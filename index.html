<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sozo Brain Center — Advanced Neuromodulation Platform</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            sozo: {
              50: '#fff7ed',
              100: '#ffedd5',
              200: '#fed7aa',
              500: '#f97316',
              600: 'rgb(244, 121, 32)', // Sozo Primary Orange
              700: 'rgb(202, 65, 12)', // Sozo Dark Orange
              800: '#9a3412',
              900: '#7c2d12',
            },
            brand: {
              orange: 'rgb(244, 121, 32)',
              'orange-dark': 'rgb(202, 65, 12)',
              blue: 'rgb(0, 161, 228)',
              'blue-dark': 'rgb(0, 130, 185)',
            }
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          }
        }
      }
    }
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    
    /* ===== SOZO COLOR PALETTE ===== */
    :root {
      --orange-primary: rgb(244, 121, 32);
      --orange-dark: rgb(202, 65, 12);
      --orange-light: rgba(244, 121, 32, 0.1);
      --orange-lighter: rgba(244, 121, 32, 0.05);
      --blue-primary: rgb(0, 161, 228);
      --blue-dark: rgb(0, 130, 185);
      --blue-light: rgba(0, 161, 228, 0.1);
      --blue-lighter: rgba(0, 161, 228, 0.05);
      --dark-bg: #0a0a0a;
      --dark-gray: #1a1a1a;
      --light-gray: #f5f5f5;
      --medium-gray: #efefef;
      --text-dark: #1a1a1a;
      --text-light: #ffffff;
      --text-secondary: #666666;
      --border-light: #e2e8f0;
    }
    
    * { box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background-color: #f8fafc; overflow-x: hidden; }
    html { overflow-x: hidden; }
    #sidebarNav { background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%); min-height: 100vh; padding: 0.5rem 0; box-shadow: 4px 0 6px -1px rgba(0, 0, 0, 0.1); }
    /* Sidebar gradient: White at top (logo), then transition to orange */
    aside { background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 4%, #f0f1f3 8%, var(--orange-primary) 12%, var(--orange-primary) 100%); box-shadow: 8px 0 16px rgba(0, 0, 0, 0.15), 12px 0 24px rgba(244, 121, 32, 0.1); }
    /* Clinic branding section with white background */
    aside > div:first-child { background: transparent; border-bottom: 2px solid #f0f0f0; }
    /* Navigation title color - darker for white background */
    aside > div:nth-child(2) .text-xs.font-bold.text-slate-400 { color: var(--orange-primary) !important; }
    /* Navigation items - white text on orange background */
    .nav-item { color: white; }
    .nav-item:hover { background: rgba(255, 255, 255, 0.15); color: white; }
    .nav-item.active { background: rgba(255, 255, 255, 0.2); color: white; border-left-color: white; }
    .content-fade { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slide-in { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
    @keyframes ripple-effect { 
      from { r: 10; opacity: 1; stroke-width: 3; } 
      to { r: 30; opacity: 0; stroke-width: 0; } 
    }
    @keyframes pulse { 
      0%, 100% { transform: scale(1); } 
      50% { transform: scale(1.05); box-shadow: 0 0 20px rgba(244, 121, 32, 0.5); } 
    }
    @keyframes electrode-pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.15); opacity: 0.8; }
      100% { transform: scale(1); opacity: 1; }
    }
    .animate-slide-in { animation: slide-in 0.3s ease-out; transition: all 0.3s ease-out; }
    .electrode circle { transition: all 0.2s ease; }
    
    /* Tab styles */
    .tab-button {
      transition: all 0.2s ease;
      border-bottom: 2px solid transparent;
    }
    .tab-button:hover {
      background-color: #f1f5f9;
      border-bottom-color: #cbd5e1 !important;
    }
    .tab-button.active-tab {
      background-color: white;
      font-weight: bold;
    }
    .tab-content {
      transition: opacity 0.2s ease;
    }
    .nav-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.65rem 1rem; margin: 0.2rem 0.65rem; color: #cbd5e1; cursor: pointer; transition: all 0.2s ease; border-radius: 0.5rem; border-left: 3px solid transparent; font-weight: 500; font-size: 0.875rem; }
    .nav-item:hover { background: rgba(244, 121, 32, 0.15); color: #ffffff; border-left-color: var(--orange-primary); transform: translateX(2px); }
    .nav-item.active { background: linear-gradient(90deg, rgba(244, 121, 32, 0.2) 0%, rgba(244, 121, 32, 0.05) 100%); color: var(--orange-primary); border-left-color: var(--orange-primary); box-shadow: 0 0 15px rgba(244, 121, 32, 0.3); }
    .nav-sublist { margin-left: 12px; border-left: 1px dashed #e2e8f0; padding-left: 8px; }
    .nav-sub { padding: 8px 12px; border-radius: 8px; color: #475569; display: flex; align-items: center; gap: 10px; cursor: pointer; transition: background 0.2s; }
    .nav-sub:hover { background: var(--orange-lighter); color: var(--orange-primary); }
    .nav-sub.active { background: var(--orange-primary); color: white; box-shadow: 0 4px 12px rgba(244, 121, 32, 0.2); }
    .card { background: white; border-radius: 16px; border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.02); transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s; }
    .card:hover { transform: translateY(-2px); box-shadow: 0 12px 24px rgba(0,0,0,0.06); border-color: var(--orange-primary); }
    table { width: 100%; border-collapse: separate; border-spacing: 0; }
    th { text-align: left; padding: 16px; color: #64748b; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
    td { padding: 16px; border-bottom: 1px solid #f1f5f9; color: #334155; font-size: 14px; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: var(--orange-lighter); }
    .badge { display: inline-block; padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; }
    .badge-success { background-color: #dcfce7; color: #166534; }
    .badge-warning { background-color: #fef3c7; color: #92400e; }
    .badge-danger { background-color: #fee2e2; color: #991b1b; }
    .badge-info { background-color: #dbeafe; color: #1e40af; }
    .badge-sozo { background-color: var(--orange-lighter); color: var(--orange-primary); }
    .fnon-highlight { background-color: var(--orange-lighter) !important; border-left: 4px solid var(--orange-primary); }
    .input-royal { width: 100%; padding: 10px 14px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; transition: 0.2s; }
    .input-royal:focus { border-color: var(--orange-primary); outline: none; box-shadow: 0 0 0 3px rgba(244, 121, 32, 0.1); }
    .progress-ring__circle { transition: stroke-dashoffset 0.35s; transform: rotate(-90deg); transform-origin: 50% 50%; }
    .kpi-card { display: flex; align-items: center; gap: 16px; padding: 20px; background: white; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.02); transition: transform 0.2s, box-shadow 0.2s; }
    .kpi-card:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0,0,0,0.08); border-color: var(--orange-primary); }
    .kpi-icon { width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; border-radius: 10px; font-size: 24px; flex-shrink: 0; }
    .kpi-label { font-size: 10px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px; }
    .kpi-value { font-size: 20px; font-weight: 800; color: #334155; line-height: 1; }
    .search-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-height: 200px; overflow-y: auto; z-index: 50; margin-top: 4px; }
    .search-dropdown-item { padding: 10px 14px; cursor: pointer; border-bottom: 1px solid #f1f5f9; transition: background 0.2s; }
    .search-dropdown-item:hover { background: var(--orange-lighter); color: var(--orange-primary); }
    .search-dropdown-item:last-child { border-bottom: none; }
    .upload-success { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #dcfce7; border-left: 3px solid #16a34a; border-radius: 6px; }
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 100; }
    .modal-content { background: white; border-radius: 16px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
    .btn-primary { background: linear-gradient(135deg, var(--orange-primary) 0%, var(--orange-dark) 100%); color: white; padding: 10px 20px; border-radius: 8px; font-weight: 600; transition: all 0.2s; }
    .btn-primary:hover { box-shadow: 0 4px 12px rgba(244, 121, 32, 0.3); transform: translateY(-1px); background: linear-gradient(135deg, var(--blue-primary) 0%, var(--blue-dark) 100%); }
    .btn-secondary { background: white; border: 2px solid #e2e8f0; color: #64748b; padding: 10px 20px; border-radius: 8px; font-weight: 600; transition: all 0.2s; }
    .btn-secondary:hover { border-color: var(--orange-primary); color: var(--orange-primary); }
    .chart-container { position: relative; height: 300px; width: 100%; }
    .sort-btn { padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 6px; cursor: pointer; background: white; font-weight: 600; font-size: 12px; transition: all 0.2s; }
    .sort-btn.active { background: var(--orange-primary); color: white; border-color: var(--orange-primary); box-shadow: 0 2px 8px rgba(244, 121, 32, 0.3); }
    .sort-btn:hover { border-color: var(--orange-primary); color: var(--orange-primary); }
    .financeSort { padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 6px; cursor: pointer; background: white; font-weight: 600; font-size: 12px; transition: all 0.2s; }
    .financeSort.active { background: var(--orange-primary); color: white; border-color: var(--orange-primary); box-shadow: 0 2px 8px rgba(244, 121, 32, 0.3); }
    .financeSort:hover { border-color: var(--orange-primary); color: var(--orange-primary); }
    .settings-tab { font-weight: 600; color: #475569; transition: all 0.2s; border-left: 3px solid transparent; }
    .settings-tab.active { background: var(--orange-lighter); color: var(--orange-primary); border-left-color: var(--orange-primary); }
    .settings-content { animation: slideUp 0.3s ease; }
    
    /* Global scrollbar styles - minimized size */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    ::-webkit-scrollbar-thumb {
      background-color: #cbd5e1;
      border-radius: 3px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background-color: var(--orange-primary);
    }
    /* Firefox scrollbar */
    * {
      scrollbar-width: thin;
      scrollbar-color: #cbd5e1 transparent;
    }
    *:hover {
      scrollbar-color: var(--orange-primary) transparent;
    }
    
    /* Appointment table scrollbar styles */
    #apptScrollContainer {
      scrollbar-width: thin;
      scrollbar-color: var(--orange-primary) #e2e8f0;
    }
    #apptScrollContainer::-webkit-scrollbar {
      width: 6px;
      height: 6px;
      display: block !important;
    }
    #apptScrollContainer::-webkit-scrollbar-track {
      background: transparent;
      border-radius: 3px;
    }
    #apptScrollContainer::-webkit-scrollbar-thumb {
      background-color: var(--orange-primary);
      border-radius: 3px;
      border: none;
    }
    #apptScrollContainer::-webkit-scrollbar-thumb:hover {
      background-color: var(--orange-dark);
    }
    #apptScrollContainer::-webkit-scrollbar-corner {
      background: transparent;
    }
    #apptScrollContainer {
      isolation: isolate;
    }

    .app-shell {
      min-height: 100%;
    }
    #mainSidebar {
      width: 280px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    #mobileSidebarOverlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      z-index: 35;
    }
    @media (max-width: 1024px) {
      #mainSidebar {
        width: 240px;
      }
    }
    @media (max-width: 768px) {
      .app-shell {
        flex-direction: column;
      }
      #mainSidebar {
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        width: min(320px, 80%);
        transform: translateX(-100%);
        z-index: 40;
        box-shadow: 18px 0 40px rgba(15, 23, 42, 0.45);
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
      }
      #mainApp.sidebar-visible #mainSidebar {
        transform: translateX(0);
      }
      #mainApp.sidebar-visible #mobileSidebarOverlay {
        display: block;
      }
      main {
        padding-top: 0;
      }
      #mobileSidebarOverlay {
        display: none;
      }
    }

    .table-scrollable {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
      scrollbar-color: rgba(244, 121, 32, 0.5) transparent;
      margin-bottom: 1rem;
    }
    .table-scrollable table {
      min-width: 480px;
    }
    .table-scrollable::-webkit-scrollbar {
      height: 6px;
    }
    .table-scrollable::-webkit-scrollbar-thumb {
      background-color: rgba(244, 121, 32, 0.6);
      border-radius: 999px;
    }

    /* Blob Animation */
    @keyframes blob {
      0% { transform: translate(0px, 0px) scale(1); }
      33% { transform: translate(30px, -50px) scale(1.1); }
      66% { transform: translate(-20px, 20px) scale(0.9); }
      100% { transform: translate(0px, 0px) scale(1); }
    }
    .animate-blob {
      animation: blob 7s infinite;
    }
    .animation-delay-2000 {
      animation-delay: 2s;
    }
    .animation-delay-4000 {
      animation-delay: 4s;
    }
  </style>
</head>
<body class="text-slate-800">

<div id="loginPage" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-900 via-blue-800 to-blue-950 relative overflow-hidden">
  <!-- Animated background elements -->
  <div class="absolute inset-0 overflow-hidden pointer-events-none">
    <div class="absolute top-0 -left-4 w-72 h-72 bg-blue-500 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-blob"></div>
    <div class="absolute top-0 -right-4 w-72 h-72 bg-blue-600 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-blob animation-delay-2000"></div>
    <div class="absolute -bottom-8 left-20 w-72 h-72 bg-blue-400 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-blob animation-delay-4000"></div>
  </div>

  <!-- Main container: split-screen layout -->
  <div class="relative z-10 w-full max-w-6xl mx-4 lg:mx-auto flex flex-col lg:flex-row gap-8 lg:gap-12 items-center">
    
    <!-- LEFT: Login Form -->
    <div class="w-full lg:w-1/2 bg-white/95 backdrop-blur-xl p-10 rounded-3xl shadow-2xl border border-white/20">
      <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-blue-900 mb-2">Welcome Back</h1>
        <p class="text-slate-600 font-medium">Sign in to continue your journey</p>
      </div>

      <div id="loginViewLogin" class="space-y-5">
        <form id="loginForm" class="space-y-5">
          <div>
            <label class="text-xs font-bold text-slate-700 uppercase ml-1">Email</label>
            <div class="relative mt-1">
              <i class="fa-solid fa-envelope absolute left-4 top-3.5 text-slate-400"></i>
              <input type="email" id="loginUsername" placeholder="Enter your email" class="w-full pl-11 pr-4 py-3 bg-slate-50 border-2 border-slate-200 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition outline-none" />
            </div>
          </div>
          <div>
            <label class="text-xs font-bold text-slate-700 uppercase ml-1">Password</label>
            <div class="relative mt-1">
              <i class="fa-solid fa-lock absolute left-4 top-3.5 text-slate-400"></i>
              <input type="password" id="loginPassword" placeholder="Enter your password" class="w-full pl-11 pr-4 py-3 bg-slate-50 border-2 border-slate-200 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition outline-none" />
            </div>
          </div>
          <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white font-bold py-3.5 rounded-xl hover:shadow-lg hover:shadow-blue-600/40 transition transform hover:-translate-y-0.5 hover:from-blue-700 hover:to-blue-800">Sign In</button>
          <div class="mt-2"><span id="loginError" class="text-sm text-red-600"></span></div>
        </form>

        <div class="relative">
          <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-slate-200"></div></div>
          <div class="relative flex justify-center text-xs"><span class="px-2 bg-white text-slate-500">New to Sozo Brain?</span></div>
        </div>

        <button type="button" onclick="switchLoginView('register')" class="w-full border-2 border-blue-600 text-blue-600 font-bold py-3 rounded-xl hover:bg-blue-50 transition">Create Account</button>

        <!-- Patient Journey button -->
        <button type="button" onclick="window.open('patient-journey.html', '_blank')" class="w-full mt-3 bg-gradient-to-r from-orange-500 to-orange-600 text-white font-bold py-3.5 rounded-xl hover:shadow-lg hover:shadow-orange-500/40 transition transform hover:-translate-y-0.5">
          <i class="fa-solid fa-route mr-2"></i>Patient Journey
        </button>

        <!-- Demo Profiles Grid -->
        <div class="mt-6 pt-4 border-t border-slate-200">
          <p class="text-xs text-slate-500 mb-3 text-center font-semibold">Quick Demo Access</p>
          <div class="grid grid-cols-2 gap-3">
            <button onclick="autoFill('admin')" class="p-3 bg-blue-50 hover:bg-blue-100 border-2 border-blue-200 rounded-xl transition group">
              <i class="fa-solid fa-user-shield text-blue-600 text-xl mb-1"></i>
              <p class="text-xs font-bold text-blue-700">Admin</p>
            </button>
            <button onclick="autoFill('doctor')" class="p-3 bg-blue-50 hover:bg-blue-100 border-2 border-blue-200 rounded-xl transition group">
              <i class="fa-solid fa-user-doctor text-blue-600 text-xl mb-1"></i>
              <p class="text-xs font-bold text-blue-700">Doctor</p>
            </button>
            <button onclick="autoFill('receptionist')" class="p-3 bg-blue-50 hover:bg-blue-100 border-2 border-blue-200 rounded-xl transition group">
              <i class="fa-solid fa-clipboard-user text-blue-600 text-xl mb-1"></i>
              <p class="text-xs font-bold text-blue-700">Receptionist</p>
            </button>
            <button onclick="autoFill('patient')" class="p-3 bg-blue-50 hover:bg-blue-100 border-2 border-blue-200 rounded-xl transition group">
              <i class="fa-solid fa-user text-blue-600 text-xl mb-1"></i>
              <p class="text-xs font-bold text-blue-700">Patient</p>
            </button>
          </div>
        </div>
      </div>

      <div id="loginViewRegister" style="display: none;" class="space-y-4">
        <form id="registerForm" class="space-y-4">
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs font-bold text-slate-700 uppercase">First Name</label>
              <input type="text" id="regFirstName" placeholder="First name" class="w-full px-4 py-2.5 mt-1 bg-slate-50 border-2 border-slate-200 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition outline-none" required />
            </div>
            <div>
              <label class="text-xs font-bold text-slate-700 uppercase">Last Name</label>
              <input type="text" id="regLastName" placeholder="Last name" class="w-full px-4 py-2.5 mt-1 bg-slate-50 border-2 border-slate-200 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition outline-none" required />
            </div>
          </div>
          
          <div>
            <label class="text-xs font-bold text-slate-700 uppercase">Email</label>
            <input type="email" id="regEmail" placeholder="your.email@example.com" class="w-full px-4 py-2.5 mt-1 bg-slate-50 border-2 border-slate-200 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition outline-none" required />
          </div>

          <div>
            <label class="text-xs font-bold text-slate-700 uppercase">Password</label>
            <input type="password" id="regPassword" placeholder="Min 6 characters" class="w-full px-4 py-2.5 mt-1 bg-slate-50 border-2 border-slate-200 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition outline-none" required />
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs font-bold text-slate-700 uppercase">Country</label>
              <select id="regCountry" class="w-full px-4 py-2.5 mt-1 bg-slate-50 border-2 border-slate-200 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition outline-none" required>
                <option value="">Select country</option>
                <option value="Germany">Germany</option>
                <option value="UK">United Kingdom</option>
                <option value="USA">United States</option>
                <option value="France">France</option>
                <option value="Spain">Spain</option>
                <option value="Cyprus">Cyprus</option>
                <option value="India">India</option>
                <option value="Australia">Australia</option>
              </select>
            </div>
            <div>
              <label class="text-xs font-bold text-slate-700 uppercase">Role</label>
              <select id="regRole" class="w-full px-4 py-2.5 mt-1 bg-slate-50 border-2 border-slate-200 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition outline-none" required>
                <option value="">Select role</option>
                <option value="patient">Patient</option>
                <option value="doctor">Doctor</option>
                <option value="admin">Admin</option>
              </select>
            </div>
          </div>
          <div>
            <label class="text-xs font-bold text-slate-700 uppercase">Mobile</label>
            <input type="tel" id="regMobile" placeholder="e.g. +49 30 123456" class="w-full px-4 py-2.5 mt-1 bg-slate-50 border-2 border-slate-200 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition outline-none" required />
          </div>
          <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white font-bold py-3.5 rounded-xl hover:shadow-lg hover:shadow-blue-600/40 transition transform hover:-translate-y-0.5">Create Account</button>
          <button type="button" onclick="switchLoginView('login')" class="w-full mt-2 border-2 border-slate-300 text-slate-700 font-bold py-3 rounded-xl hover:bg-slate-50 transition hover:border-blue-600">Back to Login</button>
        </form>
      </div>
    </div>

    <!-- RIGHT: Branding & Features -->
    <div class="hidden lg:flex w-full lg:w-1/2 flex-col items-center justify-center text-center text-white space-y-6">
      <div class="mb-8">
        <img src="logo.png" alt="SOZO Brain Center" class="h-24 w-auto mx-auto">
      </div>
      <p class="text-xl font-medium text-blue-100 max-w-md">Advanced Neuromodulation Platform for Personalized Brain Health</p>
      
      <div class="mt-8 space-y-4 max-w-md">
        <div class="flex items-start gap-4 bg-white/10 backdrop-blur-sm p-4 rounded-xl">
          <i class="fa-solid fa-brain text-3xl text-blue-300 mt-1"></i>
          <div class="text-left">
            <h4 class="font-bold text-lg mb-1">Precision Treatment</h4>
            <p class="text-sm text-blue-100">AI-powered assessment and personalized neuromodulation protocols</p>
          </div>
        </div>
        <div class="flex items-start gap-4 bg-white/10 backdrop-blur-sm p-4 rounded-xl">
          <i class="fa-solid fa-chart-line text-3xl text-blue-300 mt-1"></i>
          <div class="text-left">
            <h4 class="font-bold text-lg mb-1">Real-time Monitoring</h4>
            <p class="text-sm text-blue-100">Track your progress with comprehensive analytics and reports</p>
          </div>
        </div>
        <div class="flex items-start gap-4 bg-white/10 backdrop-blur-sm p-4 rounded-xl">
          <i class="fa-solid fa-user-doctor text-3xl text-blue-300 mt-1"></i>
          <div class="text-left">
            <h4 class="font-bold text-lg mb-1">Expert Care Team</h4>
            <p class="text-sm text-blue-100">Collaborate with specialized neurologists and clinicians</p>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Visit Selection Page (Patient Only) -->
<div id="visitSelectionPage" class="hidden min-h-screen flex items-center justify-center bg-gradient-to-br from-sozo-50 via-orange-50 to-white relative overflow-hidden">
  <div class="absolute inset-0 pointer-events-none" style="background: radial-gradient(1200px 600px at -10% -10%, rgba(251, 146, 60, 0.15) 0%, rgba(251, 146, 60, 0.08) 40%, rgba(255,255,255,0) 70%), radial-gradient(800px 400px at 110% 110%, rgba(250, 204, 21, 0.12) 0%, rgba(255,255,255,0) 60%);"></div>
  
  <div class="max-w-6xl mx-auto px-6 relative z-10">
    <!-- Header -->
    <div class="text-center mb-12">
      <div class="flex justify-center mb-6">
        <img src="logo1.png" alt="SOZOBRAIN Logo" class="h-20 w-auto">
      </div>
      <h1 class="text-4xl font-black text-slate-900 mb-3">Welcome to Your Patient Portal</h1>
      <p class="text-xl text-slate-600 font-medium" id="visitSelectionWelcome">Please select your visit stage to continue</p>
    </div>

    <!-- Visit Selection Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
      <!-- First Visit -->
      <div class="bg-white/95 backdrop-blur-xl rounded-2xl shadow-xl border border-white/20 p-8 hover:shadow-2xl transition-all duration-300 cursor-pointer group" onclick="selectVisit('first-visit')">
        <div class="flex items-start gap-6">
          <div class="w-16 h-16 rounded-full bg-gradient-to-br from-sozo-600 to-orange-800 flex items-center justify-center flex-shrink-0 group-hover:scale-110 transition-transform group-hover:shadow-lg group-hover:shadow-sozo-600/40">
            <i class="fa-solid fa-star text-white text-2xl"></i>
          </div>
          <div class="flex-1">
            <h3 class="text-2xl font-black text-slate-900 mb-2 group-hover:text-sozo-600 transition-colors">First Visit</h3>
            <p class="text-slate-600 mb-4">Begin your treatment journey with your initial consultation and assessment</p>
            <div class="space-y-2">
              <div class="flex items-center gap-2 text-sm text-slate-700">
                <i class="fa-solid fa-check text-sozo-600"></i>
                <span>Treatment Plan Overview</span>
              </div>
              <div class="flex items-center gap-2 text-sm text-slate-700">
                <i class="fa-solid fa-check text-sozo-600"></i>
                <span>Upcoming Session Details</span>
              </div>
            </div>
          </div>
        </div>
      </div>


      <!-- Follow-Up Visit 3 -->
      <div class="bg-white/95 backdrop-blur-xl rounded-2xl shadow-xl border border-white/20 p-8 hover:shadow-2xl transition-all duration-300 cursor-pointer group" onclick="selectVisit('followup-3')">
        <div class="flex items-start gap-6">
          <div class="w-16 h-16 rounded-full bg-gradient-to-br from-brand-blue to-blue-700 flex items-center justify-center flex-shrink-0 group-hover:scale-110 transition-transform group-hover:shadow-lg group-hover:shadow-sozo-600/40">
            <i class="fa-solid fa-trophy text-white text-2xl"></i>
          </div>
          <div class="flex-1">
            <h3 class="text-2xl font-black text-slate-900 mb-2 group-hover:text-sozo-600 transition-colors">Follow-Up Visit </h3>
            <p class="text-slate-600 mb-4">Complete view of your treatment journey with all historical data</p>
            <div class="space-y-2">
              <div class="flex items-center gap-2 text-sm text-slate-700">
                <i class="fa-solid fa-check text-sozo-600"></i>
                <span>Complete Treatment History</span>
              </div>
              <div class="flex items-center gap-2 text-sm text-slate-700">
                <i class="fa-solid fa-check text-sozo-600"></i>
                <span>Full Progress Analysis</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Logout Option -->
    <div class="text-center">
      <button onclick="handleLogoutFromVisitSelection()" class="text-slate-600 hover:text-slate-900 font-semibold transition-colors">
        <i class="fa-solid fa-arrow-left mr-2"></i>Back to Login
      </button>
    </div>
  </div>
</div>
<!-- End of Visit Selection Page -->
  
    <div id="mainApp" class="hidden w-full h-screen">
      <div class="app-shell flex w-full h-full bg-slate-50 overflow-hidden">
   
        <!-- ================= SIDEBAR ================= -->
        <aside id="mainSidebar" class="w-64 shrink-0 flex flex-col text-white"
          style="background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);">
          <!-- Logo -->
          <div class="p-4 flex items-center justify-center border-b border-slate-700">
            <img src="logo.png" alt="Logo" class="w-32 h-auto" />
          </div>
   
          <!-- Navigation -->
          <div class="flex-1 overflow-y-auto p-4">
            <div class="text-xs font-bold text-slate-400 uppercase mb-4 px-2 tracking-wide">
              Navigation
            </div>
            <div id="sidebarNav" class="space-y-1"></div>
          </div>
   
          <!-- User + Logout -->
          <div class="p-4 border-t border-slate-700">
            <div class="flex items-center gap-3 mb-3">
              <div id="sidebarAvatar"
                class="w-12 h-12 rounded-full border-2 border-slate-600 shadow-md bg-gradient-to-br from-sozo-600 to-brand-blue flex items-center justify-center">
                <i class="fa-solid fa-user text-white"></i>
              </div>
   
              <div class="flex-1 min-w-0">
                <div id="sidebarName" class="font-bold text-white text-sm truncate">
                  Guest
                </div>
              </div>
            </div>
   
            <button onclick="handleLogout()"
              class="w-full bg-slate-600 hover:bg-slate-700 border border-slate-700 text-white font-semibold px-4 py-2 rounded-lg transition text-sm">
              Logout
            </button>
          </div>
        </aside>
   
        <!-- ================= MAIN CONTENT ================= -->
        <main class="flex-1 w-full overflow-y-auto overflow-x-hidden">
          <div class="sm:hidden flex items-center justify-between px-4 py-3 border-b border-slate-200 bg-white sticky top-0 z-20">
            <button class="p-2 rounded-lg bg-slate-100 text-slate-700 shadow-inner" onclick="toggleMobileSidebar()" aria-label="Open sidebar">
              <i class="fa-solid fa-bars"></i>
            </button>
            <p class="text-sm font-semibold text-slate-600">Sozo Brain Center</p>
            <span class="w-10"></span>
          </div>
          <div id="contentArea" class="w-full min-h-full px-6 py-4">
            <!-- ================= YOUR PAGE CONTENT GOES HERE ================= -->
          </div>
        </main>
   
      </div>
      <div id="mobileSidebarOverlay" onclick="hideMobileSidebar()" aria-hidden="true"></div>
    </div>
    <script>
    // ========== Sozo App Bootstrap ==========
    // Demo users
    const users = {
      admin: { id:'ADM-001', name:'Admin User', role:'admin', email:'admin@sozobrain.com', password:'admin123', avatar:'https://i.pravatar.cc/100?img=5' },
      doctor: { id:'DOC-001', name:'Dr. James Wilson', role:'doctor', email:'doctor@sozobrain.com', password:'doctor123', avatar:'https://i.pravatar.cc/100?img=15', clinic:'Sozo London', country:'UK' },
      patient: { id:'PAT-001', name:'Alex Johnson', role:'patient', email:'patient@sozobrain.com', password:'patient123', avatar:'https://i.pravatar.cc/100?img=12', country:'Germany' },
      receptionist: { id:'REC-001', name:'Sarah Williams', role:'receptionist', email:'receptionist@sozobrain.com', password:'receptionist123', avatar:'https://i.pravatar.cc/100?img=20', clinic:'SOZO Brain Center', country:'Germany' }
    };

    // Global state
    let currentUser = null;
    let currentRole = null;
    let selectedDoctor = { id:'', name:'', email:'' };
    let globalSelectedPatientId = null;
    let assessmentProgress = { fnon:'completed', brain:'completed', prs:'completed', finalreport:'not-started' };
    let selectedVisit = null; // Track current visit stage for patient (first-visit, followup-1, followup-2, followup-3)

    // ==========================================
    // LOCAL STORAGE STATE MANAGEMENT
    // ==========================================
    // 
    // This module provides persistent storage for patient portal data using localStorage.
    // All user session data, patient information, and preferences are automatically saved
    // and restored across browser sessions.
    //
    // KEY FEATURES:
    // - Auto-save user sessions on login
    // - Auto-restore sessions on page load (24-hour expiry)
    // - Persistent patient data storage
    // - User preferences management
    // - Automatic logout after 24 hours
    //
    // STORAGE KEYS:
    // - sozo_current_user: Current logged-in user data
    // - sozo_current_role: User role (patient, doctor, admin, receptionist)
    // - sozo_patient_data: Patient-specific data (for patient role only)
    // - sozo_user_preferences: User preferences (theme, notifications, etc.)
    // - sozo_session_data: Session metadata (timestamp, login time)
    //
    // PUBLIC API:
    // - updatePatientField(fieldName, value) - Update single patient field
    // - updatePatientFields(updates) - Update multiple patient fields
    // - getPatientField(fieldName) - Get specific patient field value
    // - getPatientData() - Get all patient data
    // - addHealthRecord(record) - Add health record entry
    // - updatePreferences(prefs) - Update user preferences
    // - getPreferences() - Get current preferences
    // - logoutUser() - Logout and clear all localStorage data
    //
    // USAGE EXAMPLES:
    // updatePatientField('phone', '+49 30 123456');
    // updatePatientFields({ phone: '+49 30 123456', email: 'new@email.com' });
    // const phone = getPatientField('phone');
    // addHealthRecord({ type: 'blood_pressure', value: '120/80', date: '2026-01-29' });
    // updatePreferences({ theme: 'dark', notifications: true });
    //
    const STORAGE_KEYS = {
      CURRENT_USER: 'sozo_current_user',
      CURRENT_ROLE: 'sozo_current_role',
      PATIENT_DATA: 'sozo_patient_data',
      USER_PREFERENCES: 'sozo_user_preferences',
      SESSION_DATA: 'sozo_session_data'
    };

    // Save user data to localStorage
    function saveToLocalStorage(key, data) {
      try {
        const serialized = JSON.stringify(data);
        localStorage.setItem(key, serialized);
        console.log('✓ Saved to localStorage:', key);
        return true;
      } catch (error) {
        console.error('✗ Failed to save to localStorage:', error);
        return false;
      }
    }

    // Load user data from localStorage
    function loadFromLocalStorage(key) {
      try {
        const serialized = localStorage.getItem(key);
        if (serialized === null) {
          console.log('No data found in localStorage for:', key);
          return null;
        }
        const data = JSON.parse(serialized);
        console.log('✓ Loaded from localStorage:', key);
        return data;
      } catch (error) {
        console.error('✗ Failed to load from localStorage:', error);
        return null;
      }
    }

    // Remove data from localStorage
    function removeFromLocalStorage(key) {
      try {
        localStorage.removeItem(key);
        console.log('✓ Removed from localStorage:', key);
        return true;
      } catch (error) {
        console.error('✗ Failed to remove from localStorage:', error);
        return false;
      }
    }

    // Clear all Sozo app data from localStorage
    function clearAllLocalStorage() {
      try {
        Object.values(STORAGE_KEYS).forEach(key => {
          localStorage.removeItem(key);
        });
        console.log('✓ Cleared all localStorage data');
        return true;
      } catch (error) {
        console.error('✗ Failed to clear localStorage:', error);
        return false;
      }
    }

    // Save current user session
    function saveUserSession(user, role) {
      const sessionData = {
        user: user,
        role: role,
        timestamp: new Date().toISOString(),
        loginTime: new Date().toISOString()
      };
      saveToLocalStorage(STORAGE_KEYS.CURRENT_USER, user);
      saveToLocalStorage(STORAGE_KEYS.CURRENT_ROLE, role);
      saveToLocalStorage(STORAGE_KEYS.SESSION_DATA, sessionData);
    }

    // Load user session
    function loadUserSession() {
      const user = loadFromLocalStorage(STORAGE_KEYS.CURRENT_USER);
      const role = loadFromLocalStorage(STORAGE_KEYS.CURRENT_ROLE);
      const sessionData = loadFromLocalStorage(STORAGE_KEYS.SESSION_DATA);
      
      if (user && role) {
        console.log('✓ User session restored:', user.name, '(' + role + ')');
        return { user, role, sessionData };
      }
      
      console.log('No valid user session found');
      return null;
    }

    // Update patient data in localStorage
    function updatePatientData(updates) {
      if (currentRole !== 'patient') {
        console.warn('updatePatientData can only be called for patient role');
        return false;
      }
      
      // Merge updates with current user data
      const updatedUser = { ...currentUser, ...updates };
      
      // Update global state
      currentUser = updatedUser;
      
      // Save to localStorage
      saveToLocalStorage(STORAGE_KEYS.CURRENT_USER, updatedUser);
      saveToLocalStorage(STORAGE_KEYS.PATIENT_DATA, updatedUser);
      
      console.log('✓ Patient data updated:', Object.keys(updates));
      return true;
    }

    // Get patient data from localStorage or current session
    function getPatientData() {
      if (currentUser && currentRole === 'patient') {
        return currentUser;
      }
      
      const storedData = loadFromLocalStorage(STORAGE_KEYS.PATIENT_DATA);
      return storedData;
    }

    // Save user preferences
    function saveUserPreferences(preferences) {
      const existingPrefs = loadFromLocalStorage(STORAGE_KEYS.USER_PREFERENCES) || {};
      const updatedPrefs = { ...existingPrefs, ...preferences };
      saveToLocalStorage(STORAGE_KEYS.USER_PREFERENCES, updatedPrefs);
      return updatedPrefs;
    }

    // Load user preferences
    function loadUserPreferences() {
      return loadFromLocalStorage(STORAGE_KEYS.USER_PREFERENCES) || {};
    }

    // Auto-restore session on page load
    function autoRestoreSession() {
      const session = loadUserSession();
      
      if (session && session.user && session.role) {
        // Check if session is still valid (e.g., not expired)
        const sessionData = session.sessionData;
        if (sessionData && sessionData.timestamp) {
          const loginTime = new Date(sessionData.timestamp);
          const now = new Date();
          const hoursSinceLogin = (now - loginTime) / (1000 * 60 * 60);
          
          // Auto-logout after 24 hours
          if (hoursSinceLogin > 24) {
            console.log('Session expired (24 hours), clearing data');
            clearAllLocalStorage();
            return false;
          }
        }
        
        // Restore session
        currentUser = session.user;
        currentRole = session.role;
        
        console.log('✓ Session auto-restored for:', currentUser.name);
        return true;
      }
      
      return false;
    }

    // Logout and clear session
    function logoutUser() {
      console.log('Logging out user:', currentUser?.name);
      currentUser = null;
      currentRole = null;
      selectedDoctor = { id:'', name:'', email:'' };
      selectedVisit = null;
      clearAllLocalStorage();
    }

    // ==========================================
    // PATIENT DATA UPDATE HELPERS
    // ==========================================
    
    // Update specific patient fields
    window.updatePatientField = function(fieldName, value) {
      if (currentRole !== 'patient') {
        console.warn('Can only update patient data when logged in as patient');
        return false;
      }
      
      const updates = { [fieldName]: value };
      return updatePatientData(updates);
    };
    
    // Update multiple patient fields at once
    window.updatePatientFields = function(updates) {
      if (currentRole !== 'patient') {
        console.warn('Can only update patient data when logged in as patient');
        return false;
      }
      
      return updatePatientData(updates);
    };
    
    // Get specific patient field value
    window.getPatientField = function(fieldName) {
      const data = getPatientData();
      return data ? data[fieldName] : null;
    };
    
    // Add health record entry
    window.addHealthRecord = function(record) {
      if (currentRole !== 'patient') {
        console.warn('Can only add health records when logged in as patient');
        return false;
      }
      
      const healthRecords = currentUser.healthRecords || [];
      healthRecords.push({
        ...record,
        timestamp: new Date().toISOString(),
        id: 'HR-' + Date.now()
      });
      
      return updatePatientData({ healthRecords });
    };
    
    // Update user preferences (theme, notifications, etc.)
    window.updatePreferences = function(prefs) {
      const updated = saveUserPreferences(prefs);
      console.log('✓ Preferences updated:', prefs);
      return updated;
    };
    
    // Get current preferences
    window.getPreferences = function() {
      return loadUserPreferences();
    };

    // PRS CONDITIONS - Must be defined early for final report
    const PRS_CONDITIONS = [
      { id: 'tinnitus', name: 'Tinnitus', label: 'Tinnitus', icon: 'fa-ear', color: 'from-sozo-600 to-orange-500' },
      { id: 'parkinsons', name: "Parkinson's Disease", label: "Parkinson's Disease", icon: 'fa-person-hiking', color: 'from-sozo-600 to-orange-500' },
      { id: 'ms', name: 'Multiple Sclerosis', label: 'Multiple Sclerosis', icon: 'fa-brain', color: 'from-orange-500 to-sozo-600' },
      { id: 'migraine', name: 'Migraine', label: 'Migraine', icon: 'fa-head-side-virus', color: 'from-sozo-600 to-orange-400' },
      { id: 'ibd', name: 'Irritable Bowel Disease', label: 'Irritable Bowel Disease', icon: 'fa-stomach', color: 'from-brand-blue to-sozo-600' },
      { id: 'insomnia', name: 'Insomnia', label: 'Insomnia', icon: 'fa-moon', color: 'from-brand-blue to-slate-600' },
      { id: 'fibromyalgia', name: 'Fibromyalgia', label: 'Fibromyalgia', icon: 'fa-person-dots', color: 'from-slate-600 to-slate-500' },
      { id: 'ataxia', name: 'Ataxia', label: 'Ataxia', icon: 'fa-person-walking', color: 'from-brand-blue to-sozo-600' },
      { id: 'depression', name: 'Depression/Anxiety', label: 'Depression/Anxiety', icon: 'fa-face-flushed', color: 'from-slate-600 to-slate-500' },
      { id: 'dementia', name: 'Dementia', label: 'Dementia', icon: 'fa-head-side', color: 'from-sozo-600 to-orange-500' },
      { id: 'chronic_pain', name: 'Chronic Pain', label: 'Chronic Pain', icon: 'fa-heart-broken', color: 'from-orange-600 to-orange-500' },
      { id: 'als', name: 'Amyotrophic Lateral Sclerosis', label: 'Amyotrophic Lateral Sclerosis', icon: 'fa-person-rays', color: 'from-brand-blue to-slate-600' },
      { id: 'adhd', name: 'ADHD', label: 'ADHD', icon: 'fa-bolt', color: 'from-sozo-600 to-orange-400' },
      { id: 'stroke_tbi', name: 'After Stroke / TBI', label: 'After Stroke / TBI', icon: 'fa-head-side-mask', color: 'from-brand-blue to-sozo-600' }
    ];
    
    // Initialize with demo data for testing
    let fnonState = { 
      scores: {
        'DMN': 3,
        'CEN': 5,
        'SN': 2,
        'Temporal': 7,
        'Parietal': 4,
        'Frontal': 6,
        'Occipital': 2,
        'Motor': 3,
        'Sensory': 5,
        'Limbic': 8,
        'Cerebellar': 3,
        'Basal Ganglia': 4,
        'Thalamus': 6,
        'Hippocampus': 7
      }, 
      average: 5.0, 
      highestLabel: 'Limbic', 
      updatedAt: new Date().toISOString(), 
      doctor: { id:'DOC-001', name:'Dr. James Wilson', email:'doctor@sozobrain.com' } 
    };
    
    let brainUploadState = {
      fileName: 'patient_eeg_scan_2024.easy',
      uploadedAt: new Date().toISOString()
    };
    
    let prsState = {
      conditionId: 'depression',
      patientName: 'Alex Johnson',
      email: 'alex.j@example.com',
      country: 'Germany',
      responses: {},
      assessmentDate: new Date().toLocaleDateString(),
      submittedAt: new Date().toISOString()
    };

    // Enhanced global state for data persistence
    const globalState = {
      currentDoctor: { id: 'DOC-001', name: 'Dr. James Wilson', email: 'doctor@sozobrain.com', clinic: 'SOZO Brain Center' },
      currentPatient: null,
      sessionData: {},
      uploadHistory: [],
      cart: [],
      chartInstance: null,
      finalReportData: {
        // Patient-specific final report data stored by patient ID
        // Structure: { patientId: { conclusion: '', recommendation: '', ... } }
      },
      customFinalReportSections: {
        // Patient-specific custom sections
        // Structure: { patientId: [ { id: 'section1', title: 'Custom Section', content: '' } ] }
      }
    };

    function setMobileSidebarVisibility(visible) {
      const appShell = document.getElementById('mainApp');
      if (!appShell) return;
      if (visible) {
        appShell.classList.add('sidebar-visible');
        document.body.style.overflow = 'hidden';
      } else {
        appShell.classList.remove('sidebar-visible');
        document.body.style.overflow = '';
      }
    }

    function toggleMobileSidebar() {
      const appShell = document.getElementById('mainApp');
      if (!appShell) return;
      setMobileSidebarVisibility(!appShell.classList.contains('sidebar-visible'));
    }

    function hideMobileSidebar() {
      setMobileSidebarVisibility(false);
    }

    window.addEventListener('resize', () => {
      if (window.innerWidth >= 768) {
        hideMobileSidebar();
      }
    });

    const tableOverflowObserver = new MutationObserver((records) => {
      records.forEach((record) => {
        record.addedNodes.forEach((node) => {
          if (!(node instanceof HTMLElement)) return;
          if (node.tagName === 'TABLE') {
            ensureTableScrollability(node);
          }
          node.querySelectorAll && node.querySelectorAll('table').forEach(ensureTableScrollability);
        });
      });
    });

    function ensureTableScrollability(table) {
      if (table.closest('.overflow-x-auto, .table-scrollable')) return;
      const wrapper = document.createElement('div');
      wrapper.className = 'table-scrollable';
      table.parentNode.insertBefore(wrapper, table);
      wrapper.appendChild(table);
    }

    function ensureAllTablesScrollable() {
      document.querySelectorAll('table').forEach(ensureTableScrollability);
    }

    function initTableOverflowObserver() {
      ensureAllTablesScrollable();
      tableOverflowObserver.observe(document.body, { childList: true, subtree: true });
    }

    document.addEventListener('DOMContentLoaded', initTableOverflowObserver);

    // Sample data needed by modules
    const sampleData = {
      patients: [
        { id:'PAT-001', firstName:'Alex', lastName:'Johnson', middleName:'Michael', motherName:'Patricia Johnson', fatherName:'Robert Johnson', dob:'1990-05-15', age:34, sex:'Male', gender:'Male', name:'Alex Johnson', trn:'TRN001', taxOffice:'Berlin Tax Office', amka:'AMKA001', identityNumber:'ID-001', idIssueDate:'2020-03-10', idIssueBody:'Berlin Authority', occupationCategory:'IT Professional', jobTitle:'Senior Developer', email:'alex.j@example.com', email2:'alex.j2@work.com', patientCategory:'Standard', phone:'+49 30 111111', workPhone:'+49 30 222222', mobile:'+49 171 333333', firstVisitDate:'2024-01-15', cancerPatient:'No', country:'Germany', city:'Berlin', healthScore:86, subscription:'Premium', lastVisit:'2024-12-10', condition:'Depression', status:'Active' },
        { id:'PAT-002', firstName:'Maria', lastName:'Gomez', middleName:'Carmen', motherName:'Rosa Garcia', fatherName:'Carlos Gomez', dob:'1995-08-22', age:29, sex:'Female', gender:'Female', name:'Maria Gomez', trn:'TRN002', taxOffice:'Madrid Tax Office', amka:'AMKA002', identityNumber:'ID-002', idIssueDate:'2021-05-20', idIssueBody:'Madrid Authority', occupationCategory:'Healthcare Worker', jobTitle:'Nurse', email:'maria.g@example.com', email2:'maria.g@hospital.es', patientCategory:'Standard', phone:'+34 91 444444', workPhone:'+34 91 555555', mobile:'+34 666 666666', firstVisitDate:'2024-02-20', cancerPatient:'No', country:'Spain', city:'Madrid', healthScore:78, subscription:'Basic', lastVisit:'2024-12-05', condition:'Anxiety', status:'Active' },
        { id:'PAT-003', firstName:'Liam', lastName:'Smith', middleName:'James', motherName:'Margaret Smith', fatherName:'John Smith', dob:'1983-12-10', age:41, sex:'Male', gender:'Male', name:'Liam Smith', trn:'TRN003', taxOffice:'London Tax Office', amka:'AMKA003', identityNumber:'ID-003', idIssueDate:'2019-07-15', idIssueBody:'UK Authority', occupationCategory:'Business', jobTitle:'Manager', email:'liam.s@example.com', email2:'liam@business.uk', patientCategory:'VIP', phone:'+44 20 777777', workPhone:'+44 20 888888', mobile:'+44 7911 999999', firstVisitDate:'2024-03-10', cancerPatient:'No', country:'UK', city:'London', healthScore:80, subscription:'Premium', lastVisit:'2024-11-28', condition:'Tinnitus', status:'Active' },
        { id:'PAT-004', firstName:'Emma', lastName:'Chen', middleName:'Linda', motherName:'Wei Chen', fatherName:'David Chen', dob:'1989-04-03', age:35, sex:'Female', gender:'Female', name:'Emma Chen', trn:'TRN004', taxOffice:'New York Tax Office', amka:'AMKA004', identityNumber:'ID-004', idIssueDate:'2018-09-22', idIssueBody:'USA Authority', occupationCategory:'Technology', jobTitle:'Software Engineer', email:'emma.c@example.com', email2:'emma.chen@tech.com', patientCategory:'Standard', phone:'+1 212 101010', workPhone:'+1 212 111111', mobile:'+1 646 121212', firstVisitDate:'2024-01-25', cancerPatient:'No', country:'USA', city:'New York', healthScore:92, subscription:'Premium', lastVisit:'2024-12-18', condition:'PTSD', status:'Active' },
        { id:'PAT-005', firstName:'Oliver', lastName:'Brown', middleName:'Henry', motherName:'Dorothy Brown', fatherName:'William Brown', dob:'1972-11-27', age:52, sex:'Male', gender:'Male', name:'Oliver Brown', trn:'TRN005', taxOffice:'Sydney Tax Office', amka:'AMKA005', identityNumber:'ID-005', idIssueDate:'2015-12-01', idIssueBody:'Australia Authority', occupationCategory:'Finance', jobTitle:'Accountant', email:'oliver.b@example.com', email2:'oliver@finance.au', patientCategory:'Standard', phone:'+61 2 131313', workPhone:'+61 2 141414', mobile:'+61 412 151515', firstVisitDate:'2024-04-05', cancerPatient:'No', country:'Australia', city:'Sydney', healthScore:75, subscription:'Basic', lastVisit:'2024-12-01', condition:'Insomnia', status:'Active' },
        { id:'PAT-006', firstName:'Sophie', lastName:'Martin', middleName:'Nicole', motherName:'Claudine Martin', fatherName:'Jean Martin', dob:'1997-07-14', age:27, sex:'Female', gender:'Female', name:'Sophie Martin', trn:'TRN006', taxOffice:'Paris Tax Office', amka:'AMKA006', identityNumber:'ID-006', idIssueDate:'2022-06-10', idIssueBody:'France Authority', occupationCategory:'Education', jobTitle:'Teacher', email:'sophie.m@example.com', email2:'sophie@education.fr', patientCategory:'Standard', phone:'+33 1 161616', workPhone:'+33 1 171717', mobile:'+33 7 181818', firstVisitDate:'2024-05-12', cancerPatient:'No', country:'France', city:'Paris', healthScore:88, subscription:'Premium', lastVisit:'2024-12-20', condition:'Migraine', status:'Active' },
        { id:'PAT-007', firstName:'James', lastName:'Wilson', middleName:'Alexander', motherName:'Sarah Wilson', fatherName:'George Wilson', dob:'1979-09-08', age:45, sex:'Male', gender:'Male', name:'James Wilson', trn:'TRN007', taxOffice:'Toronto Tax Office', amka:'AMKA007', identityNumber:'ID-007', idIssueDate:'2016-08-20', idIssueBody:'Canada Authority', occupationCategory:'Legal', jobTitle:'Lawyer', email:'james.w@example.com', email2:'james@law.ca', patientCategory:'VIP', phone:'+1 416 191919', workPhone:'+1 416 202020', mobile:'+1 647 212121', firstVisitDate:'2024-02-14', cancerPatient:'No', country:'Canada', city:'Toronto', healthScore:82, subscription:'Premium', lastVisit:'2024-12-15', condition:'ADHD', status:'Active' },
        { id:'PAT-008', firstName:'Isabella', lastName:'Rodriguez', middleName:'Ana', motherName:'Gabriela Rodriguez', fatherName:'Miguel Rodriguez', dob:'1986-03-19', age:38, sex:'Female', gender:'Female', name:'Isabella Rodriguez', trn:'TRN008', taxOffice:'Mexico City Tax Office', amka:'AMKA008', identityNumber:'ID-008', idIssueDate:'2017-04-15', idIssueBody:'Mexico Authority', occupationCategory:'Arts', jobTitle:'Designer', email:'isabella.r@example.com', email2:'isabella@design.mx', patientCategory:'Standard', phone:'+52 55 222222', workPhone:'+52 55 232323', mobile:'+52 555 242424', firstVisitDate:'2024-06-20', cancerPatient:'No', country:'Mexico', city:'Mexico City', healthScore:79, subscription:'Basic', lastVisit:'2024-12-12', condition:'Chronic Pain', status:'Active' },
        { id:'PAT-009', firstName:'Noah', lastName:'Anderson', middleName:'Richard', motherName:'Victoria Anderson', fatherName:'Thomas Anderson', dob:'1968-02-14', age:56, sex:'Male', gender:'Male', name:'Noah Anderson', trn:'TRN009', taxOffice:'Stockholm Tax Office', amka:'AMKA009', identityNumber:'ID-009', idIssueDate:'2013-10-05', idIssueBody:'Sweden Authority', occupationCategory:'Engineering', jobTitle:'Engineer', email:'noah.a@example.com', email2:'noah@engineering.se', patientCategory:'Standard', phone:'+46 8 252525', workPhone:'+46 8 262626', mobile:'+46 70 272727', firstVisitDate:'2024-07-30', cancerPatient:'No', country:'Sweden', city:'Stockholm', healthScore:84, subscription:'Premium', lastVisit:'2024-12-18', condition:'Parkinson\'s', status:'Active' },
        { id:'PAT-010', firstName:'Mia', lastName:'Taylor', middleName:'Grace', motherName:'Anne Taylor', fatherName:'Christopher Taylor', dob:'1993-06-11', age:31, sex:'Female', gender:'Female', name:'Mia Taylor', trn:'TRN010', taxOffice:'Dublin Tax Office', amka:'AMKA010', identityNumber:'ID-010', idIssueDate:'2021-01-12', idIssueBody:'Ireland Authority', occupationCategory:'Marketing', jobTitle:'Specialist', email:'mia.t@example.com', email2:'mia@marketing.ie', patientCategory:'Standard', phone:'+353 1 282828', workPhone:'+353 1 292929', mobile:'+353 87 303030', firstVisitDate:'2024-08-15', cancerPatient:'No', country:'Ireland', city:'Dublin', healthScore:90, subscription:'Premium', lastVisit:'2024-12-22', condition:'Depression', status:'Active' },
        { id:'PAT-011', firstName:'Ethan', lastName:'White', middleName:'Robert', motherName:'Joan White', fatherName:'Edward White', dob:'1981-10-22', age:43, sex:'Male', gender:'Male', name:'Ethan White', trn:'TRN011', taxOffice:'Amsterdam Tax Office', amka:'AMKA011', identityNumber:'ID-011', idIssueDate:'2018-05-18', idIssueBody:'Netherlands Authority', occupationCategory:'Retail', jobTitle:'Manager', email:'ethan.w@example.com', email2:'ethan@retail.nl', patientCategory:'Standard', phone:'+31 20 313131', workPhone:'+31 20 323232', mobile:'+31 6 333333', firstVisitDate:'2024-09-20', cancerPatient:'No', country:'Netherlands', city:'Amsterdam', healthScore:77, subscription:'Basic', lastVisit:'2024-12-08', condition:'Anxiety', status:'Active' },
        { id:'PAT-012', firstName:'Ava', lastName:'Martinez', middleName:'Elena', motherName:'Francisca Martinez', fatherName:'Antonio Martinez', dob:'1985-01-07', age:39, sex:'Female', gender:'Female', name:'Ava Martinez', trn:'TRN012', taxOffice:'Lisbon Tax Office', amka:'AMKA012', identityNumber:'ID-012', idIssueDate:'2017-11-25', idIssueBody:'Portugal Authority', occupationCategory:'Hospitality', jobTitle:'Chef', email:'ava.m@example.com', email2:'ava@hospitality.pt', patientCategory:'Standard', phone:'+351 21 343434', workPhone:'+351 21 353535', mobile:'+351 963 363636', firstVisitDate:'2024-10-10', cancerPatient:'No', country:'Portugal', city:'Lisbon', healthScore:85, subscription:'Premium', lastVisit:'2024-12-19', condition:'MS', status:'Active' },
        { id:'PAT-013', firstName:'William', lastName:'Garcia', middleName:'Fernando', motherName:'Mariana Garcia', fatherName:'Juan Garcia', dob:'1976-08-29', age:48, sex:'Male', gender:'Male', name:'William Garcia', trn:'TRN013', taxOffice:'Rome Tax Office', amka:'AMKA013', identityNumber:'ID-013', idIssueDate:'2014-03-22', idIssueBody:'Italy Authority', occupationCategory:'Government', jobTitle:'Official', email:'william.g@example.com', email2:'william@gov.it', patientCategory:'VIP', phone:'+39 6 373737', workPhone:'+39 6 383838', mobile:'+39 338 393939', firstVisitDate:'2024-11-05', cancerPatient:'No', country:'Italy', city:'Rome', healthScore:81, subscription:'Premium', lastVisit:'2024-12-14', condition:'Stroke', status:'Active' },
        { id:'PAT-014', firstName:'Charlotte', lastName:'Lee', middleName:'Sophia', motherName:'Mei Lee', fatherName:'David Lee', dob:'1991-09-16', age:33, sex:'Female', gender:'Female', name:'Charlotte Lee', trn:'TRN014', taxOffice:'Singapore Tax Office', amka:'AMKA014', identityNumber:'ID-014', idIssueDate:'2020-07-08', idIssueBody:'Singapore Authority', occupationCategory:'Banking', jobTitle:'Analyst', email:'charlotte.l@example.com', email2:'charlotte@banking.sg', patientCategory:'Standard', phone:'+65 6404 4040', workPhone:'+65 6404 4141', mobile:'+65 9184 4242', firstVisitDate:'2024-12-01', cancerPatient:'No', country:'Singapore', city:'Singapore', healthScore:89, subscription:'Premium', lastVisit:'2024-12-21', condition:'Fibromyalgia', status:'Active' },
        { id:'PAT-015', firstName:'Benjamin', lastName:'Kim', middleName:'Sung', motherName:'Ji Won Kim', fatherName:'Young Ho Kim', dob:'1974-04-11', age:50, sex:'Male', gender:'Male', name:'Benjamin Kim', trn:'TRN015', taxOffice:'Seoul Tax Office', amka:'AMKA015', identityNumber:'ID-015', idIssueDate:'2012-09-30', idIssueBody:'South Korea Authority', occupationCategory:'Manufacturing', jobTitle:'Director', email:'benjamin.k@example.com', email2:'benjamin@mfg.kr', patientCategory:'Standard', phone:'+82 2 434343', workPhone:'+82 2 444444', mobile:'+82 10 454545', firstVisitDate:'2024-12-08', cancerPatient:'No', country:'South Korea', city:'Seoul', healthScore:76, subscription:'Basic', lastVisit:'2024-12-11', condition:'Insomnia', status:'Active' },
        { id:'PAT-016', firstName:'Amelia', lastName:'Patel', middleName:'Priya', motherName:'Sunita Patel', fatherName:'Rajesh Patel', dob:'1988-11-24', age:36, sex:'Female', gender:'Female', name:'Amelia Patel', trn:'TRN016', taxOffice:'Mumbai Tax Office', amka:'AMKA016', identityNumber:'ID-016', idIssueDate:'2018-12-14', idIssueBody:'India Authority', occupationCategory:'IT', jobTitle:'Developer', email:'amelia.p@example.com', email2:'amelia@it.in', patientCategory:'Standard', phone:'+91 22 464646', workPhone:'+91 22 474747', mobile:'+91 98200 484848', firstVisitDate:'2024-12-12', cancerPatient:'No', country:'India', city:'Mumbai', healthScore:87, subscription:'Premium', lastVisit:'2024-12-17', condition:'PTSD', status:'Active' },
        { id:'PAT-017', firstName:'Lucas', lastName:'Silva', middleName:'Henrique', motherName:'Beatriz Silva', fatherName:'Paulo Silva', dob:'1982-05-19', age:42, sex:'Male', gender:'Male', name:'Lucas Silva', trn:'TRN017', taxOffice:'São Paulo Tax Office', amka:'AMKA017', identityNumber:'ID-017', idIssueDate:'2016-02-28', idIssueBody:'Brazil Authority', occupationCategory:'Agriculture', jobTitle:'Manager', email:'lucas.s@example.com', email2:'lucas@agri.br', patientCategory:'Standard', phone:'+55 11 494949', workPhone:'+55 11 505050', mobile:'+55 11 989 515151', firstVisitDate:'2024-12-15', cancerPatient:'No', country:'Brazil', city:'São Paulo', healthScore:83, subscription:'Premium', lastVisit:'2024-12-16', condition:'Depression', status:'Active' },
        { id:'PAT-018', firstName:'Harper', lastName:'Nguyen', middleName:'Linh', motherName:'Hương Nguyen', fatherName:'Minh Nguyen', dob:'1996-02-03', age:28, sex:'Female', gender:'Female', name:'Harper Nguyen', trn:'TRN018', taxOffice:'Hanoi Tax Office', amka:'AMKA018', identityNumber:'ID-018', idIssueDate:'2021-08-20', idIssueBody:'Vietnam Authority', occupationCategory:'Service', jobTitle:'Coordinator', email:'harper.n@example.com', email2:'harper@service.vn', patientCategory:'Standard', phone:'+84 24 525252', workPhone:'+84 24 535353', mobile:'+84 982 545454', firstVisitDate:'2024-12-18', cancerPatient:'No', country:'Vietnam', city:'Hanoi', healthScore:91, subscription:'Premium', lastVisit:'2024-12-23', condition:'Anxiety', status:'Active' },
        { id:'PAT-019', firstName:'Alexander', lastName:'Berg', middleName:'Erik', motherName:'Ingrid Berg', fatherName:'Soren Berg', dob:'1977-07-12', age:47, sex:'Male', gender:'Male', name:'Alexander Berg', trn:'TRN019', taxOffice:'Oslo Tax Office', amka:'AMKA019', identityNumber:'ID-019', idIssueDate:'2013-06-17', idIssueBody:'Norway Authority', occupationCategory:'Energy', jobTitle:'Engineer', email:'alex.b@example.com', email2:'alex@energy.no', patientCategory:'Standard', phone:'+47 21 555555', workPhone:'+47 21 565656', mobile:'+47 950 575757', firstVisitDate:'2024-12-20', cancerPatient:'No', country:'Norway', city:'Oslo', healthScore:78, subscription:'Basic', lastVisit:'2024-12-13', condition:'Tinnitus', status:'Active' },
        { id:'PAT-020', firstName:'Sofia', lastName:'Kowalski', middleName:'Maria', motherName:'Urszula Kowalski', fatherName:'Stanislaw Kowalski', dob:'1984-12-28', age:40, sex:'Female', gender:'Female', name:'Sofia Kowalski', trn:'TRN020', taxOffice:'Warsaw Tax Office', amka:'AMKA020', identityNumber:'ID-020', idIssueDate:'2017-10-11', idIssueBody:'Poland Authority', occupationCategory:'Commerce', jobTitle:'Merchant', email:'sofia.k@example.com', email2:'sofia@commerce.pl', patientCategory:'VIP', phone:'+48 22 585858', workPhone:'+48 22 595959', mobile:'+48 888 606060', firstVisitDate:'2024-12-22', cancerPatient:'No', country:'Poland', city:'Warsaw', healthScore:86, subscription:'Premium', lastVisit:'2024-12-24', condition:'Migraine', status:'Active' }
      ],
      fnon: {
        sectionA: [
          {net:'DMN', signs:'Rumination, Mind-wandering', tests:['Gaze fixation','Romberg dual-task','Clock drawing']},
          {net:'CEN', signs:'Poor planning, Memory deficits', tests:['Digit Span','Serial subtraction (100-7)','Motor sequencing']},
          {net:'SN', signs:'Anxiety, Hyperarousal', tests:['Startle response','Interoceptive awareness']},
          {net:'SMN', signs:'Motor/Sensory deficits', tests:['Finger-to-nose','Heel-to-shin','Rapid movements']},
          {net:'Limbic', signs:'Emotional lability, Apathy', tests:['Facial expression check','Emotional reactivity']},
          {net:'Attention', signs:'Distractibility, Neglect', tests:['Cancellation test','Eye tracking']}
        ],
        sectionB: [
          {net:'DMN', sym:'Dissociation', anat:'PCC, mPFC', eeg:'Fz, Pz, P3/P4'},
          {net:'CEN', sym:'Executive dysfunction', anat:'DLPFC, PPC', eeg:'F3/F4, P3/P4'},
          {net:'SN', sym:'Emotional dysregulation', anat:'Insula, ACC', eeg:'Fz, Cz, F3/F4'},
          {net:'SMN', sym:'Clumsiness', anat:'Motor Cortex', eeg:'C3/C4, Cz'},
          {net:'Limbic', sym:'Mood swings', anat:'Amygdala', eeg:'T3/T4, F7/F8'},
          {net:'Attention', sym:'Inattention', anat:'FEF, IPS', eeg:'P3/P4, F3/F4'}
        ]
      },
      finance: { totalRev:50000000, patients:20000000, devices:10000000, partners:9000000, workshops:0, doctors:9000000, subscriptions:2000000 },
      shop: [
        {name:'Sozo Watch Pro', price:399, img:'fa-stopwatch', desc:'Advanced HRV & Sleep Tracking'},
        {name:'Sozo Ring', price:299, img:'fa-ring', desc:'Discreet Biometric Monitor'},
        {name:'NeuroScan Headset', price:1200, img:'fa-headset', desc:'Portable EEG for Home Use'},
        {name:'tDCS Stimulator', price:850, img:'fa-bolt', desc:'Clinical Grade Stimulation'}
      ],
      partnerships: [
        { id:'PA-001', name:'Munich Medical Center', city:'Munich', country:'Germany', revenue:250000, status:'Active', contactPerson:'Dr. Hans Müller', email:'hans@munich-medical.de', phone:'+49 30 123456', contractDate:'2024-01-15' },
        { id:'PA-002', name:'London Brain Institute', city:'London', country:'UK', revenue:320000, status:'Active', contactPerson:'Dr. Elizabeth Brown', email:'liz@london-brain.uk', phone:'+44 20 7946 0958', contractDate:'2024-02-20' },
        { id:'PA-003', name:'Sydney Neuro Clinic', city:'Sydney', country:'Australia', revenue:280000, status:'Active', contactPerson:'Dr. James Anderson', email:'james@sydney-neuro.au', phone:'+61 2 9211 0100', contractDate:'2024-03-10' },
        { id:'PA-004', name:'Paris Health Solutions', city:'Paris', country:'France', revenue:190000, status:'Active', contactPerson:'Dr. Marie Dubois', email:'marie@paris-health.fr', phone:'+33 1 42 34 56 78', contractDate:'2024-04-05' },
        { id:'PA-005', name:'New York Medical Corp', city:'New York', country:'USA', revenue:420000, status:'Active', contactPerson:'Dr. Michael Chen', email:'michael@ny-medical.com', phone:'+1 212 555 1234', contractDate:'2024-01-30' },
        { id:'PA-006', name:'Berlin Wellness Center', city:'Berlin', country:'Germany', revenue:150000, status:'Pending', contactPerson:'Dr. Klaus Wagner', email:'klaus@berlin-wellness.de', phone:'+49 30 456789', contractDate:'2024-11-15' }
      ],
      doctors: [
        { id:'DR-001', salutation:'Dr.', firstName:'James', lastName:'Wilson', fatherName:'Robert Wilson', identity:'IDNUM-001', medicalIdentity:'MD-123456', sex:'Male', name:'Dr. James Wilson', age:52, gender:'Male', specialty:'Neurology', specialist:'Neurology', group:'Neurology Dept', surgeon:'Yes', nurse:'No', phone:'+49 30 123456', email:'james@sozo.de', email2:'james.wilson@medcenter.de', email3:'dr.james@sozo-global.de', officePhone:'+49 30 123456', homePhone:'+49 30 987654', mobile:'+49 171 555999', fax:'+49 30 123456-1', address:'Berlin Medical Center, Charlottenstr. 1, Berlin', country:'Germany', comments:'Senior neurologist specializing in brain mapping and EEG analysis', institutions:'Berlin Medical Center, Charité University Hospital', type:'Consultant', licenseNo:'MD-123456', experience:25, patients:250, status:'Active' },
        { id:'DR-002', salutation:'Dr.', firstName:'Sarah', lastName:'Smith', fatherName:'Peter Smith', identity:'IDNUM-002', medicalIdentity:'GMC-654321', sex:'Female', name:'Dr. Sarah Smith', age:45, gender:'Female', specialty:'Psychiatry', specialist:'Psychiatry', group:'Psychiatry Dept', surgeon:'No', nurse:'No', phone:'+44 20 7946 0958', email:'sarah@sozo.uk', email2:'sarah.smith@nhs.uk', email3:'dr.sarah@mindcare.org', officePhone:'+44 20 7946 0958', homePhone:'+44 20 8123 4567', mobile:'+44 7911 555222', fax:'+44 20 7946 0959', address:'London Brain Institute, Harley Street, London', country:'UK', comments:'Specialist in neuropsychiatry and cognitive behavioral disorders', institutions:'London Brain Institute, University College London Hospitals', type:'Senior Consultant', licenseNo:'GMC-654321', experience:20, patients:180, status:'Active' },
        { id:'DR-003', salutation:'Prof.', firstName:'Rajesh', lastName:'Patel', fatherName:'Vikram Patel', identity:'IDNUM-003', medicalIdentity:'AHPRA-987654', sex:'Male', name:'Dr. Rajesh Patel', age:48, gender:'Male', specialty:'Internal Medicine', specialist:'Internal Medicine', group:'General Medicine', surgeon:'No', nurse:'Yes', phone:'+61 2 9211 0100', email:'rajesh@sozo.au', email2:'r.patel@sydneyhospital.edu.au', email3:'professor.patel@sozo.com', officePhone:'+61 2 9211 0100', homePhone:'+61 2 9555 8888', mobile:'+61 412 555333', fax:'+61 2 9211 0101', address:'Sydney Neuro Clinic, Macquarie Street, Sydney', country:'Australia', comments:'Expert in holistic patient care and medical management systems', institutions:'Sydney Neuro Clinic, Royal Prince Alfred Hospital, University of Sydney', type:'Consultant', licenseNo:'AHPRA-987654', experience:18, patients:220, status:'Active' },
        { id:'DR-004', salutation:'Dr.', firstName:'Maria', lastName:'Gomez', fatherName:'Carlos Gomez', identity:'IDNUM-004', medicalIdentity:'USMLE-456789', sex:'Female', name:'Dr. Maria Gomez', age:41, gender:'Female', specialty:'Cardiology', specialist:'Cardiology', group:'Cardiology Center', surgeon:'Yes', nurse:'No', phone:'+1 212 555 1234', email:'maria@sozo.com', email2:'m.gomez@nycmedicl.org', email3:'dr.gomez@heartcare.us', officePhone:'+1 212 555 1234', homePhone:'+1 212 555 5678', mobile:'+1 646 555 444', fax:'+1 212 555 1235', address:'New York Medical Corp, 5th Avenue, New York', country:'USA', comments:'Board certified cardiologist with research focus on neuromodulation effects on cardiac function', institutions:'New York Medical Corp, Columbia University Medical Center, Mount Sinai Hospital', type:'Consultant', licenseNo:'USMLE-456789', experience:15, patients:190, status:'Active' },
        { id:'DR-005', salutation:'Dr.', firstName:'Yuki', lastName:'Tanaka', fatherName:'Hiroshi Tanaka', identity:'IDNUM-005', medicalIdentity:'JMA-321654', sex:'Female', name:'Dr. Yuki Tanaka', age:38, gender:'Female', specialty:'Neurology', specialist:'Neurology', group:'Brain Research Institute', surgeon:'No', nurse:'No', phone:'+81 3 1234 5678', email:'yuki@sozo.jp', email2:'yuki.tanaka@tokyohosp.jp', email3:'dr.tanaka@global-neuro.com', officePhone:'+81 3 1234 5678', homePhone:'+81 3 9876 5432', mobile:'+81 90 555 666', fax:'+81 3 1234 5679', address:'Tokyo Health Center, Shibuya, Tokyo', country:'Japan', comments:'Pioneer in advanced brain imaging and AI-assisted diagnostics', institutions:'Tokyo Health Center, Todai Hospital, Japanese Brain Research Institute', type:'Consultant', licenseNo:'JMA-321654', experience:12, patients:160, status:'Active' },
        { id:'DR-006', salutation:'Dr.', firstName:'Michael', lastName:'Chen', fatherName:'David Chen', identity:'IDNUM-006', medicalIdentity:'LMCHK-567890', sex:'Male', name:'Dr. Michael Chen', age:50, gender:'Male', specialty:'Neurosurgery', specialist:'Neurosurgery', group:'Surgical Neurology', surgeon:'Yes', nurse:'No', phone:'+852 2589 8888', email:'michael@sozo.hk', email2:'m.chen@hongkonghospital.com', email3:'dr.chen@brainsurgery.asia', officePhone:'+852 2589 8888', homePhone:'+852 2517 0001', mobile:'+852 9123 4567', fax:'+852 2589 8889', address:'Hong Kong Brain Center, Central, Hong Kong', country:'Hong Kong', comments:'Expert in minimally invasive neurosurgical techniques', institutions:'Hong Kong Brain Center, University of Hong Kong', type:'Senior Consultant', licenseNo:'LMCHK-567890', experience:22, patients:145, status:'Active' },
        { id:'DR-007', salutation:'Dr.', firstName:'Emma', lastName:'Anderson', fatherName:'John Anderson', identity:'IDNUM-007', medicalIdentity:'FMC-234567', sex:'Female', name:'Dr. Emma Anderson', age:43, gender:'Female', specialty:'Rehabilitation Medicine', specialist:'Rehabilitation Medicine', group:'Rehab Services', surgeon:'No', nurse:'Yes', phone:'+46 8 517 742 00', email:'emma@sozo.se', email2:'e.anderson@stockholm.hospital.se', email3:'dr.anderson@rehab-care.eu', officePhone:'+46 8 517 742 00', homePhone:'+46 8 635 0000', mobile:'+46 73 123 4567', fax:'+46 8 517 742 01', address:'Stockholm Rehabilitation Center, Stockholm', country:'Sweden', comments:'Specialist in neuro-rehabilitation and recovery protocols', institutions:'Stockholm Rehabilitation Center, Karolinska Institute', type:'Consultant', licenseNo:'FMC-234567', experience:16, patients:175, status:'Active' },
        { id:'DR-008', salutation:'Prof.', firstName:'Klaus', lastName:'Mueller', fatherName:'Wilhelm Mueller', identity:'IDNUM-008', medicalIdentity:'GDMK-345678', sex:'Male', name:'Prof. Klaus Mueller', age:58, gender:'Male', specialty:'Neuropharmacology', specialist:'Neuropharmacology', group:'Pharmacology Dept', surgeon:'No', nurse:'No', phone:'+49 69 6301 0', email:'klaus@sozo.de', email2:'k.mueller@frankfurt.university.de', email3:'prof.mueller@neuro-pharma.com', officePhone:'+49 69 6301 0', homePhone:'+49 69 7923 1111', mobile:'+49 176 555 8888', fax:'+49 69 6301 1', address:'Frankfurt University Hospital, Frankfurt', country:'Germany', comments:'Pioneer in neuromodulation pharmacology research', institutions:'Frankfurt University Hospital, Max Planck Institute', type:'Professor', licenseNo:'GDMK-345678', experience:28, patients:120, status:'Active' },
        { id:'DR-009', salutation:'Dr.', firstName:'Lucia', lastName:'Rossi', fatherName:'Antonio Rossi', identity:'IDNUM-009', medicalIdentity:'OMC-456789', sex:'Female', name:'Dr. Lucia Rossi', age:46, gender:'Female', specialty:'Clinical Neurology', specialist:'Clinical Neurology', group:'Neurology Clinic', surgeon:'No', nurse:'No', phone:'+39 06 3299 1', email:'lucia@sozo.it', email2:'l.rossi@rome.hospital.it', email3:'dr.rossi@neuro-italia.com', officePhone:'+39 06 3299 1', homePhone:'+39 06 5921 3333', mobile:'+39 335 123 4567', fax:'+39 06 3299 2', address:'Rome Neurology Center, Rome', country:'Italy', comments:'Expertise in rare neurological disorders and diagnostic protocols', institutions:'Rome Neurology Center, Sapienza University', type:'Senior Consultant', licenseNo:'OMC-456789', experience:19, patients:165, status:'Active' },
        { id:'DR-010', salutation:'Dr.', firstName:'Henrik', lastName:'Larsson', fatherName:'Erik Larsson', identity:'IDNUM-010', medicalIdentity:'SMC-789012', sex:'Male', name:'Dr. Henrik Larsson', age:49, gender:'Male', specialty:'Sleep Medicine', specialist:'Sleep Medicine', group:'Sleep Disorders Clinic', surgeon:'No', nurse:'No', phone:'+46 31 343 4000', email:'henrik@sozo.se', email2:'h.larsson@goteborg.hospital.se', email3:'dr.larsson@sleepcare.eu', officePhone:'+46 31 343 4000', homePhone:'+46 31 120 0000', mobile:'+46 70 456 7890', fax:'+46 31 343 4001', address:'Gothenburg Sleep Medicine Center, Gothenburg', country:'Sweden', comments:'Specialist in sleep disorders and circadian rhythm management', institutions:'Gothenburg Sleep Medicine Center, University of Gothenburg', type:'Consultant', licenseNo:'SMC-789012', experience:17, patients:155, status:'Active' }
      ],
      workshops: [
        { id:'WS-001', title:'Advanced Brain Mapping Techniques', date:'2025-01-15', time:'10:00 AM', location:'Berlin, Germany', instructor:'Dr. James Wilson', capacity:50, registered:35, status:'Upcoming', fee:450, description:'Comprehensive training on QEEG analysis and brain mapping' },
        { id:'WS-002', title:'TMS Therapy Fundamentals', date:'2025-02-10', time:'2:00 PM', location:'London, UK', instructor:'Dr. Sarah Smith', capacity:40, registered:28, status:'Upcoming', fee:350, description:'Clinical introduction to Transcranial Magnetic Stimulation' },
        { id:'WS-003', title:'Patient Management Systems', date:'2025-01-28', time:'9:00 AM', location:'Sydney, Australia', instructor:'Dr. Rajesh Patel', capacity:60, registered:45, status:'Upcoming', fee:400, description:'Best practices for managing patient databases and records' },
        { id:'WS-004', title:'Biometric Monitoring Essentials', date:'2025-02-20', time:'3:30 PM', location:'New York, USA', instructor:'Dr. Maria Gomez', capacity:45, registered:32, status:'Upcoming', fee:380, description:'Understanding and interpreting biometric health data' },
        { id:'WS-005', title:'Neuromodulation in Clinical Practice', date:'2025-03-05', time:'1:00 PM', location:'Berlin, Germany', instructor:'Dr. James Wilson', capacity:55, registered:20, status:'Upcoming', fee:500, description:'Advanced neuromodulation techniques and protocols' }
      ],
      devices: [
        { id: 1, name: 'Neuro Headset Pro', price: 1299, desc: '64-channel EEG with real-time analysis', icon: 'fa-headphones' },
        { id: 2, name: 'Bio-Sensor Kit', price: 599, desc: 'Complete physiological monitoring', icon: 'fa-heart-pulse' },
        { id: 3, name: 'Sleep Tracker Elite', price: 399, desc: 'Advanced sleep stage detection', icon: 'fa-bed' },
        { id: 4, name: 'Sozo Ring', price: 299, desc: 'Continuous health metrics tracking', icon: 'fa-ring' },
        { id: 5, name: 'Pulse Monitor', price: 199, desc: 'Clinical-grade HRV analysis', icon: 'fa-heartbeat' },
        { id: 6, name: 'Brain Stim Device', price: 2499, desc: 'tDCS/tACS neuromodulation', icon: 'fa-brain' }
      ],
      appointments: [
        // Historical appointments
        { id:'APT-001', patientName:'Alex Johnson', patientId:'P-001', doctorName:'Dr. James Wilson', docId:'D-001', date:'2025-01-15', time:'10:00 AM', duration: 60, type:'FNON Assessment', location:'OPD', status:'Scheduled', notes:'Initial neurological assessment', room:'101' },
        { id:'APT-002', patientName:'Maria Gomez', patientId:'P-002', doctorName:'Dr. Sarah Smith', docId:'D-005', date:'2025-01-16', time:'2:00 PM', duration: 45, type:'Brain Mapping', location:'OPD', status:'Scheduled', notes:'Follow-up brain mapping session', room:'205' },
        { id:'APT-003', patientName:'Liam Smith', patientId:'P-003', doctorName:'Dr. Rajesh Patel', docId:'D-006', date:'2025-01-17', time:'11:30 AM', duration: 60, type:'PRS Assessment', location:'Ward', status:'Completed', notes:'Completed assessment', room:'102' },
        { id:'APT-004', patientName:'Emma Chen', patientId:'P-004', doctorName:'Dr. James Wilson', docId:'D-001', date:'2025-01-18', time:'3:00 PM', duration: 30, type:'FNON Assessment', location:'Online', status:'Scheduled', notes:'Routine check-up', room:'304' },
        { id:'APT-005', patientName:'Oliver Brown', patientId:'P-005', doctorName:'Dr. Maria Gomez', docId:'D-004', date:'2025-01-19', time:'9:30 AM', duration: 45, type:'Brain Mapping', location:'OPD', status:'Rescheduled', notes:'Moved from Jan 12', room:'101' },
        { id:'APT-006', patientName:'Sophie Martin', patientId:'P-006', doctorName:'Dr. Sarah Smith', docId:'D-005', date:'2025-01-20', time:'1:00 PM', duration: 30, type:'Final Report Review', location:'OPD', status:'Scheduled', notes:'Review treatment outcomes', room:'205' },
        { id:'APT-007', patientName:'James Wilson', patientId:'P-007', doctorName:'Dr. Lee', docId:'D-003', date:'2025-01-21', time:'4:00 PM', duration: 60, type:'FNON Assessment', location:'OPD', status:'Scheduled', notes:'Initial consultation', room:'102' },
        { id:'APT-008', patientName:'Isabella Rodriguez', patientId:'P-008', doctorName:'Dr. Rajesh Patel', docId:'D-006', date:'2025-01-22', time:'10:30 AM', duration: 45, type:'Brain Mapping', location:'Ward', status:'Completed', notes:'Assessment completed successfully', room:'304' },
        
        // Today's appointments (January 22, 2026) - spread throughout the day with varied durations and locations
        { id:'APT-009', patientName:'Alex Johnson', patientId:'P-001', doctorName:'Dr. James Wilson', docId:'D-001', date:'2026-01-22', time:'08:00 AM', duration: 60, type:'FNON Assessment', location:'OPD', status:'Completed', notes:'Morning assessment completed', room:'101' },
        { id:'APT-010', patientName:'Maria Gomez', patientId:'P-002', doctorName:'Dr. James Wilson', docId:'D-001', date:'2026-01-22', time:'09:00 AM', duration: 30, type:'Follow-up Consultation', location:'Online', status:'Completed', notes:'Follow-up visit', room:'102' },
        { id:'APT-011', patientName:'Liam Smith', patientId:'P-003', doctorName:'Dr. James Wilson', docId:'D-001', date:'2026-01-22', time:'10:00 AM', duration: 90, type:'Brain Mapping', location:'OPD', status:'Completed', notes:'Brain mapping session completed', room:'205' },
        { id:'APT-012', patientName:'Emma Chen', patientId:'P-004', doctorName:'Dr. James Wilson', docId:'D-001', date:'2026-01-22', time:'10:30 AM', duration: 45, type:'PRS Assessment', location:'OPD', status:'Completed', notes:'PRS evaluation completed', room:'101' },
        { id:'APT-013', patientName:'Oliver Brown', patientId:'P-005', doctorName:'Dr. James Wilson', docId:'D-001', date:'2026-01-22', time:'11:30 AM', duration: 30, type:'Treatment Review', location:'Ward', status:'Completed', notes:'Treatment progress reviewed', room:'304' },
        { id:'APT-014', patientName:'Sophie Martin', patientId:'P-006', doctorName:'Dr. James Wilson', docId:'D-001', date:'2026-01-22', time:'01:00 PM', duration: 60, type:'Initial Consultation', location:'OPD', status:'Completed', notes:'Initial consultation completed', room:'102' },
        { id:'APT-015', patientName:'James Wilson', patientId:'P-007', doctorName:'Dr. James Wilson', docId:'D-001', date:'2026-01-22', time:'02:00 PM', duration: 60, type:'FNON Assessment', location:'OPD', status:'Completed', notes:'FNON assessment completed', room:'205' },
        { id:'APT-016', patientName:'Isabella Rodriguez', patientId:'P-008', doctorName:'Dr. James Wilson', docId:'D-001', date:'2026-01-22', time:'02:30 PM', duration: 45, type:'Brain Mapping', location:'Online', status:'Scheduled', notes:'Brain mapping follow-up', room:'101' },
        { id:'APT-017', patientName:'Alex Johnson', patientId:'P-001', doctorName:'Dr. James Wilson', docId:'D-001', date:'2026-01-22', time:'03:30 PM', duration: 30, type:'Doctor Notes Review', location:'OPD', status:'Scheduled', notes:'Review doctors notes', room:'304' },
        { id:'APT-018', patientName:'Maria Gomez', patientId:'P-002', doctorName:'Dr. James Wilson', docId:'D-001', date:'2026-01-22', time:'04:30 PM', duration: 45, type:'Treatment Plan Discussion', location:'Ward', status:'Scheduled', notes:'Discuss ongoing treatment', room:'102' },
        { id:'APT-019', patientName:'Liam Smith', patientId:'P-003', doctorName:'Dr. James Wilson', docId:'D-001', date:'2026-01-22', time:'05:00 PM', duration: 30, type:'Final Report Review', location:'OPD', status:'Scheduled', notes:'Final assessment review', room:'205' },
        { id:'APT-020', patientName:'Emma Chen', patientId:'P-004', doctorName:'Dr. James Wilson', docId:'D-001', date:'2026-01-22', time:'05:30 PM', duration: 30, type:'Follow-up', location:'Online', status:'Scheduled', notes:'End of day follow-up', room:'101' },
        
        // January 23, 2026 (Tomorrow)
        { id:'APT-021', patientName:'Oliver Brown', patientId:'P-005', doctorName:'Dr. James Wilson', docId:'D-001', date:'2026-01-23', time:'08:30 AM', duration: 60, type:'FNON Assessment', location:'OPD', status:'Scheduled', notes:'Initial FNON evaluation', room:'101' },
        { id:'APT-022', patientName:'Sophie Martin', patientId:'P-006', doctorName:'Dr. James Wilson', docId:'D-001', date:'2026-01-23', time:'10:00 AM', duration: 45, type:'Brain Mapping', location:'OPD', status:'Scheduled', notes:'Brain mapping procedure', room:'205' },
        { id:'APT-023', patientName:'Alex Johnson', patientId:'P-001', doctorName:'Dr. James Wilson', docId:'D-001', date:'2026-01-23', time:'11:00 AM', duration: 30, type:'Follow-up', location:'Online', status:'Scheduled', notes:'Quick check-in session', room:'102' },
        { id:'APT-024', patientName:'Isabella Rodriguez', patientId:'P-008', doctorName:'Dr. James Wilson', docId:'D-001', date:'2026-01-23', time:'02:00 PM', duration: 60, type:'PRS Assessment', location:'OPD', status:'Scheduled', notes:'Comprehensive PRS evaluation', room:'304' },
        { id:'APT-025', patientName:'Maria Gomez', patientId:'P-002', doctorName:'Dr. James Wilson', docId:'D-001', date:'2026-01-23', time:'03:30 PM', duration: 45, type:'Treatment Review', location:'Ward', status:'Scheduled', notes:'Review treatment outcomes', room:'101' },
        { id:'APT-026', patientName:'Liam Smith', patientId:'P-003', doctorName:'Dr. James Wilson', docId:'D-001', date:'2026-01-23', time:'04:30 PM', duration: 30, type:'Consultation', location:'OPD', status:'Scheduled', notes:'General consultation', room:'205' },
        
        // January 24, 2026
        { id:'APT-027', patientName:'Emma Chen', patientId:'P-004', doctorName:'Dr. James Wilson', docId:'D-001', date:'2026-01-24', time:'09:00 AM', duration: 60, type:'Brain Mapping', location:'OPD', status:'Scheduled', notes:'Follow-up brain mapping', room:'101' },
        { id:'APT-028', patientName:'James Wilson', patientId:'P-007', doctorName:'Dr. James Wilson', docId:'D-001', date:'2026-01-24', time:'10:30 AM', duration: 45, type:'FNON Assessment', location:'OPD', status:'Scheduled', notes:'FNON follow-up assessment', room:'205' },
        { id:'APT-029', patientName:'Oliver Brown', patientId:'P-005', doctorName:'Dr. James Wilson', docId:'D-001', date:'2026-01-24', time:'01:00 PM', duration: 30, type:'Doctor Notes Review', location:'Online', status:'Scheduled', notes:'Review clinical notes', room:'102' },
        { id:'APT-030', patientName:'Sophie Martin', patientId:'P-006', doctorName:'Dr. James Wilson', docId:'D-001', date:'2026-01-24', time:'02:00 PM', duration: 60, type:'Treatment Plan Discussion', location:'OPD', status:'Scheduled', notes:'Discuss new treatment options', room:'304' },
        { id:'APT-031', patientName:'Alex Johnson', patientId:'P-001', doctorName:'Dr. James Wilson', docId:'D-001', date:'2026-01-24', time:'03:30 PM', duration: 45, type:'PRS Assessment', location:'Ward', status:'Scheduled', notes:'PRS evaluation session', room:'101' },
        
        // January 25, 2026
        { id:'APT-032', patientName:'Isabella Rodriguez', patientId:'P-008', doctorName:'Dr. James Wilson', docId:'D-001', date:'2026-01-25', time:'08:00 AM', duration: 60, type:'Initial Consultation', location:'OPD', status:'Scheduled', notes:'New patient consultation', room:'205' },
        { id:'APT-033', patientName:'Maria Gomez', patientId:'P-002', doctorName:'Dr. James Wilson', docId:'D-001', date:'2026-01-25', time:'09:30 AM', duration: 45, type:'Brain Mapping', location:'OPD', status:'Scheduled', notes:'Brain mapping session', room:'101' },
        { id:'APT-034', patientName:'Liam Smith', patientId:'P-003', doctorName:'Dr. James Wilson', docId:'D-001', date:'2026-01-25', time:'11:00 AM', duration: 30, type:'Follow-up', location:'Online', status:'Scheduled', notes:'Online follow-up consultation', room:'102' },
        { id:'APT-035', patientName:'Emma Chen', patientId:'P-004', doctorName:'Dr. James Wilson', docId:'D-001', date:'2026-01-25', time:'02:00 PM', duration: 60, type:'FNON Assessment', location:'OPD', status:'Scheduled', notes:'Complete FNON assessment', room:'304' },
        { id:'APT-036', patientName:'James Wilson', patientId:'P-007', doctorName:'Dr. James Wilson', docId:'D-001', date:'2026-01-25', time:'03:30 PM', duration: 45, type:'Treatment Review', location:'Ward', status:'Scheduled', notes:'Review ongoing treatment', room:'101' },
        
        // January 26, 2026
        { id:'APT-037', patientName:'Oliver Brown', patientId:'P-005', doctorName:'Dr. James Wilson', docId:'D-001', date:'2026-01-26', time:'09:00 AM', duration: 60, type:'Brain Mapping', location:'OPD', status:'Scheduled', notes:'Comprehensive brain mapping', room:'205' },
        { id:'APT-038', patientName:'Sophie Martin', patientId:'P-006', doctorName:'Dr. James Wilson', docId:'D-001', date:'2026-01-26', time:'10:30 AM', duration: 30, type:'Follow-up', location:'Online', status:'Scheduled', notes:'Virtual follow-up session', room:'102' },
        { id:'APT-039', patientName:'Alex Johnson', patientId:'P-001', doctorName:'Dr. James Wilson', docId:'D-001', date:'2026-01-26', time:'01:00 PM', duration: 45, type:'Final Report Review', location:'OPD', status:'Scheduled', notes:'Final report discussion', room:'101' },
        { id:'APT-040', patientName:'Isabella Rodriguez', patientId:'P-008', doctorName:'Dr. James Wilson', docId:'D-001', date:'2026-01-26', time:'02:30 PM', duration: 60, type:'PRS Assessment', location:'OPD', status:'Scheduled', notes:'PRS detailed evaluation', room:'304' },
        { id:'APT-041', patientName:'Maria Gomez', patientId:'P-002', doctorName:'Dr. James Wilson', docId:'D-001', date:'2026-01-26', time:'04:00 PM', duration: 30, type:'Consultation', location:'Ward', status:'Scheduled', notes:'Brief consultation', room:'205' },
        
        // January 27, 2026
        { id:'APT-042', patientName:'Liam Smith', patientId:'P-003', doctorName:'Dr. James Wilson', docId:'D-001', date:'2026-01-27', time:'08:30 AM', duration: 60, type:'FNON Assessment', location:'OPD', status:'Scheduled', notes:'Morning FNON assessment', room:'101' },
        { id:'APT-043', patientName:'Emma Chen', patientId:'P-004', doctorName:'Dr. James Wilson', docId:'D-001', date:'2026-01-27', time:'10:00 AM', duration: 45, type:'Brain Mapping', location:'OPD', status:'Scheduled', notes:'Brain mapping procedure', room:'205' },
        { id:'APT-044', patientName:'James Wilson', patientId:'P-007', doctorName:'Dr. James Wilson', docId:'D-001', date:'2026-01-27', time:'11:30 AM', duration: 30, type:'Treatment Plan Discussion', location:'Online', status:'Scheduled', notes:'Discuss treatment adjustments', room:'102' },
        { id:'APT-045', patientName:'Oliver Brown', patientId:'P-005', doctorName:'Dr. James Wilson', docId:'D-001', date:'2026-01-27', time:'02:00 PM', duration: 60, type:'Follow-up Consultation', location:'OPD', status:'Scheduled', notes:'Follow-up on previous assessment', room:'304' },
        { id:'APT-046', patientName:'Sophie Martin', patientId:'P-006', doctorName:'Dr. James Wilson', docId:'D-001', date:'2026-01-27', time:'03:30 PM', duration: 45, type:'Doctor Notes Review', location:'Ward', status:'Scheduled', notes:'Review medical notes', room:'101' },
        
        // January 28, 2026
        { id:'APT-047', patientName:'Alex Johnson', patientId:'P-001', doctorName:'Dr. James Wilson', docId:'D-001', date:'2026-01-28', time:'09:00 AM', duration: 60, type:'Brain Mapping', location:'OPD', status:'Scheduled', notes:'Weekly brain mapping session', room:'205' },
        { id:'APT-048', patientName:'Isabella Rodriguez', patientId:'P-008', doctorName:'Dr. James Wilson', docId:'D-001', date:'2026-01-28', time:'10:30 AM', duration: 45, type:'FNON Assessment', location:'OPD', status:'Scheduled', notes:'FNON evaluation', room:'101' },
        { id:'APT-049', patientName:'Maria Gomez', patientId:'P-002', doctorName:'Dr. James Wilson', docId:'D-001', date:'2026-01-28', time:'01:00 PM', duration: 30, type:'Follow-up', location:'Online', status:'Scheduled', notes:'Virtual check-in', room:'102' },
        { id:'APT-050', patientName:'Liam Smith', patientId:'P-003', doctorName:'Dr. James Wilson', docId:'D-001', date:'2026-01-28', time:'02:00 PM', duration: 60, type:'PRS Assessment', location:'OPD', status:'Scheduled', notes:'PRS comprehensive review', room:'304' },
        { id:'APT-051', patientName:'Emma Chen', patientId:'P-004', doctorName:'Dr. James Wilson', docId:'D-001', date:'2026-01-28', time:'03:30 PM', duration: 45, type:'Treatment Review', location:'Ward', status:'Scheduled', notes:'End of week treatment review', room:'205' }
      ]
    };

    // ===== RECEPTIONIST PORTAL DATA =====
    // Appointment services/sessions with durations
    const appointmentServices = [
      { id: 'fnon', name: 'FNON Assessment', duration: 60, description: 'Neurological assessment' },
      { id: 'brainmap', name: 'Brain Mapping', duration: 45, description: 'EEG brain mapping session' },
      { id: 'prs', name: 'PRS Assessment', duration: 30, description: 'Polygenic risk score evaluation' },
      { id: 'followup', name: 'Follow-up Consultation', duration: 30, description: 'Follow-up visit' },
      { id: 'initialconsult', name: 'Initial Consultation', duration: 45, description: 'First-time patient consultation' },
      { id: 'finalreport', name: 'Final Report Review', duration: 30, description: 'Review of treatment outcomes' },
      { id: 'tms', name: 'TMS Treatment Session', duration: 40, description: 'Transcranial magnetic stimulation' }
    ];

    // Clinic locations with available doctors
    const clinicLocations = [
      { id: 'CLINIC-NIK', name: 'Nicosia', country: 'Cyprus', address: 'Nicosia Medical Center', doctors: ['DR-001', 'DR-002', 'DR-005'], phone: '+357-22-123456', email: 'nicosia@sozobrain.com' },
      { id: 'CLINIC-LIM', name: 'Limassol', country: 'Cyprus', address: 'Limassol Health Complex', doctors: ['DR-003', 'DR-004'], phone: '+357-25-789012', email: 'limassol@sozobrain.com' },
      { id: 'CLINIC-LON', name: 'London', country: 'United Kingdom', address: 'London Brain Clinic', doctors: ['DR-001', 'DR-003'], phone: '+44-20-7946-0958', email: 'london@sozobrain.com' },
      { id: 'CLINIC-BER', name: 'Berlin', country: 'Germany', address: 'Berlin Neuroscience Hub', doctors: ['DR-002', 'DR-004', 'DR-005'], phone: '+49-30-12345678', email: 'berlin@sozobrain.com' }
    ];

    // Doctor schedules (working hours and availability per day)
    const doctorSchedules = {
      'DR-001': { workDays: [1,2,3,4,5], startTime: '08:00', endTime: '18:00', breakTime: '12:00-13:00', slotDuration: 30 },
      'DR-002': { workDays: [1,2,3,4,5], startTime: '09:00', endTime: '17:00', breakTime: '13:00-14:00', slotDuration: 30 },
      'DR-003': { workDays: [1,3,4,5], startTime: '08:30', endTime: '17:30', breakTime: '12:30-13:30', slotDuration: 30 },
      'DR-004': { workDays: [2,3,4,5], startTime: '10:00', endTime: '18:00', breakTime: '13:00-14:00', slotDuration: 30 },
      'DR-005': { workDays: [1,2,3,5], startTime: '09:00', endTime: '17:00', breakTime: '12:00-13:00', slotDuration: 30 }
    };

    // Global receptionist appointment store
    let receptionist_appointments = [
      // January 22, 2026 - Nicosia Clinic
      { id: 'APPT-001', clinicId: 'CLINIC-NIK', doctorId: 'DR-001', patientId: 'PAT-001', patientName: 'Alex Johnson', doctorName: 'Dr. James Wilson', clinicName: 'Nicosia', date: '2026-01-22', startTime: '10:00', endTime: '11:00', service: 'fnon', room: 'Room 101', status: 'Scheduled', notes: 'Initial assessment' },
      { id: 'APPT-005', clinicId: 'CLINIC-NIK', doctorId: 'DR-001', patientId: 'PAT-005', patientName: 'John Doe', doctorName: 'Dr. James Wilson', clinicName: 'Nicosia', date: '2026-01-22', startTime: '11:15', endTime: '11:45', service: 'prs', room: 'Room 102', status: 'Scheduled', notes: 'PRS evaluation' },
      { id: 'APPT-006', clinicId: 'CLINIC-NIK', doctorId: 'DR-002', patientId: 'PAT-006', patientName: 'Sarah Wilson', doctorName: 'Dr. Sarah Smith', clinicName: 'Nicosia', date: '2026-01-22', startTime: '13:30', endTime: '14:30', service: 'brainmap', room: 'Room 103', status: 'Scheduled', notes: 'Brain mapping session' },
      
      // January 22, 2026 - Limassol Clinic
      { id: 'APPT-002', clinicId: 'CLINIC-LIM', doctorId: 'DR-002', patientId: 'PAT-002', patientName: 'Maria Gomez', doctorName: 'Dr. Sarah Smith', clinicName: 'Limassol', date: '2026-01-22', startTime: '14:00', endTime: '14:45', service: 'brainmap', room: 'Room 201', status: 'Scheduled', notes: 'Follow-up brain mapping' },
      { id: 'APPT-007', clinicId: 'CLINIC-LIM', doctorId: 'DR-003', patientId: 'PAT-007', patientName: 'Michael Brown', doctorName: 'Dr. Rajesh Patel', clinicName: 'Limassol', date: '2026-01-22', startTime: '15:45', endTime: '16:15', service: 'followup', room: 'Room 202', status: 'Scheduled', notes: 'Follow-up consultation' },
      
      // January 23, 2026
      { id: 'APPT-003', clinicId: 'CLINIC-NIK', doctorId: 'DR-001', patientId: 'PAT-003', patientName: 'Liam Smith', doctorName: 'Dr. James Wilson', clinicName: 'Nicosia', date: '2026-01-23', startTime: '11:00', endTime: '11:30', service: 'prs', room: 'Room 102', status: 'Scheduled', notes: '' },
      { id: 'APPT-008', clinicId: 'CLINIC-LIM', doctorId: 'DR-003', patientId: 'PAT-008', patientName: 'Jessica Lee', doctorName: 'Dr. Rajesh Patel', clinicName: 'Limassol', date: '2026-01-23', startTime: '09:30', endTime: '10:30', service: 'initialconsult', room: 'Room 201', status: 'Scheduled', notes: 'New patient consultation' },
      { id: 'APPT-009', clinicId: 'CLINIC-LON', doctorId: 'DR-004', patientId: 'PAT-009', patientName: 'David Miller', doctorName: 'Dr. Emily Rodriguez', clinicName: 'London', date: '2026-01-23', startTime: '14:15', endTime: '14:45', service: 'tms', room: 'Room 301', status: 'Scheduled', notes: 'TMS treatment session' },
      
      // January 24, 2026
      { id: 'APPT-004', clinicId: 'CLINIC-LIM', doctorId: 'DR-003', patientId: 'PAT-004', patientName: 'Emma Chen', doctorName: 'Dr. Rajesh Patel', clinicName: 'Limassol', date: '2026-01-24', startTime: '15:00', endTime: '15:30', service: 'followup', room: 'Room 203', status: 'Scheduled', notes: 'Routine check-up' },
      { id: 'APPT-010', clinicId: 'CLINIC-NIK', doctorId: 'DR-005', patientId: 'PAT-010', patientName: 'Lisa Anderson', doctorName: 'Dr. Lisa Chen', clinicName: 'Nicosia', date: '2026-01-24', startTime: '10:45', endTime: '11:45', service: 'fnon', room: 'Room 104', status: 'Scheduled', notes: 'FNON assessment' },
      { id: 'APPT-011', clinicId: 'CLINIC-BER', doctorId: 'DR-001', patientId: 'PAT-011', patientName: 'Robert Taylor', doctorName: 'Dr. James Wilson', clinicName: 'Berlin', date: '2026-01-24', startTime: '13:00', endTime: '14:00', service: 'brainmap', room: 'Room 401', status: 'Scheduled', notes: 'EEG brain mapping' },
      
      // January 25, 2026
      { id: 'APPT-012', clinicId: 'CLINIC-LON', doctorId: 'DR-002', patientId: 'PAT-012', patientName: 'Amanda White', doctorName: 'Dr. Sarah Smith', clinicName: 'London', date: '2026-01-25', startTime: '11:30', endTime: '12:15', service: 'initialconsult', room: 'Room 302', status: 'Scheduled', notes: 'Initial consultation' },
      { id: 'APPT-013', clinicId: 'CLINIC-BER', doctorId: 'DR-005', patientId: 'PAT-013', patientName: 'Daniel Harris', doctorName: 'Dr. Lisa Chen', clinicName: 'Berlin', date: '2026-01-25', startTime: '15:30', endTime: '16:00', service: 'prs', room: 'Room 402', status: 'Scheduled', notes: 'PRS evaluation' },
      { id: 'APPT-014', clinicId: 'CLINIC-NIK', doctorId: 'DR-002', patientId: 'PAT-014', patientName: 'Catherine Martin', doctorName: 'Dr. Sarah Smith', clinicName: 'Nicosia', date: '2026-01-25', startTime: '09:00', endTime: '10:00', service: 'tms', room: 'Room 105', status: 'Scheduled', notes: 'TMS treatment' },
      
      // January 26, 2026
      { id: 'APPT-015', clinicId: 'CLINIC-LIM', doctorId: 'DR-004', patientId: 'PAT-015', patientName: 'Kevin Davis', doctorName: 'Dr. Emily Rodriguez', clinicName: 'Limassol', date: '2026-01-26', startTime: '12:00', endTime: '13:00', service: 'fnon', room: 'Room 204', status: 'Scheduled', notes: 'Neurological assessment' },
      { id: 'APPT-016', clinicId: 'CLINIC-BER', doctorId: 'DR-003', patientId: 'PAT-016', patientName: 'Rachel Garcia', doctorName: 'Dr. Rajesh Patel', clinicName: 'Berlin', date: '2026-01-26', startTime: '14:45', endTime: '15:30', service: 'brainmap', room: 'Room 403', status: 'Scheduled', notes: 'Follow-up brain mapping' },
      { id: 'APPT-017', clinicId: 'CLINIC-LON', doctorId: 'DR-005', patientId: 'PAT-017', patientName: 'Thomas Jackson', doctorName: 'Dr. Lisa Chen', clinicName: 'London', date: '2026-01-26', startTime: '10:15', endTime: '11:00', service: 'followup', room: 'Room 303', status: 'Scheduled', notes: 'Routine follow-up' }
    ];

    // Patient reports & appointments (demo data)
    const patientReports = [
      // Alex Johnson reports (current user - extensive history)
      {date:'2024-12-28', patient:'Alex Johnson', type:'FNON Report', doctor:'Dr. Wilson', country:'United Kingdom', status:'Finalized', id:'FR-9821'},
      {date:'2024-12-27', patient:'Alex Johnson', type:'Blood Work', doctor:'Dr. Patel', country:'United Kingdom', status:'Finalized', id:'BW-5512'},
      {date:'2024-12-25', patient:'Alex Johnson', type:'X-Ray', doctor:'Dr. Lee', country:'United Kingdom', status:'Finalized', id:'XR-4421'},
      {date:'2024-12-23', patient:'Alex Johnson', type:'CT Scan', doctor:'Dr. Wilson', country:'United Kingdom', status:'Finalized', id:'CT-8831'},
      {date:'2024-12-19', patient:'Alex Johnson', type:'PRS Report', doctor:'Dr. Gomez', country:'United Kingdom', status:'Finalized', id:'PR-7742'},
      {date:'2024-12-17', patient:'Alex Johnson', type:'ECG Report', doctor:'Dr. Wilson', country:'United Kingdom', status:'Finalized', id:'EC-2231'},
      {date:'2024-12-15', patient:'Alex Johnson', type:'MRI', doctor:'Dr. Lee', country:'United Kingdom', status:'Finalized', id:'MR-7711'},
      {date:'2024-12-13', patient:'Alex Johnson', type:'Ultrasound', doctor:'Dr. Patel', country:'United Kingdom', status:'Finalized', id:'US-9952'},
      {date:'2024-12-09', patient:'Alex Johnson', type:'Blood Work', doctor:'Dr. Lee', country:'United Kingdom', status:'Finalized', id:'BW-6663'},
      {date:'2024-12-07', patient:'Alex Johnson', type:'Mammography', doctor:'Dr. Gomez', country:'United Kingdom', status:'Finalized', id:'MM-1174'},
      {date:'2024-12-04', patient:'Alex Johnson', type:'X-Ray', doctor:'Dr. Wilson', country:'United Kingdom', status:'Finalized', id:'XR-5585'},
      {date:'2024-12-02', patient:'Alex Johnson', type:'Bone Density', doctor:'Dr. Patel', country:'United Kingdom', status:'Finalized', id:'BD-3396'},
      {date:'2024-11-30', patient:'Alex Johnson', type:'FNON Report', doctor:'Dr. Lee', country:'United Kingdom', status:'Finalized', id:'FR-4407'},
      {date:'2024-11-28', patient:'Alex Johnson', type:'X-Ray', doctor:'Dr. Patel', country:'United Kingdom', status:'Finalized', id:'XR-8832'},
      {date:'2024-11-26', patient:'Alex Johnson', type:'CT Scan', doctor:'Dr. Gomez', country:'United Kingdom', status:'Finalized', id:'CT-2218'},
      {date:'2024-11-24', patient:'Alex Johnson', type:'Blood Work', doctor:'Dr. Wilson', country:'United Kingdom', status:'Finalized', id:'BW-9929'},
      {date:'2024-11-22', patient:'Alex Johnson', type:'PRS Report', doctor:'Dr. Lee', country:'United Kingdom', status:'Pending', id:'PR-7740'},
      {date:'2024-11-18', patient:'Alex Johnson', type:'MRI', doctor:'Dr. Patel', country:'United Kingdom', status:'Finalized', id:'MR-6651'},
      {date:'2024-11-16', patient:'Alex Johnson', type:'ECG Report', doctor:'Dr. Gomez', country:'United Kingdom', status:'Finalized', id:'EC-1162'},
      {date:'2024-11-13', patient:'Alex Johnson', type:'Ultrasound', doctor:'Dr. Wilson', country:'United Kingdom', status:'Finalized', id:'US-8883'},
      {date:'2024-11-11', patient:'Alex Johnson', type:'X-Ray', doctor:'Dr. Lee', country:'United Kingdom', status:'Finalized', id:'XR-5594'},
      {date:'2024-11-08', patient:'Alex Johnson', type:'Blood Work', doctor:'Dr. Patel', country:'United Kingdom', status:'Finalized', id:'BW-3325'},
      {date:'2024-11-06', patient:'Alex Johnson', type:'FNON Report', doctor:'Dr. Gomez', country:'United Kingdom', status:'Finalized', id:'FR-7716'},
      {date:'2024-11-05', patient:'Alex Johnson', type:'Thyroid Panel', doctor:'Dr. Gomez', country:'United Kingdom', status:'Finalized', id:'TH-9988'},
      {date:'2024-11-03', patient:'Alex Johnson', type:'CT Scan', doctor:'Dr. Wilson', country:'United Kingdom', status:'Finalized', id:'CT-2227'},
      {date:'2024-11-01', patient:'Alex Johnson', type:'X-Ray', doctor:'Dr. Lee', country:'United Kingdom', status:'Finalized', id:'XR-6638'},
      {date:'2024-10-29', patient:'Alex Johnson', type:'PRS Report', doctor:'Dr. Patel', country:'United Kingdom', status:'Finalized', id:'PR-4449'},
      {date:'2024-10-27', patient:'Alex Johnson', type:'Blood Work', doctor:'Dr. Gomez', country:'United Kingdom', status:'Finalized', id:'BW-1150'},
      {date:'2024-10-25', patient:'Alex Johnson', type:'MRI', doctor:'Dr. Wilson', country:'United Kingdom', status:'Finalized', id:'MR-8861'},
      {date:'2024-10-23', patient:'Alex Johnson', type:'ECG Report', doctor:'Dr. Lee', country:'United Kingdom', status:'Finalized', id:'EC-5572'},
      {date:'2024-10-21', patient:'Alex Johnson', type:'Ultrasound', doctor:'Dr. Patel', country:'United Kingdom', status:'Finalized', id:'US-2283'},
      {date:'2024-10-19', patient:'Alex Johnson', type:'X-Ray', doctor:'Dr. Gomez', country:'United Kingdom', status:'Finalized', id:'XR-9994'},
      {date:'2024-10-17', patient:'Alex Johnson', type:'FNON Report', doctor:'Dr. Wilson', country:'United Kingdom', status:'Finalized', id:'FR-6605'},
      {date:'2024-10-15', patient:'Alex Johnson', type:'Blood Work', doctor:'Dr. Lee', country:'United Kingdom', status:'Finalized', id:'BW-3316'},
      {date:'2024-10-12', patient:'Alex Johnson', type:'Lipid Panel', doctor:'Dr. Patel', country:'United Kingdom', status:'Finalized', id:'LP-2205'},
      {date:'2024-10-09', patient:'Alex Johnson', type:'Vitamin D Test', doctor:'Dr. Wilson', country:'United Kingdom', status:'Finalized', id:'VD-8894'},
      {date:'2024-10-05', patient:'Alex Johnson', type:'CT Scan', doctor:'Dr. Lee', country:'United Kingdom', status:'Finalized', id:'CT-5583'},
      {date:'2024-10-01', patient:'Alex Johnson', type:'FNON Report', doctor:'Dr. Gomez', country:'United Kingdom', status:'Finalized', id:'FR-1172'},
      // Other patients' reports
      {date:'2024-12-26', patient:'Maria Gomez', type:'MRI', doctor:'Dr. Patel', country:'Spain', status:'Finalized', id:'MR-5532'},
      {date:'2024-12-24', patient:'Liam Smith', type:'CT Scan', doctor:'Dr. Lee', country:'United Kingdom', status:'Finalized', id:'CT-2211'},
      {date:'2024-12-22', patient:'Emma Chen', type:'PRS Report', doctor:'Dr. Wilson', country:'Germany', status:'Finalized', id:'PR-4456'},
      {date:'2024-12-20', patient:'Noah Brown', type:'Blood Work', doctor:'Dr. Gomez', country:'France', status:'Pending', id:'BW-7789'},
      {date:'2024-12-18', patient:'Sophia Martinez', type:'FNON Report', doctor:'Dr. Wilson', country:'Spain', status:'Finalized', id:'FR-3344'},
      {date:'2024-12-15', patient:'Oliver Davis', type:'X-Ray', doctor:'Dr. Patel', country:'United Kingdom', status:'Finalized', id:'XR-1122'},
      {date:'2024-12-13', patient:'Isabella Garcia', type:'MRI', doctor:'Dr. Lee', country:'Spain', status:'Finalized', id:'MR-6677'},
      {date:'2024-12-10', patient:'James Wilson', type:'CT Scan', doctor:'Dr. Patel', country:'United Kingdom', status:'Finalized', id:'CT-9988'},
      {date:'2024-12-08', patient:'Amelia Rodriguez', type:'PRS Report', doctor:'Dr. Wilson', country:'Germany', status:'Finalized', id:'PR-5544'},
      {date:'2024-12-05', patient:'Benjamin Lee', type:'FNON Report', doctor:'Dr. Wilson', country:'France', status:'Finalized', id:'FR-7722'},
      {date:'2024-12-03', patient:'Mia Anderson', type:'Blood Work', doctor:'Dr. Gomez', country:'United Kingdom', status:'Finalized', id:'BW-3311'},
      {date:'2024-11-30', patient:'Lucas Thomas', type:'MRI', doctor:'Dr. Lee', country:'Germany', status:'Finalized', id:'MR-8899'},
      {date:'2024-11-28', patient:'Charlotte Taylor', type:'CT Scan', doctor:'Dr. Patel', country:'Spain', status:'Finalized', id:'CT-4455'},
      {date:'2024-11-25', patient:'Henry Moore', type:'FNON Report', doctor:'Dr. Wilson', country:'United Kingdom', status:'Finalized', id:'FR-1188'},
      {date:'2024-11-22', patient:'Evelyn Jackson', type:'X-Ray', doctor:'Dr. Lee', country:'France', status:'Finalized', id:'XR-2299'},
      {date:'2024-11-18', patient:'Sebastian White', type:'PRS Report', doctor:'Dr. Wilson', country:'Germany', status:'Pending', id:'PR-6633'},
      {date:'2024-11-15', patient:'Harper Harris', type:'Blood Work', doctor:'Dr. Gomez', country:'Spain', status:'Finalized', id:'BW-9944'},
      {date:'2024-11-10', patient:'Jack Martin', type:'MRI', doctor:'Dr. Patel', country:'United Kingdom', status:'Finalized', id:'MR-7755'},
      {date:'2024-11-05', patient:'Aria Thompson', type:'CT Scan', doctor:'Dr. Lee', country:'France', status:'Finalized', id:'CT-1166'},
      
      // Maria Gomez (PAT-002) - Additional reports
      {date:'2024-12-15', patient:'Maria Gomez', type:'FNON Report', doctor:'Dr. Wilson', country:'Spain', status:'Finalized', id:'FR-9012'},
      {date:'2024-11-28', patient:'Maria Gomez', type:'Blood Work', doctor:'Dr. Patel', country:'Spain', status:'Finalized', id:'BW-3456'},
      {date:'2024-11-10', patient:'Maria Gomez', type:'Brain Mapping', doctor:'Dr. Wilson', country:'Spain', status:'Finalized', id:'BM-7890'},
      {date:'2024-10-22', patient:'Maria Gomez', type:'X-Ray', doctor:'Dr. Lee', country:'Spain', status:'Finalized', id:'XR-2345'},
      
      // Liam Smith (PAT-003) - Additional reports
      {date:'2024-12-20', patient:'Liam Smith', type:'FNON Report', doctor:'Dr. Wilson', country:'UK', status:'Finalized', id:'FR-5678'},
      {date:'2024-12-05', patient:'Liam Smith', type:'PRS Report', doctor:'Dr. Gomez', country:'UK', status:'Finalized', id:'PR-9123'},
      {date:'2024-11-18', patient:'Liam Smith', type:'MRI', doctor:'Dr. Patel', country:'UK', status:'Finalized', id:'MR-4567'},
      {date:'2024-10-30', patient:'Liam Smith', type:'Blood Work', doctor:'Dr. Lee', country:'UK', status:'Finalized', id:'BW-8901'},
      
      // Emma Chen (PAT-004) - Additional reports
      {date:'2024-12-18', patient:'Emma Chen', type:'Brain Mapping', doctor:'Dr. Wilson', country:'USA', status:'Finalized', id:'BM-3456'},
      {date:'2024-12-01', patient:'Emma Chen', type:'FNON Report', doctor:'Dr. Patel', country:'USA', status:'Finalized', id:'FR-7890'},
      {date:'2024-11-15', patient:'Emma Chen', type:'ECG Report', doctor:'Dr. Lee', country:'USA', status:'Finalized', id:'EC-1234'},
      {date:'2024-10-28', patient:'Emma Chen', type:'CT Scan', doctor:'Dr. Gomez', country:'USA', status:'Finalized', id:'CT-5678'},
      
      // Oliver Brown (PAT-005) - Additional reports
      {date:'2024-12-10', patient:'Oliver Brown', type:'FNON Report', doctor:'Dr. Wilson', country:'Australia', status:'Finalized', id:'FR-2345'},
      {date:'2024-11-25', patient:'Oliver Brown', type:'Blood Work', doctor:'Dr. Patel', country:'Australia', status:'Finalized', id:'BW-6789'},
      {date:'2024-11-08', patient:'Oliver Brown', type:'X-Ray', doctor:'Dr. Lee', country:'Australia', status:'Finalized', id:'XR-0123'},
      {date:'2024-10-20', patient:'Oliver Brown', type:'PRS Report', doctor:'Dr. Gomez', country:'Australia', status:'Finalized', id:'PR-4567'},
      
      // Sophie Martin (PAT-006) - Additional reports
      {date:'2024-12-22', patient:'Sophie Martin', type:'Brain Mapping', doctor:'Dr. Wilson', country:'France', status:'Finalized', id:'BM-8901'},
      {date:'2024-12-08', patient:'Sophie Martin', type:'FNON Report', doctor:'Dr. Patel', country:'France', status:'Finalized', id:'FR-2345'},
      {date:'2024-11-20', patient:'Sophie Martin', type:'MRI', doctor:'Dr. Lee', country:'France', status:'Finalized', id:'MR-6789'},
      {date:'2024-11-02', patient:'Sophie Martin', type:'Blood Work', doctor:'Dr. Gomez', country:'France', status:'Finalized', id:'BW-0123'},
      
      // James Wilson (PAT-007) - Additional reports
      {date:'2024-12-16', patient:'James Wilson', type:'FNON Report', doctor:'Dr. Wilson', country:'Canada', status:'Finalized', id:'FR-4567'},
      {date:'2024-11-30', patient:'James Wilson', type:'PRS Report', doctor:'Dr. Patel', country:'Canada', status:'Finalized', id:'PR-8901'},
      {date:'2024-11-12', patient:'James Wilson', type:'Brain Mapping', doctor:'Dr. Lee', country:'Canada', status:'Finalized', id:'BM-2345'},
      {date:'2024-10-25', patient:'James Wilson', type:'ECG Report', doctor:'Dr. Gomez', country:'Canada', status:'Finalized', id:'EC-6789'},
      
      // Isabella Rodriguez (PAT-008) - Additional reports
      {date:'2024-12-19', patient:'Isabella Rodriguez', type:'FNON Report', doctor:'Dr. Wilson', country:'Mexico', status:'Finalized', id:'FR-0123'},
      {date:'2024-12-02', patient:'Isabella Rodriguez', type:'X-Ray', doctor:'Dr. Patel', country:'Mexico', status:'Finalized', id:'XR-4567'},
      {date:'2024-11-14', patient:'Isabella Rodriguez', type:'Blood Work', doctor:'Dr. Lee', country:'Mexico', status:'Finalized', id:'BW-8901'},
      {date:'2024-10-27', patient:'Isabella Rodriguez', type:'MRI', doctor:'Dr. Gomez', country:'Mexico', status:'Finalized', id:'MR-2345'},
      
      // Noah Anderson (PAT-009) - New reports
      {date:'2024-12-21', patient:'Noah Anderson', type:'FNON Report', doctor:'Dr. Wilson', country:'Sweden', status:'Finalized', id:'FR-6789'},
      {date:'2024-12-04', patient:'Noah Anderson', type:'Brain Mapping', doctor:'Dr. Patel', country:'Sweden', status:'Finalized', id:'BM-0123'},
      {date:'2024-11-16', patient:'Noah Anderson', type:'PRS Report', doctor:'Dr. Lee', country:'Sweden', status:'Finalized', id:'PR-4567'},
      {date:'2024-10-29', patient:'Noah Anderson', type:'CT Scan', doctor:'Dr. Gomez', country:'Sweden', status:'Finalized', id:'CT-8901'},
      
      // Mia Taylor (PAT-010) - New reports
      {date:'2024-12-23', patient:'Mia Taylor', type:'FNON Report', doctor:'Dr. Wilson', country:'Ireland', status:'Finalized', id:'FR-2345'},
      {date:'2024-12-07', patient:'Mia Taylor', type:'Blood Work', doctor:'Dr. Patel', country:'Ireland', status:'Finalized', id:'BW-6789'},
      {date:'2024-11-19', patient:'Mia Taylor', type:'Brain Mapping', doctor:'Dr. Lee', country:'Ireland', status:'Finalized', id:'BM-0123'},
      {date:'2024-11-01', patient:'Mia Taylor', type:'X-Ray', doctor:'Dr. Gomez', country:'Ireland', status:'Finalized', id:'XR-4567'},
      
      // Ethan White (PAT-011) - New reports
      {date:'2024-12-11', patient:'Ethan White', type:'FNON Report', doctor:'Dr. Wilson', country:'Netherlands', status:'Finalized', id:'FR-8901'},
      {date:'2024-11-23', patient:'Ethan White', type:'PRS Report', doctor:'Dr. Patel', country:'Netherlands', status:'Finalized', id:'PR-2345'},
      {date:'2024-11-05', patient:'Ethan White', type:'MRI', doctor:'Dr. Lee', country:'Netherlands', status:'Finalized', id:'MR-6789'},
      {date:'2024-10-18', patient:'Ethan White', type:'Blood Work', doctor:'Dr. Gomez', country:'Netherlands', status:'Finalized', id:'BW-0123'},
      
      // Ava Martinez (PAT-012) - New reports
      {date:'2024-12-14', patient:'Ava Martinez', type:'Brain Mapping', doctor:'Dr. Wilson', country:'Portugal', status:'Finalized', id:'BM-4567'},
      {date:'2024-11-26', patient:'Ava Martinez', type:'FNON Report', doctor:'Dr. Patel', country:'Portugal', status:'Finalized', id:'FR-8901'},
      {date:'2024-11-08', patient:'Ava Martinez', type:'CT Scan', doctor:'Dr. Lee', country:'Portugal', status:'Finalized', id:'CT-2345'},
      {date:'2024-10-21', patient:'Ava Martinez', type:'ECG Report', doctor:'Dr. Gomez', country:'Portugal', status:'Finalized', id:'EC-6789'},
      
      // William Garcia (PAT-013) - New reports
      {date:'2024-12-17', patient:'William Garcia', type:'FNON Report', doctor:'Dr. Wilson', country:'Italy', status:'Finalized', id:'FR-0123'},
      {date:'2024-11-29', patient:'William Garcia', type:'PRS Report', doctor:'Dr. Patel', country:'Italy', status:'Finalized', id:'PR-4567'},
      {date:'2024-11-11', patient:'William Garcia', type:'Blood Work', doctor:'Dr. Lee', country:'Italy', status:'Finalized', id:'BW-8901'},
      {date:'2024-10-24', patient:'William Garcia', type:'Brain Mapping', doctor:'Dr. Gomez', country:'Italy', status:'Finalized', id:'BM-2345'},
      
      // Charlotte Lee (PAT-014) - New reports
      {date:'2024-12-25', patient:'Charlotte Lee', type:'FNON Report', doctor:'Dr. Wilson', country:'Singapore', status:'Finalized', id:'FR-6789'},
      {date:'2024-12-09', patient:'Charlotte Lee', type:'MRI', doctor:'Dr. Patel', country:'Singapore', status:'Finalized', id:'MR-0123'},
      {date:'2024-11-21', patient:'Charlotte Lee', type:'X-Ray', doctor:'Dr. Lee', country:'Singapore', status:'Finalized', id:'XR-4567'},
      {date:'2024-11-03', patient:'Charlotte Lee', type:'Blood Work', doctor:'Dr. Gomez', country:'Singapore', status:'Finalized', id:'BW-8901'},
      
      // Benjamin Kim (PAT-015) - New reports
      {date:'2024-12-13', patient:'Benjamin Kim', type:'Brain Mapping', doctor:'Dr. Wilson', country:'South Korea', status:'Finalized', id:'BM-2345'},
      {date:'2024-11-24', patient:'Benjamin Kim', type:'FNON Report', doctor:'Dr. Patel', country:'South Korea', status:'Finalized', id:'FR-6789'},
      {date:'2024-11-06', patient:'Benjamin Kim', type:'PRS Report', doctor:'Dr. Lee', country:'South Korea', status:'Finalized', id:'PR-0123'},
      {date:'2024-10-19', patient:'Benjamin Kim', type:'CT Scan', doctor:'Dr. Gomez', country:'South Korea', status:'Finalized', id:'CT-4567'},
      
      // Amelia Patel (PAT-016) - New reports
      {date:'2024-12-20', patient:'Amelia Patel', type:'FNON Report', doctor:'Dr. Wilson', country:'India', status:'Finalized', id:'FR-8901'},
      {date:'2024-12-03', patient:'Amelia Patel', type:'Brain Mapping', doctor:'Dr. Patel', country:'India', status:'Finalized', id:'BM-2345'},
      {date:'2024-11-15', patient:'Amelia Patel', type:'Blood Work', doctor:'Dr. Lee', country:'India', status:'Finalized', id:'BW-6789'},
      {date:'2024-10-28', patient:'Amelia Patel', type:'ECG Report', doctor:'Dr. Gomez', country:'India', status:'Finalized', id:'EC-0123'},
      
      // Lucas Silva (PAT-017) - New reports
      {date:'2024-12-18', patient:'Lucas Silva', type:'FNON Report', doctor:'Dr. Wilson', country:'Brazil', status:'Finalized', id:'FR-4567'},
      {date:'2024-11-30', patient:'Lucas Silva', type:'PRS Report', doctor:'Dr. Patel', country:'Brazil', status:'Finalized', id:'PR-8901'},
      {date:'2024-11-12', patient:'Lucas Silva', type:'MRI', doctor:'Dr. Lee', country:'Brazil', status:'Finalized', id:'MR-2345'},
      {date:'2024-10-25', patient:'Lucas Silva', type:'X-Ray', doctor:'Dr. Gomez', country:'Brazil', status:'Finalized', id:'XR-6789'},
      
      // Harper Nguyen (PAT-018) - New reports
      {date:'2024-12-24', patient:'Harper Nguyen', type:'Brain Mapping', doctor:'Dr. Wilson', country:'Vietnam', status:'Finalized', id:'BM-0123'},
      {date:'2024-12-06', patient:'Harper Nguyen', type:'FNON Report', doctor:'Dr. Patel', country:'Vietnam', status:'Finalized', id:'FR-4567'},
      {date:'2024-11-18', patient:'Harper Nguyen', type:'Blood Work', doctor:'Dr. Lee', country:'Vietnam', status:'Finalized', id:'BW-8901'},
      {date:'2024-10-31', patient:'Harper Nguyen', type:'CT Scan', doctor:'Dr. Gomez', country:'Vietnam', status:'Finalized', id:'CT-2345'},
      
      // Alexander Berg (PAT-019) - New reports
      {date:'2024-12-16', patient:'Alexander Berg', type:'FNON Report', doctor:'Dr. Wilson', country:'Norway', status:'Finalized', id:'FR-6789'},
      {date:'2024-11-28', patient:'Alexander Berg', type:'PRS Report', doctor:'Dr. Patel', country:'Norway', status:'Finalized', id:'PR-0123'},
      {date:'2024-11-10', patient:'Alexander Berg', type:'Brain Mapping', doctor:'Dr. Lee', country:'Norway', status:'Finalized', id:'BM-4567'},
      {date:'2024-10-23', patient:'Alexander Berg', type:'ECG Report', doctor:'Dr. Gomez', country:'Norway', status:'Finalized', id:'EC-8901'},
      
      // Sofia Kowalski (PAT-020) - New reports
      {date:'2024-12-26', patient:'Sofia Kowalski', type:'FNON Report', doctor:'Dr. Wilson', country:'Poland', status:'Finalized', id:'FR-2345'},
      {date:'2024-12-08', patient:'Sofia Kowalski', type:'Brain Mapping', doctor:'Dr. Patel', country:'Poland', status:'Finalized', id:'BM-6789'},
      {date:'2024-11-20', patient:'Sofia Kowalski', type:'MRI', doctor:'Dr. Lee', country:'Poland', status:'Finalized', id:'MR-0123'},
      {date:'2024-11-02', patient:'Sofia Kowalski', type:'Blood Work', doctor:'Dr. Gomez', country:'Poland', status:'Finalized', id:'BW-4567'}
    ];
    const patientBilling = [
        {date:'2024-12-26', description:'Subscription • Sozo Premium', amount:2.00, status:'Paid', method:'Visa •••• 4242', cardType:'Credit', invoice:'INV-1201', dueDate:'2025-01-26'},
        {date:'2024-12-18', description:'Consultation Copay', amount:30.00, status:'Paid', method:'Visa •••• 4242', cardType:'Credit', invoice:'INV-1198', dueDate:'2024-12-18'},
        {date:'2024-12-05', description:'Lab Work • QEEG Panel', amount:85.00, status:'Pending', method:'Aetna PPO', cardType:'Insurance', invoice:'INV-1191', dueDate:'2025-01-05'},
        {date:'2024-11-26', description:'Subscription • Sozo Premium', amount:2.00, status:'Paid', method:'Visa •••• 4242', cardType:'Credit', invoice:'INV-1180', dueDate:'2024-12-26'},
        {date:'2024-11-02', description:'Device • Sozo Ring', amount:299.00, status:'Failed', method:'Visa •••• 4242', cardType:'Debit', invoice:'INV-1170', dueDate:'2024-11-12'}
      ];
    const patientAppointments = Array.from({length:20}, (_,i) => {
      const dates = [
        '2024-12-24T10:00','2024-12-20T14:30','2024-12-15T09:00','2024-12-10T11:30',
        '2024-12-05T16:00','2024-11-30T13:00','2024-11-25T15:30','2024-11-18T10:30',
        '2024-11-12T12:00','2024-11-05T09:30','2024-10-28T10:00','2024-10-20T11:00',
        '2024-10-12T14:00','2024-10-05T15:00','2024-09-28T10:30','2024-09-20T13:30',
        '2024-09-12T09:00','2024-09-05T16:30','2024-08-28T11:30','2024-08-20T10:00'
      ];
      const doctors = [
        'Dr. Sarah Smith - Neurologist','Dr. James Wilson - Neurologist','Dr. Patel - Radiology',
        'Dr. Lee - Psychiatry','Dr. Gomez - Internal Medicine'
      ];
      const types = ['Follow-up','Initial Consult','Review'];
      const statuses = ['Completed','Cancelled','No Show'];
      const locations = ['Sozo London (UK)','Sozo Sydney (AU)','Sozo New York (USA)'];
      const patientNames = ['John Doe', 'Jane Smith', 'Robert Johnson', 'Emily Davis', 'Michael Brown'];
      const healthProfs = ['Dr. Anderson', 'Dr. Martinez', 'Dr. Thompson', 'Dr. Garcia', 'Dr. Rodriguez'];
      const rooms = ['Room 101', 'Room 102', 'Room 103', 'Room 201', 'Room 202'];
      const phones = ['555-0101', '555-0102', '555-0103', '555-0104', '555-0105'];
      const mobiles = ['555-1001', '555-1002', '555-1003', '555-1004', '555-1005'];
      const identityNumbers = ['ID-2001', 'ID-2002', 'ID-2003', 'ID-2004', 'ID-2005'];
      const birthDates = ['1985-03-15', '1990-07-22', '1978-11-30', '1995-05-18', '1982-09-10'];
      const examinations = ['MRI Scan', 'CT Scan', 'Blood Test', 'X-Ray', 'ECG'];
      const physicians = ['Dr. Williams', 'Dr. Taylor', 'Dr. Moore', 'Dr. Jackson', 'Dr. White'];
      const recommendedBy = ['Dr. Adams', 'Dr. Clark', 'Dr. Lewis', 'Dr. Walker', 'Dr. Hall'];
      const confirmStatus = ['Yes', 'No', 'Pending'];
      const pendingActions = ['Review Results', 'Follow-up Required', 'Payment Pending', 'None', 'Reschedule'];
      const createdDates = [
        '2024-12-20T08:00','2024-12-15T09:00','2024-12-10T10:00','2024-12-05T11:00',
        '2024-12-01T08:30','2024-11-25T09:30','2024-11-20T10:30','2024-11-15T11:30',
        '2024-11-10T12:00','2024-11-01T08:00','2024-10-25T09:00','2024-10-15T10:00',
        '2024-10-10T11:00','2024-10-01T12:00','2024-09-25T08:30','2024-09-15T09:30',
        '2024-09-10T10:30','2024-09-01T11:30','2024-08-25T12:30','2024-08-15T08:00'
      ];
      const dt = new Date(dates[i]);
      const createdDt = new Date(createdDates[i]);
      return {
        date: dt,
        doctor: doctors[i%doctors.length],
        location: locations[i%locations.length],
        type: types[i%types.length],
        status: statuses[i%statuses.length],
        patientName: patientNames[i%patientNames.length],
        healthProf: healthProfs[i%healthProfs.length],
        room: rooms[i%rooms.length],
        phone: phones[i%phones.length],
        mobile: mobiles[i%mobiles.length],
        identityNumber: identityNumbers[i%identityNumbers.length],
        birthDate: birthDates[i%birthDates.length],
        examination: examinations[i%examinations.length],
        physician: physicians[i%physicians.length],
        recommendedBy: recommendedBy[i%recommendedBy.length],
        confirmed: confirmStatus[i%confirmStatus.length],
        pendingAction: pendingActions[i%pendingActions.length],
        createdDate: createdDt
      };
    });

    function generateSozoId(n) {
      return `PAT-${String(n).padStart(3,'0')}`;
    }

    // Storage helpers
    const USERS_KEY = 'sozoBrainUsers';
    const FNON_KEY_PREFIX = 'sozoFnonState:'; // per-user key
    function getAllUsers() {
      try { return JSON.parse(localStorage.getItem(USERS_KEY) || '{}'); } catch { return {}; }
    }
    function saveRegisteredUsers(u) { localStorage.setItem(USERS_KEY, JSON.stringify(u)); }
    function registerNewUser(firstName, lastName, email, password, country, role, mobile) {
      const all = getAllUsers();
      if(all[email]) { alert('Email already registered'); return false; }
      all[email] = {
        id: `${role?.toUpperCase()||'USR'}-${Math.floor(100+Math.random()*900)}`,
        name: `${firstName} ${lastName}`.trim(), role: role||'patient', email, password,
        avatar : 'https://i.pravatar.cc/100?u='+encodeURIComponent(email), country, mobile
      };
      saveRegisteredUsers(all);
      return true;
    }
    function loadFnonState() {
      if(!currentUser?.email) return;
      try { const data = JSON.parse(localStorage.getItem(FNON_KEY_PREFIX + currentUser.email) || '{}'); if(Object.keys(data).length) fnonState = data; } catch {}
    }
    function saveFnonState() {
      if(!currentUser?.email) return;
      localStorage.setItem(FNON_KEY_PREFIX + currentUser.email, JSON.stringify(fnonState));
      // Save to globalState for cross-screen data persistence
      globalState.sessionData.doctor = {
        name: globalState.currentDoctor.name,
        email: globalState.currentDoctor.email
      };
      if (globalState.currentPatient) {
        globalState.sessionData.patient = {
          name: globalState.currentPatient.name,
          email: globalState.currentPatient.email || `${globalState.currentPatient.name.toLowerCase().replace(' ', '.')}@example.com`
        };
      }
    }
    function getActivePatient() {
      if(currentRole === 'patient' && currentUser) return { id: currentUser.id || 'PAT-001', name: currentUser.name || 'Alex Johnson', email: currentUser.email, country: currentUser.country || 'Germany', avatar: currentUser.avatar };
      if(globalSelectedPatientId) return sampleData.patients.find(p => p.id === globalSelectedPatientId) || sampleData.patients[0];
      return sampleData.patients[0];
    }

    // Final Report Data Management
    function saveFinalReportData(patientId) {
      if (!patientId) return;
      
      const data = {
        conclusion: document.getElementById('finalReportConclusion')?.value || '',
        recommendation: document.getElementById('finalReportRecommendation')?.value || '',
        neuromodulation: document.getElementById('finalReportNeuromodulation')?.value || '',
        primaryGoals: document.getElementById('finalReportPrimaryGoals')?.value || '',
        additionalGoals: document.getElementById('finalReportAdditionalGoals')?.value || '',
        schedule: document.getElementById('finalReportSchedule')?.value || '',
        followUp: document.getElementById('finalReportFollowUp')?.value || '',
        doctorSignature: document.getElementById('finalReportDoctorSignature')?.value || '',
        doctorDate: document.getElementById('finalReportDoctorDate')?.value || ''
      };
      
      // Save custom sections
      const customSections = globalState.customFinalReportSections[patientId] || [];
      customSections.forEach(section => {
        const el = document.getElementById('customSection_' + section.id);
        if (el) section.content = el.value;
      });
      
      globalState.finalReportData[patientId] = data;
      return data;
    }

    function loadFinalReportData(patientId) {
      if (!patientId || !globalState.finalReportData[patientId]) return null;
      return globalState.finalReportData[patientId];
    }

    function populateFinalReportFields(patientId) {
      const data = loadFinalReportData(patientId);
      if (!data) return;
      
      setTimeout(() => {
        if (document.getElementById('finalReportConclusion')) document.getElementById('finalReportConclusion').value = data.conclusion || '';
        if (document.getElementById('finalReportRecommendation')) document.getElementById('finalReportRecommendation').value = data.recommendation || '';
        if (document.getElementById('finalReportNeuromodulation')) document.getElementById('finalReportNeuromodulation').value = data.neuromodulation || '';
        if (document.getElementById('finalReportPrimaryGoals')) document.getElementById('finalReportPrimaryGoals').value = data.primaryGoals || '';
        if (document.getElementById('finalReportAdditionalGoals')) document.getElementById('finalReportAdditionalGoals').value = data.additionalGoals || '';
        if (document.getElementById('finalReportSchedule')) document.getElementById('finalReportSchedule').value = data.schedule || '';
        if (document.getElementById('finalReportFollowUp')) document.getElementById('finalReportFollowUp').value = data.followUp || '';
        if (document.getElementById('finalReportDoctorSignature')) document.getElementById('finalReportDoctorSignature').value = data.doctorSignature || '';
        if (document.getElementById('finalReportDoctorDate')) document.getElementById('finalReportDoctorDate').value = data.doctorDate || '';
        
        // Populate custom sections
        const customSections = globalState.customFinalReportSections[patientId] || [];
        customSections.forEach(section => {
          const el = document.getElementById('customSection_' + section.id);
          if (el) el.value = section.content || '';
        });
      }, 100);
    }

    function renderCustomSections(patientId) {
      const container = document.getElementById('customSectionsContainer');
      if (!container) return;
      
      const sections = globalState.customFinalReportSections[patientId] || [];
      
      if (sections.length === 0) {
        container.innerHTML = '';
        return;
      }
      
      container.innerHTML = '<div class="space-y-4">' + sections.map(section => 
        '<div class="bg-slate-50 p-4 rounded-lg border border-slate-200 relative">' +
        (currentRole === 'admin' ? '<button onclick="removeCustomSection(\'' + patientId + '\', \'' + section.id + '\')" class="absolute top-2 right-2 text-slate-600 hover:text-slate-700" title="Remove section"><i class="fa-solid fa-trash"></i></button>' : '') +
        '<h4 class="text-sm font-bold text-slate-800 mb-2">' + section.title + '</h4>' +
        '<textarea id="customSection_' + section.id + '" class="input-royal w-full border border-slate-300 rounded px-3 py-2" rows="3" placeholder="Enter content..." ' + (currentRole !== 'admin' ? 'readonly' : '') + '>' + (section.content || '') + '</textarea>' +
        '</div>'
      ).join('') + '</div>';
    }

    window.removeCustomSection = function(patientId, sectionId) {
      if (!confirm('Remove this section?')) return;
      const sections = globalState.customFinalReportSections[patientId] || [];
      const index = sections.findIndex(s => s.id === sectionId);
      if (index !== -1) {
        sections.splice(index, 1);
        renderCustomSections(patientId);
      }
    };


// ==========================================
// 2. ROUTING & NAVIGATION
// ==========================================

// Visit Selection Functions
window.selectVisit = function(visit) {
  selectedVisit = visit;
  
  // Save selected visit to localStorage
  saveToLocalStorage('sozo_selected_visit', visit);
  
  console.log('✓ Visit selected:', visit);
  
  // Hide visit selection page, show main app
  document.getElementById('visitSelectionPage').style.display = 'none';
  document.getElementById('mainApp').style.display = 'block';
  
  // Setup UI
  const sidebarName = document.getElementById('sidebarName');
  const sidebarRole = document.getElementById('sidebarRole');
  const sidebarAvatar = document.getElementById('sidebarAvatar');
  
  if(sidebarName) sidebarName.innerText = currentUser.name;
  if(sidebarRole) sidebarRole.innerText = currentRole.toUpperCase();
  if(sidebarAvatar) {
    sidebarAvatar.innerHTML = '<i class="fa-solid fa-user text-white text-2xl"></i>';
  }
  
  // Render sidebar with visit-specific menu and load home
  renderSidebar();
  loadSection('home');
};

window.handleLogoutFromVisitSelection = function() {
  if(confirm('Are you sure you want to logout?')) {
    logoutUser();
    selectedVisit = null;
    document.getElementById('visitSelectionPage').style.display = 'none';
    document.getElementById('loginPage').style.display = 'flex';
    document.getElementById('loginForm').reset();
  }
};

// Get patient menu based on selected visit
function getPatientMenuForVisit(visit) {
  const baseMenu = [
    {key:'home', label:'Home', icon:'fa-home'},
    {key:'treatment-plan', label:'Treatment Plan', icon:'fa-file-medical'},
    {key:'appointments', label:'Appointments', icon:'fa-calendar-check'}
  ];

  // Full menu for follow-up visits
  const fullMenu = [
    {key:'home', label:'Home', icon:'fa-home'},
    {key:'dashboard', label:'Dashboard', icon:'fa-heart-pulse'},
    {
      key:'wellness', label:'Medical Assessment', icon:'fa-spa',
      children: [
        {key:'fnon', label:'FNON Assessment'},
        {key:'prs', label:'PRS Assessment'},
        {key:'finalreport', label:'Final Report'}
      ]
    },
    {key:'treatment-plan', label:'Treatment Plan', icon:'fa-file-medical'},
    {key:'appointments', label:'Appointments', icon:'fa-calendar-check'},
    {key:'eshop', label:'E-Shop', icon:'fa-cart-shopping'},
    {key:'customer-support', label:'Customer Support', icon:'fa-headset', children: [
      {key:'mypatients', label:'My Referrals'},
      {key:'messages', label:'Messages'},
      {key:'telemedicine', label:'Telemedicine'}
    ]},
    {key:'profile', label:'My Profile', icon:'fa-user-circle', children: [
      {key:'profileoverview', label:'Profile Overview'},
      {key:'devices', label:'My Devices'}
    ]},
    {key:'financial-services', label:'Financial Services', icon:'fa-building-columns', children: [
      {key:'billing', label:'Billing'},
      {key:'insurance', label:'Insurance'}
    ]},
    {key:'reports', label:'History', icon:'fa-file-medical'}
  ];

  switch(visit) {
    case 'first-visit':
      return [
        {key:'treatment-plan', label:'Treatment Plan', icon:'fa-file-medical'}
      ];
    case 'followup-1':
      return [
        ...baseMenu,
        {key:'dashboard', label:'Dashboard', icon:'fa-heart-pulse'},
        {key:'profile', label:'My Profile', icon:'fa-user-circle'}
      ];
    case 'followup-2':
      return [
        ...baseMenu,
        {key:'dashboard', label:'Dashboard', icon:'fa-heart-pulse'},
        {
          key:'wellness', label:'Medical Assessment', icon:'fa-spa',
          children: [
            {key:'fnon', label:'FNON Assessment'},
            {key:'prs', label:'PRS Assessment'}
          ]
        },
        {key:'profile', label:'My Profile', icon:'fa-user-circle'},
        {key:'eshop', label:'E-Shop', icon:'fa-cart-shopping'}
      ];
    case 'followup-3':
      return fullMenu;
    default:
      return baseMenu;
  }
}

// Sub-tab switching and Parameters rendering
function switchTreatmentSubTab(subTab) {
  if (!['devices','parameters'].includes(subTab)) return;
  treatmentPlanState.activeTreatmentSubTab = subTab;
  // Re-render the treatment plan area to reflect the sub-tab change
  renderTreatmentPlan();
}

function renderParametersContent(device, deviceIndex) {
  if (!device) return '<p class="text-slate-500">No device selected</p>';

  // Ensure parameters object exists
  if (!device.parameters) device.parameters = { duration: '', intensity: '', ramp: '', daysPerWeek: '', selectedDays: '', timeOfDay: '' };

  const params = device.parameters;

  return `
    <div class="bg-white p-4 rounded-lg border border-slate-200">
      <h5 class="text-sm font-bold text-slate-900 mb-3">Device Parameters - Device ${deviceIndex + 1}: ${device.name}</h5>

      <!-- Top row: Duration / Intensity / Ramp -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
        <div>
          <label class="text-xs font-semibold text-slate-700">Duration</label>
          <select onchange="updateDeviceParameter(${deviceIndex}, 'duration', this.value)" class="input-royal w-full">
            <option value="">Duration</option>
            <option value="10" ${params.duration === '10' ? 'selected' : ''}>10 min</option>
            <option value="15" ${params.duration === '15' ? 'selected' : ''}>15 min</option>
            <option value="20" ${params.duration === '20' ? 'selected' : ''}>20 min</option>
            <option value="30" ${params.duration === '30' ? 'selected' : ''}>30 min</option>
          </select>
        </div>
        <div>
          <label class="text-xs font-semibold text-slate-700">Intensity</label>
          <select onchange="updateDeviceParameter(${deviceIndex}, 'intensity', this.value)" class="input-royal w-full">
            <option value="">Intensity</option>
            <option value="low" ${params.intensity === 'low' ? 'selected' : ''}>Low</option>
            <option value="medium" ${params.intensity === 'medium' ? 'selected' : ''}>Medium</option>
            <option value="high" ${params.intensity === 'high' ? 'selected' : ''}>High</option>
          </select>
        </div>
        <div>
          <label class="text-xs font-semibold text-slate-700">Ramp</label>
          <select onchange="updateDeviceParameter(${deviceIndex}, 'ramp', this.value)" class="input-royal w-full">
            <option value="">Ramp</option>
            <option value="slow" ${params.ramp === 'slow' ? 'selected' : ''}>Slow</option>
            <option value="medium" ${params.ramp === 'medium' ? 'selected' : ''}>Medium</option>
            <option value="fast" ${params.ramp === 'fast' ? 'selected' : ''}>Fast</option>
          </select>
        </div>
      </div>

      <!-- Bottom row: Number of days/week / Select days / Time of day -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div>
          <label class="text-xs font-semibold text-slate-700">Number of days/week</label>
          <select onchange="updateDeviceParameter(${deviceIndex}, 'daysPerWeek', this.value)" class="input-royal w-full">
            <option value="">Number of days/week</option>
            <option value="1" ${params.daysPerWeek === '1' ? 'selected' : ''}>1</option>
            <option value="2" ${params.daysPerWeek === '2' ? 'selected' : ''}>2</option>
            <option value="3" ${params.daysPerWeek === '3' ? 'selected' : ''}>3</option>
            <option value="4" ${params.daysPerWeek === '4' ? 'selected' : ''}>4</option>
            <option value="5" ${params.daysPerWeek === '5' ? 'selected' : ''}>5</option>
            <option value="6" ${params.daysPerWeek === '6' ? 'selected' : ''}>6</option>
            <option value="7" ${params.daysPerWeek === '7' ? 'selected' : ''}>7</option>
          </select>
        </div>
        <div>
          <label class="text-xs font-semibold text-slate-700">Select days</label>
          <select multiple onchange="updateDeviceParameter(${deviceIndex}, 'selectedDays', Array.from(this.selectedOptions).map(o=>o.value).join(', '))" class="input-royal w-full h-28">
            <option value="Mon" ${params.selectedDays?.includes('Mon') ? 'selected' : ''}>Mon</option>
            <option value="Tue" ${params.selectedDays?.includes('Tue') ? 'selected' : ''}>Tue</option>
            <option value="Wed" ${params.selectedDays?.includes('Wed') ? 'selected' : ''}>Wed</option>
            <option value="Thu" ${params.selectedDays?.includes('Thu') ? 'selected' : ''}>Thu</option>
            <option value="Fri" ${params.selectedDays?.includes('Fri') ? 'selected' : ''}>Fri</option>
            <option value="Sat" ${params.selectedDays?.includes('Sat') ? 'selected' : ''}>Sat</option>
            <option value="Sun" ${params.selectedDays?.includes('Sun') ? 'selected' : ''}>Sun</option>
          </select>
        </div>
        <div>
          <label class="text-xs font-semibold text-slate-700">Time of day</label>
          <select onchange="updateDeviceParameter(${deviceIndex}, 'timeOfDay', this.value)" class="input-royal w-full">
            <option value="">time of day</option>
            <option value="morning" ${params.timeOfDay === 'morning' ? 'selected' : ''}>Morning</option>
            <option value="midday" ${params.timeOfDay === 'midday' ? 'selected' : ''}>Midday</option>
            <option value="afternoon" ${params.timeOfDay === 'afternoon' ? 'selected' : ''}>Afternoon</option>
            <option value="evening" ${params.timeOfDay === 'evening' ? 'selected' : ''}>Evening</option>
            <option value="night" ${params.timeOfDay === 'night' ? 'selected' : ''}>Night</option>
          </select>
        </div>
      </div>
    </div>
  `;
}

function updateDeviceParameter(deviceIndex, key, value) {
  if (!treatmentPlanState.devices || !treatmentPlanState.devices[deviceIndex]) return;
  if (!treatmentPlanState.devices[deviceIndex].parameters) treatmentPlanState.devices[deviceIndex].parameters = {};
  treatmentPlanState.devices[deviceIndex].parameters[key] = value;
  saveTreatmentPlanState();
  // Update the deviceTabContent only to reflect changes
  const contentEl = document.getElementById('deviceTabContent');
  if (contentEl) {
    contentEl.innerHTML = treatmentPlanState.activeTreatmentSubTab === 'parameters' ? renderParametersContent(treatmentPlanState.devices[treatmentPlanState.activeDeviceTab], treatmentPlanState.activeDeviceTab) : renderDeviceJourney(treatmentPlanState.devices[treatmentPlanState.activeDeviceTab], treatmentPlanState.activeDeviceTab);
  }
}

// Expose to global scope for inline handlers
window.switchTreatmentSubTab = switchTreatmentSubTab;
window.updateDeviceParameter = updateDeviceParameter;

function switchTreatmentMainTab(tab) {
  if (!['devices','parameters','details'].includes(tab)) return;
  treatmentPlanState.activeTreatmentMainTab = tab;
  // Re-render the whole treatment plan view to load the selected main tab
  renderTreatmentPlan();
}

function renderTreatmentPlanParameters() {
  // Render a full-viewport Parameters tab for the treatment plan showing per-device parameters
  return `
    <div class="card p-8">
      <h3 class="text-xl font-bold text-slate-900 mb-4">Treatment Plan Parameters</h3>
      <p class="text-sm text-slate-600 mb-4">Configure and review parameters for all devices in a single view.</p>
      <div class="space-y-4">
        ${treatmentPlanState.devices.length === 0 ? '<p class="text-slate-500 italic">No devices added yet</p>' : treatmentPlanState.devices.map((device, idx) => `
          <div class="bg-white p-4 rounded-lg border border-slate-200">
            <h5 class="font-semibold text-slate-800 mb-2">Device ${idx + 1}: ${device.name}</h5>
            ${renderParametersContent(device, idx)}
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

window.switchTreatmentMainTab = switchTreatmentMainTab;
window.renderTreatmentPlanParameters = renderTreatmentPlanParameters;

const MENU = {
  patient: [
    {key:'home', label:'Home', icon:'fa-home'},
    {key:'dashboard', label:'Dashboard', icon:'fa-heart-pulse'},
    {key:'patient-journey', label:'Patient Journey', icon:'fa-route'},
    {
      key:'wellness', label:'Medical Assessment', icon:'fa-spa',
      children: [
        {key:'fnon', label:'FNON Assessment'},
        {key:'prs', label:'PRS Assessment'},
        {key:'finalreport', label:'Final Report'}
      ]
    },
    {key:'treatment-plan', label:'Treatment Plan', icon:'fa-file-medical'},
    {key:'appointments', label:'Appointments', icon:'fa-calendar-check'},
    {key:'eshop', label:'E-Shop', icon:'fa-cart-shopping'},
    {key:'customer-support', label:'Customer Support', icon:'fa-headset', children: [
      {key:'mypatients', label:'My Referrals'},
      {key:'messages', label:'Messages'},
      {key:'telemedicine', label:'Telemedicine'}
    ]},
    {key:'profile', label:'My Profile', icon:'fa-user-circle', children: [
      {key:'profileoverview', label:'Profile Overview'},
      {key:'devices', label:'My Devices'}
    ]},
    {key:'financial-services', label:'Financial Services', icon:'fa-building-columns', children: [
      {key:'billing', label:'Billing & Payments'},
      {key:'insurance', label:'Insurance'}
    ]},
    {key:'reports', label:'History', icon:'fa-file-medical'}
  ],
  doctor: [
    {key:'home', label:'Home', icon:'fa-home'},
    {key:'dashboard', label:'Dashboard', icon:'fa-chart-line'},
    {key:'patient-journey', label:'Patient Journey', icon:'fa-route'},
    {key:'appointments', label:'Appointments/ Schedules', icon:'fa-calendar-check', children: [
      {key:'schedule', label:'Today\'s Schedule'},
      {key:'allappointments', label:'All Appointments'},
      {key:'createvisit', label:'Create Visit'}
    ]},
    {key:'patientdetails', label:'Patient Details', icon:'fa-user-injured', children: [
      {key:'patients', label:'My Patients'},
      {key:'reports', label:'Patient Reports'}
    ]},
    {key:'eshop', label:'Medical E-Shop', icon:'fa-cart-shopping'},
    {key:'learning', label:'Learning & Dev', icon:'fa-graduation-cap'},
    {key:'profile', label:'Profile & Finance', icon:'fa-user-md'}
  ],
  receptionist: [
    {key:'home', label:'Calendar', icon:'fa-calendar-days'},
    {key:'createappt', label:'Create Appointment', icon:'fa-plus-circle'},
    {key:'manageappts', label:'Manage Appointments', icon:'fa-calendar-check'},
    {key:'patientsearch', label:'Patient Search', icon:'fa-magnifying-glass'},
    {key:'doctorsearch', label:'Doctor Search', icon:'fa-stethoscope'},
    {key:'international-patients', label:'International Patients', icon:'fa-globe'},
    {key:'profile', label:'My Profile', icon:'fa-user-circle'}
  ],
  admin: [
    {key:'dashboard', label:'Enterprise Dashboard', icon:'fa-chart-pie'},
    {key:'patient-journey', label:'Patient Journey', icon:'fa-route'},
    {key:'finance', label:'Finance & Accounts', icon:'fa-sack-dollar'},
    {key:'partnerships', label:'Partnerships', icon:'fa-handshake'},
    {key:'patients', label:'Patients DB', icon:'fa-users'},
    {key:'doctors', label:'Doctors DB', icon:'fa-user-doctor'},
    {key:'international-patients', label:'International Patients', icon:'fa-globe'},
    {key:'medicalassessment', label:'Schedules/ appointments', icon:'fa-stethoscope', children: [
      {key:'schedule', label:'Today\'s Schedule'},
      {key:'appointments', label:'Appointments'},
      {key:'createvisit', label:'Create Visit'}
    ]},
    {key:'devices', label:'Device Inventory', icon:'fa-boxes-stacked'},
    {key:'workshops', label:'Workshops', icon:'fa-chalkboard-user'},
    {key:'workshops', label:'Workshops', icon:'fa-chalkboard-user'},
    {key:'settings', label:'System Settings', icon:'fa-gear'},
    {key:'wellness', label:'Medical Assessment', icon:'fa-spa', children: [
      {key:'fnon', label:'FNON Assessment'},
      {key:'brainmap', label:'Brain Mapping'},
      {key:'prs', label:'PRS Assessment'},
      {key:'finalreport', label:'Final Report'}
    ]}
  ]
};

function renderSidebar() {
  try {
    const nav = document.getElementById('sidebarNav');
    nav.innerHTML = '';
    
    // For patient role, use visit-specific menu
    let menuItems;
    if (currentRole === 'patient' && selectedVisit) {
      menuItems = getPatientMenuForVisit(selectedVisit);
      console.log('✓ Rendering sidebar for visit:', selectedVisit, 'with', menuItems.length, 'items');
    } else {
      menuItems = MENU[currentRole];
    }
    
    if(!menuItems) {
      console.error('Menu items not found for role:', currentRole);
      return;
    }
    menuItems.forEach(item => {
      const div = document.createElement('div');
      div.className = 'nav-item';
      div.dataset.key = item.key;
      div.innerHTML = `<i class="fa-solid ${item.icon} w-6 text-center"></i><span class="flex-1">${item.label}</span>${item.children ? '<i class="fa-solid fa-chevron-down text-xs"></i>' : ''}`;
      if(item.children) {
        const sub = document.createElement('div');
        sub.className = 'nav-sublist hidden';
        item.children.forEach(child => {
          const c = document.createElement('div');
          c.className = 'nav-sub';
          c.dataset.key = child.key;
          c.innerHTML = `<span class="w-2 h-2 rounded-full bg-slate-300"></span><span>${child.label}</span>`;
          c.onclick = (e) => { e.stopPropagation(); loadSection(child.key); };
          sub.appendChild(c);
        });
        div.onclick = () => {
          sub.classList.toggle('hidden');
        };
        nav.appendChild(div);
        nav.appendChild(sub);
      } else {
        div.onclick = () => loadSection(item.key);
        nav.appendChild(div);
      }
    });
    setTimeout(() => {
      if(nav.firstChild) nav.firstChild.click();
    }, 100);

    updateProgressBadges();
  } catch(err) {
    console.error('Error in renderSidebar:', err);
  }
}

function setSelectedDoctor(doctor) {
  selectedDoctor = {
    id: doctor.id || selectedDoctor.id || '',
    name: doctor.name || selectedDoctor.name || '',
    email: doctor.email || selectedDoctor.email || ''
  };
}

function getDoctorDisplay() {
  if(!selectedDoctor.name && !selectedDoctor.id) return 'No doctor assigned';
  const parts = [selectedDoctor.name || selectedDoctor.id];
  if(selectedDoctor.id && selectedDoctor.name) parts.push(`(${selectedDoctor.id})`);
  if(selectedDoctor.email) parts.push(`• ${selectedDoctor.email}`);
  return parts.join(' ');
}

function updateLoginSummary() {
  // Update login page displays
  const doctorEl = document.getElementById('loginDoctorDisplay');
  const statusEl = document.getElementById('loginStatusBadge');
  
  if(doctorEl) doctorEl.textContent = getDoctorDisplay();
  
  if(statusEl) {
    const status = assessmentProgress.fnon;
    const statusMap = {
      'not-started': 'badge-danger',
      'in-progress': 'badge-info',
      'completed': 'badge-success'
    };
    statusEl.className = `badge ${statusMap[status] || 'badge-danger'}`;
    statusEl.textContent = status;
  }
}

function setProgress(section, status) {
  if(!assessmentProgress[section]) return;
  assessmentProgress[section] = status;
  updateProgressBadges();
}

function updateProgressBadges() {
  const colors = {
    'not-started': '#fecdd3', // light red
    'in-progress': '#bfdbfe', // light blue
    'completed': '#bbf7d0' // light green
  };

  document.querySelectorAll('.nav-sub').forEach(el => {
    const key = el.dataset.key;
    const status = assessmentProgress[key];
    const dot = el.querySelector('.rounded-full');
    if(dot && status) {
      dot.style.backgroundColor = colors[status];
      dot.title = `Status: ${status}`;
    }
  });

  // Also color main doctor menu items for assessment pages
  document.querySelectorAll('.nav-item').forEach(el => {
    const key = el.dataset.key;
    if(['fnon','brainmap','prs','doctornotes','finalreport'].includes(key)) {
      const status = assessmentProgress[key==='brainmap'?'brain':key];
      if(status) {
        const bg = status==='completed' ? '#bbf7d0' : status==='in-progress' ? '#bfdbfe' : '#fecdd3';
        el.style.backgroundImage = `linear-gradient(to right, ${bg}, transparent)`;
      }
    }
  });
}

// Helper function to generate calendar time slots with appointments
function generateTimeSlots(appointments) {
  const timeSlots = [
    '08:00 AM', '08:30 AM', '09:00 AM', '09:30 AM', '10:00 AM', '10:30 AM',
    '11:00 AM', '11:30 AM', '12:00 PM', '12:30 PM', '01:00 PM', '01:30 PM',
    '02:00 PM', '02:30 PM', '03:00 PM', '03:30 PM', '04:00 PM', '04:30 PM',
    '05:00 PM', '05:30 PM', '06:00 PM'
  ];
  
  // Filter today's appointments
  const today = new Date().toLocaleDateString();
  const todayAppts = appointments.filter(a => {
    const aptDate = new Date(a.date).toLocaleDateString();
    return aptDate === today || !a.date; // Include appointments without dates for demo
  });
  
  let html = '';
  
  timeSlots.forEach((timeSlot, index) => {
    // Find appointments for this time slot
    const slotAppts = todayAppts.filter(apt => apt.time === timeSlot);
    
    html += `
      <div class="flex gap-4 hover:bg-slate-50 rounded-lg transition" style="min-height: 80px;">
        <!-- Time Column -->
        <div class="w-24 flex-shrink-0 pt-2">
          <span class="text-sm font-semibold text-slate-600">${timeSlot}</span>
        </div>
        
        <!-- Appointments Column -->
        <div class="flex-1 border-l-2 border-slate-200 pl-4 pb-4">
          ${slotAppts.length > 0 ? slotAppts.map((apt, idx) => {
            // Determine status styling
            let statusColor = 'sozo';
            let statusBg = 'bg-orange-50';
            let statusBorder = 'border-orange-300';
            let statusText = 'text-sozo-600';
            let statusIcon = 'fa-clock';
            
            if (apt.status === 'Completed') {
              statusColor = 'orange';
              statusBg = 'bg-orange-50';
              statusBorder = 'border-orange-300';
              statusText = 'text-sozo-700';
              statusIcon = 'fa-circle-check';
            } else if (apt.status === 'Cancelled') {
              statusColor = 'slate';
              statusBg = 'bg-slate-50';
              statusBorder = 'border-slate-300';
              statusText = 'text-slate-700';
              statusIcon = 'fa-circle-xmark';
            } else if (apt.status === 'Rescheduled') {
              statusColor = 'blue';
              statusBg = 'bg-blue-50';
              statusBorder = 'border-blue-300';
              statusText = 'text-brand-blue';
              statusIcon = 'fa-calendar';
            }
            
            // Check if this is the next appointment
            const isUpNext = idx === 0 && index < 10 && apt.status === 'Scheduled';
            if (isUpNext) {
              statusBg = 'bg-gradient-to-r from-sozo-600 to-orange-700';
              statusBorder = 'border-orange-400';
            }
            
            return `
              <div class="${isUpNext ? statusBg + ' text-white' : statusBg + ' border-l-4 ' + statusBorder} rounded-lg p-4 shadow-sm mb-2 hover:shadow-md transition cursor-pointer">
                <!-- Patient Info -->
                <div class="flex items-start justify-between gap-3">
                  <div class="flex items-start gap-3 flex-1">
                    <!-- Avatar -->
                    <div class="w-10 h-10 rounded-full ${isUpNext ? 'bg-white/20' : 'bg-gradient-to-br from-sozo-400 to-orange-500'} flex items-center justify-center ${isUpNext ? 'text-white' : 'text-white'} text-sm font-bold flex-shrink-0">
                      ${apt.patientName.split(' ').map(n => n[0]).join('')}
                    </div>
                    
                    <!-- Details -->
                    <div class="flex-1 min-w-0">
                      <div onclick="startVisit('${apt.patientId}')" class="font-bold ${isUpNext ? 'text-white' : 'text-slate-900'} hover:underline cursor-pointer text-base">
                        ${apt.patientName}
                      </div>
                      <div class="${isUpNext ? 'text-white/90' : 'text-slate-600'} text-sm mt-1">
                        <i class="fa-solid fa-stethoscope mr-1"></i>${apt.type}
                      </div>
                      <div class="${isUpNext ? 'text-white/80' : 'text-slate-500'} text-xs mt-1">
                        <i class="fa-solid fa-door-open mr-1"></i>Room ${apt.room || '101'}
                        ${apt.location ? ` • <i class="fa-solid fa-location-dot ml-2 mr-1"></i>${apt.location}` : ''}
                      </div>
                    </div>
                  </div>
                  
                  <!-- Status Badge and Actions -->
                  <div class="flex flex-col items-end gap-2">
                    ${isUpNext ? `
                      <span class="inline-flex items-center gap-1 bg-white/20 backdrop-blur-sm text-white px-3 py-1 rounded-full text-xs font-bold">
                        <i class="fa-solid fa-bolt"></i> Up Next
                      </span>
                      <button onclick="startVisit('${apt.patientId}')" class="bg-white text-sozo-600 px-4 py-2 rounded-lg text-sm font-bold hover:bg-orange-50 transition">
                        <i class="fa-solid fa-video mr-1"></i>Start Visit
                      </button>
                    ` : apt.status === 'Completed' ? `
                      <span class="inline-flex items-center gap-1 bg-orange-100 ${statusText} px-3 py-1 rounded-full text-xs font-semibold">
                        <i class="fa-solid ${statusIcon}"></i> ${apt.status}
                      </span>
                      <button onclick="startVisit('${apt.patientId}')" class="text-sozo-600 hover:text-sozo-700 text-sm font-semibold">
                        <i class="fa-solid fa-notes-medical mr-1"></i>View Notes
                      </button>
                    ` : apt.status === 'Cancelled' ? `
                      <span class="inline-flex items-center gap-1 bg-slate-100 ${statusText} px-3 py-1 rounded-full text-xs font-semibold">
                        <i class="fa-solid ${statusIcon}"></i> ${apt.status}
                      </span>
                    ` : `
                      <span class="inline-flex items-center gap-1 bg-slate-100 text-slate-700 px-3 py-1 rounded-full text-xs font-semibold">
                        <i class="fa-solid ${statusIcon}"></i> ${apt.status}
                      </span>
                      <button onclick="startVisit('${apt.patientId}')" class="text-sozo-600 hover:text-sozo-700 text-sm font-semibold">
                        <i class="fa-solid fa-eye mr-1"></i>View Details
                      </button>
                    `}
                  </div>
                </div>
              </div>
            `;
          }).join('') : `
            <div class="h-full flex items-center text-slate-400 text-sm italic pt-2">
              No appointments
            </div>
          `}
        </div>
      </div>
    `;
  });
  
  return html;
}

// ==========================================
// TEAMS-LIKE CALENDAR SYSTEM
// ==========================================

// Global calendar state
const calendarState = {
  currentView: 'week', // week view only
  currentDate: new Date(),
  zoomLevel: 100,
  hourHeight: 80, // pixels per hour
  minHourHeight: 40,
  maxHourHeight: 160
};

// Switch calendar view (week view only)
function switchCalendarView(view) {
  calendarState.currentView = 'week';
  renderTeamsCalendar();
}

// Zoom calendar in/out
function zoomCalendar(direction) {
  if (direction === 'in' && calendarState.hourHeight < calendarState.maxHourHeight) {
    calendarState.hourHeight += 20;
    calendarState.zoomLevel += 25;
  } else if (direction === 'out' && calendarState.hourHeight > calendarState.minHourHeight) {
    calendarState.hourHeight -= 20;
    calendarState.zoomLevel -= 25;
  }
  
  document.getElementById('zoomLevel').textContent = calendarState.zoomLevel + '%';
  renderTeamsCalendar();
}

// Get current week date range
function getWeekDateRange() {
  const date = new Date(calendarState.currentDate);
  const day = date.getDay();
  const diff = date.getDate() - day; // Get Sunday
  
  const weekStart = new Date(date.setDate(diff));
  const weekEnd = new Date(date.setDate(diff + 6)); // Get Saturday
  
  const options = { month: 'short', day: 'numeric' };
  const startStr = weekStart.toLocaleDateString('en-US', options);
  const endStr = weekEnd.toLocaleDateString('en-US', options);
  
  return `${startStr} - ${endStr}`;
}

// Update week display in navigation
function updateWeekDisplay() {
  const weekRangeElement = document.getElementById('weekDateRange');
  if (weekRangeElement) {
    weekRangeElement.textContent = calendarState.currentView === 'day' ? getCurrentDateLabel() : getWeekDateRange();
  }
}

function getCurrentDateLabel() {
  const options = { weekday: 'short', month: 'short', day: 'numeric' };
  return calendarState.currentDate.toLocaleDateString('en-US', options);
}

// Navigate calendar (prev/next week)
function navigateCalendar(direction) {
  const date = calendarState.currentDate;
  
  if (direction === 'prev') {
    date.setDate(date.getDate() - 7);
  } else if (direction === 'next') {
    date.setDate(date.getDate() + 7);
  } else if (direction === 'today') {
    calendarState.currentDate = new Date();
  }
  
  renderTeamsCalendar();
  updateWeekDisplay();
}

// Convert time string to minutes since midnight
function timeToMinutes(timeStr) {
  if (!timeStr) return 0;
  const [time, period] = timeStr.split(' ');
  let [hours, minutes] = time.split(':').map(Number);
  
  if (period === 'PM' && hours !== 12) hours += 12;
  if (period === 'AM' && hours === 12) hours = 0;
  
  return hours * 60 + (minutes || 0);
}

// Get appointment color based on status and type
function getAppointmentColor(status, type, location) {
  const colors = {
    'Completed': { bg: '#10b981', border: '#059669', text: '#ffffff' },
    'Scheduled': { bg: '#3b82f6', border: '#2563eb', text: '#ffffff' },
    'Cancelled': { bg: '#ef4444', border: '#dc2626', text: '#ffffff' },
    'Rescheduled': { bg: '#f59e0b', border: '#d97706', text: '#ffffff' },
    'Pending': { bg: '#8b5cf6', border: '#7c3aed', text: '#ffffff' }
  };
  
  // Priority: status color
  return colors[status] || colors['Scheduled'];
}

// Render the Teams-like calendar (week view only)
function renderTeamsCalendar() {
  const container = document.getElementById('calendarTimelineContainer');
  if (!container) return;
  
  const hourHeight = calendarState.hourHeight;
  
  // Get appointments
  const appointments = sampleData.appointments || [];

  const isMobileViewport = window.innerWidth <= 768;
  calendarState.currentView = isMobileViewport ? 'day' : 'week';
  
  if (isMobileViewport) {
    renderDayView(container, appointments, hourHeight);
  } else {
    renderWeekView(container, appointments, hourHeight);
  }
  
  
  // Update week/day display text
  updateWeekDisplay();
}

// Render Day View
function renderDayView(container, appointments, hourHeight) {
  const currentDate = calendarState.currentDate;
  const dateStr = currentDate.toLocaleDateString();
  
  // Filter appointments for current date
  const dayAppointments = appointments.filter(apt => {
    if (!apt.date) return false;
    const aptDate = new Date(apt.date).toLocaleDateString();
    return aptDate === dateStr;
  });
  
  // Generate hours (6 AM to 8 PM)
  const startHour = 6;
  const endHour = 20;
  const hours = [];
  for (let h = startHour; h <= endHour; h++) {
    hours.push(h);
  }
  
  // Get current time for time indicator
  const now = new Date();
  const isToday = now.toLocaleDateString() === dateStr;
  const currentMinutes = now.getHours() * 60 + now.getMinutes();
  const currentTimeTop = ((currentMinutes - startHour * 60) / 60) * hourHeight;
  
  let html = `
    <div style="position: relative; min-height: ${(endHour - startHour + 1) * hourHeight}px;">
      <!-- Time Grid -->
      <div style="position: absolute; left: 0; top: 0; bottom: 0; width: 80px; background: white; border-right: 2px solid #e2e8f0; z-index: 2;">
        ${hours.map((h, idx) => {
          const hour12 = h > 12 ? h - 12 : (h === 0 ? 12 : h);
          const period = h >= 12 ? 'PM' : 'AM';
          return `
            <div style="height: ${hourHeight}px; border-bottom: 1px solid #e2e8f0; padding: 8px 12px; font-size: 12px; font-weight: 600; color: #64748b;">
              ${hour12}:00 ${period}
            </div>
          `;
        }).join('')}
      </div>
      
      <!-- Hour Grid Lines -->
      <div style="position: absolute; left: 80px; right: 0; top: 0; bottom: 0;">
        ${hours.map((h, idx) => `
          <div style="height: ${hourHeight}px; border-bottom: 1px solid #e2e8f0; background: ${idx % 2 === 0 ? '#ffffff' : '#fafafa'};"></div>
        `).join('')}
      </div>
      
      <!-- Current Time Indicator (Red Line) -->
      ${isToday && currentTimeTop >= 0 ? `
        <div style="position: absolute; left: 0; right: 0; top: ${currentTimeTop}px; z-index: 5; pointer-events: none;">
          <div style="height: 2px; background: #ef4444; box-shadow: 0 0 4px rgba(239, 68, 68, 0.5);"></div>
          <div style="position: absolute; left: 10px; top: -8px; width: 16px; height: 16px; background: #ef4444; border-radius: 50%; border: 2px solid white;"></div>
        </div>
      ` : ''}
      
      <!-- Appointments -->
      <div style="position: absolute; left: 80px; right: 0; top: 0; bottom: 0; padding: 0 12px;">
        ${dayAppointments.map((apt, idx) => {
          const startMinutes = timeToMinutes(apt.time);
          const top = ((startMinutes - startHour * 60) / 60) * hourHeight;
          const duration = apt.duration || 30; // default 30 minutes
          const height = (duration / 60) * hourHeight - 4;
          const color = getAppointmentColor(apt.status, apt.type, apt.location);
          
          // Check for overlapping appointments
          const overlapping = dayAppointments.filter(a => {
            const aStart = timeToMinutes(a.time);
            const aEnd = aStart + (a.duration || 30);
            const bStart = startMinutes;
            const bEnd = bStart + duration;
            return a !== apt && ((aStart < bEnd && aEnd > bStart));
          });
          
          const overlapIndex = overlapping.findIndex(a => dayAppointments.indexOf(a) < idx);
          const totalOverlaps = overlapping.length + 1;
          const width = `calc(${100 / totalOverlaps}% - 8px)`;
          const left = `${(overlapIndex + 1) * (100 / totalOverlaps)}%`;
          
          return `
            <div 
              onclick="showAppointmentDetails('${apt.id}')"
              style="
                position: absolute;
                top: ${top}px;
                left: ${overlapping.length > 0 ? left : '0'};
                width: ${overlapping.length > 0 ? width : 'calc(100% - 8px)'};
                height: ${height}px;
                min-height: 60px;
                background: ${color.bg};
                border-left: 4px solid ${color.border};
                border-radius: 6px;
                padding: 8px 10px;
                cursor: pointer;
                overflow: hidden;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                transition: all 0.2s;
                z-index: 3;
              "
              onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)'; this.style.transform='scale(1.02)'; this.style.zIndex='4';"
              onmouseout="this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'; this.style.transform='scale(1)'; this.style.zIndex='3';"
              title="${apt.patientName} - ${apt.type}"
            >
              <div style="color: ${color.text}; font-weight: 700; font-size: 13px; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                ${apt.patientName}
              </div>
              <div style="color: ${color.text}; opacity: 0.95; font-size: 11px; margin-bottom: 2px; display: flex; align-items: center; gap: 4px;">
                <i class="fa-solid fa-stethoscope"></i>
                <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${apt.type}</span>
              </div>
              <div style="color: ${color.text}; opacity: 0.9; font-size: 11px; display: flex; align-items: center; gap: 4px;">
                <i class="fa-solid fa-location-dot"></i>
                <span>${apt.location || 'Room ' + (apt.room || '101')}</span>
              </div>
              ${height > 80 ? `
                <div style="color: ${color.text}; opacity: 0.85; font-size: 10px; margin-top: 4px; padding-top: 4px; border-top: 1px solid rgba(255,255,255,0.3);">
                  <i class="fa-solid fa-clock"></i> ${apt.time} • ${duration} min
                </div>
              ` : ''}
            </div>
          `;
        }).join('')}
      </div>
    </div>
  `;
  
  container.innerHTML = html;
  
  // Auto-scroll to current time
  if (isToday && currentTimeTop > 0) {
    setTimeout(() => {
      container.scrollTop = Math.max(0, currentTimeTop - 200);
    }, 100);
  }
}

// Render Week View
function renderWeekView(container, appointments, hourHeight) {
  const currentDate = new Date(calendarState.currentDate);
  
  // Get start of week (Sunday)
  const dayOfWeek = currentDate.getDay();
  const startOfWeek = new Date(currentDate);
  startOfWeek.setDate(currentDate.getDate() - dayOfWeek);
  
  // Generate week days
  const weekDays = [];
  for (let i = 0; i < 7; i++) {
    const day = new Date(startOfWeek);
    day.setDate(startOfWeek.getDate() + i);
    weekDays.push(day);
  }
  
  // Generate hours (6 AM to 8 PM)
  const startHour = 6;
  const endHour = 20;
  const hours = [];
  for (let h = startHour; h <= endHour; h++) {
    hours.push(h);
  }
  
  // Get current time for time indicator
  const now = new Date();
  const todayStr = now.toLocaleDateString();
  const currentMinutes = now.getHours() * 60 + now.getMinutes();
  const currentTimeTop = ((currentMinutes - startHour * 60) / 60) * hourHeight;
  
  const dayWidth = 'calc((100% - 80px) / 7)';
  
  let html = `
    <div style="position: relative; min-height: ${(endHour - startHour + 1) * hourHeight + 60}px;">
      <!-- Header with Days -->
      <div style="position: sticky; top: 0; z-index: 10; background: white; border-bottom: 2px solid #e2e8f0; display: flex;">
        <div style="width: 80px; padding: 12px; border-right: 2px solid #e2e8f0; font-size: 11px; font-weight: 600; color: #94a3b8; text-align: center;">
          GMT${now.getTimezoneOffset() / -60}
        </div>
        ${weekDays.map(day => {
          const isToday = day.toLocaleDateString() === todayStr;
          return `
            <div style="flex: 1; padding: 12px; text-align: center; border-right: 1px solid #e2e8f0; ${isToday ? 'background: #eff6ff;' : ''}">
              <div style="font-size: 11px; font-weight: 600; color: #64748b; text-transform: uppercase;">
                ${day.toLocaleDateString('en-US', { weekday: 'short' })}
              </div>
              <div style="font-size: 20px; font-weight: 700; color: ${isToday ? '#3b82f6' : '#1e293b'}; margin-top: 4px;">
                ${day.getDate()}
              </div>
            </div>
          `;
        }).join('')}
      </div>
      
      <!-- Time Grid and Hour Lines -->
      <div style="display: flex; position: relative;">
        <!-- Time Column -->
        <div style="width: 80px; background: white; border-right: 2px solid #e2e8f0;">
          ${hours.map(h => {
            const hour12 = h > 12 ? h - 12 : (h === 0 ? 12 : h);
            const period = h >= 12 ? 'PM' : 'AM';
            return `
              <div style="height: ${hourHeight}px; border-bottom: 1px solid #e2e8f0; padding: 8px 8px; font-size: 11px; font-weight: 600; color: #64748b; text-align: center;">
                ${hour12} ${period}
              </div>
            `;
          }).join('')}
        </div>
        
        <!-- Days Grid -->
        <div style="flex: 1; position: relative;">
          <!-- Hour Grid Lines -->
          ${hours.map((h, idx) => `
            <div style="position: absolute; left: 0; right: 0; top: ${idx * hourHeight}px; height: ${hourHeight}px; border-bottom: 1px solid #e2e8f0; display: flex;">
              ${weekDays.map((day, dayIdx) => `
                <div style="flex: 1; border-right: 1px solid #e2e8f0; background: ${idx % 2 === 0 ? '#ffffff' : '#fafafa'};"></div>
              `).join('')}
            </div>
          `).join('')}
          
          <!-- Current Time Indicators -->
          ${weekDays.map((day, dayIdx) => {
            const isToday = day.toLocaleDateString() === todayStr;
            if (!isToday || currentTimeTop < 0) return '';
            
            const leftPos = (dayIdx / 7) * 100;
            const width = (1 / 7) * 100;
            
            return `
              <div style="position: absolute; left: ${leftPos}%; width: ${width}%; top: ${currentTimeTop}px; z-index: 5; pointer-events: none;">
                <div style="height: 2px; background: #ef4444; box-shadow: 0 0 4px rgba(239, 68, 68, 0.5);"></div>
                <div style="position: absolute; left: 4px; top: -8px; width: 16px; height: 16px; background: #ef4444; border-radius: 50%; border: 2px solid white;"></div>
              </div>
            `;
          }).join('')}
          
          <!-- Appointments for each day -->
          ${weekDays.map((day, dayIdx) => {
            const dayStr = day.toLocaleDateString();
            const dayAppointments = appointments.filter(apt => {
              if (!apt.date) return false;
              const aptDate = new Date(apt.date).toLocaleDateString();
              return aptDate === dayStr;
            });
            
            const leftPos = (dayIdx / 7) * 100;
            const width = (1 / 7) * 100;
            
            return dayAppointments.map((apt, idx) => {
              const startMinutes = timeToMinutes(apt.time);
              const top = ((startMinutes - startHour * 60) / 60) * hourHeight;
              const duration = apt.duration || 30;
              const height = (duration / 60) * hourHeight - 4;
              const color = getAppointmentColor(apt.status, apt.type, apt.location);
              
              return `
                <div 
                  onclick="showAppointmentDetails('${apt.id}')"
                  style="
                    position: absolute;
                    top: ${top}px;
                    left: calc(${leftPos}% + 4px);
                    width: calc(${width}% - 8px);
                    height: ${height}px;
                    min-height: 50px;
                    background: ${color.bg};
                    border-left: 3px solid ${color.border};
                    border-radius: 4px;
                    padding: 6px 8px;
                    cursor: pointer;
                    overflow: hidden;
                    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                    transition: all 0.2s;
                    z-index: 3;
                  "
                  onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)'; this.style.transform='scale(1.03)'; this.style.zIndex='4';"
                  onmouseout="this.style.boxShadow='0 1px 3px rgba(0,0,0,0.1)'; this.style.transform='scale(1)'; this.style.zIndex='3';"
                  title="${apt.patientName} - ${apt.type}"
                >
                  <div style="color: ${color.text}; font-weight: 700; font-size: 11px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    ${apt.patientName}
                  </div>
                  <div style="color: ${color.text}; opacity: 0.95; font-size: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    ${apt.time}
                  </div>
                  ${height > 60 ? `
                    <div style="color: ${color.text}; opacity: 0.9; font-size: 9px; margin-top: 2px;">
                      <i class="fa-solid fa-location-dot"></i> ${apt.location || 'Room ' + (apt.room || '101')}
                    </div>
                  ` : ''}
                </div>
              `;
            }).join('');
          }).join('')}
        </div>
      </div>
    </div>
  `;
  
  container.innerHTML = html;
  
  // Auto-scroll to current time
  const isThisWeek = weekDays.some(day => day.toLocaleDateString() === todayStr);
  if (isThisWeek && currentTimeTop > 0) {
    setTimeout(() => {
      container.scrollTop = Math.max(0, currentTimeTop - 150);
    }, 100);
  }
}

// Show appointment details in modal
window.showAppointmentDetails = function(appointmentId) {
  const appointment = sampleData.appointments.find(a => a.id === appointmentId);
  if (!appointment) return;
  
  const color = getAppointmentColor(appointment.status, appointment.type, appointment.location);
  
  // Create modal
  const modal = document.createElement('div');
  modal.id = 'appointmentModal';
  modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;';
  modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
  
  modal.innerHTML = `
    <div style="background: white; border-radius: 16px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3);" onclick="event.stopPropagation();">
      <!-- Header -->
      <div style="background: ${color.bg}; color: ${color.text}; padding: 24px; border-radius: 16px 16px 0 0;">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
          <h2 style="font-size: 24px; font-weight: 700; margin: 0;">${appointment.patientName}</h2>
          <button onclick="document.getElementById('appointmentModal').remove();" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px;">
            ×
          </button>
        </div>
        <div style="opacity: 0.95; font-size: 14px;">
          <i class="fa-solid fa-calendar"></i> ${appointment.date || 'Today'} • ${appointment.time}
        </div>
      </div>
      
      <!-- Body -->
      <div style="padding: 24px;">
        <!-- Status -->
        <div style="margin-bottom: 20px;">
          <div style="font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; margin-bottom: 8px;">Status</div>
          <span style="display: inline-block; background: ${color.bg}; color: ${color.text}; padding: 6px 12px; border-radius: 6px; font-size: 13px; font-weight: 600;">
            ${appointment.status}
          </span>
        </div>
        
        <!-- Type -->
        <div style="margin-bottom: 20px;">
          <div style="font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; margin-bottom: 8px;">
            <i class="fa-solid fa-stethoscope"></i> Appointment Type
          </div>
          <div style="font-size: 15px; color: #1e293b; font-weight: 500;">${appointment.type}</div>
        </div>
        
        <!-- Location -->
        <div style="margin-bottom: 20px;">
          <div style="font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; margin-bottom: 8px;">
            <i class="fa-solid fa-location-dot"></i> Location
          </div>
          <div style="font-size: 15px; color: #1e293b; font-weight: 500;">
            ${appointment.location || 'On-site'} ${appointment.room ? '• Room ' + appointment.room : ''}
          </div>
        </div>
        
        <!-- Duration -->
        <div style="margin-bottom: 20px;">
          <div style="font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; margin-bottom: 8px;">
            <i class="fa-solid fa-clock"></i> Duration
          </div>
          <div style="font-size: 15px; color: #1e293b; font-weight: 500;">${appointment.duration || 30} minutes</div>
        </div>
        
        <!-- Patient ID -->
        <div style="margin-bottom: 24px;">
          <div style="font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; margin-bottom: 8px;">
            <i class="fa-solid fa-id-card"></i> Patient ID
          </div>
          <div style="font-size: 15px; color: #1e293b; font-weight: 500; font-family: monospace;">${appointment.patientId}</div>
        </div>
        
        <!-- Actions -->
        <div style="display: flex; gap: 12px; padding-top: 16px; border-top: 1px solid #e2e8f0;">
          <button onclick="document.getElementById('appointmentModal').remove(); startVisit('${appointment.patientId}');" style="flex: 1; background: #3b82f6; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
            <i class="fa-solid fa-video mr-2"></i>Start Visit
          </button>
          <button onclick="document.getElementById('appointmentModal').remove(); startVisit('${appointment.patientId}');" style="flex: 1; background: #f1f5f9; color: #475569; border: none; padding: 12px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
            <i class="fa-solid fa-user mr-2"></i>View Patient
          </button>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}

// Initialize calendar when doctor home page loads
function initializeTeamsCalendar() {
  setTimeout(() => {
    renderTeamsCalendar();
  }, 100);
}

// Function to start a visit with a patient
function startVisit(patientId) {
  // Convert appointment patientId format (P-001) to patient ID format (PAT-001)
  const formattedPatientId = patientId.startsWith('P-') ? patientId.replace('P-', 'PAT-') : patientId;
  
  // Find the patient in the patients data
  const patient = sampleData.patients.find(p => p.id === formattedPatientId);
  
  if (!patient) {
    alert('Patient not found');
    return;
  }
  
  // Set the current patient in global state (both variables for consistency)
  globalState.currentPatient = patient;
  globalSelectedPatientId = patient.id;
  
  // Navigate to patient history section
  loadSection('patienthistory');
}

function loadSection(key) {
  try {
    const area = document.getElementById('contentArea');
    area.innerHTML = ''; // Clear
    area.classList.remove('content-fade');
    void area.offsetWidth; // Trigger reflow
    area.classList.add('content-fade');
    
    // Highlight sidebar
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.nav-sub').forEach(el => el.classList.remove('active'));
    const target = document.querySelector(`[data-key="${key}"]`);
    if(target) {
      target.classList.add('active');
      const parentSublist = target.closest('.nav-sublist');
      if(parentSublist) parentSublist.classList.remove('hidden');
    }

    if (window.innerWidth < 768) {
      hideMobileSidebar();
    }

    if(['fnon','brain','prs','finalreport'].includes(key) && assessmentProgress[key] !== 'completed') {
      setProgress(key, 'in-progress');
    }

    // Router (ensure Treatment Plan always renders)
    if(key === 'treatmentplan' || key === 'treatment-plan') {
      if(currentRole === 'patient') {
        renderPatientTreatmentPlan();
      } else {
        renderTreatmentPlan();
      }
      return;
    }

    // Patient Journey - Open in new window for all roles
    if(key === 'patient-journey') {
      window.open('patient-journey.html', '_blank');
      return;
    }

    // International Patients Questionnaire - Open in new window
    if(key === 'international-patients') {
      window.open('international-patients.html', '_blank');
      return;
    }

    if(currentRole === 'patient') renderPatient(key);
    if(currentRole === 'doctor') renderDoctor(key);
    if(currentRole === 'receptionist') renderReceptionist(key);
    if(currentRole === 'admin') renderAdmin(key);
  } catch(err) {
    console.error('Error in loadSection:', err);
  }
}

// Helper function to open specific PRS disease form
function openSpecificPRSForm(diseaseType) {
  // Navigate to PRS section and directly render the specific form
  renderPRSForm(diseaseType);
}

// ==========================================
// 3. PATIENT PORTAL (Apple Health Style)
// ==========================================
function renderPatient(key) {
  // Load patient data from localStorage or current session
  let p = getActivePatient();
  
  // If patient role, merge with localStorage data
  if (currentRole === 'patient') {
    const storedPatientData = getPatientData();
    if (storedPatientData) {
      p = { ...p, ...storedPatientData };
      console.log('✓ Patient data loaded from localStorage');
    }
  }
  
  const area = document.getElementById('contentArea');

  if(key === 'home') {
    area.innerHTML = `
      <div class="p-4 sm:p-6 lg:p-8 max-w-full overflow-hidden">
        <div class="flex flex-col gap-4 sm:gap-6">
          <!-- Header -->
          <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <div>
              <h2 class="text-2xl sm:text-3xl font-black text-slate-900 mt-1">Welcome, ${p.name}</h2>
              <p class="text-slate-600 mt-1">Here's your health overview at a glance</p>
            </div>
            <div class="flex items-center gap-3 flex-shrink-0">
              <span class="text-sm text-slate-500">Last updated: ${new Date().toLocaleDateString()}</span>
              
              <!-- Notification Bell -->
              <div class="relative">
                <button onclick="toggleNotifications(event)" class="relative p-2 rounded-full hover:bg-slate-100 transition">
                  <i class="fa-solid fa-bell text-slate-600 text-xl"></i>
                  <span class="absolute top-0 right-0 w-5 h-5 bg-slate-600 text-white text-xs font-bold rounded-full flex items-center justify-center">3</span>
                </button>
                
                <!-- Notifications Dropdown -->
                <div id="notificationsDropdown" class="hidden absolute right-0 mt-2 w-80 sm:w-96 bg-white rounded-lg shadow-xl border border-slate-200 z-50" style="max-height: 500px; overflow-y: auto;">
                  <div class="p-4 border-b border-slate-200 flex items-center justify-between">
                    <h3 class="font-bold text-slate-900">Notifications</h3>
                    <button onclick="markAllRead()" class="text-xs font-bold text-sozo-600 hover:underline">
                      Mark all as read
                    </button>
                  </div>
                  
                  <div class="divide-y divide-slate-100">
                    <!-- Notification 1 -->
                    <div class="p-4 hover:bg-slate-50 cursor-pointer transition">
                      <div class="flex gap-3">
                        <div class="w-10 h-10 rounded-full bg-orange-100 flex items-center justify-center flex-shrink-0">
                          <i class="fa-solid fa-calendar-check text-sozo-600"></i>
                        </div>
                        <div class="flex-1">
                          <div class="flex items-start justify-between mb-1">
                            <h4 class="font-bold text-sm text-slate-900">Appointment Reminder</h4>
                            <span class="text-xs text-slate-500">2h ago</span>
                          </div>
                          <p class="text-xs text-slate-600">Your follow-up consultation with Dr. Michael Torres is tomorrow at 10:00 AM</p>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Notification 2 -->
                    <div class="p-4 hover:bg-slate-50 cursor-pointer transition">
                      <div class="flex gap-3">
                        <div class="w-10 h-10 rounded-full bg-orange-100 flex items-center justify-center flex-shrink-0">
                          <i class="fa-solid fa-clipboard-list text-orange-600"></i>
                        </div>
                        <div class="flex-1">
                          <div class="flex items-start justify-between mb-1">
                            <h4 class="font-bold text-sm text-slate-900">Pending Assessment</h4>
                            <span class="text-xs text-slate-500">1d ago</span>
                          </div>
                          <p class="text-xs text-slate-600">Please complete your PRS Assessment - Insomnia (65% complete)</p>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Notification 3 -->
                    <div class="p-4 hover:bg-slate-50 cursor-pointer transition">
                      <div class="flex gap-3">
                        <div class="w-10 h-10 rounded-full bg-orange-100 flex items-center justify-center flex-shrink-0">
                          <i class="fa-solid fa-message text-sozo-600"></i>
                        </div>
                        <div class="flex-1">
                          <div class="flex items-start justify-between mb-1">
                            <h4 class="font-bold text-sm text-slate-900">New Message from Dr. Watson</h4>
                            <span class="text-xs text-slate-500">3d ago</span>
                          </div>
                          <p class="text-xs text-slate-600">Your latest brain mapping results are ready</p>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div class="p-3 border-t border-slate-200 text-center">
                    <button class="text-sm font-bold text-sozo-600 hover:underline" onclick="openNotificationsFullWindow()">View All Notifications</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Quick Stats Row -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="card p-5 border-l-4 border-l-blue-500 cursor-pointer hover:shadow-lg transition" onclick="document.getElementById('upcomingAppointmentsSection').scrollIntoView({behavior: 'smooth', block: 'start'})">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-xs font-bold text-slate-500 uppercase">Upcoming</p>
                  <p class="text-2xl font-black text-slate-900 mt-1">3</p>
                  <p class="text-sm text-slate-600">Appointments</p>
                </div>
                <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center">
                  <i class="fa-solid fa-calendar-check text-blue-600 text-xl"></i>
                </div>
              </div>
            </div>

            <div class="card p-5 border-l-4 border-l-orange-500 cursor-pointer hover:shadow-lg transition" onclick="document.getElementById('pendingAssessmentsSection').scrollIntoView({behavior: 'smooth', block: 'start'})">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-xs font-bold text-slate-500 uppercase">Pending</p>
                  <p class="text-2xl font-black text-slate-900 mt-1">1</p>
                  <p class="text-sm text-slate-600">Assessment</p>
                </div>
                <div class="w-12 h-12 rounded-full bg-orange-100 flex items-center justify-center">
                  <i class="fa-solid fa-clipboard-list text-orange-600 text-xl"></i>
                </div>
              </div>
            </div>

            <div class="card p-5 border-l-4 border-l-sozo-600 cursor-pointer hover:shadow-lg transition" onclick="document.getElementById('medicalHistorySection').scrollIntoView({behavior: 'smooth', block: 'start'})">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-xs font-bold text-slate-500 uppercase">History</p>
                  <p class="text-2xl font-black text-slate-900 mt-1">12</p>
                  <p class="text-sm text-slate-600">Records</p>
                </div>
                <div class="w-12 h-12 rounded-full bg-orange-100 flex items-center justify-center">
                  <i class="fa-solid fa-file-medical text-sozo-600 text-xl"></i>
                </div>
              </div>
            </div>

            <div class="card p-5 border-l-4 border-l-brand-blue cursor-pointer hover:shadow-lg transition" onclick="document.getElementById('workshopsSection').scrollIntoView({behavior: 'smooth', block: 'start'})">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-xs font-bold text-slate-500 uppercase">Workshops</p>
                  <p class="text-2xl font-black text-slate-900 mt-1">2</p>
                  <p class="text-sm text-slate-600">Available</p>
                </div>
                <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center">
                  <i class="fa-solid fa-chalkboard-user text-brand-blue text-xl"></i>
                </div>
              </div>
            </div>
          </div>

          <!-- Main Content Grid -->
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column - Upcoming Appointments & Pending Assessments -->
            <div class="lg:col-span-2 space-y-6">
              <!-- Upcoming Appointments -->
              <div id="upcomingAppointmentsSection" class="card p-8">
                <div class="flex items-center justify-between mb-6">
                  <h3 class="text-xl font-bold text-slate-900 flex items-center gap-2">
                    <i class="fa-solid fa-calendar-check text-blue-600"></i>
                    Upcoming Appointments
                  </h3>
                  <button class="text-sm font-bold text-sozo-600 hover:underline" onclick="loadSection('appointments')">View All</button>
                </div>
                <div class="space-y-4">
                  <!-- Appointment 1 -->
                  <div class="p-5 rounded-lg bg-slate-50 border border-slate-200 hover:shadow-md transition">
                    <div class="flex items-start justify-between">
                      <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                          <span class="badge badge-success">Jan 25</span>
                          <span class="text-sm font-bold text-slate-900">10:00 AM - 11:00 AM</span>
                        </div>
                        <h4 class="font-bold text-base text-slate-900">Follow-up Consultation</h4>
                        <p class="text-sm text-slate-600 mt-2">Dr. Michael Torres</p>
                        <p class="text-xs text-slate-500 mt-1">
                          <i class="fa-solid fa-location-dot mr-1"></i>Clinical Visit
                        </p>
                      </div>
                      <button class="btn-secondary text-xs px-3 py-1">Join</button>
                    </div>
                  </div>

                  <!-- Appointment 3 -->
                  <div class="p-5 rounded-lg bg-slate-50 border border-slate-200 hover:shadow-md transition">
                    <div class="flex items-start justify-between">
                      <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                          <span class="badge badge-warning">Feb 2</span>
                          <span class="text-sm font-bold text-slate-900">3:30 PM - 4:00 PM</span>
                        </div>
                        <h4 class="font-bold text-base text-slate-900">Brain Mapping Session</h4>
                        <p class="text-sm text-slate-600 mt-2">Dr. Emily Watson</p>
                        <p class="text-xs text-slate-500 mt-1">
                          <i class="fa-solid fa-location-dot mr-1"></i>Neuroscience Lab
                        </p>
                      </div>
                      <button class="btn-secondary text-xs px-3 py-1">Reschedule</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Treatment Plan Section -->
              <div id="treatmentPlanSection" class="card p-6">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-lg font-bold text-slate-900 flex items-center gap-2">
                    <i class="fa-solid fa-file-medical text-sozo-600"></i>
                    My Treatment Plan
                  </h3>
                  <button class="btn-primary text-sm" onclick="loadSection('treatment-plan')">
                    <i class="fa-solid fa-arrow-right mr-1"></i>View Full Plan
                  </button>
                </div>

                <!-- Current Treatment Sessions -->
                <div class="mb-4">
                  <h4 class="text-sm font-bold text-slate-700 mb-3 flex items-center gap-2">
                    <i class="fa-solid fa-clipboard-check text-sozo-600"></i>
                    Current Treatment Sessions
                  </h4>
                  <div class="space-y-2">
                    <div class="flex items-center gap-3 p-3 rounded-lg bg-blue-50 border border-blue-200">
                      <div class="w-10 h-10 rounded-full bg-brand-blue flex items-center justify-center text-white flex-shrink-0">
                        <i class="fa-solid fa-brain"></i>
                      </div>
                      <div class="flex-1">
                        <p class="font-bold text-sm text-slate-900">High Beta Protocol (tDCS)</p>
                        <p class="text-xs text-slate-600">Sessions 1-10 • Left DLPFC • 20 min</p>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Suggested Devices -->
                <div>
                  <h4 class="text-sm font-bold text-slate-700 mb-3 flex items-center gap-2">
                    <i class="fa-solid fa-laptop-medical text-sozo-600"></i>
                    Doctor Recommended Devices
                  </h4>
                  <div class="space-y-2">
                    <div class="flex items-center justify-between p-3 rounded-lg bg-orange-50 border border-orange-200">
                      <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-sozo-600 flex items-center justify-center text-white flex-shrink-0">
                          <i class="fa-solid fa-circle-nodes"></i>
                        </div>
                        <div>
                          <p class="font-bold text-sm text-slate-900">tDCS Device</p>
                          <p class="text-xs text-slate-600">Transcranial Direct Current Stimulation</p>
                        </div>
                      </div>
                      <span class="badge badge-success text-xs">€1200</span>
                    </div>
                    <div class="flex items-center justify-between p-3 rounded-lg bg-slate-50 border border-slate-200">
                      <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-slate-600 flex items-center justify-center text-white flex-shrink-0">
                          <i class="fa-solid fa-wave-square"></i>
                        </div>
                        <div>
                          <p class="font-bold text-sm text-slate-900">CES Device</p>
                          <p class="text-xs text-slate-600">Cranial Electrotherapy Stimulation</p>
                        </div>
                      </div>
                      <span class="badge badge-info text-xs">€900</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Pending Medical Assessments -->
              <div id="pendingAssessmentsSection" class="card p-8">
                <div class="flex items-center justify-between mb-6">
                  <h3 class="text-xl font-bold text-slate-900 flex items-center gap-2">
                    <i class="fa-solid fa-clipboard-list text-orange-600"></i>
                    Pending Medical Assessments
                  </h3>
                </div>
                <div class="space-y-4">
                  <!-- Assessment 1 -->
                  <div class="p-5 rounded-lg bg-gradient-to-r from-orange-50 to-orange-50 border border-orange-200">
                    <div class="flex items-start justify-between mb-3">
                      <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                          <span class="badge badge-warning">Action Required</span>
                          <span class="text-xs text-slate-500">Due in 3 days</span>
                        </div>
                        <h4 class="font-bold text-base text-slate-900">PRS Assessment - Insomnia</h4>
                        <p class="text-sm text-slate-600 mt-2">Polygenic Risk Score Evaluation for Sleep Disorders</p>
                        <div class="mt-3">
                          <div class="flex items-center justify-between text-xs text-slate-600 mb-1">
                            <span>Progress</span>
                            <span class="font-bold">65% Complete</span>
                          </div>
                          <div class="h-2 bg-slate-200 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-orange-500 to-orange-500" style="width: 65%"></div>
                          </div>
                        </div>
                      </div>
                      <button class="btn-primary text-xs px-4 py-2" onclick="openSpecificPRSForm('insomnia')">Continue</button>
                    </div>
                    
                    <!-- Specific Form Indicator -->
                    <div class="mt-3 pt-3 border-t border-orange-300">
                      <div class="flex items-center gap-2">
                        <i class="fa-solid fa-moon text-sozo-600"></i>
                        <span class="text-xs font-bold text-slate-700">Current Form: Insomnia Assessment</span>
                      </div>
                    </div>
                  </div>

                  <!-- Completed Assessments Info -->
                  <div class="p-5 rounded-lg bg-orange-50 border border-orange-200">
                    <div class="flex items-center gap-3">
                      <div class="w-10 h-10 rounded-full bg-sozo-600 flex items-center justify-center text-white">
                        <i class="fa-solid fa-check"></i>
                      </div>
                      <div class="flex-1">
                        <h4 class="font-bold text-slate-900">All other assessments completed</h4>
                        <p class="text-sm text-slate-600 mt-1">FNON Assessment completed on Jan 15, 2026</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Right Column - Quick Actions, Workshops & Medical History -->
            <div class="space-y-6">
              <!-- Quick Actions -->
              <div class="card p-6 bg-gradient-to-br from-slate-900 to-slate-800 text-white">
                <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                  <i class="fa-solid fa-bolt"></i>
                  Quick Actions
                </h3>
                <div class="space-y-2">
                  <button class="w-full btn-secondary bg-white text-slate-900 hover:bg-slate-100 text-left" onclick="loadSection('appointments')">
                    <i class="fa-solid fa-calendar-plus mr-2"></i>Book Appointment
                  </button>
                  <button class="w-full btn-secondary bg-white text-slate-900 hover:bg-slate-100 text-left" onclick="loadSection('messages')">
                    <i class="fa-solid fa-message mr-2"></i>Send Message
                  </button>
                  <button class="w-full btn-secondary bg-white text-slate-900 hover:bg-slate-100 text-left" onclick="loadSection('eshop')">
                    <i class="fa-solid fa-cart-shopping mr-2"></i>Browse E-Shop
                  </button>
                </div>
              </div>

              <!-- Medical History Summary -->
              <div id="medicalHistorySection" class="card p-6">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-lg font-bold text-slate-900 flex items-center gap-2">
                    <i class="fa-solid fa-file-medical text-sozo-600"></i>
                    Medical History
                  </h3>
                  <button class="text-sm font-bold text-sozo-600 hover:underline" onclick="loadSection('reports')">View All</button>
                </div>
                
                <!-- General Reports Section -->
                <div class="mb-4">
                  <h4 class="text-xs font-bold text-slate-600 uppercase mb-2 flex items-center gap-2">
                    <i class="fa-solid fa-hospital text-sozo-600"></i>
                    General Reports
                  </h4>
                  <div class="space-y-2">
                    <!-- CT Scan Report -->
                    <div class="p-3 rounded-lg bg-blue-50 border border-blue-200 hover:bg-blue-100 transition cursor-pointer">
                      <div class="flex items-start gap-3">
                        <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0">
                          <i class="fa-solid fa-x-ray text-brand-blue text-sm"></i>
                        </div>
                        <div class="flex-1">
                          <h5 class="font-bold text-sm text-slate-900">CT Scan Report</h5>
                          <p class="text-xs text-slate-600 mt-1">Brain CT - Normal findings</p>
                          <p class="text-xs text-slate-500 mt-1">Jan 15, 2026</p>
                        </div>
                      </div>
                    </div>

                    <!-- MRI Scan Report -->
                    <div class="p-3 rounded-lg bg-orange-50 border border-orange-200 hover:bg-orange-100 transition cursor-pointer">
                      <div class="flex items-start gap-3">
                        <div class="w-8 h-8 rounded-full bg-orange-100 flex items-center justify-center flex-shrink-0">
                          <i class="fa-solid fa-brain text-sozo-600 text-sm"></i>
                        </div>
                        <div class="flex-1">
                          <h5 class="font-bold text-sm text-slate-900">MRI Scan Report</h5>
                          <p class="text-xs text-slate-600 mt-1">Structural brain imaging</p>
                          <p class="text-xs text-slate-500 mt-1">Jan 12, 2026</p>
                        </div>
                      </div>
                    </div>

                    <!-- Blood Test Report -->
                    <div class="p-3 rounded-lg bg-slate-50 border border-slate-200 hover:bg-slate-100 transition cursor-pointer">
                      <div class="flex items-start gap-3">
                        <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center flex-shrink-0">
                          <i class="fa-solid fa-droplet text-slate-600 text-sm"></i>
                        </div>
                        <div class="flex-1">
                          <h5 class="font-bold text-sm text-slate-900">Blood Test Report</h5>
                          <p class="text-xs text-slate-600 mt-1">Complete blood count</p>
                          <p class="text-xs text-slate-500 mt-1">Jan 8, 2026</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Sozo Related Reports Section -->
                <div>
                  <h4 class="text-xs font-bold text-slate-600 uppercase mb-2 flex items-center gap-2">
                    <i class="fa-solid fa-brain-circuit text-orange-600"></i>
                    Sozo Related Reports
                  </h4>
                  <div class="space-y-2">
                    <!-- FNON Assessment -->
                    <div class="p-3 rounded-lg bg-orange-50 border border-orange-200 hover:bg-orange-100 transition cursor-pointer">
                      <div class="flex items-start gap-3">
                        <div class="w-8 h-8 rounded-full bg-orange-100 flex items-center justify-center flex-shrink-0">
                          <i class="fa-solid fa-clipboard-check text-orange-600 text-sm"></i>
                        </div>
                        <div class="flex-1">
                          <h5 class="font-bold text-sm text-slate-900">FNON Assessment</h5>
                          <p class="text-xs text-slate-600 mt-1">Functional neurological assessment</p>
                          <p class="text-xs text-slate-500 mt-1">Jan 20, 2026</p>
                        </div>
                      </div>
                    </div>

                    <!-- PRS Report -->
                    <div class="p-3 rounded-lg bg-slate-50 border border-slate-200 hover:bg-slate-100 transition cursor-pointer">
                      <div class="flex items-start gap-3">
                        <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center flex-shrink-0">
                          <i class="fa-solid fa-clipboard-list text-slate-600 text-sm"></i>
                        </div>
                        <div class="flex-1">
                          <h5 class="font-bold text-sm text-slate-900">PRS Report</h5>
                          <p class="text-xs text-slate-600 mt-1">Polygenic Risk Score assessment</p>
                          <p class="text-xs text-slate-500 mt-1">Jan 18, 2026</p>
                        </div>
                      </div>
                    </div>

                    <!-- Final Report -->
                    <div class="p-3 rounded-lg bg-blue-50 border border-blue-200 hover:bg-blue-100 transition cursor-pointer">
                      <div class="flex items-start gap-3">
                        <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0">
                          <i class="fa-solid fa-file-medical text-brand-blue text-sm"></i>
                        </div>
                        <div class="flex-1">
                          <h5 class="font-bold text-sm text-slate-900">Final Report</h5>
                          <p class="text-xs text-slate-600 mt-1">Comprehensive treatment summary</p>
                          <p class="text-xs text-slate-500 mt-1">Jan 22, 2026</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- View More -->
                <div class="text-center pt-4 mt-4 border-t border-slate-200">
                  <button class="text-sm font-bold text-slate-600 hover:text-sozo-600" onclick="loadSection('reports')">
                    <i class="fa-solid fa-arrow-right mr-1"></i>View All Reports
                  </button>
                </div>
              </div>

              <!-- Upcoming Workshops -->
              <div id="workshopsSection" class="card p-6 bg-gradient-to-br from-orange-50 to-sozo-50">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-lg font-bold text-slate-900 flex items-center gap-2">
                    <i class="fa-solid fa-chalkboard-user text-sozo-600"></i>
                    Upcoming Workshops
                  </h3>
                </div>
                <div class="space-y-3">
                  <!-- Workshop 1 -->
                  <div class="p-4 rounded-lg bg-white border border-orange-200 hover:shadow-md transition">
                    <div class="flex items-start gap-3">
                      <div class="w-10 h-10 rounded-full bg-sozo-600 flex items-center justify-center text-white flex-shrink-0">
                        <i class="fa-solid fa-brain"></i>
                      </div>
                      <div class="flex-1">
                        <h4 class="font-bold text-sm text-slate-900">Understanding TMS Therapy</h4>
                        <p class="text-xs text-slate-600 mt-1">Learn about treatment benefits</p>
                        <div class="flex items-center gap-4 mt-2 text-xs text-slate-500">
                          <span><i class="fa-solid fa-calendar mr-1"></i>Jan 28</span>
                          <span><i class="fa-solid fa-clock mr-1"></i>6:00 PM</span>
                        </div>
                        <button class="mt-2 text-xs font-bold text-sozo-600 hover:underline">Register Now</button>
                      </div>
                    </div>
                  </div>

                  <!-- Workshop 2 -->
                  <div class="p-4 rounded-lg bg-white border border-blue-200 hover:shadow-md transition">
                    <div class="flex items-start gap-3">
                      <div class="w-10 h-10 rounded-full bg-brand-blue flex items-center justify-center text-white flex-shrink-0">
                        <i class="fa-solid fa-heart"></i>
                      </div>
                      <div class="flex-1">
                        <h4 class="font-bold text-sm text-slate-900">Mindfulness & Wellness</h4>
                        <p class="text-xs text-slate-600 mt-1">Stress management techniques</p>
                        <div class="flex items-center gap-4 mt-2 text-xs text-slate-500">
                          <span><i class="fa-solid fa-calendar mr-1"></i>Feb 5</span>
                          <span><i class="fa-solid fa-clock mr-1"></i>3:00 PM</span>
                        </div>
                        <button class="mt-2 text-xs font-bold text-brand-blue hover:underline">Register Now</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  }
  else if(key === 'dashboard') {
    const healthScore = 86;
    const sleepScore = 92;
    const currentSteps = 8432;
    const connectedDevices = 2;
    const totalDevices = 3;

    const chartState = { timeframe: 'weekly', metric: 'steps' };
    const chartMeta = {
      steps: { label: 'Steps', color: 'from-sozo-500 to-orange-500', bars: { daily: [20, 45, 60, 40, 50, 70, 80], weekly: [60, 72, 80, 68, 75, 70, 78], monthly: [55, 60, 65, 70, 68, 74, 80] } },
      hrv: { label: 'HRV (ms)', color: 'from-brand-blue to-slate-600', bars: { daily: [35, 40, 48, 42, 50, 55, 52], weekly: [42, 44, 48, 46, 50, 52, 54], monthly: [38, 40, 43, 45, 46, 48, 50] } },
      sleep: { label: 'Sleep Score', color: 'from-sozo-600 to-orange-500', bars: { daily: [88, 90, 92, 86, 94, 96, 90], weekly: [90, 92, 93, 91, 94, 95, 92], monthly: [88, 89, 90, 91, 92, 93, 94] } }
    };

    area.innerHTML = `
      <div class="p-4 sm:p-6 lg:p-8 max-w-full overflow-hidden">
        <div class="flex flex-col gap-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-xs font-bold text-slate-500 uppercase tracking-wide">Dashboard</p>
              <h2 class="text-3xl font-black text-slate-900 mt-1">Hi ${p.name}</h2>
            </div>
            <div class="flex items-center gap-3">
              <button class="text-sm font-bold text-sozo-600 hover:underline">Customize view</button>
            </div>
          </div>
        </div>

        <!-- Row 1: Scorecard -->
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-bold text-slate-900"><i class="fa-solid fa-chart-line mr-2"></i>Health Metrics</h3>
          <label class="flex items-center gap-2 text-xs font-bold text-slate-600 cursor-pointer">
            <input type="checkbox" id="trendAnalysisToggle" class="w-4 h-4 accent-sozo-600" />
            <span>Enable Trend Analysis</span>
          </label>
        </div>
        <div class="grid gap-4 md:grid-cols-2 xl:grid-cols-4 items-stretch">
          <div class="card p-5 h-full border border-slate-200 hover:shadow-xl transition hover:-translate-y-1 relative overflow-hidden">
            <div class="absolute inset-0 bg-gradient-to-br from-slate-50 to-white pointer-events-none"></div>
            <div class="relative flex items-center justify-between mb-3">
              <div class="flex items-center gap-2 text-slate-500 text-xs font-bold uppercase"><span class="w-2 h-2 rounded-full bg-sozo-600"></span> Activity</div>
              <span class="text-xs font-bold text-orange-600 bg-orange-50 px-2 py-1 rounded-full">Goal 10k</span>
            </div>
            <p class="text-sm text-slate-500 relative">Daily Steps</p>
            <div class="text-3xl font-black text-slate-900 relative">${currentSteps.toLocaleString()}</div>
            <div id="trend-steps" class="hidden mt-2 text-xs text-sozo-600 font-bold"><i class="fa-solid fa-arrow-trend-up"></i> +12% vs last week</div>
            <div class="mt-3 relative">
              <div class="h-2 bg-slate-100 rounded-full overflow-hidden"><div class="h-full bg-gradient-to-r from-orange-400 to-sozo-600" style="width:${Math.min(100, Math.round((currentSteps/10000)*100))}%"></div></div>
              <p class="text-xs text-slate-500 mt-1">${Math.round((currentSteps/10000)*100)}% of daily goal</p>
            </div>
          </div>

          <div class="card p-5 h-full border border-slate-200 hover:shadow-xl transition hover:-translate-y-1">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-2 text-slate-500 text-xs font-bold uppercase"><span class="w-2 h-2 rounded-full bg-sozo-600"></span> Sozo Watch</div>
              <span class="text-xs font-bold text-sozo-600 bg-orange-50 px-2 py-1 rounded-full">Connected</span>
            </div>
            <p class="text-sm text-slate-500">HR Variability</p>
            <div class="text-3xl font-black text-slate-900">48<span class="text-sm text-slate-400"> ms</span></div>
            <div class="mt-3 h-2 bg-slate-100 rounded-full overflow-hidden"><div class="h-full bg-gradient-to-r from-slate-600 to-orange-500" style="width:68%"></div></div>
            <div id="trend-hrv" class="hidden mt-2 text-xs text-blue-600 font-bold"><i class="fa-solid fa-arrow-trend-up"></i> +8% improvement</div>
          </div>

          <div class="card p-5 h-full border border-slate-200 hover:shadow-xl transition hover:-translate-y-1">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-2 text-slate-500 text-xs font-bold uppercase"><span class="w-2 h-2 rounded-full bg-sozo-600"></span> Sozo Ring</div>
              <span class="text-xs font-bold text-sozo-600 bg-orange-50 px-2 py-1 rounded-full">Live</span>
            </div>
            <p class="text-sm text-slate-500">Sleep Score</p>
            <div class="text-3xl font-black text-slate-900">${sleepScore}<span class="text-sm text-slate-400">/100</span></div>
            <p class="text-xs text-sozo-600 mt-2 flex items-center gap-1"><i class="fa-solid fa-arrow-up"></i> +4% vs last week</p>
            <div id="trend-sleep" class="hidden mt-2 text-xs text-sozo-600 font-bold"><i class="fa-solid fa-chart-line"></i> Consistent improvement</div>
          </div>

          <div class="card p-5 h-full border border-slate-200 bg-gradient-to-br from-orange-50 to-slate-50 flex flex-col justify-between">
            <div class="flex items-center justify-between text-xs font-bold uppercase text-slate-500 mb-2"><span>Health Score</span><span class="text-sozo-600">Live</span></div>
            <div class="flex items-center justify-center relative">
              <svg class="w-36 h-36 -rotate-90" viewBox="0 0 120 120">
                <defs>
                  <linearGradient id="gaugeGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stop-color="#f97316" />
                    <stop offset="100%" stop-color="#fb923c" />
                  </linearGradient>
                </defs>
                <circle cx="60" cy="60" r="50" fill="none" stroke="#f1f5f9" stroke-width="12" />
                <circle cx="60" cy="60" r="50" fill="none" stroke="url(#gaugeGradient)" stroke-width="12" stroke-linecap="round" stroke-dasharray="314" stroke-dashoffset="${314 - (314*(healthScore/100))}" />
              </svg>
              <div class="absolute text-center">
                <div class="text-4xl font-black text-slate-900">${healthScore}</div>
                <div class="text-xs text-slate-500">Good • +2 today</div>
              </div>
            </div>
            <div class="flex items-center justify-between text-xs text-slate-500 mt-2"><span>Recovery</span><span class="text-sozo-600 font-bold">Stable</span></div>
          </div>
        </div>

        <!-- Row 2: Trends & Recommendations -->
        <div class="grid gap-4 lg:grid-cols-3 items-stretch">
          <div class="card p-5 lg:col-span-2 border border-slate-200">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
              <div>
                <p class="text-xs font-bold text-slate-500 uppercase">Weekly Health Trends</p>
                <p class="text-sm text-slate-500">Toggle timeframes and metrics</p>
              </div>
              <div class="flex flex-wrap gap-2">
                <div class="bg-slate-100 rounded-full p-1 flex">
                  <button class="time-toggle px-3 py-1 text-xs font-bold rounded-full" data-tf="daily">Daily</button>
                  <button class="time-toggle px-3 py-1 text-xs font-bold rounded-full" data-tf="weekly">Weekly</button>
                  <button class="time-toggle px-3 py-1 text-xs font-bold rounded-full" data-tf="monthly">Monthly</button>
                </div>
                <div class="bg-slate-100 rounded-full p-1 flex">
                  <button class="metric-toggle px-3 py-1 text-xs font-bold rounded-full" data-metric="steps">Show Steps</button>
                  <button class="metric-toggle px-3 py-1 text-xs font-bold rounded-full" data-metric="hrv">Show HRV</button>
                  <button class="metric-toggle px-3 py-1 text-xs font-bold rounded-full" data-metric="sleep">Show Sleep</button>
                </div>
              </div>
            </div>
            <div class="h-64 bg-slate-50 rounded-xl p-4 flex items-end gap-3" id="trendBars"></div>
            <div class="flex justify-between text-xs text-slate-400 mt-2"><span>Mon</span><span>Sun</span></div>
          </div>

          <div class="card p-5 border border-slate-200 bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white flex flex-col justify-between">
            <div>
              <p class="text-xs font-bold uppercase text-orange-200 mb-2">Smart Recommendations</p>
              <h3 class="text-xl font-black mb-3">Sharper focus, better sleep</h3>
              <ul class="space-y-3 text-sm">
                <li class="flex items-start gap-2"><span class="mt-1 text-orange-300"><i class="fa-solid fa-bolt"></i></span> Add a 10 min daylight walk after lunch to lift HRV.</li>
                <li class="flex items-start gap-2"><span class="mt-1 text-orange-300"><i class="fa-solid fa-bed"></i></span> Bring lights down 30 mins earlier to protect sleep score.</li>
                <li class="flex items-start gap-2"><span class="mt-1 text-orange-300"><i class="fa-solid fa-droplet"></i></span> Sip water through afternoon meetings to sustain focus.</li>
              </ul>
            </div>
            <button class="mt-4 bg-white text-slate-900 font-bold px-4 py-2 rounded-lg hover:shadow-lg transition">Generate new plan</button>
          </div>
        </div>

        <!-- Row 4: Benchmarking & Connectivity -->
        <div class="grid gap-4 lg:grid-cols-3 items-stretch">
          <div class="card p-5 lg:col-span-2 border border-slate-200 bg-gradient-to-r from-orange-50 to-blue-50">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-2 text-slate-700 font-bold"><i class="fa-solid fa-chart-bar text-sozo-600"></i> How You Compare</div>
              <label class="flex items-center gap-2 text-xs font-bold text-slate-600 cursor-pointer">
                <input type="checkbox" id="benchmarkToggle" class="w-4 h-4 accent-sozo-600" />
                <span>Show Peer Benchmarks</span>
              </label>
            </div>
            <div id="compareUser" class="grid grid-cols-1 md:grid-cols-3 gap-3">
              <div class="bg-white/80 border border-slate-200 rounded-lg p-3">
                <p class="text-xs text-slate-500 uppercase mb-1">Sleep Quality</p>
                <p class="text-2xl font-black text-slate-900">${sleepScore}<span class="text-xs text-slate-500"> / 100</span></p>
                <p class="text-xs text-sozo-600">Trending up</p>
              </div>
              <div class="bg-white/80 border border-slate-200 rounded-lg p-3">
                <p class="text-xs text-slate-500 uppercase mb-1">Activity</p>
                <p class="text-2xl font-black text-slate-900">${currentSteps.toLocaleString()}</p>
                <p class="text-xs text-orange-600">Goal focused</p>
              </div>
              <div class="bg-white/80 border border-slate-200 rounded-lg p-3">
                <p class="text-xs text-slate-500 uppercase mb-1">HRV</p>
                <p class="text-2xl font-black text-slate-900">48 ms</p>
                <p class="text-xs text-blue-600">Healthy range</p>
              </div>
            </div>
            <div id="comparePeers" class="grid grid-cols-1 md:grid-cols-3 gap-3 hidden">
              <div class="bg-white/90 border border-blue-200 rounded-lg p-3">
                <p class="text-xs text-slate-500 uppercase mb-1">Sleep Quality</p>
                <p class="text-2xl font-black text-brand-blue">Top 10%</p>
                <p class="text-xs text-slate-600">Peer percentile</p>
              </div>
              <div class="bg-white/90 border border-blue-200 rounded-lg p-3">
                <p class="text-xs text-slate-500 uppercase mb-1">Activity</p>
                <p class="text-2xl font-black text-brand-blue">Top 18%</p>
                <p class="text-xs text-slate-600">Peer percentile</p>
              </div>
              <div class="bg-white/90 border border-blue-200 rounded-lg p-3">
                <p class="text-xs text-slate-500 uppercase mb-1">HRV</p>
                <p class="text-2xl font-black text-brand-blue">Top 22%</p>
                <p class="text-xs text-slate-600">Peer percentile</p>
              </div>
            </div>
          </div>

          <div class="card p-5 border border-slate-200 flex flex-col gap-4">
            <div>
              <div class="flex items-center justify-between text-xs font-bold text-slate-600 mb-2"><span>Devices</span><span>${connectedDevices}/${totalDevices} Connected</span></div>
              <div class="h-2 bg-slate-100 rounded-full overflow-hidden"><div class="h-full bg-gradient-to-r from-sozo-500 to-orange-500" style="width:${(connectedDevices/totalDevices)*100}%"></div></div>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div class="relative p-3 rounded-lg border border-slate-200 bg-white hover:shadow-lg transition">
                <div class="flex items-center justify-between text-xs font-bold text-slate-500 mb-1"><span>Watch</span><span class="text-sozo-600">100%</span></div>
                <div class="flex items-center gap-2 text-slate-700"><i class="fa-solid fa-battery-full text-sozo-600"></i> Charging</div>
              </div>
              <div class="relative p-3 rounded-lg border border-slate-200 bg-white hover:shadow-lg transition">
                <div class="flex items-center justify-between text-xs font-bold text-slate-500 mb-1"><span>Ring</span><span class="text-slate-600">40%</span></div>
                <div class="flex items-center gap-2 text-slate-700"><i class="fa-solid fa-battery-half text-slate-600"></i> Low</div>
              </div>
              <div class="relative p-3 rounded-lg border border-slate-200 bg-white hover:shadow-lg transition opacity-60">
                <div class="flex items-center justify-between text-xs font-bold text-slate-500 mb-1"><span>Gloves</span><span class="text-slate-600">Offline</span></div>
                <div class="flex items-center gap-2 text-slate-700"><i class="fa-solid fa-plug-circle-xmark text-slate-600"></i> Disconnected</div>
                <button class="absolute inset-0 bg-white/80 text-slate-600 font-bold text-xs rounded-lg flex items-center justify-center hover:bg-white">Connect</button>
              </div>
            </div>
          </div>
        </div>


      </div>
    `;

    setTimeout(() => {
      const timeButtons = Array.from(document.querySelectorAll('.time-toggle'));
      const metricButtons = Array.from(document.querySelectorAll('.metric-toggle'));
      const barsEl = document.getElementById('trendBars');
      const benchmarkToggle = document.getElementById('benchmarkToggle');
      const compareUser = document.getElementById('compareUser');
      const comparePeers = document.getElementById('comparePeers');
      
      console.log('Dashboard init:', { timeButtons: timeButtons.length, metricButtons: metricButtons.length, barsEl, chartState });

      function paintActive() {
        timeButtons.forEach(b => b.className = `time-toggle px-3 py-1 text-xs font-bold rounded-full ${b.dataset.tf === chartState.timeframe ? 'bg-gradient-to-r from-sozo-500 to-orange-500 text-white shadow' : 'text-slate-600'}`);
        metricButtons.forEach(b => b.className = `metric-toggle px-3 py-1 text-xs font-bold rounded-full ${b.dataset.metric === chartState.metric ? 'bg-slate-900 text-white shadow' : 'text-slate-600'}`);
      }

      function renderBars() {
        if(!barsEl) {
          console.error('trendBars element not found');
          return;
        }
        const meta = chartMeta[chartState.metric];
        const values = meta.bars[chartState.timeframe];
        console.log('Rendering bars:', chartState, values);
        barsEl.innerHTML = values.map(v => {
          const height = Math.max(8, Math.min(100, v));
          return `<div class="flex-1 flex items-end" style="height:100%;">
            <div class="w-full rounded-t-lg bg-gradient-to-t ${meta.color} transition-all duration-500 ease-out" style="height:${height}%;"></div>
          </div>`;
        }).join('');
      }

      timeButtons.forEach(btn => btn.addEventListener('click', () => {
        chartState.timeframe = btn.dataset.tf;
        paintActive();
        renderBars();
      }));

      metricButtons.forEach(btn => btn.addEventListener('click', () => {
        chartState.metric = btn.dataset.metric;
        paintActive();
        renderBars();
      }));

      // Trend Analysis Toggle
      const trendToggle = document.getElementById('trendAnalysisToggle');
      if(trendToggle) {
        trendToggle.addEventListener('change', () => {
          const showTrends = trendToggle.checked;
          const trendElements = ['trend-steps', 'trend-hrv', 'trend-sleep'];
          trendElements.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.classList.toggle('hidden', !showTrends);
          });
        });
      }

      if(benchmarkToggle && compareUser && comparePeers) {
        benchmarkToggle.addEventListener('change', () => {
          const on = benchmarkToggle.checked;
          compareUser.classList.toggle('hidden', on);
          comparePeers.classList.toggle('hidden', !on);
        });
      }

      paintActive();
      renderBars();
    }, 50);

    // Notification panel toggle
    setTimeout(() => {
      const notificationBtn = document.getElementById('notificationBtn');
      const notificationPanel = document.getElementById('notificationPanel');
      
      // Bind only once to avoid duplicate toggles
      if (notificationBtn && notificationPanel && !notificationBtn.dataset.bound) {
        notificationBtn.dataset.bound = 'true';
        notificationBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          notificationPanel.classList.remove('hidden');
        });

        // Close on outside click
        document.addEventListener('click', (e) => {
          if (!notificationPanel.contains(e.target) && !notificationBtn.contains(e.target)) {
            notificationPanel.classList.add('hidden');
          }
        });
      }
    }, 50);

    // Show notification insights
    window.showNotificationInsight = function(type) {
      const insights = {
        appointment: {
          title: 'Upcoming Appointment Details',
          content: `
            <div class="space-y-4">
              <div class="flex items-start gap-3">
                <i class="fa-solid fa-calendar-check text-2xl text-blue-600 mt-1"></i>
                <div>
                  <h4 class="font-bold text-slate-900">TMS Therapy Session</h4>
                  <p class="text-sm text-slate-600 mt-1">Dr. Sarah Chen, Neurology</p>
                </div>
              </div>
              <div class="bg-slate-50 rounded-lg p-4 space-y-2">
                <div class="flex justify-between text-sm">
                  <span class="text-slate-600">Date & Time:</span>
                  <span class="font-bold text-slate-900">Tomorrow, 2:00 PM</span>
                </div>
                <div class="flex justify-between text-sm">
                  <span class="text-slate-600">Duration:</span>
                  <span class="font-bold text-slate-900">45 minutes</span>
                </div>
                <div class="flex justify-between text-sm">
                  <span class="text-slate-600">Location:</span>
                  <span class="font-bold text-slate-900">Clinic Room 3</span>
                </div>
              </div>
              <div class="border-t border-slate-200 pt-4">
                <h5 class="text-sm font-bold text-slate-900 mb-2">Preparation Notes:</h5>
                <ul class="text-sm text-slate-600 space-y-1 list-disc list-inside">
                  <li>Arrive 10 minutes early</li>
                  <li>Bring your Sozo Ring device data</li>
                  <li>Have had a light meal beforehand</li>
                </ul>
              </div>
            </div>
          `
        },
        news1: {
          title: 'Latest Research: TMS Effectiveness',
          content: `
            <div class="space-y-4">
              <div class="flex items-start gap-3">
                <i class="fa-solid fa-newspaper text-2xl text-sozo-600 mt-1"></i>
                <div>
                  <h4 class="font-bold text-slate-900">New Clinical Study Published</h4>
                  <p class="text-sm text-slate-600 mt-1">Journal of Neurotherapy - December 2025</p>
                </div>
              </div>
              <div class="bg-orange-50 rounded-lg p-4">
                <p class="text-sm text-slate-700 leading-relaxed">
                  A comprehensive study involving 500+ patients shows that TMS therapy combined with 
                  real-time biometric monitoring (like your Sozo devices) improves treatment outcomes 
                  by 34% compared to traditional approaches.
                </p>
              </div>
              <div class="border-t border-slate-200 pt-4">
                <h5 class="text-sm font-bold text-slate-900 mb-2">Key Findings:</h5>
                <ul class="text-sm text-slate-600 space-y-1 list-disc list-inside">
                  <li>Better sleep quality correlation with treatment</li>
                  <li>Improved HRV readings within 2-3 weeks</li>
                  <li>Enhanced patient engagement through device tracking</li>
                </ul>
              </div>
            </div>
          `
        },
        device: {
          title: 'Device Sync Complete',
          content: `
            <div class="space-y-4">
              <div class="flex items-start gap-3">
                <i class="fa-solid fa-circle-check text-2xl text-orange-600 mt-1"></i>
                <div>
                  <h4 class="font-bold text-slate-900">Sozo Ring Data Updated</h4>
                  <p class="text-sm text-slate-600 mt-1">Last sync: 5 hours ago</p>
                </div>
              </div>
              <div class="bg-orange-50 rounded-lg p-4 space-y-3">
                <div class="flex items-center justify-between">
                  <span class="text-sm text-slate-700">Sleep Score</span>
                  <span class="text-lg font-bold text-slate-900">92/100</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-sm text-slate-700">Heart Rate</span>
                  <span class="text-lg font-bold text-slate-900">68 bpm</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-sm text-slate-700">Activity Minutes</span>
                  <span class="text-lg font-bold text-slate-900">45 min</span>
                </div>
              </div>
              <div class="border-t border-slate-200 pt-4">
                <p class="text-sm text-sozo-600 flex items-center gap-2">
                  <i class="fa-solid fa-check-circle"></i>
                  Your metrics are trending positively!
                </p>
              </div>
            </div>
          `
        }
      };

      const data = insights[type];
      if (!data) return;

      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 max-h-[80vh] overflow-hidden">
          <div class="flex items-center justify-between p-6 border-b border-slate-200">
            <h3 class="text-lg font-bold text-slate-900">${data.title}</h3>
            <button onclick="this.closest('.fixed').remove()" class="text-slate-400 hover:text-slate-600 transition">
              <i class="fa-solid fa-times text-xl"></i>
            </button>
          </div>
          <div class="p-6 overflow-y-auto">
            ${data.content}
          </div>
          <div class="flex gap-3 p-6 border-t border-slate-200 bg-slate-50">
            <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-2 bg-slate-200 text-slate-700 font-bold rounded-lg hover:bg-slate-300 transition">Close</button>
            <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-2 bg-gradient-to-r from-sozo-600 to-orange-500 text-white font-bold rounded-lg hover:shadow-lg transition">Got it</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      
      // Close notification panel
      const panel = document.getElementById('notificationPanel');
      if (panel) panel.classList.add('hidden');
    };

    // Notification panel toggle (guarded to avoid double binding)
    setTimeout(() => {
      const notificationBtn = document.getElementById('notificationBtn');
      const notificationPanel = document.getElementById('notificationPanel');
      
      if (notificationBtn && notificationPanel && !notificationBtn.dataset.bound) {
        notificationBtn.dataset.bound = 'true';
        notificationBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          notificationPanel.classList.remove('hidden');
        });

        document.addEventListener('click', (e) => {
          if (!notificationPanel.contains(e.target) && !notificationBtn.contains(e.target)) {
            notificationPanel.classList.add('hidden');
          }
        });
      }
    }, 50);

    // Show notification insights
    window.showNotificationInsight = function(type) {
      const insights = {
        appointment: {
          title: 'Upcoming Appointment Details',
          content: `
            <div class="space-y-4">
              <div class="flex items-start gap-3">
                <i class="fa-solid fa-calendar-check text-2xl text-blue-600 mt-1"></i>
                <div>
                  <h4 class="font-bold text-slate-900">TMS Therapy Session</h4>
                  <p class="text-sm text-slate-600 mt-1">Dr. Sarah Chen, Neurology</p>
                </div>
              </div>
              <div class="bg-slate-50 rounded-lg p-4 space-y-2">
                <div class="flex justify-between text-sm">
                  <span class="text-slate-600">Date & Time:</span>
                  <span class="font-bold text-slate-900">Tomorrow, 2:00 PM</span>
                </div>
                <div class="flex justify-between text-sm">
                  <span class="text-slate-600">Duration:</span>
                  <span class="font-bold text-slate-900">45 minutes</span>
                </div>
                <div class="flex justify-between text-sm">
                  <span class="text-slate-600">Location:</span>
                  <span class="font-bold text-slate-900">Clinic Room 3</span>
                </div>
              </div>
              <div class="border-t border-slate-200 pt-4">
                <h5 class="text-sm font-bold text-slate-900 mb-2">Preparation Notes:</h5>
                <ul class="text-sm text-slate-600 space-y-1 list-disc list-inside">
                  <li>Arrive 10 minutes early</li>
                  <li>Bring your Sozo Ring device data</li>
                  <li>Have had a light meal beforehand</li>
                </ul>
              </div>
            </div>
          `
        },
        news1: {
          title: 'Latest Research: TMS Effectiveness',
          content: `
            <div class="space-y-4">
              <div class="flex items-start gap-3">
                <i class="fa-solid fa-newspaper text-2xl text-sozo-600 mt-1"></i>
                <div>
                  <h4 class="font-bold text-slate-900">New Clinical Study Published</h4>
                  <p class="text-sm text-slate-600 mt-1">Journal of Neurotherapy - December 2025</p>
                </div>
              </div>
              <div class="bg-orange-50 rounded-lg p-4">
                <p class="text-sm text-slate-700 leading-relaxed">
                  A comprehensive study involving 500+ patients shows that TMS therapy combined with 
                  real-time biometric monitoring (like your Sozo devices) improves treatment outcomes 
                  by 34% compared to traditional approaches.
                </p>
              </div>
              <div class="border-t border-slate-200 pt-4">
                <h5 class="text-sm font-bold text-slate-900 mb-2">Key Findings:</h5>
                <ul class="text-sm text-slate-600 space-y-1 list-disc list-inside">
                  <li>Better sleep quality correlation with treatment</li>
                  <li>Improved HRV readings within 2-3 weeks</li>
                  <li>Enhanced patient engagement through device tracking</li>
                </ul>
              </div>
            </div>
          `
        },
        device: {
          title: 'Device Sync Complete',
          content: `
            <div class="space-y-4">
              <div class="flex items-start gap-3">
                <i class="fa-solid fa-circle-check text-2xl text-orange-600 mt-1"></i>
                <div>
                  <h4 class="font-bold text-slate-900">Sozo Ring Data Updated</h4>
                  <p class="text-sm text-slate-600 mt-1">Last sync: 5 hours ago</p>
                </div>
              </div>
              <div class="bg-orange-50 rounded-lg p-4 space-y-3">
                <div class="flex items-center justify-between">
                  <span class="text-sm text-slate-700">Sleep Score</span>
                  <span class="text-lg font-bold text-slate-900">92/100</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-sm text-slate-700">Heart Rate</span>
                  <span class="text-lg font-bold text-slate-900">68 bpm</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-sm text-slate-700">Activity Minutes</span>
                  <span class="text-lg font-bold text-slate-900">45 min</span>
                </div>
              </div>
              <div class="border-t border-slate-200 pt-4">
                <p class="text-sm text-sozo-600 flex items-center gap-2">
                  <i class="fa-solid fa-check-circle"></i>
                  Your metrics are trending positively!
                </p>
              </div>
            </div>
          `
        }
      };

      const data = insights[type];
      if (!data) return;

      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 max-h-[80vh] overflow-hidden">
          <div class="flex items-center justify-between p-6 border-b border-slate-200">
            <h3 class="text-lg font-bold text-slate-900">${data.title}</h3>
            <button onclick="this.closest('.fixed').remove()" class="text-slate-400 hover:text-slate-600 transition">
              <i class="fa-solid fa-times text-xl"></i>
            </button>
          </div>
          <div class="p-6 overflow-y-auto">
            ${data.content}
          </div>
          <div class="flex gap-3 p-6 border-t border-slate-200 bg-slate-50">
            <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-2 bg-slate-200 text-slate-700 font-bold rounded-lg hover:bg-slate-300 transition">Close</button>
            <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-2 bg-gradient-to-r from-sozo-600 to-orange-500 text-white font-bold rounded-lg hover:shadow-lg transition">Got it</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      
      // Close notification panel
      const panel = document.getElementById('notificationPanel');
      if (panel) panel.classList.add('hidden');
    };
  }

  else if (key === 'mypatients') {
    area.innerHTML = `
      <div class="p-4 sm:p-6 lg:p-8 max-w-full overflow-hidden">
      <div class="mb-4 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
        <div>
          <h2 class="text-2xl font-bold">My Referrals</h2>
          <p class="text-slate-500 text-sm">Add and manage patient referrals.</p>
        </div>
        <button id="patientAddBtn" class="bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-sozo-700 shadow-lg shadow-sozo-500/20"><i class="fa-solid fa-plus mr-2"></i>Add Referral</button>
      </div>
      
      <div class="card p-4 sm:p-6">
        <div class="table-scrollable">
          <table class="w-full">
            <thead>
              <tr class="bg-slate-100 border-b border-slate-200">
                <th class="px-2 sm:px-4 py-3 text-left text-xs font-bold uppercase whitespace-nowrap">Referral Name</th>
                <th class="px-2 sm:px-4 py-3 text-left text-xs font-bold uppercase whitespace-nowrap hidden md:table-cell">Email</th>
                <th class="px-2 sm:px-4 py-3 text-left text-xs font-bold uppercase whitespace-nowrap hidden sm:table-cell">Country</th>
                <th class="px-2 sm:px-4 py-3 text-left text-xs font-bold uppercase whitespace-nowrap">Status</th>
              </tr>
            </thead>
          <tbody id="patientReferralsList">
            <tr class="border-b border-slate-200 hover:bg-slate-50">
              <td class="px-2 sm:px-4 py-3 text-sm font-bold">Emma Johnson</td>
              <td class="px-2 sm:px-4 py-3 text-sm hidden md:table-cell">emma.johnson@email.com</td>
              <td class="px-2 sm:px-4 py-3 text-sm hidden sm:table-cell">UK</td>
              <td class="px-2 sm:px-4 py-3"><span class="badge" style="background-color: #22c55e; color: white;"><i class="fa-solid fa-check"></i></span></td>
            </tr>
            <tr class="border-b border-slate-200 hover:bg-slate-50">
              <td class="px-2 sm:px-4 py-3 text-sm font-bold">Sophia Garcia</td>
              <td class="px-2 sm:px-4 py-3 text-sm hidden md:table-cell">sophia.garcia@email.com</td>
              <td class="px-2 sm:px-4 py-3 text-sm hidden sm:table-cell">Spain</td>
              <td class="px-2 sm:px-4 py-3"><span class="badge" style="background-color: #22c55e; color: white;"><i class="fa-solid fa-check"></i></span></td>
            </tr>
            <tr class="border-b border-slate-200 hover:bg-slate-50">
              <td class="px-2 sm:px-4 py-3 text-sm font-bold">Ava Wilson</td>
              <td class="px-2 sm:px-4 py-3 text-sm hidden md:table-cell">ava.wilson@email.com</td>
              <td class="px-2 sm:px-4 py-3 text-sm hidden sm:table-cell">Cyprus</td>
              <td class="px-2 sm:px-4 py-3"><span class="badge" style="background-color: #ef4444; color: white;"><i class="fa-solid fa-xmark"></i></span></td>
            </tr>
            <tr class="border-b border-slate-200 hover:bg-slate-50">
              <td class="px-2 sm:px-4 py-3 text-sm font-bold">James Anderson</td>
              <td class="px-2 sm:px-4 py-3 text-sm hidden md:table-cell">james.anderson@email.com</td>
              <td class="px-2 sm:px-4 py-3 text-sm hidden sm:table-cell">Canada</td>
              <td class="px-2 sm:px-4 py-3"><span class="badge" style="background-color: #22c55e; color: white;"><i class="fa-solid fa-check"></i></span></td>
            </tr>
            <tr class="border-b border-slate-200 hover:bg-slate-50">
              <td class="px-2 sm:px-4 py-3 text-sm font-bold">Maria Rodriguez</td>
              <td class="px-2 sm:px-4 py-3 text-sm hidden md:table-cell">maria.rodriguez@email.com</td>
              <td class="px-2 sm:px-4 py-3 text-sm hidden sm:table-cell">Mexico</td>
              <td class="px-2 sm:px-4 py-3"><span class="badge" style="background-color: #ef4444; color: white;"><i class="fa-solid fa-xmark"></i></span></td>
            </tr>
            <tr class="border-b border-slate-200 hover:bg-slate-50">
              <td class="px-2 sm:px-4 py-3 text-sm font-bold">David Chen</td>
              <td class="px-2 sm:px-4 py-3 text-sm hidden md:table-cell">david.chen@email.com</td>
              <td class="px-2 sm:px-4 py-3 text-sm hidden sm:table-cell">Singapore</td>
              <td class="px-2 sm:px-4 py-3"><span class="badge" style="background-color: #22c55e; color: white;"><i class="fa-solid fa-check"></i></span></td>
            </tr>
            <tr class="border-b border-slate-200 hover:bg-slate-50">
              <td class="px-2 sm:px-4 py-3 text-sm font-bold">Sarah Williams</td>
              <td class="px-2 sm:px-4 py-3 text-sm hidden md:table-cell">sarah.williams@email.com</td>
              <td class="px-2 sm:px-4 py-3 text-sm hidden sm:table-cell">Australia</td>
              <td class="px-2 sm:px-4 py-3"><span class="badge" style="background-color: #22c55e; color: white;"><i class="fa-solid fa-check"></i></span></td>
            </tr>
            <tr class="border-b border-slate-200 hover:bg-slate-50">
              <td class="px-2 sm:px-4 py-3 text-sm font-bold">Thomas Mueller</td>
              <td class="px-2 sm:px-4 py-3 text-sm hidden md:table-cell">thomas.mueller@email.com</td>
              <td class="px-2 sm:px-4 py-3 text-sm hidden sm:table-cell">Germany</td>
              <td class="px-2 sm:px-4 py-3"><span class="badge" style="background-color: #ef4444; color: white;"><i class="fa-solid fa-xmark"></i></span></td>
            </tr>
            <tr class="border-b border-slate-200 hover:bg-slate-50">
              <td class="px-2 sm:px-4 py-3 text-sm font-bold">Isabella Rossi</td>
              <td class="px-2 sm:px-4 py-3 text-sm hidden md:table-cell">isabella.rossi@email.com</td>
              <td class="px-2 sm:px-4 py-3 text-sm hidden sm:table-cell">Italy</td>
              <td class="px-2 sm:px-4 py-3"><span class="badge" style="background-color: #22c55e; color: white;"><i class="fa-solid fa-check"></i></span></td>
            </tr>
            <tr class="border-b border-slate-200 hover:bg-slate-50">
              <td class="px-2 sm:px-4 py-3 text-sm font-bold">Lucas Silva</td>
              <td class="px-2 sm:px-4 py-3 text-sm hidden md:table-cell">lucas.silva@email.com</td>
              <td class="px-2 sm:px-4 py-3 text-sm hidden sm:table-cell">Brazil</td>
              <td class="px-2 sm:px-4 py-3"><span class="badge" style="background-color: #22c55e; color: white;"><i class="fa-solid fa-check"></i></span></td>
            </tr>
            <tr class="border-b border-slate-200 hover:bg-slate-50">
              <td class="px-2 sm:px-4 py-3 text-sm font-bold">Emily Taylor</td>
              <td class="px-2 sm:px-4 py-3 text-sm hidden md:table-cell">emily.taylor@email.com</td>
              <td class="px-2 sm:px-4 py-3 text-sm hidden sm:table-cell">New Zealand</td>
              <td class="px-2 sm:px-4 py-3"><span class="badge" style="background-color: #ef4444; color: white;"><i class="fa-solid fa-xmark"></i></span></td>
            </tr>
            <tr class="border-b border-slate-200 hover:bg-slate-50">
              <td class="px-2 sm:px-4 py-3 text-sm font-bold">Yuki Tanaka</td>
              <td class="px-2 sm:px-4 py-3 text-sm hidden md:table-cell">yuki.tanaka@email.com</td>
              <td class="px-2 sm:px-4 py-3 text-sm hidden sm:table-cell">Japan</td>
              <td class="px-2 sm:px-4 py-3"><span class="badge" style="background-color: #22c55e; color: white;"><i class="fa-solid fa-check"></i></span></td>
            </tr>
          </tbody>
        </table>
        </div>
      </div>

      <!-- Add Referral Modal -->
      <div id="addReferralModal" style="display: none;" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6">
          <h3 class="text-xl font-bold text-slate-900 mb-4">Add Patient Referral</h3>
          <form id="addReferralForm" class="space-y-4">
            <div>
              <label class="text-xs font-bold text-slate-500 uppercase">Full Name</label>
              <input type="text" id="refName" placeholder="Patient full name" class="input-royal mt-1 py-2.5" required />
            </div>
            <div>
              <label class="text-xs font-bold text-slate-500 uppercase">Email</label>
              <input type="email" id="refEmail" placeholder="patient@example.com" class="input-royal mt-1 py-2.5" required />
            </div>
            <div>
              <label class="text-xs font-bold text-slate-500 uppercase">Country</label>
              <select id="refCountry" class="input-royal mt-1 py-2.5" required>
                <option value="">Select country</option>
                <option value="Germany">Germany</option>
                <option value="UK">UK</option>
                <option value="USA">USA</option>
                <option value="France">France</option>
                <option value="Spain">Spain</option>
                <option value="Cyprus">Cyprus</option>
              </select>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <button type="submit" class="bg-sozo-600 text-white font-bold py-2.5 rounded-lg hover:bg-sozo-700">Add Referral</button>
              <button type="button" onclick="document.getElementById('addReferralModal').style.display='none'" class="border-2 border-slate-300 text-slate-700 font-bold py-2.5 rounded-lg hover:bg-slate-100">Cancel</button>
            </div>
          </form>
        </div>
      </div>
      </div>
    `;

    setTimeout(() => {
      const btn = document.getElementById('patientAddBtn');
      const form = document.getElementById('addReferralForm');
      if(btn) btn.addEventListener('click', () => {
        document.getElementById('addReferralModal').style.display = 'flex';
      });
      if(form) form.addEventListener('submit', (e) => {
        e.preventDefault();
        const name = document.getElementById('refName').value;
        const email = document.getElementById('refEmail').value;
        const country = document.getElementById('refCountry').value;
        
        // Store referral in localStorage
        let referrals = JSON.parse(localStorage.getItem('patientReferrals') || '{}');
        if(!referrals[currentUser.email]) referrals[currentUser.email] = [];
        referrals[currentUser.email].push({ name, email, country, status: 'Pending', addedAt: new Date().toLocaleDateString() });
        localStorage.setItem('patientReferrals', JSON.stringify(referrals));
        
        alert('Referral added successfully!');
        document.getElementById('addReferralModal').style.display = 'none';
        loadSection('mypatients'); // Refresh
      });
      
      // Load referrals
      const referrals = JSON.parse(localStorage.getItem('patientReferrals') || '{}');
      const myReferrals = referrals[currentUser.email] || [];
      const tbody = document.getElementById('patientReferralsList');
      if(myReferrals.length > 0) {
        // Filter to show only Approved and Rejected statuses
        const filteredReferrals = myReferrals.filter(ref => 
          ref.status.toLowerCase().includes('approved') || 
          ref.status.toLowerCase().includes('accepted') || 
          ref.status.toLowerCase().includes('confirmed') ||
          ref.status.toLowerCase().includes('rejected') || 
          ref.status.toLowerCase().includes('cancelled') || 
          ref.status.toLowerCase().includes('failed') || 
          ref.status.toLowerCase().includes('denied')
        );
        
        tbody.innerHTML = filteredReferrals.map((ref, i) => {
          let statusColor = '#22c55e'; // green for approved
          let statusIcon = 'fa-check';
          
          // Red for rejected/cancelled/failed statuses
          if (ref.status.toLowerCase().includes('rejected') || 
              ref.status.toLowerCase().includes('cancelled') || 
              ref.status.toLowerCase().includes('failed') || 
              ref.status.toLowerCase().includes('denied')) {
            statusColor = '#ef4444';
            statusIcon = 'fa-xmark';
          }
          
          return `
          <tr>
            <td><strong>${ref.name}</strong></td>
            <td>${ref.email}</td>
            <td>${ref.country}</td>
            <td><span class="badge" style="background-color: ${statusColor}; color: white;"><i class="fa-solid ${statusIcon}"></i></span></td>
            <td><button class="text-sm text-slate-600 hover:underline" onclick="removeReferral('${i}')">Remove</button></td>
          </tr>
        `;
        }).join('');
      }
    }, 50);

    window.removeReferral = function(index) {
      if(confirm('Remove this referral?')) {
        let referrals = JSON.parse(localStorage.getItem('patientReferrals') || '{}');
        referrals[currentUser.email].splice(index, 1);
        localStorage.setItem('patientReferrals', JSON.stringify(referrals));
        loadSection('mypatients');
      }
    };
  }

  else if (key === 'treatment-plan') {
    renderPatientTreatmentPlan();
  }
  
else if (key === 'appointments') {
  area.innerHTML = `
    <div class="p-8">
    <!-- APPOINTMENTS SECTION (50% WIDTH) -->
<div
>

  <!-- HEADER -->
  <div class="mb-4 flex items-center justify-between flex-wrap gap-3">
    <div>
      <h2 class="text-2xl font-bold">Appointments</h2>
      <p class="text-slate-500 text-sm">Review history and book new sessions.</p>
    </div>
    <div class="flex gap-2">
        <div class="relative">
            <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
            <input type="text" id="apptSearch" placeholder="Search appointments..." class="pl-10 pr-4 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:border-sozo-500">
        </div>
        <button
          id="apptNewBtn"
          class="bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-sozo-700 shadow-lg shadow-sozo-500/20"
        >
          Book New Appointment
        </button>
    </div>
  </div>

  <!-- FILTER CONTROLS -->
  <div class="mb-4 flex flex-wrap gap-3 items-end">
    <div>
      <label class="text-xs font-bold text-slate-500 block mb-1">Status</label>
      <select id="apptStatusFilter" class="input-royal w-40">
        <option value="">All Statuses</option>
      </select>
    </div>
    <div>
      <label class="text-xs font-bold text-slate-500 block mb-1">Examination Type</label>
      <select id="apptExamFilter" class="input-royal w-48">
        <option value="">All Types</option>
      </select>
    </div>
    <div>
      <label class="text-xs font-bold text-slate-500 block mb-1">Doctor</label>
      <select id="apptDoctorFilter" class="input-royal w-48">
        <option value="">All Doctors</option>
      </select>
    </div>
  </div>

  <!-- SORTING CONTROLS -->
  <div class="mb-4 flex gap-2 overflow-x-auto pb-2">
    <button class="apptSort sort-btn active" data-sort="date-desc">Newest First</button>
    <button class="apptSort sort-btn" data-sort="date-asc">Oldest First</button>
    <button class="apptSort sort-btn" data-sort="status">Sort by Status</button>
    <button class="apptSort sort-btn" data-sort="exam">Sort by Examination</button>
    <button class="apptSort sort-btn" data-sort="doctor">Sort by Doctor</button>
  </div>

  <!-- SCROLL WRAPPER -->
  <div
    id="apptScrollContainer"
    style="
      width:100%;
      max-height:calc(100vh - 420px);
      min-height:470px;
      overflow-x:auto;
      overflow-y:auto;
      white-space:nowrap;
      -webkit-overflow-scrolling:touch;
      border:1px solid #e2e8f0;
      border-radius:16px;
      background:white;
    "
  >

    <!-- TABLE -->
    <table
      id="apptTableMain"
      style="
        width:2200px;
        min-width:2200px;
        border-collapse:collapse;
      "
    >
      <thead>
        <tr style="background:#f1f5f9">
          ${[
            'Actions','Status','Scheduled Date',"Patient Name",'Health Prof',
            'Room','Phone','Mobile','Identity No','Birth Date',
            'Examination','Physician','Recommended By',
            'Confirmed','Pending Action','Created Date'
          ].map(h => `
            <th style="
              padding:12px 16px;
              font-size:12px;
              font-weight:600;
              color:#64748b;
              white-space:nowrap;
              border-bottom:1px solid #e2e8f0;
              text-transform:uppercase;
            ">
              ${h}
            </th>
          `).join('')}
        </tr>
      </thead>

      <tbody id="apptTable"></tbody>
    </table>
  </div>
</div>
</div>

<!-- Book New Appointment Modal -->
<div id="apptModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto flex flex-col">
    <div class="flex items-center justify-between p-6 border-b border-slate-200 sticky top-0 bg-white rounded-t-2xl">
      <h3 class="text-xl font-bold text-slate-900">Book New Appointment</h3>
      <button id="apptModalClose" class="text-slate-400 hover:text-slate-600 transition">
        <i class="fa-solid fa-times text-xl"></i>
      </button>
    </div>
    <div class="p-6 overflow-y-auto flex-1">
      <form id="apptForm" class="space-y-4">
        <div>
          <label class="text-xs font-bold text-slate-500 uppercase">Location</label>
          <select id="apptLocation" class="input-royal mt-1 py-2.5" required>
            <option value="">Select Location</option>
            <option value="Nicosia Branch">Nicosia Branch</option>
            <option value="Limassol Branch">Limassol Branch</option>
            <option value="Larnaca Branch">Larnaca Branch</option>
            <option value="Paphos Branch">Paphos Branch</option>
            <option value="Main Clinic">Main Clinic</option>
            <option value="Downtown Center">Downtown Center</option>
          </select>
        </div>
        <div>
          <label class="text-xs font-bold text-slate-500 uppercase">Examination Type</label>
          <select id="apptExamination" class="input-royal mt-1 py-2.5" required>
            <option value="">Select Examination</option>
          </select>
        </div>
        <div>
          <label class="text-xs font-bold text-slate-500 uppercase">Preferred Doctor</label>
          <select id="apptDoctor" class="input-royal mt-1 py-2.5" required>
            <option value="">Select Doctor</option>
          </select>
        </div>
        <div>
          <label class="text-xs font-bold text-slate-500 uppercase">Appointment Date</label>
          <input type="date" id="apptDate" class="input-royal mt-1 py-2.5" required />
        </div>
        <div>
          <label class="text-xs font-bold text-slate-500 uppercase">Appointment Time</label>
          <input type="time" id="apptTime" class="input-royal mt-1 py-2.5" required />
        </div>
        <div>
          <label class="text-xs font-bold text-slate-500 uppercase">Notes (Optional)</label>
          <textarea id="apptNotes" class="input-royal mt-1" rows="3" placeholder="Any additional notes..."></textarea>
        </div>
        <div class="flex items-center gap-2 p-3 bg-blue-50 rounded-lg">
          <input type="checkbox" id="apptConsent" class="w-4 h-4 cursor-pointer" required />
          <label for="apptConsent" class="text-sm text-slate-700 cursor-pointer">I agree to the appointment terms and conditions</label>
        </div>
        <div class="flex gap-3 pt-4 border-t border-slate-200 sticky bottom-0 bg-white -mx-6 -mb-6 px-6 py-4">
          <button type="submit" id="apptSubmit" class="flex-1 bg-sozo-600 text-white font-bold py-2.5 rounded-lg hover:bg-sozo-700 transition">
            <i class="fa-solid fa-check mr-2"></i>Book Appointment
          </button>
          <button type="button" id="apptCancel" class="flex-1 border-2 border-slate-300 text-slate-700 font-bold py-2.5 rounded-lg hover:bg-slate-100 transition">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Reschedule Appointment Modal -->
<div id="rescheduleModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4">
    <div class="flex items-center justify-between p-6 border-b border-slate-200">
      <h3 class="text-xl font-bold text-slate-900">Reschedule Appointment</h3>
      <button id="rescheduleModalClose" class="text-slate-400 hover:text-slate-600 transition">
        <i class="fa-solid fa-times text-xl"></i>
      </button>
    </div>
    <div class="p-6">
      <form id="rescheduleForm" class="space-y-4">
        <div>
          <label class="text-xs font-bold text-slate-500 uppercase">Current Appointment</label>
          <div id="currentApptInfo" class="mt-2 p-3 bg-slate-50 rounded-lg text-sm">
            <!-- Current appointment details will be inserted here -->
          </div>
        </div>
        <div>
          <label class="text-xs font-bold text-slate-500 uppercase">New Date</label>
          <input type="date" id="rescheduleDate" class="input-royal mt-1 py-2.5" required />
        </div>
        <div>
          <label class="text-xs font-bold text-slate-500 uppercase">New Time</label>
          <input type="time" id="rescheduleTime" class="input-royal mt-1 py-2.5" required />
        </div>
        <div>
          <label class="text-xs font-bold text-slate-500 uppercase">Reason (Optional)</label>
          <textarea id="rescheduleReason" class="input-royal mt-1" rows="3" placeholder="Enter reason for rescheduling..."></textarea>
        </div>
        <div class="flex gap-3 pt-2">
          <button type="submit" class="flex-1 bg-sozo-600 text-white font-bold py-2.5 rounded-lg hover:bg-sozo-700 transition">
            <i class="fa-solid fa-check mr-2"></i>Confirm Reschedule
          </button>
          <button type="button" id="rescheduleCancel" class="flex-1 border-2 border-slate-300 text-slate-700 font-bold py-2.5 rounded-lg hover:bg-slate-100 transition">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
  `;

  setTimeout(() => {
    // 🚨 FORCE BODY SCROLL (CRITICAL)
    document.body.style.overflowX = 'auto';

    const tbody = document.getElementById('apptTable');
    const modal = document.getElementById('apptModal');
    const btnNew = document.getElementById('apptNewBtn');
    const close = document.getElementById('apptModalClose');
    const submit = document.getElementById('apptSubmit');
    const consent = document.getElementById('apptConsent');

    const APPT_KEY = 'patientAppointments';
    let data = JSON.parse(localStorage.getItem(APPT_KEY) || '{}');
    let myAppointments = data[p.email] || [];

    if (!myAppointments.length) {
      // Generate realistic sample data
      const statuses = ['Scheduled', 'Completed', 'Cancelled', 'No Show', 'Completed', 'Scheduled'];
      const exams = ['Initial Consultation', 'MRI Scan', 'EEG Analysis', 'Follow-up', 'Cognitive Assessment', 'Lab Results Review'];
      const doctors = ['Dr. Sarah Smith', 'Dr. James Wilson', 'Dr. Emily Chen', 'Dr. Michael Brown'];
      const rooms = ['101', '102', '205', 'Lab A', '304'];
      
      myAppointments = Array.from({ length: 12 }).map((_, i) => {
        const date = new Date();
        date.setDate(date.getDate() + (Math.floor(Math.random() * 60) - 30)); // +/- 30 days
        const status = statuses[i % statuses.length];
        
        return {
          id: Date.now() + i,
          status: status,
          date: date.toISOString(),
          patientName: p.name,
          healthProf: doctors[i % doctors.length],
          room: rooms[i % rooms.length],
          phone: p.phone || '555-0101',
          mobile: p.mobile || '555-1001',
          identityNumber: p.id || `ID-20${i}`,
          birthDate: p.dob || '1990-05-15',
          examination: exams[i % exams.length],
          physician: doctors[i % doctors.length],
          recommendedBy: i % 3 === 0 ? 'Dr. House' : 'Self',
          confirmed: status === 'Scheduled' ? 'Yes' : 'N/A',
          pendingAction: status === 'Scheduled' ? 'None' : 'N/A',
          createdDate: new Date(date.getTime() - 86400000 * 5).toISOString() // Created 5 days before
        };
      });
      
      // Sort by date descending initially
      myAppointments.sort((a, b) => new Date(b.date) - new Date(a.date));
    }

    let currentSort = 'date-desc';
    let searchTerm = '';
    let statusFilter = '';
    let examFilter = '';
    let doctorFilter = '';

    function render() {
      let filtered = myAppointments.filter(a => {
        const term = searchTerm.toLowerCase();
        const matchSearch = (
          a.healthProf.toLowerCase().includes(term) ||
          a.examination.toLowerCase().includes(term) ||
          a.status.toLowerCase().includes(term) ||
          a.room.toLowerCase().includes(term)
        );
        const matchStatus = !statusFilter || a.status === statusFilter;
        const matchExam = !examFilter || a.examination === examFilter;
        const matchDoctor = !doctorFilter || a.healthProf === doctorFilter;
        
        return matchSearch && matchStatus && matchExam && matchDoctor;
      });

      // Apply Sort - Always prioritize Scheduled appointments first
      filtered.sort((a, b) => {
        // First, sort by status - Scheduled always comes first
        const aIsScheduled = a.status === 'Scheduled' ? 0 : 1;
        const bIsScheduled = b.status === 'Scheduled' ? 0 : 1;
        
        if (aIsScheduled !== bIsScheduled) {
          return aIsScheduled - bIsScheduled;
        }
        
        // Then apply the selected sort within each group
        if (currentSort === 'date-desc') return new Date(b.date) - new Date(a.date);
        if (currentSort === 'date-asc') return new Date(a.date) - new Date(b.date);
        if (currentSort === 'status') return a.status.localeCompare(b.status);
        if (currentSort === 'exam') return a.examination.localeCompare(b.examination);
        if (currentSort === 'doctor') return a.healthProf.localeCompare(b.healthProf);
        return 0;
      });

      tbody.innerHTML = filtered.map(a => `
        <tr>
          <td class="px-4 py-3">
             ${a.status === 'Scheduled' ? `<button class="reschedule-btn px-3 py-1.5 bg-sozo-600 text-white rounded-lg font-bold text-sm hover:bg-sozo-700 transition" data-id="${a.id}" title="Reschedule">
               <i class="fa-solid fa-calendar-days mr-1"></i> Reschedule
             </button>` : '<span class="text-slate-400 text-sm">-</span>'}
          </td>
          <td class="px-4 py-3"><span class="badge badge-${a.status === 'Completed' ? 'success' : a.status === 'Scheduled' ? 'info' : a.status === 'Cancelled' ? 'danger' : 'warning'}">${a.status}</span></td>
          <td class="px-4 py-3 font-mono text-sm">${new Date(a.date).toLocaleString()}</td>
          <td class="px-4 py-3">${a.patientName}</td>
          <td class="px-4 py-3 font-medium text-slate-700">${a.healthProf}</td>
          <td class="px-4 py-3">${a.room}</td>
          <td class="px-4 py-3 text-sm text-slate-500">${a.phone}</td>
          <td class="px-4 py-3 text-sm text-slate-500">${a.mobile}</td>
          <td class="px-4 py-3 text-sm font-mono">${a.identityNumber}</td>
          <td class="px-4 py-3 text-sm">${a.birthDate}</td>
          <td class="px-4 py-3 font-bold text-sozo-700">${a.examination}</td>
          <td class="px-4 py-3 text-sm">${a.physician}</td>
          <td class="px-4 py-3 text-sm">${a.recommendedBy}</td>
          <td class="px-4 py-3 text-center">${a.confirmed === 'Yes' ? '<i class="fa-solid fa-check text-sozo-600"></i>' : '-'}</td>
          <td class="px-4 py-3 text-sm">${a.pendingAction}</td>
          <td class="px-4 py-3 text-xs text-slate-400">${new Date(a.createdDate).toLocaleDateString()}</td>
        </tr>
      `).join('') || '<tr><td colspan="16" class="p-8 text-center text-slate-500">No appointments found</td></tr>';
    }

    // Event Listeners
    const searchInput = document.getElementById('apptSearch');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            searchTerm = e.target.value;
            render();
        });
    }

    // Populate filter dropdowns
    const statusFilterSelect = document.getElementById('apptStatusFilter');
    const examFilterSelect = document.getElementById('apptExamFilter');
    const doctorFilterSelect = document.getElementById('apptDoctorFilter');
    
    const uniqueStatuses = [...new Set(myAppointments.map(a => a.status))].sort();
    const uniqueExams = [...new Set(myAppointments.map(a => a.examination))].sort();
    const uniqueDoctors = [...new Set(myAppointments.map(a => a.healthProf))].sort();
    
    uniqueStatuses.forEach(status => {
      const option = document.createElement('option');
      option.value = status;
      option.textContent = status;
      statusFilterSelect.appendChild(option);
    });
    
    uniqueExams.forEach(exam => {
      const option = document.createElement('option');
      option.value = exam;
      option.textContent = exam;
      examFilterSelect.appendChild(option);
    });
    
    uniqueDoctors.forEach(doctor => {
      const option = document.createElement('option');
      option.value = doctor;
      option.textContent = doctor;
      doctorFilterSelect.appendChild(option);
    });
    
    // Add filter change listeners
    statusFilterSelect.addEventListener('change', (e) => {
      statusFilter = e.target.value;
      render();
    });
    
    examFilterSelect.addEventListener('change', (e) => {
      examFilter = e.target.value;
      render();
    });
    
    doctorFilterSelect.addEventListener('change', (e) => {
      doctorFilter = e.target.value;
      render();
    });

    document.querySelectorAll('.apptSort').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.apptSort').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentSort = this.dataset.sort;
            render();
        });
    });

    render();

    // Book New Appointment Modal Elements
    const apptModal = document.getElementById('apptModal');
    const apptModalClose = document.getElementById('apptModalClose');
    const apptForm = document.getElementById('apptForm');
    const apptCancel = document.getElementById('apptCancel');
    const apptExamination = document.getElementById('apptExamination');
    const apptDoctor = document.getElementById('apptDoctor');
    const apptDate = document.getElementById('apptDate');
    const apptTime = document.getElementById('apptTime');
    const apptLocation = document.getElementById('apptLocation');
    const apptNotes = document.getElementById('apptNotes');
    const apptConsent = document.getElementById('apptConsent');
    const apptSubmit = document.getElementById('apptSubmit');

    // Populate examination and doctor dropdowns
    const uniqueExamsForModal = [...new Set(myAppointments.map(a => a.examination))].sort();
    const uniqueDoctorsForModal = [...new Set(myAppointments.map(a => a.healthProf))].sort();
    
    uniqueExamsForModal.forEach(exam => {
      const option = document.createElement('option');
      option.value = exam;
      option.textContent = exam;
      apptExamination.appendChild(option);
    });
    
    uniqueDoctorsForModal.forEach(doctor => {
      const option = document.createElement('option');
      option.value = doctor;
      option.textContent = doctor;
      apptDoctor.appendChild(option);
    });

    // Set minimum date to today for appointment booking
    const todayDate = new Date().toISOString().split('T')[0];
    apptDate.min = todayDate;

    // Open Book New Appointment modal
    if (btnNew) {
      btnNew.addEventListener('click', () => {
        // Reset form
        apptForm.reset();
        apptConsent.checked = false;
        // Clear previous values
        apptExamination.value = '';
        apptDoctor.value = '';
        apptDate.value = '';
        apptTime.value = '';
        apptNotes.value = '';
        // Show modal
        apptModal.classList.remove('hidden');
      });
    }

    // Close Book New Appointment modal handlers
    if (apptModalClose) {
      apptModalClose.addEventListener('click', () => {
        apptModal.classList.add('hidden');
      });
    }
    
    if (apptCancel) {
      apptCancel.addEventListener('click', () => {
        apptModal.classList.add('hidden');
      });
    }

    // Handle Book New Appointment form submission
    apptForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      if (!apptConsent.checked) {
        alert('Please agree to the appointment terms and conditions');
        return;
      }

      // Create new appointment
      const newAppointment = {
        id: Date.now(),
        status: 'Scheduled',
        date: new Date(apptDate.value + 'T' + apptTime.value).toISOString(),
        patientName: p.name,
        healthProf: apptDoctor.value,
        room: ['101', '102', '205', 'Lab A', '304'][Math.floor(Math.random() * 5)],
        phone: p.phone || '555-0101',
        mobile: p.mobile || '555-1001',
        identityNumber: p.id || 'ID-0000',
        birthDate: p.dob || '1990-05-15',
        examination: apptExamination.value,
        physician: apptDoctor.value,
        location: apptLocation.value,
        recommendedBy: 'Self',
        confirmed: 'Yes',
        pendingAction: 'None',
        createdDate: new Date().toISOString(),
        notes: apptNotes.value
      };

      // Add to appointments
      myAppointments.push(newAppointment);
      
      // Sort by date descending
      myAppointments.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      // Save to localStorage
      data[p.email] = myAppointments;
      localStorage.setItem(APPT_KEY, JSON.stringify(data));
      
      // Close modal and re-render
      apptModal.classList.add('hidden');
      render();
      
      // Show success message
      const successMsg = document.createElement('div');
      successMsg.className = 'fixed top-4 right-4 bg-sozo-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2';
      successMsg.innerHTML = '<i class="fa-solid fa-check-circle"></i><span>Appointment booked successfully!</span>';
      document.body.appendChild(successMsg);
      
      setTimeout(() => {
        successMsg.style.transition = 'opacity 0.3s';
        successMsg.style.opacity = '0';
        setTimeout(() => successMsg.remove(), 300);
      }, 3000);
    });

    // Close modal on outside click
    apptModal.addEventListener('click', function(e) {
      if (e.target === apptModal) {
        apptModal.classList.add('hidden');
      }
    });

    // Reschedule Modal Elements
    const rescheduleModal = document.getElementById('rescheduleModal');
    const rescheduleModalClose = document.getElementById('rescheduleModalClose');
    const rescheduleCancel = document.getElementById('rescheduleCancel');
    const rescheduleForm = document.getElementById('rescheduleForm');
    const rescheduleDate = document.getElementById('rescheduleDate');
    const rescheduleTime = document.getElementById('rescheduleTime');
    const rescheduleReason = document.getElementById('rescheduleReason');
    const currentApptInfo = document.getElementById('currentApptInfo');
    let currentRescheduleId = null;

    // Set minimum date to today
    const today = new Date().toISOString().split('T')[0];
    rescheduleDate.min = today;

    // Reschedule button click handler (event delegation)
    tbody.addEventListener('click', function(e) {
      const rescheduleBtn = e.target.closest('.reschedule-btn');
      if (rescheduleBtn) {
        const appointmentId = parseInt(rescheduleBtn.dataset.id);
        const appointment = myAppointments.find(a => a.id === appointmentId);
        
        if (appointment) {
          currentRescheduleId = appointmentId;
          
          // Display current appointment info
          const apptDate = new Date(appointment.date);
          currentApptInfo.innerHTML = `
            <div class="space-y-1">
              <p><span class="text-slate-500">Examination:</span> <span class="font-bold">${appointment.examination}</span></p>
              <p><span class="text-slate-500">Doctor:</span> <span class="font-bold">${appointment.healthProf}</span></p>
              <p><span class="text-slate-500">Current Date:</span> <span class="font-bold">${apptDate.toLocaleDateString()}</span></p>
              <p><span class="text-slate-500">Current Time:</span> <span class="font-bold">${apptDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span></p>
            </div>
          `;
          
          // Pre-fill with current date and time
          rescheduleDate.value = apptDate.toISOString().split('T')[0];
          rescheduleTime.value = apptDate.toTimeString().slice(0, 5);
          rescheduleReason.value = '';
          
          // Show modal
          rescheduleModal.classList.remove('hidden');
        }
      }
    });

    // Close modal handlers
    rescheduleModalClose.addEventListener('click', () => {
      rescheduleModal.classList.add('hidden');
      currentRescheduleId = null;
    });
    
    rescheduleCancel.addEventListener('click', () => {
      rescheduleModal.classList.add('hidden');
      currentRescheduleId = null;
    });

    // Handle reschedule form submission
    rescheduleForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      if (currentRescheduleId !== null) {
        const appointment = myAppointments.find(a => a.id === currentRescheduleId);
        
        if (appointment) {
          // Create new date from form inputs
          const newDate = new Date(rescheduleDate.value + 'T' + rescheduleTime.value);
          
          // Update appointment
          appointment.date = newDate.toISOString();
          appointment.status = 'Scheduled';
          
          // Save to localStorage
          data[p.email] = myAppointments;
          localStorage.setItem(APPT_KEY, JSON.stringify(data));
          
          // Close modal and re-render
          rescheduleModal.classList.add('hidden');
          currentRescheduleId = null;
          render();
          
          // Show success message
          const successMsg = document.createElement('div');
          successMsg.className = 'fixed top-4 right-4 bg-sozo-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2';
          successMsg.innerHTML = '<i class="fa-solid fa-check-circle"></i><span>Appointment rescheduled successfully!</span>';
          document.body.appendChild(successMsg);
          
          setTimeout(() => {
            successMsg.style.transition = 'opacity 0.3s';
            successMsg.style.opacity = '0';
            setTimeout(() => successMsg.remove(), 300);
          }, 3000);
        }
      }
    });

    // Close modal on outside click
    rescheduleModal.addEventListener('click', function(e) {
      if (e.target === rescheduleModal) {
        rescheduleModal.classList.add('hidden');
        currentRescheduleId = null;
      }
    });
  }, 50);
}

else if (key === 'profile') {
  const p = getActivePatient();
  area.innerHTML = `
    <div class="max-w-5xl mx-auto">
      <div class="card p-8 mb-6 flex items-start gap-6 bg-gradient-to-r from-slate-50 to-sozo-50">
        <div class="w-24 h-24 rounded-full border-4 border-white shadow-md bg-sozo-600 flex items-center justify-center"><i class="fa-solid fa-user text-white text-4xl"></i></div>
        <div class="flex-1">
          <h2 class="text-2xl font-bold text-slate-900">${p.name}</h2>
          <p class="text-sm text-slate-500 font-mono">ID: ${p.id}</p>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-4">
            <div><span class="text-xs text-slate-500 uppercase">Country</span><div class="font-bold">Germany</div></div>
            <div><span class="text-xs text-slate-500 uppercase">Age</span><div class="font-bold">34</div></div>
            <div><span class="text-xs text-slate-500 uppercase">Plan</span><div class="text-sozo-600 font-bold">Premium</div></div>
            <div><span class="text-xs text-slate-500 uppercase">Status</span><div class="text-sozo-600 font-bold">Active</div></div>
          </div>
        </div>
      </div>

      <!-- Profile Tabs -->
      <div class="card p-0 overflow-hidden">
        <div class="flex border-b border-slate-200 overflow-x-auto bg-slate-50">
          <button class="profile-tab flex-1 px-4 py-3 font-bold text-slate-600 hover:bg-slate-100 border-b-2 border-transparent active" data-tab="overview">
            <i class="fa-solid fa-user mr-2"></i> Overview
          </button>
          <button class="profile-tab flex-1 px-4 py-3 font-bold text-slate-600 hover:bg-slate-100 border-b-2 border-transparent" data-tab="purchases">
            <i class="fa-solid fa-shopping-bag mr-2"></i> Purchases
          </button>
          <button class="profile-tab flex-1 px-4 py-3 font-bold text-slate-600 hover:bg-slate-100 border-b-2 border-transparent" data-tab="payments">
            <i class="fa-solid fa-credit-card mr-2"></i> Payments
          </button>

          <button class="profile-tab flex-1 px-4 py-3 font-bold text-slate-600 hover:bg-slate-100 border-b-2 border-transparent" data-tab="notifications">
            <i class="fa-solid fa-bell mr-2"></i> Notifications
          </button>
          <button class="profile-tab flex-1 px-4 py-3 font-bold text-slate-600 hover:bg-slate-100 border-b-2 border-transparent" data-tab="settings">
            <i class="fa-solid fa-gear mr-2"></i> Settings
          </button>
        </div>

        <!-- Tab Content -->
        <div class="p-6">
          <!-- Overview -->
          <div id="tab-overview" class="profile-content">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <h3 class="font-bold text-lg mb-3">Personal Information</h3>
                  <div class="space-y-3">
                    <div>
                      <label class="text-xs font-bold text-slate-500 uppercase">Full Name</label>
                      <input type="text" class="input-royal" value="${p.name}" id="profileName" />
                    </div>
                    <div>
                      <label class="text-xs font-bold text-slate-500 uppercase">Email</label>
                      <input type="email" class="input-royal" value="alex.johnson@email.com" id="profileEmail" />
                    </div>
                    <div>
                      <label class="text-xs font-bold text-slate-500 uppercase">Phone</label>
                      <input type="tel" class="input-royal" value="+49 30 1234 5678" id="profilePhone" />
                    </div>
                    <div>
                      <label class="text-xs font-bold text-slate-500 uppercase">Date of Birth</label>
                      <input type="date" class="input-royal" value="1990-03-15" id="profileDOB" />
                    </div>
                    <div>
                      <label class="text-xs font-bold text-slate-500 uppercase">Address</label>
                      <input type="text" class="input-royal" value="Berlin, Germany" id="profileAddress" />
                    </div>
                    <div>
                      <label class="text-xs font-bold text-slate-500 uppercase">Country</label>
                      <input type="text" class="input-royal" value="Germany" id="profileCountry" />
                    </div>
                    <div>
                      <label class="text-xs font-bold text-slate-500 uppercase">Referred By</label>
                      <input type="text" class="input-royal" placeholder="Doctor/Hospital name" id="profileReferredBy" />
                    </div>
                    <div>
                      <label class="text-xs font-bold text-slate-500 uppercase">Recommended By</label>
                      <input type="text" class="input-royal" placeholder="Person/Organization" id="profileRecommendedBy" />
                    </div>
                  </div>
                  <div class="flex gap-3 mt-4">
                    <button id="saveProfileBtn" class="flex-1 bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-sozo-700">Save Changes</button>
                    <button id="cancelProfileBtn" class="flex-1 bg-slate-300 text-slate-700 px-4 py-2 rounded-lg font-bold text-sm hover:bg-slate-400">Cancel</button>
                  </div>
                </div>
                <div>
                  <h3 class="font-bold text-lg mb-3">Medical Information</h3>
                  <div class="space-y-3">
                    <div>
                      <label class="text-xs font-bold text-slate-500 uppercase">Weight (Kg)</label>
                      <input type="number" class="input-royal" placeholder="e.g., 72" id="profileHR" />
                    </div>
                    <div>
                      <label class="text-xs font-bold text-slate-500 uppercase">Height</label>
                      <div class="grid grid-cols-2 gap-2">
                        <input type="number" class="input-royal" placeholder="Feet (e.g., 5)" id="profileHeightFeet" min="0" max="8" />
                        <input type="number" class="input-royal" placeholder="Inches (e.g., 10)" id="profileHeightInches" min="0" max="11" />
                      </div>
                    </div>
                  </div>
                  <h3 class="font-bold text-lg mb-3 mt-6">Primary Care Team</h3>
                  <div class="space-y-3">
                    <div class="border border-slate-200 p-3 rounded-lg">
                      <p class="font-bold text-slate-800">Dr. James Wilson</p>
                      <p class="text-xs text-slate-500">Neurologist • Since 2024-01-15</p>
                      <p class="text-xs text-sozo-600 font-bold mt-1">Primary</p>
                    </div>
                  </div>
                  <button id="addProviderBtn" class="mt-4 text-sozo-600 font-bold text-sm hover:underline"><i class="fa-solid fa-plus"></i> Add Provider</button>
                </div>
              </div>
            </div>

            <!-- Medical History -->
            <!-- Settings -->
            <div id="tab-settings" class="profile-content hidden">
              <h3 class="font-bold text-lg mb-4">Preferences & Settings</h3>
              <div class="space-y-4">
                <div class="flex items-center justify-between p-3 border border-slate-200 rounded-lg">
                  <div>
                    <p class="font-bold text-slate-800">Email Reminders</p>
                    <p class="text-xs text-slate-500">Get appointment and health notifications</p>
                  </div>
                  <input type="checkbox" class="w-5 h-5 accent-sozo-600" checked />
                </div>
                <div class="flex items-center justify-between p-3 border border-slate-200 rounded-lg">
                  <div>
                    <p class="font-bold text-slate-800">Weekly Report</p>
                    <p class="text-xs text-slate-500">Receive health summaries every Monday</p>
                  </div>
                  <input type="checkbox" class="w-5 h-5 accent-sozo-600" checked />
                </div>
                <div class="flex items-center justify-between p-3 border border-slate-200 rounded-lg">
                  <div>
                    <p class="font-bold text-slate-800">Share Data with Provider</p>
                    <p class="text-xs text-slate-500">Allow care team to access your metrics</p>
                  </div>
                  <input type="checkbox" class="w-5 h-5 accent-sozo-600" checked />
                </div>
                <div class="flex items-center justify-between p-3 border border-slate-200 rounded-lg">
                  <div>
                    <p class="font-bold text-slate-800">Dark Mode</p>
                    <p class="text-xs text-slate-500">Enable dark theme (beta)</p>
                  </div>
                  <input type="checkbox" class="w-5 h-5 accent-sozo-600" />
                </div>
                <button class="w-full bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold mt-4 hover:bg-sozo-700">Save Settings</button>
              </div>
            </div>

            <!-- Notifications -->
            <div id="tab-notifications" class="profile-content hidden">
              <h3 class="font-bold text-lg mb-4">Notification History</h3>
              <div class="space-y-3">
                <div class="flex gap-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                  <i class="fa-solid fa-bell text-blue-600 mt-1 flex-shrink-0"></i>
                  <div>
                    <p class="font-bold text-blue-900">Appointment Reminder</p>
                    <p class="text-sm text-blue-800">Your brain mapping session is tomorrow at 10:00 AM</p>
                    <p class="text-xs text-blue-600">2 hours ago</p>
                  </div>
                </div>
                <div class="flex gap-3 p-3 bg-orange-50 border border-orange-200 rounded-lg">
                  <i class="fa-solid fa-check-circle text-sozo-600 mt-1 flex-shrink-0"></i>
                  <div>
                    <p class="font-bold text-slate-900">Health Goal Reached</p>
                    <p class="text-sm text-slate-800">You've achieved your weekly step goal! 🎉</p>
                    <p class="text-xs text-sozo-600">1 day ago</p>
                  </div>
                </div>
                <div class="flex gap-3 p-3 bg-orange-50 border border-orange-200 rounded-lg">
                  <i class="fa-solid fa-exclamation-circle text-orange-600 mt-1 flex-shrink-0"></i>
                  <div>
                    <p class="font-bold text-orange-900">Device Battery Low</p>
                    <p class="text-sm text-orange-800">Sozo Ring battery at 15%. Please charge within 24 hours</p>
                    <p class="text-xs text-orange-600">3 days ago</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Payments -->
            <div id="tab-payments" class="profile-content hidden">
              <h3 class="font-bold text-lg mb-4">Payment & Billing</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="card p-4 border-l-4 border-l-sozo-600">
                  <p class="text-xs text-slate-500 uppercase mb-1">Current Plan</p>
                  <p class="text-2xl font-bold text-slate-800">Sozo Premium</p>
                  <p class="text-sm text-slate-600 mt-2">€2.00/month • Auto-renews Dec 26, 2025</p>
                  <button class="text-sozo-600 font-bold text-sm hover:underline mt-2">Manage Plan</button>
                </div>
                <div class="card p-4 border-l-4 border-l-sozo-600">
                  <p class="text-xs text-slate-500 uppercase mb-1">Balance</p>
                  <p class="text-2xl font-bold text-sozo-600">€0.00</p>
                  <p class="text-sm text-slate-600 mt-2">Account in good standing</p>
                </div>
              </div>
              <div class="card p-0 overflow-hidden">
                <table class="w-full">
                  <thead><tr class="bg-slate-50 border-b"><th class="p-3 text-left text-xs font-bold uppercase">Date</th><th class="p-3 text-left text-xs font-bold uppercase">Description</th><th class="p-3 text-left text-xs font-bold uppercase">Amount</th><th class="p-3 text-left text-xs font-bold uppercase">Status</th></tr></thead>
                  <tbody>
                    <tr class="border-b hover:bg-slate-50"><td class="p-3">Dec 26, 2024</td><td class="p-3">Monthly Subscription</td><td class="p-3 font-mono font-bold">€2.00</td><td class="p-3"><span class="badge badge-success">Paid</span></td></tr>
                    <tr class="border-b hover:bg-slate-50"><td class="p-3">Nov 26, 2024</td><td class="p-3">Monthly Subscription</td><td class="p-3 font-mono font-bold">€2.00</td><td class="p-3"><span class="badge badge-success">Paid</span></td></tr>
                    <tr class="hover:bg-slate-50"><td class="p-3">Oct 26, 2024</td><td class="p-3">Monthly Subscription</td><td class="p-3 font-mono font-bold">€2.00</td><td class="p-3"><span class="badge badge-success">Paid</span></td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Purchase History -->
            <div id="tab-purchases" class="profile-content hidden">
              <h3 class="font-bold text-lg mb-4">Purchase History</h3>
              <div class="space-y-3">
                <div class="card p-4 flex items-center gap-4">
                  <div class="w-16 h-16 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600">
                    <i class="fa-solid fa-stopwatch text-2xl"></i>
                  </div>
                  <div class="flex-1">
                    <p class="font-bold text-slate-800">Sozo Watch Pro</p>
                    <p class="text-sm text-slate-600">Advanced HRV & Sleep Tracking</p>
                    <p class="text-xs text-slate-500">Purchased: Sep 15, 2024</p>
                  </div>
                  <div class="text-right">
                    <p class="font-bold text-sozo-600">€399.00</p>
                    <p class="text-xs text-sozo-600">✓ Delivered</p>
                  </div>
                </div>
                <div class="card p-4 flex items-center gap-4">
                  <div class="w-16 h-16 bg-blue-100 rounded-lg flex items-center justify-center text-brand-blue">
                    <i class="fa-solid fa-ring text-2xl"></i>
                  </div>
                  <div class="flex-1">
                    <p class="font-bold text-slate-800">Sozo Ring</p>
                    <p class="text-sm text-slate-600">Discreet Biometric Monitor</p>
                    <p class="text-xs text-slate-500">Purchased: Aug 20, 2024</p>
                  </div>
                  <div class="text-right">
                    <p class="font-bold text-sozo-600">€299.00</p>
                    <p class="text-xs text-sozo-600">✓ Delivered</p>
                  </div>
                </div>
                <div class="card p-4 flex items-center gap-4">
                  <div class="w-16 h-16 bg-orange-100 rounded-lg flex items-center justify-center text-sozo-600">
                    <i class="fa-solid fa-headset text-2xl"></i>
                  </div>
                  <div class="flex-1">
                    <p class="font-bold text-slate-800">NeuroScan Headset</p>
                    <p class="text-sm text-slate-600">Portable EEG for Home Use</p>
                    <p class="text-xs text-slate-500">Purchased: Jul 10, 2024</p>
                  </div>
                  <div class="text-right">
                    <p class="font-bold text-sozo-600">€1,200.00</p>
                    <p class="text-xs text-sozo-600">✓ Delivered</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- My Devices -->
            <div id="tab-devices" class="profile-content hidden">
          <h3 class="font-bold text-lg mb-4">My Connected Devices</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="card p-4 border-2 border-sozo-600 bg-orange-50">
              <div class="flex items-start justify-between mb-3">
                <div>
                  <p class="font-bold text-slate-900">Sozo Watch Pro</p>
                  <p class="text-xs text-slate-600">Serial: SWP-2024-001</p>
                </div>
                <span class="badge badge-success text-xs">Connected</span>
              </div>
              <p class="text-sm text-slate-700 mb-2">Advanced HRV & Sleep Tracking</p>
              <div class="flex gap-2">
                <button class="text-sm px-3 py-1 rounded bg-orange-200 text-orange-900 hover:bg-orange-300 font-bold">Settings</button>
                <button class="text-sm px-3 py-1 rounded bg-slate-100 text-slate-700 hover:bg-slate-200 font-bold">Unpair</button>
              </div>
            </div>

            <div class="card p-4 border-2 border-brand-blue bg-blue-50">
              <div class="flex items-start justify-between mb-3">
                <div>
                  <p class="font-bold text-slate-900">Sozo Ring</p>
                  <p class="text-xs text-slate-600">Serial: SR-2024-042</p>
                </div>
                <span class="badge badge-success text-xs">Connected</span>
              </div>
              <p class="text-sm text-slate-700 mb-2">Discreet Biometric Monitor</p>
              <div class="flex gap-2">
                <button class="text-sm px-3 py-1 rounded bg-orange-200 text-orange-900 hover:bg-orange-300 font-bold">Settings</button>
                <button class="text-sm px-3 py-1 rounded bg-slate-100 text-slate-700 hover:bg-slate-200 font-bold">Unpair</button>
              </div>
            </div>

            <div class="card p-4 border-2 border-slate-500 bg-slate-50">
              <div class="flex items-start justify-between mb-3">
                <div>
                  <p class="font-bold text-slate-900">NeuroScan Headset</p>
                  <p class="text-xs text-slate-600">Serial: NSH-2024-015</p>
                </div>
                <span class="badge badge-success text-xs">Connected</span>
              </div>
              <p class="text-sm text-slate-700 mb-2">Portable EEG for Home Use</p>
              <div class="flex gap-2">
                <button class="text-sm px-3 py-1 rounded bg-orange-200 text-orange-900 hover:bg-orange-300 font-bold">Settings</button>
                <button class="text-sm px-3 py-1 rounded bg-slate-100 text-slate-700 hover:bg-slate-200 font-bold">Unpair</button>
              </div>
            </div>

            <div class="card p-4 border-2 border-slate-300 bg-slate-50">
              <div class="flex items-start justify-between mb-3">
                <div>
                  <p class="font-bold text-slate-900">Add New Device</p>
                  <p class="text-xs text-slate-600">Connect additional devices</p>
                </div>
              </div>
              <p class="text-sm text-slate-700 mb-2">Expand your device ecosystem</p>
              <button class="text-sm px-3 py-1 rounded bg-sozo-500 text-white hover:bg-sozo-600 font-bold"><i class="fa-solid fa-plus mr-1"></i>Add Device</button>
            </div>
          </div>
          <div class="card p-4 bg-orange-50 border border-orange-200">
            <p class="text-sm text-orange-900"><strong>Tip:</strong> Keep your devices updated for the best experience. Check for firmware updates regularly in device settings.</p>
          </div>
        </div>
      </div>
    `;
    
    // Attach profile tab event listeners
    setTimeout(() => {
      document.querySelectorAll('.profile-tab').forEach(tab => {
        tab.addEventListener('click', function() {
          const tabName = this.dataset.tab;
          document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.profile-tab').forEach(t => t.style.borderBottomColor = 'transparent');
          this.classList.add('active');
          this.style.borderBottomColor = '#ea580c';
          
          document.querySelectorAll('.profile-content').forEach(c => c.classList.add('hidden'));
          document.getElementById('tab-' + tabName).classList.remove('hidden');
        });
      });
      
      // Save Profile button
      document.getElementById('saveProfileBtn')?.addEventListener('click', () => {
        const name = document.getElementById('profileName').value;
        const email = document.getElementById('profileEmail').value;
        const phone = document.getElementById('profilePhone').value;
        alert(`Profile Updated!\n\nName: ${name}\nEmail: ${email}\nPhone: ${phone}`);
      });
      
      // Cancel Profile button
      document.getElementById('cancelProfileBtn')?.addEventListener('click', () => {
        if(confirm('Discard all changes?')) {
          loadSection('profile');
        }
      });
      
      // Add Provider button
      document.getElementById('addProviderBtn')?.addEventListener('click', () => {
        alert('Add Provider functionality - opens provider selection modal');
      });
    }, 50);
  }

  else if (key === 'wellness') {
    area.innerHTML = `
      <div class="mb-6"><h2 class="text-2xl font-bold">Wellness Journey</h2><p class="text-slate-500">Your personalized treatment pathway</p></div>
      <div class="card p-8 bg-gradient-to-r from-sozo-50 to-blue-50">
        <div class="flex flex-col space-y-6">
          <!-- Step 1: Sozo Connect -->
          <div class="flex items-start gap-4">
            <div class="w-12 h-12 rounded-full bg-sozo-600 text-white flex items-center justify-center font-bold flex-shrink-0">1</div>
            <div class="flex-1">
              <h3 class="font-bold text-lg text-slate-800">Sozo Connect</h3>
              <p class="text-sm text-slate-600 mb-2">Begin your Sozo experience with device setup and initial assessment</p>
              <button class="text-sozo-600 font-bold text-sm hover:underline"><i class="fa-solid fa-arrow-right"></i> Get Started</button>
            </div>
            <div class="text-sozo-600 text-2xl"><i class="fa-solid fa-check-circle"></i></div>
          </div>
          <div class="h-12 border-l-2 border-sozo-300 ml-6"></div>

          <!-- Step 2: Appointment -->
          <div class="flex items-start gap-4">
            <div class="w-12 h-12 rounded-full bg-sozo-600 text-white flex items-center justify-center font-bold flex-shrink-0">2</div>
            <div class="flex-1">
              <h3 class="font-bold text-lg text-slate-800">Schedule Appointment</h3>
              <p class="text-sm text-slate-600 mb-2">Meet with Dr. Wilson for an initial consultation and assessment planning</p>
              <button class="text-sozo-600 font-bold text-sm hover:underline"><i class="fa-solid fa-calendar-plus"></i> Book Now</button>
            </div>
            <div class="text-slate-400 text-2xl"><i class="fa-solid fa-circle"></i></div>
          </div>
          <div class="h-12 border-l-2 border-slate-300 ml-6"></div>

          <!-- Step 3: FNON Assessment -->
          <div class="flex items-start gap-4">
            <div class="w-12 h-12 rounded-full bg-slate-400 text-white flex items-center justify-center font-bold flex-shrink-0">3</div>
            <div class="flex-1">
              <h3 class="font-bold text-lg text-slate-800">FNON Assessment</h3>
              <p class="text-sm text-slate-600 mb-2">Functional Network evaluation to assess cognitive and neurological networks</p>
              <button class="text-slate-600 font-bold text-sm opacity-50 cursor-not-allowed"><i class="fa-solid fa-lock"></i> Pending Appointment</button>
            </div>
            <div class="text-slate-300 text-2xl"><i class="fa-solid fa-circle"></i></div>
          </div>
          <div class="h-12 border-l-2 border-slate-300 ml-6"></div>

          <!-- Step 4: Brain Assessment -->
          <div class="flex items-start gap-4">
            <div class="w-12 h-12 rounded-full bg-slate-400 text-white flex items-center justify-center font-bold flex-shrink-0">4</div>
            <div class="flex-1">
              <h3 class="font-bold text-lg text-slate-800">Brain Mapping</h3>
              <p class="text-sm text-slate-600 mb-2">Quantitative EEG analysis to visualize your brain's unique signature</p>
              <button class="text-slate-600 font-bold text-sm opacity-50 cursor-not-allowed"><i class="fa-solid fa-lock"></i> Pending Assessment</button>
            </div>
            <div class="text-slate-300 text-2xl"><i class="fa-solid fa-circle"></i></div>
          </div>
          <div class="h-12 border-l-2 border-slate-300 ml-6"></div>

          <!-- Step 5: PRS System -->
          <div class="flex items-start gap-4">
            <div class="w-12 h-12 rounded-full bg-slate-400 text-white flex items-center justify-center font-bold flex-shrink-0">5</div>
            <div class="flex-1">
              <h3 class="font-bold text-lg text-slate-800">PRS System Integration</h3>
              <p class="text-sm text-slate-600 mb-2">Personalized treatment recommendations based on your complete assessment</p>
              <button class="text-slate-600 font-bold text-sm opacity-50 cursor-not-allowed"><i class="fa-solid fa-lock"></i> Pending Brain Map</button>
            </div>
            <div class="text-slate-300 text-2xl"><i class="fa-solid fa-circle"></i></div>
          </div>
        </div>
      </div>

      <div class="mt-6 card p-4 bg-blue-50 border-l-4 border-l-blue-600">
        <p class="text-sm text-blue-900"><strong>💡 Tip:</strong> Each step unlocks after the previous one is completed. Your care team will guide you through each milestone.</p>
      </div>
      </div>
    `;
  }
  else if (key === 'fnon') {
    area.innerHTML = `
      <div class="p-8">
      
      ${getAssessmentNavigation('fnon')}
      
      <div class="mb-6">
        <h2 class="text-2xl font-bold text-slate-800">FNON Assessment</h2>
        <p class="text-slate-500">Functional Network of Neurons - Assessment Overview</p>
      </div>

      <!-- FNON Assessment Read-Only Display -->
      <div class="card p-6 mb-8 bg-gradient-to-br from-blue-50 to-blue-50 border-2 border-blue-200">
        <div class="flex items-center justify-between mb-6 pb-4 border-b-2 border-blue-300">
          <div>
            <h3 class="text-2xl font-bold text-blue-900">Assessment Overview</h3>
            <p class="text-sm text-blue-600">Functional Network Assessment - Read Only</p>
          </div>
          <i class="fa-solid fa-brain text-4xl text-blue-500 opacity-70"></i>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <div class="bg-white rounded-lg p-4 border-l-4 border-blue-500 shadow-sm">
            <p class="text-xs font-bold text-slate-600 uppercase tracking-wide mb-2">Assessment Status</p>
            <p class="text-2xl font-bold text-slate-700">Assessment Ready</p>
            <p class="text-xs text-slate-500 mt-2">Review the questions below to understand this assessment</p>
          </div>
          <div class="bg-white rounded-lg p-4 border-l-4 border-brand-blue shadow-sm">
            <p class="text-xs font-bold text-slate-600 uppercase tracking-wide mb-2">Assessment Type</p>
            <p class="text-lg font-bold text-brand-blue">Neural Network Evaluation</p>
            <p class="text-xs text-slate-500 mt-2">7 functional networks assessment</p>
          </div>
        </div>


      <!-- Section A: Clinical Checklist - Read Only -->
      <div class="card p-0 mb-8 overflow-hidden">
        <div class="bg-slate-800 text-white p-4 font-bold flex justify-between">
          <span>Section A: Clinical Checklist</span>
          <span class="text-xs font-normal opacity-70">0=Normal, 1=Mild, 2=Deficit</span>
        </div>
        <div class="p-6 space-y-6">
          ${(() => {
            let totalScore = 0;
            const content = sampleData.fnon.sectionA.map((net, i) => {
              const networkTests = net.tests.map((t, ti) => {
                const randomScore = Math.floor(Math.random() * 3); // Generate random score 0, 1, or 2
                totalScore += randomScore;
                
                // Create highlighted badges
                const badge0 = randomScore === 0 ? 
                  '<span class="badge badge-info text-xs font-bold" style="background-color: #0ea5e9; color: white; box-shadow: 0 0 8px rgba(14, 165, 233, 0.6);">0 ✓</span>' : 
                  '<span class="badge badge-info text-xs opacity-40">0</span>';
                const badge1 = randomScore === 1 ? 
                  '<span class="badge badge-warning text-xs font-bold" style="background-color: #f59e0b; color: white; box-shadow: 0 0 8px rgba(245, 158, 11, 0.6);">1 ✓</span>' : 
                  '<span class="badge badge-warning text-xs opacity-40">1</span>';
                const badge2 = randomScore === 2 ? 
                  '<span class="badge badge-danger text-xs font-bold" style="background-color: #ef4444; color: white; box-shadow: 0 0 8px rgba(239, 68, 68, 0.6);">2 ✓</span>' : 
                  '<span class="badge badge-danger text-xs opacity-40">2</span>';
                
                return `
                  <div class="flex justify-between items-center text-sm bg-slate-50 p-3 rounded border-l-4 border-l-blue-300">
                    <span class="font-medium text-slate-700">${t}</span>
                    <div class="flex items-center gap-2">
                      <span class="text-xs font-semibold text-slate-600">Score:</span>
                      ${badge0}
                      ${badge1}
                      ${badge2}
                    </div>
                  </div>
                `;
              }).join('');
              
              return `
                <div class="border-b border-slate-100 pb-6 last:border-0">
                  <div class="flex justify-between items-start mb-3">
                    <h3 class="font-bold text-lg text-sozo-700">${net.net}</h3>
                  </div>
                  <p class="text-xs text-slate-500 italic mb-3"><i class="fa-solid fa-triangle-exclamation"></i> ${net.signs}</p>
                  <div class="grid grid-cols-1 gap-2">
                    ${networkTests}
                  </div>
                </div>
              `;
            }).join('');
            
            // Calculate assessment interpretation
            const maxPossibleScore = sampleData.fnon.sectionA.reduce((sum, net) => sum + net.tests.length * 2, 0);
            const scorePercentage = (totalScore / maxPossibleScore) * 100;
            let interpretation = '';
            let interpretationColor = '';
            
            if (scorePercentage <= 20) {
              interpretation = 'Excellent - Minimal deficits detected';
              interpretationColor = 'text-orange-700 bg-orange-50 border-orange-300';
            } else if (scorePercentage <= 40) {
              interpretation = 'Good - Mild concerns in some areas';
              interpretationColor = 'text-brand-blue bg-blue-50 border-blue-300';
            } else if (scorePercentage <= 60) {
              interpretation = 'Moderate - Several areas need attention';
              interpretationColor = 'text-slate-700 bg-slate-50 border-slate-300';
            } else {
              interpretation = 'Significant - Multiple areas require intervention';
              interpretationColor = 'text-slate-700 bg-slate-50 border-slate-300';
            }
            
            return content + `
              <div class="mt-6 p-6 bg-gradient-to-r from-slate-50 to-blue-50 rounded-lg border-2 border-slate-300">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="text-xl font-bold text-slate-800">
                    <i class="fa-solid fa-chart-line mr-2 text-sozo-600"></i>
                    Assessment Summary
                  </h3>
                  <div class="text-right">
                    <p class="text-xs text-slate-500 uppercase font-semibold">Assessed by</p>
                    <p class="text-sm font-bold text-slate-800">Dr. James Wilson</p>
                  </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div class="bg-white rounded-lg p-4 border-l-4 border-blue-500 shadow-sm">
                    <p class="text-xs font-bold text-slate-500 uppercase mb-1">Total Score</p>
                    <p class="text-4xl font-black text-slate-900">${totalScore}</p>
                    <p class="text-xs text-slate-500 mt-1">out of ${maxPossibleScore} points</p>
                  </div>
                  
                  <div class="bg-white rounded-lg p-4 border-l-4 border-slate-600 shadow-sm">
                    <p class="text-xs font-bold text-slate-500 uppercase mb-1">Score Percentage</p>
                    <p class="text-4xl font-black text-slate-900">${scorePercentage.toFixed(1)}%</p>
                    <p class="text-xs text-slate-500 mt-1">deficit index</p>
                  </div>
                  
                  <div class="bg-white rounded-lg p-4 border-l-4 border-orange-500 shadow-sm">
                    <p class="text-xs font-bold text-slate-500 uppercase mb-1">Assessment Date</p>
                    <p class="text-lg font-black text-slate-900">${new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</p>
                    <p class="text-xs text-slate-500 mt-1">completed</p>
                  </div>
                </div>
                
                <div class="mt-4 p-4 ${interpretationColor} rounded-lg border-2">
                  <p class="font-bold mb-1">
                    <i class="fa-solid fa-stethoscope mr-2"></i>
                    Clinical Interpretation
                  </p>
                  <p class="text-sm font-semibold">${interpretation}</p>
                </div>
              </div>
            `;
          })()}
        </div>
      </div>

      <!-- Call to Action Card -->
      <div class="card p-6 bg-gradient-to-r from-sozo-600 to-orange-500 text-white border-0">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-xl font-bold mb-2">Ready for Assessment?</h3>
            <p class="text-sm opacity-90">Contact your healthcare provider to schedule your FNON assessment when you're ready to participate.</p>
          </div>
          <button onclick="loadSection('prs')" class="bg-white text-sozo-600 px-6 py-2 rounded-lg font-bold hover:bg-slate-100 transition flex items-center gap-2">
            Continue to PRS <i class="fa-solid fa-arrow-right"></i>
          </button>
        </div>
      </div>
      </div>
    `;
  }
  else if (key === 'brain') {
    area.innerHTML = `
      <div id="brainMappingContent" class="p-8">
      <div class="mb-4 flex items-center justify-between">
        <div>
          <h2 class="text-2xl font-bold">Brain Assessment</h2>
          <p class="text-slate-600">Upload .easy or .nedf files and map to medical history.</p>
        </div>
        <div class="text-right">
          <button onclick="downloadBrainMappingPDF()" class="bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-sozo-700 transition">
            <i class="fa-solid fa-file-pdf mr-2"></i>Download PDF
          </button>
        </div>
      </div>

      <div class="card p-6 space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <p class="text-xs font-bold text-slate-500 uppercase mb-1">Patient Name</p>
            <input class="input-royal bg-slate-100" value="${p.name}" readonly />
          </div>
          <div>
            <p class="text-xs font-bold text-slate-500 uppercase mb-1">Email</p>
            <input class="input-royal bg-slate-100" value="${p.email || ''}" readonly />
          </div>
          <div>
            <p class="text-xs font-bold text-slate-500 uppercase mb-1">Country</p>
            <input class="input-royal bg-slate-100" value="${p.country || ''}" readonly />
          </div>
        </div>

        <div class="border-2 border-dashed border-slate-200 rounded-xl p-6 text-center bg-slate-50" id="brainDrop">
          <p class="font-bold text-slate-800 mb-2">Drop .easy / .nedf / .pdf files here or click to select</p>
          <p class="text-xs text-slate-500">Accepted formats: .easy, .nedf, .pdf</p>
          <input type="file" id="brainFile" accept=".easy,.nedf,.pdf" class="hidden" />
        </div>

        <div class="flex gap-3 flex-wrap items-center">
          <button id="brainUploadBtn" class="bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold">Upload</button>
          <button id="brainResetBtn" class="bg-slate-200 text-slate-800 px-4 py-2 rounded-lg font-bold hover:bg-slate-300">Reset</button>
          <span id="brainError" class="text-sm text-slate-600"></span>
          <span id="brainSuccess" class="text-sm text-sozo-600"></span>
        </div>
      </div>
    `;

    setTimeout(() => {
      const drop = document.getElementById('brainDrop');
      const fileInput = document.getElementById('brainFile');
      const uploadBtn = document.getElementById('brainUploadBtn');
      const errEl = document.getElementById('brainError');
      const okEl = document.getElementById('brainSuccess');
      const resetBtn = document.getElementById('brainResetBtn');

      function resetMsgs() { errEl.textContent=''; okEl.textContent=''; }

      function validateFile(file) {
        if(!file) return 'Please select a file.';
        const ext = file.name.split('.').pop().toLowerCase();
        if(!['easy','nedf','pdf'].includes(ext)) return 'Only .easy, .nedf, or .pdf files are allowed.';
        return '';
      }

      drop.addEventListener('click', () => fileInput.click());
      drop.addEventListener('dragover', (e) => { e.preventDefault(); drop.classList.add('bg-orange-50','border-sozo-400'); });
      drop.addEventListener('dragleave', () => drop.classList.remove('bg-orange-50','border-sozo-400'));
      drop.addEventListener('drop', (e) => {
        e.preventDefault();
        drop.classList.remove('bg-orange-50','border-sozo-400');
        if(e.dataTransfer.files?.length) fileInput.files = e.dataTransfer.files;
      });

      uploadBtn.addEventListener('click', async () => {
        resetMsgs();
        const file = fileInput.files?.[0];
        const validation = validateFile(file);
        if(validation) { errEl.textContent = validation; return; }
        try {
          await handleFileUpload(file, 'patient-self');
          okEl.textContent = 'Files Uploaded Successfully';

          brainUploadState = {
            fileName: file.name,
            uploadedAt: new Date().toISOString()
          };
          setProgress('brain', 'completed');
          setProgress('prs', 'in-progress');

          const newId = `RPT-${Math.floor(1000 + Math.random()*9000)}`;
          patientReports.unshift({
            date: new Date().toISOString().slice(0,10),
            type: file.name.toLowerCase().endsWith('.nedf') || file.name.toLowerCase().endsWith('.easy') || file.name.toLowerCase().endsWith('.pdf') ? 'Brain Mapping' : 'Brain Mapping',
            doctor: (selectedDoctor.name || 'Self'),
            status: 'Uploaded',
            id: newId
          });
        } catch(err) {
          errEl.textContent = err.message || 'Upload failed';
        }
      });

      if(resetBtn) {
        resetBtn.addEventListener('click', () => {
          fileInput.value = '';
          brainUploadState = null;
          setProgress('brain', 'in-progress');
          errEl.textContent = '';
          okEl.textContent = '';
        });
      }
    }, 50);
  }
  else if (key === 'prs') {
    renderPRSLanding();
  }
  else if (key === 'finalreport') {
    renderFinalReport();
  }
  else if (key === 'billing') {
    const outstanding = patientBilling.filter(r => r.status !== 'Paid').reduce((sum, r) => sum + r.amount, 0);
    const nextPending = patientBilling.find(r => r.status === 'Pending');
    const defaultMethod = patientBilling.find(r => r.status === 'Paid')?.method || 'Visa •••• 4242';

    area.innerHTML = `
      <div class="p-8">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
          <div>
            <p class="text-xs font-bold text-slate-500 uppercase">Patient Portal</p>
            <h2 class="text-2xl font-bold">Billing & Payments</h2>
            <p class="text-slate-500">View invoices, pay balances, and manage payment methods.</p>
          </div>
          <div class="flex flex-wrap gap-2">
            <button id="billingAddMethod" class="btn-secondary flex items-center gap-2 text-sm"><i class="fa-solid fa-plus"></i> Add Payment Method</button>
            <button class="btn-primary flex items-center gap-2 text-sm" onclick="alert('Downloading latest statement...')"><i class="fa-solid fa-file-arrow-down"></i> Download Statement</button>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 mb-6">
          <div class="card p-4 border-l-4 border-l-orange-500">
            <p class="text-xs font-bold text-slate-500 uppercase">Outstanding</p>
            <p class="text-3xl font-black text-slate-900 mt-1">€${outstanding.toFixed(2)}</p>
            <p class="text-sm text-slate-500">Pending & failed items</p>
            <button id="billingPayBalance" class="mt-3 btn-primary text-sm px-3 py-2">Pay Balance</button>
          </div>
          <div class="card p-4 border-l-4 border-l-sozo-600">
            <p class="text-xs font-bold text-slate-500 uppercase">Next Payment</p>
            <p class="text-2xl font-black text-slate-900 mt-1">${nextPending?.dueDate || 'None'}</p>
            <p class="text-sm text-slate-500">${nextPending ? nextPending.description : 'No upcoming invoices'}</p>
          </div>
          <div class="card p-4 border-l-4 border-l-brand-blue">
            <p class="text-xs font-bold text-slate-500 uppercase">Default Method</p>
            <p class="text-lg font-black text-slate-900 mt-1">${defaultMethod}</p>
            <p class="text-sm text-slate-500">Auto-pay enabled</p>
          </div>
          <div class="card p-4 border-l-4 border-l-slate-600">
            <p class="text-xs font-bold text-slate-500 uppercase">Plan</p>
            <p class="text-lg font-black text-slate-900 mt-1">Sozo Premium</p>
            <p class="text-sm text-slate-500">Renews monthly • €2.00</p>
            <button id="managePlanBtn" class="text-sozo-600 font-bold text-sm hover:underline mt-2">Manage plan</button>
          </div>
        </div>

        <div class="card p-4 mb-4 bg-slate-50 border-slate-200">
          <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
            <div class="md:col-span-2">
              <label class="text-xs font-bold text-slate-500 uppercase">Search</label>
              <div class="relative mt-1">
                <i class="fa-solid fa-magnifying-glass absolute left-3 top-3 text-slate-400"></i>
                <input id="billingSearch" type="text" class="input-royal pl-9" placeholder="Search description or invoice" />
              </div>
            </div>
            <div>
              <label class="text-xs font-bold text-slate-500 uppercase">Status</label>
              <select id="billingStatus" class="input-royal mt-1">
                <option value="">All</option>
                <option value="Paid">Paid</option>
                <option value="Pending">Pending</option>
                <option value="Failed">Failed</option>
              </select>
            </div>
            <div>
              <label class="text-xs font-bold text-slate-500 uppercase">Start Date</label>
              <input id="billingStart" type="date" class="input-royal mt-1" />
            </div>
            <div>
              <label class="text-xs font-bold text-slate-500 uppercase">End Date</label>
              <input id="billingEnd" type="date" class="input-royal mt-1" />
            </div>
          </div>
          <div class="flex justify-between items-center mt-3 text-sm">
            <button id="billingClear" class="text-slate-600 font-bold hover:text-sozo-600"><i class="fa-solid fa-rotate-left mr-1"></i> Clear filters</button>
            <div id="billingCount" class="text-slate-600 font-bold"></div>
          </div>
        </div>

        <div class="card p-0 overflow-hidden">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Description</th>
                <th>Amount</th>
                <th>Method</th>
                <th>Card Type</th>
                <th>Status</th>
                <th>Invoice</th>
                <th>Due</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="billingBody"></tbody>
          </table>
        </div>
      </div>
      <!-- Payment Processing Modal -->
      <div id="paymentModal" class="modal hidden">
        <div class="modal-content max-w-2xl">
          <div class="p-6 border-b border-slate-200 flex items-center justify-between">
            <h3 class="text-xl font-bold text-slate-900">Save Card</h3>
            <button id="closePaymentModal" class="text-slate-400 hover:text-slate-600">
              <i class="fa-solid fa-times text-xl"></i>
            </button>
          </div>
          
          <div class="p-6">
            <!-- Payment Method Selection -->
            <div class="mb-6">
              <label class="text-sm font-bold text-slate-700 mb-3 block">Payment Method</label>
              <div class="grid grid-cols-4 gap-3">
                <button class="payment-method-btn border-2 border-slate-200 rounded-lg p-4 hover:border-sozo-600 transition" data-method="credit">
                  <i class="fa-solid fa-credit-card text-2xl text-blue-600 mb-2"></i>
                  <div class="text-sm font-bold text-slate-900">Credit Card</div>
                </button>
                <button class="payment-method-btn border-2 border-slate-200 rounded-lg p-4 hover:border-sozo-600 transition" data-method="debit">
                  <i class="fa-solid fa-credit-card text-2xl text-sozo-600 mb-2"></i>
                  <div class="text-sm font-bold text-slate-900">Debit Card</div>
                </button>
                <button class="payment-method-btn border-2 border-slate-200 rounded-lg p-4 hover:border-sozo-600 transition" data-method="insurance">
                  <i class="fa-solid fa-shield-halved text-2xl text-sozo-600 mb-2"></i>
                  <div class="text-sm font-bold text-slate-900">Insurance</div>
                </button>
                <button class="payment-method-btn border-2 border-slate-200 rounded-lg p-4 hover:border-sozo-600 transition" data-method="cash">
                  <i class="fa-solid fa-dollar-sign text-2xl text-sozo-600 mb-2"></i>
                  <div class="text-sm font-bold text-slate-900">Cash</div>
                </button>
              </div>
            </div>

            <!-- Payment Forms -->
            <div id="paymentForms" class="mb-6">
              <!-- Credit/Debit Card Form -->
              <div id="cardForm" class="payment-form hidden">
                <div class="space-y-4">
                  <div>
                    <label class="text-sm font-bold text-slate-700 mb-1 block">Card Number</label>
                    <input type="text" placeholder="1234 5678 9012 3456" maxlength="19" class="input-royal" />
                  </div>
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label class="text-sm font-bold text-slate-700 mb-1 block">Expiry Date</label>
                      <input type="text" placeholder="MM/YY" maxlength="5" class="input-royal" />
                    </div>
                    <div>
                      <label class="text-sm font-bold text-slate-700 mb-1 block">CVV</label>
                      <input type="text" placeholder="123" maxlength="4" class="input-royal" />
                    </div>
                  </div>
                  <div>
                    <label class="text-sm font-bold text-slate-700 mb-1 block">Cardholder Name</label>
                    <input type="text" placeholder="John Doe" class="input-royal" />
                  </div>
                </div>
              </div>

              <!-- Insurance Form -->
              <div id="insuranceForm" class="payment-form hidden">
                <div class="space-y-4">
                  <div>
                    <label class="text-sm font-bold text-slate-700 mb-1 block">Insurance Provider</label>
                    <select class="input-royal">
                      <option>Blue Cross Blue Shield</option>
                      <option>Aetna</option>
                      <option>UnitedHealthcare</option>
                      <option>Cigna</option>
                      <option>Humana</option>
                      <option>Kaiser Permanente</option>
                    </select>
                  </div>
                  <div>
                    <label class="text-sm font-bold text-slate-700 mb-1 block">Policy Number</label>
                    <input type="text" placeholder="Enter policy number" class="input-royal" />
                  </div>
                  <div>
                    <label class="text-sm font-bold text-slate-700 mb-1 block">Group Number</label>
                    <input type="text" placeholder="Enter group number" class="input-royal" />
                  </div>
                </div>
              </div>

              <!-- Cash Form -->
              <div id="cashForm" class="payment-form hidden">
                <div class="bg-slate-50 border border-slate-300 rounded-lg p-4 mb-4">
                  <p class="text-sm text-slate-700"><i class="fa-solid fa-info-circle mr-2"></i>Cash payment will be recorded at the reception desk</p>
                </div>
                <div>
                  <label class="text-sm font-bold text-slate-700 mb-1 block">Amount Received</label>
                  <input type="number" placeholder="0.00" step="0.01" class="input-royal" />
                </div>
              </div>
            </div>

            <!-- Process Buttons -->
          </div>

          <div class="p-6 border-t border-slate-200 flex justify-end gap-3">
            <button id="cancelPayment" class="btn-secondary">Cancel</button>
            <button id="processPayment" class="btn-primary">Save Card</button>
          </div>
        </div>
      </div>
      <!-- Manage Plan Modal -->
      <div id="managePlanModal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto p-6 md:p-8 relative">
          <button id="closePlanModal" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">
            <i class="fa-solid fa-times text-xl"></i>
          </button>

          <h3 class="text-2xl font-bold mb-6">Manage Your Plan</h3>

          <!-- Current Plan -->
          <div class="bg-gradient-to-br from-sozo-500 to-orange-600 rounded-xl p-6 text-white mb-6">
            <div class="flex items-center justify-between mb-4">
              <div>
                <p class="text-sm opacity-90">Current Plan</p>
                <h4 class="text-3xl font-black">Sozo Premium</h4>
              </div>
              <span class="bg-white/20 px-4 py-2 rounded-full text-sm font-bold">Active</span>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <p class="text-sm opacity-90">Billing Cycle</p>
                <p class="font-bold">Monthly</p>
              </div>
              <div>
                <p class="text-sm opacity-90">Next Billing Date</p>
                <p class="font-bold">Feb 1, 2026</p>
              </div>
              <div>
                <p class="text-sm opacity-90">Monthly Cost</p>
                <p class="font-bold text-2xl">€2.00</p>
              </div>
              <div>
                <p class="text-sm opacity-90">Annual Savings</p>
                <p class="font-bold">€0.00</p>
              </div>
            </div>
          </div>

          <!-- Plan Options -->
          <div class="space-y-4 mb-6">
            <h4 class="font-bold text-lg">Available Plans</h4>
            
            <!-- Premium Plan -->
            <div class="border-2 border-sozo-600 rounded-lg p-4 bg-orange-50">
              <div class="flex items-center justify-between mb-3">
                <div>
                  <h5 class="font-bold text-lg">Sozo Premium</h5>
                  <p class="text-sm text-slate-600">Full access to all features</p>
                </div>
                <div class="text-right">
                  <p class="text-2xl font-black text-sozo-600">€2.00</p>
                  <p class="text-xs text-slate-500">per month</p>
                </div>
              </div>
              <ul class="space-y-2 text-sm">
                <li class="flex items-center gap-2"><i class="fa-solid fa-check text-sozo-600"></i>Unlimited telemedicine consultations</li>
                <li class="flex items-center gap-2"><i class="fa-solid fa-check text-sozo-600"></i>Priority appointment scheduling</li>
                <li class="flex items-center gap-2"><i class="fa-solid fa-check text-sozo-600"></i>24/7 messaging with healthcare team</li>
                <li class="flex items-center gap-2"><i class="fa-solid fa-check text-sozo-600"></i>Access to all brain assessment tools</li>
              </ul>
              <button class="w-full mt-4 bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold" disabled>Current Plan</button>
            </div>

            <!-- Basic Plan -->
            <div class="border-2 border-slate-200 rounded-lg p-4 hover:border-slate-300 transition">
              <div class="flex items-center justify-between mb-3">
                <div>
                  <h5 class="font-bold text-lg">Sozo Basic</h5>
                  <p class="text-sm text-slate-600">Essential features only</p>
                </div>
                <div class="text-right">
                  <p class="text-2xl font-black text-slate-900">Free</p>
                  <p class="text-xs text-slate-500">forever</p>
                </div>
              </div>
              <ul class="space-y-2 text-sm">
                <li class="flex items-center gap-2"><i class="fa-solid fa-check text-sozo-600"></i>5 telemedicine consultations per month</li>
                <li class="flex items-center gap-2"><i class="fa-solid fa-check text-sozo-600"></i>Standard appointment scheduling</li>
                <li class="flex items-center gap-2"><i class="fa-solid fa-check text-sozo-600"></i>Basic messaging features</li>
                <li class="flex items-center gap-2"><i class="fa-solid fa-times text-slate-600"></i>Limited assessment tools</li>
              </ul>
              <button class="w-full mt-4 bg-slate-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-slate-700">Downgrade to Basic</button>
            </div>
          </div>

          <!-- Cancel Plan -->
          <div class="border-t pt-6">
            <button class="text-slate-600 font-bold text-sm hover:underline">
              <i class="fa-solid fa-times-circle mr-1"></i>Cancel Subscription
            </button>
          </div>
        </div>
      </div>
    `;

    setTimeout(() => {
      const tbody = document.getElementById('billingBody');
      const search = document.getElementById('billingSearch');
      const statusSel = document.getElementById('billingStatus');
      const start = document.getElementById('billingStart');
      const end = document.getElementById('billingEnd');
      const count = document.getElementById('billingCount');
      const clear = document.getElementById('billingClear');
      const payBalance = document.getElementById('billingPayBalance');
      const addMethod = document.getElementById('billingAddMethod');

      function formatAmount(a) { return `€${a.toFixed(2)}`; }

      function applyFilters() {
        const q = (search?.value || '').toLowerCase();
        const status = statusSel?.value || '';
        const startDate = start?.value ? new Date(start.value) : null;
        const endDate = end?.value ? new Date(end.value) : null;
        if(endDate) endDate.setHours(23,59,59,999);

        const filtered = patientBilling.filter(row => {
          const d = new Date(row.date);
          if(startDate && d < startDate) return false;
          if(endDate && d > endDate) return false;
          if(status && row.status !== status) return false;
          if(q) {
            const haystack = `${row.description} ${row.invoice} ${row.method}`.toLowerCase();
            if(!haystack.includes(q)) return false;
          }
          return true;
        });

        if(tbody) {
          tbody.innerHTML = filtered.map(row => {
            const badgeClass = row.status === 'Paid' ? 'badge-success' : row.status === 'Pending' ? 'badge-warning' : 'badge-danger';
            const actionLabel = row.status === 'Paid' ? 'Receipt' : 'Pay';
            const actionIcon = row.status === 'Paid' ? 'fa-receipt' : 'fa-credit-card';
            return `
              <tr>
                <td>${row.date}</td>
                <td class="font-bold text-slate-800">${row.description}</td>
                <td class="font-mono text-sm">${formatAmount(row.amount)}</td>
                <td class="text-sm text-slate-600">${row.method}</td>
                <td class="text-sm"><span class="badge badge-info">${row.cardType || 'N/A'}</span></td>
                <td><span class="badge ${badgeClass}">${row.status}</span></td>
                <td class="font-mono text-sm">${row.invoice}</td>
                <td>${row.dueDate || '-'}</td>
                <td><button class="text-sozo-600 font-bold hover:text-sozo-700" onclick="alert('${actionLabel} for ${row.invoice}')"><i class="fa-solid ${actionIcon}"></i> ${actionLabel}</button></td>
              </tr>`;
          }).join('') || '<tr><td colspan="9" class="p-8 text-center text-slate-500">No billing items match your filters.</td></tr>';
        }

        if(count) {
          count.textContent = `Showing ${filtered.length} of ${patientBilling.length} records`;
        }
      }

      search?.addEventListener('input', applyFilters);
      statusSel?.addEventListener('change', applyFilters);
      start?.addEventListener('change', applyFilters);
      end?.addEventListener('change', applyFilters);
      clear?.addEventListener('click', () => {
        if(search) search.value = '';
        if(statusSel) statusSel.value = '';
        if(start) start.value = '';
        if(end) end.value = '';
        applyFilters();
      });

      // Payment Modal Logic
      const paymentModal = document.getElementById('paymentModal');
      const closePaymentModal = document.getElementById('closePaymentModal');
      const cancelPayment = document.getElementById('cancelPayment');
      const processPayment = document.getElementById('processPayment');
      const paymentMethodBtns = document.querySelectorAll('.payment-method-btn');
      const paymentForms = document.querySelectorAll('.payment-form');

      let selectedPaymentMethod = null;

      // Open modal
      payBalance?.addEventListener('click', () => {
        if(paymentModal) paymentModal.classList.remove('hidden');
      });

      // Close modal
      closePaymentModal?.addEventListener('click', () => {
        if(paymentModal) paymentModal.classList.add('hidden');
      });
      cancelPayment?.addEventListener('click', () => {
        if(paymentModal) paymentModal.classList.add('hidden');
      });

      // Payment method selection
      paymentMethodBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          selectedPaymentMethod = btn.dataset.method;
          
          // Update button styles
          paymentMethodBtns.forEach(b => {
            b.classList.remove('border-sozo-600', 'bg-sozo-50');
            b.classList.add('border-slate-200');
          });
          btn.classList.remove('border-slate-200');
          btn.classList.add('border-sozo-600', 'bg-sozo-50');

          // Hide all forms
          paymentForms.forEach(f => f.classList.add('hidden'));

          // Show selected form
          if(selectedPaymentMethod === 'credit' || selectedPaymentMethod === 'debit') {
            document.getElementById('cardForm')?.classList.remove('hidden');
          } else if(selectedPaymentMethod === 'insurance') {
            document.getElementById('insuranceForm')?.classList.remove('hidden');
          } else if(selectedPaymentMethod === 'cash') {
            document.getElementById('cashForm')?.classList.remove('hidden');
          }
        });
      });

      // Process payment
      processPayment?.addEventListener('click', () => {
        if(!selectedPaymentMethod) {
          alert('Please select a payment method');
          return;
        }
        alert(`Processing payment via ${selectedPaymentMethod}...`);
        if(paymentModal) paymentModal.classList.add('hidden');
      });

      addMethod?.addEventListener('click', () => {
        if(paymentModal) paymentModal.classList.remove('hidden');
      });

      // Manage Plan Modal Logic
      const managePlanBtn = document.getElementById('managePlanBtn');
      const managePlanModal = document.getElementById('managePlanModal');
      const closePlanModal = document.getElementById('closePlanModal');

      if(managePlanBtn) {
        managePlanBtn.addEventListener('click', () => {
          if(managePlanModal) {
            managePlanModal.classList.remove('hidden');
          }
        });
      }

      if(closePlanModal) {
        closePlanModal.addEventListener('click', () => {
          if(managePlanModal) {
            managePlanModal.classList.add('hidden');
          }
        });
      }

      // Close modal when clicking outside
      if(managePlanModal) {
        managePlanModal.addEventListener('click', (e) => {
          if(e.target === managePlanModal) {
            managePlanModal.classList.add('hidden');
          }
        });
      }

      // Plan selection buttons
      const planButtons = managePlanModal?.querySelectorAll('button');
      if(planButtons) {
        planButtons.forEach(btn => {
          if(btn.textContent.includes('Downgrade') || btn.textContent.includes('Upgrade')) {
            btn.addEventListener('click', () => {
              const planName = btn.closest('div').querySelector('h5')?.textContent || 'Unknown Plan';
              alert(`Plan change to "${planName}" would be processed here`);
              // In a real app, this would update the plan via API
              managePlanModal?.classList.add('hidden');
            });
          } else if(btn.textContent.includes('Cancel Subscription')) {
            btn.addEventListener('click', () => {
              if(confirm('Are you sure you want to cancel your subscription? You will lose all premium features.')) {
                alert('Subscription cancellation request submitted');
                managePlanModal?.classList.add('hidden');
              }
            });
          }
        });
      }

      applyFilters();
    }, 50);
  }
 else if (key === 'messages') {
    const p = getActivePatient();
    
    // Sample message data
    const conversations = [
      { id: 1, doctorName: 'Dr. James Wilson', avatar: 'JW', lastMessage: 'Your FNON results are ready for review.', time: '2:30 PM', unread: 3, online: true },
      { id: 2, doctorName: 'Support Team', avatar: 'ST', lastMessage: 'Thank you for contacting us. How can we hel...', time: 'Yesterday', unread: 0, online: false },
      { id: 3, doctorName: 'Dr. Sarah Miller', avatar: 'SM', lastMessage: 'Your prescription has been sent to the pharm...', time: 'Dec 28', unread: 0, online: false }
    ];

    const activeConversation = {
      id: 1,
      doctorName: 'Dr. James Wilson',
      avatar: 'JW',
      online: true,
      messages: [
        { sender: 'doctor', text: "Good afternoon! I've reviewed your FNON assessment results and they look very promising.", time: '10:15 AM', avatar: 'JW'},
        { sender: 'patient', text: "That's great to hear! Should I continue with the same treatment plan?", time: '10:18 AM', avatar: p.name?.charAt(0) || 'P' },
        { sender: 'doctor', text: "Yes, let's continue for another month. I'll schedule a follow-up appointment for early January.", time: '2:30 PM', avatar: 'JW'}
      ]
    };

    area.innerHTML = `
      <div class="p-8">
        <div class="mb-6">
          <h2 class="text-2xl font-bold">Messages</h2>
          <p class="text-slate-500 text-sm">Communicate securely with your healthcare team</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Conversations List -->
          <div class="lg:col-span-1 card p-0 overflow-hidden">
            <div class="p-4 bg-sozo-600 text-white flex items-center justify-between">
              <h3 class="font-bold text-lg">Conversations</h3>
              <button class="bg-white/20 hover:bg-white/30 text-white px-3 py-1.5 rounded-lg text-sm font-semibold transition">
                <i class="fa-solid fa-plus mr-1"></i> New Message
              </button>
            </div>

            <div class="divide-y divide-slate-200">
              ${conversations.map(conv => `
                <div class="p-4 hover:bg-slate-50 cursor-pointer transition ${conv.id === activeConversation.id ? 'bg-slate-50 border-l-4 border-l-sozo-600' : ''}" onclick="loadConversation(${conv.id})">
                  <div class="flex items-start gap-3">
                    <div class="relative">
                      <div class="w-12 h-12 rounded-full bg-gradient-to-br from-sozo-500 to-orange-500 flex items-center justify-center text-white font-bold flex-shrink-0">
                        ${conv.avatar}
                      </div>
                      ${conv.online ? '<span class="absolute bottom-0 right-0 w-3.5 h-3.5 bg-sozo-600 border-2 border-white rounded-full"></span>' : ''}
                    </div>
                    <div class="flex-1 min-w-0">
                      <div class="flex items-center justify-between mb-1">
                        <p class="font-bold text-slate-900 truncate">${conv.doctorName}</p>
                        <span class="text-xs text-slate-400">${conv.time}</span>
                      </div>
                      <p class="text-sm text-slate-600 truncate">${conv.lastMessage}</p>
                    </div>
                    ${conv.unread > 0 ? `<span class="bg-sozo-600 text-white text-xs font-bold px-2 py-1 rounded-full">${conv.unread}</span>` : ''}
                  </div>
                </div>
              `).join('')}
            </div>
          </div>

          <!-- Active Conversation -->
          <div class="lg:col-span-2 card p-0 overflow-hidden flex flex-col" style="height: 600px;">
            <!-- Header -->
            <div class="p-4 border-b border-slate-200 bg-white flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="relative">
                  <div class="w-10 h-10 rounded-full bg-gradient-to-br from-sozo-500 to-orange-500 flex items-center justify-center text-white font-bold text-sm">
                    ${activeConversation.avatar}
                  </div>
                  ${activeConversation.online ? '<span class="absolute bottom-0 right-0 w-3 h-3 bg-sozo-600 border-2 border-white rounded-full"></span>' : ''}
                </div>
                <div>
                  <p class="font-bold text-slate-900">${activeConversation.doctorName}</p>
                  <p class="text-xs text-sozo-600 font-semibold flex items-center gap-1">
                    <span class="w-2 h-2 bg-sozo-600 rounded-full"></span>
                    Online
                  </p>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <button class="text-slate-600 hover:text-sozo-600 p-2" title="Voice Call">
                  <i class="fa-solid fa-phone text-xl"></i>
                </button>
                <button class="text-slate-600 hover:text-sozo-600 p-2" title="Video Call">
                  <i class="fa-solid fa-video text-xl"></i>
                </button>
              </div>
            </div>

            <!-- Messages Area -->
            <div class="flex-1 overflow-y-auto p-6 bg-slate-50 space-y-4">
              ${activeConversation.messages.map(msg => `
                <div class="flex ${msg.sender === 'patient' ? 'justify-end' : 'justify-start'}">
                  ${msg.sender === 'doctor' ? `
                    <div class="flex items-start gap-2 max-w-md">
                      <div class="w-8 h-8 rounded-full bg-gradient-to-br from-sozo-500 to-orange-500 flex items-center justify-center text-white font-bold text-xs flex-shrink-0">
                        ${msg.avatar}
                      </div>
                      <div>
                        <div class="bg-white rounded-lg rounded-tl-none p-3 shadow-sm">
                          <p class="text-sm text-slate-800">${msg.text}</p>
                        </div>
                        <p class="text-xs text-slate-400 mt-1 ml-2">${msg.time}</p>
                      </div>
                    </div>
                  ` : `
                    <div class="flex items-start gap-2 max-w-md flex-row-reverse">
                      <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold text-xs flex-shrink-0">
                        ${msg.avatar}
                      </div>
                      <div>
                        <div class="bg-sozo-600 text-white rounded-lg rounded-tr-none p-3 shadow-sm">
                          <p class="text-sm">${msg.text}</p>
                        </div>
                        <p class="text-xs text-slate-400 mt-1 mr-2 text-right">${msg.time}</p>
                      </div>
                    </div>
                  `}
                </div>
              `).join('')}
            </div>

            <!-- Message Input -->
            <div class="p-4 border-t border-slate-200 bg-white">
              <div class="flex items-center gap-3">
                <button class="text-slate-400 hover:text-slate-600 p-2" title="Attach File">
                  <i class="fa-solid fa-paperclip text-xl"></i>
                </button>
                <input 
                  type="text" 
                  placeholder="Type your message..." 
                  class="flex-1 px-4 py-2.5 border border-slate-300 rounded-lg focus:outline-none focus:border-sozo-600 focus:ring-2 focus:ring-sozo-100"
                  id="messageInput"
                />
                <button class="bg-sozo-600 text-white px-6 py-2.5 rounded-lg font-semibold hover:bg-sozo-700 transition shadow-lg shadow-sozo-500/30">
                  <i class="fa-solid fa-paper-plane mr-2"></i>Send
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;

    // Message functionality
    setTimeout(() => {
      const messageInput = document.getElementById('messageInput');
      
      window.loadConversation = (id) => {
        console.log('Loading conversation:', id);
        // In production, this would load the conversation data
      };

      if (messageInput) {
        messageInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' && messageInput.value.trim()) {
            alert('Message sent: ' + messageInput.value);
            messageInput.value = '';
          }
        });
      }
    }, 50);
  } 
  else if (key === 'telemedicine') {
    const p = getActivePatient();
    
    // Sample telemedicine data
    const upcomingAppointments = [
      {
        id: 1,
        doctor: 'Dr. James Wilson',
        specialty: 'Neurologist',
        type: 'Follow-up Consultation',
        date: 'Dec 31, 2024',
        time: '3:00 PM',
        duration: '30 minutes',
        platform: 'SozoMeet',
        status: 'Today',
        avatar: 'JW'
      }
    ];

    const pastConsultations = [
      { date: 'Dec 24, 2024', time: '2:00 PM', doctor: 'Dr. James Wilson', type: 'FNON Review', duration: '25 min', hasRecording: true, hasNotes: true },
      { date: 'Dec 10, 2024', time: '10:30 AM', doctor: 'Dr. Sarah Miller', type: 'Initial Consultation', duration: '45 min', hasRecording: true, hasNotes: true },
      { date: 'Nov 28, 2024', time: '4:00 PM', doctor: 'Dr. James Wilson', type: 'Progress Check-in', duration: '20 min', hasRecording: true, hasNotes: true }
    ];

    area.innerHTML = `
      <div class="p-8">
        <div class="mb-6">
          <h2 class="text-2xl font-bold">Telemedicine</h2>
          <p class="text-slate-500 text-sm">Virtual consultations with your healthcare providers</p>
        </div>

        <!-- Action Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <!-- Start Video Call -->
          <div class="card p-6 hover:shadow-xl transition-all cursor-pointer border-l-4 border-l-orange-500" onclick="alert('Starting video call...')">
            <div class="flex items-start gap-4">
              <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-orange-500 to-orange-600 flex items-center justify-center flex-shrink-0 shadow-lg">
                <i class="fa-solid fa-video text-white text-2xl"></i>
              </div>
              <div class="flex-1">
                <h3 class="font-bold text-lg text-slate-900 mb-1">Start Video Call</h3>
                <p class="text-sm text-slate-600">Join scheduled consultation</p>
              </div>
            </div>
          </div>

          <!-- Schedule Appointment -->
          <div class="card p-6 hover:shadow-xl transition-all cursor-pointer border-l-4 border-l-brand-blue" onclick="alert('Opening appointment scheduler...')">
            <div class="flex items-start gap-4">
              <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-brand-blue to-blue-600 flex items-center justify-center flex-shrink-0 shadow-lg">
                <i class="fa-solid fa-calendar-plus text-white text-2xl"></i>
              </div>
              <div class="flex-1">
                <h3 class="font-bold text-lg text-slate-900 mb-1">Schedule Appointment</h3>
                <p class="text-sm text-slate-600">Book a virtual visit</p>
              </div>
            </div>
          </div>

          <!-- Past Consultations -->
          <div id="pastConsultationsCard" class="card p-6 hover:shadow-xl transition-all cursor-pointer border-l-4 border-l-slate-600">
            <div class="flex items-start gap-4">
              <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-slate-600 to-slate-700 flex items-center justify-center flex-shrink-0 shadow-lg">
                <i class="fa-solid fa-clock-rotate-left text-white text-2xl"></i>
              </div>
              <div class="flex-1">
                <h3 class="font-bold text-lg text-slate-900 mb-1">Past Consultations</h3>
                <p class="text-sm text-slate-600">View consultation history</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Upcoming Virtual Appointments -->
        <div class="mb-8">
          <h3 class="text-xl font-bold mb-4">Upcoming Virtual Appointments</h3>
          
          ${upcomingAppointments.length > 0 ? upcomingAppointments.map(apt => `
            <div class="card p-6 mb-4 border-l-4 border-l-sozo-600 bg-orange-50">
              <div class="flex items-start gap-4">
                <div class="w-16 h-16 rounded-full bg-gradient-to-br from-sozo-500 to-orange-500 flex items-center justify-center text-white text-2xl flex-shrink-0 shadow-lg">
                  ${apt.avatar}
                </div>
                <div class="flex-1">
                  <div class="flex items-start justify-between mb-3">
                    <div>
                      <h4 class="font-bold text-lg text-slate-900">${apt.doctor}</h4>
                      <p class="text-sm text-slate-600">${apt.specialty} • ${apt.type}</p>
                    </div>
                    <span class="bg-sozo-600 text-white px-3 py-1 rounded-full text-xs font-bold">${apt.status}</span>
                  </div>

                  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                    <div>
                      <p class="text-xs text-slate-500 uppercase font-semibold mb-1">Date</p>
                      <p class="font-bold text-slate-900">${apt.date}</p>
                    </div>
                    <div>
                      <p class="text-xs text-slate-500 uppercase font-semibold mb-1">Time</p>
                      <p class="font-bold text-slate-900">${apt.time}</p>
                    </div>
                    <div>
                      <p class="text-xs text-slate-500 uppercase font-semibold mb-1">Duration</p>
                      <p class="font-bold text-slate-900">${apt.duration}</p>
                    </div>
                    <div>
                      <p class="text-xs text-slate-500 uppercase font-semibold mb-1">Platform</p>
                      <p class="font-bold text-slate-900">${apt.platform}</p>
                    </div>
                  </div>

                  <div class="flex gap-3">
                    <button class="flex-1 bg-sozo-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-sozo-700 shadow-lg transition">
                      <i class="fa-solid fa-video mr-2"></i>Join Video Call
                    </button>
                    <button class="bg-white border-2 border-slate-300 text-slate-700 px-6 py-3 rounded-lg font-bold hover:border-sozo-600 hover:text-sozo-600 transition">
                      <i class="fa-solid fa-calendar mr-2"></i>Reschedule
                    </button>
                    <button class="bg-white border-2 border-slate-300 text-slate-600 px-6 py-3 rounded-lg font-bold hover:bg-slate-50 transition">
                      <i class="fa-solid fa-times mr-2"></i>Cancel
                    </button>
                  </div>
                </div>
              </div>
            </div>
          `).join('') : `
            <div class="card p-8 text-center">
              <i class="fa-solid fa-calendar-xmark text-5xl text-slate-300 mb-4"></i>
              <p class="text-slate-500 font-semibold">No upcoming virtual appointments</p>
              <button class="mt-4 bg-sozo-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-sozo-700">Schedule Now</button>
            </div>
          `}
        </div>

        <!-- Recent Consultations -->
        <div id="recentConsultationsSection">
          <h3 class="text-xl font-bold mb-4">Recent Consultations</h3>
          <!-- Search and Filter Bar -->
          <div class="card p-4 mb-4 bg-slate-50 border-slate-200">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
              <div class="md:col-span-2">
                <label class="text-xs font-bold text-slate-500 uppercase">Search</label>
                <div class="relative mt-1">
                  <i class="fa-solid fa-magnifying-glass absolute left-3 top-3 text-slate-400"></i>
                  <input type="text" id="consultationSearch" class="input-royal pl-9" placeholder="Search by provider or type..." />
                </div>
              </div>
              <div>
                <label class="text-xs font-bold text-slate-500 uppercase">Start Date</label>
                <input type="date" id="consultationStartDate" class="input-royal mt-1" />
              </div>
              <div>
                <label class="text-xs font-bold text-slate-500 uppercase">End Date</label>
                <input type="date" id="consultationEndDate" class="input-royal mt-1" />
              </div>
            </div>
            <div class="flex justify-between items-center mt-3">
              <button id="consultationClear" class="text-slate-600 font-bold hover:text-sozo-600 text-sm">
                <i class="fa-solid fa-rotate-left mr-1"></i> Clear filters
              </button>
              <span id="consultationCount" class="text-sm text-slate-600 font-semibold"></span>
            </div>
          </div>
          <div class="card p-0 overflow-hidden">
            <table>
              <thead>
                <tr>
                  <th>Date & Time</th>
                  <th>Provider</th>
                  <th>Type</th>
                  <th>Duration</th>
                  <th>Recording</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody>
                <tbody id="consultationTableBody">
                ${pastConsultations.map(consultation => `
                  <tr>
                    <td class="font-semibold">${consultation.date} • ${consultation.time}</td>
                    <td class="font-bold text-slate-900">${consultation.doctor}</td>
                    <td><span class="badge badge-info">${consultation.type}</span></td>
                    <td>${consultation.duration}</td>
                    <td>
                      ${consultation.hasRecording ? `
                        <button class="text-orange-600 hover:text-orange-700 font-semibold" title="Play Recording">
                          <i class="fa-solid fa-play-circle text-xl"></i>
                        </button>
                      ` : '<span class="text-slate-400">—</span>'}
                    </td>
                    <td>
                      ${consultation.hasNotes ? `
                        <button class="text-blue-600 hover:text-blue-700 font-semibold" title="View Notes">
                          <i class="fa-solid fa-file-medical text-xl"></i>
                        </button>
                      ` : '<span class="text-slate-400">—</span>'}
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    `;
    // Add filter functionality
    setTimeout(() => {
      let filteredConsultations = [...pastConsultations];
      const tbody = document.getElementById('consultationTableBody');
      const searchInput = document.getElementById('consultationSearch');
      const startDateInput = document.getElementById('consultationStartDate');
      const endDateInput = document.getElementById('consultationEndDate');
      const clearBtn = document.getElementById('consultationClear');
      const countDisplay = document.getElementById('consultationCount');

      function parseConsultationDate(dateStr) {
        // Parse "Dec 24, 2024" format
        return new Date(dateStr);
      }

      function applyFilters() {
        const searchTerm = searchInput?.value.toLowerCase() || '';
        const startDate = startDateInput?.value ? new Date(startDateInput.value) : null;
        const endDate = endDateInput?.value ? new Date(endDateInput.value) : null;

        filteredConsultations = pastConsultations.filter(consultation => {
          // Search filter
          const matchesSearch = !searchTerm || 
            consultation.doctor.toLowerCase().includes(searchTerm) ||
            consultation.type.toLowerCase().includes(searchTerm);

          // Date filter
          const consultDate = parseConsultationDate(consultation.date);
          const matchesStartDate = !startDate || consultDate >= startDate;
          const matchesEndDate = !endDate || consultDate <= endDate;

          return matchesSearch && matchesStartDate && matchesEndDate;
        });

        renderConsultations();
      }

      function renderConsultations() {
        if (!tbody) return;

        if (filteredConsultations.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="6" class="text-center py-8 text-slate-500">
                <i class="fa-solid fa-search text-3xl mb-2"></i>
                <p class="font-semibold">No consultations found</p>
                <p class="text-sm">Try adjusting your filters</p>
              </td>
            </tr>
          `;
        } else {
          tbody.innerHTML = filteredConsultations.map(consultation => `
            <tr>
              <td class="font-semibold">${consultation.date} • ${consultation.time}</td>
              <td class="font-bold text-slate-900">${consultation.doctor}</td>
              <td><span class="badge badge-info">${consultation.type}</span></td>
              <td>${consultation.duration}</td>
              <td>
                ${consultation.hasRecording ? `
                  <button class="text-orange-600 hover:text-orange-700 font-semibold" title="Play Recording">
                    <i class="fa-solid fa-play-circle text-xl"></i>
                  </button>
                ` : '<span class="text-slate-400">—</span>'}
              </td>
              <td>
                ${consultation.hasNotes ? `
                  <button class="text-blue-600 hover:text-blue-700 font-semibold" title="View Notes">
                    <i class="fa-solid fa-file-medical text-xl"></i>
                  </button>
                ` : '<span class="text-slate-400">—</span>'}
              </td>
            </tr>
          `).join('');
        }

        if (countDisplay) {
          countDisplay.textContent = `Showing ${filteredConsultations.length} of ${pastConsultations.length} consultations`;
        }
      }

      // Event listeners
      searchInput?.addEventListener('input', applyFilters);
      startDateInput?.addEventListener('change', applyFilters);
      endDateInput?.addEventListener('change', applyFilters);
      
      clearBtn?.addEventListener('click', () => {
        if (searchInput) searchInput.value = '';
        if (startDateInput) startDateInput.value = '';
        if (endDateInput) endDateInput.value = '';
        applyFilters();
      });

      // Initial render
      renderConsultations();

      // Add click handler for "Past Consultations" card to scroll to recent consultations section
      const pastConsultCard = document.getElementById('pastConsultationsCard');
      const recentConsultationsSection = document.getElementById('recentConsultationsSection');
      
      if (pastConsultCard && recentConsultationsSection) {
        pastConsultCard.addEventListener('click', () => {
          recentConsultationsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
      }
    }, 50);
  }
  else if (key === 'insurance') {
    const p = getActivePatient();
    
    // Sample insurance data
    const primaryInsurance = {
      provider: 'TK - Techniker Krankenkasse',
      type: 'German Public Health Insurance',
      policyNumber: 'TK-2024-789456',
      groupNumber: 'GRP-8891',
      effectiveDate: 'Jan 1, 2024',
      renewalDate: 'Jan 1, 2025',
      deductible: { current: 500, max: 500 },
      outOfPocket: { current: 1200, max: 2500 },
      coverage: 'Comprehensive',
      status: 'Active'
    };

    const coverageItems = [
      { title: 'Doctor Visits', copay: '€10 copay per visit', status: 'Fully Covered', icon: 'fa-user-doctor', color: 'green' },
      { title: 'Prescriptions', copay: '€5-€10 copay', status: 'Fully Covered', icon: 'fa-pills', color: 'green' },
      { title: 'Lab Tests', copay: 'No copay', status: '100% Covered', icon: 'fa-flask', color: 'green' },
      { title: 'Hospital Stay', copay: '€10 per day', status: 'Requires Deductible', icon: 'fa-hospital', color: 'yellow' },
      { title: 'Mental Health', copay: '€10 copay', status: 'Unlimited Sessions', icon: 'fa-brain', color: 'green' },
      { title: 'Telemedicine', copay: 'No copay', status: '100% Covered', icon: 'fa-video', color: 'green' }
    ];

    const recentClaims = [
      { id: 'CLM-2024-12-089', date: 'Dec 20, 2024', provider: 'Dr. James Wilson', service: 'Lab - CBC Test', amount: '€85.00', status: 'Approved' },
      { id: 'CLM-2024-12-067', date: 'Dec 15, 2024', provider: 'Dr. James Wilson', service: 'Office Visit', amount: '€120.00', status: 'Approved' },
      { id: 'CLM-2024-12-012', date: 'Dec 10, 2024', provider: 'Dr. Sarah Miller', service: 'Telemedicine Consult', amount: '€75.00', status: 'Approved' },
      { id: 'CLM-2024-11-198', date: 'Nov 28, 2024', provider: 'MedLab Center', service: 'Blood Work Panel', amount: '€150.00', status: 'Processing' }
    ];

    const deductiblePercent = (primaryInsurance.deductible.current / primaryInsurance.deductible.max) * 100;
    const outOfPocketPercent = (primaryInsurance.outOfPocket.current / primaryInsurance.outOfPocket.max) * 100;

    area.innerHTML = `
      <div class="p-8">
        <div class="mb-6 flex items-center justify-between">
          <div>
            <h2 class="text-2xl font-bold">Insurance Information</h2>
            <p class="text-slate-500 text-sm">Manage your health insurance coverage</p>
          </div>
          <button class="bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-sozo-700 shadow-lg">
            <i class="fa-solid fa-plus mr-2"></i>Add Insurance
          </button>
        </div>

        <!-- Primary Insurance Card -->
        <div class="mb-8">
          <h3 class="text-xl font-bold mb-4">Primary Insurance</h3>
          
          <div class="card p-6 border-l-4 border-l-orange-500">
            <div class="flex items-start justify-between mb-6">
              <div>
                <h4 class="text-2xl font-bold text-slate-900 mb-1">${primaryInsurance.provider}</h4>
                <p class="text-slate-600">${primaryInsurance.type}</p>
              </div>
              <span class="bg-orange-100 text-sozo-700 px-4 py-2 rounded-full font-bold text-sm">${primaryInsurance.status}</span>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-6">
              <div>
                <p class="text-xs text-slate-500 uppercase font-semibold mb-1">Policy Number</p>
                <p class="font-bold text-slate-900">${primaryInsurance.policyNumber}</p>
              </div>
              <div>
                <p class="text-xs text-slate-500 uppercase font-semibold mb-1">Group Number</p>
                <p class="font-bold text-slate-900">${primaryInsurance.groupNumber}</p>
              </div>
              <div>
                <p class="text-xs text-slate-500 uppercase font-semibold mb-1">Effective Date</p>
                <p class="font-bold text-slate-900">${primaryInsurance.effectiveDate}</p>
              </div>
              <div>
                <p class="text-xs text-slate-500 uppercase font-semibold mb-1">Renewal Date</p>
                <p class="font-bold text-slate-900">${primaryInsurance.renewalDate}</p>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
              <div>
                <div class="flex items-center justify-between mb-2">
                  <p class="text-sm font-semibold text-slate-700">Deductible (Annual)</p>
                  <p class="text-sm font-bold text-slate-900">€${primaryInsurance.deductible.current} / €${primaryInsurance.deductible.max}</p>
                </div>
                <div class="w-full bg-slate-200 rounded-full h-3">
                  <div class="bg-sozo-600 h-3 rounded-full" style="width: ${deductiblePercent}%"></div>
                </div>
              </div>
              <div>
                <div class="flex items-center justify-between mb-2">
                  <p class="text-sm font-semibold text-slate-700">Out-of-Pocket Max</p>
                  <p class="text-sm font-bold text-slate-900">€${primaryInsurance.outOfPocket.current} / €${primaryInsurance.outOfPocket.max}</p>
                </div>
                <div class="w-full bg-slate-200 rounded-full h-3">
                  <div class="bg-orange-500 h-3 rounded-full" style="width: ${outOfPocketPercent}%"></div>
                </div>
              </div>
              <div>
                <div class="flex items-center justify-between mb-2">
                  <p class="text-sm font-semibold text-slate-700">Coverage</p>
                  <p class="text-sm font-bold text-sozo-600 flex items-center gap-1">
                    <i class="fa-solid fa-check-circle"></i>${primaryInsurance.coverage}
                  </p>
                </div>
              </div>
            </div>

            <div class="flex flex-wrap gap-3">
              <button class="bg-slate-700 text-white px-6 py-2.5 rounded-lg font-semibold hover:bg-slate-800 transition">
                <i class="fa-solid fa-id-card mr-2"></i>View Insurance Card
              </button>
              <button class="bg-white border-2 border-slate-300 text-slate-700 px-6 py-2.5 rounded-lg font-semibold hover:border-sozo-600 hover:text-sozo-600 transition">
                <i class="fa-solid fa-edit mr-2"></i>Edit Information
              </button>
              <button class="bg-white border-2 border-slate-300 text-slate-700 px-6 py-2.5 rounded-lg font-semibold hover:border-sozo-600 hover:text-sozo-600 transition">
                <i class="fa-solid fa-download mr-2"></i>Download Documents
              </button>
            </div>
          </div>
        </div>

        <!-- Coverage Summary -->
        <div class="mb-8">
          <h3 class="text-xl font-bold mb-4">Coverage Summary</h3>
          
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            ${coverageItems.map(item => `
              <div class="card p-5 border-l-4 ${item.color === 'green' ? 'border-l-green-500' : item.color === 'yellow' ? 'border-l-yellow-500' : 'border-l-blue-500'}">
                <div class="flex items-start gap-3">
                  <div class="w-10 h-10 rounded-lg ${item.color === 'green' ? 'bg-orange-100 text-sozo-600' : item.color === 'yellow' ? 'bg-slate-100 text-slate-600' : 'bg-blue-100 text-blue-600'} flex items-center justify-center flex-shrink-0">
                    <i class="fa-solid ${item.icon} text-lg"></i>
                  </div>
                  <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1">
                      <i class="fa-solid fa-check-circle text-${item.color === 'green' ? 'sozo' : 'slate'}-500"></i>
                      <h4 class="font-bold text-slate-900">${item.title}</h4>
                    </div>
                    <p class="text-sm text-slate-600 mb-1">${item.copay}</p>
                    <p class="text-xs font-semibold ${item.color === 'green' ? 'text-sozo-600' : 'text-slate-600'}">${item.status}</p>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>

        <!-- Recent Claims -->
        <div>
          <h3 class="text-xl font-bold mb-4">Recent Claims</h3>
          <!-- Search and Filter Bar -->
          <div class="card p-4 mb-4 bg-slate-50 border-slate-200">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
              <div class="md:col-span-2">
                <label class="text-xs font-bold text-slate-500 uppercase">Search</label>
                <div class="relative mt-1">
                  <i class="fa-solid fa-magnifying-glass absolute left-3 top-3 text-slate-400"></i>
                  <input type="text" id="claimSearch" class="input-royal pl-9" placeholder="Search by claim ID, provider, or service..." />
                </div>
              </div>
              <div>
                <label class="text-xs font-bold text-slate-500 uppercase">Start Date</label>
                <input type="date" id="claimStartDate" class="input-royal mt-1" />
              </div>
              <div>
                <label class="text-xs font-bold text-slate-500 uppercase">End Date</label>
                <input type="date" id="claimEndDate" class="input-royal mt-1" />
              </div>
            </div>
            <div class="flex justify-between items-center mt-3">
              <button id="claimClear" class="text-slate-600 font-bold hover:text-sozo-600 text-sm">
                <i class="fa-solid fa-rotate-left mr-1"></i> Clear filters
              </button>
              <span id="claimCount" class="text-sm text-slate-600 font-semibold"></span>
            </div>
          </div>
          <div class="card p-0 overflow-hidden">
            <table>
              <thead>
                <tr>
                  <th>Claim ID</th>
                  <th>Date of Service</th>
                  <th>Provider</th>
                  <th>Service</th>
                  <th>Amount</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                <tbody id="claimTableBody">
                ${recentClaims.map(claim => `
                  <tr>
                    <td class="font-mono text-xs">${claim.id}</td>
                    <td class="font-semibold">${claim.date}</td>
                    <td class="font-bold text-slate-900">${claim.provider}</td>
                    <td>${claim.service}</td>
                    <td class="font-bold">${claim.amount}</td>
                    <td>
                      <span class="badge ${claim.status === 'Approved' ? 'badge-success' : claim.status === 'Processing' ? 'badge-warning' : 'badge-danger'}">
                        ${claim.status}
                      </span>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    `;
    // Add filter functionality for claims
    setTimeout(() => {
      let filteredClaims = [...recentClaims];
      const tbody = document.getElementById('claimTableBody');
      const searchInput = document.getElementById('claimSearch');
      const startDateInput = document.getElementById('claimStartDate');
      const endDateInput = document.getElementById('claimEndDate');
      const clearBtn = document.getElementById('claimClear');
      const countDisplay = document.getElementById('claimCount');

      function parseClaimDate(dateStr) {
        // Parse "Dec 20, 2024" format
        return new Date(dateStr);
      }

      function applyFilters() {
        const searchTerm = searchInput?.value.toLowerCase() || '';
        const startDate = startDateInput?.value ? new Date(startDateInput.value) : null;
        const endDate = endDateInput?.value ? new Date(endDateInput.value) : null;

        filteredClaims = recentClaims.filter(claim => {
          // Search filter
          const matchesSearch = !searchTerm || 
            claim.id.toLowerCase().includes(searchTerm) ||
            claim.provider.toLowerCase().includes(searchTerm) ||
            claim.service.toLowerCase().includes(searchTerm);

          // Date filter
          const claimDate = parseClaimDate(claim.date);
          const matchesStartDate = !startDate || claimDate >= startDate;
          const matchesEndDate = !endDate || claimDate <= endDate;

          return matchesSearch && matchesStartDate && matchesEndDate;
        });

        renderClaims();
      }

      function renderClaims() {
        if (!tbody) return;

        if (filteredClaims.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="6" class="text-center py-8 text-slate-500">
                <i class="fa-solid fa-search text-3xl mb-2"></i>
                <p class="font-semibold">No claims found</p>
                <p class="text-sm">Try adjusting your filters</p>
              </td>
            </tr>
          `;
        } else {
          tbody.innerHTML = filteredClaims.map(claim => `
            <tr>
              <td class="font-mono text-xs">${claim.id}</td>
              <td class="font-semibold">${claim.date}</td>
              <td class="font-bold text-slate-900">${claim.provider}</td>
              <td>${claim.service}</td>
              <td class="font-bold">${claim.amount}</td>
              <td>
                <span class="badge ${claim.status === 'Approved' ? 'badge-success' : claim.status === 'Processing' ? 'badge-warning' : 'badge-danger'}">
                  ${claim.status}
                </span>
              </td>
            </tr>
          `).join('');
        }

        if (countDisplay) {
          countDisplay.textContent = `Showing ${filteredClaims.length} of ${recentClaims.length} claims`;
        }
      }

      // Event listeners
      searchInput?.addEventListener('input', applyFilters);
      startDateInput?.addEventListener('change', applyFilters);
      endDateInput?.addEventListener('change', applyFilters);
      
      clearBtn?.addEventListener('click', () => {
        if (searchInput) searchInput.value = '';
        if (startDateInput) startDateInput.value = '';
        if (endDateInput) endDateInput.value = '';
        applyFilters();
      });

      // Initial render
      renderClaims();
    }, 50);
  }
  else if (key === 'reports') {
    const p = getActivePatient();
    const userReports = patientReports.filter(r => r.patient === p.name);

    area.innerHTML = `
      <div class="p-8">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4">
          <div>
            <h2 class="text-2xl font-bold">My Medical Reports</h2>
            <p class="text-slate-500">Search, filter, and download your reports</p>
          </div>
          <div id="patientReportCount" class="text-sm text-slate-600 font-bold"></div>
        </div>

        <!-- Category Filter Tabs -->
        <div class="flex gap-2 mb-4">
          <button class="sort-btn active" data-category="all" onclick="filterReportCategory('all')">
            <i class="fa-solid fa-list mr-1"></i>All Reports
          </button>
          <button class="sort-btn" data-category="general" onclick="filterReportCategory('general')">
            <i class="fa-solid fa-hospital mr-1"></i>General Reports
          </button>
          <button class="sort-btn" data-category="sozo" onclick="filterReportCategory('sozo')">
            <i class="fa-solid fa-brain-circuit mr-1"></i>Sozo Related
          </button>
        </div>

        <div class="card p-4 mb-4 bg-slate-50 border-slate-200">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
            <div class="md:col-span-2">
              <label class="text-xs font-bold text-slate-500 uppercase">Search</label>
              <div class="relative mt-1">
                <i class="fa-solid fa-magnifying-glass absolute left-3 top-3 text-slate-400"></i>
                <input type="text" id="patientReportSearch" class="input-royal pl-9" placeholder="Search by type, doctor, or ID" />
              </div>
            </div>
            <div>
              <label class="text-xs font-bold text-slate-500 uppercase">Start Date</label>
              <input type="date" id="patientReportStart" class="input-royal mt-1" />
            </div>
            <div>
              <label class="text-xs font-bold text-slate-500 uppercase">End Date</label>
              <input type="date" id="patientReportEnd" class="input-royal mt-1" />
            </div>
          </div>
          <div class="flex justify-between items-center mt-3 text-sm">
            <button id="patientReportClear" class="text-slate-600 font-bold hover:text-sozo-600">
              <i class="fa-solid fa-rotate-left mr-1"></i> Clear filters
            </button>
            <button id="uploadHistoricalRecord" class="btn-primary text-sm">
              <i class="fa-solid fa-upload mr-2"></i> Upload Historical Record
            </button>
          </div>
        </div>

        <div class="card p-0 overflow-hidden">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Report Type</th>
                <th>Category</th>
                <th>Doctor</th>
                <th>Report ID</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="patientReportsBody"></tbody>
          </table>
        </div>
      </div>
    `;

    setTimeout(() => {
      const tbody = document.getElementById('patientReportsBody');
      const searchInput = document.getElementById('patientReportSearch');
      const startInput = document.getElementById('patientReportStart');
      const endInput = document.getElementById('patientReportEnd');
      const countEl = document.getElementById('patientReportCount');
      const clearBtn = document.getElementById('patientReportClear');
      
      let currentCategory = 'all';
      
      // Define report categories
      const sozoReports = ['FNON Report', 'PRS Report', 'Final Report'];
      const generalReports = ['CT Scan', 'MRI', 'Blood Work', 'X-Ray', 'ECG Report', 'Ultrasound', 'Mammography', 'Bone Density', 'Thyroid Panel', 'Lipid Panel', 'Vitamin D Test'];
      
      function getReportCategory(reportType) {
        if (sozoReports.includes(reportType)) return 'sozo';
        if (generalReports.includes(reportType)) return 'general';
        return 'general'; // default to general for any other reports
      }
      
      function getCategoryBadge(category) {
        if (category === 'sozo') {
          return '<span class="badge badge-sozo"><i class="fa-solid fa-brain-circuit mr-1"></i>Sozo</span>';
        }
        return '<span class="badge badge-info"><i class="fa-solid fa-hospital mr-1"></i>General</span>';
      }
      
      window.filterReportCategory = function(category) {
        currentCategory = category;
        document.querySelectorAll('[data-category]').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`[data-category="${category}"]`).classList.add('active');
        applyFilters();
      };

      function applyFilters() {
        const query = (searchInput?.value || '').toLowerCase();
        const start = startInput?.value ? new Date(startInput.value) : null;
        const end = endInput?.value ? new Date(endInput.value) : null;
        if(end) end.setHours(23,59,59,999);

        const filtered = userReports.filter(r => {
          // Category filter
          const reportCategory = getReportCategory(r.type);
          if (currentCategory !== 'all' && reportCategory !== currentCategory) return false;
          
          const reportDate = new Date(r.date);
          if(start && reportDate < start) return false;
          if(end && reportDate > end) return false;

          if(query) {
            const haystack = `${r.type} ${r.doctor} ${r.id}`.toLowerCase();
            if(!haystack.includes(query)) return false;
          }
          return true;
        });

        if(tbody) {
          tbody.innerHTML = filtered.map(r => {
            const category = getReportCategory(r.type);
            return `
            <tr>
              <td>${r.date}</td>
              <td>${r.type}</td>
              <td>${getCategoryBadge(category)}</td>
              <td>${r.doctor}</td>
              <td class="font-mono text-sm">${r.id}</td>
              <td><span class="badge ${r.status==='Finalized' ? 'badge-success' : 'badge-warning'}">${r.status}</span></td>
              <td><button class="text-sozo-600 font-bold" onclick="alert('Downloading ${r.id}.pdf')"><i class="fa-solid fa-download"></i> PDF</button></td>
            </tr>
          `}).join('') || '<tr><td colspan="7" class="p-8 text-center text-slate-500">No reports found for your filters</td></tr>';
        }

        if(countEl) {
          countEl.textContent = `Showing ${filtered.length} of ${userReports.length} reports`;
        }
      }

      searchInput?.addEventListener('input', applyFilters);
      startInput?.addEventListener('change', applyFilters);
      endInput?.addEventListener('change', applyFilters);
      clearBtn?.addEventListener('click', () => {
        if(searchInput) searchInput.value = '';
        if(startInput) startInput.value = '';
        if(endInput) endInput.value = '';
        currentCategory = 'all';
        document.querySelectorAll('[data-category]').forEach(btn => btn.classList.remove('active'));
        document.querySelector('[data-category="all"]').classList.add('active');
        applyFilters();
      });

      // Upload Historical Record button handler
      document.getElementById('uploadHistoricalRecord')?.addEventListener('click', () => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.pdf,.doc,.docx,.jpg,.png';
        input.multiple = true;
        input.onchange = (e) => {
          const files = Array.from(e.target.files);
          if(files.length > 0) {
            alert(`Uploading ${files.length} file(s): ${files.map(f => f.name).join(', ')}\n\nFiles will be added to your medical history.`);
            // In production, upload to server here
          }
        };
        input.click();
      });

      applyFilters();
    }, 50);
  }
  else if (key === 'profileoverview') renderProfile();
  else if (key === 'doctornotes') renderDoctorNotes();
  else if (key === 'eshop') renderShopView();
  else if (key === 'devices') {
    // When devices is clicked as a sub-item under profile, show only devices
    renderDevicesOnly();
  }
  else if (key === 'marketplace') renderShopView();
}

// Helper function to render profile with optional active tab
function renderProfile(activeTab = 'overview') {
  const key = 'profile';
  const p = getActivePatient();
  const area = document.getElementById('contentArea');
  area.innerHTML = ''; // Clear
  area.classList.remove('content-fade');
  void area.offsetWidth; // Trigger reflow
  area.classList.add('content-fade');

  renderPatient(key);
  
  // Set active tab after content is rendered
  setTimeout(() => {
    const tabButton = document.querySelector(`[data-tab="${activeTab}"]`);
    if (tabButton) {
      document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.profile-tab').forEach(t => t.style.borderBottomColor = 'transparent');
      tabButton.classList.add('active');
      tabButton.style.borderBottomColor = '#ea580c';
      
      document.querySelectorAll('.profile-content').forEach(c => c.classList.add('hidden'));
      const tabId = 'tab-' + activeTab;
      const tabContent = document.getElementById(tabId);
      if (tabContent) {
        tabContent.classList.remove('hidden');
      }
    }
  }, 100);
}

// Helper function to render only devices information
function renderDevicesOnly() {
  const area = document.getElementById('contentArea');
  area.innerHTML = '';
  area.classList.remove('content-fade');
  void area.offsetWidth;
  area.classList.add('content-fade');
  
  area.innerHTML = `
    <div class="p-8 max-w-5xl mx-auto">
      <div class="mb-8">
        <h2 class="text-3xl font-bold text-slate-900">My Connected Devices</h2>
        <p class="text-slate-500 mt-2">Manage and monitor all your connected Sozo devices</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div class="card p-4 border-2 border-sozo-600 bg-orange-50">
          <div class="flex items-start justify-between mb-3">
            <div>
              <p class="font-bold text-slate-900">Sozo Watch Pro</p>
              <p class="text-xs text-slate-600">Serial: SWP-2024-001</p>
            </div>
            <span class="badge badge-success text-xs">Connected</span>
          </div>
          <p class="text-sm text-slate-700 mb-2">Advanced HRV & Sleep Tracking</p>
          <p class="text-xs text-slate-600 mb-3">Battery: 85% • Last sync: 2 hours ago</p>
          <div class="flex gap-2">
            <button class="text-sm px-3 py-1 rounded bg-orange-200 text-orange-800 hover:bg-orange-300 font-bold transition"><i class="fa-solid fa-gear mr-1"></i>Settings</button>
            <button class="text-sm px-3 py-1 rounded bg-slate-100 text-slate-700 hover:bg-slate-200 font-bold transition"><i class="fa-solid fa-link-slash mr-1"></i>Unpair</button>
          </div>
        </div>

        <div class="card p-4 border-2 border-blue-500 bg-blue-50">
          <div class="flex items-start justify-between mb-3">
            <div>
              <p class="font-bold text-slate-900">Sozo Ring</p>
              <p class="text-xs text-slate-600">Serial: SR-2024-042</p>
            </div>
            <span class="badge badge-success text-xs">Connected</span>
          </div>
          <p class="text-sm text-slate-700 mb-2">Discreet Biometric Monitor</p>
          <p class="text-xs text-slate-600 mb-3">Battery: 72% • Last sync: 30 minutes ago</p>
          <div class="flex gap-2">
            <button class="text-sm px-3 py-1 rounded bg-blue-200 text-blue-800 hover:bg-blue-300 font-bold transition"><i class="fa-solid fa-gear mr-1"></i>Settings</button>
            <button class="text-sm px-3 py-1 rounded bg-slate-100 text-slate-700 hover:bg-slate-200 font-bold transition"><i class="fa-solid fa-link-slash mr-1"></i>Unpair</button>
          </div>
        </div>

        <div class="card p-4 border-2 border-slate-600 bg-slate-50">
          <div class="flex items-start justify-between mb-3">
            <div>
              <p class="font-bold text-slate-900">NeuroScan Headset</p>
              <p class="text-xs text-slate-600">Serial: NSH-2024-015</p>
            </div>
            <span class="badge badge-success text-xs">Connected</span>
          </div>
          <p class="text-sm text-slate-700 mb-2">Portable EEG for Home Use</p>
          <p class="text-xs text-slate-600 mb-3">Battery: 45% • Last sync: 1 hour ago</p>
          <div class="flex gap-2">
            <button class="text-sm px-3 py-1 rounded bg-slate-200 text-slate-800 hover:bg-slate-300 font-bold transition"><i class="fa-solid fa-gear mr-1"></i>Settings</button>
            <button class="text-sm px-3 py-1 rounded bg-slate-100 text-slate-700 hover:bg-slate-200 font-bold transition"><i class="fa-solid fa-link-slash mr-1"></i>Unpair</button>
          </div>
        </div>

        <div class="card p-4 border-2 border-slate-300 bg-slate-50 flex flex-col items-center justify-center min-h-32 cursor-pointer hover:bg-slate-100 transition">
          <div class="text-center">
            <p class="font-bold text-slate-900 mb-1">Add New Device</p>
            <p class="text-xs text-slate-600 mb-3">Connect additional devices</p>
            <button class="text-sm px-4 py-2 rounded bg-sozo-500 text-white hover:bg-sozo-600 font-bold transition"><i class="fa-solid fa-plus mr-1"></i>Add Device</button>
          </div>
        </div>
      </div>

      <div class="card p-4 bg-blue-50 border border-blue-200 mb-6">
        <p class="text-sm text-blue-900"><strong><i class="fa-solid fa-lightbulb mr-2"></i>Tip:</strong> Keep your devices updated for the best experience. Check for firmware updates regularly in device settings.</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="card p-4">
          <h4 class="font-bold text-slate-800 mb-2 flex items-center gap-2">
            <i class="fa-solid fa-battery-full text-sozo-600"></i> Device Health
          </h4>
          <p class="text-2xl font-bold text-sozo-600 mb-1">98%</p>
          <p class="text-xs text-slate-500">All devices functioning optimally</p>
        </div>
        <div class="card p-4">
          <h4 class="font-bold text-slate-800 mb-2 flex items-center gap-2">
            <i class="fa-solid fa-sync text-blue-600"></i> Last Sync
          </h4>
          <p class="text-2xl font-bold text-blue-600 mb-1">30 min</p>
          <p class="text-xs text-slate-500">Updated 30 minutes ago</p>
        </div>
        <div class="card p-4">
          <h4 class="font-bold text-slate-800 mb-2 flex items-center gap-2">
            <i class="fa-solid fa-database text-sozo-600"></i> Storage Used
          </h4>
          <p class="text-2xl font-bold text-sozo-600 mb-1">2.4 GB</p>
          <p class="text-xs text-slate-500">of 10 GB available</p>
        </div>
      </div>
    </div>
  `;
}

// ==========================================
// PRS ASSESSMENT MODULE
// ==========================================

// Initialize custom PRS fields in global state
if (!globalState.customPRSFields) {
  globalState.customPRSFields = {};
}

const PRS_QUESTIONNAIRES = {
  tinnitus: {
    title: 'Tinnitus Assessment',
    sections: [
      {
        title: 'Section 1 - General Data',
        questions: [
          { id: 'assessment_date', type: 'date', label: '1. Date of assessment *', required: true },
          { id: 'doctor_email', type: 'email', label: '2. Doctor Email *', required: true },
          { id: 'patient_name', type: 'text', label: '3. Patient Name and Surname *', required: true },
          { id: 'patient_id', type: 'text', label: '4. Patient ID *', required: true },
          { id: 'patient_age', type: 'radio', label: '5. Patient Age *', required: true, options: [
            { value: '<18', label: '< 18' },
            { value: '18-25', label: '18-25' },
            { value: '26-35', label: '26-35' },
            { value: '36-45', label: '36-45' },
            { value: '46-55', label: '46-55' },
            { value: '56-65', label: '56-65' },
            { value: '>65', label: '> 65' }
          ]},
          { id: 'gender', type: 'radio', label: '6. Gender *', required: true, options: [
            { value: 'male', label: 'Male' },
            { value: 'female', label: 'Female' },
            { value: 'non-binary', label: 'Non-binary' }
          ]},
          { id: 'visit_type', type: 'radio', label: '7. Please choose one of the following options *', required: true, options: [
            { value: 'first', label: 'First visit' },
            { value: 'followup1', label: 'Follow-up visit 1' },
            { value: 'followup2', label: 'Follow-up visit 2' },
            { value: 'followup3', label: 'Follow-up visit 3' }
          ]}
        ]
      },
      {
        title: 'Section 2 - EQ-5D-5L Health Questionnaire',
        questions: [
          { id: 'fill_eq5d', type: 'radio', label: '8. Do you want to fill in EQ-5D-5L questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'eq5d_mobility', type: 'likert', label: '9. Mobility *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, options: [
            '(1) I have no problems in walking about',
            '(2) I have slight problems in walking about',
            '(3) I have moderate problems in walking about',
            '(4) I have severe problems in walking about',
            '(5) I am unable to walk about'
          ]},
          { id: 'eq5d_self_care', type: 'likert', label: '10. Self Care *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, options: [
            '(1) I have no problems washing or dressing myself',
            '(2) I have slight problems washing or dressing myself',
            '(3) I have moderate problems washing or dressing myself',
            '(4) I have severe problems washing or dressing myself',
            '(5) I am unable to wash or dress myself'
          ]},
          { id: 'eq5d_usual_activities', type: 'likert', label: '11. Usual activities (e.g. work, study, housework, family or leisure activities) *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, options: [
            '(1) I have no problems doing my usual activities',
            '(2) I have slight problems doing my usual activities',
            '(3) I have moderate problems doing my usual activities',
            '(4) I have severe problems doing my usual activities',
            '(5) I am unable to do my usual activities'
          ]},
          { id: 'eq5d_pain', type: 'likert', label: '12. Pain/Discomfort *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, options: [
            '(1) I have no pain or discomfort',
            '(2) I have slight pain or discomfort',
            '(3) I have moderate pain or discomfort',
            '(4) I have severe pain or discomfort',
            '(5) I have extreme pain or discomfort'
          ]},
          { id: 'eq5d_anxiety', type: 'likert', label: '13. Anxiety/Depression *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, options: [
            '(1) I am not anxious or depressed',
            '(2) I am slightly anxious or depressed',
            '(3) I am moderately anxious or depressed',
            '(4) I am severely anxious or depressed',
            '(5) I am extremely anxious or depressed'
          ]},
          { id: 'eq5d_health_today', type: 'slider', label: '14. We would like to know how good or bad your health is TODAY (0=worst health you can imagine, 10=best health you can imagine) *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, min: 0, max: 10 }
        ]
      },
      {
        title: 'Section 3 - COMPASS 31',
        questions: [
          { id: 'fill_compass31', type: 'radio', label: '15. Do you want to fill in COMPASS 31 questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'compass31_q16', type: 'radio', label: '16. In the past year, have you ever felt faint, dizzy, "goofy", or had difficulty thinking soon after standing up from a sitting or lying position? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            { value: '1', label: '(1) Yes' },
            { value: '2', label: '(2) No' }
          ]},
          { id: 'compass31_q17', type: 'likert', label: '17. When standing up, how frequently do you get these feelings or symptoms? *', required: true, showIf: { field: 'compass31_q16', value: '1' }, options: [
            '(1) Rarely',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Almost Always'
          ]},
          { id: 'compass31_q18', type: 'likert', label: '18. How would you rate the severity of these feelings or symptoms? *', required: true, showIf: { field: 'compass31_q16', value: '1' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_q19', type: 'likert', label: '19. In the past year, have these feelings or symptoms that you have experienced: *', required: true, showIf: { field: 'compass31_q16', value: '1' }, options: [
            '(1) Gotten much worse',
            '(2) Gotten somewhat worse',
            '(3) Stayed about the same',
            '(4) Gotten somewhat better',
            '(5) Gotten much better Completely gone'
          ]},
          { id: 'compass31_q20', type: 'radio', label: '20. In the past year, have you ever noticed color changes in your skin, such as red, white, or purple? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            { value: '1', label: '(1) Yes' },
            { value: '2', label: '(2) No' }
          ]},
          { id: 'compass31_q21', type: 'checkbox', label: '21. What parts of your body are affected by these color changes? (Check all that apply) *', required: true, showIf: { field: 'compass31_q20', value: '1' }, options: [
            { value: 'hands', label: '(1) Hands' },
            { value: 'feet', label: '(2) Feet' }
          ]},
          { id: 'compass31_q22', type: 'likert', label: '22. Are these changes in your skin color: *', required: true, showIf: { field: 'compass31_q20', value: '1' }, options: [
            '(1) Getting much worse',
            '(2) Getting somewhat worse',
            '(3) Staying about the same',
            '(4) Getting somewhat better',
            '(5) Getting much better',
            '(6) Completely gone'
          ]},
          { id: 'compass31_q23', type: 'likert', label: '23. In the past 5 years, what changes, if any, have occurred in your general body sweating? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) I sweat much more than I used to',
            '(2) I sweat somewhat more than I used to',
            '(3) I haven\'t noticed any changes in my sweating',
            '(4) I sweat somewhat less than I used to',
            '(5) I sweat much less than I used to'
          ]},
          { id: 'compass31_q24', type: 'radio', label: '24. Do your eyes feel excessively dry? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            { value: '1', label: '(1) Yes' },
            { value: '2', label: '(2) No' }
          ]},
          { id: 'compass31_q25', type: 'radio', label: '25. Does your mouth feel excessively dry? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            { value: '1', label: '(1) Yes' },
            { value: '2', label: '(2) No' }
          ]},
          { id: 'compass31_q26', type: 'likert', label: '26. For the symptom of dry eyes or dry mouth that you have had for the longest period of time, is this symptom: *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) I have not had any of these symptoms',
            '(2) Getting much worse',
            '(3) Getting somewhat worse',
            '(4) Staying about the same',
            '(5) Getting somewhat better',
            '(6) Getting much better',
            '(7) Completely gone'
          ]},
          { id: 'compass31_q27', type: 'likert', label: '27. In the past year, have you noticed any changes in how quickly you get full when eating a meal? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) I get full a lot more quickly now than I used to',
            '(2) I get full more quickly now than I used to',
            '(3) I haven\'t noticed any change',
            '(4) I get full less quickly now than I used to',
            '(5) I get full a lot less quickly now than I used to'
          ]},
          { id: 'compass31_q28', type: 'likert', label: '28. In the past year, have you felt excessively full or persistently full (bloated feeling) after a meal? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Sometimes',
            '(3) A lot of times'
          ]},
          { id: 'compass31_q29', type: 'likert', label: '29. In the past year, have you vomited after a meal? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Sometimes',
            '(3) A lot of time'
          ]},
          { id: 'compass31_q30', type: 'likert', label: '30. In the past year, have you had a cramping or colicky abdominal pain? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Sometimes',
            '(3) A lot of times'
          ]},
          { id: 'compass31_q31', type: 'radio', label: '31. In the past year, have you had any bouts of diarrhea? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            { value: '1', label: '(1) Yes' },
            { value: '2', label: '(2) No' }
          ]},
          { id: 'compass31_q32', type: 'likert', label: '32. How frequently does this occur? *', required: true, showIf: { field: 'compass31_q31', value: '1' }, options: [
            '(1) Rarely',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_q33', type: 'likert', label: '33. How severe are these bouts of diarrhea? *', required: true, showIf: { field: 'compass31_q31', value: '1' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_q34', type: 'likert', label: '34. Are your bouts of diarrhea getting: *', required: true, showIf: { field: 'compass31_q31', value: '1' }, options: [
            '(1) Much worse',
            '(2) Somewhat worse',
            '(3) Staying the same',
            '(4) Much better',
            '(5) Completely gone'
          ]},
          { id: 'compass31_q35', type: 'radio', label: '35. In the past year, have you been constipated? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            { value: '1', label: '(1) Yes' },
            { value: '2', label: '(2) No' }
          ]},
          { id: 'compass31_q36', type: 'likert', label: '36. How frequently are you constipated? *', required: true, showIf: { field: 'compass31_q35', value: '1' }, options: [
            '(1) Rarely',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_q37', type: 'likert', label: '37. How severe are these episodes of constipation? *', required: true, showIf: { field: 'compass31_q35', value: '1' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_q38', type: 'likert', label: '38. Is your constipation getting: *', required: true, showIf: { field: 'compass31_q35', value: '1' }, options: [
            '(1) Much worse',
            '(2) Somewhat worse',
            '(3) Staying the same',
            '(4) Somewhat better',
            '(5) Much better',
            '(6) Completely gone'
          ]},
          { id: 'compass31_q39', type: 'likert', label: '39. In the past year, have you ever lost control of your bladder function? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_q40', type: 'likert', label: '40. In the past year, have you had difficulty passing urine? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_q41', type: 'likert', label: '41. In the past year, have you had trouble completely emptying your bladder? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_q42', type: 'likert', label: '42. In the past year, without sunglasses or tinted glasses, has bright light bothered your eyes? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_q43', type: 'likert', label: '43. How severe is this sensitivity to bright light? *', required: true, showIf: { field: 'compass31_q42', value: '1' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_q43', type: 'likert', label: '43. How severe is this sensitivity to bright light? *', required: true, showIf: { field: 'compass31_q42', value: '2' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_q43', type: 'likert', label: '43. How severe is this sensitivity to bright light? *', required: true, showIf: { field: 'compass31_q42', value: '3' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_q44', type: 'likert', label: '44. In the past year, have you had trouble focusing your eyes? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_q45', type: 'likert', label: '45. How severe is this focusing problem? *', required: true, showIf: { field: 'compass31_q44', value: '1' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_q45', type: 'likert', label: '45. How severe is this focusing problem? *', required: true, showIf: { field: 'compass31_q44', value: '2' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_q45', type: 'likert', label: '45. How severe is this focusing problem? *', required: true, showIf: { field: 'compass31_q44', value: '3' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_q46', type: 'likert', label: '46. Is the most troublesome symptom with your eyes (i.e. sensitivity to bright light or trouble focusing) getting: *', required: true, showIf: { field: 'compass31_q44', value: '0' }, options: [
            '(1) I have not had any of these symptoms',
            '(2) Much worse',
            '(3) Somewhat worse',
            '(4) Staying about the same',
            '(5) Somewhat better',
            '(6) Much better',
            '(7) Completely gone'
          ]},
          { id: 'compass31_q46', type: 'likert', label: '46. Is the most troublesome symptom with your eyes (i.e. sensitivity to bright light or trouble focusing) getting: *', required: true, showIf: { field: 'compass31_q45', value: '0' }, options: [
            '(1) I have not had any of these symptoms',
            '(2) Much worse',
            '(3) Somewhat worse',
            '(4) Staying about the same',
            '(5) Somewhat better',
            '(6) Much better',
            '(7) Completely gone'
          ]},
          { id: 'compass31_q46', type: 'likert', label: '46. Is the most troublesome symptom with your eyes (i.e. sensitivity to bright light or trouble focusing) getting: *', required: true, showIf: { field: 'compass31_q45', value: '1' }, options: [
            '(1) I have not had any of these symptoms',
            '(2) Much worse',
            '(3) Somewhat worse',
            '(4) Staying about the same',
            '(5) Somewhat better',
            '(6) Much better',
            '(7) Completely gone'
          ]},
          { id: 'compass31_q46', type: 'likert', label: '46. Is the most troublesome symptom with your eyes (i.e. sensitivity to bright light or trouble focusing) getting: *', required: true, showIf: { field: 'compass31_q45', value: '2' }, options: [
            '(1) I have not had any of these symptoms',
            '(2) Much worse',
            '(3) Somewhat worse',
            '(4) Staying about the same',
            '(5) Somewhat better',
            '(6) Much better',
            '(7) Completely gone'
          ]}
        ]
      },
      {
        title: 'Section 4 - THI (Tinnitus Handicap Inventory)',
        questions: [
          { id: 'fill_thi', type: 'radio', label: '47. Do you want to fill in THI questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'thi_q1', type: 'likert', label: '48. Because of your tinnitus, is it difficult for you to concentrate? *', required: true, showIf: { field: 'fill_thi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'thi_q2', type: 'likert', label: '49. Because of the loudness of your tinnitus, is it difficult for you to hear people? *', required: true, showIf: { field: 'fill_thi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'thi_q3', type: 'likert', label: '50. Does your tinnitus make you angry? *', required: true, showIf: { field: 'fill_thi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'thi_q4', type: 'likert', label: '51. Does your tinnitus make you feel confused? *', required: true, showIf: { field: 'fill_thi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'thi_q5', type: 'likert', label: '52. Because of your tinnitus, do you feel desperate? *', required: true, showIf: { field: 'fill_thi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'thi_q6', type: 'likert', label: '53. Do you complain a great deal about your tinnitus? *', required: true, showIf: { field: 'fill_thi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'thi_q7', type: 'likert', label: '54. Because of your tinnitus, do you have trouble falling asleep at night? *', required: true, showIf: { field: 'fill_thi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'thi_q8', type: 'likert', label: '55. Do you feel as though you cannot escape from your tinnitus? *', required: true, showIf: { field: 'fill_thi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'thi_q9', type: 'likert', label: '56. Does your tinnitus interfere with your ability to enjoy social activities (such as going out to dinner, to the movies)? *', required: true, showIf: { field: 'fill_thi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'thi_q10', type: 'likert', label: '57. Because of your tinnitus, do you feel frustrated? *', required: true, showIf: { field: 'fill_thi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'thi_q11', type: 'likert', label: '58. Because of your tinnitus, do you feel that you have a terrible disease? *', required: true, showIf: { field: 'fill_thi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'thi_q12', type: 'likert', label: '59. Does your tinnitus make it difficult for you to enjoy life? *', required: true, showIf: { field: 'fill_thi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'thi_q13', type: 'likert', label: '60. Does your tinnitus interfere with your job or household responsibilities? *', required: true, showIf: { field: 'fill_thi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'thi_q14', type: 'likert', label: '61. Because of your tinnitus, do you find that you are often irritable? *', required: true, showIf: { field: 'fill_thi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'thi_q15', type: 'likert', label: '62. Because of your tinnitus, is it difficult for you to read? *', required: true, showIf: { field: 'fill_thi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'thi_q16', type: 'likert', label: '63. Does your tinnitus make you upset? *', required: true, showIf: { field: 'fill_thi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'thi_q17', type: 'likert', label: '64. Do you feel that your tinnitus problem has placed stress on your relationships with members of your family and friends? *', required: true, showIf: { field: 'fill_thi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'thi_q18', type: 'likert', label: '65. Do you find it difficult to focus your attention away from your tinnitus and on other things? *', required: true, showIf: { field: 'fill_thi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'thi_q19', type: 'likert', label: '66. Do you feel that you have no control over your tinnitus? *', required: true, showIf: { field: 'fill_thi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'thi_q20', type: 'likert', label: '67. Because of your tinnitus, do you often feel tired? *', required: true, showIf: { field: 'fill_thi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'thi_q21', type: 'likert', label: '68. Because of your tinnitus, do you feel depressed? *', required: true, showIf: { field: 'fill_thi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'thi_q22', type: 'likert', label: '69. Does your tinnitus make you feel anxious? *', required: true, showIf: { field: 'fill_thi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'thi_q23', type: 'likert', label: '70. Do you feel that you can no longer cope with your tinnitus? *', required: true, showIf: { field: 'fill_thi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'thi_q24', type: 'likert', label: '71. Does your tinnitus get worse when you are stressed? *', required: true, showIf: { field: 'fill_thi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'thi_q25', type: 'likert', label: '72. Does your tinnitus make you feel insecure? *', required: true, showIf: { field: 'fill_thi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]}
        ]
      },
      {
        title: 'Section 5 - DASS-21 (Depression, Anxiety and Stress Scale)',
        questions: [
          { id: 'fill_dass21', type: 'radio', label: '73. Do you want to fill in DASS-21 questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'dass21_q1', type: 'likert', label: '74. I found it hard to wind down *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_q2', type: 'likert', label: '75. I was aware of dryness of my mouth *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_q3', type: 'likert', label: '76. I couldn\'t seem to experience any positive feeling at all *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_q4', type: 'likert', label: '77. I experienced breathing difficulty (e.g. excessively rapid breathing, breathlessness in the absence of physical exertion) *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_q5', type: 'likert', label: '78. I found it difficult to work up the initiative to do things *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_q6', type: 'likert', label: '79. I tended to over-react to situations *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_q7', type: 'likert', label: '80. I experienced trembling (e.g. in the hands) *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_q8', type: 'likert', label: '81. I felt that I was using a lot of nervous energy *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_q9', type: 'likert', label: '82. I was worried about situations in which I might panic and make a fool of myself *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_q10', type: 'likert', label: '83. I felt that I had nothing to look forward to *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_q11', type: 'likert', label: '84. I found myself getting agitated *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_q12', type: 'likert', label: '85. I found it difficult to relax *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_q13', type: 'likert', label: '86. I felt down-hearted and blue *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_q14', type: 'likert', label: '87. I was intolerant of anything that kept me from getting on with what I was doing *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_q15', type: 'likert', label: '88. I felt I was close to panic *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_q16', type: 'likert', label: '89. I was unable to become enthusiastic about anything *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_q17', type: 'likert', label: '90. I felt I wasn\'t worth much as a person *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_q18', type: 'likert', label: '91. I felt that I was rather touchy *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_q19', type: 'likert', label: '92. I was aware of the action of my heart in the absence of physical exertion (e.g. sense of heart rate increase, heart missing a beat) *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_q20', type: 'likert', label: '93. I felt scared without any good reason *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_q21', type: 'likert', label: '94. I felt that life was meaningless *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of time',
            '(3) Applied to me very much or most of the time'
          ]}
        ]
      },
      {
        title: 'Section 6 - GAD-7 (Generalized Anxiety Disorder)',
        questions: [
          { id: 'fill_gad7', type: 'radio', label: '95. Do you want to fill in GAD-7 questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'gad7_q1', type: 'likert', label: '96. Over the last two weeks feeling nervous, anxious, or on edge *', required: true, showIf: { field: 'fill_gad7', value: 'yes' }, options: [
            '(0) Not at all',
            '(1) Several days',
            '(2) More than half of the days',
            '(3) Nearly every day'
          ]},
          { id: 'gad7_q2', type: 'likert', label: '97. Over the last two weeks not being able to stop or control worrying *', required: true, showIf: { field: 'fill_gad7', value: 'yes' }, options: [
            '(0) Not at all',
            '(1) Several days',
            '(2) More than half of the days',
            '(3) Nearly every day'
          ]},
          { id: 'gad7_q3', type: 'likert', label: '98. Over the last two weeks worrying too much about different things *', required: true, showIf: { field: 'fill_gad7', value: 'yes' }, options: [
            '(0) Not at all',
            '(1) Several days',
            '(2) More than half of the days',
            '(3) Nearly every day'
          ]},
          { id: 'gad7_q4', type: 'likert', label: '99. Over the last two weeks trouble relaxing *', required: true, showIf: { field: 'fill_gad7', value: 'yes' }, options: [
            '(0) Not at all',
            '(1) Several days',
            '(2) More than half of the days',
            '(3) Nearly every day'
          ]},
          { id: 'gad7_q5', type: 'likert', label: '100. Over the last two weeks being so restless that it is hard to sit still *', required: true, showIf: { field: 'fill_gad7', value: 'yes' }, options: [
            '(0) Not at all',
            '(1) Several days',
            '(2) More than half of the days',
            '(3) Nearly every day'
          ]},
          { id: 'gad7_q6', type: 'likert', label: '101. Over the last two weeks becoming easily annoyed or irritable *', required: true, showIf: { field: 'fill_gad7', value: 'yes' }, options: [
            '(0) Not at all',
            '(1) Several days',
            '(2) More than half of the days',
            '(3) Nearly every day'
          ]},
          { id: 'gad7_q7', type: 'likert', label: '102. Over the last two weeks feeling afraid, as if something awful might happen *', required: true, showIf: { field: 'fill_gad7', value: 'yes' }, options: [
            '(0) Not at all',
            '(1) Several days',
            '(2) More than half of the days',
            '(3) Nearly every day'
          ]}
        ]
      },
      {
        title: 'Section 7 - PSQI (Pittsburgh Sleep Quality Index)',
        questions: [
          { id: 'fill_psqi', type: 'radio', label: '103. Do you want to fill in PSQI questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'psqi_q1', type: 'radio', label: '104. During the past month, what time have you usually gone to bed at night? (24-Hour Time Format) *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            { value: '21:00', label: '21:00' },
            { value: '22:00', label: '22:00' },
            { value: '23:00', label: '23:00' },
            { value: '24:00', label: '24:00' },
            { value: '1:00', label: '1:00' },
            { value: '2:00', label: '2:00' },
            { value: '3:00', label: '3:00' },
            { value: '4:00', label: '4:00' },
            { value: '5:00', label: '5:00' },
            { value: '6:00', label: '6:00' },
            { value: '7:00', label: '7:00' },
            { value: '8:00', label: '8:00' },
            { value: '9:00', label: '9:00' },
            { value: '10:00', label: '10:00' },
            { value: '11:00', label: '11:00' },
            { value: '12:00', label: '12:00' },
            { value: '13:00', label: '13:00' },
            { value: '14:00', label: '14:00' },
            { value: '15:00', label: '15:00' },
            { value: '16:00', label: '16:00' },
            { value: '17:00', label: '17:00' },
            { value: '18:00', label: '18:00' },
            { value: '19:00', label: '19:00' },
            { value: '20:00', label: '20:00' }
          ]},
          { id: 'psqi_q2', type: 'slider', label: '105. During the past month, how long (in minutes) has it taken you to fall asleep each night? (0-180 minutes) *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, min: 0, max: 180 },
          { id: 'psqi_q3', type: 'radio', label: '106. During the past month, what time have you usually gotten up in the morning? (24-Hour Time Format) *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            { value: '4:00', label: '4:00' },
            { value: '5:00', label: '5:00' },
            { value: '6:00', label: '6:00' },
            { value: '7:00', label: '7:00' },
            { value: '8:00', label: '8:00' },
            { value: '9:00', label: '9:00' },
            { value: '10:00', label: '10:00' },
            { value: '11:00', label: '11:00' },
            { value: '12:00', label: '12:00' },
            { value: '13:00', label: '13:00' },
            { value: '14:00', label: '14:00' },
            { value: '15:00', label: '15:00' },
            { value: '16:00', label: '16:00' },
            { value: '17:00', label: '17:00' },
            { value: '18:00', label: '18:00' },
            { value: '19:00', label: '19:00' },
            { value: '20:00', label: '20:00' },
            { value: '21:00', label: '21:00' },
            { value: '22:00', label: '22:00' },
            { value: '23:00', label: '23:00' },
            { value: '24:00', label: '24:00' },
            { value: '1:00', label: '1:00' },
            { value: '2:00', label: '2:00' },
            { value: '3:00', label: '3:00' }
          ]},
          { id: 'psqi_q4', type: 'slider', label: '107. During the past month, how many hours of actual sleep do you get at night? (This may be different than the number of hours you spend in bed) (0-24 hours) *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, min: 0, max: 24 },
          { id: 'psqi_q5a', type: 'likert', label: '108. During the past month, how often have you had trouble sleeping because you cannot get to sleep within 30 minutes? *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_q5b', type: 'likert', label: '109. During the past month, how often have you had trouble sleeping because you wake up in the middle of the night or early morning? *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_q5c', type: 'likert', label: '110. During the past month, how often have you had trouble sleeping because you have to get up to use the bathroom? *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_q5d', type: 'likert', label: '111. During the past month, how often have you had trouble sleeping because you cannot breathe comfortably? *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_q5e', type: 'likert', label: '112. During the past month, how often have you had trouble sleeping because you cough or snore loudly? *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_q5f', type: 'likert', label: '113. During the past month, how often have you had trouble sleeping because you feel too cold? *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_q5g', type: 'likert', label: '114. During the past month, how often have you had trouble sleeping because you feel too hot? *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_q5h', type: 'likert', label: '115. During the past month, how often have you had trouble sleeping because you had bad dreams? *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_q5i', type: 'likert', label: '116. During the past month, how often have you had trouble sleeping because you have pain? *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_q5j', type: 'likert', label: '117. During the past month, how often have you had trouble sleeping because you... Other reason(s) *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_q7', type: 'likert', label: '118. During the past month, how often have you taken medicine to help you sleep (prescribed or "over the counter")? *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_q7', type: 'likert', label: '119. During the past month, how often have you had trouble staying awake while driving, eating meals, or engaging in social activity? *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_q8', type: 'likert', label: '120. During the past month, how much of a problem has it been for you to keep up enough enthusiasm to get things done? *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not a problem at all',
            '(1) Only very slight problem',
            '(2) Somewhat of a problem',
            '(3) A very big problem'
          ]},
          { id: 'psqi_q6', type: 'likert', label: '121. During the past month, how would you rate your sleep quality overall? *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Very good',
            '(1) Fairly good',
            '(2) Fairly bad',
            '(3) Very bad'
          ]},
          { id: 'psqi_q10', type: 'radio', label: '122. Do you have a bed partner or roommate? *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            { value: 'no_bed_partner', label: 'No bed partner or room mate' },
            { value: 'partner_other_room', label: 'Partner/room mate in other room' },
            { value: 'partner_same_room', label: 'Partner in same room but not same bed' },
            { value: 'partner_same_bed', label: 'Partner in same bed' }
          ]},
          { id: 'psqi_q10a', type: 'likert', label: '123. If you have a room mate or bed partner, ask him/her how often in the past month you have had: Loud snoring *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_q10b', type: 'likert', label: '124. If you have a room mate or bed partner, ask him/her how often in the past month you have had: Long pauses between breaths while asleep *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_q10c', type: 'likert', label: '125. If you have a room mate or bed partner, ask him/her how often in the past month you have had: Legs twitching or jerking while you sleep *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_q10d', type: 'likert', label: '126. If you have a room mate or bed partner, ask him/her how often in the past month you have had: Episodes of disorientation or confusion during sleep *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_q10e', type: 'likert', label: '127. If you have a room mate or bed partner, ask him/her how often in the past month you have had: Other restlessness while you sleep, please describe in next question *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_q10f', type: 'text', label: '128. Describe other restlessness while you sleep if applicable:', required: false, showIf: { field: 'fill_psqi', value: 'yes' }}
        ]
      }
    ]
  },
  migraine: {
    title: 'Migraine Assessment - COMPASS 31',
    sections: [
      {
        title: 'Section 1 - General Data',
        questions: [
          { id: 'assessment_date', type: 'date', label: '1. Date of assessment *', required: true },
          { id: 'doctor_email', type: 'email', label: '2. Doctor Email *', required: true },
          { id: 'patient_name', type: 'text', label: '3. Patient Name and Surname *', required: true },
          { id: 'patient_id', type: 'text', label: '4. Patient ID *', required: true },
          { id: 'patient_age', type: 'radio', label: '5. Patient Age *', required: true, options: [
            { value: '<18', label: '< 18' },
            { value: '18-25', label: '18-25' },
            { value: '26-35', label: '26-35' },
            { value: '36-45', label: '36-45' },
            { value: '46-55', label: '46-55' },
            { value: '56-65', label: '56-65' },
            { value: '>65', label: '> 65' }
          ]},
          { id: 'gender', type: 'radio', label: '6. Gender *', required: true, options: [
            { value: 'male', label: 'Male' },
            { value: 'female', label: 'Female' },
            { value: 'non-binary', label: 'Non-binary' }
          ]},
          { id: 'visit_type', type: 'radio', label: '7. Please choose one of the following options *', required: true, options: [
            { value: 'first', label: 'First visit' },
            { value: 'followup1', label: 'Follow-up visit 1' },
            { value: 'followup2', label: 'Follow-up visit 2' },
            { value: 'followup3', label: 'Follow-up visit 3' }
          ]}
        ]
      },
      {
        title: 'Section 2 - EQ-5D-5L Health Questionnaire',
        questions: [
          { id: 'fill_eq5d', type: 'radio', label: '8. Do you want to fill in EQ-5D-5L questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'eq5d_mobility', type: 'likert', label: '9. Mobility *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, options: [
            '(1) I have no problems in walking about',
            '(2) I have slight problems in walking about',
            '(3) I have moderate problems in walking about',
            '(4) I have severe problems in walking about',
            '(5) I am unable to walk about'
          ]},
          { id: 'eq5d_self_care', type: 'likert', label: '10. Self Care *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, options: [
            '(1) I have no problems washing or dressing myself',
            '(2) I have slight problems washing or dressing myself',
            '(3) I have moderate problems washing or dressing myself',
            '(4) I have severe problems washing or dressing myself',
            '(5) I am unable to wash or dress myself'
          ]},
          { id: 'eq5d_usual_activities', type: 'likert', label: '11. Usual activities (e.g. work, study, housework, family or leisure activities) *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, options: [
            '(1) I have no problems doing my usual activities',
            '(2) I have slight problems doing my usual activities',
            '(3) I have moderate problems doing my usual activities',
            '(4) I have severe problems doing my usual activities',
            '(5) I am unable to do my usual activities'
          ]},
          { id: 'eq5d_pain', type: 'likert', label: '12. Pain/Discomfort *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, options: [
            '(1) I have no pain or discomfort',
            '(2) I have slight pain or discomfort',
            '(3) I have moderate pain or discomfort',
            '(4) I have severe pain or discomfort',
            '(5) I have extreme pain or discomfort'
          ]},
          { id: 'eq5d_anxiety', type: 'likert', label: '13. Anxiety/Depression *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, options: [
            '(1) I am not anxious or depressed',
            '(2) I am slightly anxious or depressed',
            '(3) I am moderately anxious or depressed',
            '(4) I am severely anxious or depressed',
            '(5) I am extremely anxious or depressed'
          ]},
          { id: 'eq5d_health_today', type: 'slider', label: '14. We would like to know how good or bad your health is TODAY (0=worst health you can imagine, 10=best health you can imagine) *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, min: 0, max: 10 }
        ]
      },
      {
        title: 'Section 3 - COMPASS 31',
        questions: [
          { id: 'fill_compass31', type: 'radio', label: '15. Do you want to fill in COMPASS-31 questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'q16_faint', type: 'radio', label: '16. In the past year, have you ever felt faint, dizzy, "goofy", or had difficulty thinking soon after standing up from a sitting or lying position? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            { value: 'yes', label: '(1) Yes' },
            { value: 'no', label: '(2) No' }
          ]},
          { id: 'q17_frequency', type: 'likert', label: '17. When standing up, how frequently do you get these feelings or symptoms? *', required: true, showIf: { field: 'q16_faint', value: 'yes' }, options: [
            '(1) Rarely',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Almost Always'
          ]},
          { id: 'q18_severity', type: 'likert', label: '18. How would you rate the severity of these feelings or symptoms? *', required: true, showIf: { field: 'q16_faint', value: 'yes' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'q19_change', type: 'likert', label: '19. In the past year, have these feelings or symptoms that you have experienced: *', required: true, showIf: { field: 'q16_faint', value: 'yes' }, options: [
            '(1) Gotten much worse',
            '(2) Gotten somewhat worse',
            '(3) Stayed about the same',
            '(4) Gotten somewhat better',
            '(5) Gotten much better Completely gone'
          ]},
          { id: 'q20_skin_color', type: 'radio', label: '20. In the past year, have you ever noticed color changes in your skin, such as red, white, or purple? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            { value: 'yes', label: '(1) Yes' },
            { value: 'no', label: '(2) No' }
          ]},
          { id: 'q21_skin_parts', type: 'checkbox', label: '21. What parts of your body are affected by these color changes? (Check all that apply) *', required: true, showIf: { field: 'q20_skin_color', value: 'yes' }, options: [
            { value: 'hands', label: '(1) Hands' },
            { value: 'feet', label: '(2) Feet' }
          ]},
          { id: 'q22_skin_changes', type: 'likert', label: '22. Are these changes in your skin color: *', required: true, showIf: { field: 'q20_skin_color', value: 'yes' }, options: [
            '(1) Getting much worse',
            '(2) Getting somewhat worse',
            '(3) Staying about the same',
            '(4) Getting somewhat better',
            '(5) Getting much better',
            '(6) Completely gone'
          ]},
          { id: 'q23_sweating', type: 'likert', label: '23. In the past 5 years, what changes, if any, have occurred in your general body sweating? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) I sweat much more than I used to',
            '(2) I sweat somewhat more than I used to',
            '(3) I haven\'t noticed any changes in my sweating',
            '(4) I sweat somewhat less than I used to',
            '(5) I sweat much less than I used to'
          ]},
          { id: 'q24_dry_eyes', type: 'radio', label: '24. Do your eyes feel excessively dry? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            { value: 'yes', label: '(1) Yes' },
            { value: 'no', label: '(2) No' }
          ]},
          { id: 'q25_dry_mouth', type: 'radio', label: '25. Does your mouth feel excessively dry? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            { value: 'yes', label: '(1) Yes' },
            { value: 'no', label: '(2) No' }
          ]},
          { id: 'q26_dry_symptom', type: 'likert', label: '26. For the symptom of dry eyes or dry mouth that you have had for the longest period of time, is this symptom: *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) I have not had any of these symptoms',
            '(2) Getting much worse',
            '(3) Getting somewhat worse',
            '(4) Staying about the same',
            '(5) Getting somewhat better',
            '(6) Getting much better',
            '(7) Completely gone'
          ]},
          { id: 'q27_full_quickly', type: 'likert', label: '27. In the past year, have you noticed any changes in how quickly you get full when eating a meal? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) I get full a lot more quickly now than I used to',
            '(2) I get full more quickly now than I used to',
            '(3) I haven\'t noticed any change',
            '(4) I get full less quickly now than I used to',
            '(5) I get full a lot less quickly now than I used to'
          ]},
          { id: 'q28_bloated', type: 'likert', label: '28. In the past year, have you felt excessively full or persistently full (bloated feeling) after a meal? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Sometimes',
            '(3) A lot of times'
          ]},
          { id: 'q29_vomiting', type: 'likert', label: '29. In the past year, have you vomited after a meal? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Sometimes',
            '(3) A lot of time'
          ]},
          { id: 'q30_abdominal_pain', type: 'likert', label: '30. In the past year, have you had a cramping or colicky abdominal pain? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Sometimes',
            '(3) A lot of times'
          ]},
          { id: 'q31_diarrhea', type: 'radio', label: '31. In the past year, have you had any bouts of diarrhea? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            { value: 'yes', label: '(1) Yes' },
            { value: 'no', label: '(2) No' }
          ]},
          { id: 'q32_diarrhea_frequency', type: 'likert', label: '32. How frequently does this occur? *', required: true, showIf: { field: 'q31_diarrhea', value: 'yes' }, options: [
            '(1) Rarely',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'q33_diarrhea_severity', type: 'likert', label: '33. How severe are these bouts of diarrhea? *', required: true, showIf: { field: 'q31_diarrhea', value: 'yes' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'q34_diarrhea_change', type: 'likert', label: '34. Are your bouts of diarrhea getting: *', required: true, showIf: { field: 'q31_diarrhea', value: 'yes' }, options: [
            '(1) Much worse',
            '(2) Somewhat worse',
            '(3) Staying the same',
            '(4) Much better',
            '(5) Completely gone'
          ]},
          { id: 'q35_constipation', type: 'radio', label: '35. In the past year, have you been constipated? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            { value: 'yes', label: '(1) Yes' },
            { value: 'no', label: '(2) No' }
          ]},
          { id: 'q36_constipation_frequency', type: 'likert', label: '36. How frequently are you constipated? *', required: true, showIf: { field: 'q35_constipation', value: 'yes' }, options: [
            '(1) Rarely',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'q37_constipation_severity', type: 'likert', label: '37. How severe are these episodes of constipation? *', required: true, showIf: { field: 'q35_constipation', value: 'yes' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'q38_constipation_change', type: 'likert', label: '38. Is your constipation getting: *', required: true, showIf: { field: 'q35_constipation', value: 'yes' }, options: [
            '(1) Much worse',
            '(2) Somewhat worse',
            '(3) Staying the same',
            '(4) Somewhat better',
            '(5) Much better',
            '(6) Completely gone'
          ]},
          { id: 'q39_bladder_control', type: 'likert', label: '39. In the past year, have you ever lost control of your bladder function? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'q40_passing_urine', type: 'likert', label: '40. In the past year, have you had difficulty passing urine? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'q41_emptying_bladder', type: 'likert', label: '41. In the past year, have you had trouble completely emptying your bladder? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'q42_bright_light', type: 'likert', label: '42. In the past year, without sunglasses or tinted glasses, has bright light bothered your eyes? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'q43_light_severity', type: 'likert', label: '43. How severe is this sensitivity to bright light? *', required: true, showIf: { field: 'q42_bright_light', value: '(2) Occasionally' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'q44_focusing_eyes', type: 'likert', label: '44. In the past year, have you had trouble focusing your eyes? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'q45_focusing_severity', type: 'likert', label: '45. How severe is this focusing problem? *', required: true, showIf: { field: 'q44_focusing_eyes', value: '(2) Occasionally' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'q46_eye_symptom_change', type: 'likert', label: '46. Is the most troublesome symptom with your eyes (i.e. sensitivity to bright light or trouble focusing) getting: *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) I have not had any of these symptoms',
            '(2) Much worse',
            '(3) Somewhat worse',
            '(4) Staying about the same',
            '(5) Somewhat better',
            '(6) Much better',
            '(7) Completely gone'
          ]}
        ]
      },
      {
        title: 'Section 4 - MIDAS - Migraine Disability Assessment',
        questions: [
          { id: 'fill_midas', type: 'radio', label: '47. Do you want to fill in MIDAS questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'midas_q1_missed_work', type: 'slider', label: '48. On how many days in the last 3 months did you miss work or school because of your headaches? *', required: true, showIf: { field: 'fill_midas', value: 'yes' }, min: 0, max: 90 },
          { id: 'midas_q2_reduced_productivity', type: 'slider', label: '49. How many days in the last 3 months was your productivity at work or school reduced by half or more because of your headaches? (Do not include days you counted in question 1 where you missed work or school.) *', required: true, showIf: { field: 'fill_midas', value: 'yes' }, min: 0, max: 90 },
          { id: 'midas_q3_household_work', type: 'slider', label: '50. On how many days in the last 3 months did you not do household work (such as housework, home repairs and maintenance, shopping, caring for children and relatives) because of your headaches? *', required: true, showIf: { field: 'fill_midas', value: 'yes' }, min: 0, max: 90 },
          { id: 'midas_q4_household_reduced', type: 'slider', label: '51. How many days in the last 3 months was your productivity in household work reduced by half of more because of your headaches? (Do not include days you counted in question 3 where you did not do household work.) *', required: true, showIf: { field: 'fill_midas', value: 'yes' }, min: 0, max: 90 },
          { id: 'midas_q5_missed_activities', type: 'slider', label: '52. On how many days in the last 3 months did you miss family, social or leisure activities because of your headaches? *', required: true, showIf: { field: 'fill_midas', value: 'yes' }, min: 0, max: 90 }
        ]
      },
      {
        title: 'Section 5 - MSQ - Migraine-specific Quality of Life Questionnaire',
        questions: [
          { id: 'fill_msq', type: 'radio', label: '53. Do you want to fill in MSQ questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'msq_q1_family_friends', type: 'likert', label: '54. How often have migraines interfered with how well you dealt with family, friends and others who are close to you? *', required: true, showIf: { field: 'fill_msq', value: 'yes' }, options: [
            '(6) Never',
            '(5) Rarely',
            '(4) Sometimes',
            '(3) Pretty',
            '(2) Almost',
            '(1) Always'
          ]},
          { id: 'msq_q2_leisure', type: 'likert', label: '55. How often have migraines interrupted with your leisure time activities such as reading or exercising? *', required: true, showIf: { field: 'fill_msq', value: 'yes' }, options: [
            '(6) Never',
            '(5) Rarely',
            '(4) Sometimes',
            '(3) Pretty',
            '(2) Almost',
            '(1) Always'
          ]},
          { id: 'msq_q3_work_difficulty', type: 'likert', label: '56. How often have you had difficulty in performing work or other daily activities? *', required: true, showIf: { field: 'fill_msq', value: 'yes' }, options: [
            '(6) Never',
            '(5) Rarely',
            '(4) Sometimes',
            '(3) Pretty',
            '(2) Almost',
            '(1) Always'
          ]},
          { id: 'msq_q4_accomplished', type: 'likert', label: '57. How often have migraines kept you from getting as much accomplished as you normally do at work or at home? *', required: true, showIf: { field: 'fill_msq', value: 'yes' }, options: [
            '(6) Never',
            '(5) Rarely',
            '(4) Sometimes',
            '(3) Pretty',
            '(2) Almost',
            '(1) Always'
          ]},
          { id: 'msq_q5_limited_ability', type: 'likert', label: '58. How often have migraines limited your ability to work or do other activities as carefully as you usually do them? *', required: true, showIf: { field: 'fill_msq', value: 'yes' }, options: [
            '(6) Never',
            '(5) Rarely',
            '(4) Sometimes',
            '(3) Pretty',
            '(2) Almost',
            '(1) Always'
          ]},
          { id: 'msq_q6_exhausted', type: 'likert', label: '59. How often have you had to cancel or delay work or social activities because you were exhausted? *', required: true, showIf: { field: 'fill_msq', value: 'yes' }, options: [
            '(6) Never',
            '(5) Rarely',
            '(4) Sometimes',
            '(3) Pretty',
            '(2) Almost',
            '(1) Always'
          ]},
          { id: 'msq_q7_energy', type: 'likert', label: '60. How often have migraines left you with limited energy levels? *', required: true, showIf: { field: 'fill_msq', value: 'yes' }, options: [
            '(6) Never',
            '(5) Rarely',
            '(4) Sometimes',
            '(3) Pretty',
            '(2) Almost',
            '(1) Always'
          ]},
          { id: 'msq_q8_stop_work', type: 'likert', label: '61. How often have you had to stop work or other activities? *', required: true, showIf: { field: 'fill_msq', value: 'yes' }, options: [
            '(6) Never',
            '(5) Rarely',
            '(4) Sometimes',
            '(3) Pretty',
            '(2) Almost',
            '(1) Always'
          ]},
          { id: 'msq_q9_help_needed', type: 'likert', label: '62. How often have you needed the help of other people in handling routine tasks such as everyday household chores, doing necessary business, shopping, or caring for others when you had a migraine attack? *', required: true, showIf: { field: 'fill_msq', value: 'yes' }, options: [
            '(6) Never',
            '(5) Rarely',
            '(4) Sometimes',
            '(3) Pretty',
            '(2) Almost',
            '(1) Always'
          ]},
          { id: 'msq_q10_avoided_social', type: 'likert', label: '63. How often have you avoided social or family activities to treat your migraine attacks? *', required: true, showIf: { field: 'fill_msq', value: 'yes' }, options: [
            '(6) Never',
            '(5) Rarely',
            '(4) Sometimes',
            '(3) Pretty',
            '(2) Almost',
            '(1) Always'
          ]},
          { id: 'msq_q11_social_events', type: 'likert', label: '64. How often has it been difficult for you to go to social events such as parties? *', required: true, showIf: { field: 'fill_msq', value: 'yes' }, options: [
            '(6) Never',
            '(5) Rarely',
            '(4) Sometimes',
            '(3) Pretty',
            '(2) Almost',
            '(1) Always'
          ]},
          { id: 'msq_q12_frustrated', type: 'likert', label: '65. How often have you felt fed up or frustrated? *', required: true, showIf: { field: 'fill_msq', value: 'yes' }, options: [
            '(6) Never',
            '(5) Rarely',
            '(4) Sometimes',
            '(3) Pretty',
            '(2) Almost',
            '(1) Always'
          ]},
          { id: 'msq_q13_burden', type: 'likert', label: '66. How often have you felt like you were a burden on others? *', required: true, showIf: { field: 'fill_msq', value: 'yes' }, options: [
            '(6) Never',
            '(5) Rarely',
            '(4) Sometimes',
            '(3) Pretty',
            '(2) Almost',
            '(1) Always'
          ]},
          { id: 'msq_q14_letting_down', type: 'likert', label: '67. How often have you been afraid of letting others down? *', required: true, showIf: { field: 'fill_msq', value: 'yes' }, options: [
            '(6) Never',
            '(5) Rarely',
            '(4) Sometimes',
            '(3) Pretty',
            '(2) Almost',
            '(1) Always'
          ]}
        ]
      },
      {
        title: 'Section 6 - Pain Rating Scale',
        questions: [
          { id: 'fill_pain_scale', type: 'radio', label: '68. Do you want to fill in Pain Rating Scale questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'pain_q1_intensity_now', type: 'slider', label: '69. How intense is your pain now? *', required: true, showIf: { field: 'fill_pain_scale', value: 'yes' }, min: 0, max: 10 },
          { id: 'pain_q2_intensity_week', type: 'slider', label: '70. How intense was your pain on average last week? *', required: true, showIf: { field: 'fill_pain_scale', value: 'yes' }, min: 0, max: 10 },
          { id: 'pain_q3_distress_now', type: 'slider', label: '71. How distressing is your pain now? *', required: true, showIf: { field: 'fill_pain_scale', value: 'yes' }, min: 0, max: 10 },
          { id: 'pain_q4_distress_week', type: 'slider', label: '72. How distressing was your pain on average last week? *', required: true, showIf: { field: 'fill_pain_scale', value: 'yes' }, min: 0, max: 10 },
          { id: 'pain_q5_interference', type: 'slider', label: '73. Now please use the same method to describe how much your pain interferes with your normal everyday activities. *', required: true, showIf: { field: 'fill_pain_scale', value: 'yes' }, min: 0, max: 10 }
        ]
      },
      {
        title: 'Section 7 - DASS-21',
        questions: [
          { id: 'fill_dass21', type: 'radio', label: '74. Do you want to fill in DASS-21 questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'dass_q1_wind_down', type: 'likert', label: '75. (S) I found it hard to wind down. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_q2_dry_mouth', type: 'likert', label: '76. (A) I was aware of dryness of my mouth. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_q3_positive_feeling', type: 'likert', label: '77. (D) I couldn\'t seem to experience any positive feeling at all. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_q4_breathing', type: 'likert', label: '78. (A) I experienced breathing difficulty (e.g. excessively rapid breathing, breathlessness in the absence of physical exertion). *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_q5_initiative', type: 'likert', label: '79. (D) I found it difficult to work up the initiative to do things. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_q6_over_react', type: 'likert', label: '80. (S) I tended to over-react to situations. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_q7_trembling', type: 'likert', label: '81. (A) I experienced trembling (e.g. in the hands). *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_q8_nervous_energy', type: 'likert', label: '82. (S) I felt that I was using a lot of nervous energy. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_q9_panic', type: 'likert', label: '83. (A) I was worried about situations in which I might panic and make a fool of myself. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_q10_look_forward', type: 'likert', label: '84. (D) I felt that I had nothing to look forward to. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_q11_agitated', type: 'likert', label: '85. (S) I found myself getting agitated. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_q12_relax', type: 'likert', label: '86. (S) I found it difficult to relax. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_q13_down_hearted', type: 'likert', label: '87. (D) I felt down-hearted and blue. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_q14_intolerant', type: 'likert', label: '88. (S) I was intolerant of anything that kept me from getting on with what I was doing. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_q15_close_panic', type: 'likert', label: '89. (A) I felt I was close to panic. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_q16_enthusiastic', type: 'likert', label: '90. (D) I was unable to become enthusiastic about anything. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_q17_worth', type: 'likert', label: '91. (D) I felt I wasn\'t worth much as a person. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_q18_touchy', type: 'likert', label: '92. (S) I felt that I was rather touchy. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_q19_heart_action', type: 'likert', label: '93. (A) I was aware of the action of my heart in the absence of physical exertion (e.g. sense of heart rate increase, heart missing a beat). *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_q20_scared', type: 'likert', label: '94. (A) I felt scared without any good reason. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_q21_meaningless', type: 'likert', label: '95. (D) I felt that life was meaningless. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]}
        ]
      },
      {
        title: 'Section 8 - PSQI - Pittsburgh Sleep Quality Index',
        questions: [
          { id: 'fill_psqi', type: 'radio', label: '96. Do you want to fill in PSQI questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'psqi_q1_bedtime', type: 'radio', label: '97. During the past month, what time have you usually gone to bed at night? (24-Hour Time Format) *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            { value: '21:00', label: '21:00' },
            { value: '22:00', label: '22:00' },
            { value: '23:00', label: '23:00' },
            { value: '24:00', label: '24:00' },
            { value: '1:00', label: '1:00' },
            { value: '2:00', label: '2:00' },
            { value: '3:00', label: '3:00' },
            { value: '4:00', label: '4:00' },
            { value: '5:00', label: '5:00' },
            { value: '6:00', label: '6:00' },
            { value: '7:00', label: '7:00' },
            { value: '8:00', label: '8:00' },
            { value: '9:00', label: '9:00' },
            { value: '10:00', label: '10:00' },
            { value: '11:00', label: '11:00' },
            { value: '12:00', label: '12:00' },
            { value: '13:00', label: '13:00' },
            { value: '14:00', label: '14:00' },
            { value: '15:00', label: '15:00' },
            { value: '16:00', label: '16:00' },
            { value: '17:00', label: '17:00' },
            { value: '18:00', label: '18:00' },
            { value: '19:00', label: '19:00' },
            { value: '20:00', label: '20:00' }
          ]},
          { id: 'psqi_q2_sleep_latency', type: 'slider', label: '98. During the past month, how long (in minutes) has it usually taken you to fall asleep each night? *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, min: 0, max: 180 },
          { id: 'psqi_q3_wake_time', type: 'radio', label: '99. During the past month, what time have you usually gotten up in the morning? (24-Hour Time Format) *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            { value: '4:00', label: '4:00' },
            { value: '5:00', label: '5:00' },
            { value: '6:00', label: '6:00' },
            { value: '7:00', label: '7:00' },
            { value: '8:00', label: '8:00' },
            { value: '9:00', label: '9:00' },
            { value: '10:00', label: '10:00' },
            { value: '11:00', label: '11:00' },
            { value: '12:00', label: '12:00' },
            { value: '13:00', label: '13:00' },
            { value: '14:00', label: '14:00' },
            { value: '15:00', label: '15:00' },
            { value: '16:00', label: '16:00' },
            { value: '17:00', label: '17:00' },
            { value: '18:00', label: '18:00' },
            { value: '19:00', label: '19:00' },
            { value: '20:00', label: '20:00' },
            { value: '21:00', label: '21:00' },
            { value: '22:00', label: '22:00' },
            { value: '23:00', label: '23:00' },
            { value: '24:00', label: '24:00' },
            { value: '1:00', label: '1:00' },
            { value: '2:00', label: '2:00' },
            { value: '3:00', label: '3:00' }
          ]},
          { id: 'psqi_q4_sleep_hours', type: 'slider', label: '100. During the past month, how many hours of actual sleep did you get at night? (This may be different than the number of hours you spent in bed.) *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, min: 0, max: 24 },
          { id: 'psqi_q5a_cannot_sleep', type: 'likert', label: '101. During the past month, how often have you had trouble sleeping because you... Cannot get to sleep within 30 minutes *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_q5b_wake_up', type: 'likert', label: '102. During the past month, how often have you had trouble sleeping because you... Wake up in the middle of the night or early morning *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_q5c_bathroom', type: 'likert', label: '103. During the past month, how often have you had trouble sleeping because you... Have to get up to use the bathroom *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_q5d_breathe', type: 'likert', label: '104. During the past month, how often have you had trouble sleeping because you... Cannot breathe comfortably *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_q5e_cough_snore', type: 'likert', label: '105. During the past month, how often have you had trouble sleeping because you... Cough or snore loudly *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_q5f_too_cold', type: 'likert', label: '106. During the past month, how often have you had trouble sleeping because you... Feel too cold *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_q5g_too_hot', type: 'likert', label: '107. During the past month, how often have you had trouble sleeping because you... Feel too hot *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_q5h_bad_dreams', type: 'likert', label: '108. During the past month, how often have you had trouble sleeping because you... Have bad dreams *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_q5i_pain', type: 'likert', label: '109. During the past month, how often have you had trouble sleeping because you... Have pain *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_q5j_other', type: 'likert', label: '110. During the past month, how often have you had trouble sleeping because you... Other reason(s) *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_q6_medication', type: 'likert', label: '111. During the past month, how often have you taken medicine to help you sleep (prescribed or "over the counter")? *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_q7_staying_awake', type: 'likert', label: '112. During the past month, how often have you had trouble staying awake while driving, eating meals, or engaging in social activity? *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_q8_enthusiasm', type: 'likert', label: '113. During the past month, how much of a problem has it been for you to keep up enough enthusiasm to get things done? *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not a problem at all',
            '(1) Only very slight problem',
            '(2) Somewhat of a problem',
            '(3) A very big problem'
          ]},
          { id: 'psqi_q9_sleep_quality', type: 'likert', label: '114. During the past month, how would you rate your sleep quality overall? *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Very good',
            '(1) Fairly good',
            '(2) Fairly bad',
            '(3) Very bad'
          ]},
          { id: 'psqi_q10_bed_partner', type: 'radio', label: '115. Do you have a bed partner or roommate? *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            { value: 'no_partner', label: 'No bed partner or room mate' },
            { value: 'other_room', label: 'Partner/room mate in other room' },
            { value: 'same_room', label: 'Partner in same room but not same bed' },
            { value: 'same_bed', label: 'Partner in same bed' }
          ]},
          { id: 'psqi_q10a_snoring', type: 'likert', label: '116. If you have a room mate or bed partner, ask him/her how often in the past month you have had: Loud snoring *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_q10b_pauses', type: 'likert', label: '117. If you have a room mate or bed partner, ask him/her how often in the past month you have had: Long pauses between breaths while asleep *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_q10c_twitching', type: 'likert', label: '118. If you have a room mate or bed partner, ask him/her how often in the past month you have had: Legs twitching or jerking while you sleep *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_q10d_disorientation', type: 'likert', label: '119. If you have a room mate or bed partner, ask him/her how often in the past month you have had: Episodes of disorientation or confusion during sleep *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_q10e_restlessness', type: 'likert', label: '120. If you have a room mate or bed partner, ask him/her how often in the past month you have had: Other restlessness while you sleep, please describe in next question *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_q10f_restlessness_desc', type: 'text', label: '121. Describe other restlessness while you sleep if applicable: *', required: true, showIf: { field: 'fill_psqi', value: 'yes' } }
        ]
      },
      {
        title: 'Section 9 - BDI-II - Beck\'s Depression Inventory Version 2',
        questions: [
          { id: 'fill_bdi2', type: 'radio', label: '122. Do you want to fill in BDI-II questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'bdi_q1_sadness', type: 'likert', label: '123. Sadness *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            '(0) I do not feel sad',
            '(1) I feel sad much of the time',
            '(2) I am sad all the time',
            '(3) I am so sad or unhappy that I can\'t stand it'
          ]},
          { id: 'bdi_q2_pessimism', type: 'likert', label: '124. Pessimism *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            '(0) I am not discouraged about my future',
            '(1) I feel more discouraged about my future than I used to be',
            '(2) I do not expect things to work out for me',
            '(3) I feel my future is hopeless and will only get worse'
          ]},
          { id: 'bdi_q3_past_failure', type: 'likert', label: '125. Past failure *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            '(0) I do not feel like a failure',
            '(1) I have failed more than I should have',
            '(2) As I look back, I see a lot of failures',
            '(3) I feel I am a total failure as a person'
          ]},
          { id: 'bdi_q4_loss_pleasure', type: 'likert', label: '126. Loss of pleasure *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            '(0) I get as much pleasure as I ever did from the things I enjoy',
            '(1) I don\'t enjoy things as much as I used to',
            '(2) I get very little pleasure from the things I used to enjoy',
            '(3) I can\'t get any pleasure from the things I used to enjoy'
          ]},
          { id: 'bdi_q5_guilty_feelings', type: 'likert', label: '127. Guilty feelings *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            '(0) I don\'t feel particularly guilty',
            '(1) I feel guilty over many things I have done or should have done',
            '(2) I feel quite guilty most of the time',
            '(3) I feel guilty all of the time'
          ]},
          { id: 'bdi_q6_punishment', type: 'likert', label: '128. Punishment feelings *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            '(0) I don\'t feel I am being punished',
            '(1) I feel I may be punished',
            '(2) I expect to be punished',
            '(3) I feel I am being punished'
          ]},
          { id: 'bdi_q7_self_dislike', type: 'likert', label: '129. Self-Dislike *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            '(0) I feel the same about myself as ever',
            '(1) I have lost confidence in myself',
            '(2) I am disappointed in myself',
            '(3) I dislike myself'
          ]},
          { id: 'bdi_q8_self_criticalness', type: 'likert', label: '130. Self-Criticalness *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            '(0) I don\'t criticize or blame myself more than usual',
            '(1) I am more critical of myself than I used to be',
            '(2) I criticize myself for all of my faults',
            '(3) I blame myself for everything bad that happens'
          ]},
          { id: 'bdi_q9_suicidal', type: 'likert', label: '131. Suicidal Thoughts or Wishes *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            '(0) I don\'t have any thoughts of killing myself',
            '(1) I have thoughts of killing myself, but I would not carry them out',
            '(2) I would like to kill myself',
            '(3) I would kill myself if I had the chance'
          ]},
          { id: 'bdi_q10_crying', type: 'likert', label: '132. Crying *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            '(0) I don\'t cry any more than I used to',
            '(1) I cry more than I used to',
            '(2) I cry over every little thing',
            '(3) I feel like crying, but I can\'t'
          ]},
          { id: 'bdi_q11_agitation', type: 'likert', label: '133. Agitation *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            '(0) I am no more restless or wound up than usual',
            '(1) I feel more restless or wound up than usual',
            '(2) I am so restless or agitated that it\'s hard to stay still',
            '(3) I am so restless or agitated that I have to keep moving or doing something'
          ]},
          { id: 'bdi_q12_loss_interest', type: 'likert', label: '134. Loss of Interest *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            '(0) I have not lost interest in other people or activities',
            '(1) I am less interested in other people or things than before',
            '(2) I have lost most of my interest in other people or things',
            '(3) It\'s hard to get interested in anything'
          ]},
          { id: 'bdi_q13_indecisiveness', type: 'likert', label: '135. Indecisiveness *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            '(0) I make decisions about as well as ever',
            '(1) I find it more difficult to make decisions than usual',
            '(2) I have much greater difficulty in making decisions than I used to',
            '(3) I have trouble making any decisions'
          ]},
          { id: 'bdi_q14_worthlessness', type: 'likert', label: '136. Worthlessness *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            '(0) I do not feel I am worthless',
            '(1) I don\'t consider myself as worthwhile and useful as I used to',
            '(2) I feel more worthless as compared to other people',
            '(3) I feel utterly worthless'
          ]},
          { id: 'bdi_q15_loss_energy', type: 'likert', label: '137. Loss of Energy *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            '(0) I have as much energy as ever',
            '(1) I have less energy than I used to have',
            '(2) I don\'t have enough energy to do very much',
            '(3) I don\'t have enough energy to do anything'
          ]},
          { id: 'bdi_q16_sleep_changes', type: 'likert', label: '138. Changes in Sleeping Pattern *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            '(0) I have not experienced any change in my sleeping pattern',
            '(1) I sleep somewhat more than usual',
            '(2) I sleep somewhat less than usual',
            '(3) I sleep a lot more than usual',
            '(4) I sleep a lot less than usual',
            '(5) I sleep most of the day',
            '(6) I wake up 1-2 hours early and can\'t get back to sleep'
          ]},
          { id: 'bdi_q17_irritability', type: 'likert', label: '139. Irritability *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            '(0) I am no more irritable than usual',
            '(1) I am more irritable than usual',
            '(2) I am much more irritable than usual',
            '(3) I am irritable all the time'
          ]},
          { id: 'bdi_q18_appetite_changes', type: 'likert', label: '140. Changes in Appetite *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            '(0) I have not experienced any changes in my appetite',
            '(1) My appetite is somewhat less than usual',
            '(2) My appetite is somewhat greater than usual',
            '(3) My appetite is much less than before',
            '(4) My appetite is much greater than usual',
            '(5) I have no appetite at all',
            '(6) I crave food all the time'
          ]},
          { id: 'bdi_q19_concentration', type: 'likert', label: '141. Concentration Difficulty *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            '(0) I can concentrate as well as ever',
            '(1) I can\'t concentrate as well as usual',
            '(2) It\'s hard to keep my mind on anything for very long',
            '(3) I find I can\'t concentrate on anything'
          ]},
          { id: 'bdi_q20_tiredness', type: 'likert', label: '142. Tiredness or Fatigue *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            '(0) I am no more tired or fatigued than usual',
            '(1) I get more tired or fatigued more easily than usual',
            '(2) I am too tired or fatigued to do a lot of the things I used to do',
            '(3) I am too tired or fatigued to do most of the things I used to do'
          ]},
          { id: 'bdi_q21_loss_interest_sex', type: 'likert', label: '143. Loss of Interest in Sex *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            '(0) I have not noticed any recent change in my interest in sex',
            '(1) I am less interested in sex than I used to be',
            '(2) I am much less interested in sex now',
            '(3) I have lost interest in sex completely'
          ]}
        ]
      }
    ]
  },
  parkinsons: {
    title: "Parkinson's Disease Assessment",
    sections: [
      {
        title: 'Section 1 - General Data',
        questions: [
          { id: 'pd_date', type: 'date', label: '1. Date of assessment *', required: true },
          { id: 'pd_doctor_email', type: 'email', label: '2. Doctor Email *', required: true },
          { id: 'pd_new_existing', type: 'radio', label: '3. New or Existing *', required: true, options: [
            { value: 'new', label: 'New' },
            { value: 'existing', label: 'Existing' }
          ]},
          { id: 'pd_sozo_id', type: 'text', label: '4. Sozo ID', required: false, showIf: { field: 'pd_new_existing', value: 'existing' } },
          { id: 'pd_patient_name', type: 'text', label: '5. Patient Name and Surname *', required: true },
          { id: 'pd_patient_id', type: 'text', label: '6. Patient ID *', required: true },
          { id: 'pd_patient_age', type: 'radio', label: '7. Patient Age *', required: true, options: [
            { value: '<18', label: '< 18' },
            { value: '18-25', label: '18-25' },
            { value: '26-35', label: '26-35' },
            { value: '36-45', label: '36-45' },
            { value: '46-55', label: '46-55' },
            { value: '56-65', label: '56-65' },
            { value: '>65', label: '> 65' }
          ]},
          { id: 'pd_gender', type: 'radio', label: '8. Gender *', required: true, options: [
            { value: 'male', label: 'Male' },
            { value: 'female', label: 'Female' },
            { value: 'non-binary', label: 'Non-binary' }
          ]},
          { id: 'pd_visit_type', type: 'radio', label: '9. Please choose one of the following options *', required: true, options: [
            { value: 'first', label: 'First visit' },
            { value: 'followup1', label: 'Follow-up visit 1' },
            { value: 'followup2', label: 'Follow-up visit 2' },
            { value: 'followup3', label: 'Follow-up visit 3' }
          ]}
        ]
      },
      {
        title: 'Section 2 - COMPASS 31',
        questions: [
          { id: 'fill_compass31_pd', type: 'radio', label: '10. Do you want to fill in COMPASS-31 questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'compass31_pd_q11', type: 'likert', label: '11. In the past year, have you ever felt faint, dizzy, "goofy", or had difficulty thinking soon after standing up from a sitting or lying position? *', required: true, showIf: { field: 'fill_compass31_pd', value: 'yes' }, options: [
            '(1) Yes',
            '(2) No'
          ]},
          { id: 'compass31_pd_q12', type: 'likert', label: '12. When standing up, how frequently do you get these feelings or symptoms? *', required: true, showIf: { field: 'compass31_pd_q11', value: '0' }, options: [
            '(1) Rarely',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Almost Always'
          ]},
          { id: 'compass31_pd_q13', type: 'likert', label: '13. How would you rate the severity of these feelings or symptoms? *', required: true, showIf: { field: 'compass31_pd_q11', value: '0' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_pd_q14', type: 'likert', label: '14. In the past year, have these feelings or symptoms that you have experienced: *', required: true, showIf: { field: 'compass31_pd_q11', value: '0' }, options: [
            '(1) Gotten much worse',
            '(2) Gotten somewhat worse',
            '(3) Stayed about the same',
            '(4) Gotten somewhat better',
            '(5) Gotten much better Completely gone'
          ]},
          { id: 'compass31_pd_q15', type: 'likert', label: '15. In the past year, have you ever noticed color changes in your skin, such as red, white, or purple? *', required: true, showIf: { field: 'fill_compass31_pd', value: 'yes' }, options: [
            '(1) Yes',
            '(2) No'
          ]},
          { id: 'compass31_pd_q16', type: 'checkbox', label: '16. What parts of your body are affected by these color changes? (Check all that apply) *', required: true, showIf: { field: 'compass31_pd_q15', value: '0' }, options: [
            { value: 'hands', label: '(1) Hands' },
            { value: 'feet', label: '(2) Feet' }
          ]},
          { id: 'compass31_pd_q17', type: 'likert', label: '17. Are these changes in your skin color: *', required: true, showIf: { field: 'compass31_pd_q15', value: '0' }, options: [
            '(1) Getting much worse',
            '(2) Getting somewhat worse',
            '(3) Staying about the same',
            '(4) Getting somewhat better',
            '(5) Getting much better',
            '(6) Completely gone'
          ]},
          { id: 'compass31_pd_q18', type: 'likert', label: '18. In the past 5 years, what changes, if any, have occurred in your general body sweating? *', required: true, showIf: { field: 'fill_compass31_pd', value: 'yes' }, options: [
            '(1) I sweat much more than I used to',
            '(2) I sweat somewhat more than I used to',
            '(3) I haven\'t noticed any changes in my sweating',
            '(4) I sweat somewhat less than I used to',
            '(5) I sweat much less than I used to'
          ]},
          { id: 'compass31_pd_q19', type: 'likert', label: '19. Do your eyes feel excessively dry? *', required: true, showIf: { field: 'fill_compass31_pd', value: 'yes' }, options: [
            '(1) Yes',
            '(2) No'
          ]},
          { id: 'compass31_pd_q20', type: 'likert', label: '20. Does your mouth feel excessively dry? *', required: true, showIf: { field: 'fill_compass31_pd', value: 'yes' }, options: [
            '(1) Yes',
            '(2) No'
          ]},
          { id: 'compass31_pd_q21', type: 'likert', label: '21. For the symptom of dry eyes or dry mouth that you have had for the longest period of time, is this symptom: *', required: true, showIf: { field: 'fill_compass31_pd', value: 'yes' }, options: [
            '(1) I have not had any of these symptoms',
            '(2) Getting much worse',
            '(3) Getting somewhat worse',
            '(4) Staying about the same',
            '(5) Getting somewhat better',
            '(6) Getting much better',
            '(7) Completely gone'
          ]},
          { id: 'compass31_pd_q22', type: 'likert', label: '22. In the past year, have you noticed any changes in how quickly you get full when eating a meal? *', required: true, showIf: { field: 'fill_compass31_pd', value: 'yes' }, options: [
            '(1) I get full a lot more quickly now than I used to',
            '(2) I get full more quickly now than I used to',
            '(3) I haven\'t noticed any change',
            '(4) I get full less quickly now than I used to',
            '(5) I get full a lot less quickly now than I used to'
          ]},
          { id: 'compass31_pd_q23', type: 'likert', label: '23. In the past year, have you felt excessively full or persistently full (bloated feeling) after a meal? *', required: true, showIf: { field: 'fill_compass31_pd', value: 'yes' }, options: [
            '(1) Never',
            '(2) Sometimes',
            '(3) A lot of times'
          ]},
          { id: 'compass31_pd_q24', type: 'likert', label: '24. In the past year, have you vomited after a meal? *', required: true, showIf: { field: 'fill_compass31_pd', value: 'yes' }, options: [
            '(1) Never',
            '(2) Sometimes',
            '(3) A lot of time'
          ]},
          { id: 'compass31_pd_q25', type: 'likert', label: '25. In the past year, have you had a cramping or colicky abdominal pain? *', required: true, showIf: { field: 'fill_compass31_pd', value: 'yes' }, options: [
            '(1) Never',
            '(2) Sometimes',
            '(3) A lot of times'
          ]},
          { id: 'compass31_pd_q26', type: 'likert', label: '26. In the past year, have you had any bouts of diarrhea? *', required: true, showIf: { field: 'fill_compass31_pd', value: 'yes' }, options: [
            '(1) Yes',
            '(2) No'
          ]},
          { id: 'compass31_pd_q27', type: 'likert', label: '27. How frequently does this occur? *', required: true, showIf: { field: 'compass31_pd_q26', value: '0' }, options: [
            '(1) Rarely',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_pd_q28', type: 'likert', label: '28. How severe are these bouts of diarrhea? *', required: true, showIf: { field: 'compass31_pd_q26', value: '0' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_pd_q29', type: 'likert', label: '29. Are your bouts of diarrhea getting: *', required: true, showIf: { field: 'compass31_pd_q26', value: '0' }, options: [
            '(1) Much worse',
            '(2) Somewhat worse',
            '(3) Staying the same',
            '(4) Much better',
            '(5) Completely gone'
          ]},
          { id: 'compass31_pd_q30', type: 'likert', label: '30. In the past year, have you been constipated? *', required: true, showIf: { field: 'fill_compass31_pd', value: 'yes' }, options: [
            '(1) Yes',
            '(2) No'
          ]},
          { id: 'compass31_pd_q31', type: 'likert', label: '31. How frequently are you constipated? *', required: true, showIf: { field: 'compass31_pd_q30', value: '0' }, options: [
            '(1) Rarely',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_pd_q32', type: 'likert', label: '32. How severe are these episodes of constipation? *', required: true, showIf: { field: 'compass31_pd_q30', value: '0' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_pd_q33', type: 'likert', label: '33. Is your constipation getting: *', required: true, showIf: { field: 'compass31_pd_q30', value: '0' }, options: [
            '(1) Much worse',
            '(2) Somewhat worse',
            '(3) Staying the same',
            '(4) Somewhat better',
            '(5) Much better',
            '(6) Completely gone'
          ]},
          { id: 'compass31_pd_q34', type: 'likert', label: '34. In the past year, have you ever lost control of your bladder function? *', required: true, showIf: { field: 'fill_compass31_pd', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_pd_q35', type: 'likert', label: '35. In the past year, have you had difficulty passing urine? *', required: true, showIf: { field: 'fill_compass31_pd', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_pd_q36', type: 'likert', label: '36. In the past year, have you had trouble completely emptying your bladder? *', required: true, showIf: { field: 'fill_compass31_pd', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_pd_q37', type: 'likert', label: '37. In the past year, without sunglasses or tinted glasses, has bright light bothered your eyes? *', required: true, showIf: { field: 'fill_compass31_pd', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_pd_q38', type: 'likert', label: '38. How severe is this sensitivity to bright light? *', required: true, showIf: { field: 'compass31_pd_q37', value: '1' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_pd_q38', type: 'likert', label: '38. How severe is this sensitivity to bright light? *', required: true, showIf: { field: 'compass31_pd_q37', value: '2' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_pd_q38', type: 'likert', label: '38. How severe is this sensitivity to bright light? *', required: true, showIf: { field: 'compass31_pd_q37', value: '3' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_pd_q39', type: 'likert', label: '39. In the past year, have you had trouble focusing your eyes? *', required: true, showIf: { field: 'fill_compass31_pd', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_pd_q40', type: 'likert', label: '40. How severe is this focusing problem? *', required: true, showIf: { field: 'compass31_pd_q39', value: '1' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_pd_q40', type: 'likert', label: '40. How severe is this focusing problem? *', required: true, showIf: { field: 'compass31_pd_q39', value: '2' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_pd_q40', type: 'likert', label: '40. How severe is this focusing problem? *', required: true, showIf: { field: 'compass31_pd_q39', value: '3' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_pd_q41', type: 'likert', label: '41. Is the most troublesome symptom with your eyes (i.e. sensitivity to bright light or trouble focusing) getting: *', required: true, showIf: { field: 'compass31_pd_q37', value: '0' }, options: [
            '(1) I have not had any of these symptoms',
            '(2) Much worse',
            '(3) Somewhat worse',
            '(4) Staying about the same',
            '(5) Somewhat better',
            '(6) Much better',
            '(7) Completely gone'
          ]},
          { id: 'compass31_pd_q41', type: 'likert', label: '41. Is the most troublesome symptom with your eyes (i.e. sensitivity to bright light or trouble focusing) getting: *', required: true, showIf: { field: 'compass31_pd_q38', value: '0' }, options: [
            '(1) I have not had any of these symptoms',
            '(2) Much worse',
            '(3) Somewhat worse',
            '(4) Staying about the same',
            '(5) Somewhat better',
            '(6) Much better',
            '(7) Completely gone'
          ]},
          { id: 'compass31_pd_q41', type: 'likert', label: '41. Is the most troublesome symptom with your eyes (i.e. sensitivity to bright light or trouble focusing) getting: *', required: true, showIf: { field: 'compass31_pd_q38', value: '1' }, options: [
            '(1) I have not had any of these symptoms',
            '(2) Much worse',
            '(3) Somewhat worse',
            '(4) Staying about the same',
            '(5) Somewhat better',
            '(6) Much better',
            '(7) Completely gone'
          ]},
          { id: 'compass31_pd_q41', type: 'likert', label: '41. Is the most troublesome symptom with your eyes (i.e. sensitivity to bright light or trouble focusing) getting: *', required: true, showIf: { field: 'compass31_pd_q38', value: '2' }, options: [
            '(1) I have not had any of these symptoms',
            '(2) Much worse',
            '(3) Somewhat worse',
            '(4) Staying about the same',
            '(5) Somewhat better',
            '(6) Much better',
            '(7) Completely gone'
          ]},
          { id: 'compass31_pd_q41', type: 'likert', label: '41. Is the most troublesome symptom with your eyes (i.e. sensitivity to bright light or trouble focusing) getting: *', required: true, showIf: { field: 'compass31_pd_q39', value: '0' }, options: [
            '(1) I have not had any of these symptoms',
            '(2) Much worse',
            '(3) Somewhat worse',
            '(4) Staying about the same',
            '(5) Somewhat better',
            '(6) Much better',
            '(7) Completely gone'
          ]},
          { id: 'compass31_pd_q41', type: 'likert', label: '41. Is the most troublesome symptom with your eyes (i.e. sensitivity to bright light or trouble focusing) getting: *', required: true, showIf: { field: 'compass31_pd_q40', value: '0' }, options: [
            '(1) I have not had any of these symptoms',
            '(2) Much worse',
            '(3) Somewhat worse',
            '(4) Staying about the same',
            '(5) Somewhat better',
            '(6) Much better',
            '(7) Completely gone'
          ]},
          { id: 'compass31_pd_q41', type: 'likert', label: '41. Is the most troublesome symptom with your eyes (i.e. sensitivity to bright light or trouble focusing) getting: *', required: true, showIf: { field: 'compass31_pd_q40', value: '1' }, options: [
            '(1) I have not had any of these symptoms',
            '(2) Much worse',
            '(3) Somewhat worse',
            '(4) Staying about the same',
            '(5) Somewhat better',
            '(6) Much better',
            '(7) Completely gone'
          ]},
          { id: 'compass31_pd_q41', type: 'likert', label: '41. Is the most troublesome symptom with your eyes (i.e. sensitivity to bright light or trouble focusing) getting: *', required: true, showIf: { field: 'compass31_pd_q40', value: '2' }, options: [
            '(1) I have not had any of these symptoms',
            '(2) Much worse',
            '(3) Somewhat worse',
            '(4) Staying about the same',
            '(5) Somewhat better',
            '(6) Much better',
            '(7) Completely gone'
          ]}
        ]
      },
      {
        title: 'Section 3 - PDSS (Parkinson\'s Disease Sleep Scale)',
        questions: [
          { id: 'fill_pdss', type: 'radio', label: '42. Do you want to fill in PDSS questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'pdss_q43', type: 'slider', label: '43. The overall quality of your night\'s sleep is: *', required: true, showIf: { field: 'fill_pdss', value: 'yes' }, min: 0, max: 10 },
          { id: 'pdss_q44', type: 'slider', label: '44. Do you have difficulty falling asleep each night? *', required: true, showIf: { field: 'fill_pdss', value: 'yes' }, min: 0, max: 10 },
          { id: 'pdss_q45', type: 'slider', label: '45. Do you have difficulty staying asleep? *', required: true, showIf: { field: 'fill_pdss', value: 'yes' }, min: 0, max: 10 },
          { id: 'pdss_q46', type: 'slider', label: '46. Does restlessness in your legs or arms at night or in the evening disrupt your sleep? *', required: true, showIf: { field: 'fill_pdss', value: 'yes' }, min: 0, max: 10 },
          { id: 'pdss_q47', type: 'slider', label: '47. Do you fidget in bed? *', required: true, showIf: { field: 'fill_pdss', value: 'yes' }, min: 0, max: 10 },
          { id: 'pdss_q48', type: 'slider', label: '48. Do you suffer from distressing dreams at night? *', required: true, showIf: { field: 'fill_pdss', value: 'yes' }, min: 0, max: 10 },
          { id: 'pdss_q49', type: 'slider', label: '49. Do you suffer from distressing hallucinations at night (seeing or hearing things that you are told do not exist)? *', required: true, showIf: { field: 'fill_pdss', value: 'yes' }, min: 0, max: 10 },
          { id: 'pdss_q50', type: 'slider', label: '50. Do you get up at night to pass urine? *', required: true, showIf: { field: 'fill_pdss', value: 'yes' }, min: 0, max: 10 },
          { id: 'pdss_q51', type: 'slider', label: '51. Do you have incontinence of urine because you are unable to move due to "off" symptoms? *', required: true, showIf: { field: 'fill_pdss', value: 'yes' }, min: 0, max: 10 },
          { id: 'pdss_q52', type: 'slider', label: '52. Do you experience numbness or tingling in your arms or legs, which wakes you from sleep at night? *', required: true, showIf: { field: 'fill_pdss', value: 'yes' }, min: 0, max: 10 },
          { id: 'pdss_q53', type: 'slider', label: '53. Do you have painful muscle cramps in your arms or legs which wake you from sleep at night? *', required: true, showIf: { field: 'fill_pdss', value: 'yes' }, min: 0, max: 10 },
          { id: 'pdss_q54', type: 'slider', label: '54. Do you wake early in the morning with painful posturing of your arms or legs? *', required: true, showIf: { field: 'fill_pdss', value: 'yes' }, min: 0, max: 10 },
          { id: 'pdss_q55', type: 'slider', label: '55. On waking do you experience tremor? *', required: true, showIf: { field: 'fill_pdss', value: 'yes' }, min: 0, max: 10 },
          { id: 'pdss_q56', type: 'slider', label: '56. Do you feel tired and sleepy after waking in the morning? *', required: true, showIf: { field: 'fill_pdss', value: 'yes' }, min: 0, max: 10 },
          { id: 'pdss_q57', type: 'slider', label: '57. Have you unexpectedly fallen asleep during the day? *', required: true, showIf: { field: 'fill_pdss', value: 'yes' }, min: 0, max: 10 }
        ]
      },
      {
        title: 'Section 4 - PFS-16 (Parkinson\'s Disease Fatigue Scale)',
        questions: [
          { id: 'fill_pfs16', type: 'radio', label: '58. Do you want to fill in PFS-16 questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'pfs16_q59', type: 'likert', label: '59. I have to rest during the day *', required: true, showIf: { field: 'fill_pfs16', value: 'yes' }, options: [
            '(1) Strongly disagree',
            '(2) Disagree',
            '(3) Do not agree or disagree',
            '(4) Agree',
            '(5) Strongly agree'
          ]},
          { id: 'pfs16_q60', type: 'likert', label: '60. My life is restricted by fatigue *', required: true, showIf: { field: 'fill_pfs16', value: 'yes' }, options: [
            '(1) Strongly disagree',
            '(2) Disagree',
            '(3) Do not agree or disagree',
            '(4) Agree',
            '(5) Strongly agree'
          ]},
          { id: 'pfs16_q61', type: 'likert', label: '61. I get tired more quickly than other people I know *', required: true, showIf: { field: 'fill_pfs16', value: 'yes' }, options: [
            '(1) Strongly disagree',
            '(2) Disagree',
            '(3) Do not agree or disagree',
            '(4) Agree',
            '(5) Strongly agree'
          ]},
          { id: 'pfs16_q62', type: 'likert', label: '62. Fatigue is one of my three worst symptoms *', required: true, showIf: { field: 'fill_pfs16', value: 'yes' }, options: [
            '(1) Strongly disagree',
            '(2) Disagree',
            '(3) Do not agree or disagree',
            '(4) Agree',
            '(5) Strongly agree'
          ]},
          { id: 'pfs16_q63', type: 'likert', label: '63. I feel completely exhausted *', required: true, showIf: { field: 'fill_pfs16', value: 'yes' }, options: [
            '(1) Strongly disagree',
            '(2) Disagree',
            '(3) Do not agree or disagree',
            '(4) Agree',
            '(5) Strongly agree'
          ]},
          { id: 'pfs16_q64', type: 'likert', label: '64. Fatigue makes me reluctant to socialise *', required: true, showIf: { field: 'fill_pfs16', value: 'yes' }, options: [
            '(1) Strongly disagree',
            '(2) Disagree',
            '(3) Do not agree or disagree',
            '(4) Agree',
            '(5) Strongly agree'
          ]},
          { id: 'pfs16_q65', type: 'likert', label: '65. It takes me longer to get things done because of fatigue *', required: true, showIf: { field: 'fill_pfs16', value: 'yes' }, options: [
            '(1) Strongly disagree',
            '(2) Disagree',
            '(3) Do not agree or disagree',
            '(4) Agree',
            '(5) Strongly agree'
          ]},
          { id: 'pfs16_q66', type: 'likert', label: '66. I have a feeling of heaviness *', required: true, showIf: { field: 'fill_pfs16', value: 'yes' }, options: [
            '(1) Strongly disagree',
            '(2) Disagree',
            '(3) Do not agree or disagree',
            '(4) Agree',
            '(5) Strongly agree'
          ]},
          { id: 'pfs16_q67', type: 'likert', label: '67. If I wasn\'t so tired I could do more things *', required: true, showIf: { field: 'fill_pfs16', value: 'yes' }, options: [
            '(1) Strongly disagree',
            '(2) Disagree',
            '(3) Do not agree or disagree',
            '(4) Agree',
            '(5) Strongly agree'
          ]},
          { id: 'pfs16_q68', type: 'likert', label: '68. Everything I do is an effort *', required: true, showIf: { field: 'fill_pfs16', value: 'yes' }, options: [
            '(1) Strongly disagree',
            '(2) Disagree',
            '(3) Do not agree or disagree',
            '(4) Agree',
            '(5) Strongly agree'
          ]},
          { id: 'pfs16_q69', type: 'likert', label: '69. I feel tired for much of the time *', required: true, showIf: { field: 'fill_pfs16', value: 'yes' }, options: [
            '(1) Strongly disagree',
            '(2) Disagree',
            '(3) Do not agree or disagree',
            '(4) Agree',
            '(5) Strongly agree'
          ]},
          { id: 'pfs16_q70', type: 'likert', label: '70. I feel totally drained *', required: true, showIf: { field: 'fill_pfs16', value: 'yes' }, options: [
            '(1) Strongly disagree',
            '(2) Disagree',
            '(3) Do not agree or disagree',
            '(4) Agree',
            '(5) Strongly agree'
          ]},
          { id: 'pfs16_q71', type: 'likert', label: '71. Fatigue makes it difficult for me to cope with everyday activities *', required: true, showIf: { field: 'fill_pfs16', value: 'yes' }, options: [
            '(1) Strongly disagree',
            '(2) Disagree',
            '(3) Do not agree or disagree',
            '(4) Agree',
            '(5) Strongly agree'
          ]},
          { id: 'pfs16_q72', type: 'likert', label: '72. I feel tired even when I haven\'t done anything *', required: true, showIf: { field: 'fill_pfs16', value: 'yes' }, options: [
            '(1) Strongly disagree',
            '(2) Disagree',
            '(3) Do not agree or disagree',
            '(4) Agree',
            '(5) Strongly agree'
          ]},
          { id: 'pfs16_q73', type: 'likert', label: '73. Because of fatigue I do less in my day than I would like *', required: true, showIf: { field: 'fill_pfs16', value: 'yes' }, options: [
            '(1) Strongly disagree',
            '(2) Disagree',
            '(3) Do not agree or disagree',
            '(4) Agree',
            '(5) Strongly agree'
          ]},
          { id: 'pfs16_q74', type: 'likert', label: '74. I get so tired I want to lie down wherever I am *', required: true, showIf: { field: 'fill_pfs16', value: 'yes' }, options: [
            '(1) Strongly disagree',
            '(2) Disagree',
            '(3) Do not agree or disagree',
            '(4) Agree',
            '(5) Strongly agree'
          ]}
        ]
      },
      {
        title: 'Section 5 - MoCA (Montreal Cognitive Assessment)',
        questions: [
          { id: 'fill_moca', type: 'radio', label: '75. Do you want to fill in MoCA - Montreal Cognitive Assessment questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'moca_q76', type: 'text', label: '76. Calculated sum of all subscores from MoCA test: *', required: true, showIf: { field: 'fill_moca', value: 'yes' } }
        ]
      },
      {
        title: 'Section 6 - PainDETECT',
        questions: [
          { id: 'fill_paindetect', type: 'radio', label: '77. Do you want to fill in Pain Detect questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'paindetect_q78', type: 'slider', label: '78. How would you assess your pain now, at this moment? *', required: true, showIf: { field: 'fill_paindetect', value: 'yes' }, min: 0, max: 10 },
          { id: 'paindetect_q79', type: 'slider', label: '79. How strong was the strongest pain during the past 4 weeks? *', required: true, showIf: { field: 'fill_paindetect', value: 'yes' }, min: 0, max: 10 },
          { id: 'paindetect_q80', type: 'slider', label: '80. How strong was the pain during the past 4 weeks on average? *', required: true, showIf: { field: 'fill_paindetect', value: 'yes' }, min: 0, max: 10 },
          { id: 'paindetect_q81', type: 'likert', label: '81. Does your pain radiate to other regions of your body? *', required: true, showIf: { field: 'fill_paindetect', value: 'yes' }, options: [
            '(2) Yes',
            '(0) No'
          ]},
          { id: 'paindetect_q82', type: 'likert', label: '82. Do you suffer from a burning sensation (e.g., stinging nettles) in the marked areas? *', required: true, showIf: { field: 'fill_paindetect', value: 'yes' }, options: [
            '(0) never',
            '(1) hardly noticed',
            '(2) slightly',
            '(3) moderately',
            '(4) strongly',
            '(5) very strongly'
          ]},
          { id: 'paindetect_q83', type: 'likert', label: '83. Do you have a tingling or prickling sensation in the area of your pain (like crawling ants or electrical tingling)? *', required: true, showIf: { field: 'fill_paindetect', value: 'yes' }, options: [
            '(0) never',
            '(1) hardly noticed',
            '(2) slightly',
            '(3) moderately',
            '(4) strongly',
            '(5) very strongly'
          ]},
          { id: 'paindetect_q84', type: 'likert', label: '84. Is light touching (clothing, a blanket) in this area painful? *', required: true, showIf: { field: 'fill_paindetect', value: 'yes' }, options: [
            '(0) never',
            '(1) hardly noticed',
            '(2) slightly',
            '(3) moderately',
            '(4) strongly',
            '(5) very strongly'
          ]},
          { id: 'paindetect_q85', type: 'likert', label: '85. Do you have sudden pain attacks in the area of your pain, like electric shocks? *', required: true, showIf: { field: 'fill_paindetect', value: 'yes' }, options: [
            '(0) never',
            '(1) hardly noticed',
            '(2) slightly',
            '(3) moderately',
            '(4) strongly',
            '(5) very strongly'
          ]},
          { id: 'paindetect_q86', type: 'likert', label: '86. Is cold or heat (bath water) in this area occasionally painful? *', required: true, showIf: { field: 'fill_paindetect', value: 'yes' }, options: [
            '(0) never',
            '(1) hardly noticed',
            '(2) slightly',
            '(3) moderately',
            '(4) strongly',
            '(5) very strongly'
          ]},
          { id: 'paindetect_q87', type: 'likert', label: '87. Do you suffer from a sensation of numbness in the areas that you marked? *', required: true, showIf: { field: 'fill_paindetect', value: 'yes' }, options: [
            '(0) never',
            '(1) hardly noticed',
            '(2) slightly',
            '(3) moderately',
            '(4) strongly',
            '(5) very strongly'
          ]},
          { id: 'paindetect_q88', type: 'likert', label: '88. Does slight pressure in this area, e.g., with a finger, trigger pain? *', required: true, showIf: { field: 'fill_paindetect', value: 'yes' }, options: [
            '(0) never',
            '(1) hardly noticed',
            '(2) slightly',
            '(3) moderately',
            '(4) strongly',
            '(5) very strongly'
          ]}
        ]
      }
    ]
  },
  ms: {
    title: 'Multiple Sclerosis Assessment',
    sections: [
      {
        title: 'Section 1 - General Data',
        questions: [
          { id: 'ms_date', type: 'date', label: '1. Date of assessment *', required: true },
          { id: 'ms_doctor_email', type: 'email', label: '2. Doctor Email *', required: true },
          { id: 'ms_patient_name', type: 'text', label: '3. Patient Name and Surname *', required: true },
          { id: 'ms_patient_id', type: 'text', label: '4. Patient ID *', required: true },
          { id: 'ms_patient_age', type: 'radio', label: '5. Patient Age *', required: true, options: [
            { value: '<18', label: '< 18' },
            { value: '18-25', label: '18-25' },
            { value: '26-35', label: '26-35' },
            { value: '36-45', label: '36-45' },
            { value: '46-55', label: '46-55' },
            { value: '56-65', label: '56-65' },
            { value: '>65', label: '> 65' }
          ]},
          { id: 'ms_gender', type: 'radio', label: '6. Gender *', required: true, options: [
            { value: 'male', label: 'Male' },
            { value: 'female', label: 'Female' },
            { value: 'non-binary', label: 'Non-binary' }
          ]},
          { id: 'ms_visit_type', type: 'radio', label: '7. Please choose one of the following options *', required: true, options: [
            { value: 'first', label: 'First visit' },
            { value: 'followup1', label: 'Follow-up visit 1' },
            { value: 'followup2', label: 'Follow-up visit 2' },
            { value: 'followup3', label: 'Follow-up visit 3' }
          ]}
        ]
      },
      {
        title: 'Section 2 - EQ-5D-5L Health Questionnaire',
        questions: [
          { id: 'fill_eq5d', type: 'radio', label: '8. Do you want to fill in EQ-5D-5L questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'eq5d_mobility', type: 'likert', label: '9. Mobility *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, options: [
            '(1) I have no problems in walking about',
            '(2) I have slight problems in walking about',
            '(3) I have moderate problems in walking about',
            '(4) I have severe problems in walking about',
            '(5) I am unable to walk about'
          ]},
          { id: 'eq5d_selfcare', type: 'likert', label: '10. Self Care *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, options: [
            '(1) I have no problems washing or dressing myself',
            '(2) I have slight problems washing or dressing myself',
            '(3) I have moderate problems washing or dressing myself',
            '(4) I have severe problems washing or dressing myself',
            '(5) I am unable to wash or dress myself'
          ]},
          { id: 'eq5d_activities', type: 'likert', label: '11. Usual activities (e.g. work, study, housework, family or leisure activities) *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, options: [
            '(1) I have no problems doing my usual activities',
            '(2) I have slight problems doing my usual activities',
            '(3) I have moderate problems doing my usual activities',
            '(4) I have severe problems doing my usual activities',
            '(5) I am unable to do my usual activities'
          ]},
          { id: 'eq5d_pain', type: 'likert', label: '12. Pain/Discomfort *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, options: [
            '(1) I have no pain or discomfort',
            '(2) I have slight pain or discomfort',
            '(3) I have moderate pain or discomfort',
            '(4) I have severe pain or discomfort',
            '(5) I have extreme pain or discomfort'
          ]},
          { id: 'eq5d_anxiety', type: 'likert', label: '13. Anxiety/Depression *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, options: [
            '(1) I am not anxious or depressed',
            '(2) I am slightly anxious or depressed',
            '(3) I am moderately anxious or depressed',
            '(4) I am severely anxious or depressed',
            '(5) I am extremely anxious or depressed'
          ]},
          { id: 'eq5d_health', type: 'slider', label: '14. We would like to know how good or bad your health is TODAY. 0 means the worst health you can imagine. 10 means the best health you can imagine. *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, min: 0, max: 10 }
        ]
      },
      {
        title: 'Section 3 - COMPASS 31',
        questions: [
          { id: 'fill_compass31_ms', type: 'radio', label: '15. Do you want to fill in COMPASS-31 questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'compass31_ms_q16', type: 'likert', label: '16. In the past year, have you ever felt faint, dizzy, "goofy", or had difficulty thinking soon after standing up from a sitting or lying position? *', required: true, showIf: { field: 'fill_compass31_ms', value: 'yes' }, options: [
            '(1) Yes',
            '(2) No'
          ]},
          { id: 'compass31_ms_q17', type: 'likert', label: '17. When standing up, how frequently do you get these feelings or symptoms? *', required: true, showIf: { field: 'compass31_ms_q16', value: '0' }, options: [
            '(1) Rarely',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Almost Always'
          ]},
          { id: 'compass31_ms_q18', type: 'likert', label: '18. How would you rate the severity of these feelings or symptoms? *', required: true, showIf: { field: 'compass31_ms_q16', value: '0' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_ms_q19', type: 'likert', label: '19. In the past year, have these feelings or symptoms that you have experienced: *', required: true, showIf: { field: 'compass31_ms_q16', value: '0' }, options: [
            '(1) Gotten much worse',
            '(2) Gotten somewhat worse',
            '(3) Stayed about the same',
            '(4) Gotten somewhat better',
            '(5) Gotten much better Completely gone'
          ]},
          { id: 'compass31_ms_q20', type: 'likert', label: '20. In the past year, have you ever noticed color changes in your skin, such as red, white, or purple? *', required: true, showIf: { field: 'fill_compass31_ms', value: 'yes' }, options: [
            '(1) Yes',
            '(2) No'
          ]},
          { id: 'compass31_ms_q21', type: 'checkbox', label: '21. What parts of your body are affected by these color changes? (Check all that apply) *', required: true, showIf: { field: 'compass31_ms_q20', value: '0' }, options: [
            { value: 'hands', label: '(1) Hands' },
            { value: 'feet', label: '(2) Feet' }
          ]},
          { id: 'compass31_ms_q22', type: 'likert', label: '22. Are these changes in your skin color: *', required: true, showIf: { field: 'compass31_ms_q20', value: '0' }, options: [
            '(1) Getting much worse',
            '(2) Getting somewhat worse',
            '(3) Staying about the same',
            '(4) Getting somewhat better',
            '(5) Getting much better',
            '(6) Completely gone'
          ]},
          { id: 'compass31_ms_q23', type: 'likert', label: '23. In the past 5 years, what changes, if any, have occurred in your general body sweating? *', required: true, showIf: { field: 'fill_compass31_ms', value: 'yes' }, options: [
            '(1) I sweat much more than I used to',
            '(2) I sweat somewhat more than I used to',
            '(3) I haven\'t noticed any changes in my sweating',
            '(4) I sweat somewhat less than I used to',
            '(5) I sweat much less than I used to'
          ]},
          { id: 'compass31_ms_q24', type: 'likert', label: '24. Do your eyes feel excessively dry? *', required: true, showIf: { field: 'fill_compass31_ms', value: 'yes' }, options: [
            '(1) Yes',
            '(2) No'
          ]},
          { id: 'compass31_ms_q25', type: 'likert', label: '25. Does you mouth feel excessively dry? *', required: true, showIf: { field: 'fill_compass31_ms', value: 'yes' }, options: [
            '(1) Yes',
            '(2) No'
          ]},
          { id: 'compass31_ms_q26', type: 'likert', label: '26. For the symptom of dry eyes or dry mouth that you have had for the longest period of time, is this symptom: *', required: true, showIf: { field: 'fill_compass31_ms', value: 'yes' }, options: [
            '(1) I have not had any of these symptoms',
            '(2) Getting much worse',
            '(3) Getting somewhat worse',
            '(4) Staying about the same',
            '(5) Getting somewhat better',
            '(6) Getting much better',
            '(7) Completely gone'
          ]},
          { id: 'compass31_ms_q27', type: 'likert', label: '27. In the past year, have you noticed any changes in how quickly you get full when eating a meal? *', required: true, showIf: { field: 'fill_compass31_ms', value: 'yes' }, options: [
            '(1) I get full a lot more quickly now than I used to',
            '(2) I get full more quickly now than I used to',
            '(3) I haven\'t noticed any change',
            '(4) I get full less quickly now than I used to',
            '(5) I get full a lot less quickly now than I used to'
          ]},
          { id: 'compass31_ms_q28', type: 'likert', label: '28. In the past year, have you felt excessively full or persistently full (bloated feeling) after a meal? *', required: true, showIf: { field: 'fill_compass31_ms', value: 'yes' }, options: [
            '(1) Never',
            '(2) Sometimes',
            '(3) A lot of times'
          ]},
          { id: 'compass31_ms_q29', type: 'likert', label: '29. In the past year, have you vomited after a meal? *', required: true, showIf: { field: 'fill_compass31_ms', value: 'yes' }, options: [
            '(1) Never',
            '(2) Sometimes',
            '(3) A lot of time'
          ]},
          { id: 'compass31_ms_q30', type: 'likert', label: '30. In the past year, have you had a cramping or colicky abdominal pain? *', required: true, showIf: { field: 'fill_compass31_ms', value: 'yes' }, options: [
            '(1) Never',
            '(2) Sometimes',
            '(3) A lot of times'
          ]},
          { id: 'compass31_ms_q31', type: 'likert', label: '31. In the past year, have you had any bouts of diarrhea? *', required: true, showIf: { field: 'fill_compass31_ms', value: 'yes' }, options: [
            '(1) Yes',
            '(2) No'
          ]},
          { id: 'compass31_ms_q32', type: 'likert', label: '32. How frequently does this occur? *', required: true, showIf: { field: 'compass31_ms_q31', value: '0' }, options: [
            '(1) Rarely',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_ms_q33', type: 'likert', label: '33. How severe are these bouts of diarrhea? *', required: true, showIf: { field: 'compass31_ms_q31', value: '0' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_ms_q34', type: 'likert', label: '34. Are your bouts of diarrhea getting: *', required: true, showIf: { field: 'compass31_ms_q31', value: '0' }, options: [
            '(1) Much worse',
            '(2) Somewhat worse',
            '(3) Staying the same',
            '(4) Much better',
            '(5) Completely gone'
          ]},
          { id: 'compass31_ms_q35', type: 'likert', label: '35. In the past year, have you been constipated? *', required: true, showIf: { field: 'fill_compass31_ms', value: 'yes' }, options: [
            '(1) Yes',
            '(2) No'
          ]},
          { id: 'compass31_ms_q36', type: 'likert', label: '36. How frequently are you constipated? *', required: true, showIf: { field: 'compass31_ms_q35', value: '0' }, options: [
            '(1) Rarely',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_ms_q37', type: 'likert', label: '37. How severe are these episodes of constipation? *', required: true, showIf: { field: 'compass31_ms_q35', value: '0' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_ms_q38', type: 'likert', label: '38. Is your constipation getting: *', required: true, showIf: { field: 'compass31_ms_q35', value: '0' }, options: [
            '(1) Much worse',
            '(2) Somewhat worse',
            '(3) Staying the same',
            '(4) Somewhat better',
            '(5) Much better',
            '(6) Completely gone'
          ]},
          { id: 'compass31_ms_q39', type: 'likert', label: '39. In the past year, have you ever lost control of your bladder function? *', required: true, showIf: { field: 'fill_compass31_ms', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_ms_q40', type: 'likert', label: '40. In the past year, have you had difficulty passing urine? *', required: true, showIf: { field: 'fill_compass31_ms', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_ms_q41', type: 'likert', label: '41. In the past year, have you had trouble completely emptying your bladder? *', required: true, showIf: { field: 'fill_compass31_ms', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_ms_q42', type: 'likert', label: '42. In the past year, without sunglasses or tinted glasses, has bright light bothered your eyes? *', required: true, showIf: { field: 'fill_compass31_ms', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_ms_q43', type: 'likert', label: '43. How severe is this sensitivity to bright light? *', required: true, showIf: { field: 'compass31_ms_q42', value: '1' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_ms_q43', type: 'likert', label: '43. How severe is this sensitivity to bright light? *', required: true, showIf: { field: 'compass31_ms_q42', value: '2' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_ms_q43', type: 'likert', label: '43. How severe is this sensitivity to bright light? *', required: true, showIf: { field: 'compass31_ms_q42', value: '3' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_ms_q44', type: 'likert', label: '44. In the past year, have you had trouble focusing your eyes? *', required: true, showIf: { field: 'fill_compass31_ms', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_ms_q45', type: 'likert', label: '45. How severe is this focusing problem? *', required: true, showIf: { field: 'compass31_ms_q44', value: '1' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_ms_q45', type: 'likert', label: '45. How severe is this focusing problem? *', required: true, showIf: { field: 'compass31_ms_q44', value: '2' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_ms_q45', type: 'likert', label: '45. How severe is this focusing problem? *', required: true, showIf: { field: 'compass31_ms_q44', value: '3' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_ms_q46', type: 'likert', label: '46. Is the most troublesome symptom with your eyes (i.e. sensitivity to bright light or trouble focusing) getting: *', required: true, showIf: { field: 'fill_compass31_ms', value: 'yes' }, options: [
            '(1) I have not had any of these symptoms',
            '(2) Much worse',
            '(3) Somewhat worse',
            '(4) Staying about the same',
            '(5) Somewhat better',
            '(6) Much better',
            '(7) Completely gone'
          ]}
        ]
      },
      {
        title: 'Section 4 - DHI (Dizziness Handicap Inventory)',
        questions: [
          { id: 'fill_dhi', type: 'radio', label: '47. Do you want to fill in DHI - Dizziness Handicap Inventory questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'dhi_q48', type: 'likert', label: '48. Does looking up increase your problem? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'dhi_q49', type: 'likert', label: '49. Because of your problem, do you feel frustrated? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'dhi_q50', type: 'likert', label: '50. Because of your problem, do you restrict your travel for business or recreation? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'dhi_q51', type: 'likert', label: '51. Does walking down the aisle of a supermarket increase your problems? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'dhi_q52', type: 'likert', label: '52. Because of your problem, do you have difficulty getting into or out of bed? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'dhi_q53', type: 'likert', label: '53. Does your problem significantly restrict your participation in social activities, such as going out to dinner, going to the movies, dancing, or going to parties? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'dhi_q54', type: 'likert', label: '54. Because of your problem, do you have difficulty reading? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'dhi_q55', type: 'likert', label: '55. Does performing more ambitious activities such as sports, dancing, household chores (sweeping or putting dishes away) increase your problems? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'dhi_q56', type: 'likert', label: '56. Because of your problem, are you afraid to leave your home without having without having someone accompany you? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'dhi_q57', type: 'likert', label: '57. Because of your problem have you been embarrassed in front of others? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'dhi_q58', type: 'likert', label: '58. Do quick movements of your head increase your problem? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'dhi_q59', type: 'likert', label: '59. Because of your problem, do you avoid heights? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'dhi_q60', type: 'likert', label: '60. Does turning over in bed increase your problem? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'dhi_q61', type: 'likert', label: '61. Because of your problem, is it difficult for you to do strenuous homework or yard work? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'dhi_q62', type: 'likert', label: '62. Because of your problem, are you afraid people may think you are intoxicated? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'dhi_q63', type: 'likert', label: '63. Because of your problem, is it difficult for you to go for a walk by yourself? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'dhi_q64', type: 'likert', label: '64. Does walking down a sidewalk increase your problem? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'dhi_q65', type: 'likert', label: '65. Because of your problem, is it difficult for you to concentrate *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'dhi_q66', type: 'likert', label: '66. Because of your problem, is it difficult for you to walk around your house in the dark? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'dhi_q67', type: 'likert', label: '67. Because of your problem, are you afraid to stay home alone? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'dhi_q68', type: 'likert', label: '68. Because of your problem, do you feel handicapped? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'dhi_q69', type: 'likert', label: '69. Has the problem placed stress on your relationships with members of your family or friends *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'dhi_q70', type: 'likert', label: '70. Because of your problem, are you depressed? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'dhi_q71', type: 'likert', label: '71. Does your problem interfere with your job or household responsibilities? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]},
          { id: 'dhi_q72', type: 'likert', label: '72. Does bending over increase your problem? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            '(4) Yes',
            '(2) Sometimes',
            '(0) No'
          ]}
        ]
      },
      {
        title: 'Section 5 - SARA (Scale for the Assessment and Rating of Ataxia)',
        questions: [
          { id: 'fill_sara', type: 'radio', label: '73. Do you want to fill in SARA - Scale for the Assessment and Rating of Ataxia questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'sara_q74', type: 'likert', label: '74. GAIT: Proband is asked (1) to walk at a safe distance parallel to a wall including a half-turn (turn around to face the opposite direction of gait) and (2) to walk in tandem (heels to toes) without support. *', required: true, showIf: { field: 'fill_sara', value: 'yes' }, options: [
            '(0) Normal, no difficulties in walking, turning and walking tandem (up to one misstep allowed)',
            '(1) Slight difficulties, only visible when walking 10 consecutive steps in tandem',
            '(2) Clearly abnormal, tandem walking >10 steps not possible',
            '(3) Considerable staggering, difficulties in half-turn, but without support',
            '(4) Marked staggering, intermittent support of the wall required',
            '(5) Severe staggering, permanent support of one stick or light support by one arm required',
            '(6) Walking > 10 m only with strong support (two special sticks or stroller or accompanying person)',
            '(7) Walking < 10 m only with strong support (two special sticks or stroller or accompanying person)',
            '(8) Unable to walk, even supported'
          ]},
          { id: 'sara_q75', type: 'likert', label: '75. STANCE: Proband is asked to stand (1) in natural position, (2) with feet together in parallel (big toes touching each other) and (3) in tandem (both feet on one line, no space between heel and toe). Proband does not wear shoes, eyes are open. For each condition, three trials are allowed. Best trial is rated. *', required: true, showIf: { field: 'fill_sara', value: 'yes' }, options: [
            '(0) Normal, able to stand in tandem for > 10 s',
            '(1) Able to stand with feet together without sway, but not in tandem for > 10s',
            '(2) Able to stand with feet together for > 10 s, but only with sway',
            '(3) Able to stand for > 10 s without support in natural position, but not with feet together',
            '(4) Able to stand for >10 s in natural position only with intermittent support',
            '(5) Able to stand >10 s in natural position only with constant support of one arm',
            '(6) Unable to stand for >10 s even with constant support of one arm'
          ]},
          { id: 'sara_q76', type: 'likert', label: '76. SITTING: Proband is asked to sit on an examination bed without support of feet, eyes open and arms outstretched to the front. *', required: true, showIf: { field: 'fill_sara', value: 'yes' }, options: [
            '(0) Normal, no difficulties sitting >10 sec',
            '(1) Slight difficulties, intermittent sway',
            '(2) Constant sway, but able to sit > 10 s without support',
            '(3) Able to sit for > 10 s only with intermittent support',
            '(4) Unable to sit for >10 s without continuous support'
          ]},
          { id: 'sara_q77', type: 'likert', label: '77. SPEECH DISTURBANCE: Speech is assessed during normal conversation. *', required: true, showIf: { field: 'fill_sara', value: 'yes' }, options: [
            '(0) Normal',
            '(1) Suggestion of speech disturbance',
            '(2) Impaired speech, but easy to understand',
            '(3) Occasional words difficult to understand',
            '(4) Many words difficult to understand',
            '(5) Only single words understandable',
            '(6) Speech unintelligible / anarthria'
          ]},
          { id: 'sara_q78', type: 'likert', label: '78. FINGER CHASE RIGHT: Rated separately for each side. Proband sits comfortably. If necessary, support of feet and trunk is allowed. Examiner sits in front of proband and performs 5 consecutive sudden and fast pointing movements in unpredictable directions in a frontal plane, at about 50 % of proband´s reach. Movements have an amplitude of 30 cm and a frequency of 1 movement every 2 s. Proband is asked to follow the movements with his index finger, as fast and precisely as possible. Average performance of last 3 movements is rated. *', required: true, showIf: { field: 'fill_sara', value: 'yes' }, options: [
            '(0) No dysmetria',
            '(1) Dysmetria, under/ overshooting target <5 cm',
            '(2) Dysmetria, under/ overshooting target < 15 cm',
            '(3) Dysmetria, under/ overshooting target > 15 cm',
            '(4) Unable to perform 5 pointing movements'
          ]},
          { id: 'sara_q79', type: 'likert', label: '79. FINGER CHASE LEFT: Rated separately for each side. Proband sits comfortably. If necessary, support of feet and trunk is allowed. Examiner sits in front of proband and performs 5 consecutive sudden and fast pointing movements in unpredictable directions in a frontal plane, at about 50 % of proband´s reach. Movements have an amplitude of 30 cm and a frequency of 1 movement every 2 s. Proband is asked to follow the movements with his index finger, as fast and precisely as possible. Average performance of last 3 movements is rated. *', required: true, showIf: { field: 'fill_sara', value: 'yes' }, options: [
            '(0) No dysmetria',
            '(1) Dysmetria, under/ overshooting target <5 cm',
            '(2) Dysmetria, under/ overshooting target < 15 cm',
            '(3) Dysmetria, under/ overshooting target > 15 cm',
            '(4) Unable to perform 5 pointing movements'
          ]},
          { id: 'sara_q80', type: 'likert', label: '80. NOSE-FINGER TEST RIGHT: Rated separately for each side. Proband sits comfortably. If necessary, support of feet and trunk is allowed. Proband is asked to point repeatedly with his index finger from his nose to examiner\'s finger which is in front of the proband at about 90 % of proband\'s reach. Movements are performed at moderate speed. Average performance of movements is rated according to the amplitude of the kinetic tremor. *', required: true, showIf: { field: 'fill_sara', value: 'yes' }, options: [
            '(0) No tremor',
            '(1) Tremor with an amplitude < 2 cm',
            '(2) Tremor with an amplitude < 5 cm',
            '(3) Tremor with an amplitude > 5 cm',
            '(4) Unable to perform 5 pointing movements'
          ]},
          { id: 'sara_q81', type: 'likert', label: '81. NOSE-FINGER TEST LEFT: Rated separately for each side. Proband sits comfortably. If necessary, support of feet and trunk is allowed. Proband is asked to point repeatedly with his index finger from his nose to examiner\'s finger which is in front of the proband at about 90 % of proband\'s reach. Movements are performed at moderate speed. Average performance of movements is rated according to the amplitude of the kinetic tremor. *', required: true, showIf: { field: 'fill_sara', value: 'yes' }, options: [
            '(0) No tremor',
            '(1) Tremor with an amplitude < 2 cm',
            '(2) Tremor with an amplitude < 5 cm',
            '(3) Tremor with an amplitude > 5 cm',
            '(4) Unable to perform 5 pointing movements'
          ]},
          { id: 'sara_q82', type: 'likert', label: '82. FAST ALTERNATING HAND MOVEMENTS RIGHT: Rated separately for each side. Proband sits comfortably. If necessary, support of feet and trunk is allowed. Proband is asked to perform 10 cycles of repetitive alternation of pro- and supinations of the hand on his/her thigh as fast and as precise as possible. Movement is demonstrated by examiner at a speed of approx. 10 cycles within 7 s. Exact times for movement execution have to be taken. *', required: true, showIf: { field: 'fill_sara', value: 'yes' }, options: [
            '(0) Normal, no irregularities (performs <10s)',
            '(1) Slightly irregular (performs <10s)',
            '(2) Clearly irregular, single movements difficult to distinguish or relevant interruptions, but performs <10s',
            '(3) Very irregular, single movements difficult to distinguish or relevant interruptions, performs >10s',
            '(4) Unable to complete 10 cycles'
          ]},
          { id: 'sara_q83', type: 'likert', label: '83. FAST ALTERNATING HAND MOVEMENTS LEFT: Rated separately for each side. Proband sits comfortably. If necessary, support of feet and trunk is allowed. Proband is asked to perform 10 cycles of repetitive alternation of pro- and supinations of the hand on his/her thigh as fast and as precise as possible. Movement is demonstrated by examiner at a speed of approx. 10 cycles within 7 s. Exact times for movement execution have to be taken. *', required: true, showIf: { field: 'fill_sara', value: 'yes' }, options: [
            '(0) Normal, no irregularities (performs <10s)',
            '(1) Slightly irregular (performs <10s)',
            '(2) Clearly irregular, single movements difficult to distinguish or relevant interruptions, but performs <10s',
            '(3) Very irregular, single movements difficult to distinguish or relevant interruptions, performs >10s',
            '(4) Unable to complete 10 cycles'
          ]},
          { id: 'sara_q84', type: 'likert', label: '84. HEEL-SHIN SLIDE RIGHT: Rated separately for each side. Proband lies on examination bed, without sight of his legs. Proband is asked to lift one leg, point with the heel to the opposite knee, slide down along the shin to the ankle, and lay the leg back on the examination bed. The task is performed 3 times. Slide-down movements should be performed within 1 s. If proband slides down without contact to shin in all three trials, rate 4. *', required: true, showIf: { field: 'fill_sara', value: 'yes' }, options: [
            '(0) Normal',
            '(1) Slightly abnormal, contact to shin maintained',
            '(2) Clearly abnormal, goes off shin up to 3 times during 3 cycles',
            '(3) Severely abnormal, goes off shin 4 or more times during 3 cycles',
            '(4) Unable to perform the task'
          ]},
          { id: 'sara_q85', type: 'likert', label: '85. HEEL-SHIN SLIDE LEFT: Rated separately for each side. Proband lies on examination bed, without sight of his legs. Proband is asked to lift one leg, point with the heel to the opposite knee, slide down along the shin to the ankle, and lay the leg back on the examination bed. The task is performed 3 times. Slide-down movements should be performed within 1 s. If proband slides down without contact to shin in all three trials, rate 4. *', required: true, showIf: { field: 'fill_sara', value: 'yes' }, options: [
            '(0) Normal',
            '(1) Slightly abnormal, contact to shin maintained',
            '(2) Clearly abnormal, goes off shin up to 3 times during 3 cycles',
            '(3) Severely abnormal, goes off shin 4 or more times during 3 cycles',
            '(4) Unable to perform the task'
          ]}
        ]
      },
      {
        title: 'Section 6 - MFIS (Modified Fatigue Impact Scale)',
        questions: [
          { id: 'fill_mfis', type: 'radio', label: '86. Do you want to fill in MFIS - Modified Fatigue Impact Scale questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'mfis_q87', type: 'likert', label: '87. I have been less alert. *', required: true, showIf: { field: 'fill_mfis', value: 'yes' }, options: [
            '(0) Never',
            '(1) Rarely',
            '(2) Sometimes',
            '(3) Often',
            '(4) Almost always'
          ]},
          { id: 'mfis_q88', type: 'likert', label: '88. I have had difficulty paying attention for long periods of time. *', required: true, showIf: { field: 'fill_mfis', value: 'yes' }, options: [
            '(0) Never',
            '(1) Rarely',
            '(2) Sometimes',
            '(3) Often',
            '(4) Almost always'
          ]},
          { id: 'mfis_q89', type: 'likert', label: '89. I have been unable to think clearly. *', required: true, showIf: { field: 'fill_mfis', value: 'yes' }, options: [
            '(0) Never',
            '(1) Rarely',
            '(2) Sometimes',
            '(3) Often',
            '(4) Almost always'
          ]},
          { id: 'mfis_q90', type: 'likert', label: '90. I have been clumsy and uncoordinated. *', required: true, showIf: { field: 'fill_mfis', value: 'yes' }, options: [
            '(0) Never',
            '(1) Rarely',
            '(2) Sometimes',
            '(3) Often',
            '(4) Almost always'
          ]},
          { id: 'mfis_q91', type: 'likert', label: '91. I have been forgetful. *', required: true, showIf: { field: 'fill_mfis', value: 'yes' }, options: [
            '(0) Never',
            '(1) Rarely',
            '(2) Sometimes',
            '(3) Often',
            '(4) Almost always'
          ]},
          { id: 'mfis_q92', type: 'likert', label: '92. I have had to pace myself in my physical activities. *', required: true, showIf: { field: 'fill_mfis', value: 'yes' }, options: [
            '(0) Never',
            '(1) Rarely',
            '(2) Sometimes',
            '(3) Often',
            '(4) Almost always'
          ]},
          { id: 'mfis_q93', type: 'likert', label: '93. I have been less motivated to do anything that requires physical effort. *', required: true, showIf: { field: 'fill_mfis', value: 'yes' }, options: [
            '(0) Never',
            '(1) Rarely',
            '(2) Sometimes',
            '(3) Often',
            '(4) Almost always'
          ]},
          { id: 'mfis_q94', type: 'likert', label: '94. I have been less motivated to participate in social activities. *', required: true, showIf: { field: 'fill_mfis', value: 'yes' }, options: [
            '(0) Never',
            '(1) Rarely',
            '(2) Sometimes',
            '(3) Often',
            '(4) Almost always'
          ]},
          { id: 'mfis_q95', type: 'likert', label: '95. I have been limited in my ability to do things away from home. *', required: true, showIf: { field: 'fill_mfis', value: 'yes' }, options: [
            '(0) Never',
            '(1) Rarely',
            '(2) Sometimes',
            '(3) Often',
            '(4) Almost always'
          ]},
          { id: 'mfis_q96', type: 'likert', label: '96. I have trouble maintaining physical effort for long periods. *', required: true, showIf: { field: 'fill_mfis', value: 'yes' }, options: [
            '(0) Never',
            '(1) Rarely',
            '(2) Sometimes',
            '(3) Often',
            '(4) Almost always'
          ]},
          { id: 'mfis_q97', type: 'likert', label: '97. I have had difficulty making decisions. *', required: true, showIf: { field: 'fill_mfis', value: 'yes' }, options: [
            '(0) Never',
            '(1) Rarely',
            '(2) Sometimes',
            '(3) Often',
            '(4) Almost always'
          ]},
          { id: 'mfis_q98', type: 'likert', label: '98. I have been less motivated to do anything that requires thinking. *', required: true, showIf: { field: 'fill_mfis', value: 'yes' }, options: [
            '(0) Never',
            '(1) Rarely',
            '(2) Sometimes',
            '(3) Often',
            '(4) Almost always'
          ]},
          { id: 'mfis_q99', type: 'likert', label: '99. My muscles have felt weak. *', required: true, showIf: { field: 'fill_mfis', value: 'yes' }, options: [
            '(0) Never',
            '(1) Rarely',
            '(2) Sometimes',
            '(3) Often',
            '(4) Almost always'
          ]},
          { id: 'mfis_q100', type: 'likert', label: '100. I have been physically uncomfortable. *', required: true, showIf: { field: 'fill_mfis', value: 'yes' }, options: [
            '(0) Never',
            '(1) Rarely',
            '(2) Sometimes',
            '(3) Often',
            '(4) Almost always'
          ]},
          { id: 'mfis_q101', type: 'likert', label: '101. I have had trouble finishing tasks that require thinking. *', required: true, showIf: { field: 'fill_mfis', value: 'yes' }, options: [
            '(0) Never',
            '(1) Rarely',
            '(2) Sometimes',
            '(3) Often',
            '(4) Almost always'
          ]},
          { id: 'mfis_q102', type: 'likert', label: '102. I have had difficulty organizing my thoughts when doing things at home or at work. *', required: true, showIf: { field: 'fill_mfis', value: 'yes' }, options: [
            '(0) Never',
            '(1) Rarely',
            '(2) Sometimes',
            '(3) Often',
            '(4) Almost always'
          ]},
          { id: 'mfis_q103', type: 'likert', label: '103. I have been less able to complete tasks that require physical effort. *', required: true, showIf: { field: 'fill_mfis', value: 'yes' }, options: [
            '(0) Never',
            '(1) Rarely',
            '(2) Sometimes',
            '(3) Often',
            '(4) Almost always'
          ]},
          { id: 'mfis_q104', type: 'likert', label: '104. My thinking has been slowed down. *', required: true, showIf: { field: 'fill_mfis', value: 'yes' }, options: [
            '(0) Never',
            '(1) Rarely',
            '(2) Sometimes',
            '(3) Often',
            '(4) Almost always'
          ]},
          { id: 'mfis_q105', type: 'likert', label: '105. I have had trouble concentrating. *', required: true, showIf: { field: 'fill_mfis', value: 'yes' }, options: [
            '(0) Never',
            '(1) Rarely',
            '(2) Sometimes',
            '(3) Often',
            '(4) Almost always'
          ]},
          { id: 'mfis_q106', type: 'likert', label: '106. I have limited my physical activities. *', required: true, showIf: { field: 'fill_mfis', value: 'yes' }, options: [
            '(0) Never',
            '(1) Rarely',
            '(2) Sometimes',
            '(3) Often',
            '(4) Almost always'
          ]},
          { id: 'mfis_q107', type: 'likert', label: '107. I have needed to rest more often or for longer periods. *', required: true, showIf: { field: 'fill_mfis', value: 'yes' }, options: [
            '(0) Never',
            '(1) Rarely',
            '(2) Sometimes',
            '(3) Often',
            '(4) Almost always'
          ]}
        ]
      },
      {
        title: 'Section 7 - MoCA (Montreal Cognitive Assessment)',
        questions: [
          { id: 'fill_moca_ms', type: 'radio', label: '108. Do you want to fill in MoCA - Montreal Cognitive Assessment questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'moca_ms_q109', type: 'text', label: '109. Calculated sum of all subscores from MoCA test: *', required: true, showIf: { field: 'fill_moca_ms', value: 'yes' } }
        ]
      },
      {
        title: 'Section 8 - Barthel Index',
        questions: [
          { id: 'fill_barthel', type: 'radio', label: '110. Do you want to fill in Barthel Index questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'barthel_q111', type: 'likert', label: '111. Feeding *', required: true, showIf: { field: 'fill_barthel', value: 'yes' }, options: [
            '(0) unable',
            '(5) needs help cutting, spreading butter, etc., or requires modified diet',
            '(10) independent'
          ]},
          { id: 'barthel_q112', type: 'likert', label: '112. Bathing *', required: true, showIf: { field: 'fill_barthel', value: 'yes' }, options: [
            '(0) dependent',
            '(5) independent face (or in shower)'
          ]},
          { id: 'barthel_q113', type: 'likert', label: '113. Grooming *', required: true, showIf: { field: 'fill_barthel', value: 'yes' }, options: [
            '(0) needs to help with personal care',
            '(5) independent face/hair/teeth/shaving (implements provided)'
          ]},
          { id: 'barthel_q114', type: 'likert', label: '114. Dressing *', required: true, showIf: { field: 'fill_barthel', value: 'yes' }, options: [
            '(0) dependent',
            '(5) needs help but can do about half unaided',
            '(10) independent (including buttons, zips, laces, etc.)'
          ]},
          { id: 'barthel_q115', type: 'likert', label: '115. Bowels *', required: true, showIf: { field: 'fill_barthel', value: 'yes' }, options: [
            '(0) incontinent or needs to be given enemas',
            '(5) occasional accident',
            '(10) continent'
          ]},
          { id: 'barthel_q116', type: 'likert', label: '116. Bladder *', required: true, showIf: { field: 'fill_barthel', value: 'yes' }, options: [
            '(0) incontinent, or catheterized and unable to manage alone',
            '(5) occasional accident',
            '(10) continent'
          ]},
          { id: 'barthel_q117', type: 'likert', label: '117. Toilet use *', required: true, showIf: { field: 'fill_barthel', value: 'yes' }, options: [
            '(0) dependent',
            '(5) needs some help, but can do something alone',
            '(10) independent (on and off, dressing, wiping)'
          ]},
          { id: 'barthel_q118', type: 'likert', label: '118. Transfers (Bed to chair and back) *', required: true, showIf: { field: 'fill_barthel', value: 'yes' }, options: [
            '(0) unable, no sitting balance',
            '(5) major help (one or two people, physical), can sit',
            '(10) minor help (verbal or physical)',
            '(15) independent'
          ]},
          { id: 'barthel_q119', type: 'likert', label: '119. Mobility (on level surfaces) *', required: true, showIf: { field: 'fill_barthel', value: 'yes' }, options: [
            '(0) immobile or < 50 yards',
            '(5) wheelchair independent, including corners, > 50 yards',
            '(10) walks with help of one person (verbal or physical) > 50 yards',
            '(15) independent (but may use any aid; for example, stick) > 50 yards'
          ]},
          { id: 'barthel_q120', type: 'likert', label: '120. Stairs *', required: true, showIf: { field: 'fill_barthel', value: 'yes' }, options: [
            '(0) unable',
            '(5) needs help (verbal, physical, carrying aid)',
            '(10) independent'
          ]}
        ]
      }
    ]
  },
  ibd: {
    title: 'SOZO Irritable Bowel Disease - PRS Assessment',
    sections: [
      {
        title: 'Section 1 - General Data',
        questions: [
          { id: 'assessment_date', type: 'date', label: '1. Date of assessment *', required: true },
          { id: 'doctor_email', type: 'email', label: '2. Doctor Email *', required: true },
          { id: 'patient_name', type: 'text', label: '3. Patient Name and Surname *', required: true },
          { id: 'patient_id', type: 'text', label: '4. Patient ID *', required: true },
          { id: 'patient_age', type: 'radio', label: '5. Patient Age *', required: true, options: [
            { value: '<18', label: '< 18' },
            { value: '18-25', label: '18-25' },
            { value: '26-35', label: '26-35' },
            { value: '36-45', label: '36-45' },
            { value: '46-55', label: '46-55' },
            { value: '56-65', label: '56-65' },
            { value: '>65', label: '> 65' }
          ]},
          { id: 'gender', type: 'radio', label: '6. Gender *', required: true, options: [
            { value: 'male', label: 'Male' },
            { value: 'female', label: 'Female' },
            { value: 'non-binary', label: 'Non-binary' }
          ]},
          { id: 'visit_type', type: 'radio', label: '7. Please choose one of the following options *', required: true, options: [
            { value: 'first', label: 'First visit' },
            { value: 'followup1', label: 'Follow-up visit 1' },
            { value: 'followup2', label: 'Follow-up visit 2' },
            { value: 'followup3', label: 'Follow-up visit 3' }
          ]}
        ]
      },
      {
        title: 'Section 2 - EQ-5D-5L Health Questionnaire',
        questions: [
          { id: 'fill_eq5d', type: 'radio', label: '8. Do you want to fill in EQ-5D-5L questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'eq5d_mobility', type: 'likert', label: '9. Mobility *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, options: [
            '(1) I have no problems in walking about',
            '(2) I have slight problems in walking about',
            '(3) I have moderate problems in walking about',
            '(4) I have severe problems in walking about',
            '(5) I am unable to walk about'
          ]},
          { id: 'eq5d_self_care', type: 'likert', label: '10. Self Care *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, options: [
            '(1) I have no problems washing or dressing myself',
            '(2) I have slight problems washing or dressing myself',
            '(3) I have moderate problems washing or dressing myself',
            '(4) I have severe problems washing or dressing myself',
            '(5) I am unable to wash or dress myself'
          ]},
          { id: 'eq5d_usual_activities', type: 'likert', label: '11. Usual activities (e.g. work, study, housework, family or leisure activities) *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, options: [
            '(1) I have no problems doing my usual activities',
            '(2) I have slight problems doing my usual activities',
            '(3) I have moderate problems doing my usual activities',
            '(4) I have severe problems doing my usual activities',
            '(5) I am unable to do my usual activities'
          ]},
          { id: 'eq5d_pain', type: 'likert', label: '12. Pain/Discomfort *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, options: [
            '(1) I have no pain or discomfort',
            '(2) I have slight pain or discomfort',
            '(3) I have moderate pain or discomfort',
            '(4) I have severe pain or discomfort',
            '(5) I have extreme pain or discomfort'
          ]},
          { id: 'eq5d_anxiety', type: 'likert', label: '13. Anxiety/Depression *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, options: [
            '(1) I am not anxious or depressed',
            '(2) I am slightly anxious or depressed',
            '(3) I am moderately anxious or depressed',
            '(4) I am severely anxious or depressed',
            '(5) I am extremely anxious or depressed'
          ]},
          { id: 'eq5d_health_today', type: 'slider', label: '14. We would like to know how good or bad your health is TODAY (0=worst health you can imagine, 10=best health you can imagine) *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, min: 0, max: 10 }
        ]
      },
      {
        title: 'Section 3 - COMPASS 31',
        questions: [
          { id: 'fill_compass31', type: 'radio', label: '15. Do you want to fill in COMPASS-31 questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'compass_faint_standing', type: 'radio', label: '16. In the past year, have you ever felt faint, dizzy, "goofy", or had difficulty thinking soon after standing up from a sitting or lying position? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            { value: 'yes', label: '(1) Yes' },
            { value: 'no', label: '(2) No' }
          ]},
          { id: 'compass_faint_frequency', type: 'likert', label: '17. When standing up, how frequently do you get these feelings or symptoms? *', required: true, showIf: { field: 'compass_faint_standing', value: 'yes' }, options: [
            '(1) Rarely',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Almost Always'
          ]},
          { id: 'compass_faint_severity', type: 'likert', label: '18. How would you rate the severity of these feelings or symptoms? *', required: true, showIf: { field: 'compass_faint_standing', value: 'yes' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass_faint_changes', type: 'likert', label: '19. In the past year, have these feelings or symptoms that you have experienced: *', required: true, showIf: { field: 'compass_faint_standing', value: 'yes' }, options: [
            '(1) Gotten much worse',
            '(2) Gotten somewhat worse',
            '(3) Stayed about the same',
            '(4) Gotten somewhat better',
            '(5) Gotten much better Completely gone'
          ]},
          { id: 'compass_skin_color', type: 'radio', label: '20. In the past year, have you ever noticed color changes in your skin, such as red, white, or purple? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            { value: 'yes', label: '(1) Yes' },
            { value: 'no', label: '(2) No' }
          ]},
          { id: 'compass_skin_parts', type: 'checkbox', label: '21. What parts of your body are affected by these color changes? (Check all that apply) *', required: true, showIf: { field: 'compass_skin_color', value: 'yes' }, options: [
            { value: 'hands', label: '(1) Hands' },
            { value: 'feet', label: '(2) Feet' }
          ]},
          { id: 'compass_skin_changes', type: 'likert', label: '22. Are these changes in your skin color: *', required: true, showIf: { field: 'compass_skin_color', value: 'yes' }, options: [
            '(1) Getting much worse',
            '(2) Getting somewhat worse',
            '(3) Staying about the same',
            '(4) Getting somewhat better',
            '(5) Getting much better',
            '(6) Completely gone'
          ]},
          { id: 'compass_sweating', type: 'likert', label: '23. In the past 5 years, what changes, if any, have occurred in your general body sweating? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) I sweat much more than I used to',
            '(2) I sweat somewhat more than I used to',
            '(3) I haven\'t noticed any changes in my sweating',
            '(4) I sweat somewhat less than I used to',
            '(5) I sweat much less than I used to'
          ]},
          { id: 'compass_dry_eyes', type: 'radio', label: '24. Do your eyes feel excessively dry? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            { value: 'yes', label: '(1) Yes' },
            { value: 'no', label: '(2) No' }
          ]},
          { id: 'compass_dry_mouth', type: 'radio', label: '25. Does your mouth feel excessively dry? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            { value: 'yes', label: '(1) Yes' },
            { value: 'no', label: '(2) No' }
          ]},
          { id: 'compass_dry_symptom_changes', type: 'likert', label: '26. For the symptom of dry eyes or dry mouth that you have had for the longest period of time, is this symptom: *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) I have not had any of these symptoms',
            '(2) Getting much worse',
            '(3) Getting somewhat worse',
            '(4) Staying about the same',
            '(5) Getting somewhat better',
            '(6) Getting much better',
            '(7) Completely gone'
          ]},
          { id: 'compass_full_quickly', type: 'likert', label: '27. In the past year, have you noticed any changes in how quickly you get full when eating a meal? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) I get full a lot more quickly now than I used to',
            '(2) I get full more quickly now than I used to',
            '(3) I haven\'t noticed any change',
            '(4) I get full less quickly now than I used to',
            '(5) I get full a lot less quickly now than I used to'
          ]},
          { id: 'compass_bloated', type: 'likert', label: '28. In the past year, have you felt excessively full or persistently full (bloated feeling) after a meal? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Sometimes',
            '(3) A lot of times'
          ]},
          { id: 'compass_vomiting', type: 'likert', label: '29. In the past year, have you vomited after a meal? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Sometimes',
            '(3) A lot of time'
          ]},
          { id: 'compass_cramping', type: 'likert', label: '30. In the past year, have you had a cramping or colicky abdominal pain? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Sometimes',
            '(3) A lot of times'
          ]},
          { id: 'compass_diarrhea', type: 'radio', label: '31. In the past year, have you had any bouts of diarrhea? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            { value: 'yes', label: '(1) Yes' },
            { value: 'no', label: '(2) No' }
          ]},
          { id: 'compass_diarrhea_frequency', type: 'likert', label: '32. How frequently does this occur? *', required: true, showIf: { field: 'compass_diarrhea', value: 'yes' }, options: [
            '(1) Rarely',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass_diarrhea_severity', type: 'likert', label: '33. How severe are these bouts of diarrhea? *', required: true, showIf: { field: 'compass_diarrhea', value: 'yes' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass_diarrhea_changes', type: 'likert', label: '34. Are your bouts of diarrhea getting: *', required: true, showIf: { field: 'compass_diarrhea', value: 'yes' }, options: [
            '(1) Much worse',
            '(2) Somewhat worse',
            '(3) Staying the same',
            '(4) Much better',
            '(5) Completely gone'
          ]},
          { id: 'compass_constipation', type: 'radio', label: '35. In the past year, have you been constipated? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            { value: 'yes', label: '(1) Yes' },
            { value: 'no', label: '(2) No' }
          ]},
          { id: 'compass_constipation_frequency', type: 'likert', label: '36. How frequently are you constipated? *', required: true, showIf: { field: 'compass_constipation', value: 'yes' }, options: [
            '(1) Rarely',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass_constipation_severity', type: 'likert', label: '37. How severe are these episodes of constipation? *', required: true, showIf: { field: 'compass_constipation', value: 'yes' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass_constipation_changes', type: 'likert', label: '38. Is your constipation getting: *', required: true, showIf: { field: 'compass_constipation', value: 'yes' }, options: [
            '(1) Much worse',
            '(2) Somewhat worse',
            '(3) Staying the same',
            '(4) Somewhat better',
            '(5) Much better',
            '(6) Completely gone'
          ]},
          { id: 'compass_bladder_control', type: 'likert', label: '39. In the past year, have you ever lost control of your bladder function? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass_difficulty_urinating', type: 'likert', label: '40. In the past year, have you had difficulty passing urine? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass_emptying_bladder', type: 'likert', label: '41. In the past year, have you had trouble completely emptying your bladder? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass_bright_light', type: 'likert', label: '42. In the past year, without sunglasses or tinted glasses, has bright light bothered your eyes? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass_bright_light_severity', type: 'likert', label: '43. How severe is this sensitivity to bright light? *', required: true, showIf: { field: 'compass_bright_light', valueNot: '(1) Never' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass_focusing_eyes', type: 'likert', label: '44. In the past year, have you had trouble focusing your eyes? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass_focusing_severity', type: 'likert', label: '45. How severe is this focusing problem? *', required: true, showIf: { field: 'compass_focusing_eyes', valueNot: '(1) Never' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass_eye_symptoms_changes', type: 'likert', label: '46. Is the most troublesome symptom with your eyes (i.e. sensitivity to bright light or trouble focusing) getting: *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) I have not had any of these symptoms',
            '(2) Much worse',
            '(3) Somewhat worse',
            '(4) Staying about the same',
            '(5) Somewhat better',
            '(6) Much better',
            '(7) Completely gone'
          ]}
        ]
      },
      {
        title: 'Section 4 - IBS-SSS - IBS Symptom Severity Scale',
        questions: [
          { id: 'fill_ibs_sss', type: 'radio', label: '47. Do you want to fill in IBS-SSS - IBS Symptom Severity Scale questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'ibs_abdominal_pain_current', type: 'radio', label: '48. Do you currently suffer from abdomen or belly pain? *', required: true, showIf: { field: 'fill_ibs_sss', value: 'yes' }, options: [
            { value: 'yes', label: '(1) Yes' },
            { value: 'no', label: '(2) No' }
          ]},
          { id: 'ibs_abdominal_pain_severity', type: 'slider', label: '49. Indicate the severity of your abdomen or belly pain (0=None, 10=Severe) *', required: true, showIf: { field: 'ibs_abdominal_pain_current', value: 'yes' }, min: 0, max: 10 },
          { id: 'ibs_abdominal_pain_days', type: 'number', label: '50. Enter the number of days that you typically experience abdominal pain every 10 days (For example, if you enter 4, it means that you get pain 4 out of 10 days. If you get pain every day, enter 10.) *', required: true, showIf: { field: 'fill_ibs_sss', value: 'yes' }, },
          { id: 'ibs_abdominal_distension_current', type: 'radio', label: '51. Do you currently suffer from abdominal distension? (bloating, swollen or tight tummy) (*Women, please ignore distension related to your periods.) *', required: true, showIf: { field: 'fill_ibs_sss', value: 'yes' }, options: [
            { value: 'yes', label: '(1) Yes' },
            { value: 'no', label: '(2) No' }
          ]},
          { id: 'ibs_abdominal_distension_severity', type: 'slider', label: '52. Indicate the severity of your abdominal distension/tightness (0=None, 10=Severe) *', required: true, showIf: { field: 'ibs_abdominal_distension_current', value: 'yes' }, min: 0, max: 10 },
          { id: 'ibs_bowel_habits_satisfaction', type: 'slider', label: '53. Indicate how satisfied you are with your bowel habits (0=Very Dissatisfied, 10=Very Satisfied) *', required: true, showIf: { field: 'fill_ibs_sss', value: 'yes' }, min: 0, max: 10 },
          { id: 'ibs_life_interference', type: 'slider', label: '54. Indicate how much your Irritable Bowel Syndrome affects or interferes with your life in general (0=Not at all, 10=Completely) *', required: true, showIf: { field: 'fill_ibs_sss', value: 'yes' }, min: 0, max: 10 }
        ]
      },
      {
        title: 'Section 5 - Pain Rating Scale',
        questions: [
          { id: 'fill_pain_rating', type: 'radio', label: '55. Do you want to fill in Pain Rating Scale questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'pain_intensity_now', type: 'slider', label: '56. How intense is your pain now? (0=No pain, 10=Worst pain imaginable) *', required: true, showIf: { field: 'fill_pain_rating', value: 'yes' }, min: 0, max: 10 },
          { id: 'pain_intensity_average', type: 'slider', label: '57. How intense was your pain on average last week? (0=No pain, 10=Worst pain imaginable) *', required: true, showIf: { field: 'fill_pain_rating', value: 'yes' }, min: 0, max: 10 },
          { id: 'pain_distress_now', type: 'slider', label: '58. How distressing is your pain now? (0=Not distressing, 10=Extremely distressing) *', required: true, showIf: { field: 'fill_pain_rating', value: 'yes' }, min: 0, max: 10 },
          { id: 'pain_distress_average', type: 'slider', label: '59. How distressing was your pain on average last week? (0=Not distressing, 10=Extremely distressing) *', required: true, showIf: { field: 'fill_pain_rating', value: 'yes' }, min: 0, max: 10 },
          { id: 'pain_interference', type: 'slider', label: '60. How much does your pain interfere with your normal everyday activities? (0=No interference, 10=Complete interference) *', required: true, showIf: { field: 'fill_pain_rating', value: 'yes' }, min: 0, max: 10 }
        ]
      },
      {
        title: 'Section 6 - DASS 21',
        questions: [
          { id: 'fill_dass21', type: 'radio', label: '61. Do you want to fill in DASS-21 questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'dass_wind_down', type: 'likert', label: '62. (S) I found it hard to wind down. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_dry_mouth', type: 'likert', label: '63. (A) I was aware of dryness of my mouth. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_no_positive', type: 'likert', label: '64. (D) I couldn\'t seem to experience any positive feeling at all. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_breathing', type: 'likert', label: '65. (A) I experienced breathing difficulty (e.g. excessively rapid breathing, breathlessness in the absence of physical exertion). *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_initiative', type: 'likert', label: '66. (D) I found it difficult to work up the initiative to do things. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_overreact', type: 'likert', label: '67. (S) I tended to over-react to situations. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_trembling', type: 'likert', label: '68. (A) I experienced trembling (e.g. in the hands). *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_nervous_energy', type: 'likert', label: '69. (S) I felt that I was using a lot of nervous energy. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_panic', type: 'likert', label: '70. (A) I was worried about situations in which I might panic and make a fool of myself. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_nothing_forward', type: 'likert', label: '71. (D) I felt that I had nothing to look forward to. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_agitated', type: 'likert', label: '72. (S) I found myself getting agitated. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_relax', type: 'likert', label: '73. (S) I found it difficult to relax. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_downhearted', type: 'likert', label: '74. (D) I felt down-hearted and blue. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_intolerant', type: 'likert', label: '75. (S) I was intolerant of anything that kept me from getting on with what I was doing. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_close_panic', type: 'likert', label: '76. (A) I felt I was close to panic. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_enthusiastic', type: 'likert', label: '77. (D) I was unable to become enthusiastic about anything. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_not_worth', type: 'likert', label: '78. (D) I felt I wasn\'t worth much as a person. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_touchy', type: 'likert', label: '79. (S) I felt that I was rather touchy. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_heart_action', type: 'likert', label: '80. (A) I was aware of the action of my heart in the absence of physical exertion (e.g. sense of heart rate increase, heart missing a beat). *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_scared', type: 'likert', label: '81. (A) I felt scared without any good reason. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_meaningless', type: 'likert', label: '82. (D) I felt that life was meaningless. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]}
        ]
      },
      {
        title: 'Section 7 - BDI-II - Beck\'s Depression Inventory Version 2',
        questions: [
          { id: 'fill_bdi2', type: 'radio', label: '83. Do you want to fill in BDI-II - Beck\'s Depression Inventory questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'bdi_sadness', type: 'likert', label: '84. Sadness *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            '(0) I do not feel sad',
            '(1) I feel sad much of the time',
            '(2) I am sad all the time',
            '(3) I am so sad or unhappy that I can\'t stand it'
          ]},
          { id: 'bdi_pessimism', type: 'likert', label: '85. Pessimism *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            '(0) I am not discouraged about my future',
            '(1) I feel more discouraged about my future than I used to be',
            '(2) I do not expect things to work out for me',
            '(3) I feel my future is hopeless and will only get worse'
          ]},
          { id: 'bdi_past_failure', type: 'likert', label: '86. Past failure *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            '(0) I do not feel like a failure',
            '(1) I have failed more than I should have',
            '(2) As I look back, I see a lot of failures',
            '(3) I feel I am a total failure as a person'
          ]},
          { id: 'bdi_loss_pleasure', type: 'likert', label: '87. Loss of pleasure *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            '(0) I get as much pleasure as I ever did from the things I enjoy',
            '(1) I don\'t enjoy things as much as I used to',
            '(2) I get very little pleasure from the things I used to enjoy',
            '(3) I can\'t get any pleasure from the things I used to enjoy'
          ]},
          { id: 'bdi_guilty_feelings', type: 'likert', label: '88. Guilty feelings *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            '(0) I don\'t feel particularly guilty',
            '(1) I feel guilty over many things I have done or should have done',
            '(2) I feel quite guilty most of the time',
            '(3) I feel guilty all of the time'
          ]},
          { id: 'bdi_punishment_feelings', type: 'likert', label: '89. Punishment feelings *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            '(0) I don\'t feel I am being punished',
            '(1) I feel I may be punished',
            '(2) I expect to be punished',
            '(3) I feel I am being punished'
          ]},
          { id: 'bdi_self_dislike', type: 'likert', label: '90. Self-Dislike *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            '(0) I feel the same about myself as ever',
            '(1) I have lost confidence in myself',
            '(2) I am disappointed in myself',
            '(3) I dislike myself'
          ]},
          { id: 'bdi_self_criticalness', type: 'likert', label: '91. Self-Criticalness *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            '(0) I don\'t criticize or blame myself more than usual',
            '(1) I am more critical of myself than I used to be',
            '(2) I criticize myself for all of my faults',
            '(3) I blame myself for everything bad that happens'
          ]},
          { id: 'bdi_suicidal_thoughts', type: 'likert', label: '92. Suicidal Thoughts or Wishes *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            '(0) I don\'t have any thoughts of killing myself',
            '(1) I have thoughts of killing myself, but I would not carry them out',
            '(2) I would like to kill myself',
            '(3) I would kill myself if I had the chance'
          ]},
          { id: 'bdi_crying', type: 'likert', label: '93. Crying *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            '(0) I don\'t cry any more than I used to',
            '(1) I cry more than I used to',
            '(2) I cry over every little thing',
            '(3) I feel like crying, but I can\'t'
          ]},
          { id: 'bdi_agitation', type: 'likert', label: '94. Agitation *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            '(0) I am no more restless or wound up than usual',
            '(1) I feel more restless or wound up than usual',
            '(2) I am so restless or agitated that it\'s hard to stay still',
            '(3) I am so restless or agitated that I have to keep moving or doing something'
          ]},
          { id: 'bdi_loss_interest', type: 'likert', label: '95. Loss of Interest *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            '(0) I have not lost interest in other people or activities',
            '(1) I am less interested in other people or things than before',
            '(2) I have lost most of my interest in other people or things',
            '(3) It\'s hard to get interested in anything'
          ]},
          { id: 'bdi_indecisiveness', type: 'likert', label: '96. Indecisiveness *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            '(0) I make decisions about as well as ever',
            '(1) I find it more difficult to make decisions than usual',
            '(2) I have much greater difficulty in making decisions than I used to',
            '(3) I have trouble making any decisions'
          ]},
          { id: 'bdi_worthlessness', type: 'likert', label: '97. Worthlessness *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            '(0) I do not feel I am worthless',
            '(1) I don\'t consider myself as worthwhile and useful as I used to',
            '(2) I feel more worthless as compared to other people',
            '(3) I feel utterly worthless'
          ]},
          { id: 'bdi_loss_energy', type: 'likert', label: '98. Loss of Energy *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            '(0) I have as much energy as ever',
            '(1) I have less energy than I used to have',
            '(2) I don\'t have enough energy to do very much',
            '(3) I don\'t have enough energy to do anything'
          ]},
          { id: 'bdi_sleep_changes', type: 'likert', label: '99. Changes in Sleeping Pattern *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            '(0) I have not experienced any change in my sleeping pattern',
            '(1) I sleep somewhat more than usual',
            '(2) I sleep somewhat less than usual',
            '(3) I sleep a lot more than usual',
            '(4) I sleep a lot less than usual',
            '(5) I sleep most of the day',
            '(6) I wake up 1-2 hours early and can\'t get back to sleep'
          ]},
          { id: 'bdi_irritability', type: 'likert', label: '100. Irritability *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            '(0) I am no more irritable than usual',
            '(1) I am more irritable than usual',
            '(2) I am much more irritable than usual',
            '(3) I am irritable all the time'
          ]},
          { id: 'bdi_appetite_changes', type: 'likert', label: '101. Changes in Appetite *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            '(0) I have not experienced any changes in my appetite',
            '(1) My appetite is somewhat less than usual',
            '(2) My appetite is somewhat greater than usual',
            '(3) My appetite is much less than before',
            '(4) My appetite is much greater than usual',
            '(5) I have no appetite at all',
            '(6) I crave food all the time'
          ]},
          { id: 'bdi_concentration', type: 'likert', label: '102. Concentration Difficulty *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            '(0) I can concentrate as well as ever',
            '(1) I can\'t concentrate as well as usual',
            '(2) It\'s hard to keep my mind on anything for very long',
            '(3) I find I can\'t concentrate on anything'
          ]},
          { id: 'bdi_tiredness', type: 'likert', label: '103. Tiredness or Fatigue *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            '(0) I am no more tired or fatigued than usual',
            '(1) I get more tired or fatigued more easily than usual',
            '(2) I am too tired or fatigued to do a lot of the things I used to do',
            '(3) I am too tired or fatigued to do most of the things I used to do'
          ]},
          { id: 'bdi_loss_sex_interest', type: 'likert', label: '104. Loss of Interest in Sex *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            '(0) I have not noticed any recent change in my interest in sex',
            '(1) I am less interested in sex than I used to be',
            '(2) I am much less interested in sex now',
            '(3) I have lost interest in sex completely'
          ]}
        ]
      },
      {
        title: 'Section 8 - HDRS - Hamilton Depression Rating Scale',
        questions: [
          { id: 'fill_hdrs', type: 'radio', label: '105. Do you want to fill in HDRS - Hamilton Depression Rating Scale questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'hdrs_depressed_mood', type: 'likert', label: '106. DEPRESSED MOOD (sadness, hopeless, helpless, worthless) *', required: true, showIf: { field: 'fill_hdrs', value: 'yes' }, options: [
            '(0) Absent',
            '(1) These feeling states indicated only on questioning',
            '(2) These feeling states spontaneously reported verbally',
            '(3) Communicates feeling states non-verbally, i.e. through facial expression, posture, voice and tendency to weep',
            '(4) Patient reports virtually only these feeling states in his/her spontaneous verbal and non-verbal communication'
          ]},
          { id: 'hdrs_guilt', type: 'likert', label: '107. FEELINGS OF GUILT *', required: true, showIf: { field: 'fill_hdrs', value: 'yes' }, options: [
            '(0) Absent',
            '(1) Self reproach, feels he/she has let people down',
            '(2) Ideas of guilt or rumination over past errors or sinful deeds',
            '(3) Present illness is a punishment. Delusions of guilt',
            '(4) Hears accusatory or denunciatory voices and/or experiences threatening visual hallucinations'
          ]},
          { id: 'hdrs_suicide', type: 'likert', label: '108. SUICIDE *', required: true, showIf: { field: 'fill_hdrs', value: 'yes' }, options: [
            '(0) Absent',
            '(1) Feels life is not worth living',
            '(2) Wishes he/she were dead or any thoughts of possible death to self',
            '(3) Ideas or gestures of suicide',
            '(4) Attempts at suicide (any serious attempt rate 4)'
          ]},
          { id: 'hdrs_insomnia_early', type: 'likert', label: '109. INSOMNIA: EARLY IN THE NIGHT *', required: true, showIf: { field: 'fill_hdrs', value: 'yes' }, options: [
            '(0) No difficulty falling asleep',
            '(1) Complains of occasional difficulty falling asleep, i.e. more than 1/2 hour',
            '(2) Complains of nightly difficulty falling asleep'
          ]},
          { id: 'hdrs_insomnia_middle', type: 'likert', label: '110. INSOMNIA: MIDDLE OF THE NIGHT *', required: true, showIf: { field: 'fill_hdrs', value: 'yes' }, options: [
            '(0) No difficulty',
            '(1) Patient complains of being restless and disturbed during the night',
            '(2) Waking during the night – any getting out of bed rates 2 (except for purposes of voiding)'
          ]},
          { id: 'hdrs_insomnia_morning', type: 'likert', label: '111. INSOMNIA: EARLY HOURS OF THE MORNING *', required: true, showIf: { field: 'fill_hdrs', value: 'yes' }, options: [
            '(0) No difficulty',
            '(1) Waking in early hours of the morning but goes back to sleep',
            '(2) Unable to fall asleep again if he/she gets out of bed'
          ]},
          { id: 'hdrs_work_activities', type: 'likert', label: '112. WORK AND ACTIVITIES *', required: true, showIf: { field: 'fill_hdrs', value: 'yes' }, options: [
            '(0) No difficulty',
            '(1) Thoughts and feelings of incapacity, fatigue or weakness related to activities, work or hobbies',
            '(2) Loss of interest in activity, hobbies or work – either directly reported by the patient or indirect in listlessness, indecision and vacillation (feels he/she has to push self to work or activities)',
            '(3) Decrease in actual time spent in activities or decrease in productivity. Rate 3 if the patient does not spend at least three hours a day in activities (job or hobbies) excluding routine chores',
            '(4) Stopped working because of present illness. Rate 4 if patient engages in no activities except routine chores, or if patient fails to perform routine chores unassisted'
          ]},
          { id: 'hdrs_retardation', type: 'likert', label: '113. RETARDATION (slowness of thought and speech, impaired ability to concentrate, decreased motor activity) *', required: true, showIf: { field: 'fill_hdrs', value: 'yes' }, options: [
            '(0) Normal speech and thought',
            '(1) Slight retardation during the interview',
            '(2) Obvious retardation during the interview',
            '(3) Interview difficult',
            '(4) Complete stupor'
          ]},
          { id: 'hdrs_agitation', type: 'likert', label: '114. AGITATION *', required: true, showIf: { field: 'fill_hdrs', value: 'yes' }, options: [
            '(0) None',
            '(1) Fidgetiness',
            '(2) Playing with hands, hair, etc.',
            '(3) Moving about, can\'t sit still',
            '(4) Hand wringing, nail biting, hair-pulling, biting of lips'
          ]},
          { id: 'hdrs_anxiety_psychic', type: 'likert', label: '115. ANXIETY PSYCHIC *', required: true, showIf: { field: 'fill_hdrs', value: 'yes' }, options: [
            '(0) No difficulty',
            '(1) Subjective tension and irritability',
            '(2) Worrying about minor matters',
            '(3) Apprehensive attitude apparent in face or speech',
            '(4) Fears expressed without questioning'
          ]},
          { id: 'hdrs_anxiety_somatic', type: 'likert', label: '116. ANXIETY SOMATIC (physiological concomitants of anxiety) such as: gastro-intestinal, cardio-vascular, respiratory, urinary frequency, sweating *', required: true, showIf: { field: 'fill_hdrs', value: 'yes' }, options: [
            '(0) Absent',
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe',
            '(4) Incapacitating'
          ]},
          { id: 'hdrs_somatic_gastro', type: 'likert', label: '117. SOMATIC SYMPTOMS GASTRO-INTESTINAL *', required: true, showIf: { field: 'fill_hdrs', value: 'yes' }, options: [
            '(0) None',
            '(1) Loss of appetite but eating without staff encouragement. Heavy feelings in abdomen',
            '(2) Difficulty eating without staff urging. Requests or requires laxatives or medication for bowels or medication for gastro-intestinal symptoms'
          ]},
          { id: 'hdrs_somatic_general', type: 'likert', label: '118. GENERAL SOMATIC SYMPTOMS *', required: true, showIf: { field: 'fill_hdrs', value: 'yes' }, options: [
            '(0) None',
            '(1) Heaviness in limbs, back or head. Backaches, headaches, muscle aches. Loss of energy and fatigability',
            '(2) Any clear-cut symptom rates 2'
          ]},
          { id: 'hdrs_genital_symptoms', type: 'likert', label: '119. GENITAL SYMPTOMS (symptoms such as loss of libido, menstrual disturbances) *', required: true, showIf: { field: 'fill_hdrs', value: 'yes' }, options: [
            '(0) Absent',
            '(1) Mild',
            '(2) Severe'
          ]},
          { id: 'hdrs_hypochondriasis', type: 'likert', label: '120. HYPOCHONDRIASIS *', required: true, showIf: { field: 'fill_hdrs', value: 'yes' }, options: [
            '(0) Not present',
            '(1) Self-absorption (bodily)',
            '(2) Preoccupation with health',
            '(3) Frequent complaints, requests for help, etc.',
            '(4) Hypochondriacal delusions'
          ]},
          { id: 'hdrs_weight_loss_type', type: 'radio', label: '121. Loss of weight *', required: true, showIf: { field: 'fill_hdrs', value: 'yes' }, options: [
            { value: 'patient', label: 'According to patient' },
            { value: 'measurements', label: 'According to measurements' }
          ]},
          { id: 'hdrs_weight_loss_patient', type: 'likert', label: '122. LOSS OF WEIGHT - According to the patient *', required: true, showIf: { field: 'hdrs_weight_loss_type', value: 'patient' }, options: [
            '(0) No weight loss',
            '(1) Probable weight loss associated with present illness',
            '(2) Definite weight loss',
            '(3) Not assessed'
          ]},
          { id: 'hdrs_weight_loss_measured', type: 'likert', label: '123. LOSS OF WEIGHT - According to weekly measurements *', required: true, showIf: { field: 'hdrs_weight_loss_type', value: 'measurements' }, options: [
            '(0) Less than 1 lb weight loss in week',
            '(1) Greater than 1 lb weight loss in week',
            '(2) Greater than 2 lb weight loss in week',
            '(3) Not assessed'
          ]},
          { id: 'hdrs_insight', type: 'likert', label: '124. INSIGHT *', required: true, showIf: { field: 'fill_hdrs', value: 'yes' }, options: [
            '(0) Acknowledges being depressed and ill',
            '(1) Acknowledges illness but attributes cause to bad food, climate, overwork, virus, need for rest, etc.',
            '(2) Denies being ill at all'
          ]}
        ]
      },
      {
        title: 'Section 9 - SOZO Privacy Policy',
        questions: [
          { id: 'privacy_policy_agreement', type: 'checkbox', label: '125. IT IS IMPORTANT THAT YOU READ AND UNDERSTAND THE SOZO PRIVACY POLICY BEFORE SUBMITTING THIS FORM (https://sozobraincenter.com/privacy-policy/). The undersigned acknowledges and confirms that they have read and understood the terms of the SOZO Privacy Policy and that the information provided herein is collected and processed in accordance with the terms of the said policy. *', required: true, options: [
            { value: 'agree', label: 'I have read and agree to the SOZO Privacy Policy' }
          ]}
        ]
      },
      {
        title: 'Section 10 - Sleep-50',
        description: 'Please respond to what extent a statement (item) has been applicable to you during the past 4 weeks. Score each item on a 4-point-scale.',
        questions: [
          { id: 'fill_sleep50', type: 'radio', label: '128. Do you want to fill in Sleep-50 questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { 
            id: 'sleep50_section1', 
            type: 'table', 
            label: '129. Sleep-50 SECTION 1', 
            required: true, 
            showIf: { field: 'fill_sleep50', value: 'yes' },
            tableQuestions: [
              'I am told that I snore.',
              'I sweat during the night.',
              'I am told that I hold my breath when sleeping.',
              'I am told that I wake up gasping for air.',
              'I wake up with a dry mouth.',
              'I wake up during the night while coughing or being short of breath.',
              'I wake up with a sour taste in my mouth.',
              'I wake up with a headache.'
            ],
            options: [
              { value: '1', label: '(1) Not at all' },
              { value: '2', label: '(2) Somewhat' },
              { value: '3', label: '(3) Rather much' },
              { value: '4', label: '(4) Very much' }
            ]
          },
          { 
            id: 'sleep50_section2', 
            type: 'table', 
            label: '130. Sleep-50 SECTION 2', 
            required: true, 
            showIf: { field: 'fill_sleep50', value: 'yes' },
            tableQuestions: [
              'I have difficulty in falling asleep.',
              'Thoughts go through my head and keep me awake.',
              'I worry and find it hard to relax.',
              'I wake up during the night.',
              'After waking up during the night, I fall asleep slowly.',
              'I wake up early and cannot get back to sleep.',
              'I sleep lightly.',
              'I sleep too little.'
            ],
            options: [
              { value: '1', label: '(1) Not at all' },
              { value: '2', label: '(2) Somewhat' },
              { value: '3', label: '(3) Rather much' },
              { value: '4', label: '(4) Very much' }
            ]
          },
          { 
            id: 'sleep50_section3', 
            type: 'table', 
            label: '131. Sleep-50 SECTION 3', 
            required: true, 
            showIf: { field: 'fill_sleep50', value: 'yes' },
            tableQuestions: [
              'I see dreamlike images when falling asleep or waking up.',
              'I sometimes fall asleep on a social occasion.',
              'I have sleep attacks during the day.',
              'With intense emotions, my muscles sometimes collapse during the day.',
              'I sometimes cannot move when falling asleep or waking up.'
            ],
            options: [
              { value: '1', label: '(1) Not at all' },
              { value: '2', label: '(2) Somewhat' },
              { value: '3', label: '(3) Rather much' },
              { value: '4', label: '(4) Very much' }
            ]
          },
          { 
            id: 'sleep50_section4', 
            type: 'table', 
            label: '132. Sleep-50 SECTION 4', 
            required: true, 
            showIf: { field: 'fill_sleep50', value: 'yes' },
            tableQuestions: [
              'I am told that I kick my legs when I sleep.',
              'I have cramps or pain in my legs during the night.',
              'I feel little shocks in my legs during the night.',
              'I cannot keep my legs at rest when falling asleep.'
            ],
            options: [
              { value: '1', label: '(1) Not at all' },
              { value: '2', label: '(2) Somewhat' },
              { value: '3', label: '(3) Rather much' },
              { value: '4', label: '(4) Very much' }
            ]
          },
          { 
            id: 'sleep50_section5', 
            type: 'table', 
            label: '133. Sleep-50 SECTION 5', 
            required: true, 
            showIf: { field: 'fill_sleep50', value: 'yes' },
            tableQuestions: [
              'I would rather go to bed at a different time.',
              'I go to bed at very different times (more than 2 hr difference).',
              'I do shift work.'
            ],
            options: [
              { value: '1', label: '(1) Not at all' },
              { value: '2', label: '(2) Somewhat' },
              { value: '3', label: '(3) Rather much' },
              { value: '4', label: '(4) Very much' }
            ]
          },
          { 
            id: 'sleep50_section6', 
            type: 'table', 
            label: '134. Sleep-50 SECTION 6', 
            required: true, 
            showIf: { field: 'fill_sleep50', value: 'yes' },
            tableQuestions: [
              'I sometimes walk when I am sleeping.',
              'I sometimes wake up in a different place than where I fell asleep.',
              'I sometimes find evidence of having performed an action during the night I do not remember.'
            ],
            options: [
              { value: '1', label: '(1) Not at all' },
              { value: '2', label: '(2) Somewhat' },
              { value: '3', label: '(3) Rather much' },
              { value: '4', label: '(4) Very much' }
            ]
          },
          { 
            id: 'sleep50_section7', 
            type: 'table', 
            label: '135. Sleep-50 SECTION 7', 
            required: true, 
            showIf: { field: 'fill_sleep50', value: 'yes' },
            tableQuestions: [
              'I have frightening dreams (if not go to Q126).',
              'I wake up from these dreams.',
              'I remember the content of these dreams.',
              'I can orientate quickly after these dreams.',
              'I have physical symptoms during or after these dreams (e.g., movements, sweating, heart palpitations, shortness of breath).'
            ],
            options: [
              { value: '1', label: '(1) Not at all' },
              { value: '2', label: '(2) Somewhat' },
              { value: '3', label: '(3) Rather much' },
              { value: '4', label: '(4) Very much' }
            ]
          },
          { 
            id: 'sleep50_section8', 
            type: 'table', 
            label: '136. Sleep-50 SECTION 8', 
            required: true, 
            showIf: { field: 'fill_sleep50', value: 'yes' },
            tableQuestions: [
              'It is too light in my bedroom during the night.',
              'It is too noisy in my bedroom during the night.',
              'I drink alcoholic beverages during the evening.',
              'I smoke during the evening.',
              'I use other substances during the evening (e.g., sleep or other medication).',
              'I feel sad.',
              'I have no pleasure or interest in daily occupations.'
            ],
            options: [
              { value: '1', label: '(1) Not at all' },
              { value: '2', label: '(2) Somewhat' },
              { value: '3', label: '(3) Rather much' },
              { value: '4', label: '(4) Very much' }
            ]
          },
          { 
            id: 'sleep50_section9', 
            type: 'table', 
            label: '137. Sleep-50 SECTION 9', 
            required: true, 
            showIf: { field: 'fill_sleep50', value: 'yes' },
            tableQuestions: [
              'I feel tired at getting up.',
              'I feel sleepy during the day and struggle to remain alert.',
              'I would like to have more energy during the day.',
              'I am told that I am easily irritated.',
              'I have difficulty in concentrating at work or school.',
              'I worry whether I sleep enough.',
              'Generally, I sleep badly.'
            ],
            options: [
              { value: '1', label: '(1) Not at all' },
              { value: '2', label: '(2) Somewhat' },
              { value: '3', label: '(3) Rather much' },
              { value: '4', label: '(4) Very much' }
            ]
          }
        ]
      }
    ]
  },
  insomnia: {
    title: 'Insomnia PRS Assessment',
    sections: [
      {
        title: 'Section 1 - General Data',
        questions: [
          { id: 'assessment_date', type: 'date', label: '1. Date of assessment *', required: true },
          { id: 'doctor_email', type: 'email', label: '2. Doctor Email *', required: true },
          { id: 'patient_name', type: 'text', label: '3. Patient name and surname *', required: true },
          { id: 'patient_id', type: 'text', label: '4. Patient ID *', required: true },
          { id: 'patient_age', type: 'radio', label: '5. Patient Age *', required: true, options: [
            { value: '>18', label: '> 18' },
            { value: '18-25', label: '18-25' },
            { value: '26-35', label: '26-35' },
            { value: '36-45', label: '36-45' },
            { value: '46-55', label: '46-55' },
            { value: '56-65', label: '56-65' },
            { value: '<65', label: '< 65' }
          ]},
          { id: 'gender', type: 'radio', label: '6. Gender *', required: true, options: [
            { value: 'male', label: 'Male' },
            { value: 'female', label: 'Female' },
            { value: 'non-binary', label: 'Non-Binary' }
          ]},
          { id: 'visit_type', type: 'radio', label: '7. Please Choose one of the following options *', required: true, options: [
            { value: 'first', label: 'First Visit' },
            { value: 'followup1', label: 'Follow-up visit 1' },
            { value: 'followup2', label: 'Follow-up visit 2' },
            { value: 'followup3', label: 'Follow-up visit 3' }
          ]}
        ]
      },
      {
        title: 'Section 2 - EQ-5D-5L Health Questionnaire',
        description: 'Under each heading, please tick the ONE box that best describes your health TODAY.',
        questions: [
          { id: 'fill_eq5d', type: 'radio', label: '8. Do you want to fill in EQ-5D-5L questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'eq5d_mobility', type: 'likert', label: '9. Mobility *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, options: [
            '(1) I have no problems in walking about',
            '(2) I have slight problems in walking about',
            '(3) I have moderate problems in walking about',
            '(4) I have severe problems in walking about',
            '(5) I am unable to walk about'
          ]},
          { id: 'eq5d_self_care', type: 'likert', label: '10. Self Care *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, options: [
            '(1) I have no problems washing or dressing myself',
            '(2) I have slight problems washing or dressing myself',
            '(3) I have moderate problems washing or dressing myself',
            '(4) I have severe problems washing or dressing myself',
            '(5) I am unable to wash or dress myself'
          ]},
          { id: 'eq5d_usual_activities', type: 'likert', label: '11. Usual activities (e.g. work, study, housework, family or leisure activities) *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, options: [
            '(1) I have no problems doing my usual activities',
            '(2) I have slight problems doing my usual activities',
            '(3) I have moderate problems doing my usual activities',
            '(4) I have severe problems doing my usual activities',
            '(5) I am unable to do my usual activities'
          ]},
          { id: 'eq5d_pain', type: 'likert', label: '12. Pain/Discomfort *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, options: [
            '(1) I have no pain or discomfort',
            '(2) I have slight pain or discomfort',
            '(3) I have moderate pain or discomfort',
            '(4) I have severe pain or discomfort',
            '(5) I have extreme pain or discomfort'
          ]},
          { id: 'eq5d_anxiety', type: 'likert', label: '13. Anxiety/Depression *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, options: [
            '(1) I am not anxious or depressed',
            '(2) I am slightly anxious or depressed',
            '(3) I am moderately anxious or depressed',
            '(4) I am severely anxious or depressed',
            '(5) I am extremely anxious or depressed'
          ]},
          { id: 'eq5d_health_today', type: 'slider', label: '14. We would like to know how good or bad your health is TODAY (0=worst health you can imagine, 10=best health you can imagine) *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, min: 0, max: 10 }
        ]
      },
      {
        title: 'Section 3 - COMPASS 31',
        questions: [
          { id: 'fill_compass31', type: 'radio', label: '15. Do you want to fill in COMPASS-31 questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'compass_faint_standing', type: 'radio', label: '16. In the past year, have you ever felt faint, dizzy, "goofy", or had difficulty thinking soon after standing up from a sitting or lying position? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            { value: 'yes', label: '(1) Yes' },
            { value: 'no', label: '(2) No' }
          ]},
          { id: 'compass_faint_frequency', type: 'likert', label: '17. When standing up, how frequently do you get these feelings or symptoms? *', required: true, showIf: { field: 'compass_faint_standing', value: 'yes' }, options: [
            '(1) Rarely',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Almost Always'
          ]},
          { id: 'compass_faint_severity', type: 'likert', label: '18. How would you rate the severity of these feelings or symptoms? *', required: true, showIf: { field: 'compass_faint_standing', value: 'yes' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass_faint_changes', type: 'likert', label: '19. In the past year, have these feelings or symptoms that you have experienced: *', required: true, showIf: { field: 'compass_faint_standing', value: 'yes' }, options: [
            '(1) Gotten much worse',
            '(2) Gotten somewhat worse',
            '(3) Stayed about the same',
            '(4) Gotten somewhat better',
            '(5) Gotten much better Completely gone'
          ]},
          { id: 'compass_skin_color', type: 'radio', label: '20. In the past year, have you ever noticed color changes in your skin, such as red, white, or purple? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            { value: 'yes', label: '(1) Yes' },
            { value: 'no', label: '(2) No' }
          ]},
          { id: 'compass_skin_parts', type: 'checkbox', label: '21. What parts of your body are affected by these color changes? (Check all that apply) *', required: true, showIf: { field: 'compass_skin_color', value: 'yes' }, options: [
            { value: 'hands', label: '(1) Hands' },
            { value: 'feet', label: '(2) Feet' }
          ]},
          { id: 'compass_skin_changes', type: 'likert', label: '22. Are these changes in your skin color: *', required: true, showIf: { field: 'compass_skin_color', value: 'yes' }, options: [
            '(1) Getting much worse',
            '(2) Getting somewhat worse',
            '(3) Staying about the same',
            '(4) Getting somewhat better',
            '(5) Getting much better',
            '(6) Completely gone'
          ]},
          { id: 'compass_sweating', type: 'likert', label: '23. In the past 5 years, what changes, if any, have occurred in your general body sweating? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) I sweat much more than I used to',
            '(2) I sweat somewhat more than I used to',
            '(3) I haven\'t noticed any changes in my sweating',
            '(4) I sweat somewhat less than I used to',
            '(5) I sweat much less than I used to'
          ]},
          { id: 'compass_dry_eyes', type: 'radio', label: '24. Do your eyes feel excessively dry? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            { value: 'yes', label: '(1) Yes' },
            { value: 'no', label: '(2) No' }
          ]},
          { id: 'compass_dry_mouth', type: 'radio', label: '25. Does your mouth feel excessively dry? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            { value: 'yes', label: '(1) Yes' },
            { value: 'no', label: '(2) No' }
          ]},
          { id: 'compass_dry_symptom', type: 'likert', label: '26. For the symptom of dry eyes or dry mouth that you have had for the longest period of time, is this symptom: *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) I have not had any of these symptoms',
            '(2) Getting much worse',
            '(3) Getting somewhat worse',
            '(4) Staying about the same',
            '(5) Getting somewhat better',
            '(6) Getting much better',
            '(7) Completely gone'
          ]},
          { id: 'compass_full_quickly', type: 'likert', label: '27. In the past year, have you noticed any changes in how quickly you get full when eating a meal? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) I get full a lot more quickly now than I used to',
            '(2) I get full more quickly now than I used to',
            '(3) I haven\'t noticed any change',
            '(4) I get full less quickly now than I used to',
            '(5) I get full a lot less quickly now than I used to'
          ]},
          { id: 'compass_bloated', type: 'likert', label: '28. In the past year, have you felt excessively full or persistently full (bloated feeling) after a meal? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Sometimes',
            '(3) A lot of time'
          ]},
          { id: 'compass_vomited', type: 'likert', label: '29. In the past year, have you vomited after a meal? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Sometimes',
            '(3) A lot of times'
          ]},
          { id: 'compass_abdominal_pain', type: 'likert', label: '30. In the past year, have you had a cramping or colicky abdominal pain? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Sometimes',
            '(3) A lot of times'
          ]},
          { id: 'compass_diarrhea', type: 'radio', label: '31. In the past year, have you had any bouts of diarrhea? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            { value: 'yes', label: '(1) Yes' },
            { value: 'no', label: '(2) No' }
          ]},
          { id: 'compass_diarrhea_frequency', type: 'likert', label: '32. How frequently does this occur? *', required: true, showIf: { field: 'compass_diarrhea', value: 'yes' }, options: [
            '(1) Rarely',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass_diarrhea_severity', type: 'likert', label: '33. How severe are these bouts of diarrhea? *', required: true, showIf: { field: 'compass_diarrhea', value: 'yes' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass_diarrhea_getting', type: 'likert', label: '34. Are your bouts of diarrhea getting: *', required: true, showIf: { field: 'compass_diarrhea', value: 'yes' }, options: [
            '(1) Much worse',
            '(2) Somewhat worse',
            '(3) Staying the same',
            '(4) Much better',
            '(5) Completely gone'
          ]},
          { id: 'compass_constipation', type: 'radio', label: '35. In the past year, have you been constipated? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            { value: 'yes', label: '(1) Yes' },
            { value: 'no', label: '(2) No' }
          ]},
          { id: 'compass_constipation_frequency', type: 'likert', label: '36. How frequently are you constipated? *', required: true, showIf: { field: 'compass_constipation', value: 'yes' }, options: [
            '(1) Rarely',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass_constipation_severity', type: 'likert', label: '37. How severe are these episodes of constipation? *', required: true, showIf: { field: 'compass_constipation', value: 'yes' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass_constipation_getting', type: 'likert', label: '38. Is your constipation getting: *', required: true, showIf: { field: 'compass_constipation', value: 'yes' }, options: [
            '(1) Much worse',
            '(2) Somewhat worse',
            '(3) Staying the same',
            '(4) Somewhat better',
            '(5) Much better',
            '(6) Completely gone'
          ]},
          { id: 'compass_bladder_control', type: 'likert', label: '39. In the past year, have you ever lost control of your bladder function? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass_difficulty_passing', type: 'likert', label: '40. In the past year, have you had difficulty passing urine? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass_emptying_bladder', type: 'likert', label: '41. In the past year, have you had trouble completely emptying your bladder? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass_bright_light', type: 'likert', label: '42. In the past year, without sunglasses or tinted glasses, has bright light bothered your eyes? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass_light_severity', type: 'likert', label: '43. How severe is this sensitivity to bright light? *', required: true, showIf: { field: 'compass_bright_light', valueNot: '(1) Never' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass_trouble_focusing', type: 'likert', label: '44. In the past year, have you had trouble focusing your eyes? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass_focusing_severity', type: 'likert', label: '45. How severe is this focusing problem? *', required: true, showIf: { field: 'compass_trouble_focusing', valueNot: '(1) Never' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass_eye_symptom', type: 'likert', label: '46. Is the most troublesome symptom with your eyes (i.e. sensitivity to bright light or trouble focusing) getting: *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) I have not had any of these symptoms',
            '(2) Much worse',
            '(3) Somewhat worse',
            '(4) Staying about the same',
            '(5) Somewhat better',
            '(6) Much better',
            '(7) Completely gone'
          ]}
        ]
      },
      {
        title: 'Section 4 - DASS-21',
        questions: [
          { id: 'fill_dass21', type: 'radio', label: '47. Do you want to fill in DASS-21 questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'dass_wind_down', type: 'likert', label: '48. (S) I found it hard to wind down. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_dry_mouth', type: 'likert', label: '49. (A) I was aware of dryness of my mouth. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_positive_feeling', type: 'likert', label: '50. (D) I couldn\'t seem to experience any positive feeling at all. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_breathing', type: 'likert', label: '51. (A) I experienced breathing difficulty (e.g. excessively rapid breathing, breathlessness in the absence of physical exertion). *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_initiative', type: 'likert', label: '52. (D) I found it difficult to work up the initiative to do things. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_over_react', type: 'likert', label: '53. (S) I tended to over-react to situations. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_trembling', type: 'likert', label: '54. (A) I experienced trembling (e.g. in the hands). *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_nervous_energy', type: 'likert', label: '55. (S) I felt that I was using a lot of nervous energy. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_panic', type: 'likert', label: '56. (A) I was worried about situations in which I might panic and make a fool of myself. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_nothing_forward', type: 'likert', label: '57. (D) I felt that I had nothing to look forward to. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_agitated', type: 'likert', label: '58. (S) I found myself getting agitated. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_relax', type: 'likert', label: '59. (S) I found it difficult to relax. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_down_hearted', type: 'likert', label: '60. (D) I felt down-hearted and blue. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_intolerant', type: 'likert', label: '61. (S) I was intolerant of anything that kept me from getting on with what I was doing. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_close_panic', type: 'likert', label: '62. (A) I felt I was close to panic. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_enthusiastic', type: 'likert', label: '63. (D) I was unable to become enthusiastic about anything. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_not_worth', type: 'likert', label: '64. (D) I felt I wasn\'t worth much as a person. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_touchy', type: 'likert', label: '65. (S) I felt that I was rather touchy. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_heart_action', type: 'likert', label: '66. (A) I was aware of the action of my heart in the absence of physical exertion (e.g. sense of heart rate increase, heart missing a beat). *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_scared', type: 'likert', label: '67. (A) I felt scared without any good reason. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_meaningless', type: 'likert', label: '68. (D) I felt that life was meaningless. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]}
        ]
      },
      {
        title: 'Section 5 - GAD-7',
        questions: [
          { id: 'fill_gad7', type: 'radio', label: '69. Do you want to fill in GAD 7 questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'gad_nervous', type: 'likert', label: '70. Over the last two weeks feeling nervous, anxious, or on edge *', required: true, showIf: { field: 'fill_gad7', value: 'yes' }, options: [
            '(0) Not at all',
            '(1) Several days',
            '(2) More than half of the days',
            '(3) Nearly every day'
          ]},
          { id: 'gad_stop_worrying', type: 'likert', label: '71. Over the last two weeks not being able to stop or control worrying *', required: true, showIf: { field: 'fill_gad7', value: 'yes' }, options: [
            '(0) Not at all',
            '(1) Several days',
            '(2) More than half of the days',
            '(3) Nearly every day'
          ]},
          { id: 'gad_worrying_much', type: 'likert', label: '72. Over the last two weeks worrying too much about different things *', required: true, showIf: { field: 'fill_gad7', value: 'yes' }, options: [
            '(0) Not at all',
            '(1) Several days',
            '(2) More than half of the days',
            '(3) Nearly every day'
          ]},
          { id: 'gad_relaxing', type: 'likert', label: '73. Over the last two weeks trouble relaxing *', required: true, showIf: { field: 'fill_gad7', value: 'yes' }, options: [
            '(0) Not at all',
            '(1) Several days',
            '(2) More than half of the days',
            '(3) Nearly every day'
          ]},
          { id: 'gad_restless', type: 'likert', label: '74. Over the last two weeks being so restless that it is hard to sit still *', required: true, showIf: { field: 'fill_gad7', value: 'yes' }, options: [
            '(0) Not at all',
            '(1) Several days',
            '(2) More than half of the days',
            '(3) Nearly every day'
          ]},
          { id: 'gad_annoyed', type: 'likert', label: '75. Over the last two weeks becoming easily annoyed or irritable *', required: true, showIf: { field: 'fill_gad7', value: 'yes' }, options: [
            '(0) Not at all',
            '(1) Several days',
            '(2) More than half of the days',
            '(3) Nearly every day'
          ]},
          { id: 'gad_afraid', type: 'likert', label: '76. Over the last two weeks feeling afraid, as if something awful might happen *', required: true, showIf: { field: 'fill_gad7', value: 'yes' }, options: [
            '(0) Not at all',
            '(1) Several days',
            '(2) More than half of the days',
            '(3) Nearly every day'
          ]}
        ]
      },
      {
        title: 'Section 6 - PSQI - Pittsburgh Sleep Quality Index',
        questions: [
          { id: 'fill_psqi', type: 'radio', label: '77. Do you want to fill in PSQI - Pittsburgh Sleep Quality Index questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'psqi_bedtime', type: 'radio', label: '78. During the past month, what time have you usually gone to bed at night? (24-Hour Time Format) *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            { value: '21:00', label: '21:00' },
            { value: '22:00', label: '22:00' },
            { value: '23:00', label: '23:00' },
            { value: '24:00', label: '24:00' },
            { value: '1:00', label: '1:00' },
            { value: '2:00', label: '2:00' },
            { value: '3:00', label: '3:00' },
            { value: '4:00', label: '4:00' },
            { value: '5:00', label: '5:00' },
            { value: '6:00', label: '6:00' },
            { value: '7:00', label: '7:00' },
            { value: '8:00', label: '8:00' },
            { value: '9:00', label: '9:00' },
            { value: '10:00', label: '10:00' },
            { value: '11:00', label: '11:00' },
            { value: '12:00', label: '12:00' },
            { value: '13:00', label: '13:00' },
            { value: '14:00', label: '14:00' },
            { value: '15:00', label: '15:00' },
            { value: '16:00', label: '16:00' },
            { value: '17:00', label: '17:00' },
            { value: '18:00', label: '18:00' },
            { value: '19:00', label: '19:00' },
            { value: '20:00', label: '20:00' }
          ]},
          { id: 'psqi_fall_asleep_time', type: 'number', label: '79. During the past month, how long (in minutes) has it usually taken you to fall asleep each night? *', required: true, showIf: { field: 'fill_psqi', value: 'yes' } },
          { id: 'psqi_wakeup_time', type: 'radio', label: '80. During the past month, what time have you usually gotten up in the morning? (24-Hour Time Format) *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            { value: '4:00', label: '4:00' },
            { value: '5:00', label: '5:00' },
            { value: '6:00', label: '6:00' },
            { value: '7:00', label: '7:00' },
            { value: '8:00', label: '8:00' },
            { value: '9:00', label: '9:00' },
            { value: '10:00', label: '10:00' },
            { value: '11:00', label: '11:00' },
            { value: '12:00', label: '12:00' },
            { value: '13:00', label: '13:00' },
            { value: '14:00', label: '14:00' },
            { value: '15:00', label: '15:00' },
            { value: '16:00', label: '16:00' },
            { value: '17:00', label: '17:00' },
            { value: '18:00', label: '18:00' },
            { value: '19:00', label: '19:00' },
            { value: '20:00', label: '20:00' },
            { value: '21:00', label: '21:00' },
            { value: '22:00', label: '22:00' },
            { value: '23:00', label: '23:00' },
            { value: '24:00', label: '24:00' },
            { value: '1:00', label: '1:00' },
            { value: '2:00', label: '2:00' },
            { value: '3:00', label: '3:00' }
          ]},
          { id: 'psqi_sleep_hours', type: 'number', label: '81. During the past month, how many hours of actual sleep did you get at night? (This may be different than the number of hours you spent in bed.) *', required: true, showIf: { field: 'fill_psqi', value: 'yes' } },
          { id: 'psqi_sleep_30min', type: 'likert', label: '82. During the past month, how often have you had trouble sleeping because you...Cannot get to sleep within 30 minutes *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_wake_middle', type: 'likert', label: '83. During the past month, how often have you had trouble sleeping because you...Wake up in the middle of the night or early morning *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_bathroom', type: 'likert', label: '84. During the past month, how often have you had trouble sleeping because you...Have to get up to use the bathroom *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_breathe', type: 'likert', label: '85. During the past month, how often have you had trouble sleeping because you...Cannot breathe comfortably *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_cough_snore', type: 'likert', label: '86. During the past month, how often have you had trouble sleeping because you...Cough or snore loudly *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_too_cold', type: 'likert', label: '87. During the past month, how often have you had trouble sleeping because you...Feel too cold *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_too_hot', type: 'likert', label: '88. During the past month, how often have you had trouble sleeping because you...Feel too hot *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_bad_dreams', type: 'likert', label: '89. During the past month, how often have you had trouble sleeping because you...Have bad dreams *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_pain', type: 'likert', label: '90. During the past month, how often have you had trouble sleeping because you...Have pain *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_other_reason', type: 'likert', label: '91. During the past month, how often have you had trouble sleeping because you...Other reason(s) *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_medicine', type: 'likert', label: '92. During the past month, how often have you taken medicine to help you sleep (prescribed or "over the counter")? *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_staying_awake', type: 'likert', label: '93. During the past month, how often have you had trouble staying awake while driving, eating meals, or engaging in social activity? *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_enthusiasm', type: 'likert', label: '94. During the past month, how much of a problem has it been for you to keep up enough enthusiasm to get things done? *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Not a problem at all',
            '(1) Only very slight problem',
            '(2) Somewhat of a problem',
            '(3) A very big problem'
          ]},
          { id: 'psqi_sleep_quality', type: 'likert', label: '95. During the past month, how would you rate your sleep quality overall? *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            '(0) Very good',
            '(1) Fairly good',
            '(2) Fairly bad',
            '(3) Very bad'
          ]},
          { id: 'psqi_bed_partner', type: 'radio', label: '96. Do you have a bed partner or roommate? *', required: true, showIf: { field: 'fill_psqi', value: 'yes' }, options: [
            { value: 'no_partner', label: 'No bed partner or room mate' },
            { value: 'other_room', label: 'Partner/room mate in other room' },
            { value: 'same_room', label: 'Partner in same room but not same bed' },
            { value: 'same_bed', label: 'Partner in same bed' }
          ]},
          { id: 'psqi_partner_snoring', type: 'likert', label: '97. If you have a room mate or bed partner, ask him/her how often in the past month you have had: Loud snoring *', required: true, showIf: { field: 'psqi_bed_partner', valueNot: 'no_partner' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_partner_pauses', type: 'likert', label: '98. If you have a room mate or bed partner, ask him/her how often in the past month you have had: Long pauses between breaths while asleep *', required: true, showIf: { field: 'psqi_bed_partner', valueNot: 'no_partner' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_partner_twitching', type: 'likert', label: '99. If you have a room mate or bed partner, ask him/her how often in the past month you have had: Legs twitching or jerking while you sleep *', required: true, showIf: { field: 'psqi_bed_partner', valueNot: 'no_partner' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_partner_disorientation', type: 'likert', label: '100. If you have a room mate or bed partner, ask him/her how often in the past month you have had: Episodes of disorientation or confusion during sleep *', required: true, showIf: { field: 'psqi_bed_partner', valueNot: 'no_partner' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_partner_restlessness', type: 'likert', label: '101. If you have a room mate or bed partner, ask him/her how often in the past month you have had: Other restlessness while you sleep, please describe in next question: *', required: true, showIf: { field: 'psqi_bed_partner', valueNot: 'no_partner' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_restlessness_describe', type: 'text', label: '102. Describe other restlessness while you sleep if applicable: *', required: true, showIf: { field: 'psqi_partner_restlessness', valueNot: '(0) Not during the past month' } }
        ]
      },
      {
        title: 'Section 7 - AIS - Athens Insomnia Scale',
        description: 'This scale is intended to record your own assessment of any sleep difficulty you might have experienced. Please, check (by circling the appropriate number) the items below to indicate your estimate of any difficulty, provided that it occurred at least three times per week during the last month.',
        questions: [
          { id: 'fill_ais', type: 'radio', label: '103. Do you want to fill in AIS - Athens Insomnia Scale questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'ais_sleep_induction', type: 'likert', label: '104. SLEEP INDUCTION (time it takes you to fall asleep after turning-off the lights) *', required: true, showIf: { field: 'fill_ais', value: 'yes' }, options: [
            '(0) No problem',
            '(1) Slightly delayed',
            '(2) Markedly delayed',
            '(3) Very delayed or did not sleep at all'
          ]},
          { id: 'ais_awakenings', type: 'likert', label: '105. AWAKENINGS DURING THE NIGHT *', required: true, showIf: { field: 'fill_ais', value: 'yes' }, options: [
            '(0) No Problem',
            '(1) Minor Problem',
            '(2) Considerable Problem',
            '(3) Serious problem or did not sleep at all'
          ]},
          { id: 'ais_final_awakening', type: 'likert', label: '106. FINAL AWAKENING EARLIER THAN DESIRED *', required: true, showIf: { field: 'fill_ais', value: 'yes' }, options: [
            '(0) Not earlier',
            '(1) A little earlier',
            '(2) Markedly earlier',
            '(3) Much earlier or did not sleep at all'
          ]},
          { id: 'ais_sleep_duration', type: 'likert', label: '107. TOTAL SLEEP DURATION *', required: true, showIf: { field: 'fill_ais', value: 'yes' }, options: [
            '(0) Sufficient',
            '(1) Slightly sufficient',
            '(2) Markedly insufficient',
            '(3) Very insufficient or did not sleep at all'
          ]},
          { id: 'ais_sleep_quality', type: 'likert', label: '108. OVERALL QUALITY OF SLEEP (no matter how long you slept) *', required: true, showIf: { field: 'fill_ais', value: 'yes' }, options: [
            '(0) Satisfactory',
            '(1) Slightly unsatisfactory',
            '(2) Markedly unsatisfactory',
            '(3) Very unsatisfactory or did not sleep at all'
          ]},
          { id: 'ais_wellbeing', type: 'likert', label: '109. SENSE OF WELL-BEING DURING THE DAY *', required: true, showIf: { field: 'fill_ais', value: 'yes' }, options: [
            '(0) Normal',
            '(1) Slightly decreased',
            '(2) Markedly decreased',
            '(3) Very decreased'
          ]},
          { id: 'ais_functioning', type: 'likert', label: '110. FUNCTIONING (PHYSICAL AND MENTAL) DURING THE DAY *', required: true, showIf: { field: 'fill_ais', value: 'yes' }, options: [
            '(0) Normal',
            '(1) Slightly decreased',
            '(2) Markedly decreased',
            '(3) Very decreased'
          ]},
          { id: 'ais_sleepiness', type: 'likert', label: '111. SLEEPINESS DURING THE DAY *', required: true, showIf: { field: 'fill_ais', value: 'yes' }, options: [
            '(0) None',
            '(1) Mild',
            '(2) Considerable',
            '(3) Intense'
          ]}
        ]
      },
      {
        title: 'Section 8 - FFS - Flinder\'s Fatigue Scale',
        description: 'We are interested in the extent that you have felt fatigued (tired, weary, exhausted) over the last two weeks. We do not mean feelings of sleepiness (the likelihood of falling asleep). Please click the appropriate response in accordance with your average feelings over this two-week period.',
        questions: [
          { id: 'fill_ffs', type: 'radio', label: '112. Do you want to fill in FFS - Flinder\'s Fatigue Scale questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'ffs_problem', type: 'likert', label: '113. Was fatigue a problem for you? *', required: true, showIf: { field: 'fill_ffs', value: 'yes' }, options: [
            '(0) Not at all',
            '(1)',
            '(2) Moderately',
            '(3)',
            '(4) Extremely'
          ]},
          { id: 'ffs_functioning', type: 'likert', label: '114. Did fatigue cause problems with your everyday functioning (e.g., work, social, family)? *', required: true, showIf: { field: 'fill_ffs', value: 'yes' }, options: [
            '(0) Not at all',
            '(1)',
            '(2) Moderately',
            '(3)',
            '(4) Extremely'
          ]},
          { id: 'ffs_distress', type: 'likert', label: '115. Did fatigue cause you distress? *', required: true, showIf: { field: 'fill_ffs', value: 'yes' }, options: [
            '(0) Not at all',
            '(1)',
            '(2) Moderately',
            '(3)',
            '(4) Extremely'
          ]},
          { id: 'ffs_frequency', type: 'likert', label: '116. How often did you suffer from fatigue? *', required: true, showIf: { field: 'fill_ffs', value: 'yes' }, options: [
            '(0) 0 days/week',
            '(1) 1-2 days/week',
            '(2) 3-4 days/week',
            '(3) 5-6 days/week',
            '(4) 7 day/week'
          ]},
          { id: 'ffs_time_of_day', type: 'checkbox', label: '117. At what time(s) of the day did you typically experience fatigue? (Please tick box(es)) *', required: true, showIf: { field: 'fill_ffs', value: 'yes' }, options: [
            { value: 'early_morning', label: '(0) Early morning' },
            { value: 'mid_morning', label: '(1) Mid morning' },
            { value: 'midday', label: '(2) Midday' },
            { value: 'mid_afternoon', label: '(3) Mid afternoon' },
            { value: 'late_afternoon', label: '(4) Late afternoon' },
            { value: 'early_evening', label: '(5) Early evening' },
            { value: 'late_evening', label: '(6) Late evening' }
          ]},
          { id: 'ffs_severity', type: 'likert', label: '118. How severe was the fatigue you experienced? *', required: true, showIf: { field: 'fill_ffs', value: 'yes' }, options: [
            '(0) Not at all',
            '(1)',
            '(2) Moderately',
            '(3)',
            '(4) Extremely'
          ]},
          { id: 'ffs_poor_sleep', type: 'likert', label: '119. How much was your fatigue caused by poor sleep? *', required: true, showIf: { field: 'fill_ffs', value: 'yes' }, options: [
            '(0) Not at all',
            '(1)',
            '(2) Moderately',
            '(3)',
            '(4) Entirely'
          ]}
        ]
      },
      {
        title: 'Section 9 - ISI - Insomnia Severity Index',
        description: 'For each question, please CIRCLE the number that best describes your answer. Please rate the CURRENT (i.e. LAST 2 WEEKS) SEVERITY of your insomnia problem(s).',
        questions: [
          { id: 'fill_isi', type: 'radio', label: '120. Do you want to fill in ISI questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'isi_falling_asleep', type: 'likert', label: '121. Difficulty falling asleep *', required: true, showIf: { field: 'fill_isi', value: 'yes' }, options: [
            '(0) None',
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe',
            '(4) Very severe'
          ]},
          { id: 'isi_staying_asleep', type: 'likert', label: '122. Difficulty staying asleep *', required: true, showIf: { field: 'fill_isi', value: 'yes' }, options: [
            '(0) None',
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe',
            '(4) Very severe'
          ]},
          { id: 'isi_waking_early', type: 'likert', label: '123. Problems waking up too early *', required: true, showIf: { field: 'fill_isi', value: 'yes' }, options: [
            '(0) None',
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe',
            '(4) Very severe'
          ]},
          { id: 'isi_satisfaction', type: 'likert', label: '124. How SATISFIED/DISSATISFIED are you with your CURRENT sleep pattern? *', required: true, showIf: { field: 'fill_isi', value: 'yes' }, options: [
            '(0) Very satisfied',
            '(1) Satisfied',
            '(2) Moderately satisfied',
            '(3) Dissatisfied',
            '(4) Very dissatisfied'
          ]},
          { id: 'isi_noticeable', type: 'likert', label: '125. How NOTICEABLE to others do you think your sleep problem is in terms of impairing the quality of your life? *', required: true, showIf: { field: 'fill_isi', value: 'yes' }, options: [
            '(0) Not at all noticeable',
            '(1) A little',
            '(2) Somewhat',
            '(3) Much',
            '(4) Very much noticeable'
          ]},
          { id: 'isi_worried', type: 'likert', label: '126. How WORRIED/DISTRESSED are you about your current sleep problem? *', required: true, showIf: { field: 'fill_isi', value: 'yes' }, options: [
            '(0) Not at all worried',
            '(1) A little',
            '(2) Somewhat',
            '(3) Much',
            '(4) Very much worried'
          ]},
          { id: 'isi_interfere', type: 'likert', label: '127. To what extent do you consider your sleep problem to INTERFERE with your daily functioning (e.g. daytime fatigue, mood, ability to function at work/daily chores, concentration, memory, mood, etc.) CURRENTLY? *', required: true, showIf: { field: 'fill_isi', value: 'yes' }, options: [
            '(0) Not at all interfering',
            '(1) A little',
            '(2) Somewhat',
            '(3) Much',
            '(4) Very much interfering'
          ]}
        ]
      },
      {
        title: 'Section 10 - Sleep-50 Questionnaire',
        description: 'Please respond to what extent a statement (item) has been applicable to you during the past 4 weeks. Score each item on a 4-point-scale.',
        questions: [
          { id: 'fill_sleep50', type: 'radio', label: '128. Do you want to fill in Sleep-50 questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { 
            id: 'sleep50_section1', 
            type: 'table', 
            label: '129. Sleep-50 SECTION 1', 
            required: true, 
            showIf: { field: 'fill_sleep50', value: 'yes' },
            tableQuestions: [
              'I am told that I snore.',
              'I sweat during the night.',
              'I am told that I hold my breath when sleeping.',
              'I am told that I wake up gasping for air.',
              'I wake up with a dry mouth.',
              'I wake up during the night while coughing or being short of breath.',
              'I wake up with a sour taste in my mouth.',
              'I wake up with a headache.'
            ],
            options: [
              { value: '1', label: '(1) Not at all' },
              { value: '2', label: '(2) Somewhat' },
              { value: '3', label: '(3) Rather much' },
              { value: '4', label: '(4) Very much' }
            ]
          },
          { 
            id: 'sleep50_section2', 
            type: 'table', 
            label: '130. Sleep-50 SECTION 2', 
            required: true, 
            showIf: { field: 'fill_sleep50', value: 'yes' },
            tableQuestions: [
              'I have difficulty in falling asleep.',
              'Thoughts go through my head and keep me awake.',
              'I worry and find it hard to relax.',
              'I wake up during the night.',
              'After waking up during the night, I fall asleep slowly.',
              'I wake up early and cannot get back to sleep.',
              'I sleep lightly.',
              'I sleep too little.'
            ],
            options: [
              { value: '1', label: '(1) Not at all' },
              { value: '2', label: '(2) Somewhat' },
              { value: '3', label: '(3) Rather much' },
              { value: '4', label: '(4) Very much' }
            ]
          },
          { 
            id: 'sleep50_section3', 
            type: 'table', 
            label: '131. Sleep-50 SECTION 3', 
            required: true, 
            showIf: { field: 'fill_sleep50', value: 'yes' },
            tableQuestions: [
              'I see dreamlike images when falling asleep or waking up.',
              'I sometimes fall asleep on a social occasion.',
              'I have sleep attacks during the day.',
              'With intense emotions, my muscles sometimes collapse during the day.',
              'I sometimes cannot move when falling asleep or waking up.'
            ],
            options: [
              { value: '1', label: '(1) Not at all' },
              { value: '2', label: '(2) Somewhat' },
              { value: '3', label: '(3) Rather much' },
              { value: '4', label: '(4) Very much' }
            ]
          },
          { 
            id: 'sleep50_section4', 
            type: 'table', 
            label: '132. Sleep-50 SECTION 4', 
            required: true, 
            showIf: { field: 'fill_sleep50', value: 'yes' },
            tableQuestions: [
              'I am told that I kick my legs when I sleep.',
              'I have cramps or pain in my legs during the night.',
              'I feel little shocks in my legs during the night.',
              'I cannot keep my legs at rest when falling asleep.'
            ],
            options: [
              { value: '1', label: '(1) Not at all' },
              { value: '2', label: '(2) Somewhat' },
              { value: '3', label: '(3) Rather much' },
              { value: '4', label: '(4) Very much' }
            ]
          },
          { 
            id: 'sleep50_section5', 
            type: 'table', 
            label: '133. Sleep-50 SECTION 5', 
            required: true, 
            showIf: { field: 'fill_sleep50', value: 'yes' },
            tableQuestions: [
              'I would rather go to bed at a different time.',
              'I go to bed at very different times (more than 2 hr difference).',
              'I do shift work.'
            ],
            options: [
              { value: '1', label: '(1) Not at all' },
              { value: '2', label: '(2) Somewhat' },
              { value: '3', label: '(3) Rather much' },
              { value: '4', label: '(4) Very much' }
            ]
          },
          { 
            id: 'sleep50_section6', 
            type: 'table', 
            label: '134. Sleep-50 SECTION 6', 
            required: true, 
            showIf: { field: 'fill_sleep50', value: 'yes' },
            tableQuestions: [
              'I sometimes walk when I am sleeping.',
              'I sometimes wake up in a different place than where I fell asleep.',
              'I sometimes find evidence of having performed an action during the night I do not remember.'
            ],
            options: [
              { value: '1', label: '(1) Not at all' },
              { value: '2', label: '(2) Somewhat' },
              { value: '3', label: '(3) Rather much' },
              { value: '4', label: '(4) Very much' }
            ]
          },
          { 
            id: 'sleep50_section7', 
            type: 'table', 
            label: '135. Sleep-50 SECTION 7', 
            required: true, 
            showIf: { field: 'fill_sleep50', value: 'yes' },
            tableQuestions: [
              'I have frightening dreams (if not go to Q126).',
              'I wake up from these dreams.',
              'I remember the content of these dreams.',
              'I can orientate quickly after these dreams.',
              'I have physical symptoms during or after these dreams (e.g., movements, sweating, heart palpitations, shortness of breath).'
            ],
            options: [
              { value: '1', label: '(1) Not at all' },
              { value: '2', label: '(2) Somewhat' },
              { value: '3', label: '(3) Rather much' },
              { value: '4', label: '(4) Very much' }
            ]
          },
          { 
            id: 'sleep50_section8', 
            type: 'table', 
            label: '136. Sleep-50 SECTION 8', 
            required: true, 
            showIf: { field: 'fill_sleep50', value: 'yes' },
            tableQuestions: [
              'It is too light in my bedroom during the night.',
              'It is too noisy in my bedroom during the night.',
              'I drink alcoholic beverages during the evening.',
              'I smoke during the evening.',
              'I use other substances during the evening (e.g., sleep or other medication).',
              'I feel sad.',
              'I have no pleasure or interest in daily occupations.'
            ],
            options: [
              { value: '1', label: '(1) Not at all' },
              { value: '2', label: '(2) Somewhat' },
              { value: '3', label: '(3) Rather much' },
              { value: '4', label: '(4) Very much' }
            ]
          },
          { 
            id: 'sleep50_section9', 
            type: 'table', 
            label: '137. Sleep-50 SECTION 9', 
            required: true, 
            showIf: { field: 'fill_sleep50', value: 'yes' },
            tableQuestions: [
              'I feel tired at getting up.',
              'I feel sleepy during the day and struggle to remain alert.',
              'I would like to have more energy during the day.',
              'I am told that I am easily irritated.',
              'I have difficulty in concentrating at work or school.',
              'I worry whether I sleep enough.',
              'Generally, I sleep badly.'
            ],
            options: [
              { value: '1', label: '(1) Not at all' },
              { value: '2', label: '(2) Somewhat' },
              { value: '3', label: '(3) Rather much' },
              { value: '4', label: '(4) Very much' }
            ]
          }
        ]
      }
    ]
  },
  fibromyalgia: {
    title: 'Fibromyalgia Assessment',
    sections: [
      {
        title: 'Section 1 - General Data',
        questions: [
          { id: 'assessment_date', type: 'date', label: '1. Date of assessment *', required: true },
          { id: 'doctor_email', type: 'email', label: '2. Doctor Email *', required: true },
          { id: 'patient_name', type: 'text', label: '3. Patient Name and Surname *', required: true },
          { id: 'patient_id', type: 'text', label: '4. Patient ID *', required: true },
          { id: 'patient_age', type: 'radio', label: '5. Patient Age *', required: true, options: [
            { value: '<18', label: '< 18' },
            { value: '18-25', label: '18-25' },
            { value: '26-35', label: '26-35' },
            { value: '36-45', label: '36-45' },
            { value: '46-55', label: '46-55' },
            { value: '56-65', label: '56-65' },
            { value: '>65', label: '> 65' }
          ]},
          { id: 'gender', type: 'radio', label: '6. Gender *', required: true, options: [
            { value: 'male', label: 'Male' },
            { value: 'female', label: 'Female' },
            { value: 'non-binary', label: 'Non-binary' }
          ]},
          { id: 'visit_type', type: 'radio', label: '7. Please choose one of the following options *', required: true, options: [
            { value: 'first', label: 'First visit' },
            { value: 'followup1', label: 'Follow-up visit 1' },
            { value: 'followup2', label: 'Follow-up visit 2' },
            { value: 'followup3', label: 'Follow-up visit 3' }
          ]}
        ]
      },
      {
        title: 'Section 2 - EQ-5D-5L Health Questionnaire',
        description: 'Under each heading, please tick the ONE box that best describes your health TODAY.',
        questions: [
          { id: 'fill_eq5d', type: 'radio', label: '8. Do you want to fill in EQ-5D-5L questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'eq5d_mobility', type: 'likert', label: '9. Mobility *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, options: [
            '(1) I have no problems in walking about',
            '(2) I have slight problems in walking about',
            '(3) I have moderate problems in walking about',
            '(4) I have severe problems in walking about',
            '(5) I am unable to walk about'
          ]},
          { id: 'eq5d_self_care', type: 'likert', label: '10. Self Care *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, options: [
            '(1) I have no problems washing or dressing myself',
            '(2) I have slight problems washing or dressing myself',
            '(3) I have moderate problems washing or dressing myself',
            '(4) I have severe problems washing or dressing myself',
            '(5) I am unable to wash or dress myself'
          ]},
          { id: 'eq5d_usual_activities', type: 'likert', label: '11. Usual activities (e.g. work, study, housework, family or leisure activities) *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, options: [
            '(1) I have no problems doing my usual activities',
            '(2) I have slight problems doing my usual activities',
            '(3) I have moderate problems doing my usual activities',
            '(4) I have severe problems doing my usual activities',
            '(5) I am unable to do my usual activities'
          ]},
          { id: 'eq5d_pain', type: 'likert', label: '12. Pain/Discomfort *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, options: [
            '(1) I have no pain or discomfort',
            '(2) I have slight pain or discomfort',
            '(3) I have moderate pain or discomfort',
            '(4) I have severe pain or discomfort',
            '(5) I have extreme pain or discomfort'
          ]},
          { id: 'eq5d_anxiety', type: 'likert', label: '13. Anxiety/Depression *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, options: [
            '(1) I am not anxious or depressed',
            '(2) I am slightly anxious or depressed',
            '(3) I am moderately anxious or depressed',
            '(4) I am severely anxious or depressed',
            '(5) I am extremely anxious or depressed'
          ]},
          { id: 'eq5d_health_today', type: 'slider', label: '14. We would like to know how good or bad your health is TODAY (0=worst health you can imagine, 10=best health you can imagine) *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, min: 0, max: 10 }
        ]
      },
      {
        title: 'Section 3 - COMPASS 31',
        questions: [
          { id: 'fill_compass31', type: 'radio', label: '15. Do you want to fill in COMPASS-31 questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'compass_faint_standing', type: 'radio', label: '16. In the past year, have you ever felt faint, dizzy, "goofy", or had difficulty thinking soon after standing up from a sitting or lying position? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            { value: 'yes', label: '(1) Yes' },
            { value: 'no', label: '(2) No' }
          ]},
          { id: 'compass_faint_frequency', type: 'likert', label: '17. When standing up, how frequently do you get these feelings or symptoms? *', required: true, showIf: { field: 'compass_faint_standing', value: 'yes' }, options: [
            '(1) Rarely',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Almost Always'
          ]},
          { id: 'compass_faint_severity', type: 'likert', label: '18. How would you rate the severity of these feelings or symptoms? *', required: true, showIf: { field: 'compass_faint_standing', value: 'yes' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass_faint_changes', type: 'likert', label: '19. In the past year, have these feelings or symptoms that you have experienced: *', required: true, showIf: { field: 'compass_faint_standing', value: 'yes' }, options: [
            '(1) Gotten much worse',
            '(2) Gotten somewhat worse',
            '(3) Stayed about the same',
            '(4) Gotten somewhat better',
            '(5) Gotten much better Completely gone'
          ]},
          { id: 'compass_skin_color', type: 'radio', label: '20. In the past year, have you ever noticed color changes in your skin, such as red, white, or purple? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            { value: 'yes', label: '(1) Yes' },
            { value: 'no', label: '(2) No' }
          ]},
          { id: 'compass_skin_parts', type: 'checkbox', label: '21. What parts of your body are affected by these color changes? (Check all that apply) *', required: true, showIf: { field: 'compass_skin_color', value: 'yes' }, options: [
            { value: 'hands', label: '(1) Hands' },
            { value: 'feet', label: '(2) Feet' }
          ]},
          { id: 'compass_skin_changes', type: 'likert', label: '22. Are these changes in your skin color: *', required: true, showIf: { field: 'compass_skin_color', value: 'yes' }, options: [
            '(1) Getting much worse',
            '(2) Getting somewhat worse',
            '(3) Staying about the same',
            '(4) Getting somewhat better',
            '(5) Getting much better',
            '(6) Completely gone'
          ]},
          { id: 'compass_sweating', type: 'likert', label: '23. In the past 5 years, what changes, if any, have occurred in your general body sweating? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) I sweat much more than I used to',
            '(2) I sweat somewhat more than I used to',
            '(3) I haven\'t noticed any changes in my sweating',
            '(4) I sweat somewhat less than I used to',
            '(5) I sweat much less than I used to'
          ]},
          { id: 'compass_dry_eyes', type: 'radio', label: '24. Do your eyes feel excessively dry? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            { value: 'yes', label: '(1) Yes' },
            { value: 'no', label: '(2) No' }
          ]},
          { id: 'compass_dry_mouth', type: 'radio', label: '25. Does your mouth feel excessively dry? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            { value: 'yes', label: '(1) Yes' },
            { value: 'no', label: '(2) No' }
          ]},
          { id: 'compass_dry_symptom', type: 'likert', label: '26. For the symptom of dry eyes or dry mouth that you have had for the longest period of time, is this symptom: *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) I have not had any of these symptoms',
            '(2) Getting much worse',
            '(3) Getting somewhat worse',
            '(4) Staying about the same',
            '(5) Getting somewhat better',
            '(6) Getting much better',
            '(7) Completely gone'
          ]},
          { id: 'compass_full_quickly', type: 'likert', label: '27. In the past year, have you noticed any changes in how quickly you get full when eating a meal? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) I get full a lot more quickly now than I used to',
            '(2) I get full more quickly now than I used to',
            '(3) I haven\'t noticed any change',
            '(4) I get full less quickly now than I used to',
            '(5) I get full a lot less quickly now than I used to'
          ]},
          { id: 'compass_bloated', type: 'likert', label: '28. In the past year, have you felt excessively full or persistently full (bloated feeling) after a meal? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Sometimes',
            '(3) A lot of times'
          ]},
          { id: 'compass_vomited', type: 'likert', label: '29. In the past year, have you vomited after a meal? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Sometimes',
            '(3) A lot of time'
          ]},
          { id: 'compass_abdominal_pain', type: 'likert', label: '30. In the past year, have you had a cramping or colicky abdominal pain? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Sometimes',
            '(3) A lot of times'
          ]},
          { id: 'compass_diarrhea', type: 'radio', label: '31. In the past year, have you had any bouts of diarrhea? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            { value: 'yes', label: '(1) Yes' },
            { value: 'no', label: '(2) No' }
          ]},
          { id: 'compass_diarrhea_frequency', type: 'likert', label: '32. How frequently does this occur? *', required: true, showIf: { field: 'compass_diarrhea', value: 'yes' }, options: [
            '(1) Rarely',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass_diarrhea_severity', type: 'likert', label: '33. How severe are these bouts of diarrhea? *', required: true, showIf: { field: 'compass_diarrhea', value: 'yes' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass_diarrhea_getting', type: 'likert', label: '34. Are your bouts of diarrhea getting: *', required: true, showIf: { field: 'compass_diarrhea', value: 'yes' }, options: [
            '(1) Much worse',
            '(2) Somewhat worse',
            '(3) Staying the same',
            '(4) Much better',
            '(5) Completely gone'
          ]},
          { id: 'compass_constipation', type: 'radio', label: '35. In the past year, have you been constipated? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            { value: 'yes', label: '(1) Yes' },
            { value: 'no', label: '(2) No' }
          ]},
          { id: 'compass_constipation_frequency', type: 'likert', label: '36. How frequently are you constipated? *', required: true, showIf: { field: 'compass_constipation', value: 'yes' }, options: [
            '(1) Rarely',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass_constipation_severity', type: 'likert', label: '37. How severe are these episodes of constipation? *', required: true, showIf: { field: 'compass_constipation', value: 'yes' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass_constipation_getting', type: 'likert', label: '38. Is your constipation getting: *', required: true, showIf: { field: 'compass_constipation', value: 'yes' }, options: [
            '(1) Much worse',
            '(2) Somewhat worse',
            '(3) Staying the same',
            '(4) Somewhat better',
            '(5) Much better',
            '(6) Completely gone'
          ]},
          { id: 'compass_bladder_control', type: 'likert', label: '39. In the past year, have you ever lost control of your bladder function? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass_difficulty_passing', type: 'likert', label: '40. In the past year, have you had difficulty passing urine? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass_emptying_bladder', type: 'likert', label: '41. In the past year, have you had trouble completely emptying your bladder? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass_bright_light', type: 'likert', label: '42. In the past year, without sunglasses or tinted glasses, has bright light bothered your eyes? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass_light_severity', type: 'likert', label: '43. How severe is this sensitivity to bright light? *', required: true, showIf: { field: 'compass_bright_light', valueNot: '(1) Never' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass_trouble_focusing', type: 'likert', label: '44. In the past year, have you had trouble focusing your eyes? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass_focusing_severity', type: 'likert', label: '45. How severe is this focusing problem? *', required: true, showIf: { field: 'compass_trouble_focusing', valueNot: '(1) Never' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass_eye_symptom', type: 'likert', label: '46. Is the most troublesome symptom with your eyes (i.e. sensitivity to bright light or trouble focusing) getting: *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) I have not had any of these symptoms',
            '(2) Much worse',
            '(3) Somewhat worse',
            '(4) Staying about the same',
            '(5) Somewhat better',
            '(6) Much better',
            '(7) Completely gone'
          ]}
        ]
      },
      {
        title: 'Section 4 - Pain Rating Scale',
        questions: [
          { id: 'fill_pain_rating', type: 'radio', label: '47. Do you want to fill in Pain Rating Scale questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'pain_intensity_now', type: 'slider', label: '48. How intense is your pain now? *', required: true, showIf: { field: 'fill_pain_rating', value: 'yes' }, min: 0, max: 10 },
          { id: 'pain_intensity_average', type: 'slider', label: '49. How intense was your pain on average last week? *', required: true, showIf: { field: 'fill_pain_rating', value: 'yes' }, min: 0, max: 10 },
          { id: 'pain_distress_now', type: 'slider', label: '50. How distressing is your pain now? *', required: true, showIf: { field: 'fill_pain_rating', value: 'yes' }, min: 0, max: 10 },
          { id: 'pain_distress_average', type: 'slider', label: '51. How distressing was your pain on average last week? *', required: true, showIf: { field: 'fill_pain_rating', value: 'yes' }, min: 0, max: 10 },
          { id: 'pain_interference', type: 'slider', label: '52. Now please use the same method to describe how much your pain interferes with your normal everyday activities. *', required: true, showIf: { field: 'fill_pain_rating', value: 'yes' }, min: 0, max: 10 }
        ]
      },
      {
        title: 'Section 5 - PainDETECT',
        questions: [
          { id: 'fill_paindetect', type: 'radio', label: '53. Do you want to fill in Pain Detect questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'pd_pain_now', type: 'slider', label: '54. How would you assess your pain now, at this moment? *', required: true, showIf: { field: 'fill_paindetect', value: 'yes' }, min: 0, max: 10 },
          { id: 'pd_strongest_pain', type: 'slider', label: '55. How strong was the strongest pain during the past 4 weeks? *', required: true, showIf: { field: 'fill_paindetect', value: 'yes' }, min: 0, max: 10 },
          { id: 'pd_average_pain', type: 'slider', label: '56. How strong was the pain during the past 4 weeks on average? *', required: true, showIf: { field: 'fill_paindetect', value: 'yes' }, min: 0, max: 10 },
          { id: 'pd_pain_radiate', type: 'radio', label: '57. Does your pain radiate to other regions of your body? *', required: true, showIf: { field: 'fill_paindetect', value: 'yes' }, options: [
            { value: 'yes', label: '(2) Yes' },
            { value: 'no', label: '(0) No' }
          ]},
          { id: 'pd_burning_sensation', type: 'likert', label: '58. Do you suffer from a burning sensation (e.g., stinging nettles) in the marked areas? *', required: true, showIf: { field: 'fill_paindetect', value: 'yes' }, options: [
            '(0) Never',
            '(1) Hardly noticed',
            '(2) Slightly',
            '(3) Moderately',
            '(4) Strongly',
            '(5) Very strongly'
          ]},
          { id: 'pd_tingling', type: 'likert', label: '59. Do you have a tingling or prickling sensation in the area of your pain (like crawling ants or electrical tingling)? *', required: true, showIf: { field: 'fill_paindetect', value: 'yes' }, options: [
            '(0) Never',
            '(1) Hardly noticed',
            '(2) Slightly',
            '(3) Moderately',
            '(4) Strongly',
            '(5) Very strongly'
          ]},
          { id: 'pd_light_touching', type: 'likert', label: '60. Is light touching (clothing, a blanket) in this area painful? *', required: true, showIf: { field: 'fill_paindetect', value: 'yes' }, options: [
            '(0) Never',
            '(1) Hardly noticed',
            '(2) Slightly',
            '(3) Moderately',
            '(4) Strongly',
            '(5) Very strongly'
          ]},
          { id: 'pd_sudden_pain', type: 'likert', label: '61. Do you have sudden pain attacks in the area of your pain, like electric shocks? *', required: true, showIf: { field: 'fill_paindetect', value: 'yes' }, options: [
            '(0) Never',
            '(1) Hardly noticed',
            '(2) Slightly',
            '(3) Moderately',
            '(4) Strongly',
            '(5) Very strongly'
          ]},
          { id: 'pd_cold_heat', type: 'likert', label: '62. Is cold or heat (bath water) in this area occasionally painful? *', required: true, showIf: { field: 'fill_paindetect', value: 'yes' }, options: [
            '(0) Never',
            '(1) Hardly noticed',
            '(2) Slightly',
            '(3) Moderately',
            '(4) Strongly',
            '(5) Very strongly'
          ]},
          { id: 'pd_numbness', type: 'likert', label: '63. Do you suffer from a sensation of numbness in the areas that you marked? *', required: true, showIf: { field: 'fill_paindetect', value: 'yes' }, options: [
            '(0) Never',
            '(1) Hardly noticed',
            '(2) Slightly',
            '(3) Moderately',
            '(4) Strongly',
            '(5) Very strongly'
          ]},
          { id: 'pd_slight_pressure', type: 'likert', label: '64. Does slight pressure in this area, e.g., with a finger, trigger pain? *', required: true, showIf: { field: 'fill_paindetect', value: 'yes' }, options: [
            '(0) Never',
            '(1) Hardly noticed',
            '(2) Slightly',
            '(3) Moderately',
            '(4) Strongly',
            '(5) Very strongly'
          ]}
        ]
      },
      {
        title: 'Section 6 - FSS - Fatigue Severity Scale',
        description: 'Please click the number between 1 and 7 which you feel best fits the following statements. This refers to your usual way of life within the last week. 1 indicates "strongly disagree" and 7 indicates "strongly agree."',
        questions: [
          { id: 'fill_fss', type: 'radio', label: '65. Do you want to fill in FSS questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'fss_motivation', type: 'slider', label: '66. My motivation is lower when I am fatigued. *', required: true, showIf: { field: 'fill_fss', value: 'yes' }, min: 1, max: 7 },
          { id: 'fss_exercise', type: 'slider', label: '67. Exercise brings on my fatigue. *', required: true, showIf: { field: 'fill_fss', value: 'yes' }, min: 1, max: 7 },
          { id: 'fss_easily_fatigued', type: 'slider', label: '68. I am easily fatigued. *', required: true, showIf: { field: 'fill_fss', value: 'yes' }, min: 1, max: 7 },
          { id: 'fss_physical_functioning', type: 'slider', label: '69. Fatigue interferes with my physical functioning. *', required: true, showIf: { field: 'fill_fss', value: 'yes' }, min: 1, max: 7 },
          { id: 'fss_frequent_problems', type: 'slider', label: '70. Fatigue causes frequent problems for me. *', required: true, showIf: { field: 'fill_fss', value: 'yes' }, min: 1, max: 7 },
          { id: 'fss_sustained_functioning', type: 'slider', label: '71. My fatigue prevents sustained physical functioning. *', required: true, showIf: { field: 'fill_fss', value: 'yes' }, min: 1, max: 7 },
          { id: 'fss_duties', type: 'slider', label: '72. Fatigue interferes with carrying out certain duties and responsibilities. *', required: true, showIf: { field: 'fill_fss', value: 'yes' }, min: 1, max: 7 },
          { id: 'fss_disabling', type: 'slider', label: '73. Fatigue is among my most disabling symptoms. *', required: true, showIf: { field: 'fill_fss', value: 'yes' }, min: 1, max: 7 },
          { id: 'fss_work_family', type: 'slider', label: '74. Fatigue interferes with my work, family, or social life. *', required: true, showIf: { field: 'fill_fss', value: 'yes' }, min: 1, max: 7 },
          { id: 'fss_global_fatigue', type: 'slider', label: '75. Please mark the number which describes your global fatigue with 0 being worst and 10 being normal. *', required: true, showIf: { field: 'fill_fss', value: 'yes' }, min: 0, max: 10 }
        ]
      },
      {
        title: 'Section 7 - VAS',
        questions: [
          { id: 'fill_vas', type: 'radio', label: '76. Do you want to fill in VAS questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'vas_pain', type: 'slider', label: '77. Mark your pain on a scale from "0" no pain to "10" severe pain. *', required: true, showIf: { field: 'fill_vas', value: 'yes' }, min: 0, max: 10 }
        ]
      },
      {
        title: 'Section 8 - FIQR - Revised Fibromyalgia Impact Questionnaire',
        questions: [
          { id: 'fill_fiqr', type: 'radio', label: '78. Do you want to fill in FIQR questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'fiqr_brush_hair', type: 'slider', label: '79. Brush or comb your hair *', required: true, showIf: { field: 'fill_fiqr', value: 'yes' }, min: 0, max: 10 },
          { id: 'fiqr_walk', type: 'slider', label: '80. Walk continuously for 20 minutes *', required: true, showIf: { field: 'fill_fiqr', value: 'yes' }, min: 0, max: 10 },
          { id: 'fiqr_prepare_meal', type: 'slider', label: '81. Prepare a homemade meal *', required: true, showIf: { field: 'fill_fiqr', value: 'yes' }, min: 0, max: 10 },
          { id: 'fiqr_vacuum', type: 'slider', label: '82. Vacuum, scrub or sweep floors *', required: true, showIf: { field: 'fill_fiqr', value: 'yes' }, min: 0, max: 10 },
          { id: 'fiqr_carry_groceries', type: 'slider', label: '83. Lift and carry a bag of groceries *', required: true, showIf: { field: 'fill_fiqr', value: 'yes' }, min: 0, max: 10 },
          { id: 'fiqr_climb_stairs', type: 'slider', label: '84. Climb one flight of stairs *', required: true, showIf: { field: 'fill_fiqr', value: 'yes' }, min: 0, max: 10 },
          { id: 'fiqr_change_sheets', type: 'slider', label: '85. Change bedsheets *', required: true, showIf: { field: 'fill_fiqr', value: 'yes' }, min: 0, max: 10 },
          { id: 'fiqr_sit', type: 'slider', label: '86. Sit in a chair for 45 minutes *', required: true, showIf: { field: 'fill_fiqr', value: 'yes' }, min: 0, max: 10 },
          { id: 'fiqr_shop', type: 'slider', label: '87. Shop for groceries *', required: true, showIf: { field: 'fill_fiqr', value: 'yes' }, min: 0, max: 10 },
          { id: 'fiqr_accomplish_goals', type: 'slider', label: '88. Fibromyalgia prevented me from accomplishing goals for the week *', required: true, showIf: { field: 'fill_fiqr', value: 'yes' }, min: 0, max: 10 },
          { id: 'fiqr_overwhelmed', type: 'slider', label: '89. I was completely overwhelmed by my Fibromyalgia symptoms *', required: true, showIf: { field: 'fill_fiqr', value: 'yes' }, min: 0, max: 10 },
          { id: 'fiqr_level_pain', type: 'slider', label: '90. Please rate the level of pain *', required: true, showIf: { field: 'fill_fiqr', value: 'yes' }, min: 0, max: 10 },
          { id: 'fiqr_level_energy', type: 'slider', label: '91. Please rate your level of energy *', required: true, showIf: { field: 'fill_fiqr', value: 'yes' }, min: 0, max: 10 },
          { id: 'fiqr_level_stiffness', type: 'slider', label: '92. Please rate your level of stiffness *', required: true, showIf: { field: 'fill_fiqr', value: 'yes' }, min: 0, max: 10 },
          { id: 'fiqr_sleep_quality', type: 'slider', label: '93. Please rate the quality of your sleep *', required: true, showIf: { field: 'fill_fiqr', value: 'yes' }, min: 0, max: 10 },
          { id: 'fiqr_depression', type: 'slider', label: '94. Please rate your level of depression *', required: true, showIf: { field: 'fill_fiqr', value: 'yes' }, min: 0, max: 10 },
          { id: 'fiqr_memory', type: 'slider', label: '95. Please rate your level of memory problems *', required: true, showIf: { field: 'fill_fiqr', value: 'yes' }, min: 0, max: 10 },
          { id: 'fiqr_anxiety', type: 'slider', label: '96. Please rate your level of anxiety *', required: true, showIf: { field: 'fill_fiqr', value: 'yes' }, min: 0, max: 10 },
          { id: 'fiqr_tenderness', type: 'slider', label: '97. Please rate your level of tenderness to touch *', required: true, showIf: { field: 'fill_fiqr', value: 'yes' }, min: 0, max: 10 },
          { id: 'fiqr_balance', type: 'slider', label: '98. Please rate your level of balance problems *', required: true, showIf: { field: 'fill_fiqr', value: 'yes' }, min: 0, max: 10 },
          { id: 'fiqr_sensitivity', type: 'slider', label: '99. Please rate your level of sensitivity to loud noises, bright lights, odors, and cold *', required: true, showIf: { field: 'fill_fiqr', value: 'yes' }, min: 0, max: 10 }
        ]
      }
    ]
  },
  ataxia: {
    title: 'Ataxia Assessment',
    sections: [
      {
        title: 'Section 1 - General Data',
        questions: [
          { id: 'assessment_date', type: 'date', label: '1. Date of assessment *', required: true },
          { id: 'doctor_email', type: 'email', label: '2. Doctor Email *', required: true },
          { id: 'patient_name', type: 'text', label: '3. Patient Name and Surname *', required: true },
          { id: 'patient_id', type: 'text', label: '4. Patient ID *', required: true },
          { id: 'patient_age', type: 'radio', label: '5. Patient Age *', required: true, options: [
            { value: '<18', label: '< 18' },
            { value: '18-25', label: '18-25' },
            { value: '26-35', label: '26-35' },
            { value: '36-45', label: '36-45' },
            { value: '46-55', label: '46-55' },
            { value: '56-65', label: '56-65' },
            { value: '>65', label: '> 65' }
          ]},
          { id: 'gender', type: 'radio', label: '6. Gender *', required: true, options: [
            { value: 'male', label: 'Male' },
            { value: 'female', label: 'Female' },
            { value: 'non-binary', label: 'Non-binary' }
          ]},
          { id: 'visit_type', type: 'radio', label: '7. Please choose one of the following options *', required: true, options: [
            { value: 'first', label: 'First visit' },
            { value: 'followup1', label: 'Follow-up visit 1' },
            { value: 'followup2', label: 'Follow-up visit 2' },
            { value: 'followup3', label: 'Follow-up visit 3' }
          ]}
        ]
      },
      {
        title: 'Section 2 - EQ-5D-5L Health Questionnaire',
        description: 'Under each heading, please tick the ONE box that best describes your health TODAY.',
        questions: [
          { id: 'fill_eq5d', type: 'radio', label: '8. Do you want to fill in EQ-5D-5L questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'eq5d_mobility', type: 'likert', label: '9. Mobility *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, options: [
            '(1) I have no problems in walking about',
            '(2) I have slight problems in walking about',
            '(3) I have moderate problems in walking about',
            '(4) I have severe problems in walking about',
            '(5) I am unable to walk about'
          ]},
          { id: 'eq5d_self_care', type: 'likert', label: '10. Self Care *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, options: [
            '(1) I have no problems washing or dressing myself',
            '(2) I have slight problems washing or dressing myself',
            '(3) I have moderate problems washing or dressing myself',
            '(4) I have severe problems washing or dressing myself',
            '(5) I am unable to wash or dress myself'
          ]},
          { id: 'eq5d_usual_activities', type: 'likert', label: '11. Usual activities (e.g. work, study, housework, family or leisure activities) *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, options: [
            '(1) I have no problems doing my usual activities',
            '(2) I have slight problems doing my usual activities',
            '(3) I have moderate problems doing my usual activities',
            '(4) I have severe problems doing my usual activities',
            '(5) I am unable to do my usual activities'
          ]},
          { id: 'eq5d_pain', type: 'likert', label: '12. Pain/Discomfort *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, options: [
            '(1) I have no pain or discomfort',
            '(2) I have slight pain or discomfort',
            '(3) I have moderate pain or discomfort',
            '(4) I have severe pain or discomfort',
            '(5) I have extreme pain or discomfort'
          ]},
          { id: 'eq5d_anxiety', type: 'likert', label: '13. Anxiety/Depression *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, options: [
            '(1) I am not anxious or depressed',
            '(2) I am slightly anxious or depressed',
            '(3) I am moderately anxious or depressed',
            '(4) I am severely anxious or depressed',
            '(5) I am extremely anxious or depressed'
          ]},
          { id: 'eq5d_health_today', type: 'slider', label: '14. We would like to know how good or bad your health is TODAY (0=worst health you can imagine, 10=best health you can imagine) *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, min: 0, max: 10 }
        ]
      },
      {
        title: 'Section 3 - COMPASS 31',
        questions: [
          { id: 'fill_compass31', type: 'radio', label: '15. Do you want to fill in COMPASS-31 questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'compass_faint_standing', type: 'radio', label: '16. In the past year, have you ever felt faint, dizzy, "goofy", or had difficulty thinking soon after standing up from a sitting or lying position? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            { value: 'yes', label: '(1) Yes' },
            { value: 'no', label: '(2) No' }
          ]},
          { id: 'compass_faint_frequency', type: 'likert', label: '17. When standing up, how frequently do you get these feelings or symptoms? *', required: true, showIf: { field: 'compass_faint_standing', value: 'yes' }, options: [
            '(1) Rarely',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Almost Always'
          ]},
          { id: 'compass_faint_severity', type: 'likert', label: '18. How would you rate the severity of these feelings or symptoms? *', required: true, showIf: { field: 'compass_faint_standing', value: 'yes' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass_faint_changes', type: 'likert', label: '19. In the past year, have these feelings or symptoms that you have experienced: *', required: true, showIf: { field: 'compass_faint_standing', value: 'yes' }, options: [
            '(1) Gotten much worse',
            '(2) Gotten somewhat worse',
            '(3) Stayed about the same',
            '(4) Gotten somewhat better',
            '(5) Gotten much better Completely gone'
          ]},
          { id: 'compass_skin_color', type: 'radio', label: '20. In the past year, have you ever noticed color changes in your skin, such as red, white, or purple? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            { value: 'yes', label: '(1) Yes' },
            { value: 'no', label: '(2) No' }
          ]},
          { id: 'compass_skin_parts', type: 'checkbox', label: '21. What parts of your body are affected by these color changes? (Check all that apply) *', required: true, showIf: { field: 'compass_skin_color', value: 'yes' }, options: [
            { value: 'hands', label: '(1) Hands' },
            { value: 'feet', label: '(2) Feet' }
          ]},
          { id: 'compass_skin_changes', type: 'likert', label: '22. Are these changes in your skin color: *', required: true, showIf: { field: 'compass_skin_color', value: 'yes' }, options: [
            '(1) Getting much worse',
            '(2) Getting somewhat worse',
            '(3) Staying about the same',
            '(4) Getting somewhat better',
            '(5) Getting much better',
            '(6) Completely gone'
          ]},
          { id: 'compass_sweating', type: 'likert', label: '23. In the past 5 years, what changes, if any, have occurred in your general body sweating? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) I sweat much more than I used to',
            '(2) I sweat somewhat more than I used to',
            '(3) I haven\'t noticed any changes in my sweating',
            '(4) I sweat somewhat less than I used to',
            '(5) I sweat much less than I used to'
          ]},
          { id: 'compass_dry_eyes', type: 'radio', label: '24. Do your eyes feel excessively dry? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            { value: 'yes', label: '(1) Yes' },
            { value: 'no', label: '(2) No' }
          ]},
          { id: 'compass_dry_mouth', type: 'radio', label: '25. Does your mouth feel excessively dry? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            { value: 'yes', label: '(1) Yes' },
            { value: 'no', label: '(2) No' }
          ]},
          { id: 'compass_dry_symptom', type: 'likert', label: '26. For the symptom of dry eyes or dry mouth that you have had for the longest period of time, is this symptom: *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) I have not had any of these symptoms',
            '(2) Getting much worse',
            '(3) Getting somewhat worse',
            '(4) Staying about the same',
            '(5) Getting somewhat better',
            '(6) Getting much better',
            '(7) Completely gone'
          ]},
          { id: 'compass_full_quickly', type: 'likert', label: '27. In the past year, have you noticed any changes in how quickly you get full when eating a meal? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) I get full a lot more quickly now than I used to',
            '(2) I get full more quickly now than I used to',
            '(3) I haven\'t noticed any change',
            '(4) I get full less quickly now than I used to',
            '(5) I get full a lot less quickly now than I used to'
          ]},
          { id: 'compass_bloated', type: 'likert', label: '28. In the past year, have you felt excessively full or persistently full (bloated feeling) after a meal? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Sometimes',
            '(3) A lot of times'
          ]},
          { id: 'compass_vomited', type: 'likert', label: '29. In the past year, have you vomited after a meal? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Sometimes',
            '(3) A lot of time'
          ]},
          { id: 'compass_abdominal_pain', type: 'likert', label: '30. In the past year, have you had a cramping or colicky abdominal pain? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Sometimes',
            '(3) A lot of times'
          ]},
          { id: 'compass_diarrhea', type: 'radio', label: '31. In the past year, have you had any bouts of diarrhea? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            { value: 'yes', label: '(1) Yes' },
            { value: 'no', label: '(2) No' }
          ]},
          { id: 'compass_diarrhea_frequency', type: 'likert', label: '32. How frequently does this occur? *', required: true, showIf: { field: 'compass_diarrhea', value: 'yes' }, options: [
            '(1) Rarely',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass_diarrhea_severity', type: 'likert', label: '33. How severe are these bouts of diarrhea? *', required: true, showIf: { field: 'compass_diarrhea', value: 'yes' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass_diarrhea_getting', type: 'likert', label: '34. Are your bouts of diarrhea getting: *', required: true, showIf: { field: 'compass_diarrhea', value: 'yes' }, options: [
            '(1) Much worse',
            '(2) Somewhat worse',
            '(3) Staying the same',
            '(4) Much better',
            '(5) Completely gone'
          ]},
          { id: 'compass_constipation', type: 'radio', label: '35. In the past year, have you been constipated? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            { value: 'yes', label: '(1) Yes' },
            { value: 'no', label: '(2) No' }
          ]},
          { id: 'compass_constipation_frequency', type: 'likert', label: '36. How frequently are you constipated? *', required: true, showIf: { field: 'compass_constipation', value: 'yes' }, options: [
            '(1) Rarely',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass_constipation_severity', type: 'likert', label: '37. How severe are these episodes of constipation? *', required: true, showIf: { field: 'compass_constipation', value: 'yes' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass_constipation_getting', type: 'likert', label: '38. Is your constipation getting: *', required: true, showIf: { field: 'compass_constipation', value: 'yes' }, options: [
            '(1) Much worse',
            '(2) Somewhat worse',
            '(3) Staying the same',
            '(4) Somewhat better',
            '(5) Much better',
            '(6) Completely gone'
          ]},
          { id: 'compass_bladder_control', type: 'likert', label: '39. In the past year, have you ever lost control of your bladder function? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass_difficulty_passing', type: 'likert', label: '40. In the past year, have you had difficulty passing urine? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass_emptying_bladder', type: 'likert', label: '41. In the past year, have you had trouble completely emptying your bladder? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass_bright_light', type: 'likert', label: '42. In the past year, without sunglasses or tinted glasses, has bright light bothered your eyes? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass_light_severity', type: 'likert', label: '43. How severe is this sensitivity to bright light? *', required: true, showIf: { field: 'compass_bright_light', valueNot: '(1) Never' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass_trouble_focusing', type: 'likert', label: '44. In the past year, have you had trouble focusing your eyes? *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass_focusing_severity', type: 'likert', label: '45. How severe is this focusing problem? *', required: true, showIf: { field: 'compass_trouble_focusing', valueNot: '(1) Never' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass_eye_symptom', type: 'likert', label: '46. Is the most troublesome symptom with your eyes (i.e. sensitivity to bright light or trouble focusing) getting: *', required: true, showIf: { field: 'fill_compass31', value: 'yes' }, options: [
            '(1) I have not had any of these symptoms',
            '(2) Much worse',
            '(3) Somewhat worse',
            '(4) Staying about the same',
            '(5) Somewhat better',
            '(6) Much better',
            '(7) Completely gone'
          ]}
        ]
      },
      {
        title: 'Section 4 - DHI - Dizziness Handicap Inventory',
        questions: [
          { id: 'fill_dhi', type: 'radio', label: '47. Do you want to fill in DHI questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'dhi_looking_up', type: 'radio', label: '48. Does looking up increase your problem? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            { value: '4', label: '(4) Yes' },
            { value: '2', label: '(2) Sometimes' },
            { value: '0', label: '(0) No' }
          ]},
          { id: 'dhi_frustrated', type: 'radio', label: '49. Because of your problem, do you feel frustrated? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            { value: '4', label: '(4) Yes' },
            { value: '2', label: '(2) Sometimes' },
            { value: '0', label: '(0) No' }
          ]},
          { id: 'dhi_restrict_travel', type: 'radio', label: '50. Because of your problem, do you restrict your travel for business or recreation? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            { value: '4', label: '(4) Yes' },
            { value: '2', label: '(2) Sometimes' },
            { value: '0', label: '(0) No' }
          ]},
          { id: 'dhi_supermarket', type: 'radio', label: '51. Does walking down the aisle of a supermarket increase your problems? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            { value: '4', label: '(4) Yes' },
            { value: '2', label: '(2) Sometimes' },
            { value: '0', label: '(0) No' }
          ]},
          { id: 'dhi_bed', type: 'radio', label: '52. Because of your problem, do you have difficulty getting into or out of bed? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            { value: '4', label: '(4) Yes' },
            { value: '2', label: '(2) Sometimes' },
            { value: '0', label: '(0) No' }
          ]},
          { id: 'dhi_social_activities', type: 'radio', label: '53. Does your problem significantly restrict your participation in social activities, such as going out to dinner, going to the movies, dancing, or going to parties? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            { value: '4', label: '(4) Yes' },
            { value: '2', label: '(2) Sometimes' },
            { value: '0', label: '(0) No' }
          ]},
          { id: 'dhi_reading', type: 'radio', label: '54. Because of your problem, do you have difficulty reading? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            { value: '4', label: '(4) Yes' },
            { value: '2', label: '(2) Sometimes' },
            { value: '0', label: '(0) No' }
          ]},
          { id: 'dhi_ambitious_activities', type: 'radio', label: '55. Does performing more ambitious activities such as sports, dancing, household chores (sweeping or putting dishes away) increase your problems? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            { value: '4', label: '(4) Yes' },
            { value: '2', label: '(2) Sometimes' },
            { value: '0', label: '(0) No' }
          ]},
          { id: 'dhi_afraid_home', type: 'radio', label: '56. Because of your problem, are you afraid to leave your home without having someone accompany you? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            { value: '4', label: '(4) Yes' },
            { value: '2', label: '(2) Sometimes' },
            { value: '0', label: '(0) No' }
          ]},
          { id: 'dhi_embarrassed', type: 'radio', label: '57. Because of your problem have you been embarrassed in front of others? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            { value: '4', label: '(4) Yes' },
            { value: '2', label: '(2) Sometimes' },
            { value: '0', label: '(0) No' }
          ]},
          { id: 'dhi_quick_movements', type: 'radio', label: '58. Do quick movements of your head increase your problem? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            { value: '4', label: '(4) Yes' },
            { value: '2', label: '(2) Sometimes' },
            { value: '0', label: '(0) No' }
          ]},
          { id: 'dhi_heights', type: 'radio', label: '59. Because of your problem, do you avoid heights? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            { value: '4', label: '(4) Yes' },
            { value: '2', label: '(2) Sometimes' },
            { value: '0', label: '(0) No' }
          ]},
          { id: 'dhi_turning_bed', type: 'radio', label: '60. Does turning over in bed increase your problem? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            { value: '4', label: '(4) Yes' },
            { value: '2', label: '(2) Sometimes' },
            { value: '0', label: '(0) No' }
          ]},
          { id: 'dhi_strenuous_work', type: 'radio', label: '61. Because of your problem, is it difficult for you to do strenuous homework or yard work? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            { value: '4', label: '(4) Yes' },
            { value: '2', label: '(2) Sometimes' },
            { value: '0', label: '(0) No' }
          ]},
          { id: 'dhi_intoxicated', type: 'radio', label: '62. Because of your problem, are you afraid people may think you are intoxicated? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            { value: '4', label: '(4) Yes' },
            { value: '2', label: '(2) Sometimes' },
            { value: '0', label: '(0) No' }
          ]},
          { id: 'dhi_walk_alone', type: 'radio', label: '63. Because of your problem, is it difficult for you to go for a walk by yourself? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            { value: '4', label: '(4) Yes' },
            { value: '2', label: '(2) Sometimes' },
            { value: '0', label: '(0) No' }
          ]},
          { id: 'dhi_sidewalk', type: 'radio', label: '64. Does walking down a sidewalk increase your problem? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            { value: '4', label: '(4) Yes' },
            { value: '2', label: '(2) Sometimes' },
            { value: '0', label: '(0) No' }
          ]},
          { id: 'dhi_concentrate', type: 'radio', label: '65. Because of your problem, is it difficult for you to concentrate? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            { value: '4', label: '(4) Yes' },
            { value: '2', label: '(2) Sometimes' },
            { value: '0', label: '(0) No' }
          ]},
          { id: 'dhi_dark', type: 'radio', label: '66. Because of your problem, is it difficult for you to walk around your house in the dark? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            { value: '4', label: '(4) Yes' },
            { value: '2', label: '(2) Sometimes' },
            { value: '0', label: '(0) No' }
          ]},
          { id: 'dhi_stay_alone', type: 'radio', label: '67. Because of your problem, are you afraid to stay home alone? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            { value: '4', label: '(4) Yes' },
            { value: '2', label: '(2) Sometimes' },
            { value: '0', label: '(0) No' }
          ]},
          { id: 'dhi_handicapped', type: 'radio', label: '68. Because of your problem, do you feel handicapped? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            { value: '4', label: '(4) Yes' },
            { value: '2', label: '(2) Sometimes' },
            { value: '0', label: '(0) No' }
          ]},
          { id: 'dhi_relationships', type: 'radio', label: '69. Has the problem placed stress on your relationships with members of your family or friends? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            { value: '4', label: '(4) Yes' },
            { value: '2', label: '(2) Sometimes' },
            { value: '0', label: '(0) No' }
          ]},
          { id: 'dhi_depressed', type: 'radio', label: '70. Because of your problem, are you depressed? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            { value: '4', label: '(4) Yes' },
            { value: '2', label: '(2) Sometimes' },
            { value: '0', label: '(0) No' }
          ]},
          { id: 'dhi_job_household', type: 'radio', label: '71. Does your problem interfere with your job or household responsibilities? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            { value: '4', label: '(4) Yes' },
            { value: '2', label: '(2) Sometimes' },
            { value: '0', label: '(0) No' }
          ]},
          { id: 'dhi_bending', type: 'radio', label: '72. Does bending over increase your problem? *', required: true, showIf: { field: 'fill_dhi', value: 'yes' }, options: [
            { value: '4', label: '(4) Yes' },
            { value: '2', label: '(2) Sometimes' },
            { value: '0', label: '(0) No' }
          ]}
        ]
      },
      {
        title: 'Section 5 - SARA - Scale for the Assessment and Rating of Ataxia',
        questions: [
          { id: 'fill_sara', type: 'radio', label: '73. Do you want to fill in SARA questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'sara_gait', type: 'likert', label: '74. GAIT: Proband is asked (1) to walk at a safe distance parallel to a wall including a half-turn (turn around to face the opposite direction of gait) and (2) to walk in tandem (heels to toes) without support. *', required: true, showIf: { field: 'fill_sara', value: 'yes' }, options: [
            '(0) Normal, no difficulties in walking, turning and walking tandem (up to one misstep allowed)',
            '(1) Slight difficulties, only visible when walking 10 consecutive steps in tandem',
            '(2) Clearly abnormal, tandem walking >10 steps not possible',
            '(3) Considerable staggering, difficulties in half-turn, but without support',
            '(4) Marked staggering, intermittent support of the wall required',
            '(5) Severe staggering, permanent support of one stick or light support by one arm required',
            '(6) Walking > 10 m only with strong support (two special sticks or stroller or accompanying person)',
            '(7) Walking < 10 m only with strong support (two special sticks or stroller or accompanying person)',
            '(8) Unable to walk, even supported'
          ]},
          { id: 'sara_stance', type: 'likert', label: '75. STANCE: Proband is asked to stand (1) in natural position, (2) with feet together in parallel (big toes touching each other) and (3) in tandem (both feet on one line, no space between heel and toe). Proband does not wear shoes, eyes are open. For each condition, three trials are allowed. Best trial is rated. *', required: true, showIf: { field: 'fill_sara', value: 'yes' }, options: [
            '(0) Normal, able to stand in tandem for > 10 s',
            '(1) Able to stand with feet together without sway, but not in tandem for > 10s',
            '(2) Able to stand with feet together for > 10 s, but only with sway',
            '(3) Able to stand for > 10 s without support in natural position, but not with feet together',
            '(4) Able to stand for >10 s in natural position only with intermittent support',
            '(5) Able to stand >10 s in natural position only with constant support of one arm',
            '(6) Unable to stand for >10 s even with constant support of one arm'
          ]},
          { id: 'sara_sitting', type: 'likert', label: '76. SITTING: Proband is asked to sit on an examination bed without support of feet, eyes open and arms outstretched to the front. *', required: true, showIf: { field: 'fill_sara', value: 'yes' }, options: [
            '(0) Normal, no difficulties sitting >10 sec',
            '(1) Slight difficulties, intermittent sway',
            '(2) Constant sway, but able to sit > 10 s without support',
            '(3) Able to sit for > 10 s only with intermittent support',
            '(4) Unable to sit for >10 s without continuous support'
          ]},
          { id: 'sara_speech', type: 'likert', label: '77. SPEECH DISTURBANCE: Speech is assessed during normal conversation. *', required: true, showIf: { field: 'fill_sara', value: 'yes' }, options: [
            '(0) Normal',
            '(1) Suggestion of speech disturbance',
            '(2) Impaired speech, but easy to understand',
            '(3) Occasional words difficult to understand',
            '(4) Many words difficult to understand',
            '(5) Only single words understandable',
            '(6) Speech unintelligible / anarthria'
          ]},
          { id: 'sara_finger_chase_right', type: 'likert', label: '78. FINGER CHASE RIGHT: Rated separately for each side. Proband sits comfortably. If necessary, support of feet and trunk is allowed. Examiner sits in front of proband and performs 5 consecutive sudden and fast pointing movements in unpredictable directions in a frontal plane, at about 50 % of proband´s reach. Movements have an amplitude of 30 cm and a frequency of 1 movement every 2 s. Proband is asked to follow the movements with his index finger, as fast and precisely as possible. Average performance of last 3 movements is rated. *', required: true, showIf: { field: 'fill_sara', value: 'yes' }, options: [
            '(0) No dysmetria',
            '(1) Dysmetria, under/ overshooting target <5 cm',
            '(2) Dysmetria, under/ overshooting target < 15 cm',
            '(3) Dysmetria, under/ overshooting target > 15 cm',
            '(4) Unable to perform 5 pointing movements'
          ]},
          { id: 'sara_finger_chase_left', type: 'likert', label: '79. FINGER CHASE LEFT: Rated separately for each side. Proband sits comfortably. If necessary, support of feet and trunk is allowed. Examiner sits in front of proband and performs 5 consecutive sudden and fast pointing movements in unpredictable directions in a frontal plane, at about 50 % of proband´s reach. Movements have an amplitude of 30 cm and a frequency of 1 movement every 2 s. Proband is asked to follow the movements with his index finger, as fast and precisely as possible. Average performance of last 3 movements is rated. *', required: true, showIf: { field: 'fill_sara', value: 'yes' }, options: [
            '(0) No dysmetria',
            '(1) Dysmetria, under/ overshooting target <5 cm',
            '(2) Dysmetria, under/ overshooting target < 15 cm',
            '(3) Dysmetria, under/ overshooting target > 15 cm',
            '(4) Unable to perform 5 pointing movements'
          ]},
          { id: 'sara_nose_finger_right', type: 'likert', label: '80. NOSE-FINGER TEST RIGHT: Rated separately for each side. Proband sits comfortably. If necessary, support of feet and trunk is allowed. Proband is asked to point repeatedly with his index finger from his nose to examiner\'s finger which is in front of the proband at about 90 % of proband\'s reach. Movements are performed at moderate speed. Average performance of movements is rated according to the amplitude of the kinetic tremor. *', required: true, showIf: { field: 'fill_sara', value: 'yes' }, options: [
            '(0) No tremor',
            '(1) Tremor with an amplitude < 2 cm',
            '(2) Tremor with an amplitude < 5 cm',
            '(3) Tremor with an amplitude > 5 cm',
            '(4) Unable to perform 5 pointing movements'
          ]},
          { id: 'sara_nose_finger_left', type: 'likert', label: '81. NOSE-FINGER TEST LEFT: Rated separately for each side. Proband sits comfortably. If necessary, support of feet and trunk is allowed. Proband is asked to point repeatedly with his index finger from his nose to examiner\'s finger which is in front of the proband at about 90 % of proband\'s reach. Movements are performed at moderate speed. Average performance of movements is rated according to the amplitude of the kinetic tremor. *', required: true, showIf: { field: 'fill_sara', value: 'yes' }, options: [
            '(0) No tremor',
            '(1) Tremor with an amplitude < 2 cm',
            '(2) Tremor with an amplitude < 5 cm',
            '(3) Tremor with an amplitude > 5 cm',
            '(4) Unable to perform 5 pointing movements'
          ]},
          { id: 'sara_fast_hand_right', type: 'likert', label: '82. FAST ALTERNATING HAND MOVEMENTS RIGHT: Rated separately for each side. Proband sits comfortably. If necessary, support of feet and trunk is allowed. Proband is asked to perform 10 cycles of repetitive alternation of pro- and supinations of the hand on his/her thigh as fast and as precise as possible. Movement is demonstrated by examiner at a speed of approx. 10 cycles within 7 s. Exact times for movement execution have to be taken. *', required: true, showIf: { field: 'fill_sara', value: 'yes' }, options: [
            '(0) Normal, no irregularities (performs <10s)',
            '(1) Slightly irregular (performs <10s)',
            '(2) Clearly irregular, single movements difficult to distinguish or relevant interruptions, but performs <10s',
            '(3) Very irregular, single movements difficult to distinguish or relevant interruptions, performs >10s',
            '(4) Unable to complete 10 cycles'
          ]},
          { id: 'sara_fast_hand_left', type: 'likert', label: '83. FAST ALTERNATING HAND MOVEMENTS LEFT: Rated separately for each side. Proband sits comfortably. If necessary, support of feet and trunk is allowed. Proband is asked to perform 10 cycles of repetitive alternation of pro- and supinations of the hand on his/her thigh as fast and as precise as possible. Movement is demonstrated by examiner at a speed of approx. 10 cycles within 7 s. Exact times for movement execution have to be taken. *', required: true, showIf: { field: 'fill_sara', value: 'yes' }, options: [
            '(0) Normal, no irregularities (performs <10s)',
            '(1) Slightly irregular (performs <10s)',
            '(2) Clearly irregular, single movements difficult to distinguish or relevant interruptions, but performs <10s',
            '(3) Very irregular, single movements difficult to distinguish or relevant interruptions, performs >10s',
            '(4) Unable to complete 10 cycles'
          ]},
          { id: 'sara_heel_shin_right', type: 'likert', label: '84. HEEL-SHIN SLIDE RIGHT: Rated separately for each side. Proband lies on examination bed, without sight of his legs. Proband is asked to lift one leg, point with the heel to the opposite knee, slide down along the shin to the ankle, and lay the leg back on the examination bed. The task is performed 3 times. Slide-down movements should be performed within 1 s. If proband slides down without contact to shin in all three trials, rate 4. *', required: true, showIf: { field: 'fill_sara', value: 'yes' }, options: [
            '(0) Normal',
            '(1) Slightly abnormal, contact to shin maintained',
            '(2) Clearly abnormal, goes off shin up to 3 times during 3 cycles',
            '(3) Severely abnormal, goes off shin 4 or more times during 3 cycles',
            '(4) Unable to perform the task'
          ]},
          { id: 'sara_heel_shin_left', type: 'likert', label: '85. HEEL-SHIN SLIDE LEFT: Rated separately for each side. Proband lies on examination bed, without sight of his legs. Proband is asked to lift one leg, point with the heel to the opposite knee, slide down along the shin to the ankle, and lay the leg back on the examination bed. The task is performed 3 times. Slide-down movements should be performed within 1 s. If proband slides down without contact to shin in all three trials, rate 4. *', required: true, showIf: { field: 'fill_sara', value: 'yes' }, options: [
            '(0) Normal',
            '(1) Slightly abnormal, contact to shin maintained',
            '(2) Clearly abnormal, goes off shin up to 3 times during 3 cycles',
            '(3) Severely abnormal, goes off shin 4 or more times during 3 cycles',
            '(4) Unable to perform the task'
          ]}
        ]
      },
      {
        title: 'Section 6 - DASS-21',
        questions: [
          { id: 'fill_dass21', type: 'radio', label: '86. Do you want to fill in DASS-21 questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'dass_wind_down', type: 'likert', label: '87. (S) I found it hard to wind down. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_dry_mouth', type: 'likert', label: '88. (A) I was aware of dryness of my mouth. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_positive_feeling', type: 'likert', label: '89. (D) I couldn\'t seem to experience any positive feeling at all. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_breathing', type: 'likert', label: '90. (A) I experienced breathing difficulty (e.g. excessively rapid breathing, breathlessness in the absence of physical exertion). *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_initiative', type: 'likert', label: '91. (D) I found it difficult to work up the initiative to do things. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_over_react', type: 'likert', label: '92. (S) I tended to over-react to situations. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_trembling', type: 'likert', label: '93. (A) I experienced trembling (e.g. in the hands). *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_nervous_energy', type: 'likert', label: '94. (S) I felt that I was using a lot of nervous energy. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_panic', type: 'likert', label: '95. (A) I was worried about situations in which I might panic and make a fool of myself. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_nothing_forward', type: 'likert', label: '96. (D) I felt that I had nothing to look forward to. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_agitated', type: 'likert', label: '97. (S) I found myself getting agitated. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_relax', type: 'likert', label: '98. (S) I found it difficult to relax. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_down_hearted', type: 'likert', label: '99. (D) I felt down-hearted and blue. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_intolerant', type: 'likert', label: '100. (S) I was intolerant of anything that kept me from getting on with what I was doing. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_close_panic', type: 'likert', label: '101. (A) I felt I was close to panic. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_enthusiastic', type: 'likert', label: '102. (D) I was unable to become enthusiastic about anything. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_not_worth', type: 'likert', label: '103. (D) I felt I wasn\'t worth much as a person. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_touchy', type: 'likert', label: '104. (S) I felt that I was rather touchy. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_heart_action', type: 'likert', label: '105. (A) I was aware of the action of my heart in the absence of physical exertion (e.g. sense of heart rate increase, heart missing a beat). *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_scared', type: 'likert', label: '106. (A) I felt scared without any good reason. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass_meaningless', type: 'likert', label: '107. (D) I felt that life was meaningless. *', required: true, showIf: { field: 'fill_dass21', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]}
        ]
      },
      {
        title: 'Section 7 - VVAS - Visual Vertigo Analogue Scale',
        description: 'Indicate the amount of dizziness you experience in the following situations by clicking the scales below. "0" represents no dizziness and "10" represents the most dizziness.',
        questions: [
          { id: 'fill_vvas', type: 'radio', label: '108. Do you want to fill in VVAS questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'vvas_supermarket', type: 'slider', label: '109. Walking through a supermarket aisle *', required: true, showIf: { field: 'fill_vvas', value: 'yes' }, min: 0, max: 10 },
          { id: 'vvas_passenger', type: 'slider', label: '110. Being a passenger in a car *', required: true, showIf: { field: 'fill_vvas', value: 'yes' }, min: 0, max: 10 },
          { id: 'vvas_fluorescent', type: 'slider', label: '111. Being under fluorescent lights *', required: true, showIf: { field: 'fill_vvas', value: 'yes' }, min: 0, max: 10 },
          { id: 'vvas_traffic', type: 'slider', label: '112. Watching traffic at a busy intersection *', required: true, showIf: { field: 'fill_vvas', value: 'yes' }, min: 0, max: 10 },
          { id: 'vvas_mall', type: 'slider', label: '113. Walking through a shopping mall *', required: true, showIf: { field: 'fill_vvas', value: 'yes' }, min: 0, max: 10 },
          { id: 'vvas_escalator', type: 'slider', label: '114. Going down an escalator *', required: true, showIf: { field: 'fill_vvas', value: 'yes' }, min: 0, max: 10 },
          { id: 'vvas_movie', type: 'slider', label: '115. Watching a movie at the movie theatre *', required: true, showIf: { field: 'fill_vvas', value: 'yes' }, min: 0, max: 10 },
          { id: 'vvas_patterned_floor', type: 'slider', label: '116. Walking over a patterned floor *', required: true, showIf: { field: 'fill_vvas', value: 'yes' }, min: 0, max: 10 },
          { id: 'vvas_television', type: 'slider', label: '117. Watching action television *', required: true, showIf: { field: 'fill_vvas', value: 'yes' }, min: 0, max: 10 }
        ]
      },
      {
        title: 'Section 8 - BDI-II - Beck\'s Depression Inventory Version 2',
        description: 'Select the one statement that best describes the way you have been feeling during the past two weeks, including today.',
        questions: [
          { id: 'fill_bdi2', type: 'radio', label: '118. Do you want to fill in BDI-II questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'bdi_sadness', type: 'radio', label: '119. Sadness *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            { value: '0', label: '(0) I do not feel sad' },
            { value: '1', label: '(1) I feel sad much of the time' },
            { value: '2', label: '(2) I am sad all the time' },
            { value: '3', label: '(3) I am so sad or unhappy that I can\'t stand it' }
          ]},
          { id: 'bdi_pessimism', type: 'radio', label: '120. Pessimism *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            { value: '0', label: '(0) I am not discouraged about my future' },
            { value: '1', label: '(1) I feel more discouraged about my future than I used to be' },
            { value: '2', label: '(2) I do not expect things to work out for me' },
            { value: '3', label: '(3) I feel my future is hopeless and will only get worse' }
          ]},
          { id: 'bdi_past_failure', type: 'radio', label: '121. Past failure *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            { value: '0', label: '(0) I do not feel like a failure' },
            { value: '1', label: '(1) I have failed more than I should have' },
            { value: '2', label: '(2) As I look back, I see a lot of failures' },
            { value: '3', label: '(3) I feel I am a total failure as a person' }
          ]},
          { id: 'bdi_loss_pleasure', type: 'radio', label: '122. Loss of pleasure *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            { value: '0', label: '(0) I get as much pleasure as I ever did from the things I enjoy' },
            { value: '1', label: '(1) I don\'t enjoy things as much as I used to' },
            { value: '2', label: '(2) I get very little pleasure from the things I used to enjoy' },
            { value: '3', label: '(3) I can\'t get any pleasure from the things I used to enjoy' }
          ]},
          { id: 'bdi_guilty', type: 'radio', label: '123. Guilty feelings *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            { value: '0', label: '(0) I don\'t feel particularly guilty' },
            { value: '1', label: '(1) I feel guilty over many things I have done or should have done' },
            { value: '2', label: '(2) I feel quite guilty most of the time' },
            { value: '3', label: '(3) I feel guilty all of the time' }
          ]},
          { id: 'bdi_punishment', type: 'radio', label: '124. Punishment feelings *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            { value: '0', label: '(0) I don\'t feel I am being punished' },
            { value: '1', label: '(1) I feel I may be punished' },
            { value: '2', label: '(2) I expect to be punished' },
            { value: '3', label: '(3) I feel I am being punished' }
          ]},
          { id: 'bdi_self_dislike', type: 'radio', label: '125. Self-Dislike *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            { value: '0', label: '(0) I feel the same about myself as ever' },
            { value: '1', label: '(1) I have lost confidence in myself' },
            { value: '2', label: '(2) I am disappointed in myself' },
            { value: '3', label: '(3) I dislike myself' }
          ]},
          { id: 'bdi_self_critical', type: 'radio', label: '126. Self-Criticalness *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            { value: '0', label: '(0) I don\'t criticize or blame myself more than usual' },
            { value: '1', label: '(1) I am more critical of myself than I used to be' },
            { value: '2', label: '(2) I criticize myself for all of my faults' },
            { value: '3', label: '(3) I blame myself for everything bad that happens' }
          ]},
          { id: 'bdi_suicidal', type: 'radio', label: '127. Suicidal Thoughts or Wishes *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            { value: '0', label: '(0) I don\'t have any thoughts of killing myself' },
            { value: '1', label: '(1) I have thoughts of killing myself, but I would not carry them out' },
            { value: '2', label: '(2) I would like to kill myself' },
            { value: '3', label: '(3) I would kill myself if I had the chance' }
          ]},
          { id: 'bdi_crying', type: 'radio', label: '128. Crying *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            { value: '0', label: '(0) I don\'t cry any more than I used to' },
            { value: '1', label: '(1) I cry more than I used to' },
            { value: '2', label: '(2) I cry over every little thing' },
            { value: '3', label: '(3) I feel like crying, but I can\'t' }
          ]},
          { id: 'bdi_agitation', type: 'radio', label: '129. Agitation *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            { value: '0', label: '(0) I am no more restless or wound up than usual' },
            { value: '1', label: '(1) I feel more restless or wound up than usual' },
            { value: '2', label: '(2) I am so restless or agitated that it\'s hard to stay still' },
            { value: '3', label: '(3) I am so restless or agitated that I have to keep moving or doing something' }
          ]},
          { id: 'bdi_loss_interest', type: 'radio', label: '130. Loss of Interest *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            { value: '0', label: '(0) I have not lost interest in other people or activities' },
            { value: '1', label: '(1) I am less interested in other people or things than before' },
            { value: '2', label: '(2) I have lost most of my interest in other people or things' },
            { value: '3', label: '(3) It\'s hard to get interested in anything' }
          ]},
          { id: 'bdi_indecisiveness', type: 'radio', label: '131. Indecisiveness *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            { value: '0', label: '(0) I make decisions about as well as ever' },
            { value: '1', label: '(1) I find it more difficult to make decisions than usual' },
            { value: '2', label: '(2) I have much greater difficulty in making decisions than I used to' },
            { value: '3', label: '(3) I have trouble making any decisions' }
          ]},
          { id: 'bdi_worthlessness', type: 'radio', label: '132. Worthlessness *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            { value: '0', label: '(0) I do not feel I am worthless' },
            { value: '1', label: '(1) I don\'t consider myself as worthwhile and useful as I used to' },
            { value: '2', label: '(2) I feel more worthless as compared to other people' },
            { value: '3', label: '(3) I feel utterly worthless' }
          ]},
          { id: 'bdi_loss_energy', type: 'radio', label: '133. Loss of Energy *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            { value: '0', label: '(0) I have as much energy as ever' },
            { value: '1', label: '(1) I have less energy than I used to have' },
            { value: '2', label: '(2) I don\'t have enough energy to do very much' },
            { value: '3', label: '(3) I don\'t have enough energy to do anything' }
          ]},
          { id: 'bdi_sleeping', type: 'radio', label: '134. Changes in Sleeping Pattern *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            { value: '0', label: '(0) I have not experienced any change in my sleeping pattern' },
            { value: '1', label: '(1) I sleep somewhat more than usual' },
            { value: '2', label: '(2) I sleep somewhat less than usual' },
            { value: '3', label: '(3) I sleep a lot more than usual' },
            { value: '4', label: '(4) I sleep a lot less than usual' },
            { value: '5', label: '(5) I sleep most of the day' },
            { value: '6', label: '(6) I wake up 1-2 hours early and can\'t get back to sleep' }
          ]},
          { id: 'bdi_irritability', type: 'radio', label: '135. Irritability *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            { value: '0', label: '(0) I am no more irritable than usual' },
            { value: '1', label: '(1) I am more irritable than usual' },
            { value: '2', label: '(2) I am much more irritable than usual' },
            { value: '3', label: '(3) I am irritable all the time' }
          ]},
          { id: 'bdi_appetite', type: 'radio', label: '136. Changes in Appetite *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            { value: '0', label: '(0) I have not experienced any changes in my appetite' },
            { value: '1', label: '(1) My appetite is somewhat less than usual' },
            { value: '2', label: '(2) My appetite is somewhat greater than usual' },
            { value: '3', label: '(3) My appetite is much less than before' },
            { value: '4', label: '(4) My appetite is much greater than usual' },
            { value: '5', label: '(5) I have no appetite at all' },
            { value: '6', label: '(6) I crave food all the time' }
          ]},
          { id: 'bdi_concentration', type: 'radio', label: '137. Concentration Difficulty *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            { value: '0', label: '(0) I can concentrate as well as ever' },
            { value: '1', label: '(1) I can\'t concentrate as well as usual' },
            { value: '2', label: '(2) It\'s hard to keep my mind on anything for very long' },
            { value: '3', label: '(3) I find I can\'t concentrate on anything' }
          ]},
          { id: 'bdi_tiredness', type: 'radio', label: '138. Tiredness or Fatigue *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            { value: '0', label: '(0) I am no more tired or fatigued than usual' },
            { value: '1', label: '(1) I get more tired or fatigued more easily than usual' },
            { value: '2', label: '(2) I am too tired or fatigued to do a lot of the things I used to do' },
            { value: '3', label: '(3) I am too tired or fatigued to do most of the things I used to do' }
          ]},
          { id: 'bdi_loss_sex', type: 'radio', label: '139. Loss of Interest in Sex *', required: true, showIf: { field: 'fill_bdi2', value: 'yes' }, options: [
            { value: '0', label: '(0) I have not noticed any recent change in my interest in sex' },
            { value: '1', label: '(1) I am less interested in sex than I used to be' },
            { value: '2', label: '(2) I am much less interested in sex now' },
            { value: '3', label: '(3) I have lost interest in sex completely' }
          ]}
        ]
      }
    ]
  },

  depression: {
    title: 'Depression / Anxiety Assessment',
    sections: [
      {
        title: 'Section 1 - General Data',
        questions: [
          { id: 'assessment_date_da', type: 'date', label: '1. Date of assessment *', required: true },
          { id: 'doctor_email_da', type: 'email', label: '2. Doctor Email *', required: true },
          { id: 'patient_name_da', type: 'text', label: '3. Patient Name and Surname *', required: true },
          { id: 'patient_id_da', type: 'text', label: '4. Patient ID *', required: true },
          { id: 'patient_age_da', type: 'radio', label: '5. Patient Age *', required: true, options: [
            { value: '<18', label: '< 18' },
            { value: '18-25', label: '18-25' },
            { value: '26-35', label: '26-35' },
            { value: '36-45', label: '36-45' },
            { value: '46-55', label: '46-55' },
            { value: '56-65', label: '56-65' },
            { value: '>65', label: '> 65' }
          ]},
          { id: 'gender_da', type: 'radio', label: '6. Gender *', required: true, options: [
            { value: 'male', label: 'Male' },
            { value: 'female', label: 'Female' },
            { value: 'non-binary', label: 'Non-binary' }
          ]},
          { id: 'visit_type_da', type: 'radio', label: '7. Please choose one of the following options *', required: true, options: [
            { value: 'first', label: 'First visit' },
            { value: 'followup1', label: 'Follow-up visit 1' },
            { value: 'followup2', label: 'Follow-up visit 2' },
            { value: 'followup3', label: 'Follow-up visit 3' }
          ]}
        ]
      },
      {
        title: 'Section 2 - EQ-5D-5L Health Questionnaire',
        questions: [
          { id: 'fill_eq5d_da', type: 'radio', label: '8. Do you want to fill in EQ-5D-5L questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'eq5d_mobility_da', type: 'likert', label: '9. Mobility *', required: true, showIf: { field: 'fill_eq5d_da', value: 'yes' }, options: [
            '(1) I have no problems in walking about',
            '(2) I have slight problems in walking about',
            '(3) I have moderate problems in walking about',
            '(4) I have severe problems in walking about',
            '(5) I am unable to walk about'
          ]},
          { id: 'eq5d_selfcare_da', type: 'likert', label: '10. Self Care *', required: true, showIf: { field: 'fill_eq5d_da', value: 'yes' }, options: [
            '(1) I have no problems washing or dressing myself',
            '(2) I have slight problems washing or dressing myself',
            '(3) I have moderate problems washing or dressing myself',
            '(4) I have severe problems washing or dressing myself',
            '(5) I am unable to wash or dress myself'
          ]},
          { id: 'eq5d_activities_da', type: 'likert', label: '11. Usual activities (e.g. work, study, housework, family or leisure activities) *', required: true, showIf: { field: 'fill_eq5d_da', value: 'yes' }, options: [
            '(1) I have no problems doing my usual activities',
            '(2) I have slight problems doing my usual activities',
            '(3) I have moderate problems doing my usual activities',
            '(4) I have severe problems doing my usual activities',
            '(5) I am unable to do my usual activities'
          ]},
          { id: 'eq5d_pain_da', type: 'likert', label: '12. Pain/Discomfort *', required: true, showIf: { field: 'fill_eq5d_da', value: 'yes' }, options: [
            '(1) I have no pain or discomfort',
            '(2) I have slight pain or discomfort',
            '(3) I have moderate pain or discomfort',
            '(4) I have severe pain or discomfort',
            '(5) I have extreme pain or discomfort'
          ]},
          { id: 'eq5d_anxiety_da', type: 'likert', label: '13. Anxiety/Depression *', required: true, showIf: { field: 'fill_eq5d_da', value: 'yes' }, options: [
            '(1) I am not anxious or depressed',
            '(2) I am slightly anxious or depressed',
            '(3) I am moderately anxious or depressed',
            '(4) I am severely anxious or depressed',
            '(5) I am extremely anxious or depressed'
          ]},
          { id: 'eq5d_health_scale_da', type: 'slider', label: '14. We would like to know how good or bad your health is TODAY. 0 means the worst health you can imagine. 10 means the best health you can imagine. *', required: true, showIf: { field: 'fill_eq5d_da', value: 'yes' }, min: 0, max: 10 }
        ]
      },
      {
        title: 'Section 3 - COMPASS 31',
        questions: [
          { id: 'fill_compass31_da', type: 'radio', label: '15. Do you want to fill in COMPASS-31 questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'compass31_da_q16', type: 'radio', label: '16. In the past year, have you ever felt faint, dizzy, "goofy", or had difficulty thinking soon after standing up from a sitting or lying position? *', required: true, showIf: { field: 'fill_compass31_da', value: 'yes' }, options: [
            { value: '1', label: '(1) Yes' },
            { value: '2', label: '(2) No' }
          ]},
          { id: 'compass31_da_q17', type: 'likert', label: '17. When standing up, how frequently do you get these feelings or symptoms? *', required: true, showIf: { field: 'compass31_da_q16', value: '1' }, options: [
            '(1) Rarely',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Almost Always'
          ]},
          { id: 'compass31_da_q18', type: 'likert', label: '18. How would you rate the severity of these feelings or symptoms? *', required: true, showIf: { field: 'compass31_da_q16', value: '1' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_da_q19', type: 'likert', label: '19. In the past year, have these feelings or symptoms that you have experienced: *', required: true, showIf: { field: 'compass31_da_q16', value: '1' }, options: [
            '(1) Gotten much worse',
            '(2) Gotten somewhat worse',
            '(3) Stayed about the same',
            '(4) Gotten somewhat better',
            '(5) Gotten much better Completely gone'
          ]},
          { id: 'compass31_da_q20', type: 'radio', label: '20. In the past year, have you ever noticed color changes in your skin, such as red, white, or purple? *', required: true, showIf: { field: 'fill_compass31_da', value: 'yes' }, options: [
            { value: '1', label: '(1) Yes' },
            { value: '2', label: '(2) No' }
          ]},
          { id: 'compass31_da_q21', type: 'checkbox', label: '21. What parts of your body are affected by these color changes? (Check all that apply) *', required: true, showIf: { field: 'compass31_da_q20', value: '1' }, options: [
            { value: 'hands', label: '(1) Hands' },
            { value: 'feet', label: '(2) Feet' }
          ]},
          { id: 'compass31_da_q22', type: 'likert', label: '22. Are these changes in your skin color: *', required: true, showIf: { field: 'compass31_da_q20', value: '1' }, options: [
            '(1) Getting much worse',
            '(2) Getting somewhat worse',
            '(3) Staying about the same',
            '(4) Getting somewhat better',
            '(5) Getting much better',
            '(6) Completely gone'
          ]},
          { id: 'compass31_da_q23', type: 'likert', label: '23. In the past 5 years, what changes, if any, have occurred in your general body sweating? *', required: true, showIf: { field: 'fill_compass31_da', value: 'yes' }, options: [
            '(1) I sweat much more than I used to',
            '(2) I sweat somewhat more than I used to',
            '(3) I haven\'t noticed any changes in my sweating',
            '(4) I sweat somewhat less than I used to',
            '(5) I sweat much less than I used to'
          ]},
          { id: 'compass31_da_q24', type: 'radio', label: '24. Do your eyes feel excessively dry? *', required: true, showIf: { field: 'fill_compass31_da', value: 'yes' }, options: [
            { value: '1', label: '(1) Yes' },
            { value: '2', label: '(2) No' }
          ]},
          { id: 'compass31_da_q25', type: 'radio', label: '25. Does you mouth feel excessively dry? *', required: true, showIf: { field: 'fill_compass31_da', value: 'yes' }, options: [
            { value: '1', label: '(1) Yes' },
            { value: '2', label: '(2) No' }
          ]},
          { id: 'compass31_da_q26', type: 'likert', label: '26. For the symptom of dry eyes or dry mouth that you have had for the longest period of time, is this symptom: *', required: true, showIf: { field: 'fill_compass31_da', value: 'yes' }, options: [
            '(1) I have not had any of these symptoms',
            '(2) Getting much worse',
            '(3) Getting somewhat worse',
            '(4) Staying about the same',
            '(5) Getting somewhat better',
            '(6) Getting much better',
            '(7) Completely gone'
          ]},
          { id: 'compass31_da_q27', type: 'likert', label: '27. In the past year, have you noticed any changes in how quickly you get full when eating a meal? *', required: true, showIf: { field: 'fill_compass31_da', value: 'yes' }, options: [
            '(1) I get full a lot more quickly now than I used to',
            '(2) I get full more quickly now than I used to',
            '(3) I haven\'t noticed any change',
            '(4) I get full less quickly now than I used to',
            '(5) I get full a lot less quickly now than I used to'
          ]},
          { id: 'compass31_da_q28', type: 'likert', label: '28. In the past year, have you felt excessively full or persistently full (bloated feeling) after a meal? *', required: true, showIf: { field: 'fill_compass31_da', value: 'yes' }, options: [
            '(1) Never',
            '(2) Sometimes',
            '(3) A lot of times'
          ]},
          { id: 'compass31_da_q29', type: 'likert', label: '29. In the past year, have you vomited after a meal? *', required: true, showIf: { field: 'fill_compass31_da', value: 'yes' }, options: [
            '(1) Never',
            '(2) Sometimes',
            '(3) A lot of time'
          ]},
          { id: 'compass31_da_q30', type: 'likert', label: '30. In the past year, have you had a cramping or colicky abdominal pain? *', required: true, showIf: { field: 'fill_compass31_da', value: 'yes' }, options: [
            '(1) Never',
            '(2) Sometimes',
            '(3) A lot of times'
          ]},
          { id: 'compass31_da_q31', type: 'radio', label: '31. In the past year, have you had any bouts of diarrhea? *', required: true, showIf: { field: 'fill_compass31_da', value: 'yes' }, options: [
            { value: '1', label: '(1) Yes' },
            { value: '2', label: '(2) No' }
          ]},
          { id: 'compass31_da_q32', type: 'likert', label: '32. How frequently does this occur? *', required: true, showIf: { field: 'compass31_da_q31', value: '1' }, options: [
            '(1) Rarely',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_da_q33', type: 'likert', label: '33. How severe are these bouts of diarrhea? *', required: true, showIf: { field: 'compass31_da_q31', value: '1' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_da_q34', type: 'likert', label: '34. Are your bouts of diarrhea getting: *', required: true, showIf: { field: 'compass31_da_q31', value: '1' }, options: [
            '(1) Much worse',
            '(2) Somewhat worse',
            '(3) Staying the same',
            '(4) Much better',
            '(5) Completely gone'
          ]},
          { id: 'compass31_da_q35', type: 'radio', label: '35. In the past year, have you been constipated? *', required: true, showIf: { field: 'fill_compass31_da', value: 'yes' }, options: [
            { value: '1', label: '(1) Yes' },
            { value: '2', label: '(2) No' }
          ]},
          { id: 'compass31_da_q36', type: 'likert', label: '36. How frequently are you constipated? *', required: true, showIf: { field: 'compass31_da_q35', value: '1' }, options: [
            '(1) Rarely',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_da_q37', type: 'likert', label: '37. How severe are these episodes of constipation? *', required: true, showIf: { field: 'compass31_da_q35', value: '1' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_da_q38', type: 'likert', label: '38. Is your constipation getting: *', required: true, showIf: { field: 'compass31_da_q35', value: '1' }, options: [
            '(1) Much worse',
            '(2) Somewhat worse',
            '(3) Staying the same',
            '(4) Somewhat better',
            '(5) Much better',
            '(6) Completely gone'
          ]},
          { id: 'compass31_da_q39', type: 'likert', label: '39. In the past year, have you ever lost control of your bladder function? *', required: true, showIf: { field: 'fill_compass31_da', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_da_q40', type: 'likert', label: '40. In the past year, have you had difficulty passing urine? *', required: true, showIf: { field: 'fill_compass31_da', value: 'yes' }, options: [
            '(1)Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_da_q41', type: 'likert', label: '41. In the past year, have you had trouble completely emptying your bladder? *', required: true, showIf: { field: 'fill_compass31_da', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_da_q42', type: 'likert', label: '42. In the past year, without sunglasses or tinted glasses, has bright light bothered your eyes? *', required: true, showIf: { field: 'fill_compass31_da', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_da_q43', type: 'likert', label: '43. How severe is this sensitivity to bright light? *', required: true, showIf: { field: 'compass31_da_q42', value: '(2) Occasionally' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_da_q43b', type: 'likert', label: '43. How severe is this sensitivity to bright light? *', required: true, showIf: { field: 'compass31_da_q42', value: '(3) Frequently' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_da_q43c', type: 'likert', label: '43. How severe is this sensitivity to bright light? *', required: true, showIf: { field: 'compass31_da_q42', value: '(4) Constantly' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_da_q44', type: 'likert', label: '44. In the past year, have you had trouble focusing your eyes? *', required: true, showIf: { field: 'fill_compass31_da', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_da_q45', type: 'likert', label: '45. How severe is this focusing problem? *', required: true, showIf: { field: 'compass31_da_q44', value: '(2) Occasionally' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_da_q45b', type: 'likert', label: '45. How severe is this focusing problem? *', required: true, showIf: { field: 'compass31_da_q44', value: '(3) Frequently' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_da_q45c', type: 'likert', label: '45. How severe is this focusing problem? *', required: true, showIf: { field: 'compass31_da_q44', value: '(4) Constantly' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_da_q46', type: 'likert', label: '46. Is the most troublesome symptom with your eyes (i.e. sensitivity to bright light or trouble focusing) getting: *', required: true, showIf: { field: 'fill_compass31_da', value: 'yes' }, options: [
            '(1) I have not had any of these symptoms',
            '(2) Much worse',
            '(3) Somewhat worse',
            '(4) Staying about the same',
            '(5) Somewhat better',
            '(6) Much better',
            '(7) Completely gone'
          ]}
        ]
      },
      {
        title: 'Section 4 - DASS-21',
        questions: [
          { id: 'fill_dass21_da', type: 'radio', label: '47. Do you want to fill in DASS-21 questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'dass21_da_q1', type: 'likert', label: '48. (S) I found it hard to wind down. *', required: true, showIf: { field: 'fill_dass21_da', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_da_q2', type: 'likert', label: '49. (A) I was aware of dryness of my mouth. *', required: true, showIf: { field: 'fill_dass21_da', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_da_q3', type: 'likert', label: '50. (D) I couldn\'t seem to experience any positive feeling at all. *', required: true, showIf: { field: 'fill_dass21_da', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_da_q4', type: 'likert', label: '51. (A) I experienced breathing difficulty (e.g. excessively rapid breathing, breathlessness in the absence of physical exertion). *', required: true, showIf: { field: 'fill_dass21_da', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_da_q5', type: 'likert', label: '52. (D) I found it difficult to work up the initiative to do things. *', required: true, showIf: { field: 'fill_dass21_da', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_da_q6', type: 'likert', label: '53. (S) I tended to over-react to situations. *', required: true, showIf: { field: 'fill_dass21_da', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_da_q7', type: 'likert', label: '54. (A) I experienced trembling (e.g. in the hands). *', required: true, showIf: { field: 'fill_dass21_da', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_da_q8', type: 'likert', label: '55. (S) I felt that I was using a lot of nervous energy. *', required: true, showIf: { field: 'fill_dass21_da', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_da_q9', type: 'likert', label: '56. (A) I was worried about situations in which I might panic and make a fool of myself. *', required: true, showIf: { field: 'fill_dass21_da', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_da_q10', type: 'likert', label: '57. (D) I felt that I had nothing to look forward to. *', required: true, showIf: { field: 'fill_dass21_da', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_da_q11', type: 'likert', label: '58. (S) I found myself getting agitated. *', required: true, showIf: { field: 'fill_dass21_da', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_da_q12', type: 'likert', label: '59. (S) I found it difficult to relax. *', required: true, showIf: { field: 'fill_dass21_da', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_da_q13', type: 'likert', label: '60. (D) I felt down-hearted and blue. *', required: true, showIf: { field: 'fill_dass21_da', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_da_q14', type: 'likert', label: '61. (S) I was intolerant of anything that kept me from getting on with what I was doing. *', required: true, showIf: { field: 'fill_dass21_da', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_da_q15', type: 'likert', label: '62. (A) I felt I was close to panic. *', required: true, showIf: { field: 'fill_dass21_da', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_da_q16', type: 'likert', label: '63. (D) I was unable to become enthusiastic about anything. *', required: true, showIf: { field: 'fill_dass21_da', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_da_q17', type: 'likert', label: '64. (D) I felt I wasn\'t worth much as a person. *', required: true, showIf: { field: 'fill_dass21_da', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_da_q18', type: 'likert', label: '65. (S) I felt that I was rather touchy. *', required: true, showIf: { field: 'fill_dass21_da', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_da_q19', type: 'likert', label: '66. (A) I was aware of the action of my heart in the absence of physical exertion (e.g. sense of heart rate increase, heart missing a beat). *', required: true, showIf: { field: 'fill_dass21_da', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_da_q20', type: 'likert', label: '67. (A) I felt scared without any good reason. *', required: true, showIf: { field: 'fill_dass21_da', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_da_q21', type: 'likert', label: '68. (D) I felt that life was meaningless. *', required: true, showIf: { field: 'fill_dass21_da', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]}
        ]
      },
      {
        title: 'Section 5 - BDI-II - Beck\'s Depression Inventory Version 2',
        questions: [
          { id: 'fill_bdi2_da', type: 'radio', label: '69. Do you want to fill in BDI-II questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'bdi2_da_sadness', type: 'likert', label: '70. Sadness *', required: true, showIf: { field: 'fill_bdi2_da', value: 'yes' }, options: [
            '(0) I do not feel sad',
            '(1) I feel sad much of the time',
            '(2) I am sad all the time',
            '(3) I am so sad or unhappy that I can\'t stand it'
          ]},
          { id: 'bdi2_da_pessimism', type: 'likert', label: '71. Pessimism *', required: true, showIf: { field: 'fill_bdi2_da', value: 'yes' }, options: [
            '(0) I am not discouraged about my future',
            '(1) I feel more discouraged about my future than I used to be',
            '(2) I do not expect things to work out for me',
            '(3) I feel my future is hopeless and will only get worse'
          ]},
          { id: 'bdi2_da_pastfailure', type: 'likert', label: '72. Past Failure *', required: true, showIf: { field: 'fill_bdi2_da', value: 'yes' }, options: [
            '(0) I do not feel like a failure',
            '(1) I have failed more than I should have',
            '(2) As I look back, I see a lot of failures',
            '(3) I feel I am a total failure as a person'
          ]},
          { id: 'bdi2_da_losspleasure', type: 'likert', label: '73. Loss of Pleasure *', required: true, showIf: { field: 'fill_bdi2_da', value: 'yes' }, options: [
            '(0) I get as much pleasure as I ever did from the things I enjoy',
            '(1) I don\'t enjoy things as much as I used to',
            '(2) I get very little pleasure from the things I used to enjoy',
            '(3) I can\'t get any pleasure from the things I used to enjoy'
          ]},
          { id: 'bdi2_da_guilty', type: 'likert', label: '74. Guilty Feelings *', required: true, showIf: { field: 'fill_bdi2_da', value: 'yes' }, options: [
            '(0) I don\'t feel particularly guilty',
            '(1) I feel guilty over many things I have done or should have done',
            '(2) I feel quite guilty most of the time',
            '(3) I feel guilty all of the time'
          ]},
          { id: 'bdi2_da_punishment', type: 'likert', label: '75. Punishment Feelings *', required: true, showIf: { field: 'fill_bdi2_da', value: 'yes' }, options: [
            '(0) I don\'t feel I am being punished',
            '(1) I feel I may be punished',
            '(2) I expect to be punished',
            '(3) I feel I am being punished'
          ]},
          { id: 'bdi2_da_selfdislike', type: 'likert', label: '76. Self-Dislike *', required: true, showIf: { field: 'fill_bdi2_da', value: 'yes' }, options: [
            '(0) I feel the same about myself as ever',
            '(1) I have lost confidence in myself',
            '(2) I am disappointed in myself',
            '(3) I dislike myself'
          ]},
          { id: 'bdi2_da_selfcritical', type: 'likert', label: '77. Self-Criticalness *', required: true, showIf: { field: 'fill_bdi2_da', value: 'yes' }, options: [
            '(0) I don\'t criticize or blame myself more than usual',
            '(1) I am more critical of myself than I used to be',
            '(2) I criticize myself for all of my faults',
            '(3) I blame myself for everything bad that happens'
          ]},
          { id: 'bdi2_da_suicidal', type: 'likert', label: '78. Suicidal Thoughts or Wishes *', required: true, showIf: { field: 'fill_bdi2_da', value: 'yes' }, options: [
            '(0) I don\'t have any thoughts of killing myself',
            '(1) I have thoughts of killing myself, but I would not carry them out',
            '(2) I would like to kill myself',
            '(3) I would kill myself if I had the chance'
          ]},
          { id: 'bdi2_da_crying', type: 'likert', label: '79. Crying *', required: true, showIf: { field: 'fill_bdi2_da', value: 'yes' }, options: [
            '(0) I don\'t cry any more than I used to',
            '(1) I cry more than I used to',
            '(2) I cry over every little thing',
            '(3) I feel like crying, but I can\'t'
          ]},
          { id: 'bdi2_da_agitation', type: 'likert', label: '80. Agitation *', required: true, showIf: { field: 'fill_bdi2_da', value: 'yes' }, options: [
            '(0) I am no more restless or wound up than usual',
            '(1) I feel more restless or wound up than usual',
            '(2) I am so restless or agitated that it\'s hard to stay still',
            '(3) I am so restless or agitated that I have to keep moving or doing something'
          ]},
          { id: 'bdi2_da_lossinterest', type: 'likert', label: '81. Loss of Interest *', required: true, showIf: { field: 'fill_bdi2_da', value: 'yes' }, options: [
            '(0) I have not lost interest in other people or activities',
            '(1) I am less interested in other people or things than before',
            '(2) I have lost most of my interest in other people or things',
            '(3) It\'s hard to get interested in anything'
          ]},
          { id: 'bdi2_da_indecisive', type: 'likert', label: '82. Indecisiveness *', required: true, showIf: { field: 'fill_bdi2_da', value: 'yes' }, options: [
            '(0) I make decisions about as well as ever',
            '(1) I find it more difficult to make decisions than usual',
            '(2) I have much greater difficulty in making decisions than I used to',
            '(3) I have trouble making any decisions'
          ]},
          { id: 'bdi2_da_worthless', type: 'likert', label: '83. Worthlessness *', required: true, showIf: { field: 'fill_bdi2_da', value: 'yes' }, options: [
            '(0) I do not feel I am worthless',
            '(1) I don\'t consider myself as worthwhile and useful as I used to',
            '(2) I feel more worthless as compared to other people',
            '(3) I feel utterly worthless'
          ]},
          { id: 'bdi2_da_lossenergy', type: 'likert', label: '84. Loss of Energy *', required: true, showIf: { field: 'fill_bdi2_da', value: 'yes' }, options: [
            '(0) I have as much energy as ever',
            '(1) I have less energy than I used to have',
            '(2) I don\'t have enough energy to do very much',
            '(3) I don\'t have enough energy to do anything'
          ]},
          { id: 'bdi2_da_sleeping', type: 'likert', label: '85. Changes in Sleeping Pattern *', required: true, showIf: { field: 'fill_bdi2_da', value: 'yes' }, options: [
            '(0) I have not experienced any change in my sleeping pattern',
            '(1) I sleep somewhat more than usual',
            '(2) I sleep somewhat less than usual',
            '(3) I sleep a lot more than usual',
            '(4) I sleep a lot less than usual',
            '(5) I sleep most of the day',
            '(6) I wake up 1-2 hours early and can\'t get back to sleep'
          ]},
          { id: 'bdi2_da_irritable', type: 'likert', label: '86. Irritability *', required: true, showIf: { field: 'fill_bdi2_da', value: 'yes' }, options: [
            '(0) I am no more irritable than usual',
            '(1) I am more irritable than usual',
            '(2) I am much more irritable than usual',
            '(3) I am irritable all the time'
          ]},
          { id: 'bdi2_da_appetite', type: 'likert', label: '87. Changes in Appetite *', required: true, showIf: { field: 'fill_bdi2_da', value: 'yes' }, options: [
            '(0) I have not experienced any changes in my appetite',
            '(1) My appetite is somewhat less than usual',
            '(2) My appetite is somewhat greater than usual',
            '(3) My appetite is much less than before',
            '(4) My appetite is much greater than usual',
            '(5) I have no appetite at all',
            '(6) I crave food all the time'
          ]},
          { id: 'bdi2_da_concentration', type: 'likert', label: '88. Concentration Difficulty *', required: true, showIf: { field: 'fill_bdi2_da', value: 'yes' }, options: [
            '(0) I can concentrate as well as ever',
            '(1) I can\'t concentrate as well as usual',
            '(2) It\'s hard to keep my mind on anything for very long',
            '(3) I find I can\'t concentrate on anything'
          ]},
          { id: 'bdi2_da_tiredness', type: 'likert', label: '89. Tiredness or Fatigue *', required: true, showIf: { field: 'fill_bdi2_da', value: 'yes' }, options: [
            '(0) I am no more tired or fatigued than usual',
            '(1) I get more tired or fatigued more easily than usual',
            '(2) I am too tired or fatigued to do a lot of the things I used to do',
            '(3) I am too tired or fatigued to do most of the things I used to do'
          ]},
          { id: 'bdi2_da_sex', type: 'likert', label: '90. Loss of Interest in Sex *', required: true, showIf: { field: 'fill_bdi2_da', value: 'yes' }, options: [
            '(0) I have not noticed any recent change in my interest in sex',
            '(1) I am less interested in sex than I used to be',
            '(2) I am much less interested in sex now',
            '(3) I have lost interest in sex completely'
          ]}
        ]
      },
      {
        title: 'Section 6 - GAD-7',
        questions: [
          { id: 'fill_gad7_da', type: 'radio', label: '91. Do you want to fill in GAD-7 questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'gad7_da_q1', type: 'likert', label: '92. Over the last two weeks feeling nervous, anxious, or on edge *', required: true, showIf: { field: 'fill_gad7_da', value: 'yes' }, options: [
            '(0) Not at all',
            '(1) Several days',
            '(2) More than half of the days',
            '(3) Nearly every day'
          ]},
          { id: 'gad7_da_q2', type: 'likert', label: '93. Over the last two weeks not being able to stop or control worrying *', required: true, showIf: { field: 'fill_gad7_da', value: 'yes' }, options: [
            '(0) Not at all',
            '(1) Several days',
            '(2) More than half of the days',
            '(3) Nearly every day'
          ]},
          { id: 'gad7_da_q3', type: 'likert', label: '94. Over the last two weeks worrying too much about different things *', required: true, showIf: { field: 'fill_gad7_da', value: 'yes' }, options: [
            '(0) Not at all',
            '(1) Several days',
            '(2) More than half of the days',
            '(3) Nearly every day'
          ]},
          { id: 'gad7_da_q4', type: 'likert', label: '95. Over the last two weeks trouble relaxing *', required: true, showIf: { field: 'fill_gad7_da', value: 'yes' }, options: [
            '(0) Not at all',
            '(1) Several days',
            '(2) More than half of the days',
            '(3) Nearly every day'
          ]},
          { id: 'gad7_da_q5', type: 'likert', label: '96. Over the last two weeks being so restless that it is hard to sit still *', required: true, showIf: { field: 'fill_gad7_da', value: 'yes' }, options: [
            '(0) Not at all',
            '(1) Several days',
            '(2) More than half of the days',
            '(3) Nearly every day'
          ]},
          { id: 'gad7_da_q6', type: 'likert', label: '97. Over the last two weeks becoming easily annoyed or irritable *', required: true, showIf: { field: 'fill_gad7_da', value: 'yes' }, options: [
            '(0) Not at all',
            '(1) Several days',
            '(2) More than half of the days',
            '(3) Nearly every day'
          ]},
          { id: 'gad7_da_q7', type: 'likert', label: '98. Over the last two weeks feeling afraid, as if something awful might happen *', required: true, showIf: { field: 'fill_gad7_da', value: 'yes' }, options: [
            '(0) Not at all',
            '(1) Several days',
            '(2) More than half of the days',
            '(3) Nearly every day'
          ]}
        ]
      },
      {
        title: 'Section 7 - MADRS - Montgomery and Asberg Depression Scale',
        questions: [
          { id: 'fill_madrs_da', type: 'radio', label: '99. Do you want to fill in MADRS questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'madrs_da_q1', type: 'likert', label: '100. Apparent Sadness - Representing despondency, gloom and despair, (more than just ordinary transient low spirits) reflected in speech, facial expression, and posture. Rate by depth and inability to brighten up. *', required: true, showIf: { field: 'fill_madrs_da', value: 'yes' }, options: [
            '(0) No sadness',
            '(1)',
            '(2) Looks dispirited but does brighten up without difficulty',
            '(3)',
            '(4) Appears sad and unhappy most of the time',
            '(5)',
            '(6) Looks miserable all the time or extremely despondent'
          ]},
          { id: 'madrs_da_q2', type: 'likert', label: '101. Reported sadness - Representing reports of depressed mood, regardless of whether it is reflected in appearance or not. Includes low spirits, despondency or the feeling of being beyond help and without hope. Rate according to intensity, duration and the extent to which the mood is reported to be influenced by events. *', required: true, showIf: { field: 'fill_madrs_da', value: 'yes' }, options: [
            '(0) Occasional sadness in keeping with the circumstances',
            '(1)',
            '(2) Sad or low but brightens up without difficulty',
            '(3)',
            '(4) Pervasive feelings of sadness or gloominess. The mood is still influenced by external circumstances',
            '(5)',
            '(6) Continuous or unvarying sadness, misery or despondency'
          ]},
          { id: 'madrs_da_q3', type: 'likert', label: '102. Inner tension - Representing feelings of ill-defined discomfort, edginess, inner turmoil, mental tension mounting to either panic, dread or anguish. Rate according to intensity, frequency, duration and the extent of reassurance called for. *', required: true, showIf: { field: 'fill_madrs_da', value: 'yes' }, options: [
            '(0) Placid. Only fleeting inner tension',
            '(1)',
            '(2) Occasional feelings of edginess and ill-defined discomfort',
            '(3)',
            '(4) Continuous feelings of inner tension or intermittent panic which the patient can only master with some difficulty',
            '(5)',
            '(6) Unrelenting dread or anguish or overwhelming panic'
          ]},
          { id: 'madrs_da_q4', type: 'likert', label: '103. Reduced sleep - Representing the experience of reduced duration or depth of sleep compared to the subject\'s own normal pattern when well. *', required: true, showIf: { field: 'fill_madrs_da', value: 'yes' }, options: [
            '(0) Sleeps as usual',
            '(1)',
            '(2) Slight difficulty dropping off to sleep or slightly reduced, light or fitful sleep',
            '(3)',
            '(4) Sleep reduced or broken by at least two hours',
            '(5)',
            '(6) Less than two or three hours sleep'
          ]},
          { id: 'madrs_da_q5', type: 'likert', label: '104. Reduced appetite - Representing the feeling of a loss of appetite compared with when well. Rate by loss of desire for food or the need to force oneself to eat. *', required: true, showIf: { field: 'fill_madrs_da', value: 'yes' }, options: [
            '(0) Normal or increased appetite',
            '(1)',
            '(2) Slightly reduced appetite',
            '(3)',
            '(4) No appetite or food is tasteless',
            '(5)',
            '(6) Needs persuasion to eat at all'
          ]},
          { id: 'madrs_da_q6', type: 'likert', label: '105. Concentration difficulties - Representing difficulties in collecting one\'s thoughts mounting to incapacitating lack of concentration. Rate according to intensity, frequency, and degree of incapacity produced *', required: true, showIf: { field: 'fill_madrs_da', value: 'yes' }, options: [
            '(0) No difficulties in concentrating',
            '(1)',
            '(2) Occasional difficulties in collecting one\'s thoughts',
            '(3)',
            '(4) Difficulties in concentrating and sustaining thought which reduces ability to read or hold a conversation',
            '(5)',
            '(6) Unable to read or converse without great difficulty'
          ]},
          { id: 'madrs_da_q7', type: 'likert', label: '106. Lassitude - Representing a difficulty getting started or slowness initiating and performing everyday activities *', required: true, showIf: { field: 'fill_madrs_da', value: 'yes' }, options: [
            '(0) Hardly any difficulty in getting started or no sluggishness',
            '(1)',
            '(2) Difficulties in starting activities',
            '(3)',
            '(4) Difficulties in starting simple routine activities which are carried out with effort',
            '(5)',
            '(6) Complete lassitude. Unable to do anything without help'
          ]},
          { id: 'madrs_da_q8', type: 'likert', label: '107. Inability to feel - Representing the subjective experience of reduced interest in the surroundings, or activities that normally give pleasure. The ability to react with adequate emotion to circumstances or people is reduced. *', required: true, showIf: { field: 'fill_madrs_da', value: 'yes' }, options: [
            '(0) Normal interest in the surroundings and in other peopl',
            '(1)',
            '(2) Reduced ability to enjoy usual interests',
            '(3)',
            '(4) Loss of interest in the surroundings or loss of feelings for friends and acquaintances',
            '(5)',
            '(6) The experience of being emotionally paralysed, inability to feel anger, grief or pleasure and a complete or even painful failure to feel for close relatives and friends'
          ]},
          { id: 'madrs_da_q9', type: 'likert', label: '108. Pessimistic thoughts - Representing thoughts of guilt, inferiority, self-reproach, sinfulness, remorse and ruin. *', required: true, showIf: { field: 'fill_madrs_da', value: 'yes' }, options: [
            '(0) No pessimistic thoughts',
            '(1)',
            '(2) Fluctuating ideas of failure, self-reproach or self depreciation',
            '(3)',
            '(4) Persistent self-accusations, or definite but still rational ideas of guilt or sin or increasingly pessimistic about the future',
            '(5)',
            '(6) Delusions of ruin, remorse or unredeemable sin or self-accusations which are absurd and unshakable'
          ]},
          { id: 'madrs_da_q10', type: 'likert', label: '109. Suicidal thoughts - Representing the feeling that life is not worth living, that a natural death would be welcome, suicidal thoughts, and preparations for suicide. Suicidal attempts should not in themselves influence the rating. *', required: true, showIf: { field: 'fill_madrs_da', value: 'yes' }, options: [
            '(0) Enjoys life or takes it as it comes',
            '(1)',
            '(2) Weary of life or only fleeting suicidal thoughts',
            '(3)',
            '(4) Probably better off dead or suicidal thoughts are common, and suicide is considered as a possible solution, but without specific plans or intention',
            '(5)',
            '(6) Explicit plans for suicide when there is an opportunity or active preparations for suicide'
          ]}
        ]
      },
      {
        title: 'Section 8 - PSQI - Pittsburgh Sleep Quality Index',
        questions: [
          { id: 'fill_psqi_da', type: 'radio', label: '110. Do you want to fill in PSQI questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'psqi_da_bedtime', type: 'likert', label: '111. During the past month, what time have you usually gone to bed at night? (24-Hour Time Format) *', required: true, showIf: { field: 'fill_psqi_da', value: 'yes' }, options: [
            '21:00', '22:00', '23:00', '24:00', '1:00', '2:00', '3:00', '4:00', '5:00', '6:00', '7:00', '8:00', '9:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00', '20:00'
          ]},
          { id: 'psqi_da_sleeptime', type: 'number', label: '112. During the past month, how long (in minutes) has it usually taken you to fall asleep each night? *', required: true, showIf: { field: 'fill_psqi_da', value: 'yes' } },
          { id: 'psqi_da_wakeup', type: 'likert', label: '113. During the past month, what time have you usually gotten up in the morning? (24-Hour Time Format) *', required: true, showIf: { field: 'fill_psqi_da', value: 'yes' }, options: [
            '4:00', '5:00', '6:00', '7:00', '8:00', '9:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00', '20:00', '21:00', '22:00', '23:00', '24:00', '1:00', '2:00', '3:00'
          ]},
          { id: 'psqi_da_sleephours', type: 'number', label: '114. During the past month, how many hours of actual sleep did you get at night? (This may be different than the number of hours you spent in bed.) *', required: true, showIf: { field: 'fill_psqi_da', value: 'yes' } },
          { id: 'psqi_da_q1', type: 'likert', label: '115. During the past month, how often have you had trouble sleeping because you... Cannot get to sleep within 30 minutes *', required: true, showIf: { field: 'fill_psqi_da', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_da_q2', type: 'likert', label: '116. During the past month, how often have you had trouble sleeping because you... Wake up in the middle of the night or early morning *', required: true, showIf: { field: 'fill_psqi_da', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_da_q3', type: 'likert', label: '117. During the past month, how often have you had trouble sleeping because you... Have to get up to use the bathroom *', required: true, showIf: { field: 'fill_psqi_da', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_da_q4', type: 'likert', label: '118. During the past month, how often have you had trouble sleeping because you... Cannot breathe comfortably *', required: true, showIf: { field: 'fill_psqi_da', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_da_q5', type: 'likert', label: '119. During the past month, how often have you had trouble sleeping because you... Cough or snore loudly *', required: true, showIf: { field: 'fill_psqi_da', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_da_q6', type: 'likert', label: '120. During the past month, how often have you had trouble sleeping because you... Feel too cold *', required: true, showIf: { field: 'fill_psqi_da', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_da_q7', type: 'likert', label: '121. During the past month, how often have you had trouble sleeping because you... Feel too hot *', required: true, showIf: { field: 'fill_psqi_da', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_da_q8', type: 'likert', label: '122. During the past month, how often have you had trouble sleeping because you... Have bad dreams *', required: true, showIf: { field: 'fill_psqi_da', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_da_q9', type: 'likert', label: '123. During the past month, how often have you had trouble sleeping because you... Have pain *', required: true, showIf: { field: 'fill_psqi_da', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_da_q10', type: 'likert', label: '124. During the past month, how often have you had trouble sleeping because you... Other reason(s) *', required: true, showIf: { field: 'fill_psqi_da', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_da_medicine', type: 'likert', label: '125. During the past month, how often have you taken medicine to help you sleep (prescribed or "over the counter")? *', required: true, showIf: { field: 'fill_psqi_da', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_da_awake', type: 'likert', label: '126. During the past month, how often have you had trouble staying awake while driving, eating meals, or engaging in social activity? *', required: true, showIf: { field: 'fill_psqi_da', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_da_enthusiasm', type: 'likert', label: '127. During the past month, how much of a problem has it been for you to keep up enough enthusiasm to get things done? *', required: true, showIf: { field: 'fill_psqi_da', value: 'yes' }, options: [
            '(0) Not a problem at all',
            '(1) Only very slight problem',
            '(2) Somewhat of a problem',
            '(3) A very big problem'
          ]},
          { id: 'psqi_da_quality', type: 'likert', label: '128. During the past month, how would you rate your sleep quality overall? *', required: true, showIf: { field: 'fill_psqi_da', value: 'yes' }, options: [
            '(0) Very good',
            '(1) Fairly good',
            '(2) Fairly bad',
            '(3) Very bad'
          ]},
          { id: 'psqi_da_partner', type: 'likert', label: '129. Do you have a bed partner or roommate? *', required: true, showIf: { field: 'fill_psqi_da', value: 'yes' }, options: [
            'No bed partner or room mate',
            'Partner/room mate in other room',
            'Partner in same room but not same bed',
            'Partner in same bed'
          ]},
          { id: 'psqi_da_snoring', type: 'likert', label: '130. If you have a room mate or bed partner, ask him/her how often in the past month you have had: Loud snoring *', required: true, showIf: { field: 'fill_psqi_da', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_da_pauses', type: 'likert', label: '131. If you have a room mate or bed partner, ask him/her how often in the past month you have had: Long pauses between breaths while asleep *', required: true, showIf: { field: 'fill_psqi_da', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_da_twitching', type: 'likert', label: '132. If you have a room mate or bed partner, ask him/her how often in the past month you have had: Legs twitching or jerking while you sleep *', required: true, showIf: { field: 'fill_psqi_da', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_da_disorientation', type: 'likert', label: '133. If you have a room mate or bed partner, ask him/her how often in the past month you have had: Episodes of disorientation or confusion during sleep *', required: true, showIf: { field: 'fill_psqi_da', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_da_restless', type: 'likert', label: '134. If you have a room mate or bed partner, ask him/her how often in the past month you have had: Other restlessness while you sleep, please describe in next question: *', required: true, showIf: { field: 'fill_psqi_da', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_da_describe', type: 'text', label: '135. Describe other restlessness while you sleep if applicable: *', required: true, showIf: { field: 'psqi_da_restless', value: '(1) Less than once a week' } },
          { id: 'psqi_da_describe2', type: 'text', label: '135. Describe other restlessness while you sleep if applicable: *', required: true, showIf: { field: 'psqi_da_restless', value: '(2) Once or twice a week' } },
          { id: 'psqi_da_describe3', type: 'text', label: '135. Describe other restlessness while you sleep if applicable: *', required: true, showIf: { field: 'psqi_da_restless', value: '(3) Three or more times a week' } }
        ]
      }
    ]
  },
  dementia: {
    title: 'Dementia Assessment',
    sections: [
      {
        title: 'Section 1 - General Data',
        questions: [
          { id: 'assessment_date_dm', type: 'date', label: '1. Date of assessment *', required: true },
          { id: 'doctor_email_dm', type: 'email', label: '2. Doctor Email *', required: true },
          { id: 'patient_name_dm', type: 'text', label: '3. Patient Name and Surname *', required: true },
          { id: 'patient_id_dm', type: 'text', label: '4. Patient ID *', required: true },
          { id: 'patient_age_dm', type: 'radio', label: '5. Patient Age *', required: true, options: [
            { value: '<18', label: '< 18' },
            { value: '18-25', label: '18-25' },
            { value: '26-35', label: '26-35' },
            { value: '36-45', label: '36-45' },
            { value: '46-55', label: '46-55' },
            { value: '56-65', label: '56-65' },
            { value: '>65', label: '> 65' }
          ]},
          { id: 'gender_dm', type: 'radio', label: '6. Gender *', required: true, options: [
            { value: 'male', label: 'Male' },
            { value: 'female', label: 'Female' },
            { value: 'non-binary', label: 'Non-binary' }
          ]},
          { id: 'visit_type_dm', type: 'radio', label: '7. Please choose one of the following options *', required: true, options: [
            { value: 'first', label: 'First visit' },
            { value: 'followup1', label: 'Follow-up visit 1' },
            { value: 'followup2', label: 'Follow-up visit 2' },
            { value: 'followup3', label: 'Follow-up visit 3' }
          ]}
        ]
      },
      {
        title: 'Section 2 - EQ-5D-5L Health Questionnaire',
        questions: [
          { id: 'fill_eq5d_dm', type: 'radio', label: '8. Do you want to fill in EQ-5D-5L questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'eq5d_mobility_dm', type: 'likert', label: '9. Mobility *', required: true, showIf: { field: 'fill_eq5d_dm', value: 'yes' }, options: [
            '(1) I have no problems in walking about',
            '(2) I have slight problems in walking about',
            '(3) I have moderate problems in walking about',
            '(4) I have severe problems in walking about',
            '(5) I am unable to walk about'
          ]},
          { id: 'eq5d_selfcare_dm', type: 'likert', label: '10. Self Care *', required: true, showIf: { field: 'fill_eq5d_dm', value: 'yes' }, options: [
            '(1) I have no problems washing or dressing myself',
            '(2) I have slight problems washing or dressing myself',
            '(3) I have moderate problems washing or dressing myself',
            '(4) I have severe problems washing or dressing myself',
            '(5) I am unable to wash or dress myself'
          ]},
          { id: 'eq5d_activities_dm', type: 'likert', label: '11. Usual activities (e.g. work, study, housework, family or leisure activities) *', required: true, showIf: { field: 'fill_eq5d_dm', value: 'yes' }, options: [
            '(1) I have no problems doing my usual activities',
            '(2) I have slight problems doing my usual activities',
            '(3) I have moderate problems doing my usual activities',
            '(4) I have severe problems doing my usual activities',
            '(5) I am unable to do my usual activities'
          ]},
          { id: 'eq5d_pain_dm', type: 'likert', label: '12. Pain/Discomfort *', required: true, showIf: { field: 'fill_eq5d_dm', value: 'yes' }, options: [
            '(1) I have no pain or discomfort',
            '(2) I have slight pain or discomfort',
            '(3) I have moderate pain or discomfort',
            '(4) I have severe pain or discomfort',
            '(5) I have extreme pain or discomfort'
          ]},
          { id: 'eq5d_anxiety_dm', type: 'likert', label: '13. Anxiety/Depression *', required: true, showIf: { field: 'fill_eq5d_dm', value: 'yes' }, options: [
            '(1) I am not anxious or depressed',
            '(2) I am slightly anxious or depressed',
            '(3) I am moderately anxious or depressed',
            '(4) I am severely anxious or depressed',
            '(5) I am extremely anxious or depressed'
          ]},
          { id: 'eq5d_health_scale_dm', type: 'slider', label: '14. We would like to know how good or bad your health is TODAY. 0 means the worst health you can imagine. 10 means the best health you can imagine. *', required: true, showIf: { field: 'fill_eq5d_dm', value: 'yes' }, min: 0, max: 10 }
        ]
      },
      {
        title: 'Section 3 - COMPASS 31',
        questions: [
          { id: 'fill_compass31_dm', type: 'radio', label: '15. Do you want to fill in COMPASS-31 questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'compass31_dm_q16', type: 'radio', label: '16. In the past year, have you ever felt faint, dizzy, "goofy", or had difficulty thinking soon after standing up from a sitting or lying position? *', required: true, showIf: { field: 'fill_compass31_dm', value: 'yes' }, options: [
            { value: '1', label: '(1) Yes' },
            { value: '2', label: '(2) No' }
          ]},
          { id: 'compass31_dm_q17', type: 'likert', label: '17. When standing up, how frequently do you get these feelings or symptoms? *', required: true, showIf: { field: 'compass31_dm_q16', value: '1' }, options: [
            '(1) Rarely',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Almost Always'
          ]},
          { id: 'compass31_dm_q18', type: 'likert', label: '18. How would you rate the severity of these feelings or symptoms? *', required: true, showIf: { field: 'compass31_dm_q16', value: '1' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_dm_q19', type: 'likert', label: '19. In the past year, have these feelings or symptoms that you have experienced: *', required: true, showIf: { field: 'compass31_dm_q16', value: '1' }, options: [
            '(1) Gotten much worse',
            '(2) Gotten somewhat worse',
            '(3) Stayed about the same',
            '(4) Gotten somewhat better',
            '(5) Gotten much better Completely gone'
          ]},
          { id: 'compass31_dm_q20', type: 'radio', label: '20. In the past year, have you ever noticed color changes in your skin, such as red, white, or purple? *', required: true, showIf: { field: 'fill_compass31_dm', value: 'yes' }, options: [
            { value: '1', label: '(1) Yes' },
            { value: '2', label: '(2) No' }
          ]},
          { id: 'compass31_dm_q21', type: 'checkbox', label: '21. What parts of your body are affected by these color changes? (Check all that apply) *', required: true, showIf: { field: 'compass31_dm_q20', value: '1' }, options: [
            { value: 'hands', label: '(1) Hands' },
            { value: 'feet', label: '(2) Feet' }
          ]},
          { id: 'compass31_dm_q22', type: 'likert', label: '22. Are these changes in your skin color: *', required: true, showIf: { field: 'compass31_dm_q20', value: '1' }, options: [
            '(1) Getting much worse',
            '(2) Getting somewhat worse',
            '(3) Staying about the same',
            '(4) Getting somewhat better',
            '(5) Getting much better',
            '(6) Completely gone'
          ]},
          { id: 'compass31_dm_q23', type: 'likert', label: '23. In the past 5 years, what changes, if any, have occurred in your general body sweating? *', required: true, showIf: { field: 'fill_compass31_dm', value: 'yes' }, options: [
            '(1) I sweat much more than I used to',
            '(2) I sweat somewhat more than I used to',
            '(3) I haven\'t noticed any changes in my sweating',
            '(4) I sweat somewhat less than I used to',
            '(5) I sweat much less than I used to'
          ]},
          { id: 'compass31_dm_q24', type: 'radio', label: '24. Do your eyes feel excessively dry? *', required: true, showIf: { field: 'fill_compass31_dm', value: 'yes' }, options: [
            { value: '1', label: '(1) Yes' },
            { value: '2', label: '(2) No' }
          ]},
          { id: 'compass31_dm_q25', type: 'radio', label: '25. Does your mouth feel excessively dry? *', required: true, showIf: { field: 'fill_compass31_dm', value: 'yes' }, options: [
            { value: '1', label: '(1) Yes' },
            { value: '2', label: '(2) No' }
          ]},
          { id: 'compass31_dm_q26', type: 'likert', label: '26. For the symptom of dry eyes or dry mouth that you have had for the longest period of time, is this symptom: *', required: true, showIf: { field: 'fill_compass31_dm', value: 'yes' }, options: [
            '(1) I have not had any of these symptoms',
            '(2) Getting much worse',
            '(3) Getting somewhat worse',
            '(4) Staying about the same',
            '(5) Getting somewhat better',
            '(6) Getting much better',
            '(7) Completely gone'
          ]},
          { id: 'compass31_dm_q27', type: 'likert', label: '27. In the past year, have you noticed any changes in how quickly you get full when eating a meal? *', required: true, showIf: { field: 'fill_compass31_dm', value: 'yes' }, options: [
            '(1) I get full a lot more quickly now than I used to',
            '(2) I get full more quickly now than I used to',
            '(3) I haven\'t noticed any change',
            '(4) I get full less quickly now than I used to',
            '(5) I get full a lot less quickly now than I used to'
          ]},
          { id: 'compass31_dm_q28', type: 'likert', label: '28. In the past year, have you felt excessively full or persistently full (bloated feeling) after a meal? *', required: true, showIf: { field: 'fill_compass31_dm', value: 'yes' }, options: [
            '(1) Never',
            '(2) Sometimes',
            '(3) A lot of times'
          ]},
          { id: 'compass31_dm_q29', type: 'likert', label: '29. In the past year, have you vomited after a meal? *', required: true, showIf: { field: 'fill_compass31_dm', value: 'yes' }, options: [
            '(1) Never',
            '(2) Sometimes',
            '(3) A lot of time'
          ]},
          { id: 'compass31_dm_q30', type: 'likert', label: '30. In the past year, have you had a cramping or colicky abdominal pain? *', required: true, showIf: { field: 'fill_compass31_dm', value: 'yes' }, options: [
            '(1) Never',
            '(2) Sometimes',
            '(3) A lot of times'
          ]},
          { id: 'compass31_dm_q31', type: 'radio', label: '31. In the past year, have you had any bouts of diarrhea? *', required: true, showIf: { field: 'fill_compass31_dm', value: 'yes' }, options: [
            { value: '1', label: '(1) Yes' },
            { value: '2', label: '(2) No' }
          ]},
          { id: 'compass31_dm_q32', type: 'likert', label: '32. How frequently does this occur? *', required: true, showIf: { field: 'compass31_dm_q31', value: '1' }, options: [
            '(1) Rarely',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_dm_q33', type: 'likert', label: '33. How severe are these bouts of diarrhea? *', required: true, showIf: { field: 'compass31_dm_q31', value: '1' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_dm_q34', type: 'likert', label: '34. Are your bouts of diarrhea getting: *', required: true, showIf: { field: 'compass31_dm_q31', value: '1' }, options: [
            '(1) Much worse',
            '(2) Somewhat worse',
            '(3) Staying the same',
            '(4) Much better',
            '(5) Completely gone'
          ]},
          { id: 'compass31_dm_q35', type: 'radio', label: '35. In the past year, have you been constipated? *', required: true, showIf: { field: 'fill_compass31_dm', value: 'yes' }, options: [
            { value: '1', label: '(1) Yes' },
            { value: '2', label: '(2) No' }
          ]},
          { id: 'compass31_dm_q36', type: 'likert', label: '36. How frequently are you constipated? *', required: true, showIf: { field: 'compass31_dm_q35', value: '1' }, options: [
            '(1) Rarely',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_dm_q37', type: 'likert', label: '37. How severe are these episodes of constipation? *', required: true, showIf: { field: 'compass31_dm_q35', value: '1' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_dm_q38', type: 'likert', label: '38. Is your constipation getting: *', required: true, showIf: { field: 'compass31_dm_q35', value: '1' }, options: [
            '(1) Much worse',
            '(2) Somewhat worse',
            '(3) Staying the same',
            '(4) Somewhat better',
            '(5) Much better',
            '(6) Completely gone'
          ]},
          { id: 'compass31_dm_q39', type: 'likert', label: '39. In the past year, have you ever lost control of your bladder function? *', required: true, showIf: { field: 'fill_compass31_dm', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_dm_q40', type: 'likert', label: '40. In the past year, have you had difficulty passing urine? *', required: true, showIf: { field: 'fill_compass31_dm', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_dm_q41', type: 'likert', label: '41. In the past year, have you had trouble completely emptying your bladder? *', required: true, showIf: { field: 'fill_compass31_dm', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_dm_q42', type: 'likert', label: '42. In the past year, without sunglasses or tinted glasses, has bright light bothered your eyes? *', required: true, showIf: { field: 'fill_compass31_dm', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_dm_q43', type: 'likert', label: '43. How severe is this sensitivity to bright light? *', required: true, showIf: { field: 'compass31_dm_q42', value: '(2) Occasionally' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_dm_q43b', type: 'likert', label: '43. How severe is this sensitivity to bright light? *', required: true, showIf: { field: 'compass31_dm_q42', value: '(3) Frequently' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_dm_q43c', type: 'likert', label: '43. How severe is this sensitivity to bright light? *', required: true, showIf: { field: 'compass31_dm_q42', value: '(4) Constantly' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_dm_q44', type: 'likert', label: '44. In the past year, have you had trouble focusing your eyes? *', required: true, showIf: { field: 'fill_compass31_dm', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_dm_q45', type: 'likert', label: '45. How severe is this focusing problem? *', required: true, showIf: { field: 'compass31_dm_q44', value: '(2) Occasionally' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_dm_q45b', type: 'likert', label: '45. How severe is this focusing problem? *', required: true, showIf: { field: 'compass31_dm_q44', value: '(3) Frequently' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_dm_q45c', type: 'likert', label: '45. How severe is this focusing problem? *', required: true, showIf: { field: 'compass31_dm_q44', value: '(4) Constantly' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_dm_q46', type: 'likert', label: '46. Is the most troublesome symptom with your eyes (i.e. sensitivity to bright light or trouble focusing) getting: *', required: true, showIf: { field: 'fill_compass31_dm', value: 'yes' }, options: [
            '(1) I have not had any of these symptoms',
            '(2) Much worse',
            '(3) Somewhat worse',
            '(4) Staying about the same',
            '(5) Somewhat better',
            '(6) Much better',
            '(7) Completely gone'
          ]}
        ]
      },
      {
        title: 'Section 4 - AMTS - Abbreviated Mental Test Score',
        questions: [
          { id: 'fill_amts_dm', type: 'radio', label: '47. Do you want to fill in AMTS questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'amts_dm_q1', type: 'radio', label: '48. What is your Age? *', required: true, showIf: { field: 'fill_amts_dm', value: 'yes' }, options: [
            { value: '0', label: '(0) Not correct' },
            { value: '1', label: '(1) Correct' }
          ]},
          { id: 'amts_dm_q2', type: 'radio', label: '49. What is the time to the nearest hour? *', required: true, showIf: { field: 'fill_amts_dm', value: 'yes' }, options: [
            { value: '0', label: '(0) Not correct' },
            { value: '1', label: '(1) Correct' }
          ]},
          { id: 'amts_dm_q3', type: 'radio', label: '50. Give the patient an address, and ask him or her to repeat it at the end of the test (e.g. 42 West Street) *', required: true, showIf: { field: 'fill_amts_dm', value: 'yes' }, options: [
            { value: '0', label: '(0) Not correct' },
            { value: '1', label: '(1) Correct' }
          ]},
          { id: 'amts_dm_q4', type: 'radio', label: '51. What is the year? *', required: true, showIf: { field: 'fill_amts_dm', value: 'yes' }, options: [
            { value: '0', label: '(0) Not correct' },
            { value: '1', label: '(1) Correct' }
          ]},
          { id: 'amts_dm_q5', type: 'radio', label: '52. What is the name of the hospital or number of the residence where the patient is situated? *', required: true, showIf: { field: 'fill_amts_dm', value: 'yes' }, options: [
            { value: '0', label: '(0) Not correct' },
            { value: '1', label: '(1) Correct' }
          ]},
          { id: 'amts_dm_q6', type: 'radio', label: '53. Can the patient recognize two persons (the doctor, nurse, home help, etc.)? *', required: true, showIf: { field: 'fill_amts_dm', value: 'yes' }, options: [
            { value: '0', label: '(0) Not correct' },
            { value: '1', label: '(1) Correct' }
          ]},
          { id: 'amts_dm_q7', type: 'radio', label: '54. What is your date of birth? (day and month sufficient) *', required: true, showIf: { field: 'fill_amts_dm', value: 'yes' }, options: [
            { value: '0', label: '(0) Not correct' },
            { value: '1', label: '(1) Correct' }
          ]},
          { id: 'amts_dm_q8', type: 'radio', label: '55. In what year did World War 1 begin? *', required: true, showIf: { field: 'fill_amts_dm', value: 'yes' }, options: [
            { value: '0', label: '(0) Not correct' },
            { value: '1', label: '(1) Correct' }
          ]},
          { id: 'amts_dm_q9', type: 'radio', label: '56. Name the present monarch/prime minister/president. *', required: true, showIf: { field: 'fill_amts_dm', value: 'yes' }, options: [
            { value: '0', label: '(0) Not correct' },
            { value: '1', label: '(1) Correct' }
          ]},
          { id: 'amts_dm_q10', type: 'radio', label: '57. Count backwards from 20 down to 1 *', required: true, showIf: { field: 'fill_amts_dm', value: 'yes' }, options: [
            { value: '0', label: '(0) Not correct' },
            { value: '1', label: '(1) Correct' }
          ]}
        ]
      },
      {
        title: 'Section 5 - MoCA - Montreal Cognitive Assessment',
        questions: [
          { id: 'fill_moca_dm', type: 'radio', label: '58. Do you want to fill in MOCA questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'moca_dm_score', type: 'number', label: '59. Calculated sum of all subscores from MoCA test: *', required: true, showIf: { field: 'fill_moca_dm', value: 'yes' } }
        ]
      },
      {
        title: 'Section 6 - DSRS - Dementia Severity Rating Scale',
        questions: [
          { id: 'fill_dsrs_dm', type: 'radio', label: '60. Do you want to fill in DSRS questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'dsrs_dm_q1', type: 'likert', label: '61. MEMORY *', required: true, showIf: { field: 'fill_dsrs_dm', value: 'yes' }, options: [
            '(0) Normal memory',
            '(1) Occasionally forgets things that they were told recently. Does not cause many problems',
            '(2) Mild consistent forgetfulness. Remembers recent events but often forgets parts',
            '(3) Moderate memory loss. Worse for recent events. May not remember something you just told them. Causes problems with everyday activities',
            '(4) Substantial memory loss. Quickly forgets recent or newly-learned things. Can only remember things that they have known for a long time',
            '(5) Does not remember basic facts like the day of the week, when last meal was eaten or what the next meal will be',
            '(6) Does not remember even the most basic things'
          ]},
          { id: 'dsrs_dm_q2', type: 'likert', label: '62. SPEECH AND LANGUAGE *', required: true, showIf: { field: 'fill_dsrs_dm', value: 'yes' }, options: [
            '(0) Normal ability to talk and to understand other',
            '(1) Sometimes cannot find a word, but able to carry on conversations',
            '(2) Often forgets words. May use the wrong word in its place. Some trouble expressing thoughts and giving answers',
            '(3) Usually answers questions using sentences but rarely starts a conversation',
            '(4) Answers questions, but responses are often hard to understand or don\'t make sense. Usually able to follow simple instructions',
            '(5) Speech often does not make sense. Can not answer questions or follow instructions',
            '(6) Does not respond most of the time'
          ]},
          { id: 'dsrs_dm_q3', type: 'likert', label: '63. RECOGNITION OF FAMILY MEMBERS *', required: true, showIf: { field: 'fill_dsrs_dm', value: 'yes' }, options: [
            '(0) Normal - recognizes people and generally knows who they are',
            '(1) Usually does not recognize family members who are not seen frequently but may not recall how they are related',
            '(2) Usually does not recognize family members who are not seen frequently. Is often confused about how family members such as grandchildren, nieces, or nephews are related to them',
            '(3) Sometimes does not recognize close family members or others who they see frequently. May not recognize their children, brothers, or sisters who are not seen on a regular basis',
            '(4) Frequently does not recognize spouse or caregiver',
            '(5) No recognition or awareness of the presence of others'
          ]},
          { id: 'dsrs_dm_q4', type: 'likert', label: '64. ORIENTATION TO TIME *', required: true, showIf: { field: 'fill_dsrs_dm', value: 'yes' }, options: [
            '(0) Normal awareness of time of day and day of week',
            '(1) Some confusion about what time it is or what day of the week, but not severe enough to interfere with everyday activities',
            '(2) Frequently confused about time of day',
            '(3) Almost always confused about the time of day',
            '(4) Seems completely unaware of time'
          ]},
          { id: 'dsrs_dm_q5', type: 'likert', label: '65. ORIENTATION TO PLACE *', required: true, showIf: { field: 'fill_dsrs_dm', value: 'yes' }, options: [
            '(0) Normal awareness of where they are even in new places',
            '(1) Sometimes disoriented in new places',
            '(2) Frequently disoriented in new places',
            '(3) Usually disoriented, even in familiar places. May forget that they are already at home',
            '(4) Almost always confused about place'
          ]},
          { id: 'dsrs_dm_q6', type: 'likert', label: '66. ABILITY TO MAKE DECISIONS *', required: true, showIf: { field: 'fill_dsrs_dm', value: 'yes' }, options: [
            '(0) Normal - as able to make decisions as before',
            '(1) Only some difficulty making decisions that arise in day-to-day life',
            '(2) Moderate difficulty. Gets confused when things get complicated or plans change',
            '(3) Rarely makes any important decisions. Gets confused easily',
            '(4) Not able to understand what is happening most of the time'
          ]},
          { id: 'dsrs_dm_q7', type: 'likert', label: '67. SOCIAL AND COMMUNITY ACTIVITY *', required: true, showIf: { field: 'fill_dsrs_dm', value: 'yes' }, options: [
            '(0) Normal - acts the same with people as before',
            '(1) Only mild problems that are not really important, but clearly acts differently from previous years',
            '(2) Can still take part in community activities without help. May appear normal to people who don\'t know them',
            '(3) Often has trouble dealing with people outside the home without help from caregiver. Usually can participate in quiet home activities with friends. The problem is clear to anyone who sees them',
            '(4) No longer takes part in any real way in activities at home involving other people. Can only deal with the primary caregiver',
            '(5) Little or no response even to primary caregiver'
          ]},
          { id: 'dsrs_dm_q8', type: 'likert', label: '68. HOME ACTIVITIES AND RESPONSIBILITIES *', required: true, showIf: { field: 'fill_dsrs_dm', value: 'yes' }, options: [
            '(0) Normal. No decline in ability to do things around the house',
            '(1) Some problems with home activities. May have more trouble with money management (paying bills) and fixing things. Can still go to a store, cook or clean. Still watches TV or reads a newspaper with interest and understanding',
            '(2) Makes mistakes with easy tasks like going to a store, cooking or cleaning. Losing interest in the newspaper, TV or radio. Often can\'t follow a long conversation on a single topic',
            '(3) Not able to shop, cook or clean without a lot of help. Does not understand the newspaper or the TV. Cannot follow a conversation',
            '(4) No longer does any home-based activities'
          ]},
          { id: 'dsrs_dm_q9', type: 'likert', label: '69. PERSONAL CARE - CLEANLINESS *', required: true, showIf: { field: 'fill_dsrs_dm', value: 'yes' }, options: [
            '(0) Normal. Takes care of self as well as they used to',
            '(1) Sometimes forgets to wash, shave, comb hair, or may dress in wrong type of clothes. Not as neat as they used to be',
            '(2) Requires help with dressing, washing and personal grooming',
            '(3) Totally dependent on help for personal care'
          ]},
          { id: 'dsrs_dm_q10', type: 'likert', label: '70. EATING *', required: true, showIf: { field: 'fill_dsrs_dm', value: 'yes' }, options: [
            '(0) Normal, does not need help in eating food that is served to them',
            '(1) May need help cutting food or have trouble with some foods, but basically able to eat by themselves',
            '(2) Generally able to feed themselves but may require some help. May lose interest during the meal',
            '(3) Needs to be fed. May have trouble swallowing'
          ]},
          { id: 'dsrs_dm_q11', type: 'likert', label: '71. CONTROL OF URINATION AND BOWELS *', required: true, showIf: { field: 'fill_dsrs_dm', value: 'yes' }, options: [
            '(0) Normal - does not have problems controlling urination or bowels except for physical problems',
            '(1) Rarely fails to control urination (generally less than one accident per month)',
            '(2) Occasional failure to control urination (about once a week or less)',
            '(3) Frequently fails to control urination (more than once a week)',
            '(4) Generally fails to control urination and frequently can not control bowels'
          ]},
          { id: 'dsrs_dm_q12', type: 'likert', label: '72. ABILITY TO GET FROM PLACE TO PLACE *', required: true, showIf: { field: 'fill_dsrs_dm', value: 'yes' }, options: [
            '(0) Normal, able to get around on their own. (May have physical problems that require a cane walker)',
            '(1) Sometimes gets confused when driving or taking public transportation, especially in new places. Able to walk places alone',
            '(2) Cannot drive or take public transportation alone, even in familiar places. Can walk alone outside for short distances. Might get lost if walking too far from home',
            '(3) Cannot be left outside alone. Can get around the house without getting lost or confused',
            '(4) Gets confused and needs help finding their way around the house',
            '(5) Almost always in a bed or chair. May be able to walk a few steps with help, but lacks sense of direction',
            '(6) Always in bed. Unable to sit or stand'
          ]}
        ]
      },
      {
        title: 'Section 7 - GDS - Global Deterioration Scale',
        questions: [
          { id: 'fill_gds_dm', type: 'radio', label: '73. Do you want to fill in GDS questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'gds_dm_q1', type: 'likert', label: '74. Choose the most appropriate global stage based upon cognition and function: *', required: true, showIf: { field: 'fill_gds_dm', value: 'yes' }, options: [
            '(1) Stage 1: Subjectively and objectively normal',
            '(2) Stage 2: Subjective complaints of memory deficit',
            '(3) Stage 3: Mild cognitive impairment',
            '(4) Stage 4: Early dementia',
            '(5) Stage 5: Moderate dementia',
            '(6) Stage 6: Moderately severe dementia',
            '(7) Stage 7: Severe dementia'
          ]}
        ]
      },
      {
        title: 'Section 8 - IADL - Lawton Instrumental Activities of Daily Living Scale',
        questions: [
          { id: 'fill_iadl_dm', type: 'radio', label: '75. Do you want to fill in IADL questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'iadl_dm_q1', type: 'likert', label: '76. Ability to Use Telephone *', required: true, showIf: { field: 'fill_iadl_dm', value: 'yes' }, options: [
            '(1) Operates telephone on own initiative; looks up and dials numbers',
            '(1) Dials a few well-known numbers',
            '(1) Answers telephone, but does not dial',
            '(0) Does not use telephone at all'
          ]},
          { id: 'iadl_dm_q2', type: 'likert', label: '77. Shopping *', required: true, showIf: { field: 'fill_iadl_dm', value: 'yes' }, options: [
            '(1) Takes care of all shopping needs independently',
            '(0) Shops independently for small purchases',
            '(0) Needs to be accompanied on any shopping trip',
            '(0) Completely unable to shop'
          ]},
          { id: 'iadl_dm_q3', type: 'likert', label: '78. Food Preparation *', required: true, showIf: { field: 'fill_iadl_dm', value: 'yes' }, options: [
            '(1) Plans, prepares, and serves adequate meals independently',
            '(0) Prepares adequate meals if supplied with ingredients',
            '(0) Heats and serves prepared meals or prepares meals but does not maintain adequate diet',
            '(0) Needs to have meals prepared and served'
          ]},
          { id: 'iadl_dm_q4', type: 'likert', label: '79. Housekeeping *', required: true, showIf: { field: 'fill_iadl_dm', value: 'yes' }, options: [
            '(1) Maintains house alone with occasion assistance (heavy work)',
            '(1) Performs light daily tasks such as dishwashing, bed making',
            '(1) Performs light daily tasks, but cannot maintain acceptable level of cleanliness',
            '(1) Needs help with all home maintenance tasks',
            '(0) Does not participate in any housekeeping tasks'
          ]},
          { id: 'iadl_dm_q5', type: 'likert', label: '80. Laundry *', required: true, showIf: { field: 'fill_iadl_dm', value: 'yes' }, options: [
            '(1) Does personal laundry completely',
            '(1) Launders small items, rinses socks, stockings, etc.',
            '(0) All laundry must be done by others'
          ]},
          { id: 'iadl_dm_q6', type: 'likert', label: '81. Mode of Transportation *', required: true, showIf: { field: 'fill_iadl_dm', value: 'yes' }, options: [
            '(1) Travels independently on public transportation or drives own car',
            '(1) Arranges own travel via taxi, but does not otherwise use public transportation',
            '(1) Travels on public transportation when assisted or accompanied by another',
            '(0) Travel limited to taxi or automobile with assistance of another',
            '(0) Does not travel at all'
          ]},
          { id: 'iadl_dm_q7', type: 'likert', label: '82. Responsibility for Own Medications *', required: true, showIf: { field: 'fill_iadl_dm', value: 'yes' }, options: [
            '(1) Is responsible for taking medication in correct dosages at correct time',
            '(0) Takes responsibility if medication is prepared in advance in separate dosages',
            '(0) Is not capable of dispensing own medication'
          ]},
          { id: 'iadl_dm_q8', type: 'likert', label: '83. Ability to Handle Finances *', required: true, showIf: { field: 'fill_iadl_dm', value: 'yes' }, options: [
            '(1) Manages financial matters independently (budgets, writes checks, pays rent and bills, goes to bank); collects and keeps track of income',
            '(1) Manages day-to-day purchases, but needs help with banking, major purchases, etc.',
            '(0) Incapable of handling money'
          ]}
        ]
      },
      {
        title: 'Section 9 - DASS 21',
        questions: [
          { id: 'fill_dass21_dm', type: 'radio', label: '84. Do you want to fill in DASS-21 questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'dass21_dm_q1', type: 'likert', label: '85. (S) I found it hard to wind down. *', required: true, showIf: { field: 'fill_dass21_dm', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_dm_q2', type: 'likert', label: '86. (A) I was aware of dryness of my mouth. *', required: true, showIf: { field: 'fill_dass21_dm', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_dm_q3', type: 'likert', label: '87. (D) I couldn\'t seem to experience any positive feeling at all. *', required: true, showIf: { field: 'fill_dass21_dm', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_dm_q4', type: 'likert', label: '88. (A) I experienced breathing difficulty (e.g. excessively rapid breathing, breathlessness in the absence of physical exertion). *', required: true, showIf: { field: 'fill_dass21_dm', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_dm_q5', type: 'likert', label: '89. (D) I found it difficult to work up the initiative to do things. *', required: true, showIf: { field: 'fill_dass21_dm', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_dm_q6', type: 'likert', label: '90. (S) I tended to over-react to situations. *', required: true, showIf: { field: 'fill_dass21_dm', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_dm_q7', type: 'likert', label: '91. (A) I experienced trembling (e.g. in the hands). *', required: true, showIf: { field: 'fill_dass21_dm', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_dm_q8', type: 'likert', label: '92. (S) I felt that I was using a lot of nervous energy. *', required: true, showIf: { field: 'fill_dass21_dm', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_dm_q9', type: 'likert', label: '93. (A) I was worried about situations in which I might panic and make a fool of myself. *', required: true, showIf: { field: 'fill_dass21_dm', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_dm_q10', type: 'likert', label: '94. (D) I felt that I had nothing to look forward to. *', required: true, showIf: { field: 'fill_dass21_dm', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_dm_q11', type: 'likert', label: '95. (S) I found myself getting agitated. *', required: true, showIf: { field: 'fill_dass21_dm', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_dm_q12', type: 'likert', label: '96. (S) I found it difficult to relax. *', required: true, showIf: { field: 'fill_dass21_dm', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_dm_q13', type: 'likert', label: '97. (D) I felt down-hearted and blue. *', required: true, showIf: { field: 'fill_dass21_dm', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_dm_q14', type: 'likert', label: '98. (S) I was intolerant of anything that kept me from getting on with what I was doing. *', required: true, showIf: { field: 'fill_dass21_dm', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_dm_q15', type: 'likert', label: '99. (A) I felt I was close to panic. *', required: true, showIf: { field: 'fill_dass21_dm', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_dm_q16', type: 'likert', label: '100. (D) I was unable to become enthusiastic about anything. *', required: true, showIf: { field: 'fill_dass21_dm', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_dm_q17', type: 'likert', label: '101. (D) I felt I wasn\'t worth much as a person. *', required: true, showIf: { field: 'fill_dass21_dm', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_dm_q18', type: 'likert', label: '102. (S) I felt that I was rather touchy. *', required: true, showIf: { field: 'fill_dass21_dm', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_dm_q19', type: 'likert', label: '103. (A) I was aware of the action of my heart in the absence of physical exertion (e.g. sense of heart rate increase, heart missing a beat). *', required: true, showIf: { field: 'fill_dass21_dm', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_dm_q20', type: 'likert', label: '104. (A) I felt scared without any good reason. *', required: true, showIf: { field: 'fill_dass21_dm', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_dm_q21', type: 'likert', label: '105. (D) I felt that life was meaningless. *', required: true, showIf: { field: 'fill_dass21_dm', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]}
        ]
      }
    ]
  },
  chronic_pain: {
    title: 'Chronic Pain Assessment',
    sections: [
      {
        title: 'Section 1 - General Data',
        questions: [
          { id: 'assessment_date_cp', type: 'date', label: '1. Date of assessment *', required: true },
          { id: 'doctor_email_cp', type: 'email', label: '2. Doctor Email *', required: true },
          { id: 'patient_name_cp', type: 'text', label: '3. Patient Name and Surname *', required: true },
          { id: 'patient_id_cp', type: 'text', label: '4. Patient ID *', required: true },
          { id: 'patient_age_cp', type: 'radio', label: '5. Patient Age *', required: true, options: [
            { value: '<18', label: '< 18' },
            { value: '18-25', label: '18-25' },
            { value: '26-35', label: '26-35' },
            { value: '36-45', label: '36-45' },
            { value: '46-55', label: '46-55' },
            { value: '56-65', label: '56-65' },
            { value: '>65', label: '> 65' }
          ]},
          { id: 'gender_cp', type: 'radio', label: '6. Gender *', required: true, options: [
            { value: 'male', label: 'Male' },
            { value: 'female', label: 'Female' },
            { value: 'non-binary', label: 'Non-binary' }
          ]},
          { id: 'visit_type_cp', type: 'radio', label: '7. Please choose one of the following options *', required: true, options: [
            { value: 'first', label: 'First visit' },
            { value: 'followup1', label: 'Follow-up visit 1' },
            { value: 'followup2', label: 'Follow-up visit 2' },
            { value: 'followup3', label: 'Follow-up visit 3' }
          ]}
        ]
      },
      {
        title: 'Section 2 - EQ-5D-5L Health Questionnaire',
        questions: [
          { id: 'fill_eq5d_cp', type: 'radio', label: '8. Do you want to fill in EQ-5D-5L questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'eq5d_mobility_cp', type: 'likert', label: '9. Mobility *', required: true, showIf: { field: 'fill_eq5d_cp', value: 'yes' }, options: [
            '(1) I have no problems in walking about',
            '(2) I have slight problems in walking about',
            '(3) I have moderate problems in walking about',
            '(4) I have severe problems in walking about',
            '(5) I am unable to walk about'
          ]},
          { id: 'eq5d_selfcare_cp', type: 'likert', label: '10. Self Care *', required: true, showIf: { field: 'fill_eq5d_cp', value: 'yes' }, options: [
            '(1) I have no problems washing or dressing myself',
            '(2) I have slight problems washing or dressing myself',
            '(3) I have moderate problems washing or dressing myself',
            '(4) I have severe problems washing or dressing myself',
            '(5) I am unable to wash or dress myself'
          ]},
          { id: 'eq5d_activities_cp', type: 'likert', label: '11. Usual activities (e.g. work, study, housework, family or leisure activities) *', required: true, showIf: { field: 'fill_eq5d_cp', value: 'yes' }, options: [
            '(1) I have no problems doing my usual activities',
            '(2) I have slight problems doing my usual activities',
            '(3) I have moderate problems doing my usual activities',
            '(4) I have severe problems doing my usual activities',
            '(5) I am unable to do my usual activities'
          ]},
          { id: 'eq5d_pain_cp', type: 'likert', label: '12. Pain/Discomfort *', required: true, showIf: { field: 'fill_eq5d_cp', value: 'yes' }, options: [
            '(1) I have no pain or discomfort',
            '(2) I have slight pain or discomfort',
            '(3) I have moderate pain or discomfort',
            '(4) I have severe pain or discomfort',
            '(5) I have extreme pain or discomfort'
          ]},
          { id: 'eq5d_anxiety_cp', type: 'likert', label: '13. Anxiety/Depression *', required: true, showIf: { field: 'fill_eq5d_cp', value: 'yes' }, options: [
            '(1) I am not anxious or depressed',
            '(2) I am slightly anxious or depressed',
            '(3) I am moderately anxious or depressed',
            '(4) I am severely anxious or depressed',
            '(5) I am extremely anxious or depressed'
          ]},
          { id: 'eq5d_health_scale_cp', type: 'slider', label: '14. We would like to know how good or bad your health is TODAY. 0 means the worst health you can imagine. 10 means the best health you can imagine. *', required: true, showIf: { field: 'fill_eq5d_cp', value: 'yes' }, min: 0, max: 10 }
        ]
      },
      {
        title: 'Section 3 - COMPASS 31',
        questions: [
          { id: 'fill_compass31_cp', type: 'radio', label: '15. Do you want to fill in COMPASS-31 questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'compass31_cp_q16', type: 'radio', label: '16. In the past year, have you ever felt faint, dizzy, "goofy", or had difficulty thinking soon after standing up from a sitting or lying position? *', required: true, showIf: { field: 'fill_compass31_cp', value: 'yes' }, options: [
            { value: '1', label: '(1) Yes' },
            { value: '2', label: '(2) No' }
          ]},
          { id: 'compass31_cp_q17', type: 'likert', label: '17. When standing up, how frequently do you get these feelings or symptoms? *', required: true, showIf: { field: 'compass31_cp_q16', value: '1' }, options: [
            '(1) Rarely',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Almost Always'
          ]},
          { id: 'compass31_cp_q18', type: 'likert', label: '18. How would you rate the severity of these feelings or symptoms? *', required: true, showIf: { field: 'compass31_cp_q16', value: '1' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_cp_q19', type: 'likert', label: '19. In the past year, have these feelings or symptoms that you have experienced: *', required: true, showIf: { field: 'compass31_cp_q16', value: '1' }, options: [
            '(1) Gotten much worse',
            '(2) Gotten somewhat worse',
            '(3) Stayed about the same',
            '(4) Gotten somewhat better',
            '(5) Gotten much better Completely gone'
          ]},
          { id: 'compass31_cp_q20', type: 'radio', label: '20. In the past year, have you ever noticed color changes in your skin, such as red, white, or purple? *', required: true, showIf: { field: 'fill_compass31_cp', value: 'yes' }, options: [
            { value: '1', label: '(1) Yes' },
            { value: '2', label: '(2) No' }
          ]},
          { id: 'compass31_cp_q21', type: 'checkbox', label: '21. What parts of your body are affected by these color changes? (Check all that apply) *', required: true, showIf: { field: 'compass31_cp_q20', value: '1' }, options: [
            { value: 'hands', label: '(1) Hands' },
            { value: 'feet', label: '(2) Feet' }
          ]},
          { id: 'compass31_cp_q22', type: 'likert', label: '22. Are these changes in your skin color: *', required: true, showIf: { field: 'compass31_cp_q20', value: '1' }, options: [
            '(1) Getting much worse',
            '(2) Getting somewhat worse',
            '(3) Staying about the same',
            '(4) Getting somewhat better',
            '(5) Getting much better',
            '(6) Completely gone'
          ]},
          { id: 'compass31_cp_q23', type: 'likert', label: '23. In the past 5 years, what changes, if any, have occurred in your general body sweating? *', required: true, showIf: { field: 'fill_compass31_cp', value: 'yes' }, options: [
            '(1) I sweat much more than I used to',
            '(2) I sweat somewhat more than I used to',
            '(3) I haven\'t noticed any changes in my sweating',
            '(4) I sweat somewhat less than I used to',
            '(5) I sweat much less than I used to'
          ]},
          { id: 'compass31_cp_q24', type: 'radio', label: '24. Do your eyes feel excessively dry? *', required: true, showIf: { field: 'fill_compass31_cp', value: 'yes' }, options: [
            { value: '1', label: '(1) Yes' },
            { value: '2', label: '(2) No' }
          ]},
          { id: 'compass31_cp_q25', type: 'radio', label: '25. Does your mouth feel excessively dry? *', required: true, showIf: { field: 'fill_compass31_cp', value: 'yes' }, options: [
            { value: '1', label: '(1) Yes' },
            { value: '2', label: '(2) No' }
          ]},
          { id: 'compass31_cp_q26', type: 'likert', label: '26. For the symptom of dry eyes or dry mouth that you have had for the longest period of time, is this symptom: *', required: true, showIf: { field: 'fill_compass31_cp', value: 'yes' }, options: [
            '(1) I have not had any of these symptoms',
            '(2) Getting much worse',
            '(3) Getting somewhat worse',
            '(4) Staying about the same',
            '(5) Getting somewhat better',
            '(6) Getting much better',
            '(7) Completely gone'
          ]},
          { id: 'compass31_cp_q27', type: 'likert', label: '27. In the past year, have you noticed any changes in how quickly you get full when eating a meal? *', required: true, showIf: { field: 'fill_compass31_cp', value: 'yes' }, options: [
            '(1) I get full a lot more quickly now than I used to',
            '(2) I get full more quickly now than I used to',
            '(3) I haven\'t noticed any change',
            '(4) I get full less quickly now than I used to',
            '(5) I get full a lot less quickly now than I used to'
          ]},
          { id: 'compass31_cp_q28', type: 'likert', label: '28. In the past year, have you felt excessively full or persistently full (bloated feeling) after a meal? *', required: true, showIf: { field: 'fill_compass31_cp', value: 'yes' }, options: [
            '(1) Never',
            '(2) Sometimes',
            '(3) A lot of times'
          ]},
          { id: 'compass31_cp_q29', type: 'likert', label: '29. In the past year, have you vomited after a meal? *', required: true, showIf: { field: 'fill_compass31_cp', value: 'yes' }, options: [
            '(1) Never',
            '(2) Sometimes',
            '(3) A lot of time'
          ]},
          { id: 'compass31_cp_q30', type: 'likert', label: '30. In the past year, have you had a cramping or colicky abdominal pain? *', required: true, showIf: { field: 'fill_compass31_cp', value: 'yes' }, options: [
            '(1) Never',
            '(2) Sometimes',
            '(3) A lot of times'
          ]},
          { id: 'compass31_cp_q31', type: 'radio', label: '31. In the past year, have you had any bouts of diarrhea? *', required: true, showIf: { field: 'fill_compass31_cp', value: 'yes' }, options: [
            { value: '1', label: '(1) Yes' },
            { value: '2', label: '(2) No' }
          ]},
          { id: 'compass31_cp_q32', type: 'likert', label: '32. How frequently does this occur? *', required: true, showIf: { field: 'compass31_cp_q31', value: '1' }, options: [
            '(1) Rarely',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_cp_q33', type: 'likert', label: '33. How severe are these bouts of diarrhea? *', required: true, showIf: { field: 'compass31_cp_q31', value: '1' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_cp_q34', type: 'likert', label: '34. Are your bouts of diarrhea getting: *', required: true, showIf: { field: 'compass31_cp_q31', value: '1' }, options: [
            '(1) Much worse',
            '(2) Somewhat worse',
            '(3) Staying the same',
            '(4) Much better',
            '(5) Completely gone'
          ]},
          { id: 'compass31_cp_q35', type: 'radio', label: '35. In the past year, have you been constipated? *', required: true, showIf: { field: 'fill_compass31_cp', value: 'yes' }, options: [
            { value: '1', label: '(1) Yes' },
            { value: '2', label: '(2) No' }
          ]},
          { id: 'compass31_cp_q36', type: 'likert', label: '36. How frequently are you constipated? *', required: true, showIf: { field: 'compass31_cp_q35', value: '1' }, options: [
            '(1) Rarely',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_cp_q37', type: 'likert', label: '37. How severe are these episodes of constipation? *', required: true, showIf: { field: 'compass31_cp_q35', value: '1' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_cp_q38', type: 'likert', label: '38. Is your constipation getting: *', required: true, showIf: { field: 'compass31_cp_q35', value: '1' }, options: [
            '(1) Much worse',
            '(2) Somewhat worse',
            '(3) Staying the same',
            '(4) Somewhat better',
            '(5) Much better',
            '(6) Completely gone'
          ]},
          { id: 'compass31_cp_q39', type: 'likert', label: '39. In the past year, have you ever lost control of your bladder function? *', required: true, showIf: { field: 'fill_compass31_cp', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_cp_q40', type: 'likert', label: '40. In the past year, have you had difficulty passing urine? *', required: true, showIf: { field: 'fill_compass31_cp', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_cp_q41', type: 'likert', label: '41. In the past year, have you had trouble completely emptying your bladder? *', required: true, showIf: { field: 'fill_compass31_cp', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_cp_q42', type: 'likert', label: '42. In the past year, without sunglasses or tinted glasses, has bright light bothered your eyes? *', required: true, showIf: { field: 'fill_compass31_cp', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_cp_q43', type: 'likert', label: '43. How severe is this sensitivity to bright light? *', required: true, showIf: { field: 'compass31_cp_q42', value: '(2) Occasionally' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_cp_q43b', type: 'likert', label: '43. How severe is this sensitivity to bright light? *', required: true, showIf: { field: 'compass31_cp_q42', value: '(3) Frequently' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_cp_q43c', type: 'likert', label: '43. How severe is this sensitivity to bright light? *', required: true, showIf: { field: 'compass31_cp_q42', value: '(4) Constantly' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_cp_q44', type: 'likert', label: '44. In the past year, have you had trouble focusing your eyes? *', required: true, showIf: { field: 'fill_compass31_cp', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_cp_q45', type: 'likert', label: '45. How severe is this focusing problem? *', required: true, showIf: { field: 'compass31_cp_q44', value: '(2) Occasionally' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_cp_q45b', type: 'likert', label: '45. How severe is this focusing problem? *', required: true, showIf: { field: 'compass31_cp_q44', value: '(3) Frequently' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_cp_q45c', type: 'likert', label: '45. How severe is this focusing problem? *', required: true, showIf: { field: 'compass31_cp_q44', value: '(4) Constantly' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_cp_q46', type: 'likert', label: '46. Is the most troublesome symptom with your eyes (i.e. sensitivity to bright light or trouble focusing) getting: *', required: true, showIf: { field: 'fill_compass31_cp', value: 'yes' }, options: [
            '(1) I have not had any of these symptoms',
            '(2) Much worse',
            '(3) Somewhat worse',
            '(4) Staying about the same',
            '(5) Somewhat better',
            '(6) Much better',
            '(7) Completely gone'
          ]}
        ]
      },
      {
        title: 'Section 4 - DASS-21',
        questions: [
          { id: 'fill_dass21_cp', type: 'radio', label: '47. Do you want to fill in DASS-21 questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'dass21_cp_q1', type: 'likert', label: '48. (S) I found it hard to wind down. *', required: true, showIf: { field: 'fill_dass21_cp', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_cp_q2', type: 'likert', label: '49. (A) I was aware of dryness of my mouth. *', required: true, showIf: { field: 'fill_dass21_cp', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_cp_q3', type: 'likert', label: '50. (D) I couldn\'t seem to experience any positive feeling at all. *', required: true, showIf: { field: 'fill_dass21_cp', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_cp_q4', type: 'likert', label: '51. (A) I experienced breathing difficulty (e.g. excessively rapid breathing, breathlessness in the absence of physical exertion). *', required: true, showIf: { field: 'fill_dass21_cp', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_cp_q5', type: 'likert', label: '52. (D) I found it difficult to work up the initiative to do things. *', required: true, showIf: { field: 'fill_dass21_cp', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_cp_q6', type: 'likert', label: '53. (S) I tended to over-react to situations. *', required: true, showIf: { field: 'fill_dass21_cp', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_cp_q7', type: 'likert', label: '54. (A) I experienced trembling (e.g. in the hands). *', required: true, showIf: { field: 'fill_dass21_cp', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_cp_q8', type: 'likert', label: '55. (S) I felt that I was using a lot of nervous energy. *', required: true, showIf: { field: 'fill_dass21_cp', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_cp_q9', type: 'likert', label: '56. (A) I was worried about situations in which I might panic and make a fool of myself. *', required: true, showIf: { field: 'fill_dass21_cp', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_cp_q10', type: 'likert', label: '57. (D) I felt that I had nothing to look forward to. *', required: true, showIf: { field: 'fill_dass21_cp', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_cp_q11', type: 'likert', label: '58. (S) I found myself getting agitated. *', required: true, showIf: { field: 'fill_dass21_cp', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_cp_q12', type: 'likert', label: '59. (S) I found it difficult to relax. *', required: true, showIf: { field: 'fill_dass21_cp', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_cp_q13', type: 'likert', label: '60. (D) I felt down-hearted and blue. *', required: true, showIf: { field: 'fill_dass21_cp', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_cp_q14', type: 'likert', label: '61. (S) I was intolerant of anything that kept me from getting on with what I was doing. *', required: true, showIf: { field: 'fill_dass21_cp', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_cp_q15', type: 'likert', label: '62. (A) I felt I was close to panic. *', required: true, showIf: { field: 'fill_dass21_cp', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_cp_q16', type: 'likert', label: '63. (D) I was unable to become enthusiastic about anything. *', required: true, showIf: { field: 'fill_dass21_cp', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_cp_q17', type: 'likert', label: '64. (D) I felt I wasn\'t worth much as a person. *', required: true, showIf: { field: 'fill_dass21_cp', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_cp_q18', type: 'likert', label: '65. (S) I felt that I was rather touchy. *', required: true, showIf: { field: 'fill_dass21_cp', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_cp_q19', type: 'likert', label: '66. (A) I was aware of the action of my heart in the absence of physical exertion (e.g. sense of heart rate increase, heart missing a beat). *', required: true, showIf: { field: 'fill_dass21_cp', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_cp_q20', type: 'likert', label: '67. (A) I felt scared without any good reason. *', required: true, showIf: { field: 'fill_dass21_cp', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_cp_q21', type: 'likert', label: '68. (D) I felt that life was meaningless. *', required: true, showIf: { field: 'fill_dass21_cp', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]}
        ]
      },
      {
        title: 'Section 5 - DN-4',
        questions: [
          { id: 'fill_dn4_cp', type: 'radio', label: '69. Do you want to fill in DN-4 questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'dn4_cp_q1', type: 'likert', label: '70. Does the pain have one or more of the following characteristics? *', required: true, showIf: { field: 'fill_dn4_cp', value: 'yes' }, options: [
            'Burning',
            'Painful cold',
            'Electric shocks'
          ]},
          { id: 'dn4_cp_q2', type: 'likert', label: '71. Is the pain associated with one or more of the following symptoms in the same area? *', required: true, showIf: { field: 'fill_dn4_cp', value: 'yes' }, options: [
            'Tingling',
            'Pins and needles',
            'Numbness',
            'Itching'
          ]},
          { id: 'dn4_cp_q3', type: 'likert', label: '72. Is the pain located in an area where the physical examination may reveal one or more of the following characteristics? *', required: true, showIf: { field: 'fill_dn4_cp', value: 'yes' }, options: [
            'Hypoesthesia to touch',
            'Hypoesthesia to prick'
          ]},
          { id: 'dn4_cp_q4', type: 'likert', label: '73. In the painful area, can the pain be caused or increased by brushing? *', required: true, showIf: { field: 'fill_dn4_cp', value: 'yes' }, options: [
            'Yes',
            'No'
          ]}
        ]
      },
      {
        title: 'Section 6 - PainDETECT',
        questions: [
          { id: 'fill_paindetect_cp', type: 'radio', label: '74. Do you want to fill in Pain Detect questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'paindetect_cp_q1', type: 'slider', label: '75. How would you assess your pain now, at this moment? *', required: true, showIf: { field: 'fill_paindetect_cp', value: 'yes' }, min: 0, max: 10 },
          { id: 'paindetect_cp_q2', type: 'slider', label: '76. How strong was the strongest pain during the past 4 weeks? *', required: true, showIf: { field: 'fill_paindetect_cp', value: 'yes' }, min: 0, max: 10 },
          { id: 'paindetect_cp_q3', type: 'slider', label: '77. How strong was the pain during the past 4 weeks on average? *', required: true, showIf: { field: 'fill_paindetect_cp', value: 'yes' }, min: 0, max: 10 },
          { id: 'paindetect_cp_q4', type: 'radio', label: '78. Does your pain radiate to other regions of your body? *', required: true, showIf: { field: 'fill_paindetect_cp', value: 'yes' }, options: [
            { value: '2', label: '(2) Yes' },
            { value: '0', label: '(0) No' }
          ]},
          { id: 'paindetect_cp_q5', type: 'likert', label: '79. Do you suffer from a burning sensation (e.g., stinging nettles) in the marked areas? *', required: true, showIf: { field: 'fill_paindetect_cp', value: 'yes' }, options: [
            '(0) Never',
            '(1) Hardly noticed',
            '(2) Slightly',
            '(3) Moderately',
            '(4) Strongly',
            '(5) Very strongly'
          ]},
          { id: 'paindetect_cp_q6', type: 'likert', label: '80. Do you have a tingling or prickling sensation in the area of your pain (like crawling ants or electrical tingling)? *', required: true, showIf: { field: 'fill_paindetect_cp', value: 'yes' }, options: [
            '(0) Never',
            '(1) Hardly noticed',
            '(2) Slightly',
            '(3) Moderately',
            '(4) Strongly',
            '(5) Very strongly'
          ]},
          { id: 'paindetect_cp_q7', type: 'likert', label: '81. Is light touching (clothing, a blanket) in this area painful? *', required: true, showIf: { field: 'fill_paindetect_cp', value: 'yes' }, options: [
            '(0) Never',
            '(1) Hardly noticed',
            '(2) Slightly',
            '(3) Moderately',
            '(4) Strongly',
            '(5) Very strongly'
          ]},
          { id: 'paindetect_cp_q8', type: 'likert', label: '82. Do you have sudden pain attacks in the area of your pain, like electric shocks? *', required: true, showIf: { field: 'fill_paindetect_cp', value: 'yes' }, options: [
            '(0) Never',
            '(1) Hardly noticed',
            '(2) Slightly',
            '(3) Moderately',
            '(4) Strongly',
            '(5) Very strongly'
          ]},
          { id: 'paindetect_cp_q9', type: 'likert', label: '83. Is cold or heat (bath water) in this area occasionally painful? *', required: true, showIf: { field: 'fill_paindetect_cp', value: 'yes' }, options: [
            '(0) Never',
            '(1) Hardly noticed',
            '(2) Slightly',
            '(3) Moderately',
            '(4) Strongly',
            '(5) Very strongly'
          ]},
          { id: 'paindetect_cp_q10', type: 'likert', label: '84. Do you suffer from a sensation of numbness in the areas that you marked? *', required: true, showIf: { field: 'fill_paindetect_cp', value: 'yes' }, options: [
            '(0) Never',
            '(1) Hardly noticed',
            '(2) Slightly',
            '(3) Moderately',
            '(4) Strongly',
            '(5) Very strongly'
          ]},
          { id: 'paindetect_cp_q11', type: 'likert', label: '85. Does slight pressure in this area, e.g., with a finger, trigger pain? *', required: true, showIf: { field: 'fill_paindetect_cp', value: 'yes' }, options: [
            '(0) Never',
            '(1) Hardly noticed',
            '(2) Slightly',
            '(3) Moderately',
            '(4) Strongly',
            '(5) Very strongly'
          ]}
        ]
      },
      {
        title: 'Section 7 - Pain Rating Scale',
        questions: [
          { id: 'fill_painrating_cp', type: 'radio', label: '86. Do you want to fill in Pain Rating Scale questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'painrating_cp_q1', type: 'slider', label: '87. How intense is your pain now? *', required: true, showIf: { field: 'fill_painrating_cp', value: 'yes' }, min: 0, max: 10 },
          { id: 'painrating_cp_q2', type: 'slider', label: '88. How intense was your pain on average last week? *', required: true, showIf: { field: 'fill_painrating_cp', value: 'yes' }, min: 0, max: 10 },
          { id: 'painrating_cp_q3', type: 'slider', label: '89. How distressing is your pain now? *', required: true, showIf: { field: 'fill_painrating_cp', value: 'yes' }, min: 0, max: 10 },
          { id: 'painrating_cp_q4', type: 'slider', label: '90. How distressing was your pain on average last week? *', required: true, showIf: { field: 'fill_painrating_cp', value: 'yes' }, min: 0, max: 10 },
          { id: 'painrating_cp_q5', type: 'slider', label: '91. Now please use the same method to describe how much your pain interferes with your normal everyday activities. *', required: true, showIf: { field: 'fill_painrating_cp', value: 'yes' }, min: 0, max: 10 }
        ]
      },
      {
        title: 'Section 8 - GAD-7',
        questions: [
          { id: 'fill_gad7_cp', type: 'radio', label: '92. Do you want to fill in GAD-7 questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'gad7_cp_q1', type: 'likert', label: '93. Over the last two weeks feeling nervous, anxious, or on edge *', required: true, showIf: { field: 'fill_gad7_cp', value: 'yes' }, options: [
            '(0) Not at all',
            '(1) Several days',
            '(2) More than half of the days',
            '(3) Nearly every day'
          ]},
          { id: 'gad7_cp_q2', type: 'likert', label: '94. Over the last two weeks not being able to stop or control worrying *', required: true, showIf: { field: 'fill_gad7_cp', value: 'yes' }, options: [
            '(0) Not at all',
            '(1) Several days',
            '(2) More than half of the days',
            '(3) Nearly every day'
          ]},
          { id: 'gad7_cp_q3', type: 'likert', label: '95. Over the last two weeks worrying too much about different things *', required: true, showIf: { field: 'fill_gad7_cp', value: 'yes' }, options: [
            '(0) Not at all',
            '(1) Several days',
            '(2) More than half of the days',
            '(3) Nearly every day'
          ]},
          { id: 'gad7_cp_q4', type: 'likert', label: '96. Over the last two weeks trouble relaxing *', required: true, showIf: { field: 'fill_gad7_cp', value: 'yes' }, options: [
            '(0) Not at all',
            '(1) Several days',
            '(2) More than half of the days',
            '(3) Nearly every day'
          ]},
          { id: 'gad7_cp_q5', type: 'likert', label: '97. Over the last two weeks being so restless that it is hard to sit still *', required: true, showIf: { field: 'fill_gad7_cp', value: 'yes' }, options: [
            '(0) Not at all',
            '(1) Several days',
            '(2) More than half of the days',
            '(3) Nearly every day'
          ]},
          { id: 'gad7_cp_q6', type: 'likert', label: '98. Over the last two weeks becoming easily annoyed or irritable *', required: true, showIf: { field: 'fill_gad7_cp', value: 'yes' }, options: [
            '(0) Not at all',
            '(1) Several days',
            '(2) More than half of the days',
            '(3) Nearly every day'
          ]},
          { id: 'gad7_cp_q7', type: 'likert', label: '99. Over the last two weeks feeling afraid, as if something awful might happen *', required: true, showIf: { field: 'fill_gad7_cp', value: 'yes' }, options: [
            '(0) Not at all',
            '(1) Several days',
            '(2) More than half of the days',
            '(3) Nearly every day'
          ]}
        ]
      },
      {
        title: 'Section 9 - PSQI - Pittsburgh Sleep Quality Index',
        questions: [
          { id: 'fill_psqi_cp', type: 'radio', label: '100. Do you want to fill in PSQI questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'psqi_cp_q1', type: 'likert', label: '101. During the past month, what time have you usually gone to bed at night? (24-Hour Time Format) *', required: true, showIf: { field: 'fill_psqi_cp', value: 'yes' }, options: [
            '21:00', '22:00', '23:00', '24:00', '1:00', '2:00', '3:00', '4:00', '5:00', '6:00', '7:00', '8:00', '9:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00', '20:00'
          ]},
          { id: 'psqi_cp_q2', type: 'number', label: '102. During the past month, how long (in minutes) has it usually taken you to fall asleep each night? *', required: true, showIf: { field: 'fill_psqi_cp', value: 'yes' } },
          { id: 'psqi_cp_q3', type: 'likert', label: '103. During the past month, what time have you usually gotten up in the morning? (24-Hour Time Format) *', required: true, showIf: { field: 'fill_psqi_cp', value: 'yes' }, options: [
            '4:00', '5:00', '6:00', '7:00', '8:00', '9:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00', '20:00', '21:00', '22:00', '23:00', '24:00', '1:00', '2:00', '3:00'
          ]},
          { id: 'psqi_cp_q4', type: 'number', label: '104. During the past month, how many hours of actual sleep did you get at night? *', required: true, showIf: { field: 'fill_psqi_cp', value: 'yes' } },
          { id: 'psqi_cp_q5', type: 'likert', label: '105. Cannot get to sleep within 30 minutes *', required: true, showIf: { field: 'fill_psqi_cp', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_cp_q6', type: 'likert', label: '106. Wake up in the middle of the night or early morning *', required: true, showIf: { field: 'fill_psqi_cp', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_cp_q7', type: 'likert', label: '107. Have to get up to use the bathroom *', required: true, showIf: { field: 'fill_psqi_cp', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_cp_q8', type: 'likert', label: '108. Cannot breathe comfortably *', required: true, showIf: { field: 'fill_psqi_cp', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_cp_q9', type: 'likert', label: '109. Cough or snore loudly *', required: true, showIf: { field: 'fill_psqi_cp', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_cp_q10', type: 'likert', label: '110. Feel too cold *', required: true, showIf: { field: 'fill_psqi_cp', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_cp_q11', type: 'likert', label: '111. Feel too hot *', required: true, showIf: { field: 'fill_psqi_cp', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_cp_q12', type: 'likert', label: '112. Have bad dreams *', required: true, showIf: { field: 'fill_psqi_cp', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_cp_q13', type: 'likert', label: '113. Have pain *', required: true, showIf: { field: 'fill_psqi_cp', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_cp_q14', type: 'likert', label: '114. Other reason(s) *', required: true, showIf: { field: 'fill_psqi_cp', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_cp_q15', type: 'likert', label: '115. During the past month, how often have you taken medicine to help you sleep (prescribed or "over the counter")? *', required: true, showIf: { field: 'fill_psqi_cp', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_cp_q16', type: 'likert', label: '116. During the past month, how often have you had trouble staying awake while driving, eating meals, or engaging in social activity? *', required: true, showIf: { field: 'fill_psqi_cp', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_cp_q17', type: 'likert', label: '117. During the past month, how much of a problem has it been for you to keep up enough enthusiasm to get things done? *', required: true, showIf: { field: 'fill_psqi_cp', value: 'yes' }, options: [
            '(0) Not a problem at all',
            '(1) Only very slight problem',
            '(2) Somewhat of a problem',
            '(3) A very big problem'
          ]},
          { id: 'psqi_cp_q18', type: 'likert', label: '118. During the past month, how would you rate your sleep quality overall? *', required: true, showIf: { field: 'fill_psqi_cp', value: 'yes' }, options: [
            '(0) Very good',
            '(1) Fairly good',
            '(2) Fairly bad',
            '(3) Very bad'
          ]},
          { id: 'psqi_cp_q19', type: 'likert', label: '119. Do you have a bed partner or roommate? *', required: true, showIf: { field: 'fill_psqi_cp', value: 'yes' }, options: [
            'No bed partner or room mate',
            'Partner/room mate in other room',
            'Partner in same room but not same bed',
            'Partner in same bed'
          ]},
          { id: 'psqi_cp_q20', type: 'likert', label: '120. Loud snoring *', required: true, showIf: { field: 'fill_psqi_cp', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_cp_q21', type: 'likert', label: '121. Long pauses between breaths while asleep *', required: true, showIf: { field: 'fill_psqi_cp', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_cp_q22', type: 'likert', label: '122. Legs twitching or jerking while you sleep *', required: true, showIf: { field: 'fill_psqi_cp', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_cp_q23', type: 'likert', label: '123. Episodes of disorientation or confusion during sleep *', required: true, showIf: { field: 'fill_psqi_cp', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_cp_q24', type: 'likert', label: '124. Other restlessness while you sleep, please describe in next question *', required: true, showIf: { field: 'fill_psqi_cp', value: 'yes' }, options: [
            '(0) Not during the past month',
            '(1) Less than once a week',
            '(2) Once or twice a week',
            '(3) Three or more times a week'
          ]},
          { id: 'psqi_cp_q25', type: 'text', label: '125. Describe other restlessness while you sleep if applicable:', required: false, showIf: { field: 'fill_psqi_cp', value: 'yes' } }
        ]
      }
    ]
  },
  als: {
    title: 'Amyotrophic Lateral Sclerosis Assessment',
    sections: [
      {
        title: 'Section 1 - General Data',
        questions: [
          { id: 'assessment_date', type: 'date', label: '1. Date of assessment *', required: true },
          { id: 'doctor_email', type: 'email', label: '2. Doctor Email *', required: true },
          { id: 'patient_name', type: 'text', label: '3. Patient Name and Surname *', required: true },
          { id: 'patient_id', type: 'text', label: '4. Patient ID *', required: true },
          { id: 'patient_age', type: 'radio', label: '5. Patient Age *', required: true, options: [
            { value: '<18', label: '< 18' },
            { value: '18-25', label: '18-25' },
            { value: '26-35', label: '26-35' },
            { value: '36-45', label: '36-45' },
            { value: '46-55', label: '46-55' },
            { value: '56-65', label: '56-65' },
            { value: '>65', label: '> 65' }
          ]},
          { id: 'gender', type: 'radio', label: '6. Gender *', required: true, options: [
            { value: 'male', label: 'Male' },
            { value: 'female', label: 'Female' },
            { value: 'non-binary', label: 'Non-binary' }
          ]},
          { id: 'visit_type', type: 'radio', label: '7. Please choose one of the following options *', required: true, options: [
            { value: 'first', label: 'First visit' },
            { value: 'followup1', label: 'Follow-up visit 1' },
            { value: 'followup2', label: 'Follow-up visit 2' },
            { value: 'followup3', label: 'Follow-up visit 3' }
          ]}
        ]
      },
      {
        title: 'Section 2 - EQ-5D-5L Health Questionnaire',
        questions: [
          { id: 'fill_eq5d', type: 'radio', label: '8. Do you want to fill in EQ-5D-5L questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'eq5d_mobility', type: 'likert', label: '9. Mobility *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, options: [
            '(1) I have no problems in walking about',
            '(2) I have slight problems in walking about',
            '(3) I have moderate problems in walking about',
            '(4) I have severe problems in walking about',
            '(5) I am unable to walk about'
          ]},
          { id: 'eq5d_selfcare', type: 'likert', label: '10. Self Care *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, options: [
            '(1) I have no problems washing or dressing myself',
            '(2) I have slight problems washing or dressing myself',
            '(3) I have moderate problems washing or dressing myself',
            '(4) I have severe problems washing or dressing myself',
            '(5) I am unable to wash or dress myself'
          ]},
          { id: 'eq5d_activities', type: 'likert', label: '11. Usual activities (e.g. work, study, housework, family or leisure activities) *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, options: [
            '(1) I have no problems doing my usual activities',
            '(2) I have slight problems doing my usual activities',
            '(3) I have moderate problems doing my usual activities',
            '(4) I have severe problems doing my usual activities',
            '(5) I am unable to do my usual activities'
          ]},
          { id: 'eq5d_pain', type: 'likert', label: '12. Pain/Discomfort *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, options: [
            '(1) I have no pain or discomfort',
            '(2) I have slight pain or discomfort',
            '(3) I have moderate pain or discomfort',
            '(4) I have severe pain or discomfort',
            '(5) I have extreme pain or discomfort'
          ]},
          { id: 'eq5d_anxiety', type: 'likert', label: '13. Anxiety/Depression *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, options: [
            '(1) I am not anxious or depressed',
            '(2) I am slightly anxious or depressed',
            '(3) I am moderately anxious or depressed',
            '(4) I am severely anxious or depressed',
            '(5) I am extremely anxious or depressed'
          ]},
          { id: 'eq5d_health_scale', type: 'slider', label: '14. We would like to know how good or bad your health is TODAY. 0 means the worst health you can imagine. 10 means the best health you can imagine. *', required: true, showIf: { field: 'fill_eq5d', value: 'yes' }, min: 0, max: 10 }
        ]
      },
      {
        title: 'Section 3 - COMPASS 31',
        questions: [
          { id: 'fill_compass31_als', type: 'radio', label: '15. Do you want to fill in COMPASS-31 questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'compass31_als_q16', type: 'radio', label: '16. In the past year, have you ever felt faint, dizzy, "goofy", or had difficulty thinking soon after standing up from a sitting or lying position? *', required: true, showIf: { field: 'fill_compass31_als', value: 'yes' }, options: [
            { value: '1', label: '(1) Yes' },
            { value: '2', label: '(2) No' }
          ]},
          { id: 'compass31_als_q17', type: 'likert', label: '17. When standing up, how frequently do you get these feelings or symptoms? *', required: true, showIf: { field: 'compass31_als_q16', value: '1' }, options: [
            '(1) Rarely',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Almost Always'
          ]},
          { id: 'compass31_als_q18', type: 'likert', label: '18. How would you rate the severity of these feelings or symptoms? *', required: true, showIf: { field: 'compass31_als_q16', value: '1' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_als_q19', type: 'likert', label: '19. In the past year, have these feelings or symptoms that you have experienced: *', required: true, showIf: { field: 'compass31_als_q16', value: '1' }, options: [
            '(1) Gotten much worse',
            '(2) Gotten somewhat worse',
            '(3) Stayed about the same',
            '(4) Gotten somewhat better',
            '(5) Gotten much better Completely gone'
          ]},
          { id: 'compass31_als_q20', type: 'radio', label: '20. In the past year, have you ever noticed color changes in your skin, such as red, white, or purple? *', required: true, showIf: { field: 'fill_compass31_als', value: 'yes' }, options: [
            { value: '1', label: '(1) Yes' },
            { value: '2', label: '(2) No' }
          ]},
          { id: 'compass31_als_q21', type: 'checkbox', label: '21. What parts of your body are affected by these color changes? (Check all that apply) *', required: true, showIf: { field: 'compass31_als_q20', value: '1' }, options: [
            { value: 'hands', label: '(1) Hands' },
            { value: 'feet', label: '(2) Feet' }
          ]},
          { id: 'compass31_als_q22', type: 'likert', label: '22. Are these changes in your skin color: *', required: true, showIf: { field: 'compass31_als_q20', value: '1' }, options: [
            '(1) Getting much worse',
            '(2) Getting somewhat worse',
            '(3) Staying about the same',
            '(4) Getting somewhat better',
            '(5) Getting much better',
            '(6) Completely gone'
          ]},
          { id: 'compass31_als_q23', type: 'likert', label: '23. In the past 5 years, what changes, if any, have occurred in your general body sweating? *', required: true, showIf: { field: 'fill_compass31_als', value: 'yes' }, options: [
            '(1) I sweat much more than I used to',
            '(2) I sweat somewhat more than I used to',
            '(3) I haven\'t noticed any changes in my sweating',
            '(4) I sweat somewhat less than I used to',
            '(5) I sweat much less than I used to'
          ]},
          { id: 'compass31_als_q24', type: 'radio', label: '24. Do your eyes feel excessively dry? *', required: true, showIf: { field: 'fill_compass31_als', value: 'yes' }, options: [
            { value: '1', label: '(1) Yes' },
            { value: '2', label: '(2) No' }
          ]},
          { id: 'compass31_als_q25', type: 'radio', label: '25. Does your mouth feel excessively dry? *', required: true, showIf: { field: 'fill_compass31_als', value: 'yes' }, options: [
            { value: '1', label: '(1) Yes' },
            { value: '2', label: '(2) No' }
          ]},
          { id: 'compass31_als_q26', type: 'likert', label: '26. For the symptom of dry eyes or dry mouth that you have had for the longest period of time, is this symptom: *', required: true, showIf: { field: 'fill_compass31_als', value: 'yes' }, options: [
            '(1) I have not had any of these symptoms',
            '(2) Getting much worse',
            '(3) Getting somewhat worse',
            '(4) Staying about the same',
            '(5) Getting somewhat better',
            '(6) Getting much better',
            '(7) Completely gone'
          ]},
          { id: 'compass31_als_q27', type: 'likert', label: '27. In the past year, have you noticed any changes in how quickly you get full when eating a meal? *', required: true, showIf: { field: 'fill_compass31_als', value: 'yes' }, options: [
            '(1) I get full a lot more quickly now than I used to',
            '(2) I get full more quickly now than I used to',
            '(3) I haven\'t noticed any change',
            '(4) I get full less quickly now than I used to',
            '(5) I get full a lot less quickly now than I used to'
          ]},
          { id: 'compass31_als_q28', type: 'likert', label: '28. In the past year, have you felt excessively full or persistently full (bloated feeling) after a meal? *', required: true, showIf: { field: 'fill_compass31_als', value: 'yes' }, options: [
            '(1) Never',
            '(2) Sometimes',
            '(3) A lot of times'
          ]},
          { id: 'compass31_als_q29', type: 'likert', label: '29. In the past year, have you vomited after a meal? *', required: true, showIf: { field: 'fill_compass31_als', value: 'yes' }, options: [
            '(1) Never',
            '(2) Sometimes',
            '(3) A lot of time'
          ]},
          { id: 'compass31_als_q30', type: 'likert', label: '30. In the past year, have you had a cramping or colicky abdominal pain? *', required: true, showIf: { field: 'fill_compass31_als', value: 'yes' }, options: [
            '(1) Never',
            '(2) Sometimes',
            '(3) A lot of times'
          ]},
          { id: 'compass31_als_q31', type: 'radio', label: '31. In the past year, have you had any bouts of diarrhea? *', required: true, showIf: { field: 'fill_compass31_als', value: 'yes' }, options: [
            { value: '1', label: '(1) Yes' },
            { value: '2', label: '(2) No' }
          ]},
          { id: 'compass31_als_q32', type: 'likert', label: '32. How frequently does this occur? *', required: true, showIf: { field: 'compass31_als_q31', value: '1' }, options: [
            '(1) Rarely',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_als_q33', type: 'likert', label: '33. How severe are these bouts of diarrhea? *', required: true, showIf: { field: 'compass31_als_q31', value: '1' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_als_q34', type: 'likert', label: '34. Are your bouts of diarrhea getting: *', required: true, showIf: { field: 'compass31_als_q31', value: '1' }, options: [
            '(1) Much worse',
            '(2) Somewhat worse',
            '(3) Staying the same',
            '(4) Much better',
            '(5) Completely gone'
          ]},
          { id: 'compass31_als_q35', type: 'radio', label: '35. In the past year, have you been constipated? *', required: true, showIf: { field: 'fill_compass31_als', value: 'yes' }, options: [
            { value: '1', label: '(1) Yes' },
            { value: '2', label: '(2) No' }
          ]},
          { id: 'compass31_als_q36', type: 'likert', label: '36. How frequently are you constipated? *', required: true, showIf: { field: 'compass31_als_q35', value: '1' }, options: [
            '(1) Rarely',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_als_q37', type: 'likert', label: '37. How severe are these episodes of constipation? *', required: true, showIf: { field: 'compass31_als_q35', value: '1' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_als_q38', type: 'likert', label: '38. Is your constipation getting: *', required: true, showIf: { field: 'compass31_als_q35', value: '1' }, options: [
            '(1) Much worse',
            '(2) Somewhat worse',
            '(3) Staying the same',
            '(4) Somewhat better',
            '(5) Much better',
            '(6) Completely gone'
          ]},
          { id: 'compass31_als_q39', type: 'likert', label: '39. In the past year, have you ever lost control of your bladder function? *', required: true, showIf: { field: 'fill_compass31_als', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_als_q40', type: 'likert', label: '40. In the past year, have you had difficulty passing urine? *', required: true, showIf: { field: 'fill_compass31_als', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_als_q41', type: 'likert', label: '41. In the past year, have you had trouble completely emptying your bladder? *', required: true, showIf: { field: 'fill_compass31_als', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_als_q42', type: 'likert', label: '42. In the past year, without sunglasses or tinted glasses, has bright light bothered your eyes? *', required: true, showIf: { field: 'fill_compass31_als', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_als_q43', type: 'likert', label: '43. How severe is this sensitivity to bright light? *', required: true, showIf: { field: 'compass31_als_q42', value: '(2) Occasionally' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_als_q43b', type: 'likert', label: '43. How severe is this sensitivity to bright light? *', required: true, showIf: { field: 'compass31_als_q42', value: '(3) Frequently' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_als_q43c', type: 'likert', label: '43. How severe is this sensitivity to bright light? *', required: true, showIf: { field: 'compass31_als_q42', value: '(4) Constantly' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_als_q44', type: 'likert', label: '44. In the past year, have you had trouble focusing your eyes? *', required: true, showIf: { field: 'fill_compass31_als', value: 'yes' }, options: [
            '(1) Never',
            '(2) Occasionally',
            '(3) Frequently',
            '(4) Constantly'
          ]},
          { id: 'compass31_als_q45', type: 'likert', label: '45. How severe is this focusing problem? *', required: true, showIf: { field: 'compass31_als_q44', value: '(2) Occasionally' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_als_q45b', type: 'likert', label: '45. How severe is this focusing problem? *', required: true, showIf: { field: 'compass31_als_q44', value: '(3) Frequently' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_als_q45c', type: 'likert', label: '45. How severe is this focusing problem? *', required: true, showIf: { field: 'compass31_als_q44', value: '(4) Constantly' }, options: [
            '(1) Mild',
            '(2) Moderate',
            '(3) Severe'
          ]},
          { id: 'compass31_als_q46', type: 'likert', label: '46. Is the most troublesome symptom with your eyes (i.e. sensitivity to bright light or trouble focusing) getting: *', required: true, showIf: { field: 'fill_compass31_als', value: 'yes' }, options: [
            '(1) I have not had any of these symptoms',
            '(2) Much worse',
            '(3) Somewhat worse',
            '(4) Staying about the same',
            '(5) Somewhat better',
            '(6) Much better',
            '(7) Completely gone'
          ]}
        ]
      },
      {
        title: 'Section 4 - DASS 21',
        questions: [
          { id: 'fill_dass21_als', type: 'radio', label: '47. Do you want to fill in DASS-21 questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'dass21_als_q1', type: 'likert', label: '48. (S) I found it hard to wind down. *', required: true, showIf: { field: 'fill_dass21_als', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_als_q2', type: 'likert', label: '49. (A) I was aware of dryness of my mouth. *', required: true, showIf: { field: 'fill_dass21_als', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_als_q3', type: 'likert', label: '50. (D) I couldn\'t seem to experience any positive feeling at all. *', required: true, showIf: { field: 'fill_dass21_als', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_als_q4', type: 'likert', label: '51. (A) I experienced breathing difficulty (e.g. excessively rapid breathing, breathlessness in the absence of physical exertion). *', required: true, showIf: { field: 'fill_dass21_als', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_als_q5', type: 'likert', label: '52. (D) I found it difficult to work up the initiative to do things. *', required: true, showIf: { field: 'fill_dass21_als', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_als_q6', type: 'likert', label: '53. (S) I tended to over-react to situations. *', required: true, showIf: { field: 'fill_dass21_als', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_als_q7', type: 'likert', label: '54. (A) I experienced trembling (e.g. in the hands). *', required: true, showIf: { field: 'fill_dass21_als', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_als_q8', type: 'likert', label: '55. (S) I felt that I was using a lot of nervous energy. *', required: true, showIf: { field: 'fill_dass21_als', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_als_q9', type: 'likert', label: '56. (A) I was worried about situations in which I might panic and make a fool of myself. *', required: true, showIf: { field: 'fill_dass21_als', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_als_q10', type: 'likert', label: '57. (D) I felt that I had nothing to look forward to. *', required: true, showIf: { field: 'fill_dass21_als', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_als_q11', type: 'likert', label: '58. (S) I found myself getting agitated. *', required: true, showIf: { field: 'fill_dass21_als', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_als_q12', type: 'likert', label: '59. (S) I found it difficult to relax. *', required: true, showIf: { field: 'fill_dass21_als', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_als_q13', type: 'likert', label: '60. (D) I felt down-hearted and blue. *', required: true, showIf: { field: 'fill_dass21_als', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_als_q14', type: 'likert', label: '61. (S) I was intolerant of anything that kept me from getting on with what I was doing. *', required: true, showIf: { field: 'fill_dass21_als', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_als_q15', type: 'likert', label: '62. (A) I felt I was close to panic. *', required: true, showIf: { field: 'fill_dass21_als', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_als_q16', type: 'likert', label: '63. (D) I was unable to become enthusiastic about anything. *', required: true, showIf: { field: 'fill_dass21_als', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_als_q17', type: 'likert', label: '64. (D) I felt I wasn\'t worth much as a person. *', required: true, showIf: { field: 'fill_dass21_als', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_als_q18', type: 'likert', label: '65. (S) I felt that I was rather touchy. *', required: true, showIf: { field: 'fill_dass21_als', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_als_q19', type: 'likert', label: '66. (A) I was aware of the action of my heart in the absence of physical exertion (e.g. sense of heart rate increase, heart missing a beat). *', required: true, showIf: { field: 'fill_dass21_als', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_als_q20', type: 'likert', label: '67. (A) I felt scared without any good reason. *', required: true, showIf: { field: 'fill_dass21_als', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]},
          { id: 'dass21_als_q21', type: 'likert', label: '68. (D) I felt that life was meaningless. *', required: true, showIf: { field: 'fill_dass21_als', value: 'yes' }, options: [
            '(0) Did not apply to me at all',
            '(1) Applied to me to some degree, or some of the time',
            '(2) Applied to me to a considerable degree or a good part of the time',
            '(3) Applied to me very much or most of the time'
          ]}
        ]
      },
      {
        title: 'Section 5 - BDI-II - Beck\'s Inventory Version 2',
        questions: [
          { id: 'fill_bdi_als', type: 'radio', label: '69. Do you want to fill in BDI-II - Beck\'s Inventory questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'bdi_als_q1', type: 'likert', label: '70. Sadness *', required: true, showIf: { field: 'fill_bdi_als', value: 'yes' }, options: [
            '(0) I do not feel sad',
            '(1) I feel sad much of the time',
            '(2) I am sad all the time',
            '(3) I am so sad or unhappy that I can\'t stand it'
          ]},
          { id: 'bdi_als_q2', type: 'likert', label: '71. Pessimism *', required: true, showIf: { field: 'fill_bdi_als', value: 'yes' }, options: [
            '(0) I am not discouraged about my future',
            '(1) I feel more discouraged about my future than I used to be',
            '(2) I do not expect things to work out for me',
            '(3) I feel my future is hopeless and will only get worse'
          ]},
          { id: 'bdi_als_q3', type: 'likert', label: '72. Past Failure *', required: true, showIf: { field: 'fill_bdi_als', value: 'yes' }, options: [
            '(0) I do not feel like a failure',
            '(1) I have failed more than I should have',
            '(2) As I look back, I see a lot of failures',
            '(3) I feel I am a total failure as a person'
          ]},
          { id: 'bdi_als_q4', type: 'likert', label: '73. Loss of Pleasure *', required: true, showIf: { field: 'fill_bdi_als', value: 'yes' }, options: [
            '(0) I get as much pleasure as I ever did from the things I enjoy',
            '(1) I don\'t enjoy things as much as I used to',
            '(2) I get very little pleasure from the things I used to enjoy',
            '(3) I can\'t get any pleasure from the things I used to enjoy'
          ]},
          { id: 'bdi_als_q5', type: 'likert', label: '74. Guilty Feelings *', required: true, showIf: { field: 'fill_bdi_als', value: 'yes' }, options: [
            '(0) I don\'t feel particularly guilty',
            '(1) I feel guilty over many things I have done or should have done',
            '(2) I feel quite guilty most of the time',
            '(3) I feel guilty all of the time'
          ]},
          { id: 'bdi_als_q6', type: 'likert', label: '75. Punishment Feelings *', required: true, showIf: { field: 'fill_bdi_als', value: 'yes' }, options: [
            '(0) I don\'t feel I am being punished',
            '(1) I feel I may be punished',
            '(2) I expect to be punished',
            '(3) I feel I am being punished'
          ]},
          { id: 'bdi_als_q7', type: 'likert', label: '76. Self-Dislike *', required: true, showIf: { field: 'fill_bdi_als', value: 'yes' }, options: [
            '(0) I feel the same about myself as ever',
            '(1) I have lost confidence in myself',
            '(2) I am disappointed in myself',
            '(3) I dislike myself'
          ]},
          { id: 'bdi_als_q8', type: 'likert', label: '77. Self-Criticalness *', required: true, showIf: { field: 'fill_bdi_als', value: 'yes' }, options: [
            '(0) I don\'t criticize or blame myself more than usual',
            '(1) I am more critical of myself than I used to be',
            '(2) I criticize myself for all of my faults',
            '(3) I blame myself for everything bad that happens'
          ]},
          { id: 'bdi_als_q9', type: 'likert', label: '78. Suicidal Thoughts or Wishes *', required: true, showIf: { field: 'fill_bdi_als', value: 'yes' }, options: [
            '(0) I don\'t have any thoughts of killing myself',
            '(1) I have thoughts of killing myself, but I would not carry them out',
            '(2) I would like to kill myself',
            '(3) I would kill myself if I had the chance'
          ]},
          { id: 'bdi_als_q10', type: 'likert', label: '79. Crying *', required: true, showIf: { field: 'fill_bdi_als', value: 'yes' }, options: [
            '(0) I don\'t cry any more than I used to',
            '(1) I cry more than I used to',
            '(2) I cry over every little thing',
            '(3) I feel like crying, but I can\'t'
          ]},
          { id: 'bdi_als_q11', type: 'likert', label: '80. Agitation *', required: true, showIf: { field: 'fill_bdi_als', value: 'yes' }, options: [
            '(0) I am no more restless or wound up than usual',
            '(1) I feel more restless or wound up than usual',
            '(2) I am so restless or agitated that it\'s hard to stay still',
            '(3) I am so restless or agitated that I have to keep moving or doing something'
          ]},
          { id: 'bdi_als_q12', type: 'likert', label: '81. Loss of Interest *', required: true, showIf: { field: 'fill_bdi_als', value: 'yes' }, options: [
            '(0) I have not lost interest in other people or activities',
            '(1) I am less interested in other people or things than before',
            '(2) I have lost most of my interest in other people or things',
            '(3) It\'s hard to get interested in anything'
          ]},
          { id: 'bdi_als_q13', type: 'likert', label: '82. Indecisiveness *', required: true, showIf: { field: 'fill_bdi_als', value: 'yes' }, options: [
            '(0) I make decisions about as well as ever',
            '(1) I find it more difficult to make decisions than usual',
            '(2) I have much greater difficulty in making decisions than I used to',
            '(3) I have trouble making any decisions'
          ]},
          { id: 'bdi_als_q14', type: 'likert', label: '83. Worthlessness *', required: true, showIf: { field: 'fill_bdi_als', value: 'yes' }, options: [
            '(0) I do not feel I am worthless',
            '(1) I don\'t consider myself as worthwhile and useful as I used to',
            '(2) I feel more worthless as compared to other people',
            '(3) I feel utterly worthless'
          ]},
          { id: 'bdi_als_q15', type: 'likert', label: '84. Loss of Energy *', required: true, showIf: { field: 'fill_bdi_als', value: 'yes' }, options: [
            '(0) I have as much energy as ever',
            '(1) I have less energy than I used to have',
            '(2) I don\'t have enough energy to do very much',
            '(3) I don\'t have enough energy to do anything'
          ]},
          { id: 'bdi_als_q16', type: 'likert', label: '85. Changes in Sleeping Pattern *', required: true, showIf: { field: 'fill_bdi_als', value: 'yes' }, options: [
            '(0) I have not experienced any change in my sleeping pattern',
            '(1) I sleep somewhat more than usual',
            '(2) I sleep somewhat less than usual',
            '(3) I sleep a lot more than usual',
            '(4) I sleep a lot less than usual',
            '(5) I sleep most of the day',
            '(6) I wake up 1-2 hours early and can\'t get back to sleep'
          ]},
          { id: 'bdi_als_q17', type: 'likert', label: '86. Irritability *', required: true, showIf: { field: 'fill_bdi_als', value: 'yes' }, options: [
            '(0) I am no more irritable than usual',
            '(1) I am more irritable than usual',
            '(2) I am much more irritable than usual',
            '(3) I am irritable all the time'
          ]},
          { id: 'bdi_als_q18', type: 'likert', label: '87. Changes in Appetite *', required: true, showIf: { field: 'fill_bdi_als', value: 'yes' }, options: [
            '(0) I have not experienced any changes in my appetite',
            '(1) My appetite is somewhat less than usual',
            '(2) My appetite is somewhat greater than usual',
            '(3) My appetite is much less than before',
            '(4) My appetite is much greater than usual',
            '(5) I have no appetite at all',
            '(6) I crave food all the time'
          ]},
          { id: 'bdi_als_q19', type: 'likert', label: '88. Concentration Difficulty *', required: true, showIf: { field: 'fill_bdi_als', value: 'yes' }, options: [
            '(0) I can concentrate as well as ever',
            '(1) I can\'t concentrate as well as usual',
            '(2) It\'s hard to keep my mind on anything for very long',
            '(3) I find I can\'t concentrate on anything'
          ]},
          { id: 'bdi_als_q20', type: 'likert', label: '89. Tiredness or Fatigue *', required: true, showIf: { field: 'fill_bdi_als', value: 'yes' }, options: [
            '(0) I am no more tired or fatigued than usual',
            '(1) I get more tired or fatigued more easily than usual',
            '(2) I am too tired or fatigued to do a lot of the things I used to do',
            '(3) I am too tired or fatigued to do most of the things I used to do'
          ]},
          { id: 'bdi_als_q21', type: 'likert', label: '90. Loss of Interest in Sex', required: false, showIf: { field: 'fill_bdi_als', value: 'yes' }, options: [
            '(0) I have not noticed any recent change in my interest in sex',
            '(1) I am less interested in sex than I used to be',
            '(2) I am much less interested in sex now',
            '(3) I have lost interest in sex completely'
          ]}
        ]
      },
      {
        title: 'Section 6 - MAS - Modified Ashworth Scale',
        questions: [
          { id: 'fill_mas_als', type: 'radio', label: '91. Do you want to fill in MAS - Modified Ashworth Scale questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'mas_als_q1', type: 'likert', label: '92. Question - Depending on the kind of muscles tested, please score: *', required: true, showIf: { field: 'fill_mas_als', value: 'yes' }, options: [
            '(0) No increase in muscle tone',
            '(1) Slight increase in muscle tone, manifested by a catch and release or by minimal resistance at the end of the range of motion',
            '(1.5) Slight increase in muscle tone, manifested by a catch, followed by minimal resistance throughout the remainder',
            '(2) More marked increase in muscle tone through most of the ROM, but affected part(s) easily moved',
            '(3) Considerable increase in muscle tone, passive movement difficult',
            '(4) Affected part(s) rigid in flexion or extension'
          ]}
        ]
      },
      {
        title: 'Section 7 - GAD 7',
        questions: [
          { id: 'fill_gad7_als', type: 'radio', label: '93. Do you want to fill in GAD 7 questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'gad7_als_q1', type: 'likert', label: '94. Over the last two weeks feeling nervous, anxious, or on edge *', required: true, showIf: { field: 'fill_gad7_als', value: 'yes' }, options: [
            '(0) Not at all',
            '(1) Several days',
            '(2) More than half of the days',
            '(3) Nearly every day'
          ]},
          { id: 'gad7_als_q2', type: 'likert', label: '95. Over the last two weeks not being able to stop or control worrying *', required: true, showIf: { field: 'fill_gad7_als', value: 'yes' }, options: [
            '(0) Not at all',
            '(1) Several days',
            '(2) More than half of the days',
            '(3) Nearly every day'
          ]},
          { id: 'gad7_als_q3', type: 'likert', label: '96. Over the last two weeks worrying too much about different things *', required: true, showIf: { field: 'fill_gad7_als', value: 'yes' }, options: [
            '(0) Not at all',
            '(1) Several days',
            '(2) More than half of the days',
            '(3) Nearly every day'
          ]},
          { id: 'gad7_als_q4', type: 'likert', label: '97. Over the last two weeks trouble relaxing *', required: true, showIf: { field: 'fill_gad7_als', value: 'yes' }, options: [
            '(0) Not at all',
            '(1) Several days',
            '(2) More than half of the days',
            '(3) Nearly every day'
          ]},
          { id: 'gad7_als_q5', type: 'likert', label: '98. Over the last two weeks being so restless that it is hard to sit still *', required: true, showIf: { field: 'fill_gad7_als', value: 'yes' }, options: [
            '(0) Not at all',
            '(1) Several days',
            '(2) More than half of the days',
            '(3) Nearly every day'
          ]},
          { id: 'gad7_als_q6', type: 'likert', label: '99. Over the last two weeks becoming easily annoyed or irritable *', required: true, showIf: { field: 'fill_gad7_als', value: 'yes' }, options: [
            '(0) Not at all',
            '(1) Several days',
            '(2) More than half of the days',
            '(3) Nearly every day'
          ]},
          { id: 'gad7_als_q7', type: 'likert', label: '100. Over the last two weeks feeling afraid, as if something awful might happen *', required: true, showIf: { field: 'fill_gad7_als', value: 'yes' }, options: [
            '(0) Not at all',
            '(1) Several days',
            '(2) More than half of the days',
            '(3) Nearly every day'
          ]}
        ]
      },
      {
        title: 'Section 8 - ALSFRS-R - ALS Functional Rating Scale–Revised',
        questions: [
          { id: 'fill_alsfrs_als', type: 'radio', label: '101. Do you want to fill in ALSFRS-R Functional Rating Scale questionnaire? *', required: true, options: [
            { value: 'yes', label: 'Yes' },
            { value: 'no', label: 'No' }
          ]},
          { id: 'alsfrs_als_q1', type: 'likert', label: '102. Speech *', required: true, showIf: { field: 'fill_alsfrs_als', value: 'yes' }, options: [
            '(4) Normal',
            '(3) Detectable speech disturbances',
            '(2) Intelligible with repeating',
            '(1) Speech combined with nonvocal communication',
            '(0) Loss of useful speech'
          ]},
          { id: 'alsfrs_als_q2', type: 'likert', label: '103. Salivation *', required: true, showIf: { field: 'fill_alsfrs_als', value: 'yes' }, options: [
            '(4) Normal',
            '(3) Slight but definite excess of saliva in mouth; may have nighttime drooling',
            '(2) Moderately excessive saliva; may have minimal drooling',
            '(1) Marked excess of saliva with some drooling',
            '(0) Slight but definite excess of saliva in mouth; may have nighttime drooling'
          ]},
          { id: 'alsfrs_als_q3', type: 'likert', label: '104. Swallowing *', required: true, showIf: { field: 'fill_alsfrs_als', value: 'yes' }, options: [
            '(4) Normal',
            '(3) Early eating problems - occasional choking',
            '(2) Dietary consistency changes',
            '(1) Needs supplemental tube feeding',
            '(0) NPO (exclusively parenteral or enteral feeding'
          ]},
          { id: 'alsfrs_als_q4', type: 'likert', label: '105. Hand writing *', required: true, showIf: { field: 'fill_alsfrs_als', value: 'yes' }, options: [
            '(4) Normal',
            '(3) Slow or sloppy; all words are legible',
            '(2) Not all words are legible',
            '(1) Able to grip pen but unable to write',
            '(0) Unable to grip pen'
          ]},
          { id: 'alsfrs_als_q5', type: 'likert', label: '106. Cutting food *', required: true, showIf: { field: 'fill_alsfrs_als', value: 'yes' }, options: [
            '(4) Normal',
            '(3) Somewhat slow and clumsy, but no help needed',
            '(2) Can cut most foods, although slow and clumsy; some help needed',
            '(1) Food must be but by someone, but can still feed slowly',
            '(0) Needs to be fed'
          ]},
          { id: 'alsfrs_als_q6', type: 'likert', label: '107. Dressing and Hygiene *', required: true, showIf: { field: 'fill_alsfrs_als', value: 'yes' }, options: [
            '(4) Normal',
            '(3) Independent and complete self-care with effort or decreased efficiency',
            '(2) Intermitted assistance or substitute methods',
            '(1) Needs attendant for self-care',
            '(0) Total dependence'
          ]},
          { id: 'alsfrs_als_q7', type: 'likert', label: '108. Turning in Bed *', required: true, showIf: { field: 'fill_alsfrs_als', value: 'yes' }, options: [
            '(4) Normal',
            '(3) Somewhat slow and clumsy, but no help needed',
            '(2) Can turn alone or adjust sheets, but with great difficulty',
            '(1) Can initiate, but not turn or adjust sheets alone',
            '(0) Helpless'
          ]},
          { id: 'alsfrs_als_q8', type: 'likert', label: '109. Walking *', required: true, showIf: { field: 'fill_alsfrs_als', value: 'yes' }, options: [
            '(4) Normal',
            '(3) Early ambulation difficulties',
            '(2) Walks with assistance',
            '(1) Non-ambulatory functional movement only',
            '(0) No purposeful leg movement'
          ]},
          { id: 'alsfrs_als_q9', type: 'likert', label: '110. Climbing stairs *', required: true, showIf: { field: 'fill_alsfrs_als', value: 'yes' }, options: [
            '(4) Normal',
            '(3) Slow',
            '(2) Mild unsteadiness or fatigue',
            '(1) Needs assistance',
            '(0) Cannot do'
          ]},
          { id: 'alsfrs_als_q10', type: 'likert', label: '111. Dyspnea *', required: true, showIf: { field: 'fill_alsfrs_als', value: 'yes' }, options: [
            '(4) None',
            '(3) Occurs when walking',
            '(2) Occurs with one or more of the following: eating, bathing, dressing (ADL)',
            '(1) Occurs at rest, difficulty breathing when either sitting or lying',
            '(0) Significant difficulty, considering using mechanical respiratory support'
          ]},
          { id: 'alsfrs_als_q11', type: 'likert', label: '112. Orthopnea *', required: true, showIf: { field: 'fill_alsfrs_als', value: 'yes' }, options: [
            '(4) None',
            '(3) Some difficulty sleeping at night due to shortness of breath. Does not routinely use more than two pillows',
            '(2) Needs extra pillow in order to sleep (more than two)',
            '(1) Can only sleep sitting up',
            '(0) Unable to sleep'
          ]},
          { id: 'alsfrs_als_q12', type: 'likert', label: '113. Respiratory insufficiency *', required: true, showIf: { field: 'fill_alsfrs_als', value: 'yes' }, options: [
            '(4) None',
            '(3) Intermitted use of BiPAP',
            '(2) Continuous use of BiPAP',
            '(1) Continuous use of BiPAP during the day and night',
            '(0) Invasive mechanical ventilation by intubation or tracheostomy'
          ]}
        ]
      }
    ]
  },
  adhd: {
    title: 'ADHD Assessment',
    sections: [
      {
        title: 'General Data',
        questions: [
          { id: 'q5_age_group', type: 'radio', label: 'Patient Age *', required: true, options: [
            { value: '<18', label: '< 18' },
            { value: '18-25', label: '18-25' },
            { value: '26-35', label: '26-35' },
            { value: '36-45', label: '36-45' },
            { value: '46-55', label: '46-55' },
            { value: '56-65', label: '56-65' },
            { value: '>65', label: '> 65' }
          ]},
          { id: 'q6_gender', type: 'radio', label: 'Gender *', required: true, options: [
            { value: 'male', label: 'Male' },
            { value: 'female', label: 'Female' },
            { value: 'nonbinary', label: 'Non-binary' }
          ]},
          { id: 'q7_visit_type', type: 'radio', label: 'Visit Type *', required: true, options: [
            { value: 'first', label: 'First visit' },
            { value: 'f1', label: 'Follow-up visit 1' },
            { value: 'f2', label: 'Follow-up visit 2' },
            { value: 'f3', label: 'Follow-up visit 3' }
          ]}
        ]
      },
      {
        title: 'EQ-5D-5L Health Questionnaire',
        questions: [
          { id: 'q8_eq5d', type: 'radio', label: 'Do you want to fill in EQ-5D-5L questionnaire?', required: true, options: [
            { value: 'Yes', label: 'Yes' },
            { value: 'No', label: 'No' }
          ]},
          { id: 'q9_mobility', type: 'likert', label: 'Mobility', options: [
            '(1) I have no problems in walking about',
            '(2) I have slight problems in walking about',
            '(3) I have moderate problems in walking about',
            '(4) I have severe problems in walking about',
            '(5) I am unable to walk about'
          ], showIf: { field: 'q8_eq5d', value: 'Yes' }},
          { id: 'q10_selfcare', type: 'likert', label: 'Self Care', options: [
            '(1) I have no problems washing or dressing myself',
            '(2) I have slight problems washing or dressing myself',
            '(3) I have moderate problems washing or dressing myself',
            '(4) I have severe problems washing or dressing myself',
            '(5) I am unable to wash or dress myself'
          ], showIf: { field: 'q8_eq5d', value: 'Yes' }},
          { id: 'q11_usual_activities', type: 'likert', label: 'Usual activities', options: [
            '(1) I have no problems doing my usual activities',
            '(2) I have slight problems doing my usual activities',
            '(3) I have moderate problems doing my usual activities',
            '(4) I have severe problems doing my usual activities',
            '(5) I am unable to do my usual activities'
          ], showIf: { field: 'q8_eq5d', value: 'Yes' }},
          { id: 'q12_pain', type: 'likert', label: 'Pain / Discomfort', options: [
            '(1) I have no pain or discomfort',
            '(2) I have slight pain or discomfort',
            '(3) I have moderate pain or discomfort',
            '(4) I have severe pain or discomfort',
            '(5) I have extreme pain or discomfort'
          ], showIf: { field: 'q8_eq5d', value: 'Yes' }},
          { id: 'q13_anxiety', type: 'likert', label: 'Anxiety / Depression', options: [
            '(1) I am not anxious or depressed',
            '(2) I am slightly anxious or depressed',
            '(3) I am moderately anxious or depressed',
            '(4) I am severely anxious or depressed',
            '(5) I am extremely anxious or depressed'
          ], showIf: { field: 'q8_eq5d', value: 'Yes' }},
          { id: 'q14_health_vas', type: 'slider', label: 'Overall health today (0 = worst, 10 = best)', min: 0, max: 10, step: 1, showIf: { field: 'q8_eq5d', value: 'Yes' }}
        ]
      },
      {
        title: 'COMPASS-31',
        questions: [
          { id: 'q15_compass', type: 'radio', label: 'Do you want to fill in COMPASS-31 questionnaire?', required: true, options: [
            { value: 'Yes', label: 'Yes' },
            { value: 'No', label: 'No' }
          ]},
          { id: 'q16_faint', type: 'radio', label: 'In the past year, have you ever felt faint, dizzy, "goofy", or had difficulty thinking soon after standing up from a sitting or lying position?', options: [
            { value: 'Yes', label: 'Yes' },
            { value: 'No', label: 'No' }
          ], showIf: { field: 'q15_compass', value: 'Yes' }},
          { id: 'q17_freq', type: 'radio', label: 'When standing up, how frequently do you get these feelings or symptoms?', options: [
            { value: 'Rarely', label: 'Rarely' },
            { value: 'Occasionally', label: 'Occasionally' },
            { value: 'Frequently', label: 'Frequently' },
            { value: 'Almost Always', label: 'Almost always' }
          ], showIf: { field: 'q16_faint', value: 'Yes' }},
          { id: 'q18_severity', type: 'radio', label: 'How would you rate the severity of these feelings or symptoms?', options: [
            { value: 'Mild', label: 'Mild' },
            { value: 'Moderate', label: 'Moderate' },
            { value: 'Severe', label: 'Severe' }
          ], showIf: { field: 'q16_faint', value: 'Yes' }},
          { id: 'q19_change', type: 'radio', label: 'In the past year, have these feelings or symptoms:', options: [
            { value: 'Much worse', label: 'Gotten much worse' },
            { value: 'Somewhat worse', label: 'Gotten somewhat worse' },
            { value: 'Same', label: 'Stayed about the same' },
            { value: 'Somewhat better', label: 'Gotten somewhat better' },
            { value: 'Much better', label: 'Gotten much better' },
            { value: 'Gone', label: 'Completely gone' }
          ], showIf: { field: 'q16_faint', value: 'Yes' }},
          { id: 'q20_skin', type: 'radio', label: 'In the past year, have you ever noticed color changes in your skin, such as red, white, or purple?', options: [
            { value: 'Yes', label: 'Yes' },
            { value: 'No', label: 'No' }
          ], showIf: { field: 'q15_compass', value: 'Yes' }},
          { id: 'q21_skin_parts', type: 'checkbox', label: 'What parts of your body are affected by these color changes? (Check all that apply)', options: [
            { value: 'Hands', label: 'Hands' },
            { value: 'Feet', label: 'Feet' }
          ], showIf: { field: 'q20_skin', value: 'Yes' }},
          { id: 'q22_skin_change', type: 'radio', label: 'In the past year, have these skin color changes:', options: [
            { value: 'Much worse', label: 'Gotten much worse' },
            { value: 'Somewhat worse', label: 'Gotten somewhat worse' },
            { value: 'Same', label: 'Stayed about the same' },
            { value: 'Somewhat better', label: 'Gotten somewhat better' },
            { value: 'Much better', label: 'Gotten much better' },
            { value: 'Gone', label: 'Completely gone' }
          ], showIf: { field: 'q20_skin', value: 'Yes' }},
          { id: 'q23_dry_eyes', type: 'radio', label: 'Do your eyes feel excessively dry?', options: [
            { value: 'Yes', label: 'Yes' },
            { value: 'No', label: 'No' }
          ], showIf: { field: 'q15_compass', value: 'Yes' }},
          { id: 'q24_dry_mouth', type: 'radio', label: 'Does your mouth feel excessively dry?', options: [
            { value: 'Yes', label: 'Yes' },
            { value: 'No', label: 'No' }
          ], showIf: { field: 'q15_compass', value: 'Yes' }},
          { id: 'q25_light_sensitivity', type: 'radio', label: 'Without sunglasses or tinted glasses, has bright light bothered your eyes in the past year?', options: [
            { value: 'Never', label: 'Never' },
            { value: 'Occasionally', label: 'Occasionally' },
            { value: 'Frequently', label: 'Frequently' },
            { value: 'Constantly', label: 'Constantly' }
          ], showIf: { field: 'q15_compass', value: 'Yes' }},
          { id: 'q26_light_severity', type: 'radio', label: 'How severe is this sensitivity to bright light?', options: [
            { value: 'Mild', label: 'Mild' },
            { value: 'Moderate', label: 'Moderate' },
            { value: 'Severe', label: 'Severe' }
          ], showIf: { field: 'q25_light_sensitivity', value: 'Never' }}
        ]
      },
      {
        title: 'ASRS-v1.1 – Adult ADHD Self-Report Scale',
        questions: [
          { id: 'q36_asrs', type: 'radio', label: 'Do you want to fill in ASRS-v1.1 questionnaire?', options: [
            { value: 'Yes', label: 'Yes' },
            { value: 'No', label: 'No' }
          ], showIf: { field: 'q5_age_group', valueNot: '<18' }},
          { id: 'q37', type: 'radio', label: 'How often do you have trouble wrapping up the final details of a project, once the challenging parts have been done?', options: [
            { value: '0', label: 'Never' },
            { value: '0', label: 'Rarely' },
            { value: '1', label: 'Sometimes' },
            { value: '1', label: 'Often' },
            { value: '1', label: 'Very often' }
          ], showIf: { field: 'q36_asrs', value: 'Yes' }},
          { id: 'q38', type: 'radio', label: 'How often do you have difficulty getting things in order when you have to do a task that requires organization?', options: [
            { value: '0', label: 'Never' },
            { value: '0', label: 'Rarely' },
            { value: '1', label: 'Sometimes' },
            { value: '1', label: 'Often' },
            { value: '1', label: 'Very often' }
          ], showIf: { field: 'q36_asrs', value: 'Yes' }},
          { id: 'q39', type: 'radio', label: 'How often do you have problems remembering appointments or obligations?', options: [
            { value: '0', label: 'Never' },
            { value: '0', label: 'Rarely' },
            { value: '1', label: 'Sometimes' },
            { value: '1', label: 'Often' },
            { value: '1', label: 'Very often' }
          ], showIf: { field: 'q36_asrs', value: 'Yes' }},
          { id: 'q40', type: 'radio', label: 'When you have a task that requires a lot of thought, how often do you avoid or delay getting started?', options: [
            { value: '0', label: 'Never' },
            { value: '0', label: 'Rarely' },
            { value: '0', label: 'Sometimes' },
            { value: '1', label: 'Often' },
            { value: '1', label: 'Very often' }
          ], showIf: { field: 'q36_asrs', value: 'Yes' }},
          { id: 'q41', type: 'radio', label: 'How often do you fidget or squirm with your hands or feet when you have to sit down for a long time?', options: [
            { value: '0', label: 'Never' },
            { value: '0', label: 'Rarely' },
            { value: '0', label: 'Sometimes' },
            { value: '1', label: 'Often' },
            { value: '1', label: 'Very often' }
          ], showIf: { field: 'q36_asrs', value: 'Yes' }},
          { id: 'q42', type: 'radio', label: 'How often do you feel overly active and compelled to do things, like you were driven by a motor?', options: [
            { value: '0', label: 'Never' },
            { value: '0', label: 'Rarely' },
            { value: '0', label: 'Sometimes' },
            { value: '1', label: 'Often' },
            { value: '1', label: 'Very often' }
          ], showIf: { field: 'q36_asrs', value: 'Yes' }},
          { id: 'q43', type: 'radio', label: 'How often do you make careless mistakes when you have to work on a boring or difficult project?', options: [
            { value: '0', label: 'Never' },
            { value: '0', label: 'Rarely' },
            { value: '0', label: 'Sometimes' },
            { value: '1', label: 'Often' },
            { value: '1', label: 'Very often' }
          ], showIf: { field: 'q36_asrs', value: 'Yes' }},
          { id: 'q44', type: 'radio', label: 'How often do you have difficulty keeping your attention when you are doing boring or repetitive work?', options: [
            { value: '0', label: 'Never' },
            { value: '0', label: 'Rarely' },
            { value: '0', label: 'Sometimes' },
            { value: '1', label: 'Often' },
            { value: '1', label: 'Very often' }
          ], showIf: { field: 'q36_asrs', value: 'Yes' }},
          { id: 'q45', type: 'radio', label: 'How often do you have difficulty concentrating on what people say to you, even when they are speaking to you directly?', options: [
            { value: '0', label: 'Never' },
            { value: '0', label: 'Rarely' },
            { value: '1', label: 'Sometimes' },
            { value: '1', label: 'Often' },
            { value: '1', label: 'Very often' }
          ], showIf: { field: 'q36_asrs', value: 'Yes' }},
          { id: 'q46', type: 'radio', label: 'How often do you misplace or have difficulty finding things at home or at work?', options: [
            { value: '0', label: 'Never' },
            { value: '0', label: 'Rarely' },
            { value: '0', label: 'Sometimes' },
            { value: '1', label: 'Often' },
            { value: '1', label: 'Very often' }
          ], showIf: { field: 'q36_asrs', value: 'Yes' }},
          { id: 'q47', type: 'radio', label: 'How often are you distracted by activity or noise around you?', options: [
            { value: '0', label: 'Never' },
            { value: '0', label: 'Rarely' },
            { value: '0', label: 'Sometimes' },
            { value: '1', label: 'Often' },
            { value: '1', label: 'Very often' }
          ], showIf: { field: 'q36_asrs', value: 'Yes' }},
          { id: 'q48', type: 'radio', label: 'How often do you leave your seat in meetings or other situations in which you are expected to remain seated?', options: [
            { value: '0', label: 'Never' },
            { value: '0', label: 'Rarely' },
            { value: '1', label: 'Sometimes' },
            { value: '1', label: 'Often' },
            { value: '1', label: 'Very often' }
          ], showIf: { field: 'q36_asrs', value: 'Yes' }},
          { id: 'q49', type: 'radio', label: 'How often do you feel restless or fidgety?', options: [
            { value: '0', label: 'Never' },
            { value: '0', label: 'Rarely' },
            { value: '0', label: 'Sometimes' },
            { value: '1', label: 'Often' },
            { value: '1', label: 'Very often' }
          ], showIf: { field: 'q36_asrs', value: 'Yes' }},
          { id: 'q50', type: 'radio', label: 'How often do you have difficulty unwinding and relaxing when you have time to yourself?', options: [
            { value: '0', label: 'Never' },
            { value: '0', label: 'Rarely' },
            { value: '0', label: 'Sometimes' },
            { value: '1', label: 'Often' },
            { value: '1', label: 'Very often' }
          ], showIf: { field: 'q36_asrs', value: 'Yes' }},
          { id: 'q51', type: 'radio', label: 'How often do you find yourself talking too much when you are in social situations?', options: [
            { value: '0', label: 'Never' },
            { value: '0', label: 'Rarely' },
            { value: '0', label: 'Sometimes' },
            { value: '1', label: 'Often' },
            { value: '1', label: 'Very often' }
          ], showIf: { field: 'q36_asrs', value: 'Yes' }},
          { id: 'q52', type: 'radio', label: 'When you are in a conversation, how often do you find yourself finishing the sentences of the people you are talking to before they can finish them?', options: [
            { value: '0', label: 'Never' },
            { value: '0', label: 'Rarely' },
            { value: '1', label: 'Sometimes' },
            { value: '1', label: 'Often' },
            { value: '1', label: 'Very often' }
          ], showIf: { field: 'q36_asrs', value: 'Yes' }},
          { id: 'q53', type: 'radio', label: 'How often do you have difficulty waiting your turn in situations when turn taking is required?', options: [
            { value: '0', label: 'Never' },
            { value: '0', label: 'Rarely' },
            { value: '0', label: 'Sometimes' },
            { value: '1', label: 'Often' },
            { value: '1', label: 'Very often' }
          ], showIf: { field: 'q36_asrs', value: 'Yes' }},
          { id: 'q54', type: 'radio', label: 'How often do you interrupt others when they are busy?', options: [
            { value: '0', label: 'Never' },
            { value: '0', label: 'Rarely' },
            { value: '1', label: 'Sometimes' },
            { value: '1', label: 'Often' },
            { value: '1', label: 'Very often' }
          ], showIf: { field: 'q36_asrs', value: 'Yes' }}
        ]
      },
      {
        title: 'DASS-21',
        questions: [
          { id: 'q55_dass', type: 'radio', label: 'Do you want to fill in DASS-21 questionnaire?', options: [
            { value: 'Yes', label: 'Yes' },
            { value: 'No', label: 'No' }
          ]},
          { id: 'q56', type: 'radio', label: '(S) I found it hard to wind down.', options: [
            { value: '0', label: '0 – Did not apply to me at all' },
            { value: '1', label: '1 – Applied to me to some degree, or some of the time' },
            { value: '2', label: '2 – Applied to me to a considerable degree or a good part of the time' },
            { value: '3', label: '3 – Applied to me very much or most of the time' }
          ], showIf: { field: 'q55_dass', value: 'Yes' }},
          { id: 'q57', type: 'radio', label: '(A) I was aware of dryness of my mouth.', options: [
            { value: '0', label: '0 – Did not apply to me at all' },
            { value: '1', label: '1 – Applied to me to some degree, or some of the time' },
            { value: '2', label: '2 – Applied to me to a considerable degree or a good part of the time' },
            { value: '3', label: '3 – Applied to me very much or most of the time' }
          ], showIf: { field: 'q55_dass', value: 'Yes' }}
        ]
      },
      {
        title: 'SNAP-IV (Children)',
        questions: [
          { id: 'q77_snap', type: 'radio', label: 'Do you want to fill in SNAP-IV questionnaire?', options: [
            { value: 'Yes', label: 'Yes' },
            { value: 'No', label: 'No' }
          ]},
          { id: 'q78', type: 'radio', label: 'Fails to give close attention', options: [
            { value: '0', label: '0 – Not at all' },
            { value: '1', label: '1 – Just a little' },
            { value: '2', label: '2 – Quite a bit' },
            { value: '3', label: '3 – Very much' }
          ], showIf: { field: 'q77_snap', value: 'Yes' }},
          { id: 'q79', type: 'radio', label: 'Difficulty sustaining attention', options: [
            { value: '0', label: '0 – Not at all' },
            { value: '1', label: '1 – Just a little' },
            { value: '2', label: '2 – Quite a bit' },
            { value: '3', label: '3 – Very much' }
          ], showIf: { field: 'q77_snap', value: 'Yes' }},
          { id: 'q80', type: 'radio', label: 'Often does not seem to listen when spoken to directly', options: [
            { value: '0', label: '0 – Not at all' },
            { value: '1', label: '1 – Just a little' },
            { value: '2', label: '2 – Quite a bit' },
            { value: '3', label: '3 – Very much' }
          ], showIf: { field: 'q77_snap', value: 'Yes' }},
          { id: 'q81', type: 'radio', label: 'Often does not follow through on instructions and fails to finish work', options: [
            { value: '0', label: '0 – Not at all' },
            { value: '1', label: '1 – Just a little' },
            { value: '2', label: '2 – Quite a bit' },
            { value: '3', label: '3 – Very much' }
          ], showIf: { field: 'q77_snap', value: 'Yes' }},
          { id: 'q82', type: 'radio', label: 'Often has difficulty organizing tasks and activities', options: [
            { value: '0', label: '0 – Not at all' },
            { value: '1', label: '1 – Just a little' },
            { value: '2', label: '2 – Quite a bit' },
            { value: '3', label: '3 – Very much' }
          ], showIf: { field: 'q77_snap', value: 'Yes' }},
          { id: 'q83', type: 'radio', label: 'Often avoids tasks requiring sustained mental effort', options: [
            { value: '0', label: '0 – Not at all' },
            { value: '1', label: '1 – Just a little' },
            { value: '2', label: '2 – Quite a bit' },
            { value: '3', label: '3 – Very much' }
          ], showIf: { field: 'q77_snap', value: 'Yes' }},
          { id: 'q84', type: 'radio', label: 'Often loses things necessary for activities', options: [
            { value: '0', label: '0 – Not at all' },
            { value: '1', label: '1 – Just a little' },
            { value: '2', label: '2 – Quite a bit' },
            { value: '3', label: '3 – Very much' }
          ], showIf: { field: 'q77_snap', value: 'Yes' }},
          { id: 'q85', type: 'radio', label: 'Often is distracted by extraneous stimuli', options: [
            { value: '0', label: '0 – Not at all' },
            { value: '1', label: '1 – Just a little' },
            { value: '2', label: '2 – Quite a bit' },
            { value: '3', label: '3 – Very much' }
          ], showIf: { field: 'q77_snap', value: 'Yes' }},
          { id: 'q86', type: 'radio', label: 'Often is forgetful in daily activities', options: [
            { value: '0', label: '0 – Not at all' },
            { value: '1', label: '1 – Just a little' },
            { value: '2', label: '2 – Quite a bit' },
            { value: '3', label: '3 – Very much' }
          ], showIf: { field: 'q77_snap', value: 'Yes' }},
          { id: 'q87', type: 'radio', label: 'Often fidgets with hands or feet or squirms in seat', options: [
            { value: '0', label: '0 – Not at all' },
            { value: '1', label: '1 – Just a little' },
            { value: '2', label: '2 – Quite a bit' },
            { value: '3', label: '3 – Very much' }
          ], showIf: { field: 'q77_snap', value: 'Yes' }},
          { id: 'q88', type: 'radio', label: 'Often leaves seat in situations where remaining seated is expected', options: [
            { value: '0', label: '0 – Not at all' },
            { value: '1', label: '1 – Just a little' },
            { value: '2', label: '2 – Quite a bit' },
            { value: '3', label: '3 – Very much' }
          ], showIf: { field: 'q77_snap', value: 'Yes' }},
          { id: 'q89', type: 'radio', label: 'Often runs about or climbs excessively', options: [
            { value: '0', label: '0 – Not at all' },
            { value: '1', label: '1 – Just a little' },
            { value: '2', label: '2 – Quite a bit' },
            { value: '3', label: '3 – Very much' }
          ], showIf: { field: 'q77_snap', value: 'Yes' }},
          { id: 'q90', type: 'radio', label: 'Often has difficulty playing quietly', options: [
            { value: '0', label: '0 – Not at all' },
            { value: '1', label: '1 – Just a little' },
            { value: '2', label: '2 – Quite a bit' },
            { value: '3', label: '3 – Very much' }
          ], showIf: { field: 'q77_snap', value: 'Yes' }},
          { id: 'q91', type: 'radio', label: 'Often is "on the go" or driven by a motor', options: [
            { value: '0', label: '0 – Not at all' },
            { value: '1', label: '1 – Just a little' },
            { value: '2', label: '2 – Quite a bit' },
            { value: '3', label: '3 – Very much' }
          ], showIf: { field: 'q77_snap', value: 'Yes' }},
          { id: 'q92', type: 'radio', label: 'Often talks excessively', options: [
            { value: '0', label: '0 – Not at all' },
            { value: '1', label: '1 – Just a little' },
            { value: '2', label: '2 – Quite a bit' },
            { value: '3', label: '3 – Very much' }
          ], showIf: { field: 'q77_snap', value: 'Yes' }},
          { id: 'q93', type: 'radio', label: 'Often blurts out answers', options: [
            { value: '0', label: '0 – Not at all' },
            { value: '1', label: '1 – Just a little' },
            { value: '2', label: '2 – Quite a bit' },
            { value: '3', label: '3 – Very much' }
          ], showIf: { field: 'q77_snap', value: 'Yes' }},
          { id: 'q94', type: 'radio', label: 'Often has difficulty awaiting turn', options: [
            { value: '0', label: '0 – Not at all' },
            { value: '1', label: '1 – Just a little' },
            { value: '2', label: '2 – Quite a bit' },
            { value: '3', label: '3 – Very much' }
          ], showIf: { field: 'q77_snap', value: 'Yes' }},
          { id: 'q95', type: 'radio', label: 'Often interrupts or intrudes on others', options: [
            { value: '0', label: '0 – Not at all' },
            { value: '1', label: '1 – Just a little' },
            { value: '2', label: '2 – Quite a bit' },
            { value: '3', label: '3 – Very much' }
          ], showIf: { field: 'q77_snap', value: 'Yes' }},
          { id: 'q96', type: 'radio', label: 'Often loses temper', options: [
            { value: '0', label: '0 – Not at all' },
            { value: '1', label: '1 – Just a little' },
            { value: '2', label: '2 – Quite a bit' },
            { value: '3', label: '3 – Very much' }
          ], showIf: { field: 'q77_snap', value: 'Yes' }},
          { id: 'q97', type: 'radio', label: 'Often argues with adults', options: [
            { value: '0', label: '0 – Not at all' },
            { value: '1', label: '1 – Just a little' },
            { value: '2', label: '2 – Quite a bit' },
            { value: '3', label: '3 – Very much' }
          ], showIf: { field: 'q77_snap', value: 'Yes' }},
          { id: 'q98', type: 'radio', label: 'Often actively defies adult requests or rules', options: [
            { value: '0', label: '0 – Not at all' },
            { value: '1', label: '1 – Just a little' },
            { value: '2', label: '2 – Quite a bit' },
            { value: '3', label: '3 – Very much' }
          ], showIf: { field: 'q77_snap', value: 'Yes' }},
          { id: 'q99', type: 'radio', label: 'Often deliberately annoys other people', options: [
            { value: '0', label: '0 – Not at all' },
            { value: '1', label: '1 – Just a little' },
            { value: '2', label: '2 – Quite a bit' },
            { value: '3', label: '3 – Very much' }
          ], showIf: { field: 'q77_snap', value: 'Yes' }},
          { id: 'q100', type: 'radio', label: 'Often blames others for mistakes or misbehaviour', options: [
            { value: '0', label: '0 – Not at all' },
            { value: '1', label: '1 – Just a little' },
            { value: '2', label: '2 – Quite a bit' },
            { value: '3', label: '3 – Very much' }
          ], showIf: { field: 'q77_snap', value: 'Yes' }},
          { id: 'q101', type: 'radio', label: 'Often is touchy or easily annoyed', options: [
            { value: '0', label: '0 – Not at all' },
            { value: '1', label: '1 – Just a little' },
            { value: '2', label: '2 – Quite a bit' },
            { value: '3', label: '3 – Very much' }
          ], showIf: { field: 'q77_snap', value: 'Yes' }},
          { id: 'q102', type: 'radio', label: 'Often is angry and resentful', options: [
            { value: '0', label: '0 – Not at all' },
            { value: '1', label: '1 – Just a little' },
            { value: '2', label: '2 – Quite a bit' },
            { value: '3', label: '3 – Very much' }
          ], showIf: { field: 'q77_snap', value: 'Yes' }},
          { id: 'q103', type: 'radio', label: 'Often is spiteful or vindictive', options: [
            { value: '0', label: '0 – Not at all' },
            { value: '1', label: '1 – Just a little' },
            { value: '2', label: '2 – Quite a bit' },
            { value: '3', label: '3 – Very much' }
          ], showIf: { field: 'q77_snap', value: 'Yes' }}
        ]
      }
    ]
  },
  stroke_tbi: {
    title: 'After Stroke / TBI Assessment',
    sections: [
      {
        title: 'General Data',
        questions: [
          { id: 'q5_age_group', type: 'radio', label: 'Patient Age *', required: true, options: [
            { value: '<18', label: '< 18' },
            { value: '18-25', label: '18-25' },
            { value: '26-35', label: '26-35' },
            { value: '36-45', label: '36-45' },
            { value: '46-55', label: '46-55' },
            { value: '56-65', label: '56-65' },
            { value: '>65', label: '> 65' }
          ]},
          { id: 'q6_gender', type: 'radio', label: 'Gender *', required: true, options: [
            { value: 'male', label: 'Male' },
            { value: 'female', label: 'Female' },
            { value: 'nonbinary', label: 'Non-binary' }
          ]},
          { id: 'q7_visit_type', type: 'radio', label: 'Visit Type *', required: true, options: [
            { value: 'first', label: 'First visit' },
            { value: 'f1', label: 'Follow-up visit 1' },
            { value: 'f2', label: 'Follow-up visit 2' },
            { value: 'f3', label: 'Follow-up visit 3' }
          ]}
        ]
      },
      {
        title: 'COMPASS-31',
        questions: [
          { id: 'c9_consent', type: 'radio', label: 'Do you want to fill in COMPASS-31 questionnaire?', required: true, options: [
            { value: 'Yes', label: 'Yes' },
            { value: 'No', label: 'No' }
          ]},
          { id: 'c10_faint', type: 'radio', label: 'In the past year, have you ever felt faint, dizzy, goofy, or had difficulty thinking soon after standing up from a sitting or lying position?', options: [
            { value: 'Yes', label: 'Yes' },
            { value: 'No', label: 'No' }
          ], showIf: { field: 'c9_consent', value: 'Yes' }},
          { id: 'c11_frequency', type: 'radio', label: 'When standing up, how frequently do you get these feelings or symptoms?', options: [
            { value: 'Rarely', label: 'Rarely' },
            { value: 'Occasionally', label: 'Occasionally' },
            { value: 'Frequently', label: 'Frequently' },
            { value: 'Almost Always', label: 'Almost Always' }
          ], showIf: { field: 'c10_faint', value: 'Yes' }},
          { id: 'c12_severity', type: 'radio', label: 'How would you rate the severity of these feelings or symptoms?', options: [
            { value: 'Mild', label: 'Mild' },
            { value: 'Moderate', label: 'Moderate' },
            { value: 'Severe', label: 'Severe' }
          ], showIf: { field: 'c10_faint', value: 'Yes' }},
          { id: 'c13_progression', type: 'radio', label: 'In the past year, have these feelings or symptoms that you have experienced:', options: [
            { value: 'Much worse', label: 'Gotten much worse' },
            { value: 'Somewhat worse', label: 'Gotten somewhat worse' },
            { value: 'Same', label: 'Stayed about the same' },
            { value: 'Somewhat better', label: 'Gotten somewhat better' },
            { value: 'Gone', label: 'Gotten much better / Completely gone' }
          ], showIf: { field: 'c10_faint', value: 'Yes' }},
          { id: 'c14_skin_color', type: 'radio', label: 'In the past year, have you ever noticed color changes in your skin, such as red, white, or purple?', options: [
            { value: 'Yes', label: 'Yes' },
            { value: 'No', label: 'No' }
          ], showIf: { field: 'c9_consent', value: 'Yes' }},
          { id: 'c15_body_parts', type: 'radio', label: 'What parts of your body are affected by these color changes?', options: [
            { value: 'Hands', label: 'Hands' },
            { value: 'Feet', label: 'Feet' }
          ], showIf: { field: 'c14_skin_color', value: 'Yes' }},
          { id: 'c16_skin_change_progress', type: 'radio', label: 'Are these changes in your skin color:', options: [
            { value: 'Much worse', label: 'Getting much worse' },
            { value: 'Somewhat worse', label: 'Getting somewhat worse' },
            { value: 'Same', label: 'Staying about the same' },
            { value: 'Somewhat better', label: 'Getting somewhat better' },
            { value: 'Gone', label: 'Getting much better / Completely gone' }
          ], showIf: { field: 'c14_skin_color', value: 'Yes' }},
          { id: 'c17_dry_eyes', type: 'radio', label: 'Do your eyes feel excessively dry?', options: [
            { value: 'Yes', label: 'Yes' },
            { value: 'No', label: 'No' }
          ], showIf: { field: 'c9_consent', value: 'Yes' }},
          { id: 'c18_dry_mouth', type: 'radio', label: 'Does your mouth feel excessively dry?', options: [
            { value: 'Yes', label: 'Yes' },
            { value: 'No', label: 'No' }
          ], showIf: { field: 'c9_consent', value: 'Yes' }},
          { id: 'c19_early_full', type: 'radio', label: 'In the past year, have you noticed any changes in how quickly you get full when eating a meal?', options: [
            { value: 'Much quicker', label: 'I get full a lot more quickly now' },
            { value: 'Quicker', label: 'I get full more quickly now' },
            { value: 'No change', label: 'I have not noticed any change' },
            { value: 'Slower', label: 'I get full less quickly now' },
            { value: 'Much slower', label: 'I get full a lot less quickly now' }
          ], showIf: { field: 'c9_consent', value: 'Yes' }},
          { id: 'c20_diarrhea', type: 'radio', label: 'In the past year, have you had any bouts of diarrhea?', options: [
            { value: 'Yes', label: 'Yes' },
            { value: 'No', label: 'No' }
          ], showIf: { field: 'c9_consent', value: 'Yes' }},
          { id: 'c21_diarrhea_freq', type: 'radio', label: 'How frequently does this occur?', options: [
            { value: 'Rarely', label: 'Rarely' },
            { value: 'Occasionally', label: 'Occasionally' },
            { value: 'Frequently', label: 'Frequently' },
            { value: 'Constantly', label: 'Constantly' }
          ], showIf: { field: 'c20_diarrhea', value: 'Yes' }},
          { id: 'c22_bladder_control', type: 'radio', label: 'In the past year, have you ever lost control of your bladder function?', options: [
            { value: 'Never', label: 'Never' },
            { value: 'Occasionally', label: 'Occasionally' },
            { value: 'Frequently', label: 'Frequently' },
            { value: 'Constantly', label: 'Constantly' }
          ], showIf: { field: 'c9_consent', value: 'Yes' }}
        ]
      },
      {
        title: 'KPS – Karnofsky Performance Status Scale',
        questions: [
          { id: 'kps_consent', type: 'radio', label: 'Do you want to fill in KPS questionnaire?', options: [
            { value: 'Yes', label: 'Yes' },
            { value: 'No', label: 'No' }
          ]},
          { id: 'kps_score', type: 'radio', label: 'Select the statement that best describes the patient\'s condition', options: [
            { value: '100', label: '(100%) Normal; no complaints; no evidence of disease' },
            { value: '90', label: '(90%) Able to carry on normal activity; minor signs or symptoms of disease' },
            { value: '80', label: '(80%) Normal activity with effort; some signs or symptoms of disease' },
            { value: '70', label: '(70%) Cares for self; unable to carry on normal activity or active work' },
            { value: '60', label: '(60%) Requires occasional assistance but able to care for most needs' },
            { value: '50', label: '(50%) Requires considerable assistance and frequent medical care' },
            { value: '40', label: '(40%) Disabled; requires special care and assistance' },
            { value: '30', label: '(30%) Severely disabled; hospital admission indicated' },
            { value: '20', label: '(20%) Very sick; hospital admission necessary' },
            { value: '10', label: '(10%) Moribund; fatal processes progressing rapidly' },
            { value: '0', label: '(0%) Dead' }
          ], showIf: { field: 'kps_consent', value: 'Yes' }}
        ]
      },
      {
        title: 'SS-QOL – Stroke Specific Quality of Life',
        questions: [
          { id: 'ssqol_consent', type: 'radio', label: 'Do you want to fill in SS-QOL questionnaire?', options: [
            { value: 'Yes', label: 'Yes' },
            { value: 'No', label: 'No' }
          ]},
          { id: 'ssqol_40', type: 'radio', label: 'I felt tired most of the time', options: [
            { value: '1', label: '1 – Strongly agree' },
            { value: '2', label: '2 – Moderately agree' },
            { value: '3', label: '3 – Neither agree nor disagree' },
            { value: '4', label: '4 – Moderately disagree' },
            { value: '5', label: '5 – Strongly disagree' }
          ], showIf: { field: 'ssqol_consent', value: 'Yes' }},
          { id: 'ssqol_41', type: 'radio', label: 'I had to stop and rest during the day', options: [
            { value: '1', label: '1 – Strongly agree' },
            { value: '2', label: '2 – Moderately agree' },
            { value: '3', label: '3 – Neither agree nor disagree' },
            { value: '4', label: '4 – Moderately disagree' },
            { value: '5', label: '5 – Strongly disagree' }
          ], showIf: { field: 'ssqol_consent', value: 'Yes' }},
          { id: 'ssqol_46', type: 'radio', label: 'Did you have trouble speaking?', options: [
            { value: '1', label: '1 – Couldn\'t do it at all' },
            { value: '2', label: '2 – A lot of trouble' },
            { value: '3', label: '3 – Some trouble' },
            { value: '4', label: '4 – A little trouble' },
            { value: '5', label: '5 – No trouble at all' }
          ], showIf: { field: 'ssqol_consent', value: 'Yes' }}
        ]
      },
      {
        title: 'MAS – Modified Ashworth Scale',
        questions: [
          { id: 'mas_consent', type: 'radio', label: 'Do you want to fill in MAS questionnaire?', options: [
            { value: 'Yes', label: 'Yes' },
            { value: 'No', label: 'No' }
          ]},
          { id: 'mas_left_hand_flexors', type: 'radio', label: 'Left hand flexors', options: [
            { value: '0', label: '0 – No increase in muscle tone' },
            { value: '1', label: '1 – Slight increase (catch and release)' },
            { value: '1.5', label: '1+ – Catch followed by minimal resistance' },
            { value: '2', label: '2 – Marked increase through most ROM' },
            { value: '3', label: '3 – Considerable increase, movement difficult' },
            { value: '4', label: '4 – Rigid in flexion or extension' }
          ], showIf: { field: 'mas_consent', value: 'Yes' }},
          { id: 'mas_right_hand_flexors', type: 'radio', label: 'Right hand flexors', options: [
            { value: '0', label: '0 – No increase in muscle tone' },
            { value: '1', label: '1 – Slight increase (catch and release)' },
            { value: '1.5', label: '1+ – Catch followed by minimal resistance' },
            { value: '2', label: '2 – Marked increase through most ROM' },
            { value: '3', label: '3 – Considerable increase, movement difficult' },
            { value: '4', label: '4 – Rigid in flexion or extension' }
          ], showIf: { field: 'mas_consent', value: 'Yes' }}
        ]
      },
      {
        title: 'MRC – Medical Research Council Scale',
        questions: [
          { id: 'mrc_consent', type: 'radio', label: 'Do you want to fill in MRC questionnaire?', options: [
            { value: 'Yes', label: 'Yes' },
            { value: 'No', label: 'No' }
          ]},
          { id: 'mrc_knee_extensors_right', type: 'radio', label: 'Knee extensors – Right', options: [
            { value: '5', label: '5 – Normal strength' },
            { value: '4', label: '4 – Movement against resistance' },
            { value: '3', label: '3 – Movement against gravity' },
            { value: '2', label: '2 – Movement but not against gravity' },
            { value: '1', label: '1 – Flicker of contraction' },
            { value: '0', label: '0 – No contraction' }
          ], showIf: { field: 'mrc_consent', value: 'Yes' }},
          { id: 'mrc_knee_extensors_left', type: 'radio', label: 'Knee extensors – Left', options: [
            { value: '5', label: '5 – Normal strength' },
            { value: '4', label: '4 – Movement against resistance' },
            { value: '3', label: '3 – Movement against gravity' },
            { value: '2', label: '2 – Movement but not against gravity' },
            { value: '1', label: '1 – Flicker of contraction' },
            { value: '0', label: '0 – No contraction' }
          ], showIf: { field: 'mrc_consent', value: 'Yes' }}
        ]
      },
      {
        title: 'MoCA – Montreal Cognitive Assessment',
        questions: [
          { id: 'moca_consent', type: 'radio', label: 'Do you want to fill in MOCA questionnaire?', required: true, options: [
            { value: 'Yes', label: 'Yes' },
            { value: 'No', label: 'No' }
          ]},
          { id: 'moca_total_score', type: 'slider', label: 'Calculated sum of all subscores from MoCA test (0–30)', min: 0, max: 30, step: 1, required: true, showIf: { field: 'moca_consent', value: 'Yes' }},
          { id: 'moca_education_adjustment', type: 'radio', label: 'Education adjustment (add 1 point if ≤12 years of formal education)', options: [
            { value: '1', label: 'Yes – Add 1 point' },
            { value: '0', label: 'No – Do not add' }
          ], showIf: { field: 'moca_consent', value: 'Yes' }},
          { id: 'moca_final_score', type: 'slider', label: 'Final MoCA score after education adjustment (0–30)', min: 0, max: 30, step: 1, showIf: { field: 'moca_consent', value: 'Yes' }}
        ]
      },
      {
        title: 'Barthel Index',
        questions: [
          { id: 'barthel_consent', type: 'radio', label: 'Do you want to fill in Barthel Index questionnaire?', options: [
            { value: 'Yes', label: 'Yes' },
            { value: 'No', label: 'No' }
          ]},
          { id: 'barthel_92_feeding', type: 'radio', label: 'Feeding', options: [
            { value: '0', label: '0 – Unable' },
            { value: '5', label: '5 – Needs help cutting/spreading or modified diet' },
            { value: '10', label: '10 – Independent' }
          ], showIf: { field: 'barthel_consent', value: 'Yes' }},
          { id: 'barthel_93_bathing', type: 'radio', label: 'Bathing', options: [
            { value: '0', label: '0 – Dependent' },
            { value: '5', label: '5 – Independent (face or shower)' }
          ], showIf: { field: 'barthel_consent', value: 'Yes' }},
          { id: 'barthel_94_grooming', type: 'radio', label: 'Grooming', options: [
            { value: '0', label: '0 – Needs help with personal care' },
            { value: '5', label: '5 – Independent (implements provided)' }
          ], showIf: { field: 'barthel_consent', value: 'Yes' }},
          { id: 'barthel_95_dressing', type: 'radio', label: 'Dressing', options: [
            { value: '0', label: '0 – Dependent' },
            { value: '5', label: '5 – Needs help but can do about half unaided' },
            { value: '10', label: '10 – Independent (buttons, zips, laces)' }
          ], showIf: { field: 'barthel_consent', value: 'Yes' }},
          { id: 'barthel_96_bowels', type: 'radio', label: 'Bowels', options: [
            { value: '0', label: '0 – Incontinent or needs enemas' },
            { value: '5', label: '5 – Occasional accident' },
            { value: '10', label: '10 – Continent' }
          ], showIf: { field: 'barthel_consent', value: 'Yes' }},
          { id: 'barthel_97_bladder', type: 'radio', label: 'Bladder', options: [
            { value: '0', label: '0 – Incontinent or catheterized and unable to manage' },
            { value: '5', label: '5 – Occasional accident' },
            { value: '10', label: '10 – Continent' }
          ], showIf: { field: 'barthel_consent', value: 'Yes' }},
          { id: 'barthel_98_toilet', type: 'radio', label: 'Toilet Use', options: [
            { value: '0', label: '0 – Dependent' },
            { value: '5', label: '5 – Needs some help' },
            { value: '10', label: '10 – Independent' }
          ], showIf: { field: 'barthel_consent', value: 'Yes' }},
          { id: 'barthel_99_transfers', type: 'radio', label: 'Transfers (Bed to chair and back)', options: [
            { value: '0', label: '0 – Unable, no sitting balance' },
            { value: '5', label: '5 – Major help, can sit' },
            { value: '10', label: '10 – Minor help' },
            { value: '15', label: '15 – Independent' }
          ], showIf: { field: 'barthel_consent', value: 'Yes' }},
          { id: 'barthel_100_mobility', type: 'radio', label: 'Mobility (on level surfaces)', options: [
            { value: '0', label: '0 – Immobile or <50 yards' },
            { value: '5', label: '5 – Wheelchair independent >50 yards' },
            { value: '10', label: '10 – Walks with help >50 yards' },
            { value: '15', label: '15 – Independent >50 yards (may use aid)' }
          ], showIf: { field: 'barthel_consent', value: 'Yes' }},
          { id: 'barthel_101_stairs', type: 'radio', label: 'Stairs', options: [
            { value: '0', label: '0 – Unable' },
            { value: '5', label: '5 – Needs help' },
            { value: '10', label: '10 – Independent' }
          ], showIf: { field: 'barthel_consent', value: 'Yes' }}
        ]
      },
      {
        title: 'PainDETECT',
        questions: [
          { id: 'paindetect_consent', type: 'radio', label: 'Do you want to fill in PainDETECT questionnaire?', options: [
            { value: 'Yes', label: 'Yes' },
            { value: 'No', label: 'No' }
          ]},
          { id: 'paindetect_103_now', type: 'slider', label: 'How would you assess your pain now, at this moment?', min: 0, max: 10, step: 1, showIf: { field: 'paindetect_consent', value: 'Yes' }},
          { id: 'paindetect_104_max', type: 'slider', label: 'How strong was the strongest pain during the past 4 weeks?', min: 0, max: 10, step: 1, showIf: { field: 'paindetect_consent', value: 'Yes' }},
          { id: 'paindetect_105_avg', type: 'slider', label: 'How strong was the pain during the past 4 weeks on average?', min: 0, max: 10, step: 1, showIf: { field: 'paindetect_consent', value: 'Yes' }},
          { id: 'paindetect_106_radiate', type: 'radio', label: 'Does your pain radiate to other regions of your body?', options: [
            { value: '2', label: 'Yes' },
            { value: '0', label: 'No' }
          ], showIf: { field: 'paindetect_consent', value: 'Yes' }},
          { id: 'paindetect_107_burning', type: 'radio', label: 'Burning sensation (e.g., stinging nettles)', options: [
            { value: '0', label: '0 – Never' },
            { value: '1', label: '1 – Hardly noticed' },
            { value: '2', label: '2 – Slightly' },
            { value: '3', label: '3 – Moderately' },
            { value: '4', label: '4 – Strongly' },
            { value: '5', label: '5 – Very strongly' }
          ], showIf: { field: 'paindetect_consent', value: 'Yes' }},
          { id: 'paindetect_108_tingling', type: 'radio', label: 'Tingling or prickling sensation', options: [
            { value: '0', label: '0 – Never' },
            { value: '1', label: '1 – Hardly noticed' },
            { value: '2', label: '2 – Slightly' },
            { value: '3', label: '3 – Moderately' },
            { value: '4', label: '4 – Strongly' },
            { value: '5', label: '5 – Very strongly' }
          ], showIf: { field: 'paindetect_consent', value: 'Yes' }},
          { id: 'paindetect_109_touch', type: 'radio', label: 'Pain from light touch (clothing, blanket)', options: [
            { value: '0', label: '0 – Never' },
            { value: '1', label: '1 – Hardly noticed' },
            { value: '2', label: '2 – Slightly' },
            { value: '3', label: '3 – Moderately' },
            { value: '4', label: '4 – Strongly' },
            { value: '5', label: '5 – Very strongly' }
          ], showIf: { field: 'paindetect_consent', value: 'Yes' }},
          { id: 'paindetect_110_shocks', type: 'radio', label: 'Sudden pain attacks like electric shocks', options: [
            { value: '0', label: '0 – Never' },
            { value: '1', label: '1 – Hardly noticed' },
            { value: '2', label: '2 – Slightly' },
            { value: '3', label: '3 – Moderately' },
            { value: '4', label: '4 – Strongly' },
            { value: '5', label: '5 – Very strongly' }
          ], showIf: { field: 'paindetect_consent', value: 'Yes' }},
          { id: 'paindetect_111_temp', type: 'radio', label: 'Pain from cold or heat', options: [
            { value: '0', label: '0 – Never' },
            { value: '1', label: '1 – Hardly noticed' },
            { value: '2', label: '2 – Slightly' },
            { value: '3', label: '3 – Moderately' },
            { value: '4', label: '4 – Strongly' },
            { value: '5', label: '5 – Very strongly' }
          ], showIf: { field: 'paindetect_consent', value: 'Yes' }},
          { id: 'paindetect_112_numb', type: 'radio', label: 'Numbness in painful areas', options: [
            { value: '0', label: '0 – Never' },
            { value: '1', label: '1 – Hardly noticed' },
            { value: '2', label: '2 – Slightly' },
            { value: '3', label: '3 – Moderately' },
            { value: '4', label: '4 – Strongly' },
            { value: '5', label: '5 – Very strongly' }
          ], showIf: { field: 'paindetect_consent', value: 'Yes' }},
          { id: 'paindetect_113_pressure', type: 'radio', label: 'Pain triggered by slight pressure', options: [
            { value: '0', label: '0 – Never' },
            { value: '1', label: '1 – Hardly noticed' },
            { value: '2', label: '2 – Slightly' },
            { value: '3', label: '3 – Moderately' },
            { value: '4', label: '4 – Strongly' },
            { value: '5', label: '5 – Very strongly' }
          ], showIf: { field: 'paindetect_consent', value: 'Yes' }}
        ]
      }
    ]
  }
};

function renderPRSLanding() {
  const area = document.getElementById('contentArea');
  const patientContext = globalState.prsPatientContext || {};
  const hasPatient = patientContext.patientId && globalSelectedPatientId;
  
  area.innerHTML = `
    <div class="p-8">
    
    ${getAssessmentNavigation('prs')}
    
    ${hasPatient ? `
    <!-- Patient Navigation Section -->
    <div class="card p-4 mb-6 bg-gradient-to-r from-orange-50 to-orange-100 border-l-4 border-l-green-600">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <i class="fa-solid fa-users text-sozo-600 text-xl"></i>
          <div>
            <label class="text-xs font-bold text-slate-900 uppercase mb-1 block">Navigate to Patient</label>
            <select id="patientNavigationSelectPRS" class="input-royal pr-10 font-bold border-orange-300 text-sozo-600 focus:border-sozo-600 focus:ring-green-500">
              ${sampleData.patients.map(pt => `
                <option value="${pt.id}" ${pt.id === globalSelectedPatientId ? 'selected' : ''}>${pt.name} (${pt.id})</option>
              `).join('')}
            </select>
          </div>
        </div>
        <button onclick="loadSection('patienthistory')" class="btn-secondary text-sm">
          <i class="fa-solid fa-arrow-left mr-2"></i>Back to Patient History
        </button>
      </div>
    </div>
    ` : ''}
    
    <div class="flex flex-col gap-6">
      <div class="flex items-center justify-between">
        <div>
          <h2 class="text-3xl font-black text-slate-900">PRS Assessment</h2>
          <p class="text-slate-600 mt-1">Select a condition to start your assessment</p>
        </div>
        <button onclick="loadSection('finalreport')" class="bg-sozo-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-sozo-700 transition">
          Next: Final Report <i class="fa-solid fa-arrow-right ml-2"></i>
        </button>
      </div>

      <div class="grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
        ${PRS_CONDITIONS.map(cond => `
          <div onclick="renderPRSForm('${cond.id}')" class="card p-6 border border-slate-200 hover:shadow-xl hover:-translate-y-1 transition text-left group cursor-pointer">
            <div class="flex items-start justify-between mb-4">
              <div class="w-12 h-12 rounded-lg bg-gradient-to-br ${cond.color} flex items-center justify-center text-white text-xl group-hover:scale-110 transition">
                <i class="fa-solid ${cond.icon}"></i>
              </div>
              <i class="fa-solid fa-arrow-right text-slate-300 group-hover:text-sozo-600 transition"></i>
            </div>
            <h3 class="font-bold text-slate-900 text-sm">${cond.label}</h3>
            <p class="text-xs text-slate-500 mt-2">Click to begin assessment</p>
          </div>
        `).join('')}
      </div>
    </div>
    </div>
  `;
  
  // Add event listener for patient navigation
  setTimeout(() => {
    const patientNavSelectPRS = document.getElementById('patientNavigationSelectPRS');
    if (patientNavSelectPRS) {
      patientNavSelectPRS.addEventListener('change', (e) => {
        const patientId = e.target.value;
        if (patientId) {
          const patient = sampleData.patients.find(p => p.id === patientId);
          if (patient) {
            globalSelectedPatientId = patient.id;
            globalState.currentPatient = patient;
            // Reload the PRS page with new patient
            renderPRSDoctor();
          }
        }
      });
    }
  }, 50);
}

function renderPRSForm(conditionId) {
  const p = getActivePatient();
  const config = PRS_QUESTIONNAIRES[conditionId];
  if (!config) return;

  const area = document.getElementById('contentArea');
  const conditionLabel = PRS_CONDITIONS.find(c => c.id === conditionId)?.label || 'Assessment';

  // Helper function to check if question should be shown based on conditional logic
  const shouldShowQuestion = (q, formElement) => {
    if (!q.showIf) return true;
    if (!formElement) return true;
    
    const dependentField = formElement.elements[q.showIf.field];
    if (!dependentField) return true;
    
    let currentValue = '';
    if (dependentField.type === 'radio') {
      const checked = formElement.querySelector(`input[name="${q.showIf.field}"]:checked`);
      currentValue = checked ? checked.value : '';
    } else if (dependentField.type === 'checkbox') {
      currentValue = dependentField.checked ? dependentField.value : '';
    } else {
      currentValue = dependentField.value;
    }
    
    // Handle valueNot condition (show if value is NOT the specified value)
    if (q.showIf.valueNot !== undefined) {
      return currentValue !== q.showIf.valueNot;
    }
    
    return currentValue === q.showIf.value;
  };

  // Helper function to render questions inline
  const renderQuestionHTML = (q, condId) => {
    const conditionalClass = q.showIf ? `data-show-if-field="${q.showIf.field}" data-show-if-value="${q.showIf.value || ''}" data-show-if-not="${q.showIf.valueNot || ''}"` : '';
    const hiddenClass = q.showIf ? ' hidden' : '';
    
    if (q.type === 'radio') {
      return `
        <div class="question-wrapper${hiddenClass}" data-question-id="${q.id}" ${conditionalClass}>
          <label class="text-sm font-bold text-slate-900">${q.label}${q.required ? ' *' : ''}</label>
          <div class="flex flex-wrap gap-3 mt-2">
            ${q.options.map(opt => `
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" name="${q.id}" value="${opt.value}" class="w-4 h-4 accent-sozo-600" ${q.required && !q.showIf ? 'required' : ''} onchange="updateConditionalQuestions()" />
                <span class="text-sm text-slate-700">${opt.label}</span>
              </label>
            `).join('')}
          </div>
        </div>
      `;
    } else if (q.type === 'slider') {
      return `
        <div class="question-wrapper${hiddenClass}" data-question-id="${q.id}" ${conditionalClass}>
          <label class="text-sm font-bold text-slate-900 flex items-center justify-between">
            <span>${q.label}${q.required ? ' *' : ''}</span>
            <span id="slider-value-${q.id}" class="text-sozo-600 font-bold text-lg">5</span>
          </label>
          <input type="range" id="${q.id}" name="${q.id}" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-sozo-600 mt-2" min="${q.min}" max="${q.max}" value="5" ${q.required && !q.showIf ? 'required' : ''} oninput="document.getElementById('slider-value-${q.id}').innerText = this.value; updateConditionalQuestions();" />
          <div class="flex justify-between text-xs text-slate-500 mt-2">
            <span>${q.min}</span>
            <span>${q.max}</span>
          </div>
        </div>
      `;
    } else if (q.type === 'number') {
      return `
        <div class="question-wrapper${hiddenClass}" data-question-id="${q.id}" ${conditionalClass}>
          <label class="text-sm font-bold text-slate-900">${q.label}${q.required ? ' *' : ''}</label>
          <input type="number" id="${q.id}" name="${q.id}" class="input-royal mt-2" min="0" max="10" ${q.required && !q.showIf ? 'required' : ''} onchange="updateConditionalQuestions()" />
        </div>
      `;
    } else if (q.type === 'text') {
      return `
        <div class="question-wrapper${hiddenClass}" data-question-id="${q.id}" ${conditionalClass}>
          <label class="text-sm font-bold text-slate-900">${q.label}${q.required ? ' *' : ''}</label>
          <input type="text" id="${q.id}" name="${q.id}" class="input-royal mt-2" ${q.required && !q.showIf ? 'required' : ''} onchange="updateConditionalQuestions()" />
        </div>
      `;
    } else if (q.type === 'email') {
      return `
        <div class="question-wrapper${hiddenClass}" data-question-id="${q.id}" ${conditionalClass}>
          <label class="text-sm font-bold text-slate-900">${q.label}${q.required ? ' *' : ''}</label>
          <input type="email" id="${q.id}" name="${q.id}" class="input-royal mt-2" ${q.required && !q.showIf ? 'required' : ''} onchange="updateConditionalQuestions()" />
        </div>
      `;
    } else if (q.type === 'date') {
      return `
        <div class="question-wrapper${hiddenClass}" data-question-id="${q.id}" ${conditionalClass}>
          <label class="text-sm font-bold text-slate-900">${q.label}${q.required ? ' *' : ''}</label>
          <input type="date" id="${q.id}" name="${q.id}" class="input-royal mt-2" ${q.required && !q.showIf ? 'required' : ''} onchange="updateConditionalQuestions()" />
        </div>
      `;
    } else if (q.type === 'likert') {
      return `
        <div class="question-wrapper${hiddenClass}" data-question-id="${q.id}" ${conditionalClass}>
          <label class="text-sm font-bold text-slate-900">${q.label}${q.required ? ' *' : ''}</label>
          <div class="flex gap-1 mt-2 flex-wrap">
            ${q.options.map((opt, idx) => `
              <label class="flex items-center gap-2 cursor-pointer flex-1 min-w-32">
                <input type="radio" name="${q.id}" value="${idx}" class="w-4 h-4 accent-sozo-600" ${q.required && !q.showIf ? 'required' : ''} onchange="updateConditionalQuestions()" />
                <span class="text-xs text-slate-700 leading-tight">${opt}</span>
              </label>
            `).join('')}
          </div>
        </div>
      `;
    } else if (q.type === 'checkbox') {
      if (q.options) {
        // Multiple checkbox options
        return `
          <div class="question-wrapper${hiddenClass}" data-question-id="${q.id}" ${conditionalClass}>
            <label class="text-sm font-bold text-slate-900 mb-2 block">${q.label}${q.required ? ' *' : ''}</label>
            ${q.options.map(opt => `
              <label class="flex items-center gap-3 cursor-pointer mb-2">
                <input type="checkbox" name="${q.id}" value="${opt.value}" class="w-5 h-5 accent-sozo-600" onchange="updateConditionalQuestions()" />
                <span class="text-sm text-slate-700">${opt.label}</span>
              </label>
            `).join('')}
          </div>
        `;
      } else {
        // Single checkbox
        return `
          <div class="question-wrapper${hiddenClass}" data-question-id="${q.id}" ${conditionalClass}>
            <label class="flex items-center gap-3 cursor-pointer">
              <input type="checkbox" id="${q.id}" name="${q.id}" class="w-5 h-5 accent-sozo-600" onchange="updateConditionalQuestions()" />
              <span class="text-sm font-bold text-slate-900">${q.label}</span>
            </label>
          </div>
        `;
      }
    }
    return '';
  };

  area.innerHTML = `
    <div class="p-8">
    <div class="flex flex-col gap-6">
      <button onclick="renderPRSLanding()" class="inline-flex items-center gap-2 text-sozo-600 font-bold hover:text-sozo-700 w-fit">
        <i class="fa-solid fa-arrow-left"></i> Back to Conditions
      </button>

      <form id="prsForm" class="flex flex-col gap-6">
        <!-- Header Card -->
        <div class="card p-6 border border-slate-200">
          <h2 class="text-2xl font-black text-slate-900">${config.title}</h2>
          <p class="text-slate-600 mt-1">Patient Assessment Form</p>
        </div>

        <!-- Patient Info Card -->
        <div class="card p-6 border border-slate-200 bg-gradient-to-r from-blue-50 to-white">
          <h3 class="font-bold text-slate-900 mb-2">Patient Information</h3>
          <p class="text-xs text-slate-500 mb-4"><i class="fa-solid fa-circle-info"></i> Auto-populated from FNON Assessment</p>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-xs font-bold text-slate-500 uppercase">Doctor Name <span class="badge badge-success text-xs ml-2"></span></label>
              <input type="text" id="doctorName" class="input-royal bg-slate-100" value="${globalState.sessionData.doctor?.name || globalState.currentDoctor.name}" readonly />
            </div>
            <div>
              <label class="text-xs font-bold text-slate-500 uppercase">Doctor Email <span class="badge badge-success text-xs ml-2"></span></label>
              <input type="email" id="doctorEmail" class="input-royal bg-slate-100" value="${globalState.sessionData.doctor?.email || globalState.currentDoctor.email}" readonly />
            </div>
            <div>
              <div class="flex items-center justify-between mb-2">
                <label class="text-xs font-bold text-slate-500 uppercase">Patient Name <span class="badge badge-success text-xs ml-2"></span></label>
                <button type="button" class="editPatientField bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 rounded text-sm font-bold transition" data-field="patientName" title="Edit Patient Name"><i class="fa-solid fa-pen-to-square mr-1"></i>Edit</button>
              </div>
              <input type="text" id="patientName" class="input-royal bg-slate-100" value="${globalState.sessionData.patient?.name || p.name}" readonly />
            </div>
            <div>
              <div class="flex items-center justify-between mb-2">
                <label class="text-xs font-bold text-slate-500 uppercase">Patient Email <span class="badge badge-success text-xs ml-2"></span></label>
                <button type="button" class="editPatientField bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 rounded text-sm font-bold transition" data-field="patientEmail" title="Edit Patient Email"><i class="fa-solid fa-pen-to-square mr-1"></i>Edit</button>
              </div>
              <input type="email" id="patientEmail" class="input-royal bg-slate-100" value="${globalState.sessionData.patient?.email || p.email || ''}" readonly />
            </div>
            <div>
              <div class="flex items-center justify-between mb-2">
                <label class="text-xs font-bold text-slate-500 uppercase">Patient Country <span class="badge badge-success text-xs ml-2"></span></label>
                <button type="button" class="editPatientField bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 rounded text-sm font-bold transition" data-field="patientCountry" title="Edit Patient Country"><i class="fa-solid fa-pen-to-square mr-1"></i>Edit</button>
              </div>
              <input type="text" id="patientCountry" class="input-royal bg-slate-100" value="${globalState.sessionData.patient?.country || p.country || 'N/A'}" readonly />
            </div>
            <div>
              <div class="flex items-center justify-between mb-2">
                <label class="text-xs font-bold text-slate-500 uppercase">Patient ID <span class="badge badge-success text-xs ml-2"></span></label>
                <button type="button" class="editPatientField bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 rounded text-sm font-bold transition" data-field="patientId" title="Edit Patient ID"><i class="fa-solid fa-pen-to-square mr-1"></i>Edit</button>
              </div>
              <input type="text" id="patientId" class="input-royal bg-slate-100" value="${globalState.sessionData.patient?.id || p.id}" readonly />
            </div>
            <div>
              <label class="text-xs font-bold text-slate-500 uppercase">Condition *</label>
              <select id="conditionSelect" class="input-royal">
                <option value="${conditionId}" selected>${conditionLabel}</option>
                ${PRS_CONDITIONS.filter(c => c.id !== conditionId).map(c => `<option value="${c.id}">${c.label}</option>`).join('')}
              </select>
            </div>
            <div>
              <label class="text-xs font-bold text-slate-500 uppercase">Date of Assessment</label>
              <input type="date" id="assessmentDate" class="input-royal" value="${new Date().toISOString().split('T')[0]}" />
            </div>
          </div>
        </div>

        <!-- Vital Signs Card -->
        <div class="card p-6 border border-slate-200 bg-gradient-to-r from-orange-50 to-white">
          <h3 class="font-bold text-slate-900 mb-4"><i class="fa-solid fa-heartbeat mr-2"></i>Vital Signs</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div>
              <label class="text-xs font-bold text-slate-500 uppercase">Weight (kg)</label>
              <input type="number" id="vitalWeight" class="input-royal" placeholder="e.g., 70" step="0.1" value="72" />
            </div>
            <div>
              <label class="text-xs font-bold text-slate-500 uppercase">Blood Pressure (Systolic)</label>
              <input type="number" id="vitalBPSystolic" class="input-royal" placeholder="e.g., 120" value="128" />
            </div>
            <div>
              <label class="text-xs font-bold text-slate-500 uppercase">Blood Pressure (Diastolic)</label>
              <input type="number" id="vitalBPDiastolic" class="input-royal" placeholder="e.g., 80" value="82" />
            </div>
            <div>
              <label class="text-xs font-bold text-slate-500 uppercase">Heart Rate (bpm)</label>
              <input type="number" id="vitalHeartRate" class="input-royal" placeholder="e.g., 72" value="76" />
            </div>
            <div>
              <label class="text-xs font-bold text-slate-500 uppercase">Temperature (°C)</label>
              <input type="number" id="vitalTemperature" class="input-royal" placeholder="e.g., 36.6" step="0.1" value="36.8" />
            </div>
            <div>
              <label class="text-xs font-bold text-slate-500 uppercase">Respiratory Rate (bpm)</label>
              <input type="number" id="vitalRespiratoryRate" class="input-royal" placeholder="e.g., 16" value="18" />
            </div>
            <div>
              <label class="text-xs font-bold text-slate-500 uppercase">Oxygen Saturation (%)</label>
              <input type="number" id="vitalOxygenSat" class="input-royal" placeholder="e.g., 98" min="0" max="100" value="98" />
            </div>
            <div>
              <label class="text-xs font-bold text-slate-500 uppercase">Height (cm)</label>
              <input type="number" id="vitalHeight" class="input-royal" placeholder="e.g., 170" value="175" />
            </div>
            <div>
              <label class="text-xs font-bold text-slate-500 uppercase">Blood Group</label>
              <select id="vitalBloodGroup" class="input-royal">
                <option value="">Select Blood Group</option>
                <option value="O+" selected>O+ (O Positive)</option>
                <option value="A+">A+ (A Positive)</option>
                <option value="B+">B+ (B Positive)</option>
                <option value="AB+">AB+ (AB Positive)</option>
                <option value="O-">O- (O Negative)</option>
                <option value="A-">A- (A Negative)</option>
                <option value="B-">B- (B Negative)</option>
                <option value="AB-">AB- (AB Negative)</option>
              </select>
            </div>
          </div>
        </div>

        ${currentRole === 'admin' ? `
        <!-- Custom PRS Fields Management (Admin Only) -->
        <div class="card p-6 border border-slate-200 bg-gradient-to-r from-slate-50 to-white border-l-4 border-l-slate-600">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold text-slate-900"><i class="fa-solid fa-sliders mr-2"></i>Custom Assessment Questions Management</h3>
            <button type="button" id="addPRSField_${conditionId}" class="bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-sozo-700 transition">
              <i class="fa-solid fa-plus mr-2"></i>Add Custom Question
            </button>
          </div>
          <div id="customPRSFields_${conditionId}" class="space-y-3">
            <p class="text-sm text-slate-500 italic">No custom questions added yet. Click "Add Custom Question" to create one.</p>
          </div>
        </div>
        ` : ''}

        <!-- Question Sections -->
        ${config.sections.map((section, sectionIdx) => `
          <div id="section-${sectionIdx}" class="card p-6 border border-slate-200">
            <h3 class="font-bold text-slate-900 mb-4">${section.title}</h3>
            <div class="space-y-6">
              ${section.questions.map(q => renderQuestionHTML(q, conditionId)).join('')}
            </div>
          </div>
        `).join('')}

        <!-- Custom Questions Section (if any exist) -->
        ${(() => {
          const customFields = globalState.customPRSFields?.[conditionId] || [];
          if (customFields.length === 0) return '';
          
          const questionsHTML = customFields.map((field, idx) => {
            let inputHTML = '';
            if (field.type === 'text') {
              inputHTML = '<input type="text" id="customPRS_' + conditionId + '_' + idx + '" name="customPRS_' + conditionId + '_' + idx + '" class="input-royal w-full" placeholder="' + (field.placeholder || 'Enter answer...') + '" />';
            } else if (field.type === 'number') {
              inputHTML = '<input type="number" id="customPRS_' + conditionId + '_' + idx + '" name="customPRS_' + conditionId + '_' + idx + '" class="input-royal w-full" placeholder="' + (field.placeholder || 'Enter value...') + '" step="0.01" />';
            } else if (field.type === 'slider') {
              inputHTML = '<div class="flex items-center gap-4"><input type="range" id="customPRS_' + conditionId + '_' + idx + '" name="customPRS_' + conditionId + '_' + idx + '" class="flex-1 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-sozo-600" min="0" max="10" value="5" oninput="document.getElementById(\'customSliderValue_' + idx + '\').innerText = this.value" /><span id="customSliderValue_' + idx + '" class="text-sozo-600 font-bold text-lg w-8 text-center">5</span></div><div class="flex justify-between text-xs text-slate-500 mt-1"><span>0</span><span>10</span></div>';
            } else if (field.type === 'textarea') {
              inputHTML = '<textarea id="customPRS_' + conditionId + '_' + idx + '" name="customPRS_' + conditionId + '_' + idx + '" class="input-royal w-full min-h-24" placeholder="' + (field.placeholder || 'Enter detailed answer...') + '"></textarea>';
            }

            return '<div><label class="text-sm font-bold text-slate-900 block mb-2">' + field.label + '</label>' + inputHTML + '</div>';
          }).join('');
          
          return `
            <div class="card p-6 border border-slate-200 bg-gradient-to-r from-slate-50 to-white border-l-4 border-l-slate-600">
              <div class="flex items-center gap-2 mb-4">
                <i class="fa-solid fa-star text-sozo-600"></i>
                <h3 class="font-bold text-slate-900">Additional Assessment Questions</h3>
              </div>
              <div class="space-y-6">
                ${questionsHTML}
              </div>
            </div>
          `;
        })()}

        <!-- Submit Button -->
        <div class="flex items-center gap-3 flex-wrap justify-between">
          <div class="flex items-center gap-3 flex-wrap">
            <button type="submit" id="prsSubmit" class="bg-gradient-to-r from-sozo-600 to-orange-500 text-white px-6 py-3 rounded-lg font-bold hover:shadow-lg transition disabled:opacity-50">
              Submit Assessment
            </button>
            <button type="button" id="prsResetBtn" class="bg-slate-200 text-slate-700 px-6 py-3 rounded-lg font-bold hover:bg-slate-300 transition">
              Reset Answers
            </button>
            <button type="reset" onclick="renderPRSLanding()" class="bg-slate-200 text-slate-700 px-6 py-3 rounded-lg font-bold hover:bg-slate-300 transition">
              Cancel
            </button>
          </div>
          <button type="button" onclick="loadSection('finalreport')" class="bg-sozo-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-sozo-700 transition">
            Next: Final Report <i class="fa-solid fa-arrow-right ml-2"></i>
          </button>
        </div>
      </form>
    </div>
    </div>
  `;

  // Attach event listeners after form is rendered
  setTimeout(() => {
    attachPRSFormListeners(conditionId);
    updateConditionalQuestions(); // Initialize conditional logic
  }, 50);
}

function renderQuestion(q, conditionId) {
  if (q.type === 'radio') {
    return `
      <div>
        <label class="text-sm font-bold text-slate-900">${q.label}${q.required ? ' *' : ''}</label>
        <div class="flex flex-wrap gap-3 mt-2">
          ${q.options.map(opt => `
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" name="${q.id}" value="${opt.value}" class="w-4 h-4 accent-sozo-600" ${q.required ? 'required' : ''} />
              <span class="text-sm text-slate-700">${opt.label}</span>
            </label>
          `).join('')}
        </div>
      </div>
    `;
  } else if (q.type === 'slider') {
    return `
      <div>
        <label class="text-sm font-bold text-slate-900 flex items-center justify-between">
          <span>${q.label}${q.required ? ' *' : ''}</span>
          <span id="slider-value-${q.id}" class="text-sozo-600 font-bold text-lg">5</span>
        </label>
        <input type="range" id="${q.id}" name="${q.id}" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-sozo-600 mt-2" min="${q.min}" max="${q.max}" value="5" ${q.required ? 'required' : ''} oninput="document.getElementById('slider-value-${q.id}').innerText = this.value" />
        <div class="flex justify-between text-xs text-slate-500 mt-2">
          <span>${q.min}</span>
          <span>${q.max}</span>
        </div>
      </div>
    `;
  } else if (q.type === 'likert') {
    return `
      <div>
        <label class="text-sm font-bold text-slate-900">${q.label}${q.required ? ' *' : ''}</label>
        <div class="flex gap-1 mt-2 flex-wrap">
          ${q.options.map((opt, idx) => `
            <label class="flex items-center gap-2 cursor-pointer flex-1 min-w-32">
              <input type="radio" name="${q.id}" value="${idx}" class="w-4 h-4 accent-sozo-600" ${q.required ? 'required' : ''} />
              <span class="text-xs text-slate-700 leading-tight">${opt}</span>
            </label>
          `).join('')}
        </div>
      </div>
    `;
  } else if (q.type === 'checkbox') {
    return `
      <div>
        <label class="flex items-center gap-3 cursor-pointer">
          <input type="checkbox" id="${q.id}" name="${q.id}" class="w-5 h-5 accent-sozo-600" onchange="toggleConditionalSections()" />
          <span class="text-sm font-bold text-slate-900">${q.label}</span>
        </label>
      </div>
    `;
  }
  return '';
}

// Function to update visibility of conditional questions
function updateConditionalQuestions() {
  const form = document.getElementById('prsForm');
  if (!form) return;

  // Get all questions with conditional logic
  const conditionalQuestions = form.querySelectorAll('[data-show-if-field]');
  
  conditionalQuestions.forEach(questionWrapper => {
    const dependentField = questionWrapper.dataset.showIfField;
    const expectedValue = questionWrapper.dataset.showIfValue;
    const notValue = questionWrapper.dataset.showIfNot;
    const questionId = questionWrapper.dataset.questionId;
    
    // Get the current value of the dependent field
    let currentValue = '';
    const fieldElement = form.elements[dependentField];
    
    if (!fieldElement) return;
    
    if (fieldElement.type === 'radio') {
      const checked = form.querySelector(`input[name="${dependentField}"]:checked`);
      currentValue = checked ? checked.value : '';
    } else if (fieldElement.type === 'checkbox') {
      currentValue = fieldElement.checked ? (fieldElement.value || 'yes') : '';
    } else if (fieldElement.length && fieldElement[0].type === 'radio') {
      // Handle NodeList of radio buttons
      const checked = Array.from(fieldElement).find(el => el.checked);
      currentValue = checked ? checked.value : '';
    } else {
      currentValue = fieldElement.value;
    }
    
    // Determine if question should be shown
    let shouldShow = false;
    if (notValue) {
      // Show if current value is NOT the specified value
      shouldShow = currentValue !== notValue;
    } else if (expectedValue) {
      // Show if current value matches expected value
      shouldShow = currentValue === expectedValue;
    }
    
    // Show or hide the question
    if (shouldShow) {
      questionWrapper.classList.remove('hidden');
      // Make required if needed
      const inputs = questionWrapper.querySelectorAll('input, select, textarea');
      inputs.forEach(input => {
        if (input.dataset.originalRequired === 'true') {
          input.setAttribute('required', 'required');
        }
      });
    } else {
      questionWrapper.classList.add('hidden');
      // Remove required attribute when hidden
      const inputs = questionWrapper.querySelectorAll('input, select, textarea');
      inputs.forEach(input => {
        if (input.hasAttribute('required')) {
          input.dataset.originalRequired = 'true';
          input.removeAttribute('required');
        }
        // Clear values when hidden
        if (input.type === 'radio' || input.type === 'checkbox') {
          input.checked = false;
        } else {
          input.value = '';
        }
      });
    }
  });
}

// [Deprecated - moved inline into renderPRSForm]

function attachPRSFormListeners(conditionId) {
  const form = document.getElementById('prsForm');
  if (!form) return;

  // Initialize custom PRS fields for this condition if not exists
  if (!globalState.customPRSFields[conditionId]) {
    globalState.customPRSFields[conditionId] = [];
  }

  // Custom PRS Fields Management (Admin Only)
  const addPRSFieldBtn = document.getElementById(`addPRSField_${conditionId}`);
  const customPRSFieldsContainer = document.getElementById(`customPRSFields_${conditionId}`);

  function renderCustomPRSFields() {
    if (!customPRSFieldsContainer) return; // Skip if not admin
    const fields = globalState.customPRSFields[conditionId] || [];
    if (fields.length === 0) {
      customPRSFieldsContainer.innerHTML = '<p class="text-sm text-slate-500 italic">No custom questions added yet. Click "Add Custom Question" to create one.</p>';
    } else {
      customPRSFieldsContainer.innerHTML = fields.map((field, idx) => {
        let inputHTML = '';
        if (field.type === 'text') {
          inputHTML = `<input type="text" id="customPRS_${conditionId}_${idx}" name="customPRS_${conditionId}_${idx}" class="input-royal w-full" placeholder="${field.placeholder || 'Enter answer...'}" />`;
        } else if (field.type === 'number') {
          inputHTML = `<input type="number" id="customPRS_${conditionId}_${idx}" name="customPRS_${conditionId}_${idx}" class="input-royal w-full" placeholder="${field.placeholder || 'Enter value...'}" step="0.01" />`;
        } else if (field.type === 'slider') {
          inputHTML = `
            <div class="flex items-center gap-4">
              <input type="range" id="customPRS_${conditionId}_${idx}" name="customPRS_${conditionId}_${idx}" class="flex-1 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-sozo-600" min="0" max="10" value="5" oninput="document.getElementById('customSlider_${idx}').innerText = this.value" />
              <span id="customSlider_${idx}" class="text-sozo-600 font-bold text-lg w-8 text-center">5</span>
            </div>
            <div class="flex justify-between text-xs text-slate-500 mt-1">
              <span>0</span>
              <span>10</span>
            </div>
          `;
        } else if (field.type === 'textarea') {
          inputHTML = `<textarea id="customPRS_${conditionId}_${idx}" name="customPRS_${conditionId}_${idx}" class="input-royal w-full min-h-24" placeholder="${field.placeholder || 'Enter detailed answer...'}"></textarea>`;
        }

        return `
          <div class="bg-white p-4 rounded-lg border border-slate-200">
            <div class="flex items-start gap-4">
              <div class="flex-1">
                <label class="text-sm font-bold text-slate-900 block mb-2">${field.label}</label>
                ${inputHTML}
              </div>
              <div class="flex gap-2">
                <button type="button" class="editCustomPRSField text-blue-600 hover:text-blue-800 font-bold p-2" data-index="${idx}" title="Edit Question">
                  <i class="fa-solid fa-edit"></i>
                </button>
                <button type="button" class="deleteCustomPRSField text-slate-600 hover:text-slate-700 font-bold p-2" data-index="${idx}" title="Remove Question">
                  <i class="fa-solid fa-trash"></i>
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');

      // Attach event listeners for edit and delete
      document.querySelectorAll('.editCustomPRSField').forEach(btn => {
        btn.addEventListener('click', function() {
          const idx = parseInt(this.dataset.index);
          const field = globalState.customPRSFields[conditionId][idx];
          
          // Create edit modal
          const modal = document.createElement('div');
          modal.className = 'modal';
          modal.innerHTML = `
            <div class="modal-content max-w-2xl">
              <div class="bg-gradient-to-r from-blue-600 to-brand-blue text-white p-6 rounded-t-2xl">
                <h3 class="text-2xl font-bold"><i class="fa-solid fa-edit mr-2"></i>Edit Custom Question</h3>
                <p class="text-sm text-blue-100 mt-1">Modify the existing question</p>
              </div>
              
              <div class="p-6 space-y-4">
                <div>
                  <label class="block text-sm font-bold text-slate-800 mb-2">
                    Question Label <span class="text-slate-600">*</span>
                  </label>
                  <input type="text" id="editQuestionLabel" class="input-royal w-full" 
                         value="${field.label.replace(/"/g, '&quot;')}" 
                         autofocus />
                </div>

                <div>
                  <label class="block text-sm font-bold text-slate-800 mb-2">
                    Question Type <span class="text-slate-600">*</span>
                  </label>
                  <div class="grid grid-cols-2 gap-3">
                    <label class="cursor-pointer">
                      <input type="radio" name="editQuestionType" value="text" class="hidden peer" ${field.type === 'text' ? 'checked' : ''} />
                      <div class="p-4 border-2 border-slate-200 rounded-lg peer-checked:border-blue-600 peer-checked:bg-blue-50 transition hover:border-blue-400">
                        <i class="fa-solid fa-keyboard text-2xl text-slate-600 mb-2"></i>
                        <p class="font-bold text-sm text-slate-800">Text</p>
                        <p class="text-xs text-slate-500">Short answer</p>
                      </div>
                    </label>
                    
                    <label class="cursor-pointer">
                      <input type="radio" name="editQuestionType" value="number" class="hidden peer" ${field.type === 'number' ? 'checked' : ''} />
                      <div class="p-4 border-2 border-slate-200 rounded-lg peer-checked:border-blue-600 peer-checked:bg-blue-50 transition hover:border-blue-400">
                        <i class="fa-solid fa-hashtag text-2xl text-slate-600 mb-2"></i>
                        <p class="font-bold text-sm text-slate-800">Number</p>
                        <p class="text-xs text-slate-500">Numeric value</p>
                      </div>
                    </label>
                    
                    <label class="cursor-pointer">
                      <input type="radio" name="editQuestionType" value="slider" class="hidden peer" ${field.type === 'slider' ? 'checked' : ''} />
                      <div class="p-4 border-2 border-slate-200 rounded-lg peer-checked:border-blue-600 peer-checked:bg-blue-50 transition hover:border-blue-400">
                        <i class="fa-solid fa-sliders text-2xl text-slate-600 mb-2"></i>
                        <p class="font-bold text-sm text-slate-800">Slider</p>
                        <p class="text-xs text-slate-500">0-10 scale</p>
                      </div>
                    </label>
                    
                    <label class="cursor-pointer">
                      <input type="radio" name="editQuestionType" value="textarea" class="hidden peer" ${field.type === 'textarea' ? 'checked' : ''} />
                      <div class="p-4 border-2 border-slate-200 rounded-lg peer-checked:border-blue-600 peer-checked:bg-blue-50 transition hover:border-blue-400">
                        <i class="fa-solid fa-align-left text-2xl text-slate-600 mb-2"></i>
                        <p class="font-bold text-sm text-slate-800">Textarea</p>
                        <p class="text-xs text-slate-500">Long answer</p>
                      </div>
                    </label>
                  </div>
                </div>

                <div>
                  <label class="block text-sm font-bold text-slate-800 mb-2">
                    Placeholder Text (Optional)
                  </label>
                  <input type="text" id="editQuestionPlaceholder" class="input-royal w-full" 
                         value="${(field.placeholder || '').replace(/"/g, '&quot;')}" />
                </div>
              </div>

              <div class="bg-slate-50 px-6 py-4 rounded-b-2xl flex justify-end gap-3">
                <button id="cancelEditQuestion" class="btn-secondary">
                  <i class="fa-solid fa-times mr-2"></i>Cancel
                </button>
                <button id="saveEditQuestion" class="btn-primary bg-gradient-to-r from-blue-600 to-brand-blue">
                  <i class="fa-solid fa-check mr-2"></i>Update Question
                </button>
              </div>
            </div>
          `;
          
          document.body.appendChild(modal);

          // Handle cancel
          document.getElementById('cancelEditQuestion').addEventListener('click', () => {
            modal.remove();
          });

          // Handle save
          document.getElementById('saveEditQuestion').addEventListener('click', () => {
            const label = document.getElementById('editQuestionLabel').value.trim();
            if (!label) {
              alert('Please enter a question label');
              return;
            }

            const typeRadio = document.querySelector('input[name="editQuestionType"]:checked');
            const fieldType = typeRadio ? typeRadio.value : field.type;
            
            let placeholder = document.getElementById('editQuestionPlaceholder').value.trim();

            globalState.customPRSFields[conditionId][idx] = {
              label: label,
              type: fieldType,
              placeholder: placeholder || field.placeholder
            };

            renderCustomPRSFields();
            modal.remove();
            
            // Show success message
            const successMsg = document.createElement('div');
            successMsg.className = 'fixed bottom-4 right-4 bg-blue-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-3';
            successMsg.innerHTML = `
              <i class="fa-solid fa-check-circle text-xl"></i>
              <span class="font-bold">Question updated successfully!</span>
            `;
            document.body.appendChild(successMsg);
            setTimeout(() => successMsg.remove(), 3000);
          });

          // Close modal on background click
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              modal.remove();
            }
          });
        });
      });

      document.querySelectorAll('.deleteCustomPRSField').forEach(btn => {
        btn.addEventListener('click', function() {
          const idx = parseInt(this.dataset.index);
          if (confirm('Remove this custom question?')) {
            globalState.customPRSFields[conditionId].splice(idx, 1);
            renderCustomPRSFields();
          }
        });
      });
    }
  }

  if (addPRSFieldBtn) {
    addPRSFieldBtn.addEventListener('click', () => {
      // Create modal for adding custom question
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-content max-w-2xl">
          <div class="bg-gradient-to-r from-sozo-600 to-orange-500 text-white p-6 rounded-t-2xl">
            <h3 class="text-2xl font-bold"><i class="fa-solid fa-plus-circle mr-2"></i>Add Custom Question</h3>
            <p class="text-sm text-orange-100 mt-1">Create a new assessment question for this condition</p>
          </div>
          
          <div class="p-6 space-y-4">
            <div>
              <label class="block text-sm font-bold text-slate-800 mb-2">
                Question Label <span class="text-slate-600">*</span>
              </label>
              <input type="text" id="customQuestionLabel" class="input-royal w-full" 
                     placeholder="e.g., How often do you experience symptoms?" 
                     autofocus />
              <p class="text-xs text-slate-500 mt-1">This will be displayed as the question text</p>
            </div>

            <div>
              <label class="block text-sm font-bold text-slate-800 mb-2">
                Question Type <span class="text-slate-600">*</span>
              </label>
              <div class="grid grid-cols-2 gap-3">
                <label class="cursor-pointer">
                  <input type="radio" name="customQuestionType" value="text" class="hidden peer" checked />
                  <div class="p-4 border-2 border-slate-200 rounded-lg peer-checked:border-sozo-600 peer-checked:bg-orange-50 transition hover:border-sozo-400">
                    <i class="fa-solid fa-keyboard text-2xl text-slate-600 mb-2"></i>
                    <p class="font-bold text-sm text-slate-800">Text</p>
                    <p class="text-xs text-slate-500">Short answer input</p>
                  </div>
                </label>
                
                <label class="cursor-pointer">
                  <input type="radio" name="customQuestionType" value="number" class="hidden peer" />
                  <div class="p-4 border-2 border-slate-200 rounded-lg peer-checked:border-sozo-600 peer-checked:bg-orange-50 transition hover:border-sozo-400">
                    <i class="fa-solid fa-hashtag text-2xl text-slate-600 mb-2"></i>
                    <p class="font-bold text-sm text-slate-800">Number</p>
                    <p class="text-xs text-slate-500">Numeric value</p>
                  </div>
                </label>
                
                <label class="cursor-pointer">
                  <input type="radio" name="customQuestionType" value="slider" class="hidden peer" />
                  <div class="p-4 border-2 border-slate-200 rounded-lg peer-checked:border-sozo-600 peer-checked:bg-orange-50 transition hover:border-sozo-400">
                    <i class="fa-solid fa-sliders text-2xl text-slate-600 mb-2"></i>
                    <p class="font-bold text-sm text-slate-800">Slider</p>
                    <p class="text-xs text-slate-500">0-10 scale</p>
                  </div>
                </label>
                
                <label class="cursor-pointer">
                  <input type="radio" name="customQuestionType" value="textarea" class="hidden peer" />
                  <div class="p-4 border-2 border-slate-200 rounded-lg peer-checked:border-sozo-600 peer-checked:bg-orange-50 transition hover:border-sozo-400">
                    <i class="fa-solid fa-align-left text-2xl text-slate-600 mb-2"></i>
                    <p class="font-bold text-sm text-slate-800">Textarea</p>
                    <p class="text-xs text-slate-500">Long answer</p>
                  </div>
                </label>
              </div>
            </div>

            <div>
              <label class="block text-sm font-bold text-slate-800 mb-2">
                Placeholder Text (Optional)
              </label>
              <input type="text" id="customQuestionPlaceholder" class="input-royal w-full" 
                     placeholder="e.g., Enter your answer here..." />
              <p class="text-xs text-slate-500 mt-1">Helpful hint text shown in the input field</p>
            </div>
          </div>

          <div class="bg-slate-50 px-6 py-4 rounded-b-2xl flex justify-end gap-3">
            <button id="cancelCustomQuestion" class="btn-secondary">
              <i class="fa-solid fa-times mr-2"></i>Cancel
            </button>
            <button id="saveCustomQuestion" class="btn-primary">
              <i class="fa-solid fa-check mr-2"></i>Add Question
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);

      // Handle cancel
      document.getElementById('cancelCustomQuestion').addEventListener('click', () => {
        modal.remove();
      });

      // Handle save
      document.getElementById('saveCustomQuestion').addEventListener('click', () => {
        const label = document.getElementById('customQuestionLabel').value.trim();
        if (!label) {
          alert('Please enter a question label');
          return;
        }

        const typeRadio = document.querySelector('input[name="customQuestionType"]:checked');
        const fieldType = typeRadio ? typeRadio.value : 'text';
        
        let placeholder = document.getElementById('customQuestionPlaceholder').value.trim();
        if (!placeholder) {
          placeholder = fieldType === 'number' ? 'Enter numeric value...' : 
                       fieldType === 'slider' ? '' :
                       fieldType === 'textarea' ? 'Enter detailed answer...' :
                       'Enter answer...';
        }

        globalState.customPRSFields[conditionId].push({
          label: label,
          type: fieldType,
          placeholder: placeholder
        });

        renderCustomPRSFields();
        modal.remove();
        
        // Show success message
        const successMsg = document.createElement('div');
        successMsg.className = 'fixed bottom-4 right-4 bg-sozo-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-3';
        successMsg.innerHTML = `
          <i class="fa-solid fa-check-circle text-xl"></i>
          <span class="font-bold">Custom question added successfully!</span>
        `;
        document.body.appendChild(successMsg);
        setTimeout(() => successMsg.remove(), 3000);
      });

      // Close modal on background click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });
    });
  }

  if (customPRSFieldsContainer) {
    renderCustomPRSFields();
  }

  form.addEventListener('submit', (e) => {
    e.preventDefault();
    handlePRSSubmit(conditionId);
  });

  // Show/hide conditional sections based on checkbox
  const eq5dCheckbox = form.querySelector('[name="eq5d_consent"]');
  if (eq5dCheckbox) {
    eq5dCheckbox.addEventListener('change', toggleConditionalSections);
  }

  const resetBtn = document.getElementById('prsResetBtn');
  if(resetBtn) {
    resetBtn.addEventListener('click', () => {
      form.reset();
      form.querySelectorAll('input[type="range"]').forEach(r => {
        r.value = 5;
        const label = document.getElementById(`slider-value-${r.id}`);
        if(label) label.textContent = r.value;
      });
      setProgress('prs', 'in-progress');
    });
  }
}

function toggleConditionalSections() {
  const eq5dCheckbox = document.querySelector('[name="eq5d_consent"]');
  const config = PRS_QUESTIONNAIRES[Object.keys(PRS_QUESTIONNAIRES)[0]]; // Get first config
  
  if (eq5dCheckbox && eq5dCheckbox.checked) {
    document.querySelectorAll('[id^="section-"]').forEach(section => {
      section.style.display = 'block';
    });
  }
}

// Notification Dropdown Functions
function toggleNotifications(event) {
  event.stopPropagation();
  const dropdown = document.getElementById('notificationsDropdown');
  dropdown.classList.toggle('hidden');
}

function markAllRead() {
  alert('All notifications marked as read');
  // You can add logic here to update notification states
  const allNotifs = document.querySelectorAll('[data-notification-item]');
  allNotifs.forEach(n => n.classList.add('opacity-60'));
}

// Patient notifications data
const PATIENT_NOTIFICATIONS = [
  {
    id: 1,
    title: 'Appointment Reminder',
    time: '2 hours ago',
    date: 'Jan 28, 2026',
    description: 'Your follow-up consultation with Dr. Michael Torres is tomorrow at 10:00 AM',
    details: 'Please arrive 15 minutes early to complete any necessary paperwork. The appointment will be held via Telemedicine (Virtual). Make sure you have a stable internet connection.',
    icon: 'fa-calendar-check',
    color: 'blue',
    read: false,
    type: 'appointment'
  },
  {
    id: 2,
    title: 'Pending Assessment',
    time: '1 day ago',
    date: 'Jan 26, 2026',
    description: 'Please complete your PRS Assessment - Insomnia (65% complete)',
    details: 'This assessment is crucial for developing your personalized treatment plan. You have 3 days remaining to complete it. Click "Continue Assessment" to resume where you left off.',
    icon: 'fa-clipboard-list',
    color: 'orange',
    read: false,
    type: 'assessment',
    action: 'Continue Assessment',
    actionFn: 'openSpecificPRSForm(\'insomnia\')'
  },
  {
    id: 3,
    title: 'New Message from Dr. Watson',
    time: '3 days ago',
    date: 'Jan 24, 2026',
    description: 'Your latest brain mapping results are ready',
    details: 'Dr. Emily Watson has reviewed your brain mapping session results and left you a detailed message. The results show positive progress in the targeted areas. Please review the full report in your medical history.',
    icon: 'fa-message',
    color: 'green',
    read: false,
    type: 'message',
    action: 'View Message',
    actionFn: 'loadSection(\'messages\')'
  },
  {
    id: 5,
    title: 'Treatment Plan Updated',
    time: '1 week ago',
    date: 'Jan 20, 2026',
    description: 'Your treatment plan has been updated by Dr. Torres',
    details: 'Dr. Michael Torres has made adjustments to your treatment protocol based on your recent progress. The new plan includes modified session frequencies and updated protocols. Please review the changes in your treatment plan section.',
    icon: 'fa-file-medical',
    color: 'green',
    read: true,
    type: 'treatment'
  },
  {
    id: 6,
    title: 'Payment Receipt',
    time: '2 weeks ago',
    date: 'Jan 13, 2026',
    description: 'Payment received for TMS Session Package',
    details: 'Thank you for your payment of €1,200 for the 10-session TMS treatment package. Your receipt has been sent to your registered email address. You can view and download all payment receipts in the billing section.',
    icon: 'fa-receipt',
    color: 'blue',
    read: true,
    type: 'billing'
  },
  {
    id: 7,
    title: 'New Device Recommendation',
    time: '2 weeks ago',
    date: 'Jan 12, 2026',
    description: 'Dr. Torres recommended a tDCS device for home use',
    details: 'Based on your treatment progress, Dr. Torres has recommended the tDCS (Transcranial Direct Current Stimulation) device for supplemental home therapy. This device can enhance your treatment outcomes. View details in the E-Shop.',
    icon: 'fa-laptop-medical',
    color: 'green',
    read: true,
    type: 'recommendation',
    action: 'View in E-Shop',
    actionFn: 'loadSection(\'eshop\')'
  }
];

// Open full window notifications view
function openNotificationsFullWindow() {
  // Close dropdown first
  const dropdown = document.getElementById('notificationsDropdown');
  if (dropdown) dropdown.classList.add('hidden');
  
  const area = document.getElementById('contentArea');
  const unreadCount = PATIENT_NOTIFICATIONS.filter(n => !n.read).length;
  
  const colorClasses = {
    blue: { bg: 'bg-blue-50', border: 'border-l-blue-500', iconBg: 'bg-blue-100', iconText: 'text-blue-600', btnBg: 'bg-blue-600', btnHover: 'hover:bg-blue-700' },
    orange: { bg: 'bg-orange-50', border: 'border-l-orange-500', iconBg: 'bg-orange-100', iconText: 'text-orange-600', btnBg: 'bg-orange-600', btnHover: 'hover:bg-orange-700' },
    green: { bg: 'bg-orange-50', border: 'border-l-sozo-600', iconBg: 'bg-orange-100', iconText: "text-sozo-600", btnBg: 'bg-sozo-600', btnHover: 'hover:bg-sozo-700' },
    purple: { bg: 'bg-slate-50', border: 'border-l-purple-500', iconBg: 'bg-slate-100', iconText: 'text-sozo-600', btnBg: 'bg-slate-600', btnHover: 'hover:bg-slate-700' }
  };
  
  const notificationCards = PATIENT_NOTIFICATIONS.map(notif => {
    const colors = colorClasses[notif.color] || colorClasses.blue;
    const readOpacity = notif.read ? 'opacity-70' : '';
    const actionButton = notif.action ? `
      <button class="mt-3 px-4 py-2 ${colors.btnBg} ${colors.btnHover} text-white text-sm font-bold rounded-lg transition" onclick="${notif.actionFn || 'alert(\"Action clicked\")'}">
        ${notif.action}
      </button>
    ` : '';
    
    return `
      <div class="card p-6 border-l-4 ${colors.border} ${readOpacity} hover:shadow-lg transition" data-notification-item data-notification-id="${notif.id}">
        <div class="flex gap-4">
          <div class="w-12 h-12 rounded-full ${colors.iconBg} flex items-center justify-center flex-shrink-0">
            <i class="fa-solid ${notif.icon} ${colors.iconText} text-xl"></i>
          </div>
          <div class="flex-1">
            <div class="flex items-start justify-between mb-2">
              <div>
                <h3 class="text-lg font-bold text-slate-900">${notif.title}</h3>
                <div class="flex items-center gap-3 mt-1">
                  <span class="text-xs text-slate-500">
                    <i class="fa-solid fa-clock mr-1"></i>${notif.time}
                  </span>
                  <span class="text-xs text-slate-500">
                    <i class="fa-solid fa-calendar mr-1"></i>${notif.date}
                  </span>
                </div>
              </div>
              ${!notif.read ? '<span class="w-3 h-3 bg-slate-600 rounded-full"></span>' : ''}
            </div>
            <p class="text-sm font-semibold text-slate-700 mb-2">${notif.description}</p>
            <p class="text-sm text-slate-600 leading-relaxed">${notif.details}</p>
            ${actionButton}
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  area.innerHTML = `
    <div class="p-8" style="max-width: 1200px;">
      <!-- Header -->
      <div class="flex items-center justify-between mb-8">
        <div>
          <h1 class="text-3xl font-black text-slate-900 flex items-center gap-3">
            <i class="fa-solid fa-bell text-sozo-600"></i>
            All Notifications
          </h1>
          <p class="text-slate-600 mt-1">
            You have ${unreadCount} unread notification${unreadCount !== 1 ? 's' : ''}
          </p>
        </div>
        <div class="flex items-center gap-3">
          <button class="btn-secondary" onclick="markAllRead()">
            <i class="fa-solid fa-check-double mr-2"></i>Mark All as Read
          </button>
          <button class="btn-primary" onclick="renderPatient('home')">
            <i class="fa-solid fa-arrow-left mr-2"></i>Back to Home
          </button>
        </div>
      </div>
      
      <!-- Filter Tabs -->
      <div class="flex gap-2 mb-6 flex-wrap">
        <button class="sort-btn active" onclick="filterNotifications('all')">
          <i class="fa-solid fa-list mr-1"></i>All (${PATIENT_NOTIFICATIONS.length})
        </button>
        <button class="sort-btn" onclick="filterNotifications('unread')">
          <i class="fa-solid fa-envelope mr-1"></i>Unread (${unreadCount})
        </button>
        <button class="sort-btn" onclick="filterNotifications('appointment')">
          <i class="fa-solid fa-calendar mr-1"></i>Appointments
        </button>
        <button class="sort-btn" onclick="filterNotifications('message')">
          <i class="fa-solid fa-message mr-1"></i>Messages
        </button>
        <button class="sort-btn" onclick="filterNotifications('assessment')">
          <i class="fa-solid fa-clipboard mr-1"></i>Assessments
        </button>
      </div>
      
      <!-- Notifications List -->
      <div class="space-y-4" id="notificationsList">
        ${notificationCards}
      </div>
      
      ${PATIENT_NOTIFICATIONS.length === 0 ? `
        <div class="card p-12 text-center">
          <i class="fa-solid fa-bell-slash text-6xl text-slate-300 mb-4"></i>
          <h3 class="text-xl font-bold text-slate-900 mb-2">No Notifications</h3>
          <p class="text-slate-600">You're all caught up! Check back later for updates.</p>
        </div>
      ` : ''}
    </div>
  `;
}

// Filter notifications by type
function filterNotifications(filterType) {
  // Update active button
  document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
  event.target.closest('.sort-btn').classList.add('active');
  
  const notificationItems = document.querySelectorAll('[data-notification-item]');
  
  notificationItems.forEach(item => {
    const notifId = parseInt(item.dataset.notificationId);
    const notif = PATIENT_NOTIFICATIONS.find(n => n.id === notifId);
    
    if (!notif) {
      item.style.display = 'none';
      return;
    }
    
    if (filterType === 'all') {
      item.style.display = 'block';
    } else if (filterType === 'unread') {
      item.style.display = notif.read ? 'none' : 'block';
    } else {
      item.style.display = notif.type === filterType ? 'block' : 'none';
    }
  });
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
  const dropdown = document.getElementById('notificationsDropdown');
  if (dropdown && !dropdown.classList.contains('hidden')) {
    if (!event.target.closest('#notificationsDropdown') && !event.target.closest('button[onclick*="toggleNotifications"]')) {
      dropdown.classList.add('hidden');
    }
  }
});

function handlePRSSubmit(conditionId) {
  const form = document.getElementById('prsForm');
  const formData = new FormData(form);

  // Validation - removed patientCountry from required fields as it's 
  const requiredFields = ['patientName', 'patientEmail', 'assessmentDate', 'doctorEmail', 'doctorName'];
  for (let field of requiredFields) {
    const el = document.getElementById(field);
    if (!el || !el.value) {
      alert(`Please fill in: ${field}`);
      return;
    }
  }

  // Show loading spinner
  const submitBtn = document.getElementById('prsSubmit');
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Submitting...';

  // Simulate submission
  setTimeout(() => {
    const assessment = {
      conditionId,
      patientName: document.getElementById('patientName').value,
      patientId: document.getElementById('patientId').value,
      email: document.getElementById('patientEmail').value,
      country: document.getElementById('patientCountry').value,
      assessmentDate: document.getElementById('assessmentDate').value,
      doctorEmail: document.getElementById('doctorEmail').value,
      doctorName: document.getElementById('doctorName').value,
      responses: Object.fromEntries(formData),
      submittedAt: new Date().toISOString()
    };

    console.log('Assessment submitted:', assessment);

    prsState = assessment;
    setSelectedDoctor({ name: assessment.doctorName, email: assessment.doctorEmail, id: selectedDoctor.id || assessment.doctorName });
    setProgress('prs', 'completed');
    setProgress('finalreport', 'in-progress');

    // Directly navigate to final report
    loadSection('finalreport');
  }, 1500);
}

function downloadFinalReport() {
  setProgress('finalreport', 'completed');
  updateProgressBadges();
  window.print();
}

// Helper functions for patient FNON assessment
function calcPatientFNON(idx) {
  let total = 0;
  const radios = document.querySelectorAll(`input[name^="pn${idx}"]:checked`);
  radios.forEach(r => total += parseInt(r.value));
  document.getElementById(`ps_${idx}`).innerText = total;
  const testsCount = sampleData.fnon.sectionA[idx].tests.length;
  const maxRaw = testsCount * 2;
  const normalized = maxRaw ? (total / maxRaw) * 10 : 0;
  const nEl = document.getElementById(`pn_${idx}`);
  if(nEl) nEl.textContent = normalized.toFixed(1);
  updatePatientRefTable();
  refreshPatientFnonOverall();
}

function updatePatientRefTable() {
  const tbody = document.getElementById('patientFnonRefBody');
  if(!tbody) return;
  tbody.innerHTML = '';
  sampleData.fnon.sectionB.forEach((row, i) => {
    const scoreEl = document.getElementById(`ps_${i}`);
    const score = scoreEl ? parseInt(scoreEl.innerText) : 0;
    const highlight = score > 0;
    tbody.innerHTML += `
      <tr class="${highlight ? 'fnon-highlight font-medium text-sozo-900' : ''}">
        <td>${row.net} ${highlight ? '<i class="fa-solid fa-circle-exclamation text-sozo-600 ml-2"></i>' : ''}</td>
        <td>${row.sym}</td>
        <td>${row.anat}</td>
        <td class="font-mono text-xs">${row.eeg}</td>
      </tr>
    `;
  });
}

function refreshPatientFnonOverall() {
  let sum = 0; let count = sampleData.fnon.sectionA.length; let highest = { label: '--', val: -1 };
  const scoreMap = {};
  sampleData.fnon.sectionA.forEach((row, i) => {
    const nEl = document.getElementById(`pn_${i}`);
    const val = nEl ? parseFloat(nEl.textContent || '0') : 0;
    scoreMap[row.net] = val;
    sum += val;
    if(val > highest.val) highest = { label: row.net, val };
  });
  const avg = count ? (sum / count) : 0;
  const avgEl = document.getElementById('patient-fnon-average');
  if(avgEl) avgEl.textContent = avg.toFixed(1);
  const highEl = document.getElementById('patient-fnon-highest');
  if(highEl) highEl.textContent = highest.label;
  
  const plan = document.getElementById('patient-fnon-plan');
  const flagged = [];
  sampleData.fnon.sectionA.forEach((row, i) => {
    const val = scoreMap[row.net] || 0;
    if(val >= 6) flagged.push(`${row.net} (${val.toFixed(1)}/10)`);
  });
  if(plan) {
    plan.innerHTML = flagged.length ? `
      <ul class="list-disc ml-4">
        ${flagged.map(x => `<li>Focus on ${x}: 2x/week targeted training + tDCS protocol</li>`).join('')}
      </ul>
    ` : 'No elevated findings. Maintain current plan.';
  }

  fnonState = {
    scores: scoreMap,
    average: avg,
    highestLabel: highest.label,
    updatedAt: new Date().toISOString(),
    doctor: fnonState?.doctor || { id:'', name:'', email:'' }
  };
  saveFnonState();
}

// ==========================================
// Shared Final Report Renderer
// ==========================================
function renderFinalReport() {
  const area = document.getElementById('contentArea');
  
  try {
    // Auto-select first patient if none selected (for testing)
    if(!globalSelectedPatientId && sampleData.patients.length > 0) {
      globalSelectedPatientId = sampleData.patients[0].id;
    }
    
    const p = getActivePatient();
    if (!p) {
      area.innerHTML = '<div class="p-8"><div class="bg-slate-50 border border-slate-300 rounded-lg p-6"><p class="text-slate-900 font-bold">No Patient Selected</p><p class="text-sm text-slate-600 mt-2">Please select a patient from "My Patients" or "Patients DB" section first.</p></div></div>';
      return;
    }
    
    // Calculate FNON data (COMPASS-31 scores)
    const fnonScores = fnonState.scores || {};
    
    // Get PRS label
    const prsCondition = PRS_CONDITIONS.find(c => c.id === prsState.conditionId);
    const prsLabel = prsCondition ? prsCondition.name : 'DEMENTIA';

    // Generate random dummy data for patient role
    const randomData = currentRole === 'patient' ? {
      // Quality of Life (1-5 scale)
      qolMobility: Math.floor(Math.random() * 5) + 1,
      qolSelfCare: Math.floor(Math.random() * 5) + 1,
      qolUsualActivities: Math.floor(Math.random() * 5) + 1,
      qolPainDiscomfort: Math.floor(Math.random() * 5) + 1,
      qolDepressionAnxiety: Math.floor(Math.random() * 5) + 1,
      qolVAS: Math.floor(Math.random() * 10) + 1,
      
      // COMPASS-31 (0-40 range for each)
      compassOrthostatic: Math.floor(Math.random() * 41),
      compassVasomotor: Math.floor(Math.random() * 41),
      compassSecretomotor: Math.floor(Math.random() * 41),
      compassGastrointestinal: Math.floor(Math.random() * 41),
      compassBladder: Math.floor(Math.random() * 41),
      compassPupillomotor: Math.floor(Math.random() * 41),
      
      // Cognitive assessments
      amtsScore: Math.floor(Math.random() * 11), // 0-10
      mocaScore: Math.floor(Math.random() * 31), // 0-30
      dsrsScore: Math.floor(Math.random() * 55), // 0-54
      gdsStage: `Stage ${Math.floor(Math.random() * 5) + 1}`, // Stage 1-5
      iadlScore: Math.floor(Math.random() * 9), // 0-8
      
      // Mental Health - DASS-21
      dassDepression: Math.floor(Math.random() * 29), // 0-28
      dassAnxiety: Math.floor(Math.random() * 21), // 0-20
      dassStress: Math.floor(Math.random() * 35), // 0-34
    } : null;

  area.innerHTML = `
    <div class="p-8">
    ${getAssessmentNavigation('finalreport')}
    
    <!-- Patient Navigation Section (Doctor Only) -->
    ${(currentRole === 'doctor' || currentRole === 'admin') ? `

      <div class="mb-6 print:hidden">
        <div class="card p-4 bg-gradient-to-r from-slate-50 to-orange-50 border-l-4 border-l-amber-600">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <i class="fa-solid fa-users text-slate-600 text-xl"></i>
              <div>
                <label class="text-xs font-bold text-slate-900 uppercase mb-1 block">Navigate to Patient</label>
                <select id="patientNavigationSelectFinal" class="input-royal pr-10 font-bold border-slate-300 text-slate-600 focus:border-slate-600 focus:ring-amber-500">
                  ${sampleData.patients.map(pt => `
                    <option value="${pt.id}" ${pt.id === globalSelectedPatientId ? 'selected' : ''}>${pt.name} (${pt.id})</option>
                  `).join('')}
                </select>
              </div>
            </div>
            <button onclick="loadSection('patienthistory')" class="btn-secondary text-sm">
              <i class="fa-solid fa-arrow-left mr-2"></i>Back to Patient History
            </button>
          </div>
        </div>
      </div>
      
    ` : ''}
    
    <div id="finalReportContent" class="p-8 bg-white w-full">
    
    <!-- Header with Logo and Contact -->
    <div class="text-center border-b-4 border-sozo-600 pb-4 mb-6">
      <h1 class="text-4xl font-black text-sozo-600 mb-2">SOZ&#937; BRAIN CENTER</h1>
      <p class="text-sm text-slate-600">
        <i class="fa-solid fa-phone mr-1"></i> +357 25 864013 | 
        <i class="fa-solid fa-envelope mr-1"></i> info@sozobraincenter.com | 
        <i class="fa-solid fa-globe mr-1"></i> www.sozobraincenter.com
      </p>
      <p class="text-xs text-slate-500 mt-3">Privacy Notice available at www.sozobraincenter.com</p>
    </div>

    <!-- Action Buttons -->
    <div class="flex gap-3 justify-end mb-6 print:hidden">
      ${(currentRole === 'admin' || currentRole === 'doctor') ? `
        <button id="saveFinalReportBtn" class="bg-sozo-600 text-white px-4 py-2 rounded font-bold hover:bg-sozo-700">
          <i class="fa-solid fa-save mr-2"></i>Save Changes
        </button>
      ` : ''}
      <button onclick="window.print()" class="bg-white border border-slate-300 px-4 py-2 rounded font-bold text-slate-700 hover:bg-slate-50">
        <i class="fa-solid fa-print mr-2"></i>Print
      </button>
      <button onclick="downloadReportAsPDF()" class="bg-sozo-600 text-white px-4 py-2 rounded font-bold hover:bg-sozo-700">
        <i class="fa-solid fa-file-pdf mr-2"></i>PDF
      </button>
    </div>

    <!-- Report Title -->
    <div class="bg-sozo-600 text-white p-4 rounded mb-6 text-center">
      <h2 class="text-2xl font-bold">ASSESSMENT FINDINGS REPORT</h2>
      <p class="text-sm mt-1 opacity-90">${prsLabel}</p>
    </div>

    <!-- Patient Information Section -->
    <div class="bg-slate-50 p-6 rounded-lg border-2 border-slate-200 mb-6">
      <h3 class="text-xl font-bold text-slate-900 mb-4">Patient Information</h3>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="bg-white p-3 rounded-lg">
          <p class="text-xs font-bold text-slate-600 uppercase">Name/Surname</p>
          ${currentRole === 'patient' ? `<input type="text" id="finalReportPatientName" class="input-royal w-full border border-slate-300 rounded px-2 py-1 text-sm font-bold text-slate-900 mt-1" value="${p.name}" />` : `<p class="text-sm sm:text-base font-bold text-slate-900">${p.name}</p>`}
        </div>
        <div class="bg-white p-3 rounded-lg">
          <p class="text-xs font-bold text-slate-600 uppercase">Date</p>
          <p class="text-sm sm:text-base font-bold text-slate-900">${new Date().toLocaleDateString()}</p>
        </div>
        <div class="bg-white p-3 rounded-lg">
          <p class="text-xs font-bold text-slate-600 uppercase">Date of Birth</p>
          <p class="text-sm sm:text-base font-bold text-slate-900">${p.dob || 'N/A'}</p>
        </div>
        <div class="bg-white p-3 rounded-lg">
          <p class="text-xs font-bold text-slate-600 uppercase">Patient ID</p>
          <p class="text-sm sm:text-base font-bold text-slate-900">${p.id}</p>
        </div>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div class="bg-white p-3 rounded-lg">
          <label class="text-xs font-bold text-slate-600 uppercase block mb-2">Complaints</label>
          <textarea id="finalReportComplaints" class="input-royal w-full border border-slate-300 rounded px-3 py-2 text-sm" rows="2" placeholder="Enter patient complaints..."></textarea>
        </div>
        <div class="bg-white p-3 rounded-lg">
          <label class="text-xs font-bold text-slate-600 uppercase block mb-2">Medical History</label>
          <textarea id="finalReportMedicalHistory" class="input-royal w-full border border-slate-300 rounded px-3 py-2 text-sm" rows="2" placeholder="Enter medical history...">${p.condition || ''}</textarea>
        </div>
        <div class="bg-white p-3 rounded-lg">
          <label class="text-xs font-bold text-slate-600 uppercase block mb-2">External Diagnosis</label>
          <input type="text" class="input-royal w-full border border-slate-300 rounded px-3 py-2 text-sm" id="finalReportDiagnosis" value="${prsLabel}" readonly />
        </div>
        <div class="bg-white p-3 rounded-lg">
          <label class="text-xs font-bold text-slate-600 uppercase block mb-2">Referred by</label>
          <textarea id="finalReportReferredBy" class="input-royal w-full border border-slate-300 rounded px-3 py-2 text-sm" rows="2" placeholder="Enter referring physician..." readonly></textarea>
        </div>
      </div>
    </div>

    <!-- Multifactorial Assessment Report Header -->
    <div class="bg-gradient-to-r from-sozo-100 to-orange-50 p-3 sm:p-4 rounded-lg mb-4 border-l-4 border-sozo-600">
      <h3 class="text-lg sm:text-xl font-bold text-sozo-700 flex items-center"><i class="fa-solid fa-clipboard-list mr-2"></i>Multifactorial Assessment Report</h3>
    </div>

    <!-- Quality of Life Section -->
    <div class="mb-6">
      <h4 class="text-base sm:text-lg font-bold text-slate-900 mb-3 border-b-2 border-sozo-600 pb-2 flex items-center"><i class="fa-solid fa-heart mr-2 text-slate-600"></i>Quality of Life</h4>
      <p class="text-xs sm:text-sm font-bold text-slate-700 mb-2">General Health (EQ-5D-5L)</p>
      <div class="overflow-x-auto mb-3">
        <table class="w-full border-collapse border border-slate-300 text-xs sm:text-sm">
          <thead class="bg-gradient-to-r from-slate-200 to-slate-100">
            <tr>
              <th class="border border-slate-300 px-2 sm:px-3 py-2 text-left">Date Visit</th>
              <th class="border border-slate-300 px-2 sm:px-3 py-2 text-center">Mobility</th>
              <th class="border border-slate-300 px-2 sm:px-3 py-2 text-center">Self-Care</th>
              <th class="border border-slate-300 px-2 sm:px-3 py-2 text-center">Activities</th>
              <th class="border border-slate-300 px-2 sm:px-3 py-2 text-center">Pain</th>
              <th class="border border-slate-300 px-2 sm:px-3 py-2 text-center">Mood</th>
              <th class="border border-slate-300 px-2 sm:px-3 py-2 text-center">VAS</th>
            </tr>
          </thead>
          <tbody>
            <tr class="bg-blue-50">
              <td class="border border-slate-300 px-2 sm:px-3 py-2">${new Date().toLocaleDateString()}</td>
              <td class="border border-slate-300 px-2 sm:px-3 py-2 text-center"><input type="number" id="qolMobility" class="input-royal w-24 text-center text-sm" min="1" max="5" value="${randomData ? randomData.qolMobility : ''}" ${currentRole === 'patient' ? 'readonly' : ''} /></td>
              <td class="border border-slate-300 px-2 sm:px-3 py-2 text-center"><input type="number" id="qolSelfCare" class="input-royal w-24 text-center text-sm" min="1" max="5" value="${randomData ? randomData.qolSelfCare : ''}" ${currentRole === 'patient' ? 'readonly' : ''} /></td>
              <td class="border border-slate-300 px-2 sm:px-3 py-2 text-center"><input type="number" id="qolUsualActivities" class="input-royal w-24 text-center text-sm" min="1" max="5" value="${randomData ? randomData.qolUsualActivities : ''}" ${currentRole === 'patient' ? 'readonly' : ''} /></td>
              <td class="border border-slate-300 px-2 sm:px-3 py-2 text-center"><input type="number" id="qolPainDiscomfort" class="input-royal w-24 text-center text-sm" min="1" max="5" value="${randomData ? randomData.qolPainDiscomfort : ''}" ${currentRole === 'patient' ? 'readonly' : ''} /></td>
              <td class="border border-slate-300 px-2 sm:px-3 py-2 text-center"><input type="number" id="qolDepressionAnxiety" class="input-royal w-24 text-center text-sm" min="1" max="5" value="${randomData ? randomData.qolDepressionAnxiety : ''}" ${currentRole === 'patient' ? 'readonly' : ''} /></td>
              <td class="border border-slate-300 px-2 sm:px-3 py-2 text-center"><input type="number" id="qolVAS" class="input-royal w-24 text-center text-sm" min="1" max="10" value="${randomData ? randomData.qolVAS : ''}" ${currentRole === 'patient' ? 'readonly' : ''} /></td>
            </tr>
          </tbody>
        </table>
      </div>
      <p class="text-xs text-slate-600 italic">Scale: 1=No problem, 2=Slight, 3=Moderate, 4=Severe, 5=Unable/Extreme</p>
    </div>

    <!-- Autonomic Nervous System Assessment -->
    <div class="mb-6">
      <h4 class="text-base sm:text-lg font-bold text-slate-900 mb-3 border-b-2 border-sozo-600 pb-2 flex items-center"><i class="fa-solid fa-wave-square mr-2 text-slate-600"></i>Autonomic Nervous System (COMPASS-31)</h4>
      <div class="overflow-x-auto mb-3">
        <table class="w-full border-collapse border border-slate-300 text-xs sm:text-sm">
          <thead class="bg-gradient-to-r from-slate-200 to-slate-100">
            <tr>
              <th class="border border-slate-300 px-2 sm:px-3 py-2 text-left">Date Visit</th>
              <th class="border border-slate-300 px-2 sm:px-3 py-2 text-center">Orthostatic</th>
              <th class="border border-slate-300 px-2 sm:px-3 py-2 text-center">Vasomotor</th>
              <th class="border border-slate-300 px-2 sm:px-3 py-2 text-center">Secretomotor</th>
              <th class="border border-slate-300 px-2 sm:px-3 py-2 text-center">GI</th>
              <th class="border border-slate-300 px-2 sm:px-3 py-2 text-center">Bladder</th>
              <th class="border border-slate-300 px-2 sm:px-3 py-2 text-center">Pupil</th>
            </tr>
          </thead>
          <tbody>
            <tr class="bg-slate-50">
              <td class="border border-slate-300 px-2 sm:px-3 py-2">${new Date().toLocaleDateString()}</td>
              <td class="border border-slate-300 px-2 sm:px-3 py-2 text-center"><input type="number" id="compassOrthostatic" class="input-royal w-24 text-center text-sm" value="${randomData ? randomData.compassOrthostatic : ''}" ${currentRole === 'patient' ? 'readonly' : ''} /></td>
              <td class="border border-slate-300 px-2 sm:px-3 py-2 text-center"><input type="number" id="compassVasomotor" class="input-royal w-24 text-center text-sm" value="${randomData ? randomData.compassVasomotor : ''}" ${currentRole === 'patient' ? 'readonly' : ''} /></td>
              <td class="border border-slate-300 px-2 sm:px-3 py-2 text-center"><input type="number" id="compassSecretomotor" class="input-royal w-24 text-center text-sm" value="${randomData ? randomData.compassSecretomotor : ''}" ${currentRole === 'patient' ? 'readonly' : ''} /></td>
              <td class="border border-slate-300 px-2 sm:px-3 py-2 text-center"><input type="number" id="compassGastrointestinal" class="input-royal w-24 text-center text-sm" value="${randomData ? randomData.compassGastrointestinal : ''}" ${currentRole === 'patient' ? 'readonly' : ''} /></td>
              <td class="border border-slate-300 px-2 sm:px-3 py-2 text-center"><input type="number" id="compassBladder" class="input-royal w-24 text-center text-sm" value="${randomData ? randomData.compassBladder : ''}" ${currentRole === 'patient' ? 'readonly' : ''} /></td>
              <td class="border border-slate-300 px-2 sm:px-3 py-2 text-center"><input type="number" id="compassPupillomotor" class="input-royal w-24 text-center text-sm" value="${randomData ? randomData.compassPupillomotor : ''}" ${currentRole === 'patient' ? 'readonly' : ''} /></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Cognitive Assessments -->
    <div class="mb-6">
      <!-- AMTS -->
      <div class="mb-4">
        <p class="text-sm font-bold text-slate-800 mb-2">AMTS – Abbreviated Mental Test Score</p>
        <table class="w-full border-collapse border border-slate-300 mb-2">
          <thead class="bg-slate-200">
            <tr>
              <th class="border border-slate-300 px-3 py-2 text-sm font-bold text-left">Date Visit</th>
              <th class="border border-slate-300 px-3 py-2 text-sm font-bold text-center">AMTS Score</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="border border-slate-300 px-3 py-2 text-sm">${new Date().toLocaleDateString()} First visit</td>
              <td class="border border-slate-300 px-3 py-2 text-sm text-center"><input type="number" id="amtsScore" class="input-royal w-28 text-center text-base" min="0" max="10" value="${randomData ? randomData.amtsScore : ''}" ${currentRole === 'patient' ? 'readonly' : ''} /></td>
            </tr>
          </tbody>
        </table>
        <p class="text-xs text-slate-600 italic">A score of 6 or less suggests delirium or dementia, although further tests are necessary to confirm the diagnosis.</p>
      </div>

      <!-- MoCA -->
      <div class="mb-4">
        <p class="text-sm font-bold text-slate-800 mb-2">MoCA – Montreal Cognitive Assessment</p>
        <table class="w-full border-collapse border border-slate-300">
          <thead class="bg-slate-200">
            <tr>
              <th class="border border-slate-300 px-3 py-2 text-sm font-bold text-left">Date Visit</th>
              <th class="border border-slate-300 px-3 py-2 text-sm font-bold text-center">MoCA Score</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="border border-slate-300 px-3 py-2 text-sm">${new Date().toLocaleDateString()} First visit</td>
              <td class="border border-slate-300 px-3 py-2 text-sm text-center"><input type="number" id="mocaScore" class="input-royal w-28 text-center text-base" min="0" max="30" value="${randomData ? randomData.mocaScore : ''}" ${currentRole === 'patient' ? 'readonly' : ''} /></td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- DSRS -->
      <div class="mb-4">
        <p class="text-sm font-bold text-slate-800 mb-2">DSRS – Dementia Severity Rating Scale</p>
        <table class="w-full border-collapse border border-slate-300 mb-2">
          <thead class="bg-slate-200">
            <tr>
              <th class="border border-slate-300 px-3 py-2 text-sm font-bold text-left">Date Visit</th>
              <th class="border border-slate-300 px-3 py-2 text-sm font-bold text-center">DSRS Score</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="border border-slate-300 px-3 py-2 text-sm">${new Date().toLocaleDateString()} First visit</td>
              <td class="border border-slate-300 px-3 py-2 text-sm text-center"><input type="number" id="dsrsScore" class="input-royal w-28 text-center text-base" min="0" max="54" value="${randomData ? randomData.dsrsScore : ''}" ${currentRole === 'patient' ? 'readonly' : ''} /></td>
            </tr>
          </tbody>
        </table>
        <p class="text-xs text-slate-600 italic">0-18: Mild, 19-36: Moderate, 37-54: Severe</p>
      </div>

      <!-- GDS -->
      <div class="mb-4">
        <p class="text-sm font-bold text-slate-800 mb-2">GDS – Global Deterioration Scale</p>
        <table class="w-full border-collapse border border-slate-300">
          <thead class="bg-slate-200">
            <tr>
              <th class="border border-slate-300 px-3 py-2 text-sm font-bold text-left">Date Visit</th>
              <th class="border border-slate-300 px-3 py-2 text-sm font-bold text-center">GDS Stage</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="border border-slate-300 px-3 py-2 text-sm">${new Date().toLocaleDateString()} First visit</td>
              <td class="border border-slate-300 px-3 py-2 text-sm text-center"><input type="text" id="gdsStage" class="input-royal w-48 text-center text-base" placeholder="e.g., Stage 3 (Mild)" value="${randomData ? randomData.gdsStage : ''}" ${currentRole === 'patient' ? 'readonly' : ''} /></td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- IADL -->
      <div class="mb-4">
        <p class="text-sm font-bold text-slate-800 mb-2">IADL – Lawton Instrumental Activities of Daily Living Scale</p>
        <table class="w-full border-collapse border border-slate-300 mb-2">
          <thead class="bg-slate-200">
            <tr>
              <th class="border border-slate-300 px-3 py-2 text-sm font-bold text-left">Date Visit</th>
              <th class="border border-slate-300 px-3 py-2 text-sm font-bold text-center">IADL Score</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="border border-slate-300 px-3 py-2 text-sm">${new Date().toLocaleDateString()} First visit</td>
              <td class="border border-slate-300 px-3 py-2 text-sm text-center"><input type="number" id="iadlScore" class="input-royal w-28 text-center text-base" min="0" max="8" value="${randomData ? randomData.iadlScore : ''}" ${currentRole === 'patient' ? 'readonly' : ''} /></td>
            </tr>
          </tbody>
        </table>
        <p class="text-xs text-slate-600 italic">Score ranges from 0 (low function, dependent) to 8 (high function, independent).</p>
      </div>
    </div>

    <!-- Mental Health Section -->
    <div class="mb-6">
      <h4 class="text-lg font-bold text-slate-900 mb-3 border-b-2 border-sozo-600 pb-2">Mental Health</h4>
      <p class="text-sm font-bold text-slate-700 mb-2">Assessment of Psychological Distress</p>
      <p class="text-sm font-bold text-slate-800 mb-3">DASS-21</p>
      <div class="overflow-x-auto">
        <table class="w-full border-collapse border border-slate-300">
          <thead class="bg-slate-200">
            <tr>
              <th class="border border-slate-300 px-3 py-2 text-sm font-bold text-left">Date Visit</th>
              <th class="border border-slate-300 px-3 py-2 text-sm font-bold text-center">Depression<br/>(0-28)</th>
              <th class="border border-slate-300 px-3 py-2 text-sm font-bold text-center">Anxiety<br/>(0-20)</th>
              <th class="border border-slate-300 px-3 py-2 text-sm font-bold text-center">Stress<br/>(0-34)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="border border-slate-300 px-3 py-2 text-sm">${new Date().toLocaleDateString()} First visit</td>
              <td class="border border-slate-300 px-3 py-2 text-sm text-center"><input type="number" id="dassDepression" class="input-royal w-20 text-center" min="0" max="28" value="${randomData ? randomData.dassDepression : ''}" ${currentRole === 'patient' ? 'readonly' : ''} /></td>
              <td class="border border-slate-300 px-3 py-2 text-sm text-center"><input type="number" id="dassAnxiety" class="input-royal w-20 text-center" min="0" max="20" value="${randomData ? randomData.dassAnxiety : ''}" ${currentRole === 'patient' ? 'readonly' : ''} /></td>
              <td class="border border-slate-300 px-3 py-2 text-sm text-center"><input type="number" id="dassStress" class="input-royal w-20 text-center" min="0" max="34" value="${randomData ? randomData.dassStress : ''}" ${currentRole === 'patient' ? 'readonly' : ''} /></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    ${currentRole !== 'patient' ? `
    <!-- Treatment Plan Section -->
    <div class="mb-6">
      <h4 class="text-lg font-bold text-slate-900 mb-3 border-b-2 border-sozo-600 pb-2">Treatment Plan</h4>
      
      <!-- Patient Info -->
      <div class="mb-4">
        <label class="text-sm font-bold text-slate-800 block mb-2">Patient's Name & Date</label>
        <div class="grid grid-cols-2 gap-4">
          <input type="text" id="treatmentPatientName" class="input-royal" placeholder="Patient Name" value="${p.name}" ${currentRole === 'patient' ? 'readonly' : ''} />
          <input type="date" id="treatmentDate" class="input-royal" value="${new Date().toISOString().split('T')[0]}" ${currentRole === 'patient' ? 'readonly' : ''} />
        </div>
      </div>

      <!-- Treatment Sessions - First Row -->
      <div class="mb-6 bg-slate-50 p-4 rounded-lg border border-slate-200">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Brain Diagram 1 with Fields -->
          <div>
            <div class="mb-3">
              <svg viewBox="0 0 200 200" class="w-48 h-48 mx-auto mb-3">
                <!-- Brain mapping diagram -->
                <circle cx="100" cy="100" r="80" fill="none" stroke="#cbd5e1" stroke-width="2"/>
                <!-- Top markers -->
                <circle cx="100" cy="30" r="5" fill="none" stroke="#cbd5e1" stroke-width="1.5"/>
                <text x="100" y="20" text-anchor="middle" font-size="10" fill="#64748b">NASION</text>
                <!-- Row 1 -->
                <circle cx="70" cy="50" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="70" y="54" text-anchor="middle" font-size="8" fill="#64748b">FP1</text>
                <circle cx="100" cy="50" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="100" y="54" text-anchor="middle" font-size="8" fill="#64748b">FPZ</text>
                <circle cx="130" cy="50" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="130" y="54" text-anchor="middle" font-size="8" fill="#64748b">FP2</text>
                <!-- Row 2 -->
                <circle cx="50" cy="75" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="50" y="79" text-anchor="middle" font-size="8" fill="#64748b">F7</text>
                <circle cx="75" cy="75" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="75" y="79" text-anchor="middle" font-size="8" fill="#64748b">F3</text>
                <circle cx="100" cy="75" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="100" y="79" text-anchor="middle" font-size="8" fill="#64748b">FZ</text>
                <circle cx="125" cy="75" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="125" y="79" text-anchor="middle" font-size="8" fill="#64748b">F4</text>
                <circle cx="150" cy="75" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="150" y="79" text-anchor="middle" font-size="8" fill="#64748b">F8</text>
                <!-- Center row -->
                <circle cx="30" cy="100" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="30" y="104" text-anchor="middle" font-size="8" fill="#64748b">T3</text>
                <circle cx="65" cy="100" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="65" y="104" text-anchor="middle" font-size="8" fill="#64748b">C3</text>
                <circle cx="100" cy="100" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="100" y="104" text-anchor="middle" font-size="8" fill="#64748b">CZ</text>
                <circle cx="135" cy="100" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="135" y="104" text-anchor="middle" font-size="8" fill="#64748b">C4</text>
                <circle cx="170" cy="100" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="170" y="104" text-anchor="middle" font-size="8" fill="#64748b">T4</text>
                <!-- Row 4 -->
                <circle cx="50" cy="125" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="50" y="129" text-anchor="middle" font-size="8" fill="#64748b">T5</text>
                <circle cx="75" cy="125" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="75" y="129" text-anchor="middle" font-size="8" fill="#64748b">P3</text>
                <circle cx="100" cy="125" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="100" y="129" text-anchor="middle" font-size="8" fill="#64748b">PZ</text>
                <circle cx="125" cy="125" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="125" y="129" text-anchor="middle" font-size="8" fill="#64748b">P4</text>
                <circle cx="150" cy="125" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="150" y="129" text-anchor="middle" font-size="8" fill="#64748b">T6</text>
                <!-- Bottom row -->
                <circle cx="85" cy="150" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="85" y="154" text-anchor="middle" font-size="8" fill="#64748b">O1</text>
                <circle cx="100" cy="155" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="100" y="159" text-anchor="middle" font-size="8" fill="#64748b">OZ</text>
                <circle cx="115" cy="150" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="115" y="154" text-anchor="middle" font-size="8" fill="#64748b">O2</text>
                <!-- Bottom marker -->
                <circle cx="100" cy="170" r="5" fill="none" stroke="#cbd5e1" stroke-width="1.5"/>
                <text x="100" y="185" text-anchor="middle" font-size="10" fill="#64748b">INION</text>
              </svg>
            </div>
            <div class="space-y-2">
              <div class="flex items-center gap-2">
                <span class="w-32 text-xs font-semibold text-slate-700">Session #:</span>
                <input type="text" class="input-royal flex-1 text-sm" placeholder="e.g., 1-10" ${currentRole === 'patient' ? 'readonly' : ''} />
              </div>
              <div class="flex items-center gap-2">
                <span class="w-32 text-xs font-semibold text-slate-700">Protocol:</span>
                <input type="text" class="input-royal flex-1 text-sm" placeholder="e.g., High Beta" ${currentRole === 'patient' ? 'readonly' : ''} />
              </div>
              <div class="flex items-center gap-2">
                <span class="w-32 text-xs font-semibold text-slate-700">Duration:</span>
                <input type="text" class="input-royal flex-1 text-sm" placeholder="e.g., 20 min" ${currentRole === 'patient' ? 'readonly' : ''} />
              </div>
              <div class="flex items-center gap-2">
                <span class="w-32 text-xs font-semibold text-slate-700">Frequency:</span>
                <input type="text" class="input-royal flex-1 text-sm" placeholder="e.g., 5x/week" ${currentRole === 'patient' ? 'readonly' : ''} />
              </div>
              <div class="flex items-center gap-2">
                <span class="w-32 text-xs font-semibold text-slate-700">Notes:</span>
                <textarea class="input-royal flex-1 text-sm" rows="2" placeholder="Additional notes..." ${currentRole === 'patient' ? 'readonly' : ''}></textarea>
              </div>
            </div>
          </div>

          <!-- Head Profile with Fields -->
          <div>
            <div class="mb-3">
              <svg viewBox="0 0 120 200" class="w-32 h-48 mx-auto mb-3">
                <!-- Head profile outline -->
                <path d="M 60 30 Q 90 30 90 60 L 90 120 Q 90 140 70 155 L 60 160 L 60 175 Q 75 175 75 185" 
                      fill="none" stroke="#ea580c" stroke-width="3" stroke-linecap="round"/>
                <circle cx="65" cy="80" r="6" fill="none" stroke="#ea580c" stroke-width="2"/>
                <path d="M 50 100 Q 55 105 60 100" fill="none" stroke="#ea580c" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </div>
            <div class="space-y-2">
              <div class="flex items-center gap-2">
                <span class="w-32 text-xs font-semibold text-slate-700">Target Area:</span>
                <input type="text" class="input-royal flex-1 text-sm" placeholder="e.g., Left DLPFC" ${currentRole === 'patient' ? 'readonly' : ''} />
              </div>
              <div class="flex items-center gap-2">
                <span class="w-32 text-xs font-semibold text-slate-700">Modality:</span>
                <input type="text" class="input-royal flex-1 text-sm" placeholder="e.g., tDCS/rTMS" ${currentRole === 'patient' ? 'readonly' : ''} />
              </div>
              <div class="flex items-center gap-2">
                <span class="w-32 text-xs font-semibold text-slate-700">Intensity:</span>
                <input type="text" class="input-royal flex-1 text-sm" placeholder="e.g., 2mA" ${currentRole === 'patient' ? 'readonly' : ''} />
              </div>
              <div class="flex items-center gap-2">
                <span class="w-32 text-xs font-semibold text-slate-700">Expected Outcome:</span>
                <textarea class="input-royal flex-1 text-sm" rows="3" placeholder="Expected therapeutic outcomes..." ${currentRole === 'patient' ? 'readonly' : ''}></textarea>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Treatment Sessions - Second Row -->
      <div class="mb-6 bg-slate-50 p-4 rounded-lg border border-slate-200">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Brain Diagram 2 with Fields -->
          <div>
            <div class="mb-3">
              <svg viewBox="0 0 200 200" class="w-48 h-48 mx-auto mb-3">
                <!-- Brain mapping diagram (same as above) -->
                <circle cx="100" cy="100" r="80" fill="none" stroke="#cbd5e1" stroke-width="2"/>
                <circle cx="100" cy="30" r="5" fill="none" stroke="#cbd5e1" stroke-width="1.5"/>
                <text x="100" y="20" text-anchor="middle" font-size="10" fill="#64748b">NASION</text>
                <circle cx="70" cy="50" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="70" y="54" text-anchor="middle" font-size="8" fill="#64748b">FP1</text>
                <circle cx="100" cy="50" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="100" y="54" text-anchor="middle" font-size="8" fill="#64748b">FPZ</text>
                <circle cx="130" cy="50" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="130" y="54" text-anchor="middle" font-size="8" fill="#64748b">FP2</text>
                <circle cx="50" cy="75" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="50" y="79" text-anchor="middle" font-size="8" fill="#64748b">F7</text>
                <circle cx="75" cy="75" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="75" y="79" text-anchor="middle" font-size="8" fill="#64748b">F3</text>
                <circle cx="100" cy="75" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="100" y="79" text-anchor="middle" font-size="8" fill="#64748b">FZ</text>
                <circle cx="125" cy="75" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="125" y="79" text-anchor="middle" font-size="8" fill="#64748b">F4</text>
                <circle cx="150" cy="75" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="150" y="79" text-anchor="middle" font-size="8" fill="#64748b">F8</text>
                <circle cx="30" cy="100" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="30" y="104" text-anchor="middle" font-size="8" fill="#64748b">T3</text>
                <circle cx="65" cy="100" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="65" y="104" text-anchor="middle" font-size="8" fill="#64748b">C3</text>
                <circle cx="100" cy="100" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="100" y="104" text-anchor="middle" font-size="8" fill="#64748b">CZ</text>
                <circle cx="135" cy="100" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="135" y="104" text-anchor="middle" font-size="8" fill="#64748b">C4</text>
                <circle cx="170" cy="100" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="170" y="104" text-anchor="middle" font-size="8" fill="#64748b">T4</text>
                <circle cx="50" cy="125" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="50" y="129" text-anchor="middle" font-size="8" fill="#64748b">T5</text>
                <circle cx="75" cy="125" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="75" y="129" text-anchor="middle" font-size="8" fill="#64748b">P3</text>
                <circle cx="100" cy="125" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="100" y="129" text-anchor="middle" font-size="8" fill="#64748b">PZ</text>
                <circle cx="125" cy="125" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="125" y="129" text-anchor="middle" font-size="8" fill="#64748b">P4</text>
                <circle cx="150" cy="125" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="150" y="129" text-anchor="middle" font-size="8" fill="#64748b">T6</text>
                <circle cx="85" cy="150" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="85" y="154" text-anchor="middle" font-size="8" fill="#64748b">O1</text>
                <circle cx="100" cy="155" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="100" y="159" text-anchor="middle" font-size="8" fill="#64748b">OZ</text>
                <circle cx="115" cy="150" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="115" y="154" text-anchor="middle" font-size="8" fill="#64748b">O2</text>
                <circle cx="100" cy="170" r="5" fill="none" stroke="#cbd5e1" stroke-width="1.5"/>
                <text x="100" y="185" text-anchor="middle" font-size="10" fill="#64748b">INION</text>
              </svg>
            </div>
            <div class="space-y-2">
              <div class="flex items-center gap-2">
                <span class="w-32 text-xs font-semibold text-slate-700">Session #:</span>
                <input type="text" class="input-royal flex-1 text-sm" placeholder="e.g., 11-20" ${currentRole === 'patient' ? 'readonly' : ''} />
              </div>
              <div class="flex items-center gap-2">
                <span class="w-32 text-xs font-semibold text-slate-700">Protocol:</span>
                <input type="text" class="input-royal flex-1 text-sm" placeholder="e.g., Alpha/Theta" ${currentRole === 'patient' ? 'readonly' : ''} />
              </div>
              <div class="flex items-center gap-2">
                <span class="w-32 text-xs font-semibold text-slate-700">Duration:</span>
                <input type="text" class="input-royal flex-1 text-sm" placeholder="e.g., 20 min" ${currentRole === 'patient' ? 'readonly' : ''} />
              </div>
              <div class="flex items-center gap-2">
                <span class="w-32 text-xs font-semibold text-slate-700">Frequency:</span>
                <input type="text" class="input-royal flex-1 text-sm" placeholder="e.g., 3x/week" ${currentRole === 'patient' ? 'readonly' : ''} />
              </div>
              <div class="flex items-center gap-2">
                <span class="w-32 text-xs font-semibold text-slate-700">Notes:</span>
                <textarea class="input-royal flex-1 text-sm" rows="2" placeholder="Additional notes..." ${currentRole === 'patient' ? 'readonly' : ''}></textarea>
              </div>
            </div>
          </div>

          <!-- Head Profile with Fields -->
          <div>
            <div class="mb-3">
              <svg viewBox="0 0 120 200" class="w-32 h-48 mx-auto mb-3">
                <path d="M 60 30 Q 90 30 90 60 L 90 120 Q 90 140 70 155 L 60 160 L 60 175 Q 75 175 75 185" 
                      fill="none" stroke="#ea580c" stroke-width="3" stroke-linecap="round"/>
                <circle cx="65" cy="80" r="6" fill="none" stroke="#ea580c" stroke-width="2"/>
                <path d="M 50 100 Q 55 105 60 100" fill="none" stroke="#ea580c" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </div>
            <div class="space-y-2">
              <div class="flex items-center gap-2">
                <span class="w-32 text-xs font-semibold text-slate-700">Target Area:</span>
                <input type="text" class="input-royal flex-1 text-sm" placeholder="e.g., Right PFC" ${currentRole === 'patient' ? 'readonly' : ''} />
              </div>
              <div class="flex items-center gap-2">
                <span class="w-32 text-xs font-semibold text-slate-700">Modality:</span>
                <input type="text" class="input-royal flex-1 text-sm" placeholder="e.g., Neurofeedback" ${currentRole === 'patient' ? 'readonly' : ''} />
              </div>
              <div class="flex items-center gap-2">
                <span class="w-32 text-xs font-semibold text-slate-700">Intensity:</span>
                <input type="text" class="input-royal flex-1 text-sm" placeholder="e.g., Low" ${currentRole === 'patient' ? 'readonly' : ''} />
              </div>
              <div class="flex items-center gap-2">
                <span class="w-32 text-xs font-semibold text-slate-700">Expected Outcome:</span>
                <textarea class="input-royal flex-1 text-sm" rows="3" placeholder="Expected therapeutic outcomes..." ${currentRole === 'patient' ? 'readonly' : ''}></textarea>
              </div>
            </div>
          </div>
        </div>
      </div>
      ` : ''}
    </div>

    <!-- Conclusion and Recommendations -->
    <div class="space-y-4 mb-6">
      <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
        <h4 class="text-sm font-bold text-slate-800 mb-2">Multifactorial Assessment Conclusion</h4>
        <textarea id="finalReportConclusion" class="input-royal w-full border border-slate-300 rounded px-3 py-2" rows="3" placeholder="Enter assessment conclusion..." ${currentRole !== 'admin' ? 'readonly' : ''}>The comprehensive analysis reveals significant hypoactivity in the left dorsolateral prefrontal cortex, consistent with the patient's reported low mood and lack of motivation. Concurrent elevated Beta wave activity suggests underlying anxiety and hyperarousal, contributing to sleep disturbances.</textarea>
      </div>

      <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
        <h4 class="text-sm font-bold text-slate-800 mb-2">Recommendation</h4>
        <textarea id="finalReportRecommendation" class="input-royal w-full border border-slate-300 rounded px-3 py-2" rows="3" placeholder="Enter recommendations..." ${currentRole !== 'admin' ? 'readonly' : ''}>We recommend a non-invasive neuromodulation protocol to regulate cortical excitability, paired with cognitive behavioral strategies to reinforce neural changes. Lifestyle modifications focusing on sleep hygiene and reduced stimulant intake are advised to support the biological intervention.</textarea>
      </div>

      <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
        <h4 class="text-sm font-bold text-slate-800 mb-2">Recommendation - Device</h4>
        <textarea id="finalReportRecommendationDevice" class="input-royal w-full border border-slate-300 rounded px-3 py-2" rows="2" placeholder="Enter device-specific recommendations or comments..." ${currentRole !== 'admin' ? 'readonly' : ''}>We recommend using the Sozo Brain Mapper device for biweekly assessment sessions to monitor cortical activity changes. Daily use of transcranial stimulation device is advised for optimal therapeutic outcomes.</textarea>
      </div>

      <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
        <h4 class="text-sm font-bold text-slate-800 mb-2">Recommendation - Medical History</h4>
        <textarea id="finalReportRecommendationMedicalHistory" class="input-royal w-full border border-slate-300 rounded px-3 py-2" rows="2" placeholder="Enter medical history related recommendations or comments..." ${currentRole !== 'admin' ? 'readonly' : ''}>Given the patient's previous medication trials and adverse reactions, we recommend avoiding SSRIs. Continue current supplementation regimen and monitor liver function annually due to medication history.</textarea>
      </div>

      <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
        <h4 class="text-sm font-bold text-slate-800 mb-2">Neuromodulation</h4>
        <textarea id="finalReportNeuromodulation" class="input-royal w-full border border-slate-300 rounded px-3 py-2" rows="3" placeholder="Enter neuromodulation protocol..." ${currentRole !== 'admin' ? 'readonly' : ''}>The selected modality is Repetitive Transcranial Magnetic Stimulation (rTMS) targeting the left DLPFC to enhance neuronal firing rates. An inhibitory protocol may be applied to the right hemisphere subsequently to dampen anxiety-related overactivity.</textarea>
      </div>

      <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
        <h4 class="text-sm font-bold text-slate-800 mb-2">Primary neuromodulation goals</h4>
        <textarea id="finalReportPrimaryGoals" class="input-royal w-full border border-slate-300 rounded px-3 py-2" rows="3" placeholder="Enter primary goals..." ${currentRole !== 'admin' ? 'readonly' : ''}>The primary objective is to achieve a clinically significant reduction in depressive symptoms (aiming for >50% reduction in standardized depression scores). We focus on restoring emotional regulation and increasing the patient's drive and motivation for daily activities.</textarea>
      </div>

      <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
        <h4 class="text-sm font-bold text-slate-800 mb-2">Additional goals</h4>
        <textarea id="finalReportAdditionalGoals" class="input-royal w-full border border-slate-300 rounded px-3 py-2" rows="3" placeholder="Enter additional goals..." ${currentRole !== 'admin' ? 'readonly' : ''}>Secondary goals include stabilizing sleep architecture to ensure restorative rest and reducing subjective feelings of brain fog. We also aim to improve executive functions, specifically attention span and working memory, which have been impacted by the mood disorder.</textarea>
      </div>

      <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
        <h4 class="text-sm font-bold text-slate-800 mb-2">Schedule of neuromodulation sessions</h4>
        <textarea id="finalReportSchedule" class="input-royal w-full border border-slate-300 rounded px-3 py-2" rows="3" placeholder="Enter session schedule..." ${currentRole !== 'admin' ? 'readonly' : ''}>The initial acute phase consists of 5 sessions per week for a duration of 4 to 6 weeks, totaling 20-30 sessions. Each session will last approximately 20 minutes and should ideally be scheduled at the same time each day to establish a routine.</textarea>
        <p class="text-xs text-slate-600 mt-2 italic">Note: Manufacturers propose limiting the use of tDCS products to a maximum of 30 mins per day and recommend against their use with children below the age of 18.</p>
      </div>

      <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
        <h4 class="text-sm font-bold text-slate-800 mb-2">Follow up assessment</h4>
        <textarea id="finalReportFollowUp" class="input-royal w-full border border-slate-300 rounded px-3 py-2" rows="3" placeholder="Enter follow-up assessment plan..." ${currentRole !== 'admin' ? 'readonly' : ''}>A clinical review will be conducted after session 10 to evaluate tolerance and early symptomatic improvement. A full repeat of the Multifactorial Assessment, including Brain Mapping, is required after session 20 to quantify physiological progress. Based on these results, the treatment plan will be adjusted or transitioned to a maintenance schedule.</textarea>
      </div>
      
      <!-- Custom Sections Management (Admin Only) -->
      ${currentRole === 'admin' ? `
        <div class="bg-gradient-to-r from-orange-50 to-sozo-50 p-4 rounded-lg border-2 border-sozo-300 mb-4 mt-4">
          <h4 class="text-sm font-bold text-sozo-700 mb-3 flex items-center"><i class="fa-solid fa-wrench mr-2"></i>Manage Custom Sections (Admin Only)</h4>
          <button id="addCustomSectionBtn" class="bg-sozo-600 text-white px-4 py-2 rounded font-bold hover:bg-sozo-700 text-sm">
            <i class="fa-solid fa-plus mr-2"></i>Add New Section
          </button>
        </div>
      ` : ''}
      
      <!-- Custom Sections Display -->
      <div id="customSectionsContainer"></div>
    </div>

    <!-- Doctor Recommendation -->
    <div class="bg-blue-50 p-6 rounded-lg border-2 border-blue-300 mb-6">
      <h4 class="text-lg font-bold text-blue-900 mb-3">Doctor Recommendation</h4>
      <p class="text-sm text-blue-800 mb-4">
        As a member of the multidisciplinary medical team of SOZ&#937; Brain Center, I have reviewed the findings 
        in this report and recommend this patient proceeds with neuromodulation treatment.
      </p>
      <div class="grid grid-cols-2 gap-8 mt-6">
        <div>
          <label class="text-xs font-bold text-blue-700 block mb-1">Signature & Name</label>
          <select id="finalReportDoctorSignature" class="input-royal w-full border border-blue-400 rounded px-3 py-2">
            <option value="">Select Doctor</option>
            ${sampleData.doctors.map(doc => `<option value="${doc.name}, ${doc.specialty}">${doc.name}, ${doc.specialty}</option>`).join('')}
          </select>
        </div>
        <div>
          <label class="text-xs font-bold text-blue-700 block mb-1">Date</label>
          <input type="date" id="finalReportDoctorDate" class="input-royal w-full border border-blue-400 rounded px-3 py-2" />
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="mt-8 pt-4 border-t-2 border-slate-300 text-center text-xs text-slate-500">
      <p>SOZ&#937; Brain Center collects and processes data according to our Privacy Notice</p>
      <p class="mt-1">prepared in accordance with the provisions of the EU General Data Protection Regulation (GDPR)</p>
      <p class="mt-1 font-bold">Page 1 of 4</p>
    </div>

  </div>
  </div>
  `;
  
  // Render custom sections
  renderCustomSections(p.id);
  
  // Load saved data and attach event listeners
  populateFinalReportFields(p.id);
  
  setTimeout(() => {
    // Patient Navigation Dropdown for Final Report
    const patientNavSelectFinal = document.getElementById('patientNavigationSelectFinal');
    if (patientNavSelectFinal) {
      patientNavSelectFinal.addEventListener('change', (e) => {
        const patientId = e.target.value;
        if (patientId) {
          const patient = sampleData.patients.find(p => p.id === patientId);
          if (patient) {
            globalSelectedPatientId = patient.id;
            globalState.currentPatient = patient;
            // Reload the Final Report page with new patient
            renderFinalReport();
          }
        }
      });
    }
    
    const saveBtn = document.getElementById('saveFinalReportBtn');
    if (saveBtn) {
      saveBtn.addEventListener('click', () => {
        saveFinalReportData(p.id);
        // Show success message
        saveBtn.innerHTML = '<i class="fa-solid fa-check mr-2"></i>Saved!';
        saveBtn.classList.remove("bg-sozo-600", "hover:bg-sozo-700");
        saveBtn.classList.add("bg-sozo-600");
        setTimeout(() => {
          saveBtn.innerHTML = '<i class="fa-solid fa-save mr-2"></i>Save Changes';
          saveBtn.classList.remove("bg-sozo-600");
          saveBtn.classList.add('bg-sozo-600', 'hover:bg-sozo-700');
        }, 2000);
      });
    }
    
    // Add custom section button handler
    const addSectionBtn = document.getElementById('addCustomSectionBtn');
    if (addSectionBtn) {
      addSectionBtn.addEventListener('click', () => {
        const title = prompt('Enter section title:');
        if (title && title.trim()) {
          if (!globalState.customFinalReportSections[p.id]) {
            globalState.customFinalReportSections[p.id] = [];
          }
          const newSection = {
            id: 'section_' + Date.now(),
            title: title.trim(),
            content: ''
          };
          globalState.customFinalReportSections[p.id].push(newSection);
          renderCustomSections(p.id);
        }
      });
    }
  }, 100);
  
  } catch(err) {
    console.error('Final Report Error:', err);
    area.innerHTML = `<div class="p-8"><div class="bg-slate-50 border border-slate-300 rounded-lg p-6"><p class="text-slate-600 font-bold">Error generating final report</p><p class="text-sm text-slate-600 mt-2">${err.message}</p></div></div>`;
  }
}

// ==========================================
// 4. DOCTOR PORTAL (Clinical Suite)
// ==========================================
function renderDoctor(key) {
  const d = users.doctor;
  const area = document.getElementById('contentArea');

  if(key === 'home') {
    const today = new Date().toDateString();
    const allAppts = sampleData.appointments;
    const todayAppts = allAppts.filter(a => a.date === new Date().toLocaleDateString());
    const nextAppt = allAppts.find(a => a.status === 'Scheduled');
    const pendingFNON = 2; // Could be calculated from actual data
    const todayRevenue = 2000;
    const appointmentsLeftToday = todayAppts.filter(a => a.status !== 'Completed').length;
    
    area.innerHTML = `
      <div class="p-6 bg-slate-50 min-h-screen">
        <!-- Header -->
        <div class="mb-6">
          <h1 class="text-3xl font-bold text-slate-900 mb-1">Welcome back, ${d.name} 👋</h1>
          <p class="text-slate-600">Here's everything you need for today's clinic</p>
        </div>
        <!-- Top Section: Next Appointment + Workshop (Side by Side) -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <!-- Up Next Card -->
          <div>
            ${nextAppt ? `
            <div class="bg-white rounded-xl p-6 shadow-lg relative overflow-hidden h-full border border-slate-200">
              <div class="absolute top-0 left-0 w-24 h-24 bg-blue-100 opacity-30 rounded-full -translate-x-6 -translate-y-6"></div>
              <div class="relative z-10">
                <div class="inline-block bg-blue-100 px-2 py-1 rounded-full text-xs font-semibold mb-3 text-blue-700">
                  Up Next
                </div>
                <div class="flex items-center justify-between">
                  <div>
                    <h3 class="text-xl font-bold mb-1 text-slate-900"><span onclick="startVisit('${nextAppt.patientId}')" class="cursor-pointer hover:text-blue-600 transition">${nextAppt.patientName}</span> <i class="fa-solid fa-eye text-sm ml-2"></i></h3>
                    <span class="inline-block bg-blue-100 px-2 py-1 rounded-full text-xs text-blue-700">
                      ${nextAppt.type}
                    </span>
                  </div>
                  <div class="text-right">
                    <div class="text-3xl font-bold mb-2 text-slate-900">${nextAppt.time}</div>
                    <button onclick="startVisit('${nextAppt.patientId}')" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 transition text-sm">
                      Start Visit
                    </button>
                  </div>
                </div>
              </div>
            </div>
            ` : `
            <div class="bg-gradient-to-br from-slate-300 to-slate-400 rounded-2xl p-6 text-white shadow-lg h-full flex items-center justify-center">
              <div class="text-center">
                <i class="fa-solid fa-calendar-check text-6xl mb-4 opacity-50"></i>
                <p class="text-xl font-semibold">No upcoming appointments</p>
              </div>
            </div>
            `}
          </div>
            
          <!-- Upcoming Workshop Card -->
          <div class="bg-white rounded-xl p-6 shadow-lg relative overflow-hidden border border-slate-200">
            <div class="absolute top-0 left-0 w-24 h-24 bg-orange-100 opacity-30 rounded-full -translate-x-6 -translate-y-6"></div>
            <div class="relative z-10">
              <div class="inline-block bg-orange-100 px-2 py-1 rounded-full text-xs font-semibold mb-3 text-orange-700">
                Upcoming Workshop
              </div>
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="text-xl font-bold mb-1 text-slate-900">FNON Methodology Certification <i class="fa-solid fa-chalkboard-teacher text-sm ml-2"></i></h3>
                  <span class="inline-block bg-orange-100 px-2 py-1 rounded-full text-xs text-orange-700">
                    Advanced Training
                  </span>
                </div>
                <div class="text-right">
                  <div class="text-3xl font-bold mb-2 text-slate-900">Feb 15</div>
                  <button onclick="loadSection('workshops')" class="bg-orange-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-orange-700 transition text-sm">
                    Register Now
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Stats Cards (Below) -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
          <!-- Appointments Left Today -->
          <div class="bg-white rounded-xl p-5 shadow-sm border border-slate-200">
            <div class="flex items-center justify-between mb-3">
              <div class="w-12 h-12 bg-slate-100 rounded-lg flex items-center justify-center">
                <i class="fa-solid fa-calendar-days text-sozo-600 text-xl"></i>
              </div>
              <div class="text-right">
                <div class="text-3xl font-bold text-slate-900">5<span class="text-lg text-slate-400">/12</span></div>
                <div class="text-sm text-slate-500">Appointments Left Today</div>
              </div>
            </div>
          </div>

          <!-- Pending FNON -->
          <div class="bg-white rounded-xl p-5 shadow-sm border border-slate-200">
            <div class="flex items-center justify-between mb-3">
              <div class="w-12 h-12 bg-slate-100 rounded-lg flex items-center justify-center">
                <i class="fa-solid fa-clipboard-list text-slate-600 text-xl"></i>
              </div>
              <div class="text-right">
                <div class="text-3xl font-bold text-slate-900">${pendingFNON}</div>
                <div class="text-sm text-slate-500">Pending FNON</div>
              </div>
            </div>
            <button onclick="loadSection('mypatients')" class="text-blue-600 hover:text-blue-700 font-semibold text-sm">
              Review Now <i class="fa-solid fa-arrow-right ml-1"></i>
            </button>
          </div>

          <!-- Today's Revenue -->
          <div class="bg-white rounded-xl p-5 shadow-sm border border-slate-200">
            <div class="flex items-center justify-between mb-3">
              <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                <i class="fa-solid fa-dollar-sign text-sozo-600 text-xl"></i>
              </div>
              <div class="text-right">
                <div class="text-3xl font-bold text-slate-900">$${todayRevenue}</div>
                <div class="text-sm text-slate-500">Today's Revenue</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Teams-like Calendar View -->
        <div id="teamsCalendar" class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
          <!-- Header with View Controls -->
          <div class="p-4 border-b border-slate-200">
            <div class="flex items-center justify-between flex-wrap gap-4">
              <div class="flex items-center gap-4">
                <div>
                  <h3 class="text-xl font-bold text-slate-900">Calendar</h3>
                  <p class="text-sm text-slate-500 mt-1">${new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}</p>
                </div>
              </div>
              
              <div class="flex items-center gap-3 flex-wrap">
                <!-- Zoom Controls -->
                <div class="inline-flex rounded-lg border border-slate-300 bg-slate-50 p-1">
                  <button onclick="zoomCalendar('out')" class="px-3 py-2 text-slate-600 hover:text-slate-900 transition">
                    <i class="fa-solid fa-minus"></i>
                  </button>
                  <div class="px-3 py-2 text-sm font-semibold text-slate-700 border-x border-slate-300" id="zoomLevel">100%</div>
                  <button onclick="zoomCalendar('in')" class="px-3 py-2 text-slate-600 hover:text-slate-900 transition">
                    <i class="fa-solid fa-plus"></i>
                  </button>
                </div>
                
                <!-- Navigation -->
                <div class="inline-flex items-center gap-3">
                  <button onclick="navigateCalendar('prev')" class="px-3 py-2 text-slate-600 hover:text-slate-900 hover:bg-slate-100 rounded-lg transition" title="Previous Week">
                    <i class="fa-solid fa-chevron-left"></i>
                  </button>
                  <div class="flex flex-col items-center">
                    <div id="weekDateRange" class="text-lg font-bold text-slate-800">Jan 19 - Jan 25</div>
                    <button onclick="navigateCalendar('today')" class="text-xs text-blue-600 hover:text-blue-700 font-semibold transition">
                      Today
                    </button>
                  </div>
                  <button onclick="navigateCalendar('next')" class="px-3 py-2 text-slate-600 hover:text-slate-900 hover:bg-slate-100 rounded-lg transition" title="Next Week">
                    <i class="fa-solid fa-chevron-right"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Calendar Timeline Container -->
          <div id="calendarTimelineContainer" style="height: 650px; overflow: auto; position: relative; background: #fafafa;">
            <!-- Calendar content will be rendered here -->
          </div>
        </div>

        <!-- Alerts Section (Right Side) -->
        <div class="mt-6 bg-white rounded-xl shadow-sm border border-slate-200 p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold text-slate-900">Alerts</h3>
          </div>
          <div class="space-y-4">
            <div class="flex items-start gap-3 p-3 bg-orange-50 border border-orange-200 rounded-lg">
              <i class="fa-solid fa-clipboard-list text-orange-600 text-lg mt-1"></i>
              <div class="flex-1">
                <p class="text-sm font-semibold text-slate-900 mb-1">FNON overdue for 7+ days</p>
                <p class="text-xs text-slate-600">24 Sept, 2025 | 05:21 PM</p>
              </div>
              <button onclick="loadSection('mypatients')" class="text-blue-600 hover:text-blue-700 font-semibold text-sm whitespace-nowrap">
                Review Now
              </button>
            </div>
            
            <div class="flex items-start gap-3 p-3 bg-slate-50 border border-slate-200 rounded-lg">
              <i class="fa-solid fa-calendar-xmark text-slate-600 text-lg mt-1"></i>
              <div class="flex-1">
                <p class="text-sm font-semibold text-slate-900 mb-1">3 Missed Appointments today</p>
                <p class="text-xs text-slate-600">24 Sept, 2025 | 05:21 PM</p>
              </div>
              <button onclick="loadSection('schedule')" class="text-blue-600 hover:text-blue-700 font-semibold text-sm whitespace-nowrap">
                Check No Shows
              </button>
            </div>
            
            <div class="flex items-start gap-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
              <i class="fa-solid fa-book text-blue-600 text-lg mt-1"></i>
              <div class="flex-1">
                <p class="text-sm font-semibold text-slate-900 mb-1">You're left with 23mins of FNON Methodology Certification</p>
                <p class="text-xs text-slate-600">24 Sept, 2025 | 05:21 PM</p>
              </div>
              <button onclick="alert('Opening certification course')" class="text-blue-600 hover:text-blue-700 font-semibold text-sm whitespace-nowrap">
                Watch Now
              </button>
            </div>
            
            <div class="flex items-start gap-3 p-3 bg-orange-50 border border-orange-200 rounded-lg">
              <i class="fa-solid fa-clipboard-list text-orange-600 text-lg mt-1"></i>
              <div class="flex-1">
                <p class="text-sm font-semibold text-slate-900 mb-1">FNON overdue for 7+ days</p>
                <p class="text-xs text-slate-600">24 Sept, 2025 | 05:21 PM</p>
              </div>
              <button onclick="loadSection('mypatients')" class="text-blue-600 hover:text-blue-700 font-semibold text-sm whitespace-nowrap">
                Review Now
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    // Initialize Teams calendar
    initializeTeamsCalendar();
    
    // Add styles for filter buttons
    setTimeout(() => {
      const style = document.createElement('style');
      style.textContent = `
        .appointment-filter-btn {
          color: #64748b;
          background: transparent;
        }
        .appointment-filter-btn:hover {
          background: #f1f5f9;
        }
        .appointment-filter-btn.active {
          color: #1e40af;
          background: #eff6ff;
        }
      `;
      document.head.appendChild(style);
    }, 10);
  }
  else if(key === 'dashboard') {
    const patientsCount = 2000; // Active patients count
    const apptsCount = 3600; // Total appointments
    const today = new Date().toDateString();
    const todayAppts = 10; // Today's appointments
    const revenueToday = Math.floor(300 + Math.random()*700);
    const timeframes = ['daily','weekly','quarter','halfyear','year'];
    const trendData = {
      daily: [12, 18, 22, 9, 14, 20, 25],
      weekly: [80, 75, 90, 88, 95, 92, 100],
      quarter: [240, 260, 280, 300],
      halfyear: [500, 540, 580, 620, 660, 700],
      year: [900, 980, 1020, 1100, 1200, 1300, 1400, 1500, 1600, 1700, 1800, 1900]
    };
    area.innerHTML = `
      <div class="p-8">
      <div class="mb-10 flex items-center gap-6">
        <div class="w-20 h-20 rounded-full border-4 border-white shadow-lg bg-orange-500 flex items-center justify-center"><i class="fa-solid fa-user-doctor text-white text-2xl"></i></div>
        <div>
          <h2 class="text-3xl font-bold text-slate-900">${d.name}</h2>
          <p class="text-slate-600 text-base mt-1">${d.clinic} • ${d.country}</p>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-10">
        <div class="kpi-card">
          <div class="kpi-icon text-blue-600 bg-blue-50"><i class="fa-solid fa-users"></i></div>
          <div>
            <div class="kpi-label">Active Patients</div>
            <div class="kpi-value">${patientsCount}</div>
          </div>
        </div>
        <div class="kpi-card">
          <div class="kpi-icon text-sozo-600 bg-slate-50"><i class="fa-solid fa-calendar-check"></i></div>
          <div>
            <div class="kpi-label">Total Appointment</div>
            <div class="kpi-value">${apptsCount}</div>
          </div>
        </div>
        <div class="kpi-card">
          <div class="kpi-icon text-brand-blue bg-blue-50"><i class="fa-solid fa-calendar-day"></i></div>
          <div>
            <div class="kpi-label">Today Appointment</div>
            <div class="kpi-value">${todayAppts}</div>
          </div>
        </div>
        <div class="kpi-card">
          <div class="kpi-icon text-sozo-600 bg-orange-50"><i class="fa-solid fa-sack-dollar"></i></div>
          <div>
            <div class="kpi-label">Revenue (Today)</div>
            <div class="kpi-value">€${revenueToday}</div>
          </div>
        </div>
        <div class="kpi-card bg-sozo-50 border-sozo-200">
          <div class="kpi-icon bg-white text-sozo-600"><i class="fa-solid fa-flask"></i></div>
          <div>
            <div class="kpi-label text-sozo-800">Pending FNON</div>
            <div class="kpi-value text-sozo-900">${Math.floor(Math.random()*5)+1}</div>
          </div>
        </div>
      </div>

      <div class="card p-6 mb-8">
        <div class="flex items-center justify-between mb-6">
          <div>
            <h3 class="font-bold text-lg text-slate-900">Trends</h3>
            <p class="text-xs text-slate-500 mt-1">Patient activity over time</p>
          </div>
          <div class="flex gap-2 flex-wrap">
            <button class="trend-btn bg-sozo-600 text-white px-3 py-2 rounded-lg text-sm font-medium" data-tf="quarter">Quarter</button>
            <button class="trend-btn bg-slate-200 text-slate-700 px-3 py-2 rounded-lg text-sm font-medium" data-tf="halfyear">Half Year</button>
            <button class="trend-btn bg-slate-200 text-slate-700 px-3 py-2 rounded-lg text-sm font-medium" data-tf="year">Full Year</button>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="doctorTrendChart"></canvas>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div onclick="loadSection('fnon')" class="card p-8 cursor-pointer hover:border-blue-400 hover:shadow-xl group transition">
          <div class="flex items-center gap-5">
            <div class="bg-blue-100 text-blue-600 p-4 rounded-xl group-hover:scale-110 group-hover:bg-blue-600 group-hover:text-white transition-all"><i class="fa-solid fa-list-check text-2xl"></i></div>
            <div class="flex-1">
              <h3 class="font-bold text-lg text-slate-900 mb-1">Start FNON Assessment</h3>
              <p class="text-sm text-slate-600">Perform clinical network checklist</p>
            </div>
          </div>
        </div>
        <div onclick="loadSection('eshop')" class="card p-8 cursor-pointer hover:border-orange-400 hover:shadow-xl group transition">
          <div class="flex items-center gap-5">
            <div class="bg-orange-100 text-sozo-600 p-4 rounded-xl group-hover:scale-110 group-hover:bg-sozo-600 group-hover:text-white transition-all"><i class="fa-solid fa-cart-plus text-2xl"></i></div>
            <div class="flex-1">
              <h3 class="font-bold text-lg text-slate-900 mb-1">Medical E-Shop</h3>
              <p class="text-sm text-slate-600">Order devices for your clinic</p>
            </div>
          </div>
        </div>
      </div>

      <div class="card p-6">
        <div class="flex items-center justify-between mb-6">
          <div>
            <h3 class="font-bold text-lg text-slate-900">Upcoming Workshops</h3>
            <p class="text-xs text-slate-500 mt-1">Professional development and training opportunities</p>
          </div>
          <button onclick="loadSection('workshops')" class="btn-secondary text-sm">View All</button>
        </div>
        <div class="space-y-3">
          ${sampleData.workshops.filter(w => w.status === 'Upcoming').slice(0, 4).map(w => `
            <div class="flex items-center gap-4 p-4 bg-slate-50 rounded-lg hover:bg-orange-50 transition cursor-pointer border border-slate-200 hover:border-orange-300">
              <div class="bg-orange-100 text-orange-600 p-3 rounded-lg flex-shrink-0">
                <i class="fa-solid fa-chalkboard-teacher text-xl"></i>
              </div>
              <div class="flex-1 min-w-0">
                <h4 class="font-bold text-slate-900 text-sm truncate">${w.title}</h4>
                <p class="text-xs text-slate-600 mt-1">${w.instructor} • ${w.location}</p>
              </div>
              <div class="text-right flex-shrink-0">
                <div class="font-bold text-slate-900 text-sm">${w.date}</div>
                <div class="text-xs text-slate-500">${w.time}</div>
              </div>
              <div class="flex-shrink-0">
                <span class="badge badge-sozo">${w.registered}/${w.capacity}</span>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
      </div>
    `;

    setTimeout(() => {
      // Initialize Chart.js
      const chartData = {
        quarter: {
          labels: ['Month 1', 'Month 2', 'Month 3'],
          data: [240, 260, 280]
        },
        halfyear: {
          labels: ['M1', 'M2', 'M3', 'M4', 'M5', 'M6'],
          data: [500, 540, 580, 620, 660, 700]
        },
        year: {
          labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
          data: [900, 980, 1020, 1100, 1200, 1300, 1400, 1500, 1600, 1700, 1800, 1900]
        }
      };

      function initChart(period) {
        const ctx = document.getElementById('doctorTrendChart');
        if (!ctx) return;

        // Destroy existing chart
        if (globalState.chartInstance) {
          globalState.chartInstance.destroy();
        }

        const dataset = chartData[period];
        globalState.chartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: dataset.labels,
            datasets: [{
              label: 'Patient Sessions',
              data: dataset.data,
              backgroundColor: '#ea580c',
              borderColor: '#c2410c',
              borderWidth: 1,
              borderRadius: 6,
              barThickness: 24
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: '#1e293b',
                padding: 12,
                titleColor: '#fff',
                bodyColor: '#fff',
                borderColor: '#ea580c',
                borderWidth: 1
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: '#f1f5f9', drawBorder: false },
                ticks: { color: '#64748b', font: { size: 11 } }
              },
              x: {
                grid: { display: false },
                ticks: { color: '#64748b', font: { size: 11 } }
              }
            }
          }
        });
      }

      initChart('quarter');

      document.querySelectorAll('.trend-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.trend-btn').forEach(b => {
            b.classList.remove('bg-sozo-600', 'text-white');
            b.classList.add('bg-slate-200', 'text-slate-700');
          });
          btn.classList.remove('bg-slate-200', 'text-slate-700');
          btn.classList.add('bg-sozo-600', 'text-white');
          initChart(btn.dataset.tf);
        });
      });
    }, 50);
  }
  else if (key === 'schedule') {
    area.innerHTML = `
      <div class="p-8">
      <div class="mb-6">
        <h2 class="text-2xl font-bold text-slate-900">Today's Schedule</h2>
        <p class="text-slate-500">${new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
        <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="card p-4 border-l-4 border-l-green-500">
          <div class="text-xs text-slate-500 uppercase mb-1">Completed Today</div>
          <div class="text-2xl font-bold text-sozo-600" id="completedCount">2</div>
        </div>
        <div class="card p-4 border-l-4 border-l-blue-500">
          <div class="text-xs text-slate-500 uppercase mb-1">In Progress</div>
          <div class="text-2xl font-bold text-blue-600" id="inProgressCount">1</div>
        </div>
        <div class="card p-4 border-l-4 border-l-slate-400">
          <div class="text-xs text-slate-500 uppercase mb-1">Appointments for Today</div>
          <div class="text-2xl font-bold text-slate-700" id="remainingCount">10</div>
        </div>
        
      </div>
      <br>

      <!-- Filters and Sort Section -->
      <div class="card p-4 mb-4 bg-slate-50 border-slate-200">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
          <div class="md:col-span-2">
            <label class="text-xs font-bold text-slate-500 uppercase">Search</label>
            <div class="relative mt-1">
              <i class="fa-solid fa-magnifying-glass absolute left-3 top-3 text-slate-400"></i>
              <input type="text" id="scheduleSearch" class="input-royal pl-9" placeholder="Search by patient, room, or type..." />
            </div>
          </div>
          <div>
            <label class="text-xs font-bold text-slate-500 uppercase">Filter by Status</label>
            <select id="scheduleStatusFilter" class="input-royal mt-1">
              <option value="">All Statuses</option>
              <option value="Completed">Completed</option>
              <option value="In Progress">In Progress</option>
              <option value="Scheduled">Scheduled</option>
            </select>
          </div>
          <div>
            <label class="text-xs font-bold text-slate-500 uppercase">Sort By</label>
            <select id="scheduleSort" class="input-royal mt-1">
              <option value="time">Time (Earliest First)</option>
              <option value="time-desc">Time (Latest First)</option>
              <option value="patient">Patient Name (A-Z)</option>
              <option value="patient-desc">Patient Name (Z-A)</option>
              <option value="room">Room Number</option>
              <option value="type">Appointment Type</option>
              <option value="status">Status</option>
            </select>
          </div>
        </div>
        <div class="flex justify-between items-center mt-3 text-sm">
          <button id="scheduleClearFilters" class="text-slate-600 font-bold hover:text-sozo-600">
            <i class="fa-solid fa-rotate-left mr-1"></i> Clear filters
          </button>
          <span id="scheduleResultCount" class="text-slate-600 font-medium"></span>
        </div>
      </div>
      <br>

      
      <div class="card p-0 overflow-hidden">
        <table class="w-full">
          <thead>
            <tr class="bg-slate-100">
              <th class="text-left py-4 px-6 text-sm font-bold text-slate-700">Time</th>
              <th class="text-left py-4 px-6 text-sm font-bold text-slate-700">Patient Name</th>
              <th class="text-left py-4 px-6 text-sm font-bold text-slate-700">Room</th>
              <th class="text-left py-4 px-6 text-sm font-bold text-slate-700">Type</th>
              <th class="text-center py-4 px-6 text-sm font-bold text-slate-700">Status</th>
              <th class="text-center py-4 px-6 text-sm font-bold text-slate-700">Actions</th>
            </tr>
          </thead>
          <tbody id="scheduleTableBody">
          </tbody>
        </table>
      </div>

      
      </div>
      </div>
    `;

    setTimeout(() => {
      // Schedule data
      const scheduleData = [
        { time: '08:00 AM', timeValue: 800, patient: 'Sarah Mitchell', room: 'Room 101', roomNum: 101, type: 'Initial Consultation', status: 'Completed' },
        { time: '09:30 AM', timeValue: 930, patient: 'James Anderson', room: 'Room 205', roomNum: 205, type: 'Follow-up', status: 'Completed' },
        { time: '11:00 AM', timeValue: 1100, patient: 'Emily Rodriguez', room: 'Room 102', roomNum: 102, type: 'FNON Assessment', status: 'In Progress' },
        { time: '01:00 PM', timeValue: 1300, patient: 'Michael Chen', room: 'Room 304', roomNum: 304, type: 'Cognitive Assessment', status: 'Scheduled' },
        { time: '02:30 PM', timeValue: 1430, patient: 'Lisa Thompson', room: 'Room 101', roomNum: 101, type: 'Brain Mapping', status: 'Scheduled' },
        { time: '04:00 PM', timeValue: 1600, patient: 'David Brown', room: 'Room 205', roomNum: 205, type: 'PRS Assessment', status: 'Scheduled' },
        { time: '05:30 PM', timeValue: 1730, patient: 'Anna Williams', room: 'Room 102', roomNum: 102, type: 'Treatment Review', status: 'Scheduled' }
      ];

      let currentSearch = '';
      let currentStatusFilter = '';
      let currentSort = 'time';

      // Get DOM elements
      const tbody = document.getElementById('scheduleTableBody');
      const searchInput = document.getElementById('scheduleSearch');
      const statusFilter = document.getElementById('scheduleStatusFilter');
      const sortSelect = document.getElementById('scheduleSort');
      const clearBtn = document.getElementById('scheduleClearFilters');
      const resultCount = document.getElementById('scheduleResultCount');
      const completedCount = document.getElementById('completedCount');
      const inProgressCount = document.getElementById('inProgressCount');
      const remainingCount = document.getElementById('remainingCount');

      function renderSchedule() {
        // Filter data
        let filteredData = scheduleData.filter(item => {
          const matchesSearch = !currentSearch || 
            item.patient.toLowerCase().includes(currentSearch.toLowerCase()) ||
            item.room.toLowerCase().includes(currentSearch.toLowerCase()) ||
            item.type.toLowerCase().includes(currentSearch.toLowerCase());
          
          const matchesStatus = !currentStatusFilter || item.status === currentStatusFilter;
          
          return matchesSearch && matchesStatus;
        });

        // Sort data
        filteredData.sort((a, b) => {
          switch(currentSort) {
            case 'time':
              return a.timeValue - b.timeValue;
            case 'time-desc':
              return b.timeValue - a.timeValue;
            case 'patient':
              return a.patient.localeCompare(b.patient);
            case 'patient-desc':
              return b.patient.localeCompare(a.patient);
            case 'room':
              return a.roomNum - b.roomNum;
            case 'type':
              return a.type.localeCompare(b.type);
            case 'status':
              return a.status.localeCompare(b.status);
            default:
              return 0;
          }
        });

        // Update result count
        resultCount.textContent = 'Showing ' + filteredData.length + ' of ' + scheduleData.length + ' appointments';

        // Render table
        if (filteredData.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="py-8 text-center text-slate-500">No appointments found matching your filters</td></tr>';
        } else {
          tbody.innerHTML = filteredData.map(item => {
            const isInProgress = item.status === 'In Progress';
            const isCompleted = item.status === 'Completed';
            const rowClass = isInProgress ? 'border-b border-slate-100 hover:bg-blue-50 bg-blue-50' : 'border-b border-slate-100 hover:bg-slate-50';
            const textClass = isInProgress ? 'text-blue-900' : 'text-slate-900';
            const boldClass = isInProgress ? 'font-bold' : '';
            
            let statusBadge;
            if (isCompleted) {
              statusBadge = '<span class="badge badge-success text-xs">Completed</span>';
            } else if (isInProgress) {
              statusBadge = '<span class="badge badge-primary text-xs">In Progress</span>';
            } else {
              statusBadge = '<span class="badge bg-slate-200 text-slate-700 text-xs">Scheduled</span>';
            }
            
            let actionButton;
            if (isInProgress) {
              actionButton = '<button class="bg-blue-600 text-white px-3 py-1 rounded-lg text-xs font-bold hover:bg-blue-700 hidden">Join Session</button>';
            } else if (isCompleted) {
              actionButton = '<button class="text-sozo-600 font-bold text-xs hover:text-sozo-700">View Notes</button>';
            } else {
              actionButton = '<button class="text-slate-600 font-bold text-xs hover:text-slate-700">View Details</button>';
            }
            
            return '<tr class="' + rowClass + '">' +
              '<td class="py-4 px-6 text-sm font-medium ' + textClass + '">' + item.time + '</td>' +
              '<td class="py-4 px-6 text-sm ' + textClass + ' ' + boldClass + '">' + item.patient + '</td>' +
              '<td class="py-4 px-6 text-sm ' + (isInProgress ? 'text-blue-700' : 'text-slate-600') + '">' + item.room + '</td>' +
              '<td class="py-4 px-6 text-sm ' + (isInProgress ? 'text-blue-700' : 'text-slate-600') + '">' + item.type + '</td>' +
              '<td class="py-4 px-6 text-center">' + statusBadge + '</td>' +
              '<td class="py-4 px-6 text-center">' + actionButton + '</td>' +
              '</tr>';
          }).join('');
        }

        // Update counts
        const completed = scheduleData.filter(i => i.status === 'Completed').length;
        const inProgress = scheduleData.filter(i => i.status === 'In Progress').length;
        const scheduled = scheduleData.filter(i => i.status === 'Scheduled').length;
        
        completedCount.textContent = completed;
        inProgressCount.textContent = inProgress;
        remainingCount.textContent = scheduled;
      }

      // Event listeners
      searchInput.addEventListener('input', (e) => {
        currentSearch = e.target.value;
        renderSchedule();
      });

      statusFilter.addEventListener('change', (e) => {
        currentStatusFilter = e.target.value;
        renderSchedule();
      });

      sortSelect.addEventListener('change', (e) => {
        currentSort = e.target.value;
        renderSchedule();
      });

      clearBtn.addEventListener('click', () => {
        currentSearch = '';
        currentStatusFilter = '';
        currentSort = 'time';
        searchInput.value = '';
        statusFilter.value = '';
        sortSelect.value = 'time';
        renderSchedule();
      });

      // Initial render
      renderSchedule();
    }, 50);
  }
  else if (key === 'allappointments') {
    area.innerHTML = `
      <div class="p-8">
      <!-- ALL APPOINTMENTS SECTION -->
      <div>

        <!-- HEADER -->
        <div class="mb-4 flex items-center justify-between flex-wrap gap-3">
          <div>
            <h2 class="text-2xl font-bold">All Appointments</h2>
            <p class="text-slate-500 text-sm">View and manage all patient appointments.</p>
          </div>
          <div class="flex gap-2">
              <div class="relative">
                  <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                  <input type="text" id="docApptSearch" placeholder="Search appointments..." class="pl-10 pr-4 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:border-sozo-500">
              </div>
          </div>
        </div>

        <!-- FILTER CONTROLS -->
        <div class="mb-4 flex flex-wrap gap-3 items-end">
          <div>
            <label class="text-xs font-bold text-slate-500 block mb-1">Status</label>
            <select id="docApptStatusFilter" class="input-royal w-40">
              <option value="">All Statuses</option>
            </select>
          </div>
          <div>
            <label class="text-xs font-bold text-slate-500 block mb-1">Examination Type</label>
            <select id="docApptExamFilter" class="input-royal w-48">
              <option value="">All Types</option>
            </select>
          </div>
          <div>
            <label class="text-xs font-bold text-slate-500 block mb-1">Patient</label>
            <select id="docApptPatientFilter" class="input-royal w-48">
              <option value="">All Patients</option>
            </select>
          </div>
        </div>

        <!-- SORTING CONTROLS -->
        <div class="mb-4 flex gap-2 overflow-x-auto pb-2">
          <button class="docApptSort sort-btn active" data-sort="date-desc">Newest First</button>
          <button class="docApptSort sort-btn" data-sort="date-asc">Oldest First</button>
          <button class="docApptSort sort-btn" data-sort="status">Sort by Status</button>
          <button class="docApptSort sort-btn" data-sort="exam">Sort by Examination</button>
          <button class="docApptSort sort-btn" data-sort="patient">Sort by Patient</button>
        </div>

        <!-- SCROLL WRAPPER -->
        <div
          id="docApptScrollContainer"
          style="
            width:100%;
            max-height:calc(100vh - 420px);
            min-height:470px;
            overflow-x:auto;
            overflow-y:auto;
            white-space:nowrap;
            -webkit-overflow-scrolling:touch;
            border:1px solid #e2e8f0;
            border-radius:16px;
            background:white;
          "
        >

          <!-- TABLE -->
          <table
            id="docApptTableMain"
            style="
              width:2200px;
              min-width:2200px;
              border-collapse:collapse;
            "
          >
            <thead>
              <tr style="background:#f1f5f9">
                ${
                  [
                    'Actions','Status','Scheduled Date',"Patient Name",'Patient ID',
                    'Room','Phone','Mobile','Health Prof','Birth Date',
                    'Examination','Recommended By',
                    'Confirmed','Pending Action','Created Date'
                  ].map(h => `
                    <th style="
                      padding:12px 16px;
                      font-size:12px;
                      font-weight:600;
                      color:#64748b;
                      white-space:nowrap;
                      border-bottom:1px solid #e2e8f0;
                      text-transform:uppercase;
                    ">
                      ${h}
                    </th>
                  `).join('')
                }
              </tr>
            </thead>

            <tbody id="docApptTable"></tbody>
          </table>
        </div>
      </div>
      </div>

<!-- Reschedule Appointment Modal -->
<div id="docRescheduleModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4">
    <div class="flex items-center justify-between p-6 border-b border-slate-200">
      <h3 class="text-xl font-bold text-slate-900">Reschedule Appointment</h3>
      <button id="docRescheduleModalClose" class="text-slate-400 hover:text-slate-600 transition">
        <i class="fa-solid fa-times text-xl"></i>
      </button>
    </div>
    <div class="p-6">
      <form id="docRescheduleForm" class="space-y-4">
        <div>
          <label class="text-xs font-bold text-slate-500 uppercase">Current Appointment</label>
          <div id="docCurrentApptInfo" class="mt-2 p-3 bg-slate-50 rounded-lg text-sm">
            <!-- Current appointment details will be inserted here -->
          </div>
        </div>
        <div>
          <label class="text-xs font-bold text-slate-500 uppercase">New Date</label>
          <input type="date" id="docRescheduleDate" class="input-royal mt-1 py-2.5" required />
        </div>
        <div>
          <label class="text-xs font-bold text-slate-500 uppercase">New Time</label>
          <input type="time" id="docRescheduleTime" class="input-royal mt-1 py-2.5" required />
        </div>
        <div>
          <label class="text-xs font-bold text-slate-500 uppercase">Reason (Optional)</label>
          <textarea id="docRescheduleReason" class="input-royal mt-1" rows="3" placeholder="Enter reason for rescheduling..."></textarea>
        </div>
        <div class="flex gap-3 pt-2">
          <button type="submit" class="flex-1 bg-sozo-600 text-white font-bold py-2.5 rounded-lg hover:bg-sozo-700 transition">
            <i class="fa-solid fa-check mr-2"></i>Confirm Reschedule
          </button>
          <button type="button" id="docRescheduleCancel" class="flex-1 border-2 border-slate-300 text-slate-700 font-bold py-2.5 rounded-lg hover:bg-slate-100 transition">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
    `;

    setTimeout(() => {
      const tbody = document.getElementById('docApptTable');
      const searchInput = document.getElementById('docApptSearch');
      const statusFilterSelect = document.getElementById('docApptStatusFilter');
      const examFilterSelect = document.getElementById('docApptExamFilter');
      const patientFilterSelect = document.getElementById('docApptPatientFilter');
      const rescheduleModal = document.getElementById('docRescheduleModal');
      const rescheduleModalClose = document.getElementById('docRescheduleModalClose');
      const rescheduleCancel = document.getElementById('docRescheduleCancel');
      const rescheduleForm = document.getElementById('docRescheduleForm');
      const rescheduleDate = document.getElementById('docRescheduleDate');
      const rescheduleTime = document.getElementById('docRescheduleTime');
      const rescheduleReason = document.getElementById('docRescheduleReason');
      const currentApptInfo = document.getElementById('docCurrentApptInfo');

      const DOC_APPT_KEY = 'doctorAppointments';
      let data = JSON.parse(localStorage.getItem(DOC_APPT_KEY) || '{}');
      let allAppointments = data.all || [];

      if (!allAppointments.length) {
        // Generate realistic sample data for doctor's appointments
        const statuses = ['Scheduled', 'Completed', 'Cancelled', 'No Show', 'Completed', 'Scheduled'];
        const exams = ['Initial Consultation', 'MRI Scan', 'EEG Analysis', 'Follow-up', 'Cognitive Assessment', 'Lab Results Review'];
        const patientNames = ['John Anderson', 'Maria Garcia', 'Ahmed Hassan', 'Emma Wilson', 'David Chen', 'Sarah Johnson', 'Michael Brown', 'Lisa Martinez'];
        const rooms = ['101', '102', '205', 'Lab A', '304', '305'];
        
        allAppointments = Array.from({ length: 20 }).map((_, i) => {
          const date = new Date();
          date.setDate(date.getDate() + (Math.floor(Math.random() * 60) - 30)); // +/- 30 days
          const status = statuses[i % statuses.length];
          const patient = patientNames[i % patientNames.length];
          
          return {
            id: Date.now() + i,
            status: status,
            date: date.toISOString(),
            patientName: patient,
            patientId: `PT-${1000 + i}`,
            room: rooms[i % rooms.length],
            phone: `555-010${i % 10}`,
            mobile: `555-100${i % 10}`,
            healthProf: d.name,
            birthDate: `198${5 + (i % 5)}-0${1 + (i % 9)}-15`,
            examination: exams[i % exams.length],
            recommendedBy: i % 3 === 0 ? 'Dr. House' : 'Self Referral',
            confirmed: status === 'Scheduled' ? 'Yes' : 'N/A',
            pendingAction: status === 'Scheduled' ? 'Review Records' : 'N/A',
            createdDate: new Date(date.getTime() - 86400000 * 5).toISOString() // Created 5 days before
          };
        });
        
        // Sort by date descending initially
        allAppointments.sort((a, b) => new Date(b.date) - new Date(a.date));
      }

      let currentSort = 'date-desc';
      let searchTerm = '';
      let statusFilter = '';
      let examFilter = '';
      let patientFilter = '';
      let currentRescheduleId = null;

      function render() {
        let filtered = allAppointments.filter(a => {
          const term = searchTerm.toLowerCase();
          const matchSearch = (
            a.patientName.toLowerCase().includes(term) ||
            a.examination.toLowerCase().includes(term) ||
            a.status.toLowerCase().includes(term) ||
            a.room.toLowerCase().includes(term)
          );
          const matchStatus = !statusFilter || a.status === statusFilter;
          const matchExam = !examFilter || a.examination === examFilter;
          const matchPatient = !patientFilter || a.patientName === patientFilter;
          
          return matchSearch && matchStatus && matchExam && matchPatient;
        });

        // Apply Sort - Always prioritize Scheduled appointments first
        filtered.sort((a, b) => {
          // First, sort by status - Scheduled always comes first
          const aIsScheduled = a.status === 'Scheduled' ? 0 : 1;
          const bIsScheduled = b.status === 'Scheduled' ? 0 : 1;
          
          if (aIsScheduled !== bIsScheduled) {
            return aIsScheduled - bIsScheduled;
          }
          
          // Then apply the selected sort within each group
          if (currentSort === 'date-desc') return new Date(b.date) - new Date(a.date);
          if (currentSort === 'date-asc') return new Date(a.date) - new Date(b.date);
          if (currentSort === 'status') return a.status.localeCompare(b.status);
          if (currentSort === 'exam') return a.examination.localeCompare(b.examination);
          if (currentSort === 'patient') return a.patientName.localeCompare(b.patientName);
          return 0;
        });

        tbody.innerHTML = filtered.map(a => `
          <tr>
            <td class="px-4 py-3">
               ${a.status === 'Scheduled' ? `<button class="doc-reschedule-btn px-3 py-1.5 bg-sozo-600 text-white rounded-lg font-bold text-sm hover:bg-sozo-700 transition" data-id="${a.id}" title="Reschedule">
                 <i class="fa-solid fa-calendar-days mr-1"></i> Reschedule
               </button>` : '<span class="text-slate-400 text-sm">-</span>'}
            </td>
            <td class="px-4 py-3"><span class="badge badge-${a.status === 'Completed' ? 'success' : a.status === 'Scheduled' ? 'info' : a.status === 'Cancelled' ? 'danger' : 'warning'}">${a.status}</span></td>
            <td class="px-4 py-3 font-mono text-sm">${new Date(a.date).toLocaleString()}</td>
            <td class="px-4 py-3">${a.patientName}</td>
            <td class="px-4 py-3 font-mono text-sm">${a.patientId}</td>
            <td class="px-4 py-3">${a.room}</td>
            <td class="px-4 py-3 text-sm text-slate-500">${a.phone}</td>
            <td class="px-4 py-3 text-sm text-slate-500">${a.mobile}</td>
            <td class="px-4 py-3 font-medium text-slate-700">${a.healthProf}</td>
            <td class="px-4 py-3 text-sm">${a.birthDate}</td>
            <td class="px-4 py-3 font-bold text-sozo-700">${a.examination}</td>
            <td class="px-4 py-3 text-sm">${a.recommendedBy}</td>
            <td class="px-4 py-3 text-center">${a.confirmed === 'Yes' ? '<i class="fa-solid fa-check text-sozo-600"></i>' : '-'}</td>
            <td class="px-4 py-3 text-sm">${a.pendingAction}</td>
            <td class="px-4 py-3 text-xs text-slate-400">${new Date(a.createdDate).toLocaleDateString()}</td>
          </tr>
        `).join('') || '<tr><td colspan="15" class="p-8 text-center text-slate-500">No appointments found</td></tr>';
      }

      // Event Listeners
      if (searchInput) {
          searchInput.addEventListener('input', (e) => {
              searchTerm = e.target.value;
              render();
          });
      }

      // Populate filter dropdowns
      const uniqueStatuses = [...new Set(allAppointments.map(a => a.status))].sort();
      const uniqueExams = [...new Set(allAppointments.map(a => a.examination))].sort();
      const uniquePatients = [...new Set(allAppointments.map(a => a.patientName))].sort();
      
      uniqueStatuses.forEach(status => {
        const option = document.createElement('option');
        option.value = status;
        option.textContent = status;
        statusFilterSelect.appendChild(option);
      });
      
      uniqueExams.forEach(exam => {
        const option = document.createElement('option');
        option.value = exam;
        option.textContent = exam;
        examFilterSelect.appendChild(option);
      });
      
      uniquePatients.forEach(patient => {
        const option = document.createElement('option');
        option.value = patient;
        option.textContent = patient;
        patientFilterSelect.appendChild(option);
      });
      
      // Add filter change listeners
      statusFilterSelect.addEventListener('change', (e) => {
        statusFilter = e.target.value;
        render();
      });
      
      examFilterSelect.addEventListener('change', (e) => {
        examFilter = e.target.value;
        render();
      });
      
      patientFilterSelect.addEventListener('change', (e) => {
        patientFilter = e.target.value;
        render();
      });

      // Sort buttons
      document.querySelectorAll('.docApptSort').forEach(btn => {
          btn.addEventListener('click', function() {
              document.querySelectorAll('.docApptSort').forEach(b => b.classList.remove('active'));
              this.classList.add('active');
              currentSort = this.dataset.sort;
              render();
          });
      });

      // Set minimum date to today
      const today = new Date().toISOString().split('T')[0];
      rescheduleDate.min = today;

      // Reschedule button click handler (event delegation)
      tbody.addEventListener('click', function(e) {
        const rescheduleBtn = e.target.closest('.doc-reschedule-btn');
        if (rescheduleBtn) {
          const appointmentId = parseInt(rescheduleBtn.dataset.id);
          const appointment = allAppointments.find(a => a.id === appointmentId);
          
          if (appointment) {
            currentRescheduleId = appointmentId;
            
            // Display current appointment info
            const apptDate = new Date(appointment.date);
            currentApptInfo.innerHTML = `
              <div class="space-y-1">
                <p><span class="text-slate-500">Examination:</span> <span class="font-bold">${appointment.examination}</span></p>
                <p><span class="text-slate-500">Patient:</span> <span class="font-bold">${appointment.patientName}</span></p>
                <p><span class="text-slate-500">Current Date:</span> <span class="font-bold">${apptDate.toLocaleDateString()}</span></p>
                <p><span class="text-slate-500">Current Time:</span> <span class="font-bold">${apptDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span></p>
              </div>
            `;
            
            // Pre-fill with current date and time
            rescheduleDate.value = apptDate.toISOString().split('T')[0];
            rescheduleTime.value = apptDate.toTimeString().slice(0, 5);
            rescheduleReason.value = '';
            
            // Show modal
            rescheduleModal.classList.remove('hidden');
          }
        }
      });

      // Close modal handlers
      rescheduleModalClose.addEventListener('click', () => {
        rescheduleModal.classList.add('hidden');
        currentRescheduleId = null;
      });
      
      rescheduleCancel.addEventListener('click', () => {
        rescheduleModal.classList.add('hidden');
        currentRescheduleId = null;
      });

      // Handle reschedule form submission
      rescheduleForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (currentRescheduleId !== null) {
          const appointment = allAppointments.find(a => a.id === currentRescheduleId);
          
          if (appointment) {
            // Create new date from form inputs
            const newDate = new Date(rescheduleDate.value + 'T' + rescheduleTime.value);
            
            // Update appointment
            appointment.date = newDate.toISOString();
            appointment.status = 'Scheduled';
            
            // Save to localStorage
            data.all = allAppointments;
            localStorage.setItem(DOC_APPT_KEY, JSON.stringify(data));
            
            // Close modal and re-render
            rescheduleModal.classList.add('hidden');
            currentRescheduleId = null;
            render();
            
            // Show success message
            const successMsg = document.createElement('div');
            successMsg.className = 'fixed top-4 right-4 bg-orange-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2';
            successMsg.innerHTML = '<i class="fa-solid fa-check-circle"></i><span>Appointment rescheduled successfully!</span>';
            document.body.appendChild(successMsg);
            
            setTimeout(() => {
              successMsg.style.transition = 'opacity 0.3s';
              successMsg.style.opacity = '0';
              setTimeout(() => successMsg.remove(), 300);
            }, 3000);
          }
        }
      });

      // Close modal on outside click
      rescheduleModal.addEventListener('click', function(e) {
        if (e.target === rescheduleModal) {
          rescheduleModal.classList.add('hidden');
          currentRescheduleId = null;
        }
      });

      render();
    }, 50);
  }
  else if (key === 'patients') {
    const countries = [...new Set(sampleData.patients.map(p => p.country))];
    area.innerHTML = `
      <div class="p-8">
      <div class="mb-6 flex flex-wrap gap-4 items-end justify-between">
        <div>
          <h2 class="text-2xl font-bold">My Patients</h2>
          <p class="text-slate-500">Filter by country or search by name/ID</p>
        </div>
        <div class="flex flex-wrap gap-3 items-end">
          <div>
            <label class="text-xs font-bold text-slate-500">Country</label>
            <select id="filterCountry" class="input-royal w-40"><option value="">All</option>${countries.map(c => `<option value="${c}">${c}</option>`).join('')}</select>
          </div>
          <div>
            <label class="text-xs font-bold text-slate-500">Search</label>
            <input id="filterSearch" type="text" placeholder="e.g., Alice or SOZO..." class="input-royal w-64">
          </div>
          <button id="addPatientBtn" class="bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold">+ Add Patient</button>
        </div>
      </div>
      <div class="card p-0 overflow-hidden">
        <table>
          <thead><tr><th>Patient ID</th><th>Name</th><th>Condition</th><th>Country</th><th>Last Visit</th><th>Status</th><th>Action</th></tr></thead>
          <tbody id="patientsTable"></tbody>
        </table>
      </div>
      </div>
    `;

    // Create the modal outside of innerHTML so it persists across section changes
    if(!document.getElementById('addPatientModal')) {
      const modalHTML = document.createElement('div');
      modalHTML.id = 'addPatientModal';
      modalHTML.className = 'hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50 overflow-y-auto';
      modalHTML.innerHTML = `
        <div class="card p-6 w-[90%] max-w-4xl my-8">
          <h3 class="font-bold text-2xl mb-6 text-sozo-700">Add New Patient - Demographics</h3>
          
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div><label class="text-xs font-bold text-slate-600">First Name <span class="text-slate-600">*</span></label><input id="npFirstName" class="input-royal"/></div>
            <div><label class="text-xs font-bold text-slate-600">Last Name <span class="text-slate-600">*</span></label><input id="npLastName" class="input-royal"/></div>
            <div><label class="text-xs font-bold text-slate-600">Middle Name</label><input id="npMiddleName" class="input-royal"/></div>
            
            <div><label class="text-xs font-bold text-slate-600">Mother's Name</label><input id="npMotherName" class="input-royal"/></div>
            <div><label class="text-xs font-bold text-slate-600">Father's Name</label><input id="npFatherName" class="input-royal"/></div>
            <div><label class="text-xs font-bold text-slate-600">Date of Birth <span class="text-slate-600">*</span></label><input id="npDOB" type="date" class="input-royal"/></div>
            
            <div><label class="text-xs font-bold text-slate-600">Sex <span class="text-slate-600">*</span></label><select id="npSex" class="input-royal"><option value="">Select</option><option>Male</option><option>Female</option><option>Other</option></select></div>
            <div><label class="text-xs font-bold text-slate-600">TRN</label><input id="npTRN" class="input-royal" placeholder="Tax Reference Number"/></div>
            <div><label class="text-xs font-bold text-slate-600">Tax Office</label><input id="npTaxOffice" class="input-royal"/></div>
            
            <div><label class="text-xs font-bold text-slate-600">AMKA</label><input id="npAMKA" class="input-royal" placeholder="Social Security Number"/></div>
            <div><label class="text-xs font-bold text-slate-600">Identity Number <span class="text-slate-600">*</span></label><input id="npIdentityNum" class="input-royal"/></div>
            <div><label class="text-xs font-bold text-slate-600">ID Issue Date</label><input id="npIDIssueDate" type="date" class="input-royal"/></div>
            
            <div><label class="text-xs font-bold text-slate-600">ID Issue Body</label><input id="npIDIssueBody" class="input-royal"/></div>
            <div><label class="text-xs font-bold text-slate-600">Occupation Category</label><input id="npOccupationCat" class="input-royal"/></div>
            <div><label class="text-xs font-bold text-slate-600">Job Title</label><input id="npJobTitle" class="input-royal"/></div>
            
            <div><label class="text-xs font-bold text-slate-600">Email <span class="text-slate-600">*</span></label><input id="npEmail" type="email" class="input-royal"/></div>
            <div><label class="text-xs font-bold text-slate-600">Email 2</label><input id="npEmail2" type="email" class="input-royal"/></div>
            <div><label class="text-xs font-bold text-slate-600">Patient Category</label><input id="npPatientCategory" class="input-royal"/></div>
            
            <div><label class="text-xs font-bold text-slate-600">Phone</label><input id="npPhone" type="tel" class="input-royal"/></div>
            <div><label class="text-xs font-bold text-slate-600">Work Phone</label><input id="npWorkPhone" type="tel" class="input-royal"/></div>
            <div><label class="text-xs font-bold text-slate-600">Mobile <span class="text-slate-600">*</span></label><input id="npMobile" type="tel" class="input-royal"/></div>
            
            <div><label class="text-xs font-bold text-slate-600">First Visit Date</label><input id="npFirstVisitDate" type="date" class="input-royal"/></div>
            <div><label class="text-xs font-bold text-slate-600">Cancer Patient</label><div class="flex items-center gap-4 mt-1"><label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="npCancerPatient" class="w-5 h-5 rounded border-slate-300 text-sozo-600 focus:ring-sozo-500" /><span class="text-sm">Yes</span></label></div></div>
          </div>

          <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg mb-4">
            <p class="text-xs text-blue-800"><span class="font-bold">Note:</span> Fields marked with <span class="text-slate-600">*</span> are required</p>
          </div>

          <div class="flex gap-3">
            <button id="npSave" class="flex-1 bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-sozo-700">Save Patient</button>
            <button id="npCancel" class="flex-1 bg-slate-300 text-slate-700 px-4 py-2 rounded-lg font-bold hover:bg-slate-400">Cancel</button>
          </div>
        </div>
      `;
      document.body.appendChild(modalHTML);
    }

    // Create patient details modal
    if(!document.getElementById('patientDetailsModal')) {
      const detailsModalHTML = document.createElement('div');
      detailsModalHTML.id = 'patientDetailsModal';
      detailsModalHTML.className = 'hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50 overflow-y-auto';
      detailsModalHTML.innerHTML = `
        <div class="card p-6 w-[90%] max-w-5xl my-8 max-h-[90vh] overflow-y-auto">
          <div class="flex justify-between items-center mb-6">
            <h3 class="font-bold text-2xl text-sozo-700">Patient Details</h3>
            <button id="closePatientDetails" class="text-slate-400 hover:text-slate-600 transition">
              <i class="fa-solid fa-times text-2xl"></i>
            </button>
          </div>
          <div id="patientDetailsContent"></div>
        </div>
      `;
      document.body.appendChild(detailsModalHTML);
    }

    setTimeout(() => {
      const tbody = document.getElementById('patientsTable');
      const countrySel = document.getElementById('filterCountry');
      const searchInp = document.getElementById('filterSearch');
      const addBtn = document.getElementById('addPatientBtn');
      const modal = document.getElementById('addPatientModal');
      const npSave = document.getElementById('npSave');
      const npCancel = document.getElementById('npCancel');

      // Function to navigate to patient history
      function showPatientDetails(patientId) {
        const patient = sampleData.patients.find(p => p.id === patientId);
        if (!patient) return;
        
        // Set global patient ID for assessments
        globalSelectedPatientId = patient.id;
        globalState.currentPatient = patient;
        
        // Navigate to patient history section
        loadSection('patienthistory');
      }
      
      // Old modal function - keeping structure but unused
      function _oldShowPatientDetailsModal(patientId) {
        const patient = sampleData.patients.find(p => p.id === patientId);
        if (!patient) return;
        
        const detailsModal = document.getElementById('patientDetailsModal');
        const detailsContent = document.getElementById('patientDetailsContent');
        
        detailsContent.innerHTML = `
          <!-- Patient Header -->
          <div class="mb-8 text-center">
            <div class="w-24 h-24 rounded-full bg-gradient-to-br from-orange-500 to-slate-600 flex items-center justify-center text-white text-3xl font-bold mx-auto mb-4 shadow-lg">
              ${patient.name.split(' ').map(n => n[0]).join('')}
            </div>
            <h4 class="font-bold text-2xl text-slate-900">${patient.name}</h4>
            <p class="text-slate-600 text-sm mt-1">Patient ID: ${patient.id}</p>
            <p class="text-slate-500 text-sm">${patient.condition || 'N/A'} • ${patient.country}</p>
          </div>

          <!-- Assessment Buttons -->
          <div class="mb-6">
            <h5 class="font-bold text-lg mb-4 text-sozo-600 text-center">Select Assessment Type</h5>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- FNON Assessment -->
              <button onclick="document.getElementById('patientDetailsModal').classList.add('hidden'); loadSection('fnon');" 
                      class="group p-6 bg-gradient-to-br from-blue-50 to-blue-100 border-2 border-blue-200 rounded-xl hover:shadow-xl hover:border-blue-400 transition-all duration-300">
                <div class="flex flex-col items-center gap-3">
                  <div class="w-16 h-16 rounded-full bg-blue-600 text-white flex items-center justify-center group-hover:scale-110 transition-transform">
                    <i class="fa-solid fa-list-check text-2xl"></i>
                  </div>
                  <div class="text-center">
                    <h6 class="font-bold text-lg text-slate-900">FNON Assessment</h6>
                    <p class="text-xs text-slate-600 mt-1">Functional Network Analysis</p>
                  </div>
                </div>
              </button>

              <!-- Brain Mapping -->
              <button onclick="document.getElementById('patientDetailsModal').classList.add('hidden'); loadSection('brainmap');" 
                      class="group p-6 bg-gradient-to-br from-slate-50 to-slate-100 border-2 border-slate-200 rounded-xl hover:shadow-xl hover:border-slate-400 transition-all duration-300">
                <div class="flex flex-col items-center gap-3">
                  <div class="w-16 h-16 rounded-full bg-slate-600 text-white flex items-center justify-center group-hover:scale-110 transition-transform">
                    <i class="fa-solid fa-brain text-2xl"></i>
                  </div>
                  <div class="text-center">
                    <h6 class="font-bold text-lg text-slate-900">Brain Mapping</h6>
                    <p class="text-xs text-slate-600 mt-1">EEG & Neural Imaging</p>
                  </div>
                </div>
              </button>

              <!-- PRS Assessment -->
              <button onclick="document.getElementById('patientDetailsModal').classList.add('hidden'); loadSection('prs');" 
                      class="group p-6 bg-gradient-to-br from-orange-50 to-orange-100 border-2 border-orange-200 rounded-xl hover:shadow-xl hover:border-orange-400 transition-all duration-300">
                <div class="flex flex-col items-center gap-3">
                  <div class="w-16 h-16 rounded-full bg-sozo-600 text-white flex items-center justify-center group-hover:scale-110 transition-transform">
                    <i class="fa-solid fa-clipboard-check text-2xl"></i>
                  </div>
                  <div class="text-center">
                    <h6 class="font-bold text-lg text-slate-900">PRS Assessment</h6>
                    <p class="text-xs text-slate-600 mt-1">Patient Reported Symptoms</p>
                  </div>
                </div>
              </button>

              <!-- Final Report -->
              <button onclick="document.getElementById('patientDetailsModal').classList.add('hidden'); loadSection('finalreport');" 
                      class="group p-6 bg-gradient-to-br from-orange-50 to-orange-100 border-2 border-orange-200 rounded-xl hover:shadow-xl hover:border-orange-400 transition-all duration-300">
                <div class="flex flex-col items-center gap-3">
                  <div class="w-16 h-16 rounded-full bg-orange-600 text-white flex items-center justify-center group-hover:scale-110 transition-transform">
                    <i class="fa-solid fa-file-medical text-2xl"></i>
                  </div>
                  <div class="text-center">
                    <h6 class="font-bold text-lg text-slate-900">Final Report</h6>
                    <p class="text-xs text-slate-600 mt-1">Comprehensive Analysis</p>
                  </div>
                </div>
              </button>
            </div>
          </div>

          <div class="flex justify-center mt-6">
            <button id="closePatientDetailsBtn" class="border-2 border-slate-300 text-slate-700 px-8 py-2 rounded-lg font-bold hover:bg-slate-100">
              Close
            </button>
          </div>
        `;
        
        detailsModal.classList.remove('hidden');
        
        // Add close button handlers
        document.getElementById('closePatientDetails').addEventListener('click', () => {
          detailsModal.classList.add('hidden');
        });
        document.getElementById('closePatientDetailsBtn').addEventListener('click', () => {
          detailsModal.classList.add('hidden');
        });
      }

      function renderRows() {
        const country = countrySel.value;
        const q = searchInp.value.toLowerCase();
        const rows = sampleData.patients.filter(p => {
          if(country && p.country !== country) return false;
          if(q && !(p.name.toLowerCase().includes(q) || p.id.toLowerCase().includes(q))) return false;
          return true;
        }).slice(0,50).map((p,i) => `
          <tr>
            <td class="font-mono text-xs text-slate-600 bg-slate-50">${p.id}</td>
            <td class="font-bold">${p.name}</td>
            <td><span class="text-sm">${p.condition || 'N/A'}</span></td>
            <td><span class="text-sm">${p.country}</span></td>
            <td><span class="text-sm text-slate-600">${p.lastVisit}</span></td>
            <td><span class="badge badge-success">Active</span></td>
            <td><button class="view-patient-btn btn-primary text-xs px-3 py-1 rounded" data-patient-id="${p.id}">View</button></td>
          </tr>
        `).join('');
        tbody.innerHTML = rows;
        
        // Add click handlers to View buttons
        document.querySelectorAll('.view-patient-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const patientId = btn.getAttribute('data-patient-id');
            showPatientDetails(patientId);
          });
        });
      }

      countrySel.addEventListener('change', renderRows);
      searchInp.addEventListener('input', renderRows);
      renderRows();

      addBtn.addEventListener('click', () => { modal.classList.remove('hidden'); });
      npCancel.addEventListener('click', () => { modal.classList.add('hidden'); });
      npSave.addEventListener('click', () => {
        // Validate required fields
        const firstName = document.getElementById('npFirstName').value.trim();
        const lastName = document.getElementById('npLastName').value.trim();
        const dob = document.getElementById('npDOB').value;
        const sex = document.getElementById('npSex').value;
        const identityNum = document.getElementById('npIdentityNum').value.trim();
        const email = document.getElementById('npEmail').value.trim();
        const mobile = document.getElementById('npMobile').value.trim();

        if(!firstName || !lastName || !dob || !sex || !identityNum || !email || !mobile) {
          alert('Please fill all required fields (marked with *)');
          return;
        }

        // Calculate age from DOB
        const birthDate = new Date(dob);
        const today = new Date();
        const age = today.getFullYear() - birthDate.getFullYear() - (today < new Date(today.getFullYear(), birthDate.getMonth(), birthDate.getDate()) ? 1 : 0);

        // Create new patient object with all demographics
        const id = generateSozoId(sampleData.patients.length + 1);
        const newPatient = {
          id: id,
          firstName: firstName,
          lastName: lastName,
          middleName: document.getElementById('npMiddleName').value.trim(),
          motherName: document.getElementById('npMotherName').value.trim(),
          fatherName: document.getElementById('npFatherName').value.trim(),
          dob: dob,
          age: age,
          sex: sex,
          name: `${firstName} ${lastName}`,
          gender: sex,
          trn: document.getElementById('npTRN').value.trim(),
          taxOffice: document.getElementById('npTaxOffice').value.trim(),
          amka: document.getElementById('npAMKA').value.trim(),
          identityNumber: identityNum,
          idIssueDate: document.getElementById('npIDIssueDate').value,
          idIssueBody: document.getElementById('npIDIssueBody').value.trim(),
          occupationCategory: document.getElementById('npOccupationCat').value.trim(),
          jobTitle: document.getElementById('npJobTitle').value.trim(),
          email: email,
          email2: document.getElementById('npEmail2').value.trim(),
          patientCategory: document.getElementById('npPatientCategory').value.trim(),
          phone: document.getElementById('npPhone').value.trim(),
          workPhone: document.getElementById('npWorkPhone').value.trim(),
          mobile: mobile,
          firstVisitDate: document.getElementById('npFirstVisitDate').value || new Date().toISOString().slice(0,10),
          cancerPatient: document.getElementById('npCancerPatient').value || 'No',
          country: 'Germany',
          city: 'Berlin',
          healthScore: 75,
          condition: 'General Check-up',
          subscription: 'Standard',
          lastVisit: new Date().toISOString().slice(0,10),
          status: 'Active'
        };

        // Add to patient database
        sampleData.patients.unshift(newPatient);
        globalSelectedPatientId = id;
        globalState.currentPatient = newPatient;
        
        // Clear form
        document.getElementById('npFirstName').value = '';
        document.getElementById('npLastName').value = '';
        document.getElementById('npMiddleName').value = '';
        document.getElementById('npMotherName').value = '';
        document.getElementById('npFatherName').value = '';
        document.getElementById('npDOB').value = '';
        document.getElementById('npSex').value = '';
        document.getElementById('npTRN').value = '';
        document.getElementById('npTaxOffice').value = '';
        document.getElementById('npAMKA').value = '';
        document.getElementById('npIdentityNum').value = '';
        document.getElementById('npIDIssueDate').value = '';
        document.getElementById('npIDIssueBody').value = '';
        document.getElementById('npOccupationCat').value = '';
        document.getElementById('npJobTitle').value = '';
        document.getElementById('npEmail').value = '';
        document.getElementById('npEmail2').value = '';
        document.getElementById('npPatientCategory').value = '';
        document.getElementById('npPhone').value = '';
        document.getElementById('npWorkPhone').value = '';
        document.getElementById('npMobile').value = '';
        document.getElementById('npFirstVisitDate').value = '';
        document.getElementById('npCancerPatient').value = '';

        alert(`Patient "${firstName} ${lastName}" added successfully!`);
        modal.classList.add('hidden');
        renderRows();
        loadSection('fnon');
      });
    }, 50);
  }
  else if (key === 'patienthistory') {
    const patient = globalState.currentPatient;
    if (!patient) {
      area.innerHTML = `
        <div class="p-8">
          <div class="card p-8 text-center">
            <i class="fa-solid fa-user-slash text-6xl text-slate-300 mb-4"></i>
            <h3 class="text-xl font-bold text-slate-700 mb-2">No Patient Selected</h3>
            <p class="text-slate-500 mb-4">Please select a patient from the patients list</p>
            <button onclick="loadSection('patients')" class="btn-primary">Go to Patients</button>
          </div>
        </div>
      `;
      return;
    }

    area.innerHTML = `
      <div class="p-8">
        <!-- Patient Header -->
        <div class="mb-6 flex items-center justify-between">
          <div class="flex items-center gap-4">
            <button onclick="loadSection('patients')" class="text-slate-600 hover:text-slate-900 transition">
              <i class="fa-solid fa-arrow-left text-xl"></i>
            </button>
            <div class="w-16 h-16 rounded-full bg-gradient-to-br from-orange-500 to-slate-600 flex items-center justify-center text-white text-xl font-bold shadow-lg">
              ${patient.name.split(' ').map(n => n[0]).join('')}
            </div>
            <div>
              <h2 class="text-2xl font-bold text-slate-900">${patient.name}</h2>
              <p class="text-slate-600">ID: ${patient.id} • ${patient.condition || 'N/A'} • ${patient.country}</p>
            </div>
          </div>
          <span class="badge ${patient.status === 'Active' ? 'badge-success' : 'badge-danger'} text-lg px-4 py-2">${patient.status || 'Active'}</span>
        </div>

        <!-- Patient Info Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div class="card p-4 border-l-4 border-l-blue-500">
            <p class="text-xs font-bold text-slate-500 uppercase mb-1">Health Score</p>
            <p class="text-3xl font-black text-blue-600">${patient.healthScore || 'N/A'}</p>
          </div>
          <div class="card p-4 border-l-4 border-l-green-500">
            <p class="text-xs font-bold text-slate-500 uppercase mb-1">Last Visit</p>
            <p class="text-lg font-bold text-sozo-600">${patient.lastVisit}</p>
          </div>
          <div class="card p-4 border-l-4 border-l-purple-500">
            <p class="text-xs font-bold text-slate-500 uppercase mb-1">Age / Sex</p>
            <p class="text-lg font-bold text-sozo-600">${patient.age || 'N/A'} / ${patient.sex || 'N/A'}</p>
          </div>
          <div class="card p-4 border-l-4 border-l-orange-500">
            <p class="text-xs font-bold text-slate-500 uppercase mb-1">Subscription</p>
            <p class="text-lg font-bold text-orange-600">${patient.subscription || 'N/A'}</p>
          </div>
        </div>

        <!-- Quick Actions - Assessment Buttons -->
        <div class="card p-6 mb-6">
          <h3 class="font-bold text-lg mb-4 text-slate-900"><i class="fa-solid fa-stethoscope mr-2"></i>Quick Actions - Start Assessment</h3>
          <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
            <button onclick="loadSection('fnon');" class="group p-4 bg-gradient-to-br from-orange-50 to-orange-100 border-2 border-orange-200 rounded-xl hover:shadow-lg hover:border-sozo-600 transition-all">
              <div class="flex flex-col items-center gap-2">
                <div class="w-12 h-12 rounded-full bg-sozo-600 text-white flex items-center justify-center group-hover:scale-110 transition-transform">
                  <i class="fa-solid fa-list-check text-xl"></i>
                </div>
                <div class="text-center">
                  <h6 class="font-bold text-sm text-slate-900">FNON</h6>
                  <p class="text-xs text-slate-600">Network Analysis</p>
                </div>
              </div>
            </button>

            <button onclick="loadSection('brainmap');" class="group p-4 bg-gradient-to-br from-blue-50 to-blue-100 border-2 border-blue-200 rounded-xl hover:shadow-lg hover:border-brand-blue transition-all">
              <div class="flex flex-col items-center gap-2">
                <div class="w-12 h-12 rounded-full bg-brand-blue text-white flex items-center justify-center group-hover:scale-110 transition-transform">
                  <i class="fa-solid fa-brain text-xl"></i>
                </div>
                <div class="text-center">
                  <h6 class="font-bold text-sm text-slate-900">Brain Mapping</h6>
                  <p class="text-xs text-slate-600">EEG Imaging</p>
                </div>
              </div>
            </button>

            <button onclick="loadSection('prs');" class="group p-4 bg-gradient-to-br from-slate-50 to-slate-100 border-2 border-slate-200 rounded-xl hover:shadow-lg hover:border-slate-400 transition-all">
              <div class="flex flex-col items-center gap-2">
                <div class="w-12 h-12 rounded-full bg-slate-600 text-white flex items-center justify-center group-hover:scale-110 transition-transform">
                  <i class="fa-solid fa-clipboard-check text-xl"></i>
                </div>
                <div class="text-center">
                  <h6 class="font-bold text-sm text-slate-900">PRS</h6>
                  <p class="text-xs text-slate-600">Symptoms</p>
                </div>
              </div>
            </button>

            <button onclick="loadSection('doctornotes');" class="group p-4 bg-gradient-to-br from-orange-50 to-orange-100 border-2 border-orange-200 rounded-xl hover:shadow-lg hover:border-sozo-600 transition-all">
              <div class="flex flex-col items-center gap-2">
                <div class="w-12 h-12 rounded-full bg-sozo-600 text-white flex items-center justify-center group-hover:scale-110 transition-transform">
                  <i class="fa-solid fa-comment-medical text-xl"></i>
                </div>
                <div class="text-center">
                  <h6 class="font-bold text-sm text-slate-900">Doctor's Notes</h6>
                  <p class="text-xs text-slate-600">Clinical Notes</p>
                </div>
              </div>
            </button>

            <button onclick="loadSection('treatmentplan');" class="group p-4 bg-gradient-to-br from-orange-50 to-orange-100 border-2 border-orange-200 rounded-xl hover:shadow-lg hover:border-sozo-600 transition-all">
              <div class="flex flex-col items-center gap-2">
                <div class="w-12 h-12 rounded-full bg-sozo-600 text-white flex items-center justify-center group-hover:scale-110 transition-transform">
                  <i class="fa-solid fa-notes-medical text-xl"></i>
                </div>
                <div class="text-center">
                  <h6 class="font-bold text-sm text-slate-900">Treatment Plan</h6>
                  <p class="text-xs text-slate-600">Therapy Design</p>
                </div>
              </div>
            </button>

            <button onclick="loadSection('finalreport');" class="group p-4 bg-gradient-to-br from-blue-50 to-blue-100 border-2 border-blue-200 rounded-xl hover:shadow-lg hover:border-brand-blue transition-all">
              <div class="flex flex-col items-center gap-2">
                <div class="w-12 h-12 rounded-full bg-brand-blue text-white flex items-center justify-center group-hover:scale-110 transition-transform">
                  <i class="fa-solid fa-file-medical text-xl"></i>
                </div>
                <div class="text-center">
                  <h6 class="font-bold text-sm text-slate-900">Final Report</h6>
                  <p class="text-xs text-slate-600">Comprehensive</p>
                </div>
              </div>
            </button>
          </div>
        </div>

        <!-- Medical History Grid: SOZO (50% Left) + Medications & Treatment (50% Right) -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          
          <!-- Left Column: SOZO Assessments (50%) -->
          <div class="card p-6">
            <h3 class="font-bold text-lg mb-4 text-slate-900"><i class="fa-solid fa-microscope mr-2 text-sozo-600"></i>SOZO Assessments</h3>
            <div class="space-y-3">
              ${patientReports.filter(r => r.patient === patient.name && (r.type.includes('FNON') || r.type.includes('Brain') || r.type.includes('PRS') || r.type.includes('MRI'))).slice(0, 6).map(report => `
                <div class="flex items-center justify-between p-4 bg-gradient-to-r from-orange-50 to-slate-50 rounded-lg hover:shadow-md transition border-2 border-orange-200 hover:border-orange-400 cursor-pointer">
                  <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl ${
                      report.type.includes('FNON') ? 'bg-blue-600 text-white' :
                      report.type.includes('Brain') || report.type.includes('MRI') ? 'bg-slate-600 text-white' :
                      report.type.includes('PRS') ? 'bg-sozo-600 text-white' :
                      'bg-slate-600 text-white'
                    } flex items-center justify-center font-bold shadow-lg">
                      <i class="fa-solid ${
                        report.type.includes('FNON') ? 'fa-list-check text-lg' :
                        report.type.includes('Brain') || report.type.includes('MRI') ? 'fa-brain text-lg' :
                        report.type.includes('PRS') ? 'fa-clipboard-check text-lg' :
                        'fa-file-medical text-lg'
                      }"></i>
                    </div>
                    <div>
                      <h4 class="font-bold text-slate-900 text-base">${report.type}</h4>
                      <p class="text-xs text-slate-600">ID: ${report.id} • Doctor: ${report.doctor}</p>
                    </div>
                  </div>
                  <div class="text-right">
                    <p class="text-sm font-bold text-slate-900">${report.date}</p>
                    <span class="badge ${
                      report.status === 'Finalized' ? 'badge-success' :
                      report.status === 'Pending' ? 'badge-warning' :
                      'badge-info'
                    } text-xs">${report.status}</span>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>

          <!-- Right Column: Medical History & Treatment Logs (50%) -->
          <div class="space-y-6">
            
            <!-- Medical History -->
            <div class="card p-6">
              <h3 class="font-bold text-lg mb-4 text-slate-900"><i class="fa-solid fa-file-medical mr-2 text-blue-600"></i>Medical History</h3>
              <div class="grid grid-cols-1 gap-4" style="max-height: 400px; overflow-y: auto;">
                ${[
                  { name: 'Complete Blood Count (CBC)', result: 'Normal', orderedBy: 'Dr. James Wilson', date: '2025-12-15', status: 'Finalized', category: 'Blood Work', reportId: 'BW-2234' },
                  { name: 'Chest X-Ray', result: 'Clear - No abnormalities', orderedBy: 'Dr. Sarah Smith', date: '2025-11-20', status: 'Finalized', category: 'Imaging', reportId: 'XR-4421' },
                  { name: 'Lipid Panel', result: 'Borderline High Cholesterol', orderedBy: 'Dr. James Wilson', date: '2025-10-10', status: 'Finalized', category: 'Blood Work', reportId: 'BW-5512' },
                  { name: 'ECG Report', result: 'Normal Sinus Rhythm', orderedBy: 'Dr. Sarah Smith', date: '2025-09-05', status: 'Finalized', category: 'Cardiac', reportId: 'EC-2231' },
                  { name: 'MRI Brain', result: 'No structural abnormalities', orderedBy: 'Dr. James Wilson', date: '2025-08-22', status: 'Finalized', category: 'Imaging', reportId: 'MR-7711' },
                  { name: 'Urinalysis', result: 'Within normal limits', orderedBy: 'Dr. Sarah Smith', date: '2025-07-18', status: 'Finalized', category: 'Lab Test', reportId: 'UA-9952' }
                ].map(record => `
                  <div class="p-4 bg-blue-50 rounded-lg border-2 border-blue-200 hover:border-blue-400 hover:shadow-md transition cursor-pointer">
                    <div class="flex items-start justify-between mb-2">
                      <div class="flex-1">
                        <h4 class="font-bold text-slate-900 text-base">${record.name}</h4>
                        <p class="text-xs text-slate-600 mt-1"><span class="font-semibold">Result:</span> ${record.result}</p>
                      </div>
                      <span class="badge ${record.status === 'Finalized' ? 'badge-success' : 'badge-warning'} text-xs">${record.status}</span>
                    </div>
                    <div class="mt-3 pt-3 border-t border-blue-200">
                      <div class="flex items-center justify-between text-xs text-slate-600 mb-2">
                        <span><i class="fa-solid fa-user-doctor mr-1"></i>${record.orderedBy}</span>
                        <span><i class="fa-solid fa-calendar mr-1"></i>${record.date}</span>
                      </div>
                      <div class="flex items-center justify-between">
                        <span class="inline-block bg-blue-100 text-blue-700 px-2 py-1 rounded-full text-xs font-semibold">${record.category}</span>
                        <span class="text-xs text-slate-500 font-mono">${record.reportId}</span>
                      </div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>

            <!-- Treatment Plan Logs -->
            <div class="card p-6">
              <h3 class="font-bold text-lg mb-4 text-slate-900"><i class="fa-solid fa-clipboard-list mr-2 text-sozo-600"></i>Treatment Plan Logs</h3>
              <div class="space-y-3" style="max-height: 400px; overflow-y: auto;">
            ${[
              { date: '2026-01-20', time: '10:30 AM', treatment: 'Cognitive Behavioral Therapy Session', provider: 'Dr. James Wilson', duration: '50 mins', status: 'Completed', notes: 'Patient showed improvement in anxiety management techniques' },
              { date: '2026-01-18', time: '02:00 PM', treatment: 'Physical Therapy - Upper Body', provider: 'Dr. Sarah Smith', duration: '45 mins', status: 'Completed', notes: 'Range of motion exercises completed successfully' },
              { date: '2026-01-15', time: '09:00 AM', treatment: 'Blood Work - Routine Check', provider: 'Lab Technician', duration: '15 mins', status: 'Completed', notes: 'Results sent to primary physician' },
              { date: '2026-01-13', time: '11:00 AM', treatment: 'Neurological Consultation', provider: 'Dr. James Wilson', duration: '60 mins', status: 'Completed', notes: 'Follow-up scheduled for next month' },
              { date: '2026-01-10', time: '03:30 PM', treatment: 'Medication Review', provider: 'Dr. Sarah Smith', duration: '30 mins', status: 'Completed', notes: 'Adjusted Sertraline dosage to 50mg' },
              { date: '2026-01-22', time: '02:00 PM', treatment: 'FNON Assessment Follow-up', provider: 'Dr. James Wilson', duration: '60 mins', status: 'Scheduled', notes: 'Review previous assessment results' }
            ].map(log => `
              <div class="flex items-start gap-4 p-4 ${log.status === 'Completed' ? 'bg-orange-50 border-orange-200' : 'bg-slate-50 border-slate-200'} rounded-lg border-2 hover:shadow-md transition">
                <div class="w-12 h-12 rounded-xl ${log.status === 'Completed' ? 'bg-sozo-600' : 'bg-slate-600'} text-white flex items-center justify-center font-bold flex-shrink-0 shadow-lg">
                  <i class="fa-solid ${log.status === 'Completed' ? 'fa-check' : 'fa-clock'}"></i>
                </div>
                <div class="flex-1">
                  <div class="flex items-start justify-between mb-2">
                    <div>
                      <h4 class="font-bold text-slate-900 text-base">${log.treatment}</h4>
                      <p class="text-xs text-slate-600 mt-1">
                        <i class="fa-solid fa-calendar mr-1"></i>${log.date} at ${log.time}
                        <span class="mx-2">•</span>
                        <i class="fa-solid fa-clock mr-1"></i>${log.duration}
                      </p>
                    </div>
                    <span class="badge ${log.status === 'Completed' ? 'badge-success' : 'badge-warning'} text-xs">${log.status}</span>
                  </div>
                  <div class="mt-2 pt-2 border-t ${log.status === 'Completed' ? 'border-orange-200' : 'border-slate-200'}">
                    <p class="text-xs text-slate-600 mb-2">
                      <i class="fa-solid fa-user-doctor mr-1"></i><span class="font-semibold">Provider:</span> ${log.provider}
                    </p>
                    <p class="text-xs text-slate-700 italic bg-white/50 p-2 rounded">
                      <i class="fa-solid fa-note-sticky mr-1"></i>${log.notes}
                    </p>
                  </div>
                </div>
              </div>
            `).join('')}
              </div>
            </div>
            
          </div>
        </div>

        <!-- Patient Details -->
        <div class="card p-6">
          <h3 class="font-bold text-lg mb-4 text-slate-900"><i class="fa-solid fa-user mr-2"></i>Patient Details</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="text-xs font-bold text-slate-500 uppercase">Full Name</label>
              <p class="text-sm font-semibold text-slate-900 mt-1">${patient.name}</p>
            </div>
            <div>
              <label class="text-xs font-bold text-slate-500 uppercase">Date of Birth</label>
              <p class="text-sm font-semibold text-slate-900 mt-1">${patient.dob || 'N/A'}</p>
            </div>
            <div>
              <label class="text-xs font-bold text-slate-500 uppercase">Gender</label>
              <p class="text-sm font-semibold text-slate-900 mt-1">${patient.gender || patient.sex || 'N/A'}</p>
            </div>
            <div>
              <label class="text-xs font-bold text-slate-500 uppercase">Email</label>
              <p class="text-sm font-semibold text-slate-900 mt-1">${patient.email}</p>
            </div>
            <div>
              <label class="text-xs font-bold text-slate-500 uppercase">Phone</label>
              <p class="text-sm font-semibold text-slate-900 mt-1">${patient.mobile || patient.phone || 'N/A'}</p>
            </div>
            <div>
              <label class="text-xs font-bold text-slate-500 uppercase">Country</label>
              <p class="text-sm font-semibold text-slate-900 mt-1">${patient.country}</p>
            </div>
            <div>
              <label class="text-xs font-bold text-slate-500 uppercase">City</label>
              <p class="text-sm font-semibold text-slate-900 mt-1">${patient.city || 'N/A'}</p>
            </div>
            <div>
              <label class="text-xs font-bold text-slate-500 uppercase">Identity Number</label>
              <p class="text-sm font-semibold text-slate-900 mt-1">${patient.identityNumber || 'N/A'}</p>
            </div>
            <div>
              <label class="text-xs font-bold text-slate-500 uppercase">First Visit</label>
              <p class="text-sm font-semibold text-slate-900 mt-1">${patient.firstVisitDate || 'N/A'}</p>
            </div>
          </div>
        </div>
      </div>
    `;
  }
  else if (key === 'fnon') renderFNON();
  else if (key === 'brainmap') renderBrainMap();
  else if (key === 'brainmapping') renderBrainMap();
  else if (key === 'prs') renderPRSDoctor();
  else if (key === 'doctornotes') renderDoctorNotes();
  else if (key === 'treatmentplan') {
    if (currentRole === 'patient') {
      renderPatientTreatmentPlan();
    } else {
      renderTreatmentPlan();
    }
  }
  else if (key === 'finalreport') {
    // Admin renders final report using shared function
    renderFinalReport();
  }
  else if (key === 'eshop') renderShopView();
  else if (key === 'reports') {
    area.innerHTML = `
      <div class="p-8">
      <div class="mb-4">
        <h2 class="text-2xl font-bold mb-1">Patient Medical Reports</h2>
        <p class="text-slate-500">Filter by patient name, report type, country, date range, or doctor.</p>
      </div>
      
      <!-- Filter Controls -->
      <div class="card p-6 mb-6 bg-slate-50">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
          <div>
            <label class="text-xs font-bold text-slate-500 uppercase">Patient Name</label>
            <input type="text" id="filterPatient" placeholder="Search patient..." class="input-royal mt-1" />
          </div>
          <div>
            <label class="text-xs font-bold text-slate-500 uppercase">Report Type</label>
            <select id="filterType" class="input-royal mt-1">
              <option value="">All Types</option>
              <option value="FNON Report">FNON Report</option>
              <option value="PRS Report">PRS Report</option>
              <option value="MRI">MRI</option>
              <option value="CT Scan">CT Scan</option>
              <option value="X-Ray">X-Ray</option>
              <option value="Blood Work">Blood Work</option>
            </select>
          </div>
          <div>
            <label class="text-xs font-bold text-slate-500 uppercase">Country</label>
            <select id="filterCountry" class="input-royal mt-1">
              <option value="">All Countries</option>
              <option value="United Kingdom">United Kingdom</option>
              <option value="Germany">Germany</option>
              <option value="France">France</option>
              <option value="Spain">Spain</option>
            </select>
          </div>
          <div>
            <label class="text-xs font-bold text-slate-500 uppercase">Start Date</label>
            <input type="date" id="filterStart" class="input-royal mt-1" />
          </div>
          <div>
            <label class="text-xs font-bold text-slate-500 uppercase">End Date</label>
            <input type="date" id="filterEnd" class="input-royal mt-1" />
          </div>
        </div>
        <div class="flex justify-between items-center mt-4">
          <button onclick="clearReportFilters()" class="text-slate-600 font-bold text-sm hover:text-sozo-600">
            <i class="fa-solid fa-rotate-left mr-1"></i> Clear Filters
          </button>
          <div id="reportCount" class="text-sm text-slate-600 font-bold"></div>
        </div>
      </div>

      <!-- Reports Table -->
      <div class="card p-0 overflow-hidden">
        <div class="bg-slate-800 text-white p-4 font-bold flex justify-between items-center">
          <span><i class="fa-solid fa-file-medical mr-2"></i> Medical Reports</span>
          <button class="text-xs bg-white text-slate-800 px-3 py-1 rounded-md font-bold hover:bg-slate-100">
            <i class="fa-solid fa-download mr-1"></i> Export CSV
          </button>
        </div>
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Patient Name</th>
              <th>Report Type</th>
              <th>Doctor</th>
              <th>Country</th>
              <th>Report ID</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="reportsTable"></tbody>
        </table>
      </div>
      </div>
    `;

    setTimeout(() => {
      const tbody = document.getElementById('reportsTable');
      const reportCount = document.getElementById('reportCount');
      const patientInp = document.getElementById('filterPatient');
      const typeSel = document.getElementById('filterType');
      const countrySel = document.getElementById('filterCountry');
      const startInp = document.getElementById('filterStart');
      const endInp = document.getElementById('filterEnd');

      function applyFilters() {
        const patientQuery = patientInp.value.toLowerCase();
        const type = typeSel.value;
        const country = countrySel.value;
        const start = startInp.value ? new Date(startInp.value) : null;
        const end = endInp.value ? new Date(endInp.value) : null;

        // Get the current doctor (assuming "Dr. Wilson" for now, should be from current user context)
        const currentDoctor = 'Dr. Wilson'; // This should be derived from the logged-in user

        const filtered = patientReports.filter(r => {
          // Filter by current doctor - only show reports for this doctor
          if(r.doctor !== currentDoctor) return false;
          
          // Filter by patient name
          if(patientQuery && !r.patient.toLowerCase().includes(patientQuery)) return false;
          
          // Filter by type
          if(type && r.type !== type) return false;
          
          // Filter by country
          if(country && r.country !== country) return false;
          
          // Filter by date range
          const d = new Date(r.date);
          if(start && d < start) return false;
          if(end && d > end) return false;
          
          return true;
        });

        // Remove duplicate patient names - keep first occurrence of each patient
        const seenPatients = new Set();
        const uniqueReports = filtered.filter(r => {
          if(seenPatients.has(r.patient)) {
            return false;
          }
          seenPatients.add(r.patient);
          return true;
        });

        const rows = uniqueReports.map(r => `
          <tr>
            <td>${r.date}</td>
            <td class="font-bold text-slate-800">${r.patient}</td>
            <td><span class="badge badge-primary">${r.type}</span></td>
            <td>${r.doctor}</td>
            <td>${r.country}</td>
            <td class="font-mono text-sm">${r.id}</td>
            <td><span class="badge ${r.status==='Finalized' ? 'badge-success' : 'badge-warning'}">${r.status}</span></td>
            <td>
              <button class="text-sozo-600 font-bold hover:text-sozo-700" onclick="alert('Downloading ${r.id}.pdf')">
                <i class="fa-solid fa-download"></i> PDF
              </button>
            </td>
          </tr>
        `).join('');
        
        if(tbody) {
          tbody.innerHTML = rows || '<tr><td colspan="8" class="p-8 text-center text-slate-500"><i class="fa-solid fa-inbox text-4xl mb-3 opacity-30"></i><br/>No reports found matching your filters.</td></tr>';
        }
        
        if(reportCount) {
          reportCount.textContent = `Showing ${uniqueReports.length} of ${filtered.length} reports (Doctor: ${currentDoctor})`;
        }
      }

      // Attach event listeners
      [typeSel, countrySel, startInp, endInp].forEach(el => el.addEventListener('change', applyFilters));
      patientInp.addEventListener('input', applyFilters);
      
      // Initial load
      applyFilters();
    }, 50);
  }
  else if (key === 'learning') {
    area.innerHTML = `
      <div class="p-8">
      <div class="mb-6"><h2 class="text-2xl font-bold">Learning & Development</h2><p class="text-slate-600 mt-1">Professional training and certification programs</p></div>
      <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
        ${[
          {title:'FNON Methodology Certification', time:'45 min', done: false, icon:'fa-brain', color:'blue'},
          {title:'tDCS Safety Protocol', time:'20 min', done: true, icon:'fa-shield-halved', color:'green'},
          {title:'Reading QEEG Maps', time:'1h 30m', done: false, icon:'fa-chart-line', color:'purple'},
          {title:'Advanced Neurostimulation', time:'2h', done: false, icon:'fa-bolt', color:'orange'},
          {title:'Patient Assessment Techniques', time:'1h 15m', done: false, icon:'fa-user-doctor', color:'indigo'},
          {title:'Clinical Documentation', time:'30 min', done: true, icon:'fa-file-medical', color:'teal'}
        ].map(l => `
          <div class="card p-6 hover:shadow-xl transition">
            <div class="flex items-start justify-between mb-4">
              <div class="w-14 h-14 rounded-xl ${l.done?'bg-orange-100 text-sozo-600':`bg-${l.color}-100 text-${l.color}-600`} flex items-center justify-center text-xl">
                <i class="fa-solid ${l.done?'fa-check':l.icon}"></i>
              </div>
              ${l.done ? '<span class="badge badge-success text-xs">Completed</span>' : '<span class="badge badge-info text-xs">Available</span>'}
            </div>
            <h4 class="font-bold text-lg mb-2">${l.title}</h4>
            <p class="text-sm text-slate-500 mb-4"><i class="fa-solid fa-clock"></i> ${l.time}</p>
            <div class="flex gap-2">
              ${l.done ? '<button class="flex-1 bg-white border-2 border-sozo-600 text-sozo-600 text-sm font-bold px-4 py-2 rounded-lg hover:bg-sozo-50 transition">View Certificate</button>' : '<button class="flex-1 bg-sozo-600 text-white text-sm font-bold px-4 py-2 rounded-lg hover:bg-sozo-700 transition">Start Course</button>'}
            </div>
          </div>
        `).join('')}
      </div>
      </div>
    `;
  }
  else if (key === 'createvisit') {
    area.innerHTML = `
      <div class="p-8">
        <div class="mb-6">
          <h2 class="text-2xl font-bold">Create Patient Visit</h2>
          <p class="text-slate-500 text-sm">Register a new patient visit with complete information</p>
        </div>
        
        <div class="card p-4 sm:p-6 max-w-full overflow-hidden mb-8">
          <form id="visitForm">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
              <!-- Patient Selection -->
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">Select Patient <span class="text-slate-600">*</span></label>
                <select id="visitPatient" class="input-royal">
                  <option value="">Choose a patient</option>
                </select>
              </div>
              
              <!-- Doctor/Provider -->
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">Treating Doctor <span class="text-slate-600">*</span></label>
                <select id="visitDoctor" class="input-royal">
                  <option value="">Select doctor</option>
                </select>
              </div>
              
              <!-- Visit Reason -->
              <div class="md:col-span-2">
                <label class="text-xs font-bold text-slate-600 block mb-2">Visit Reason <span class="text-slate-600">*</span></label>
                <textarea id="visitReason" class="input-royal" rows="3" placeholder="e.g., Follow-up consultation, Initial assessment, Treatment review"></textarea>
              </div>
              
              <!-- Referred By -->
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">Referred By</label>
                <input id="visitReferredBy" type="text" class="input-royal" placeholder="Doctor/Hospital name"/>
              </div>
              
              <!-- Recommended By -->
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">Recommended By</label>
                <input id="visitRecommendedBy" type="text" class="input-royal" placeholder="Person/Organization"/>
              </div>
              
              <!-- Admission Date -->
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">Admission Date <span class="text-slate-600">*</span></label>
                <input id="visitAdmissionDate" type="date" class="input-royal"/>
              </div>
              
              <!-- Visit Date & Time -->
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">Visit Date & Time <span class="text-slate-600">*</span></label>
                <input id="visitDateTime" type="datetime-local" class="input-royal"/>
              </div>
              
              <!-- Visit Type -->
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">Visit Type <span class="text-slate-600">*</span></label>
                <select id="visitType" class="input-royal">
                  <option value="">Select type</option>
                  <option value="In-Person">In-Person</option>
                  <option value="Telehealth">Telehealth</option>
                  <option value="Follow-up">Follow-up</option>
                  <option value="Emergency">Emergency</option>
                </select>
              </div>
              
              <!-- Priority -->
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">Priority <span class="text-slate-600">*</span></label>
                <select id="visitPriority" class="input-royal">
                  <option value="">Select priority</option>
                  <option value="Routine">Routine</option>
                  <option value="Urgent">Urgent</option>
                  <option value="Emergency">Emergency</option>
                </select>
              </div>
              
              <!-- Chief Complaint -->
              <div class="md:col-span-2">
                <label class="text-xs font-bold text-slate-600 block mb-2">Chief Complaint</label>
                <textarea id="visitChiefComplaint" class="input-royal" rows="2" placeholder="Patient's main complaint or symptoms"></textarea>
              </div>
              
              <!-- Vital Signs -->
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">Blood Pressure (mmHg)</label>
                <input id="visitBP" type="text" class="input-royal" placeholder="e.g., 120/80"/>
              </div>
              
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">Heart Rate (bpm)</label>
                <input id="visitHR" type="number" class="input-royal" placeholder="e.g., 72"/>
              </div>
              
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">Temperature (°C)</label>
                <input id="visitTemp" type="number" step="0.1" class="input-royal" placeholder="e.g., 37.2"/>
              </div>
              
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">Weight (kg)</label>
                <input id="visitWeight" type="number" step="0.1" class="input-royal" placeholder="e.g., 70"/>
              </div>
              
              <!-- Notes -->
              <div class="md:col-span-2">
                <label class="text-xs font-bold text-slate-600 block mb-2">Additional Notes</label>
                <textarea id="visitNotes" class="input-royal" rows="3" placeholder="Any additional medical notes or observations"></textarea>
              </div>
            </div>
            
            <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg mb-6">
              <p class="text-xs text-blue-800"><span class="font-bold">Note:</span> Fields marked with <span class="text-slate-600">*</span> are required</p>
            </div>
            
            <div class="flex gap-3">
              <button type="submit" class="flex-1 bg-sozo-600 text-white px-4 py-3 rounded-lg font-bold hover:bg-sozo-700">Create Visit</button>
              <button type="reset" class="flex-1 bg-slate-300 text-slate-700 px-4 py-3 rounded-lg font-bold hover:bg-slate-400">Clear Form</button>
            </div>
          </form>
        </div>

        <!-- Recent Visits List -->
        <div>
            <div class="mb-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <h3 class="text-xl font-bold text-slate-800">Recent Visits</h3>
            <div class="flex flex-wrap gap-2 w-full md:w-auto">
                <div class="relative flex-grow md:flex-grow-0">
                    <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                    <input type="text" id="visitSearch" placeholder="Search visits..." class="pl-10 pr-4 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:border-sozo-500 w-full md:w-64">
                </div>
                <div class="flex gap-1">
                    <button class="visitSort sort-btn active" data-sort="date-desc">Newest</button>
                    <button class="visitSort sort-btn" data-sort="date-asc">Oldest</button>
                    <button class="visitSort sort-btn" data-sort="priority">Priority</button>
                </div>
            </div>
            </div>

            <div class="card p-0 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                <thead class="bg-slate-50 text-slate-600 font-bold border-b">
                    <tr>
                    <th class="px-4 py-3">Date</th>
                    <th class="px-4 py-3">Patient</th>
                    <th class="px-4 py-3">Doctor</th>
                    <th class="px-4 py-3">Type</th>
                    <th class="px-4 py-3">Priority</th>
                    <th class="px-4 py-3">Reason</th>
                    <th class="px-4 py-3">Status</th>
                    </tr>
                </thead>
                <tbody id="visitTableBody">
                    <!-- Rows will be injected here -->
                </tbody>
                </table>
            </div>
            </div>
        </div>
      </div>
    `;
    
    // Populate dropdowns
    setTimeout(() => {
      const patientSelect = document.getElementById('visitPatient');
      const doctorSelect = document.getElementById('visitDoctor');
      const visitForm = document.getElementById('visitForm');
      
      if (!patientSelect || !doctorSelect) {
        console.error('Form elements not found');
        return;
      }
      
      // Populate patients
      if (sampleData && sampleData.patients) {
        sampleData.patients.forEach(p => {
          const option = document.createElement('option');
          option.value = p.id;
          option.textContent = p.name + ' (' + p.id + ')';
          patientSelect.appendChild(option);
        });
      }
      
      // Populate doctors
      if (sampleData && sampleData.doctors) {
        sampleData.doctors.forEach(d => {
          const option = document.createElement('option');
          option.value = d.id;
          option.textContent = d.name + ' - ' + (d.specialty || 'General');
          doctorSelect.appendChild(option);
        });
      }

      // Load visits from localStorage
      const storedVisits = localStorage.getItem('adminVisits');
      if (storedVisits) {
          sampleData.visits = JSON.parse(storedVisits);
      } else if (!sampleData.visits) {
          sampleData.visits = [];
      }

      function renderVisits() {
        const tbody = document.getElementById('visitTableBody');
        const searchInput = document.getElementById('visitSearch');
        if (!tbody || !searchInput) return;

        const searchTerm = searchInput.value.toLowerCase();
        const activeSortBtn = document.querySelector('.visitSort.active');
        const sortType = activeSortBtn ? activeSortBtn.dataset.sort : 'date-desc';

        let filtered = sampleData.visits.filter(v => 
            v.patientName.toLowerCase().includes(searchTerm) ||
            v.doctorName.toLowerCase().includes(searchTerm) ||
            v.visitReason.toLowerCase().includes(searchTerm) ||
            v.id.toLowerCase().includes(searchTerm)
        );

        // Sort
        filtered.sort((a, b) => {
            if (sortType === 'date-desc') return new Date(b.visitDateTime) - new Date(a.visitDateTime);
            if (sortType === 'date-asc') return new Date(a.visitDateTime) - new Date(b.visitDateTime);
            if (sortType === 'priority') {
                const pMap = { 'Emergency': 3, 'Urgent': 2, 'Routine': 1 };
                return (pMap[b.priority] || 0) - (pMap[a.priority] || 0);
            }
            return 0;
        });

        tbody.innerHTML = filtered.map(v => `
            <tr class="border-b hover:bg-slate-50">
                <td class="px-4 py-3 whitespace-nowrap">${new Date(v.visitDateTime).toLocaleString()}</td>
                <td class="px-4 py-3 font-medium">${v.patientName}</td>
                <td class="px-4 py-3">${v.doctorName}</td>
                <td class="px-4 py-3">${v.visitType}</td>
                <td class="px-4 py-3"><span class="badge badge-${v.priority === 'Emergency' ? 'danger' : v.priority === 'Urgent' ? 'warning' : 'info'}">${v.priority}</span></td>
                <td class="px-4 py-3 truncate max-w-xs" title="${v.visitReason}">${v.visitReason}</td>
                <td class="px-4 py-3"><span class="badge badge-success">${v.status}</span></td>
            </tr>
        `).join('') || '<tr><td colspan="7" class="p-4 text-center text-slate-500">No visits found</td></tr>';
      }

      // Event Listeners
      const searchInput = document.getElementById('visitSearch');
      if (searchInput) {
          searchInput.addEventListener('input', renderVisits);
      }

      document.querySelectorAll('.visitSort').forEach(btn => {
          btn.addEventListener('click', function() {
              document.querySelectorAll('.visitSort.active').forEach(b => b.classList.remove('active'));
              this.classList.add('active');
              renderVisits();
          });
      });

      renderVisits();
      
      // Form submission
      if (visitForm) {
        visitForm.addEventListener('submit', (e) => {
          e.preventDefault();
          
          const patientId = document.getElementById('visitPatient').value;
          const doctorId = document.getElementById('visitDoctor').value;
          const visitReason = document.getElementById('visitReason').value.trim();
          const visitDate = document.getElementById('visitDateTime').value;
          const visitType = document.getElementById('visitType').value;
          const priority = document.getElementById('visitPriority').value;
          
          if (!patientId || !doctorId || !visitReason || !visitDate || !visitType || !priority) {
            alert('Please fill all required fields');
            return;
          }
          
          const visitRecord = {
            id: 'VISIT-' + Math.floor(100000 + Math.random() * 900000),
            patientId,
            patientName: patientSelect.options[patientSelect.selectedIndex].text.split(' (')[0],
            doctorId,
            doctorName: doctorSelect.options[doctorSelect.selectedIndex].text,
            visitReason,
            referredBy: document.getElementById('visitReferredBy').value.trim(),
            recommendedBy: document.getElementById('visitRecommendedBy').value.trim(),
            admissionDate: document.getElementById('visitAdmissionDate').value,
            visitDateTime: visitDate,
            visitType,
            priority,
            chiefComplaint: document.getElementById('visitChiefComplaint').value.trim(),
            bloodPressure: document.getElementById('visitBP').value.trim(),
            heartRate: document.getElementById('visitHR').value.trim(),
            temperature: document.getElementById('visitTemp').value.trim(),
            weight: document.getElementById('visitWeight').value.trim(),
            notes: document.getElementById('visitNotes').value.trim(),
            createdAt: new Date().toISOString(),
            status: 'Scheduled'
          };
          
          // Store visit record
          if (!sampleData.visits) sampleData.visits = [];
          sampleData.visits.unshift(visitRecord);
          localStorage.setItem('adminVisits', JSON.stringify(sampleData.visits));
          
          alert('Visit record created successfully!');
          visitForm.reset();
          renderVisits();
        });
      }
    }, 50);
  }
  else if (key === 'profile') {
    // Doctor Profile & Finance Section - Similar to Patient Profile
    const doc = users.doctor;
    area.innerHTML = `
      <div class="p-8">
      <div class="max-w-7xl mx-auto">
        <!-- Doctor Header Card -->
        <div class="card p-8 mb-6 flex items-start gap-6 bg-gradient-to-r from-slate-50 to-orange-50 border-l-4 border-l-sozo-600">
          <div class="w-24 h-24 rounded-full border-4 border-white shadow-lg bg-orange-500 flex items-center justify-center"><i class="fa-solid fa-stethoscope text-white text-3xl"></i></div>
          <div class="flex-1">
            <h2 class="text-3xl font-bold text-slate-900">${doc.name}</h2>
            <p class="text-sm text-slate-500 font-mono mt-1">ID: ${doc.id}</p>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
              <div><span class="text-xs text-slate-500 uppercase font-bold">Specialization</span><div class="font-bold text-slate-800">Neurologist</div></div>
              <div><span class="text-xs text-slate-500 uppercase font-bold">Clinic</span><div class="font-bold text-sozo-600">${doc.clinic}</div></div>
              <div><span class="text-xs text-slate-500 uppercase font-bold">Country</span><div class="font-bold text-slate-800">${doc.country}</div></div>
              <div><span class="text-xs text-slate-500 uppercase font-bold">Status</span><div class="text-sozo-600 font-bold">Active</div></div>
            </div>
          </div>
        </div>

        <!-- Profile Tabs -->
        <div class="card p-0 overflow-hidden">
          <div class="flex border-b border-slate-200 overflow-x-auto bg-slate-50">
            <button class="doctor-profile-tab flex-1 px-6 py-4 font-bold text-slate-600 hover:bg-slate-100 border-b-2 border-sozo-600 text-sozo-600" data-tab="overview">
              <i class="fa-solid fa-user mr-2"></i> Overview
            </button>
            <button class="doctor-profile-tab flex-1 px-6 py-4 font-bold text-slate-600 hover:bg-slate-100 border-b-2 border-transparent" data-tab="finance">
              <i class="fa-solid fa-sack-dollar mr-2"></i> Finance
            </button>
            <button class="doctor-profile-tab flex-1 px-6 py-4 font-bold text-slate-600 hover:bg-slate-100 border-b-2 border-transparent" data-tab="settings">
              <i class="fa-solid fa-gear mr-2"></i> Settings
            </button>
            <button class="doctor-profile-tab flex-1 px-6 py-4 font-bold text-slate-600 hover:bg-slate-100 border-b-2 border-transparent" data-tab="partnership">
              <i class="fa-solid fa-handshake mr-2"></i> Partnership
            </button>
          </div>

          <!-- Tab Content -->
          <div class="p-8">
            <!-- Overview Tab -->
            <div id="doctor-tab-overview" class="doctor-profile-content">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                  <h3 class="font-bold text-xl mb-4 text-slate-900">Professional Information</h3>
                  <div class="space-y-3 text-sm">
                    <div class="flex justify-between border-b border-slate-100 pb-2">
                      <span class="text-slate-500">Full Name:</span>
                      <span class="font-bold text-slate-800">${doc.name}</span>
                    </div>
                    <div class="flex justify-between border-b border-slate-100 pb-2">
                      <span class="text-slate-500">Email:</span>
                      <span class="font-mono text-slate-800">${doc.email}</span>
                    </div>
                    <div class="flex justify-between border-b border-slate-100 pb-2">
                      <span class="text-slate-500">Specialty:</span>
                      <span class="font-bold text-slate-800">Neurology</span>
                    </div>
                    <div class="flex justify-between border-b border-slate-100 pb-2">
                      <span class="text-slate-500">Sub-Specialty:</span>
                      <span class="text-slate-800">Neuromodulation</span>
                    </div>
                    <div class="flex justify-between border-b border-slate-100 pb-2">
                      <span class="text-slate-500">License Number:</span>
                      <span class="font-mono text-slate-800">UK-NEU-2024-8891</span>
                    </div>
                    <div class="flex justify-between border-b border-slate-100 pb-2">
                      <span class="text-slate-500">Medical Degree:</span>
                      <span class="text-slate-800">MD, PhD</span>
                    </div>
                    <div class="flex justify-between border-b border-slate-100 pb-2">
                      <span class="text-slate-500">University:</span>
                      <span class="text-slate-800">University of London</span>
                    </div>
                    <div class="flex justify-between border-b border-slate-100 pb-2">
                      <span class="text-slate-500">Years of Experience:</span>
                      <span class="font-bold text-slate-800">15 years</span>
                    </div>
                    <div class="flex justify-between border-b border-slate-100 pb-2">
                      <span class="text-slate-500">Clinic/Practice:</span>
                      <span class="font-bold text-slate-800">${doc.clinic}</span>
                    </div>
                    <div class="flex justify-between border-b border-slate-100 pb-2">
                      <span class="text-slate-500">Country:</span>
                      <span class="font-bold text-slate-800">${doc.country}</span>
                    </div>
                    <div class="flex justify-between border-b border-slate-100 pb-2">
                      <span class="text-slate-500">Phone:</span>
                      <span class="font-mono text-slate-800">+44 20 7946 0958</span>
                    </div>
                    <div class="flex justify-between border-b border-slate-100 pb-2">
                      <span class="text-slate-500">Languages:</span>
                      <span class="text-slate-800">English, German, Spanish</span>
                    </div>
                    <div class="flex justify-between border-b border-slate-100 pb-2">
                      <span class="text-slate-500">Joined:</span>
                      <span class="text-slate-800">January 15, 2024</span>
                    </div>
                    <div class="flex justify-between border-b border-slate-100 pb-2">
                      <span class="text-slate-500">Status:</span>
                      <span class="badge badge-success">Active</span>
                    </div>
                  </div>
                  <button class="mt-6 bg-sozo-600 text-white px-6 py-3 rounded-lg font-bold text-sm hover:bg-sozo-700 shadow-lg">
                    <i class="fa-solid fa-edit mr-2"></i> Edit Profile
                  </button>
                </div>
                <div>
                  <h3 class="font-bold text-xl mb-4 text-slate-900">Practice Statistics</h3>
                  <div class="space-y-4 mb-6">
                    <div class="border border-slate-200 p-4 rounded-lg bg-blue-50">
                      <div class="flex justify-between items-center">
                        <div>
                          <p class="text-xs text-slate-500 uppercase font-bold">Total Patients</p>
                          <p class="text-3xl font-black text-blue-600 mt-1">2000</p>
                        </div>
                        <i class="fa-solid fa-users text-4xl text-blue-300"></i>
                      </div>
                    </div>
                    <div class="border border-slate-200 p-4 rounded-lg bg-orange-50">
                      <div class="flex justify-between items-center">
                        <div>
                          <p class="text-xs text-slate-500 uppercase font-bold">Assessments Completed</p>
                          <p class="text-3xl font-black text-sozo-600 mt-1">47</p>
                        </div>
                        <i class="fa-solid fa-clipboard-check text-4xl text-slate-400"></i>
                      </div>
                    </div>
                    <div class="border border-slate-200 p-4 rounded-lg bg-slate-50">
                      <div class="flex justify-between items-center">
                        <div>
                          <p class="text-xs text-slate-500 uppercase font-bold">Success Rate</p>
                          <p class="text-3xl font-black text-sozo-600 mt-1">94%</p>
                        </div>
                        <i class="fa-solid fa-chart-line text-4xl text-slate-400"></i>
                      </div>
                    </div>
                  </div>

                  <h3 class="font-bold text-xl mb-4 text-slate-900">Certifications & Training</h3>
                  <div class="space-y-2 text-sm">
                    <div class="flex items-start gap-2 border-l-2 border-sozo-600 pl-3 py-1">
                      <i class="fa-solid fa-certificate text-sozo-600 mt-1"></i>
                      <div>
                        <p class="font-bold text-slate-800">Board Certified Neurologist</p>
                        <p class="text-xs text-slate-500">Royal College of Physicians, 2010</p>
                      </div>
                    </div>
                    <div class="flex items-start gap-2 border-l-2 border-sozo-600 pl-3 py-1">
                      <i class="fa-solid fa-certificate text-sozo-600 mt-1"></i>
                      <div>
                        <p class="font-bold text-slate-800">FNON Assessment Specialist</p>
                        <p class="text-xs text-slate-500">Sozo Brain Center, 2024</p>
                      </div>
                    </div>
                    <div class="flex items-start gap-2 border-l-2 border-sozo-600 pl-3 py-1">
                      <i class="fa-solid fa-certificate text-sozo-600 mt-1"></i>
                      <div>
                        <p class="font-bold text-slate-800">Advanced Brain Mapping</p>
                        <p class="text-xs text-slate-500">International Brain Institute, 2022</p>
                      </div>
                    </div>
                    <div class="flex items-start gap-2 border-l-2 border-sozo-600 pl-3 py-1">
                      <i class="fa-solid fa-certificate text-sozo-600 mt-1"></i>
                      <div>
                        <p class="font-bold text-slate-800">Neuromodulation Therapy</p>
                        <p class="text-xs text-slate-500">European Neuro Society, 2021</p>
                      </div>
                    </div>
                  </div>
                </div>
                </div>
              </div>
            </div>

            <!-- Finance Tab -->
            <div id="doctor-tab-finance" class="doctor-profile-content hidden">
              <h3 class="font-bold text-xl mb-6 text-slate-900">Revenue & Earnings</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
                <div class="card p-5 border-l-4 border-l-green-600">
                  <p class="text-xs text-slate-500 uppercase font-bold mb-2">Total Revenue</p>
                  <p class="text-3xl font-black text-sozo-600">€45,890</p>
                  <p class="text-xs text-sozo-600 mt-2"><i class="fa-solid fa-arrow-up"></i> +12% vs last month</p>
                </div>
                <div class="card p-5 border-l-4 border-l-blue-600">
                  <p class="text-xs text-slate-500 uppercase font-bold mb-2">Patient Revenue</p>
                  <p class="text-3xl font-black text-blue-600">€32,150</p>
                  <p class="text-xs text-slate-600 mt-2">From 2000 patients</p>
                </div>
                <div class="card p-5 border-l-4 border-l-orange-600">
                  <p class="text-xs text-slate-500 uppercase font-bold mb-2">Commission</p>
                  <p class="text-3xl font-black text-orange-600">€6,883</p>
                  <p class="text-xs text-slate-600 mt-2">15% revenue share</p>
                </div>
                <div class="card p-5 border-l-4 border-l-purple-600">
                  <p class="text-xs text-slate-500 uppercase font-bold mb-2">Pending</p>
                  <p class="text-3xl font-black text-sozo-600">€6,857</p>
                  <p class="text-xs text-slate-600 mt-2">Next payout: Jan 5</p>
                </div>
                <div class="card p-5 border-l-4 border-l-sozo-600 bg-gradient-to-br from-orange-50 to-white">
                  <p class="text-xs text-slate-500 uppercase font-bold mb-2">Sozo Payments</p>
                  <p class="text-3xl font-black text-sozo-600">€13,740</p>
                  <p class="text-xs text-sozo-600 mt-2"><i class="fa-solid fa-wallet"></i> Platform earnings</p>
                </div>
              </div>

              <div class="card p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                  <h4 class="font-bold text-lg text-slate-900">Subscription Status</h4>
                  <span class="badge badge-success">Premium Tier</span>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div class="border border-slate-200 p-4 rounded-lg">
                    <p class="text-sm text-slate-600">Current Plan</p>
                    <p class="text-xl font-bold text-slate-800 mt-1">Sozo Professional</p>
                    <p class="text-xs text-slate-500 mt-2">€199/month • Renews Feb 1, 2025</p>
                  </div>
                  <div class="border border-slate-200 p-4 rounded-lg">
                    <p class="text-sm text-slate-600">Revenue Sharing</p>
                    <p class="text-xl font-bold text-slate-800 mt-1">85% / 15%</p>
                    <p class="text-xs text-slate-500 mt-2">You keep 85% of patient fees</p>
                  </div>
                </div>
                <button class="mt-4 text-sozo-600 font-bold text-sm hover:underline">
                  <i class="fa-solid fa-credit-card mr-1"></i> View Payment Details
                </button>
              </div>

              <div class="card p-0 overflow-hidden">
                <div class="bg-slate-800 text-white p-4 font-bold flex justify-between items-center">
                  <span>Recent Transactions</span>
                  <button class="text-xs bg-white text-slate-800 px-3 py-1 rounded-md font-bold hover:bg-slate-100">Export</button>
                </div>
                <table>
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Patient</th>
                      <th>Service</th>
                      <th>Amount</th>
                      <th>Commission</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>Dec 28, 2024</td>
                      <td>Alex Johnson</td>
                      <td>FNON Assessment</td>
                      <td class="font-mono font-bold text-sozo-600">€250.00</td>
                      <td class="font-mono text-slate-600">€37.50</td>
                      <td><span class="badge badge-success">Paid</span></td>
                    </tr>
                    <tr>
                      <td>Dec 26, 2024</td>
                      <td>Maria Gomez</td>
                      <td>Brain Mapping</td>
                      <td class="font-mono font-bold text-sozo-600">€380.00</td>
                      <td class="font-mono text-slate-600">€57.00</td>
                      <td><span class="badge badge-success">Paid</span></td>
                    </tr>
                    <tr>
                      <td>Dec 24, 2024</td>
                      <td>Liam Smith</td>
                      <td>PRS Assessment</td>
                      <td class="font-mono font-bold text-sozo-600">€180.00</td>
                      <td class="font-mono text-slate-600">€27.00</td>
                      <td><span class="badge badge-success">Paid</span></td>
                    </tr>
                    <tr>
                      <td>Dec 22, 2024</td>
                      <td>Emma Chen</td>
                      <td>Follow-up Session</td>
                      <td class="font-mono font-bold text-orange-600">€150.00</td>
                      <td class="font-mono text-slate-600">€22.50</td>
                      <td><span class="badge badge-warning">Pending</span></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Settings Tab -->
            <div id="doctor-tab-settings" class="doctor-profile-content hidden">
              <h3 class="font-bold text-xl mb-6 text-slate-900">Account Settings</h3>
              <div class="space-y-4">
                <div class="card p-5">
                  <h4 class="font-bold text-slate-800 mb-4">Notification Preferences</h4>
                  <div class="space-y-3">
                    <div class="flex items-center justify-between p-3 border border-slate-200 rounded-lg">
                      <div>
                        <p class="font-bold text-slate-800">New Patient Appointments</p>
                        <p class="text-xs text-slate-500">Email notification for new bookings</p>
                      </div>
                      <input type="checkbox" class="w-5 h-5 accent-sozo-600" checked />
                    </div>
                    <div class="flex items-center justify-between p-3 border border-slate-200 rounded-lg">
                      <div>
                        <p class="font-bold text-slate-800">Revenue Updates</p>
                        <p class="text-xs text-slate-500">Weekly revenue summaries</p>
                      </div>
                      <input type="checkbox" class="w-5 h-5 accent-sozo-600" checked />
                    </div>
                    <div class="flex items-center justify-between p-3 border border-slate-200 rounded-lg">
                      <div>
                        <p class="font-bold text-slate-800">Platform Updates</p>
                        <p class="text-xs text-slate-500">New features and announcements</p>
                      </div>
                      <input type="checkbox" class="w-5 h-5 accent-sozo-600" />
                    </div>
                  </div>
                </div>

                <div class="card p-5">
                  <h4 class="font-bold text-slate-800 mb-4">Security Settings</h4>
                  <div class="space-y-3">
                    <button class="w-full text-left p-3 border border-slate-200 rounded-lg hover:bg-slate-50 transition">
                      <p class="font-bold text-slate-800">Change Password</p>
                      <p class="text-xs text-slate-500">Last changed: 30 days ago</p>
                    </button>
                    <button class="w-full text-left p-3 border border-slate-200 rounded-lg hover:bg-slate-50 transition">
                      <p class="font-bold text-slate-800">Two-Factor Authentication</p>
                      <p class="text-xs text-sozo-600"><i class="fa-solid fa-check-circle"></i> Enabled</p>
                    </button>
                    <button class="w-full text-left p-3 border border-slate-200 rounded-lg hover:bg-slate-50 transition">
                      <p class="font-bold text-slate-800">Active Sessions</p>
                      <p class="text-xs text-slate-500">Manage logged-in devices</p>
                    </button>
                  </div>
                </div>

                <button class="w-full bg-sozo-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-sozo-700">
                  Save Settings
                </button>
              </div>
            </div>

            <!-- Partnership Tab -->
            <div id="doctor-tab-partnership" class="doctor-profile-content hidden">
              <h3 class="font-bold text-xl mb-6 text-slate-900">Partnership Program</h3>
              <div class="card p-6 mb-6 bg-gradient-to-r from-orange-50 to-orange-50 border-l-4 border-l-sozo-600">
                <div class="flex items-start gap-4">
                  <div class="w-16 h-16 rounded-full bg-sozo-600 text-white flex items-center justify-center text-2xl flex-shrink-0">
                    <i class="fa-solid fa-handshake"></i>
                  </div>
                  <div class="flex-1">
                    <h4 class="font-bold text-xl text-slate-900 mb-2">Become a Sozo Partner</h4>
                    <p class="text-slate-700 mb-4">Join our exclusive network of neuromodulation experts. Unlock premium features, higher revenue sharing, and priority support.</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                      <div class="bg-white p-3 rounded-lg border border-orange-200">
                        <p class="text-xs text-slate-500 uppercase font-bold">Revenue Share</p>
                        <p class="text-2xl font-bold text-sozo-600">90%</p>
                        <p class="text-xs text-slate-600">vs 85% standard</p>
                      </div>
                      <div class="bg-white p-3 rounded-lg border border-orange-200">
                        <p class="text-xs text-slate-500 uppercase font-bold">Priority Support</p>
                        <p class="text-2xl font-bold text-blue-600">24/7</p>
                        <p class="text-xs text-slate-600">Dedicated account manager</p>
                      </div>
                      <div class="bg-white p-3 rounded-lg border border-orange-200">
                        <p class="text-xs text-slate-500 uppercase font-bold">Partnership Fee</p>
                        <p class="text-2xl font-bold text-sozo-600">€80k</p>
                        <p class="text-xs text-slate-600">One-time investment</p>
                      </div>
                    </div>
                    <button onclick="openPartnershipModal()" class="bg-sozo-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-sozo-700 shadow-lg">
                      <i class="fa-solid fa-plus mr-2"></i> Apply for Partnership
                    </button>
                  </div>
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="card p-5">
                  <h4 class="font-bold text-slate-800 mb-3"><i class="fa-solid fa-star text-slate-600 mr-2"></i>Partner Benefits</h4>
                  <ul class="space-y-2 text-sm text-slate-700">
                    <li class="flex items-start gap-2"><i class="fa-solid fa-check text-sozo-600 mt-1"></i><span>Higher revenue sharing (90% vs 85%)</span></li>
                    <li class="flex items-start gap-2"><i class="fa-solid fa-check text-sozo-600 mt-1"></i><span>Priority patient referrals</span></li>
                    <li class="flex items-start gap-2"><i class="fa-solid fa-check text-sozo-600 mt-1"></i><span>Advanced analytics dashboard</span></li>
                    <li class="flex items-start gap-2"><i class="fa-solid fa-check text-sozo-600 mt-1"></i><span>Exclusive training workshops</span></li>
                    <li class="flex items-start gap-2"><i class="fa-solid fa-check text-sozo-600 mt-1"></i><span>Co-marketing opportunities</span></li>
                    <li class="flex items-start gap-2"><i class="fa-solid fa-check text-sozo-600 mt-1"></i><span>24/7 dedicated support</span></li>
                  </ul>
                </div>
                <div class="card p-5">
                  <h4 class="font-bold text-slate-800 mb-3"><i class="fa-solid fa-trophy text-sozo-600 mr-2"></i>Success Stories</h4>
                  <div class="space-y-3">
                    <div class="border-l-4 border-l-green-500 pl-3 py-2">
                      <p class="text-sm font-bold text-slate-800">Dr. Sarah Chen</p>
                      <p class="text-xs text-slate-600">"Revenue increased 340% in first 6 months"</p>
                    </div>
                    <div class="border-l-4 border-l-blue-500 pl-3 py-2">
                      <p class="text-sm font-bold text-slate-800">Dr. Michael Torres</p>
                      <p class="text-xs text-slate-600">"Best investment in my practice's future"</p>
                    </div>
                    <div class="border-l-4 border-l-purple-500 pl-3 py-2">
                      <p class="text-sm font-bold text-slate-800">Dr. Emma Williams</p>
                      <p class="text-xs text-slate-600">"Partner support team is exceptional"</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      </div>
    `;

    // Tab switching functionality
    setTimeout(() => {
      const tabs = document.querySelectorAll('.doctor-profile-tab');
      const contents = document.querySelectorAll('.doctor-profile-content');
      
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const targetTab = tab.dataset.tab;
          
          // Remove active classes from all tabs
          tabs.forEach(t => {
            t.classList.remove('border-sozo-600', 'text-sozo-600');
            t.classList.add('border-transparent', 'text-slate-600');
          });
          
          // Add active class to clicked tab
          tab.classList.remove('border-transparent', 'text-slate-600');
          tab.classList.add('border-sozo-600', 'text-sozo-600');
          
          // Hide all content
          contents.forEach(c => c.classList.add('hidden'));
          
          // Show target content
          const targetContent = document.getElementById(`doctor-tab-${targetTab}`);
          if (targetContent) targetContent.classList.remove('hidden');
        });
      });
    }, 50);
  }
}

// Partnership Modal Function
function openPartnershipModal() {
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.innerHTML = `
    <div class="modal-content max-w-2xl">
      <div class="p-6 border-b border-slate-200">
        <h3 class="text-2xl font-bold text-slate-900">Partnership Application</h3>
        <p class="text-sm text-slate-600 mt-1">Fill out the form below to apply for Sozo Partnership Program</p>
      </div>
      <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="text-xs font-bold text-slate-500 uppercase">Organization Name *</label>
            <input type="text" class="input-royal" placeholder="Your clinic or practice name" required />
          </div>
          <div>
            <label class="text-xs font-bold text-slate-500 uppercase">Contact Email *</label>
            <input type="email" class="input-royal" placeholder="your.email@clinic.com" required />
          </div>
          <div>
            <label class="text-xs font-bold text-slate-500 uppercase">Phone Number</label>
            <input type="tel" class="input-royal" placeholder="+1 (555) 123-4567" />
          </div>
          <div>
            <label class="text-xs font-bold text-slate-500 uppercase">Country *</label>
            <select class="input-royal" required>
              <option value="">Select country</option>
              <option value="UK">United Kingdom</option>
              <option value="Germany">Germany</option>
              <option value="USA">United States</option>
              <option value="France">France</option>
              <option value="Spain">Spain</option>
            </select>
          </div>
          <div class="md:col-span-2">
            <label class="text-xs font-bold text-slate-500 uppercase">Why do you want to become a partner?</label>
            <textarea class="input-royal" rows="4" placeholder="Tell us about your practice and goals..."></textarea>
          </div>
        </div>
      </div>
      <div class="p-6 border-t border-slate-200 flex justify-end gap-3">
        <button onclick="this.closest('.modal').remove()" class="btn-secondary">Cancel</button>
        <button onclick="handlePartnershipSubmit()" class="btn-primary">Submit Application</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

function handlePartnershipSubmit() {
  alert('Partnership application submitted successfully! Our team will review your application and contact you within 2-3 business days.');
  document.querySelector('.modal')?.remove();
}

// Clear Report Filters
function clearReportFilters() {
  document.getElementById('filterPatient').value = '';
  document.getElementById('filterType').value = '';
  document.getElementById('filterCountry').value = '';
  document.getElementById('filterStart').value = '';
  document.getElementById('filterEnd').value = '';
  // Trigger filter update
  document.getElementById('filterPatient').dispatchEvent(new Event('input'));
}

// Assessment Navigation Helper
function getAssessmentNavigation(currentAssessment) {
  const assessments = [
    { id: 'fnon', label: 'FNON', icon: 'fa-clipboard-check', color: 'bg-sozo-600' },
    { id: 'brainmapping', label: 'Brain Mapping', icon: 'fa-brain', color: 'bg-brand-blue' },
    { id: 'prs', label: 'PRS', icon: 'fa-clipboard-list', color: 'bg-slate-600' },
    { id: 'doctornotes', label: currentRole === 'patient' ? 'Prescription' : 'Doctor\'s Notes', icon: 'fa-comment-medical', color: 'bg-orange-500' },
    { id: 'treatmentplan', label: 'Treatment Plan', icon: 'fa-notes-medical', color: 'bg-orange-600' },
    { id: 'finalreport', label: 'Final Report', icon: 'fa-file-medical', color: 'bg-slate-600' }
  ].filter(item => {
    // Hide brain mapping for patients
    if (currentRole === 'patient' && item.id === 'brainmapping') return false;
    
    // For first visit patients, hide FNON and PRS
    if (currentRole === 'patient' && selectedVisit === 'first-visit') {
      if (item.id === 'fnon' || item.id === 'prs') return false;
    }
    
    return true;
  });
  
  return `
    <div class="mb-6 bg-white border border-slate-200 rounded-lg p-4 shadow-sm">
      <div class="flex items-center justify-between flex-wrap gap-3">
        <div class="flex items-center gap-2">
          <i class="fa-solid fa-route text-slate-500"></i>
          <span class="text-sm font-bold text-slate-600">Assessment Navigation:</span>
        </div>
        <div class="flex gap-2 flex-wrap">
          ${assessments.map(assess => `
            <button 
              onclick="loadSection('${assess.id}')" 
              class="px-4 py-2 rounded-lg font-bold text-sm transition ${
                assess.id === currentAssessment 
                  ? assess.color + ' text-white shadow-md' 
                  : 'bg-slate-100 text-slate-700 hover:bg-slate-200'
              }"
              ${assess.id === currentAssessment ? 'disabled' : ''}
            >
              <i class="fa-solid ${assess.icon} mr-2"></i>${assess.label}
            </button>
          `).join('')}
        </div>
      </div>
    </div>
  `;
}

// -- DOCTOR'S NOTES MODULE LOGIC --
function renderDoctorNotes() {
  const area = document.getElementById('contentArea');
  // For patient role, auto-select their own patient context
  if(currentRole === 'patient' && !globalSelectedPatientId) {
    const ap = getActivePatient();
    if(ap?.id) globalSelectedPatientId = ap.id;
  }
  
  // Auto-populate patient details if globalSelectedPatientId is set
  if(globalSelectedPatientId && !globalState.currentPatient) {
    const selectedPatient = sampleData.patients.find(p => p.id === globalSelectedPatientId);
    if(selectedPatient) {
      globalState.currentPatient = selectedPatient;
    }
  }
  
  const p = globalState.currentPatient || getActivePatient();
  if (!p) {
    area.innerHTML = `
      <div class="p-8">
        <div class="bg-slate-50 border border-slate-300 rounded-lg p-6">
          <p class="text-slate-700 font-bold">No patient selected</p>
          <p class="text-sm text-slate-700 mt-2">Please select a patient to enter doctor's notes.</p>
        </div>
      </div>
    `;
    return;
  }

  area.innerHTML = `
    <div class="p-8">
      ${getAssessmentNavigation('doctornotes')}

      <!-- Header -->
      <div class="mb-6 flex items-center justify-between">
        <div>
          <h2 class="text-3xl font-black text-slate-900">${currentRole === 'patient' ? 'Prescription' : 'Doctor\'s Notes & Comments'}</h2>
          <p class="text-slate-600 mt-1">${currentRole === 'patient' ? 'Medications and treatment instructions from your doctor' : 'Clinical observations, recommendations, and medication notes for ' + p.name}</p>
        </div>
        ${currentRole !== 'patient' ? `
        <button onclick="loadSection('patienthistory')" class="btn-secondary text-sm">
          <i class="fa-solid fa-arrow-left mr-2"></i>Back to Patient History
        </button>
        ` : ''}
      </div>

      <!-- Patient Info Banner -->
      <div class="card p-4 mb-6 bg-gradient-to-r from-blue-50 to-slate-50">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-slate-600 flex items-center justify-center text-white text-lg font-bold">
            ${p.name.split(' ').map(n => n[0]).join('')}
          </div>
          <div>
            <h3 class="font-bold text-slate-900">${p.name}</h3>
            <p class="text-sm text-slate-600">ID: ${p.id} • ${p.age} years old • ${p.condition || 'General Assessment'}</p>
          </div>
        </div>
      </div>

      <!-- Doctor Notes Card -->
      <div class="card p-6 border border-slate-200 bg-gradient-to-r from-slate-50 to-white">
        <h3 class="font-bold text-slate-900 mb-4"><i class="fa-solid fa-comment-medical mr-2"></i>Doctor's Notes & Comments</h3>
        <div class="space-y-4">
          ${currentRole !== 'patient' ? `
          <div>
            <label class="text-xs font-bold text-slate-500 uppercase">Clinical Observations</label>
            <textarea id="doctorNotes" class="input-royal min-h-32" placeholder="Enter clinical observations, assessment notes, or any relevant comments...">Patient presents with moderate cognitive decline consistent with early-stage dementia. Notable impairments in short-term memory and executive function. Patient is oriented to person and place but occasionally confused about time. Family reports increasing difficulty with daily activities and mild behavioral changes over the past 6 months. Physical examination reveals no acute neurological deficits. Patient's speech is coherent but shows occasional word-finding difficulties.</textarea>
          </div>
          ` : ''}
          <div>
            <label class="text-xs font-bold text-slate-500 uppercase">Recommendations</label>
            <textarea id="doctorRecommendations" class="input-royal min-h-24" placeholder="Enter treatment recommendations, follow-up instructions, or medication notes...">Recommend initiating cognitive rehabilitation therapy 3 times per week. Family should be educated on dementia care strategies and home safety modifications. Patient would benefit from structured daily routines and cognitive stimulation activities. Consider referral to occupational therapy for ADL assessment. Schedule follow-up appointment in 3 months to reassess cognitive function and adjust treatment plan accordingly.</textarea>
          </div>
          <div>
            <label class="text-xs font-bold text-slate-500 uppercase mb-3 block">
              <i class="fa-solid fa-pills mr-2"></i>Prescribed Medications
            </label>
            
            ${currentRole === 'patient' ? `
            <!-- Patient View - Medication Grid -->
            <div class="bg-white rounded-lg border-2 border-slate-200 overflow-hidden">
              <div class="overflow-x-auto">
                <table class="w-full">
                  <thead>
                    <tr class="bg-gradient-to-r from-blue-500 to-slate-600 text-white">
                      <th class="px-4 py-3 text-left font-bold">Medicine Name</th>
                      <th class="px-4 py-3 text-center font-bold">Dosage</th>
                      <th class="px-4 py-3 text-center font-bold">
                        <i class="fa-solid fa-sunrise mr-1"></i>Morning
                      </th>
                      <th class="px-4 py-3 text-center font-bold">
                        <i class="fa-solid fa-sun mr-1"></i>Afternoon
                      </th>
                      <th class="px-4 py-3 text-center font-bold">
                        <i class="fa-solid fa-moon mr-1"></i>Dinner
                      </th>
                      <th class="px-4 py-3 text-left font-bold">Instructions</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-slate-200">
                    <tr class="hover:bg-blue-50 transition">
                      <td class="px-4 py-4">
                        <div class="font-bold text-slate-900">Donepezil</div>
                        <div class="text-xs text-slate-500">Cholinesterase Inhibitor</div>
                      </td>
                      <td class="px-4 py-4 text-center">
                        <span class="bg-slate-100 text-slate-800 px-3 py-1 rounded-full text-sm font-bold">5mg</span>
                      </td>
                      <td class="px-4 py-4 text-center">
                        <span class="inline-flex items-center justify-center w-10 h-10 bg-orange-500 text-white rounded-full font-bold text-lg">1</span>
                      </td>
                      <td class="px-4 py-4 text-center">
                        <span class="inline-flex items-center justify-center w-10 h-10 bg-slate-200 text-slate-400 rounded-full font-bold">-</span>
                      </td>
                      <td class="px-4 py-4 text-center">
                        <span class="inline-flex items-center justify-center w-10 h-10 bg-slate-200 text-slate-400 rounded-full font-bold">-</span>
                      </td>
                      <td class="px-4 py-4">
                        <div class="flex items-center gap-2">
                          <span class="bg-orange-100 text-orange-700 px-2 py-1 rounded text-xs font-bold">After Meal</span>
                          <span class="text-slate-600 text-sm">with water</span>
                        </div>
                      </td>
                    </tr>
                    <tr class="hover:bg-blue-50 transition">
                      <td class="px-4 py-4">
                        <div class="font-bold text-slate-900">Vitamin B12</div>
                        <div class="text-xs text-slate-500">Supplement</div>
                      </td>
                      <td class="px-4 py-4 text-center">
                        <span class="bg-slate-100 text-slate-700 px-3 py-1 rounded-full text-sm font-bold">1000mcg</span>
                      </td>
                      <td class="px-4 py-4 text-center">
                        <span class="inline-flex items-center justify-center w-10 h-10 bg-orange-500 text-white rounded-full font-bold text-lg">1</span>
                      </td>
                      <td class="px-4 py-4 text-center">
                        <span class="inline-flex items-center justify-center w-10 h-10 bg-slate-200 text-slate-400 rounded-full font-bold">-</span>
                      </td>
                      <td class="px-4 py-4 text-center">
                        <span class="inline-flex items-center justify-center w-10 h-10 bg-slate-200 text-slate-400 rounded-full font-bold">-</span>
                      </td>
                      <td class="px-4 py-4">
                        <div class="flex items-center gap-2">
                          <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold">Before Meal</span>
                          <span class="text-slate-600 text-sm">on empty stomach</span>
                        </div>
                      </td>
                    </tr>
                    <tr class="hover:bg-blue-50 transition">
                      <td class="px-4 py-4">
                        <div class="font-bold text-slate-900">Vitamin D</div>
                        <div class="text-xs text-slate-500">Supplement</div>
                      </td>
                      <td class="px-4 py-4 text-center">
                        <span class="bg-slate-100 text-slate-700 px-3 py-1 rounded-full text-sm font-bold">2000 IU</span>
                      </td>
                      <td class="px-4 py-4 text-center">
                        <span class="inline-flex items-center justify-center w-10 h-10 bg-slate-200 text-slate-400 rounded-full font-bold">-</span>
                      </td>
                      <td class="px-4 py-4 text-center">
                        <span class="inline-flex items-center justify-center w-10 h-10 bg-slate-200 text-slate-400 rounded-full font-bold">-</span>
                      </td>
                      <td class="px-4 py-4 text-center">
                        <span class="inline-flex items-center justify-center w-10 h-10 bg-orange-500 text-white rounded-full font-bold text-lg">1</span>
                      </td>
                      <td class="px-4 py-4">
                        <div class="flex items-center gap-2">
                          <span class="bg-orange-100 text-orange-700 px-2 py-1 rounded text-xs font-bold">After Meal</span>
                          <span class="text-slate-600 text-sm">for better absorption</span>
                        </div>
                      </td>
                    </tr>
                    <tr class="hover:bg-blue-50 transition">
                      <td class="px-4 py-4">
                        <div class="font-bold text-slate-900">Omega-3 Fatty Acids</div>
                        <div class="text-xs text-slate-500">Supplement</div>
                      </td>
                      <td class="px-4 py-4 text-center">
                        <span class="bg-slate-100 text-slate-700 px-3 py-1 rounded-full text-sm font-bold">1000mg</span>
                      </td>
                      <td class="px-4 py-4 text-center">
                        <span class="inline-flex items-center justify-center w-10 h-10 bg-orange-500 text-white rounded-full font-bold text-lg">1</span>
                      </td>
                      <td class="px-4 py-4 text-center">
                        <span class="inline-flex items-center justify-center w-10 h-10 bg-slate-200 text-slate-400 rounded-full font-bold">-</span>
                      </td>
                      <td class="px-4 py-4 text-center">
                        <span class="inline-flex items-center justify-center w-10 h-10 bg-orange-500 text-white rounded-full font-bold text-lg">1</span>
                      </td>
                      <td class="px-4 py-4">
                        <div class="flex items-center gap-2">
                          <span class="bg-orange-100 text-orange-700 px-2 py-1 rounded text-xs font-bold">After Meal</span>
                          <span class="text-slate-600 text-sm">twice daily</span>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              
              <!-- Legend -->
              <div class="bg-slate-50 px-4 py-3 border-t border-slate-200">
                <div class="flex items-center gap-6 text-xs text-slate-600">
                  <div class="flex items-center gap-2">
                    <span class="inline-flex items-center justify-center w-6 h-6 bg-orange-500 text-white rounded-full font-bold text-xs">1</span>
                    <span>Take this many pills</span>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="inline-flex items-center justify-center w-6 h-6 bg-slate-200 text-slate-400 rounded-full font-bold">-</span>
                    <span>Skip this time</span>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="bg-orange-100 text-orange-700 px-2 py-1 rounded font-bold">After Meal</span>
                    <span>Take after eating</span>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded font-bold">Before Meal</span>
                    <span>Take before eating</span>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Additional Notes for Patient -->
            <div class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
              <h4 class="font-bold text-blue-900 mb-2">
                <i class="fa-solid fa-info-circle mr-2"></i>Important Medication Information
              </h4>
              <ul class="text-sm text-blue-800 space-y-1">
                <li><i class="fa-solid fa-check mr-2 text-blue-600"></i>Patient tolerating all medications well with no reported side effects</li>
                <li><i class="fa-solid fa-check mr-2 text-blue-600"></i>Donepezil dose may be increased to 10mg after 4-6 weeks if tolerated</li>
                <li><i class="fa-solid fa-check mr-2 text-blue-600"></i>Monitor for potential drug interactions with new prescriptions</li>
                <li><i class="fa-solid fa-check mr-2 text-blue-600"></i>No known drug allergies on record</li>
                <li><i class="fa-solid fa-exclamation-triangle mr-2 text-orange-600"></i>Please inform your doctor of any side effects immediately</li>
              </ul>
            </div>
            ` : `
            <!-- Doctor/Staff View - Text Area -->
            <textarea id="doctorMedicationNotes" class="input-royal min-h-24" placeholder="Enter Medication Notes">Currently on Donepezil 5mg daily (cholinesterase inhibitor). Patient tolerating medication well with no reported side effects. Plan to increase to 10mg after 4-6 weeks if tolerated. Supplement regimen includes Vitamin B12 (1000mcg), Vitamin D (2000 IU), and Omega-3 fatty acids. Monitor for potential drug interactions with new prescriptions. Patient has no known drug allergies. Family educated on importance of medication adherence and potential side effects to watch for.</textarea>
            `}
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex justify-between items-center mt-6">
        ${currentRole !== 'patient' || selectedVisit !== 'first-visit' ? `
        <button onclick="loadSection('prs')" class="btn-secondary">
          <i class="fa-solid fa-arrow-left mr-2"></i>Back to PRS
        </button>
        ` : '<div></div>'}
        <div class="flex gap-3">
          ${currentRole !== 'patient' ? `
            <button onclick="alert('Draft saved successfully!')" class="bg-slate-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-slate-700 transition">
              <i class="fa-solid fa-save mr-2"></i>Save Draft
            </button>
            <button onclick="alert('Notes submitted successfully!'); loadSection('treatmentplan');" class="btn-primary px-6 py-3">
              <i class="fa-solid fa-arrow-right mr-2"></i>Continue to Treatment Plan
            </button>
          ` : ''}
        </div>
      </div>
    </div>
  `;
}

// -- TREATMENT PLAN MODULE LOGIC --
// -- TREATMENT PLAN MODULE LOGIC --
let treatmentPlanState = {
  devices: [], // Array of up to 3 devices
  activeDeviceTab: 0,
  maxDevices: 3,
  networkTabs: {}, // Track network tabs per device: {deviceIndex: [{networkId, networkName, isActive}]}
  // Sub-tab inside Treatment Plan (either 'devices' or 'parameters')
  activeTreatmentSubTab: 'devices',
  // Main tabs for the Treatment Plan page: 'devices' or 'parameters' (full tab)
  activeTreatmentMainTab: 'devices'
};

// Persistence Logic
const STORAGE_KEY = 'sozo_treatment_plan';
const CUSTOM_MONTAGES_KEY = 'sozo_custom_montages';

// Custom Montages Storage
let customMontagesLibrary = [];

function loadCustomMontages() {
  try {
    const saved = localStorage.getItem(CUSTOM_MONTAGES_KEY);
    if (saved) {
      customMontagesLibrary = JSON.parse(saved);
      console.log('Custom Montages loaded from storage:', customMontagesLibrary.length, 'montages');
    }
  } catch (e) {
    console.error('Error loading custom montages:', e);
  }
  return customMontagesLibrary;
}

function saveCustomMontageToLibrary(montageName, anodes, cathode, deviceType, baseNetwork) {
  console.log('[saveCustomMontageToLibrary] Saving:', { montageName, anodes, cathode, deviceType, baseNetwork });
  
  const customMontage = {
    id: `custom_${Date.now()}`,
    name: montageName,
    anodes: anodes,
    cathode: cathode,
    deviceType: deviceType,
    baseNetwork: baseNetwork,
    createdAt: new Date().toISOString(),
    description: `Custom montage: ${anodes.join(', ')} → ${cathode}`
  };
  
  customMontagesLibrary.push(customMontage);
  console.log('[saveCustomMontageToLibrary] Library now has', customMontagesLibrary.length, 'montages');
  
  try {
    localStorage.setItem(CUSTOM_MONTAGES_KEY, JSON.stringify(customMontagesLibrary));
    console.log('[saveCustomMontageToLibrary] Saved to localStorage successfully');
  } catch (e) {
    console.error('[saveCustomMontageToLibrary] Failed to save to localStorage:', e);
  }
  
  return customMontage;
}

function getCustomMontagesForDevice(deviceType) {
  return customMontagesLibrary.filter(m => m.deviceType === deviceType);
}

function loadTreatmentPlanState() {
  try {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      treatmentPlanState = JSON.parse(saved);
      console.log('Treatment Plan loaded from storage');
    }
  } catch (e) {
    console.error('Failed to load treatment plan state', e);
  }
}

function saveTreatmentPlanState() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(treatmentPlanState));
    console.log('Treatment Plan saved to storage');
  } catch (e) {
    console.error('Failed to save treatment plan state', e);
  }
}

// Load state on initialization
loadTreatmentPlanState();
loadCustomMontages();

// Restore visual state from stored data
function restoreTreatmentPlanHighlights() {
  treatmentPlanState.devices.forEach((device, i) => {
    // 1. Update Dropdown
    const select = document.getElementById(`networkSelect_${i}`);
    if (select && device.selectedNetwork !== undefined && device.selectedNetwork !== '') {
      select.value = device.selectedNetwork;
      document.getElementById(`networkDetails_${i}`).classList.remove('hidden');
    }

    // 2. Update Details Text
    if (device.selectedNetwork !== undefined && device.selectedNetwork !== '') {
       const networks = getDummyNetworks(device.value);
       const network = networks[device.selectedNetwork];
       if (network) {
         const nameEl = document.getElementById(`networkName_${i}`);
         if (nameEl) {
             let name = network.name;
             if (device.customMontageName) {
                 name += ` ${device.customMontageName}`;
             }
             nameEl.textContent = name;
         }
         
         const descEl = document.getElementById(`networkDesc_${i}`);
         if (descEl) descEl.textContent = network.description;
         
         const indEl = document.getElementById(`networkIndication_${i}`);
         if (indEl) indEl.textContent = network.indication;
       }
    }

    // 3. Update Electrodes Text
    const anodesEl = document.getElementById(`networkAnodes_${i}`);
    if (anodesEl && device.montage.anodes) {
        anodesEl.textContent = device.montage.anodes.join(', ');
    }
    
    const cathodeEl = document.getElementById(`networkCathode_${i}`);
    if (cathodeEl) {
        cathodeEl.textContent = device.montage.cathode || '';
    }
    
    // 4. Update Info Panel
    const infoEl = document.getElementById(`networkInfo_${i}`);
    if (infoEl && device.selectedNetwork !== undefined && device.selectedNetwork !== '') {
       const networks = getDummyNetworks(device.value);
       const network = networks[device.selectedNetwork];
       if (network) {
           infoEl.innerHTML = `
            <p class="text-xs font-bold text-purple-900 mb-1">
              <i class="fa-solid fa-bolt mr-1"></i>Active Network: ${network.name}${device.customMontageName ? ` ${device.customMontageName}` : ''}
            </p>
            <p class="text-xs text-purple-700">
              Anodes: <span class="font-mono font-bold">${device.montage.anodes ? device.montage.anodes.join(', ') : ''}</span> | 
              Cathode: <span class="font-mono font-bold">${device.montage.cathode || ''}</span>
            </p>
          `;
       }
    }

    // 5. Highlight Electrodes (Only for brain devices)
    if (usesBrainMontage(device.value) && device.montage && device.montage.anodes) {
      highlightNetworkElectrodes(i, device.montage.anodes, device.montage.cathode);
    }
  });
}

function populateCustomMontagesForAllDevices() {
  treatmentPlanState.devices.forEach((device, i) => {
    if (usesBrainMontage(device.value)) {
      populateCustomMontagesForDevice(i);
    }
  });
}

function populateCustomMontagesForDevice(deviceIndex) {
  const optgroup = document.getElementById(`customMontagesOptgroup_${deviceIndex}`);
  
  if (!optgroup) return;
  
  const device = treatmentPlanState.devices[deviceIndex];
  if (!device) return;
  
  // Get custom montages for this device type
  const deviceMontages = customMontagesLibrary.filter(m => m.deviceType === device.value);
  
  if (deviceMontages.length === 0) {
    optgroup.innerHTML = '<option value="" disabled>No custom montages saved</option>';
    return;
  }
  
  // Build options from array
  let html = '';
  deviceMontages.forEach(montage => {
    html += `<option value="${montage.id}">⭐ ${montage.name}</option>`;
  });
  
  optgroup.innerHTML = html;
}

// Original implementation preserved below for reference
function populateCustomMontagesForDevice_OLD(deviceIndex) {
  const device = treatmentPlanState.devices[deviceIndex];
  if (!device || !usesBrainMontage(device.value)) return;
  
  const customMontages = getCustomMontagesForDevice(device.value);
  const listEl = document.getElementById(`customMontagesList_${deviceIndex}`);
  const countEl = document.getElementById(`customMontageCount_${deviceIndex}`);
  
  if (countEl) {
    countEl.textContent = customMontages.length;
  }
  
  if (listEl) {
    if (customMontages.length === 0) {
      listEl.innerHTML = '<p class="text-xs text-slate-500 italic text-center py-2">No custom montages saved yet</p>';
    } else {
      listEl.innerHTML = customMontages.map(montage => `
        <button 
          onclick="loadCustomMontage(${deviceIndex}, '${montage.id}')"
          class="w-full text-left px-3 py-2 rounded hover:bg-purple-50 transition-colors text-xs border border-transparent hover:border-purple-300 group"
        >
          <div class="flex items-center justify-between">
            <div>
              <span class="font-semibold text-purple-900">${montage.name}</span>
              <div class="text-[10px] text-purple-600">${montage.description}</div>
            </div>
            <div class="opacity-0 group-hover:opacity-100 transition-opacity">
              <i class="fa-solid fa-arrow-right text-purple-500 text-xs"></i>
            </div>
          </div>
        </button>
      `).join('');
    }
  }
}

function loadCustomMontage(deviceIndex, montageId) {
  const customMontage = customMontagesLibrary.find(m => m.id === montageId);
  if (!customMontage) return;
  
  const device = treatmentPlanState.devices[deviceIndex];
  if (!device) return;
  
  // Apply the custom montage
  device.montage.anodes = [...customMontage.anodes];
  device.montage.cathode = customMontage.cathode;
  device.customMontageName = `(${customMontage.name})`;
  device.selectedNetwork = ''; // Clear network selection as this is custom
  
  // Update UI
  highlightNetworkElectrodes(deviceIndex, customMontage.anodes, customMontage.cathode);
  
  // Update network details panel
  document.getElementById(`networkDetails_${deviceIndex}`).classList.remove('hidden');
  document.getElementById(`networkName_${deviceIndex}`).textContent = `Custom: ${customMontage.name}`;
  document.getElementById(`networkDesc_${deviceIndex}`).textContent = customMontage.description;
  document.getElementById(`networkAnodes_${deviceIndex}`).textContent = customMontage.anodes.join(', ');
  document.getElementById(`networkCathode_${deviceIndex}`).textContent = customMontage.cathode;
  document.getElementById(`networkIndication_${deviceIndex}`).textContent = `Custom montage created from ${customMontage.baseNetwork}`;
  
  // Update left panel info
  document.getElementById(`networkInfo_${deviceIndex}`).innerHTML = `
    <p class="text-xs font-bold text-purple-900 mb-1">
      <i class="fa-solid fa-star mr-1"></i>Custom Montage: ${customMontage.name}
    </p>
    <p class="text-xs text-purple-700">
      Anodes: <span class="font-mono font-bold">${customMontage.anodes.join(', ')}</span> | 
      Cathode: <span class="font-mono font-bold">${customMontage.cathode}</span>
    </p>
  `;
  
  saveTreatmentPlanState();
}

function renderTreatmentPlan() {
  const area = document.getElementById('contentArea');
  // For patient role, auto-select their own patient context
  if(currentRole === 'patient' && !globalSelectedPatientId) {
    const ap = getActivePatient();
    if(ap?.id) globalSelectedPatientId = ap.id;
  }
  
  // Auto-populate patient details if globalSelectedPatientId is set
  if(globalSelectedPatientId && !globalState.currentPatient) {
    const selectedPatient = sampleData.patients.find(p => p.id === globalSelectedPatientId);
    if(selectedPatient) {
      globalState.currentPatient = selectedPatient;
    }
  }
  
  const p = globalState.currentPatient || getActivePatient();
  if (!p) {
    area.innerHTML = `
      <div class="p-8">
        <div class="bg-yellow-50 border border-yellow-300 rounded-lg p-6">
          <p class="text-yellow-800 font-bold">No patient selected</p>
          <p class="text-sm text-yellow-700 mt-2">Please select a patient to view their treatment plan.</p>
        </div>
      </div>
    `;
    return;
  }
  
  area.innerHTML = `
    <div class="p-8">
    
    ${getAssessmentNavigation('treatmentplan')}
    
    <div class="mb-6 flex items-center justify-between">
      <div>
        <h2 class="text-2xl font-bold text-slate-800">Treatment Plan</h2>
        <p class="text-slate-500">Neuromodulation Treatment Planning & Documentation</p>
      </div>
      ${currentRole !== 'patient' ? `
      <div class="flex items-center gap-3">
        <div class="relative">
          <select id="patientNavigationSelectTreatment" class="input-royal pr-10 font-bold text-slate-900 bg-white border-2 border-orange-300">
            <option value="">Select Patient...</option>
            ${sampleData.patients.map(patient => `
              <option value="${patient.id}" ${globalState.currentPatient?.id === patient.id ? 'selected' : ''}>
                ${patient.name} (${patient.id})
              </option>
            `).join('')}
          </select>
          <i class="fa-solid fa-user-group absolute right-3 top-3 text-orange-600 pointer-events-none"></i>
        </div>
        <button onclick="loadSection('patienthistory')" class="btn-secondary text-sm" title="Back to Patient History">
          <i class="fa-solid fa-arrow-left mr-2"></i>Patient View
        </button>
      </div>
      ` : ''}
    </div>

    ${globalState.currentPatient && currentRole !== 'patient' ? `
    <!-- Auto-populated Patient Context -->
    <div class="card p-6 mb-8 border-l-4 border-l-orange-600 bg-gradient-to-r from-orange-50 to-slate-50">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-bold text-orange-900"><i class="fa-solid fa-user-circle mr-2"></i>Patient: ${p.name}</h3>
        <span class="badge badge-sozo">ID: ${p.id}</span>
      </div>
      <div class="grid grid-cols-3 gap-4 text-sm">
        <div><span class="font-bold text-slate-700">Age:</span> <span class="text-slate-900">${p.age}</span></div>
        <div><span class="font-bold text-slate-700">Gender:</span> <span class="text-slate-900">${p.gender}</span></div>
        <div><span class="font-bold text-slate-700">Status:</span> <span class="badge badge-info">${p.status || 'Active'}</span></div>
      </div>
    </div>
    ` : ''}

    <!-- Treatment Plan Main Tabs -->
      <div class="mb-4 flex gap-2 items-center">
      <button id="tpMain_devices" onclick="switchTreatmentMainTab('devices')" class="px-4 py-2 rounded-t-lg font-semibold ${treatmentPlanState.activeTreatmentMainTab === 'devices' ? 'bg-white border-t border-l border-r border-slate-200' : 'bg-slate-100 text-slate-700'}">Devices</button>
      <button id="tpMain_parameters" onclick="switchTreatmentMainTab('parameters')" class="px-4 py-2 rounded-t-lg font-semibold ${treatmentPlanState.activeTreatmentMainTab === 'parameters' ? 'bg-white border-t border-l border-r border-slate-200' : 'bg-slate-100 text-slate-700'}">Parameters</button>
      <button id="tpMain_details" onclick="switchTreatmentMainTab('details')" class="px-4 py-2 rounded-t-lg font-semibold ${treatmentPlanState.activeTreatmentMainTab === 'details' ? 'bg-white border-t border-l border-r border-slate-200' : 'bg-slate-100 text-slate-700'}">Details</button>
    </div>

    <div id="treatmentMainContent">
    <div class="card p-8">
      
      <!-- Step 1: Device Selection (Max 3) -->
      <div class="mb-8 bg-gradient-to-br from-blue-50 to-indigo-50 p-6 rounded-2xl border-2 border-blue-300">
        <h3 class="text-xl font-bold text-slate-900 mb-4 flex items-center gap-3">
          <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl flex items-center justify-center">
            <i class="fa-solid fa-microchip"></i>
          </div>
          Choose Devices (Maximum 3)
        </h3>
        
        <div class="flex flex-wrap gap-3 mb-4">
          ${treatmentPlanState.devices.map((device, idx) => `
            <div class="bg-white px-4 py-2 rounded-lg border-2 border-blue-400 flex items-center gap-2 shadow">
              <i class="fa-solid fa-microchip text-blue-600"></i>
              <span class="font-semibold text-slate-800">${device.name}</span>
              <button onclick="removeDevice(${idx})" class="ml-2 text-red-500 hover:text-red-700" ${currentRole === 'patient' ? 'disabled' : ''}>
                <i class="fa-solid fa-times"></i>
              </button>
            </div>
          `).join('')}
          ${treatmentPlanState.devices.length === 0 ? '<p class="text-slate-500 italic">No devices selected yet</p>' : ''}
        </div>
        
        ${treatmentPlanState.devices.length < treatmentPlanState.maxDevices ? `
        <div class="flex gap-3 items-center">
          <select id="newDeviceSelect" class="input-royal flex-1" ${currentRole === 'patient' ? 'disabled' : ''}>
            <option value="">-- Select a Device to Add --</option>
            <optgroup label="tDCS/tACS Devices">
              <option value="plato">Plato Neurostimulation - 4 specialized electrode blocks</option>
              <option value="newronika">Newronika - 10-20 system placement</option>
            </optgroup>
            <optgroup label="Alpha Stim Devices">
              <option value="alpha_stim_aid">Alpha Stim AID - Earlobe clips</option>
              <option value="alpha_stim_met">Alpha Stim MET - Earlobe clips + probe</option>
            </optgroup>
            <optgroup label="VNS & Other">
              <option value="tvns">tVNS - Cymba area (left ear)</option>
              <option value="device3">VNS (Vagus Nerve Stimulation)</option>
              <option value="tps">TPS (Transcranial Pulse Stimulation)</option>
            </optgroup>
            <optgroup label="Standard Placement">
              <option value="flow">Flow Device - Standard placement</option>
              <option value="robotic_arm">Robotic Arm - Standard placement</option>
            </optgroup>
          </select>
          <button onclick="addDevice()" class="btn-primary" ${currentRole === 'patient' ? 'disabled' : ''}>
            <i class="fa-solid fa-plus mr-2"></i>Add Device
          </button>
        </div>
        ` : '<p class="text-orange-600 font-semibold"><i class="fa-solid fa-info-circle mr-2"></i>Maximum of 3 devices reached</p>'}
      </div>

      ${treatmentPlanState.devices.length > 0 ? `
      <!-- Step 2: Device Journey Tabs -->
      <div class="mb-8">
        <h3 class="text-xl font-bold text-slate-900 mb-4 flex items-center gap-3">
          <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-xl flex items-center justify-center">
            <i class="fa-solid fa-route"></i>
          </div>
          Configure Each Device Journey
        </h3>
        
        <!-- Device Tabs -->
        <div class="flex border-b-2 border-slate-200 mb-6 overflow-x-auto">
          ${treatmentPlanState.devices.map((device, idx) => `
            <button 
              onclick="switchDeviceTab(${idx})" 
              class="px-6 py-3 font-semibold transition-all border-b-4 ${treatmentPlanState.activeDeviceTab === idx ? 'border-purple-600 text-purple-600 bg-purple-50' : 'border-transparent text-slate-600 hover:bg-slate-50'}"
            >
              <i class="fa-solid fa-microchip mr-2"></i>
              Device ${idx + 1}: ${device.name}
            </button>
          `).join('')}
        </div>
        
        <!-- Active Device Tab Content -->
        <div>
          <div id="deviceTabContent">
            ${renderDeviceJourney(treatmentPlanState.devices[treatmentPlanState.activeDeviceTab], treatmentPlanState.activeDeviceTab)}
          </div>
        </div>
      </div>
      ` : ''}

      

      <!-- Disease Selection & Automated Brain Region Mapping -->
      <!--for previous treatment plan -->
      <!-- Medication Suggestions Section -->
      <div class="mb-6 bg-slate-50 p-6 rounded-lg border border-slate-200">
        <h3 class="text-lg font-bold text-slate-900 mb-4 border-b-2 border-sozo-600 pb-2">
          <i class="fa-solid fa-pills mr-2"></i>Medication Suggestions
        </h3>
        <div class="space-y-4">
          <div>
            <label class="text-sm font-semibold text-slate-700 block mb-2">Prescribed Medications</label>
            <textarea 
              id="medicationSuggestions" 
              class="input-royal w-full text-sm" 
              rows="8" 
              placeholder="Enter medication suggestions, dosages, and instructions...&#10;&#10;Example:&#10;1. Medication Name: [Drug name]&#10;   Dosage: [Amount and frequency]&#10;   Duration: [Treatment period]&#10;   Instructions: [Special instructions]&#10;&#10;2. ..." 
              ${currentRole === 'patient' ? 'readonly' : ''}
            ></textarea>
          </div>
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div class="flex items-start gap-3">
              <i class="fa-solid fa-info-circle text-blue-600 text-xl mt-1"></i>
              <div class="text-sm text-blue-800">
                <p class="font-semibold mb-1">Clinical Notes:</p>
                <ul class="list-disc list-inside space-y-1 text-xs">
                  <li>Include medication name, dosage, frequency, and duration</li>
                  <li>Note any contraindications or interactions with neuromodulation</li>
                  <li>Specify timing relative to treatment sessions if applicable</li>
                  <li>Document any medication adjustments based on treatment response</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Save Button -->
      ${currentRole !== 'patient' ? `
      <div class="flex justify-end gap-3 mt-6">
        <button id="saveTreatmentPlanBtn" class="btn-primary">
          <i class="fa-solid fa-save mr-2"></i>Save Treatment Plan
        </button>
      </div>
      ` : ''}
    </div>
    </div>
    </div>
  `;
  
  // Attach event listeners
  setTimeout(() => {
    // Restore saved visualizations
    restoreTreatmentPlanHighlights();
    populateCustomMontagesForAllDevices();
    
    // Clean up any malformed network tabs
    if (treatmentPlanState.networkTabs) {
      Object.keys(treatmentPlanState.networkTabs).forEach(deviceIndex => {
        if (treatmentPlanState.networkTabs[deviceIndex]) {
          treatmentPlanState.networkTabs[deviceIndex] = treatmentPlanState.networkTabs[deviceIndex]
            .filter(tab => tab && tab.networkId !== undefined && tab.networkName);
        }
      });
    }
    
    // Initialize network tabs for all devices
    treatmentPlanState.devices.forEach((device, index) => {
      if (usesBrainMontage(device.value)) {
        renderNetworkTabs(index);
      }
    });

    // Render main treatment content according to selected main tab
    const mainContentEl = document.getElementById('treatmentMainContent');
    if (mainContentEl) {
      if (treatmentPlanState.activeTreatmentMainTab === 'parameters') {
        mainContentEl.innerHTML = renderTreatmentPlanParameters();
      } else if (treatmentPlanState.activeTreatmentMainTab === 'details') {
        mainContentEl.innerHTML = renderTreatmentPlanDetails();
      } else {
        // Ensure device tab content is up-to-date for devices main tab
        const deviceTabContent = document.getElementById('deviceTabContent');
        if (deviceTabContent) {
          deviceTabContent.innerHTML = treatmentPlanState.activeTreatmentSubTab === 'parameters' ? renderParametersContent(treatmentPlanState.devices[treatmentPlanState.activeDeviceTab], treatmentPlanState.activeDeviceTab) : renderDeviceJourney(treatmentPlanState.devices[treatmentPlanState.activeDeviceTab], treatmentPlanState.activeDeviceTab);
        }
      }
    }

    // Clinical Indication Dropdown - trigger initial update if needed
    const clinicalSelect = document.getElementById('clinicalIndicationSelect');
    if (clinicalSelect) {
      // Populate custom montages in dropdown
      populateCustomMontagesDropdown();
      
      // Initialize montage display if there's a pre-selected value
      if (clinicalSelect.value) {
        updateMontageMapping();
      }
    }
    
    // Patient Navigation Dropdown
    const patientNavSelect = document.getElementById('patientNavigationSelectTreatment');
    if (patientNavSelect) {
      patientNavSelect.addEventListener('change', (e) => {
        const patientId = e.target.value;
        if (patientId) {
          const patient = sampleData.patients.find(p => p.id === patientId);
          if (patient) {
            globalSelectedPatientId = patient.id;
            globalState.currentPatient = patient;
            renderTreatmentPlan();
          }
        }
      });
    }
    
    // Save Button Handler
    const saveBtn = document.getElementById('saveTreatmentPlanBtn');
    if (saveBtn) {
      saveBtn.addEventListener('click', () => {
        // Collect treatment plan data
        const treatmentData = {
          patientId: p.id,
          patientName: document.getElementById('treatmentPatientName')?.value,
          treatmentDate: document.getElementById('treatmentDate')?.value,
          session1: {
            number: document.getElementById('session1Number')?.value,
            protocol: document.getElementById('session1Protocol')?.value,
            duration: document.getElementById('session1Duration')?.value,
            frequency: document.getElementById('session1Frequency')?.value,
            notes: document.getElementById('session1Notes')?.value,
            targetArea: document.getElementById('session1TargetArea')?.value,
            modality: document.getElementById('session1Modality')?.value,
            intensity: document.getElementById('session1Intensity')?.value,
            outcome: document.getElementById('session1Outcome')?.value
          },
          session2: {
            number: document.getElementById('session2Number')?.value,
            protocol: document.getElementById('session2Protocol')?.value,
            duration: document.getElementById('session2Duration')?.value,
            frequency: document.getElementById('session2Frequency')?.value,
            notes: document.getElementById('session2Notes')?.value,
            targetArea: document.getElementById('session2TargetArea')?.value,
            modality: document.getElementById('session2Modality')?.value,
            intensity: document.getElementById('session2Intensity')?.value,
            outcome: document.getElementById('session2Outcome')?.value
          }
        };
        
        console.log('Treatment Plan Saved:', treatmentData);
        
        // Show success message
        saveBtn.innerHTML = '<i class="fa-solid fa-check mr-2"></i>Saved!';
        saveBtn.classList.remove('bg-sozo-600');
        saveBtn.classList.add('bg-green-500');
        setTimeout(() => {
          saveBtn.innerHTML = '<i class="fa-solid fa-save mr-2"></i>Save Treatment Plan';
          saveBtn.classList.remove('bg-green-500');
          saveBtn.classList.add('bg-sozo-600');
        }, 2000);
      });
    }
  }, 100);
}

function updateMontageMapping() {
  const selection = document.getElementById('clinicalIndicationSelect')?.value;
  const montageSection = document.getElementById('montageDetailsSection');
  
  if (!selection || !montageSection) return;
  
  // Define montage configurations based on the table
  const montageConfigs = {
    ruminative_depression: {
      category: 'Montage Category 1 - Standard 1-channel',
      clinicalIndication: 'Ruminative, melancholic depression; low drive; cognitive slowing',
      networkTarget: 'CEN (Central Executive Network)',
      secondaryNetwork: '—',
      anodePlacement: 'F3 (left executive hub), F4 (right-biased affective profile), optional Fz',
      anodeOptions: 'Limbic regulation, indirect DMN disengagement',
      cathodePlacement: 'Shoulder / torso (preferred); FPz or Cz if cephalic required',
      cathodeType: 'Extracephalic preferred',
      fnonLogic: 'Strengthens top-down executive control; reduces rumination indirectly via improved network switching',
      anodes: ['F3', 'F4'],
      cathodes: ['FPZ'],
      extracephalic: true,
      recommendedDevice: 'device1' // TMS for targeted DLPFC stimulation
    },
    cognitive_depression: {
      category: 'Montage Category 2 - Standard 1-channel',
      clinicalIndication: 'Cognitive depression, attentional inefficiency',
      networkTarget: 'CEN (Central Executive Network)',
      secondaryNetwork: 'DAN / parietal integration',
      anodePlacement: 'F3 / F4 / Fz',
      anodeOptions: '',
      cathodePlacement: 'P3 / P4 (integrational integration) or extracephalic',
      cathodeType: 'Cephalic or extracephalic (case-dependent)',
      fnonLogic: 'Treats depression as network inefficiency rather than mood deficit',
      anodes: ['F3', 'F4'],
      cathodes: ['P3'],
      extracephalic: false,
      recommendedDevice: 'device2' // tDCS for broader cortical coverage
    },
    anxious_depression: {
      category: 'Montage Category 3 - Standard 1-channel',
      clinicalIndication: 'Anxious depression, hypervigilance, stress sensitivity',
      networkTarget: 'SN (Salience Network - regulatory)',
      secondaryNetwork: 'CEN stabilization',
      anodePlacement: 'FCz, FC1 / FC2',
      anodeOptions: '',
      cathodePlacement: 'Shoulder / torso preferred; Cz or FPz if cephalic',
      cathodeType: 'Extracephalic preferred',
      fnonLogic: 'Normalizes pathological salience attribution and improves switching',
      anodes: ['FCZ', 'FC1'],
      cathodes: ['CZ'],
      extracephalic: true,
      recommendedDevice: 'device3' // VNS for stress and anxiety via vagus nerve
    }
  };
  
  let config;
  
  // Show/hide delete button based on selection
  const deleteBtn = document.getElementById('deleteCustomMontageBtn');
  
  // Check if selection is a custom montage
  if (selection.startsWith('custom_')) {
    const customMontage = getCustomMontage(selection);
    if (customMontage) {
      // Transform custom montage to match expected config structure
      config = {
        category: customMontage.baseNetwork || 'Custom Montage',
        networkTarget: customMontage.baseNetwork || '',
        secondaryNetwork: '',
        anodePlacement: customMontage.anodes?.join(', ') || '',
        anodeOptions: '',
        cathodePlacement: customMontage.cathode || '',
        cathodeType: '',
        fnonLogic: customMontage.description || `Custom montage: ${customMontage.name}`,
        anodes: customMontage.anodes || [],
        cathodes: customMontage.cathode ? [customMontage.cathode] : [],
        recommendedDevice: customMontage.deviceType || ''
      };
    }
    // Show delete button for custom montages
    if (deleteBtn) {
      deleteBtn.style.display = 'block';
      deleteBtn.onclick = () => deleteCustomMontage(selection);
    }
  } else {
    // Load standard configuration
    config = montageConfigs[selection];
    // Hide delete button for standard montages
    if (deleteBtn) deleteBtn.style.display = 'none';
  }
  
  // Load custom montages list
  loadCustomMontagesList();
  
  if (config) {
    // Show the montage section
    montageSection.classList.remove('hidden');
    
    // Populate all fields
    document.getElementById('montageCategory').value = config.category;
    document.getElementById('networkTarget').value = config.networkTarget;
    document.getElementById('secondaryNetwork').value = config.secondaryNetwork || config.secondaryNetwork;
    document.getElementById('anodePlacement').value = config.anodePlacement || config.anodes?.join(', ') || '';
    document.getElementById('anodeOptions').value = config.anodeOptions || '';
    document.getElementById('cathodePlacement').value = config.cathodePlacement || config.cathodes?.join(', ') || '';
    document.getElementById('cathodeType').value = config.cathodeType;
    document.getElementById('useStage').value = 'Clinical treatment phase';
    document.getElementById('fnonLogic').textContent = config.fnonLogic;
    
    // Update brain visualization
    updateBrainVisualization(config);
    
    // Automatically select and display recommended device
    const deviceSelect = document.getElementById('deviceSelect');
    if (deviceSelect && config.recommendedDevice) {
      deviceSelect.value = config.recommendedDevice;
      updateDeviceVisualization();
    }
    
    // Scroll to the montage section smoothly
    setTimeout(() => {
      montageSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 100);
  } else {
    // Hide the section if no selection
    montageSection.classList.add('hidden');
    resetBrainVisualization();
  }
}

// Render the Treatment Plan 'Details' main tab — per-device freeform notes entered by doctor
function renderTreatmentPlanDetails() {
  const devices = treatmentPlanState.devices || [];

  if (devices.length === 0) {
    return `
      <div class="card p-6 text-sm text-slate-600">
        <p>No devices added yet. Add devices first to add details.</p>
      </div>
    `;
  }

  // Ensure we have an activeDetailsDevice index
  if (treatmentPlanState.activeDetailsDevice === undefined || treatmentPlanState.activeDetailsDevice === null) {
    treatmentPlanState.activeDetailsDevice = treatmentPlanState.activeDeviceTab || 0;
  }
  const selIndex = Math.min(Math.max(0, parseInt(treatmentPlanState.activeDetailsDevice || 0)), devices.length - 1);
  const device = devices[selIndex];

  return `
    <div class="card p-6 space-y-4">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-bold">Device Details</h3>
        <div class="">
          <label class="text-xs text-slate-600 mr-2">Select device</label>
          <select onchange="switchDetailsDevice(this.value)" class="input-royal">
            ${devices.map((d, i) => `<option value="${i}" ${i === selIndex ? 'selected' : ''}>Device ${i+1}: ${d.name}</option>`).join('')}
          </select>
        </div>
      </div>

      <div class="border rounded-lg p-4 bg-white">
        <div class="mb-2 font-semibold text-slate-800">Selected: Device ${selIndex + 1} — ${device.name}</div>
        <textarea id="deviceDetails_${selIndex}" class="input-royal w-full text-sm" rows="8" placeholder="Enter notes or device-specific details for the doctor..." oninput="updateDeviceDetails(${selIndex}, this.value)">${(device.details || '')}</textarea>
      </div>
    </div>
  `;
}

function switchDetailsDevice(index) {
  const idx = parseInt(index);
  if (isNaN(idx)) return;
  treatmentPlanState.activeDetailsDevice = idx;
  saveTreatmentPlanState();
  const mainContentEl = document.getElementById('treatmentMainContent');
  if (mainContentEl) mainContentEl.innerHTML = renderTreatmentPlanDetails();
}

window.switchDetailsDevice = switchDetailsDevice;

function updateDeviceDetails(deviceIndex, value) {
  if (!treatmentPlanState.devices || !treatmentPlanState.devices[deviceIndex]) return;
  treatmentPlanState.devices[deviceIndex].details = value;
  saveTreatmentPlanState();
}

// Expose details update to global scope for inline handlers
window.renderTreatmentPlanDetails = renderTreatmentPlanDetails;
window.updateDeviceDetails = updateDeviceDetails;

// Update brain diagram visualization with electrode highlights
function updateBrainVisualization(config) {
  // Reset all electrodes first
  resetBrainVisualization();
  
  if (!config) return;
  
  // Highlight anodes (red/orange)
  if (config.anodes && config.anodes.length > 0) {
    config.anodes.forEach(electrode => {
      const el = document.getElementById(electrode.toLowerCase() + '-electrode');
      if (el) {
        const circle = el.querySelector('circle');
        const text = el.querySelector('text');
        if (circle) {
          circle.setAttribute('fill', 'url(#anodeGradient)');
          circle.setAttribute('stroke', '#dc2626');
          circle.setAttribute('stroke-width', '3');
        }
        if (text) {
          text.setAttribute('fill', '#ffffff');
          text.setAttribute('font-weight', 'bold');
        }
      }
    });
  }
  
  // Highlight cathodes (blue)
  if (config.cathodes && config.cathodes.length > 0) {
    config.cathodes.forEach(electrode => {
      const el = document.getElementById(electrode.toLowerCase() + '-electrode');
      if (el) {
        const circle = el.querySelector('circle');
        const text = el.querySelector('text');
        if (circle) {
          circle.setAttribute('fill', 'url(#cathodeGradient)');
          circle.setAttribute('stroke', '#2563eb');
          circle.setAttribute('stroke-width', '3');
        }
        if (text) {
          text.setAttribute('fill', '#ffffff');
          text.setAttribute('font-weight', 'bold');
        }
      }
    });
  }
  
  // Show/hide extracephalic note
  const extracephalicNote = document.getElementById('extracephalicNote');
  if (extracephalicNote) {
    if (config.extracephalic) {
      extracephalicNote.classList.remove('hidden');
    } else {
      extracephalicNote.classList.add('hidden');
    }
  }
  
  // Update active montage info
  const activeAnodes = document.getElementById('activeAnodes');
  const activeCathodes = document.getElementById('activeCathodes');
  const activeNetwork = document.getElementById('activeNetwork');
  
  if (activeAnodes) activeAnodes.textContent = config.anodes.join(', ');
  if (activeCathodes) {
    if (config.extracephalic) {
      activeCathodes.textContent = 'Shoulder/Torso (extracephalic)';
    } else {
      activeCathodes.textContent = config.cathodes.join(', ');
    }
  }
  if (activeNetwork) activeNetwork.textContent = config.networkTarget;
  
  // Add gradients to SVG if they don't exist
  addSVGGradients();
  
  // Enable cathode drag-and-drop for doctors
  if (currentRole === 'doctor' || currentRole === 'admin') {
    enableCathodeCustomization();
  }
}
// Update device visualization function to work with tabs
function updateDeviceVisualization() {
  const deviceSelect = document.getElementById('deviceSelect');
  const visualizationSection = document.getElementById('deviceVisualizationSection');
  
  if (!deviceSelect || !visualizationSection) return;
  
  const selectedDevice = deviceSelect.value;
  
  // Hide all device visualizations
  const allDeviceVizIds = [
    'device1Viz', 'device2Viz', 'device3Viz',
    'platoViz', 'newronikaViz', 'alpha_stim_aidViz', 
    'alpha_stim_metViz', 'tvnsViz', 'tpsViz',
    'flowViz', 'robotic_armViz'
  ];
  
  allDeviceVizIds.forEach(id => {
    document.getElementById(id)?.classList.add('hidden');
  });
  
  if (!selectedDevice) {
    visualizationSection.classList.add('hidden');
    return;
  }
  
  // Show the visualization section
  visualizationSection.classList.remove('hidden');
  
  // Map device values to their visualization IDs
  const deviceVizMap = {
    'device1': 'device1Viz',
    'device2': 'device2Viz',
    'device3': 'device3Viz',
    'plato': 'platoViz',
    'newronika': 'newronikaViz',
    'alpha_stim_aid': 'alpha_stim_aidViz',
    'alpha_stim_met': 'alpha_stim_metViz',
    'tvns': 'tvnsViz',
    'tps': 'tpsViz',
    'flow': 'flowViz',
    'robotic_arm': 'robotic_armViz'
  };
  
  // Show the selected device visualization
  const vizId = deviceVizMap[selectedDevice];
  if (vizId) {
    document.getElementById(vizId)?.classList.remove('hidden');
  }
  
  // Auto-switch to device tab when device is selected
  switchTab('device');
}

function switchTab(tabName) {
  // Remove active class from all tabs
  document.querySelectorAll('.tab-button').forEach(btn => {
    btn.classList.remove('active-tab');
    btn.classList.add('text-slate-700');
    btn.style.borderBottomColor = 'transparent';
  });
  
  // Hide all tab content
  document.querySelectorAll('.tab-content').forEach(content => {
    content.classList.add('hidden');
  });
  
  // Show selected tab content and activate tab
  if (tabName === 'montage') {
    const montageTab = document.getElementById('montageTab');
    const montageTabContent = document.getElementById('montageTabContent');
    if (montageTab) {
      montageTab.classList.add('active-tab');
      montageTab.classList.remove('text-slate-700');
      montageTab.classList.add('text-purple-600');
      montageTab.style.borderBottomColor = '#9333ea';
    }
    if (montageTabContent) {
      montageTabContent.classList.remove('hidden');
    }
  } else if (tabName === 'device') {
    const deviceTab = document.getElementById('deviceTab');
    const deviceTabContent = document.getElementById('deviceTabContent');
    if (deviceTab) {
      deviceTab.classList.add('active-tab');
      deviceTab.classList.remove('text-slate-700');
      deviceTab.classList.add('text-orange-600');
      deviceTab.style.borderBottomColor = '#ea580c';
    }
    if (deviceTabContent) {
      deviceTabContent.classList.remove('hidden');
    }
    
    // Show device visualization if device is selected
    const deviceSelect = document.getElementById('deviceSelect');
    const deviceVisualizationSection = document.getElementById('deviceVisualizationSection');
    if (deviceSelect && deviceSelect.value && deviceVisualizationSection) {
      deviceVisualizationSection.classList.remove('hidden');
    }
  }
}

// Initialize default tab
document.addEventListener('DOMContentLoaded', function() {
  // Only switch tab if we're in the treatment plan context
  if (document.getElementById('montageTab')) {
    switchTab('montage'); // Default to montage tab
  }
});

// Device Management Functions for Treatment Plan
function addDevice() {
  const select = document.getElementById('newDeviceSelect');
  if (!select || !select.value) {
    alert('Please select a device first');
    return;
  }
  
  if (treatmentPlanState.devices.length >= treatmentPlanState.maxDevices) {
    alert('Maximum of 3 devices reached');
    return;
  }
  
  const deviceValue = select.value;
  const deviceText = select.options[select.selectedIndex].text;
  
  // Check if device already added
  if (treatmentPlanState.devices.some(d => d.value === deviceValue)) {
    alert('This device has already been added');
    return;
  }
  
  // Add device with default configuration
  treatmentPlanState.devices.push({
    value: deviceValue,
    name: deviceText,
    symptoms: [],
    network: '',
    montage: {
      type: 'blank',
      anode: null,
      cathode: null
    }
  });
  
  // Reset select and re-render
  select.value = '';
  saveTreatmentPlanState();
  renderTreatmentPlan();
}

function removeDevice(index) {
  if (confirm('Are you sure you want to remove this device?')) {
    treatmentPlanState.devices.splice(index, 1);
    
    // Adjust active tab if needed
    if (treatmentPlanState.activeDeviceTab >= treatmentPlanState.devices.length) {
      treatmentPlanState.activeDeviceTab = Math.max(0, treatmentPlanState.devices.length - 1);
    }
    
    saveTreatmentPlanState();
    renderTreatmentPlan();
  }
}

function switchDeviceTab(index) {
  treatmentPlanState.activeDeviceTab = index;
  saveTreatmentPlanState();
  
  // Re-render just the tab content
  const content = document.getElementById('deviceTabContent');
  if (content) {
    content.innerHTML = renderDeviceJourney(treatmentPlanState.devices[index], index);
    // Restore styling and functionality
    restoreTreatmentPlanHighlights();
    populateCustomMontagesForDevice(index);
  }
  
  // Update tab styling
  document.querySelectorAll('[onclick^="switchDeviceTab"]').forEach((tab, idx) => {
    if (idx === index) {
      tab.classList.add('border-purple-600', 'text-purple-600', 'bg-purple-50');
      tab.classList.remove('border-transparent', 'text-slate-600');
    } else {
      tab.classList.remove('border-purple-600', 'text-purple-600', 'bg-purple-50');
      tab.classList.add('border-transparent', 'text-slate-600');
    }
  });
}

// Switch between Network Selection and Custom Montage tabs
function switchMontageTab(deviceIndex, tabType) {
  const networkTab = document.getElementById(`networkTab_${deviceIndex}`);
  const customTab = document.getElementById(`customTab_${deviceIndex}`);
  const networkContent = document.getElementById(`networkTabContent_${deviceIndex}`);
  const customContent = document.getElementById(`customTabContent_${deviceIndex}`);
  
  if (tabType === 'network') {
    // Show network tab
    if (networkTab) {
      networkTab.classList.add('border-green-600', 'text-green-700', 'bg-green-100');
      networkTab.classList.remove('border-transparent', 'text-slate-600');
    }
    if (customTab) {
      customTab.classList.remove('border-purple-600', 'text-purple-700', 'bg-purple-100');
      customTab.classList.add('border-transparent', 'text-slate-600');
    }
    if (networkContent) networkContent.classList.remove('hidden');
    if (customContent) customContent.classList.add('hidden');
  } else if (tabType === 'custom') {
    // Show custom montage tab
    if (networkTab) {
      networkTab.classList.remove('border-green-600', 'text-green-700', 'bg-green-100');
      networkTab.classList.add('border-transparent', 'text-slate-600');
    }
    if (customTab) {
      customTab.classList.add('border-purple-600', 'text-purple-700', 'bg-purple-100');
      customTab.classList.remove('border-transparent', 'text-slate-600');
    }
    if (networkContent) networkContent.classList.add('hidden');
    if (customContent) customContent.classList.remove('hidden');
    
    // Populate custom montages when tab is opened
    populateCustomMontagesForDevice(deviceIndex);
  }
}

// Network Tab Management Functions
function addNetworkTab(deviceIndex, networkId) {
  try {
    console.log('addNetworkTab called with:', {deviceIndex, networkId, type_deviceIndex: typeof deviceIndex, type_networkId: typeof networkId});
    
    const idx = Number(deviceIndex);

    if (
      Number.isNaN(idx) ||
      !treatmentPlanState.devices ||
      !treatmentPlanState.devices[idx]
    ) {
      console.error('Invalid device index', deviceIndex, 'Parsed:', idx, 'Devices:', treatmentPlanState.devices);
      return;
    }

    const deviceValue = treatmentPlanState.devices[idx].value;
    const networks = getDummyNetworks(deviceValue);
    
    console.log('Device and networks:', {deviceValue, networks: networks ? networks.length : 'null'});

    if (!Array.isArray(networks)) {
      console.error('Networks not found for device', deviceValue, 'Got:', networks);
      return;
    }

    const nid = Number(networkId);
    console.log('Network ID conversion:', {networkId, nid, isNaN: Number.isNaN(nid), networkExists: !!networks[nid]});
    
    if (Number.isNaN(nid) || !networks[nid]) {
      console.error('Invalid networkId', networkId, 'Parsed:', nid, 'Available networks:', networks.length);
      return;
    }

    // Double-check that the network object has required properties
    if (!networks[nid].name) {
      console.error('Network missing required properties:', networks[nid]);
      return;
    }

    // Ensure networkTabs object exists
    if (!treatmentPlanState.networkTabs) {
      treatmentPlanState.networkTabs = {};
    }
    
    if (!treatmentPlanState.networkTabs[idx]) {
      treatmentPlanState.networkTabs[idx] = [];
    }

    const existing = treatmentPlanState.networkTabs[idx]
      .find(tab => tab && tab.networkId === nid);

    if (existing) {
      switchNetworkTab(idx, nid);
      applyNetworkToDevice(idx, nid);
      return;
    }

    treatmentPlanState.networkTabs[idx].forEach(tab => {
      if (tab) tab.isActive = false;
    });

    treatmentPlanState.networkTabs[idx].push({
      networkId: nid,
      networkName: networks[nid].name,
      isActive: true
    });

    applyNetworkToDevice(idx, nid);
    saveTreatmentPlanState();
    renderNetworkTabs(idx);

  } catch (err) {
    console.error('addNetworkTab error:', err);
  }
}


function removeNetworkTab(deviceIndex, networkId) {
  if (!treatmentPlanState.networkTabs?.[deviceIndex]) return;

  const tabs = treatmentPlanState.networkTabs[deviceIndex];
  const tabIndex = tabs.findIndex(tab => tab && tab.networkId === networkId);
  
  if (tabIndex === -1) return; // Tab not found
  
  // Check if the tab being removed was active
  const wasActive = tabs[tabIndex].isActive;
  
  // Remove the tab
  tabs.splice(tabIndex, 1);

  // If the removed tab was active and there are remaining tabs, activate the last one
  if (wasActive && tabs.length > 0) {
    tabs[tabs.length - 1].isActive = true;
    // Apply the network for the newly activated tab
    applyNetworkToDevice(deviceIndex, tabs[tabs.length - 1].networkId);
  }

  saveTreatmentPlanState();
  renderNetworkTabs(deviceIndex);
}


function switchNetworkTab(deviceIndex, networkId) {
  if (!treatmentPlanState.networkTabs[deviceIndex]) return;
  
  console.log('Switching to network tab:', {deviceIndex, networkId});
  
  // Deactivate all tabs
  treatmentPlanState.networkTabs[deviceIndex].forEach(tab => {
    if (tab) tab.isActive = false;
  });
  
  // Activate selected tab
  const selectedTab = treatmentPlanState.networkTabs[deviceIndex].find(tab => tab && tab.networkId === parseInt(networkId));
  if (selectedTab) {
    selectedTab.isActive = true;
    console.log('Activated tab:', selectedTab.networkName);
    
    // Apply the network configuration and highlight the montage
    applyNetworkToDevice(deviceIndex, networkId);
  } else {
    console.error('Network tab not found:', {deviceIndex, networkId, availableTabs: treatmentPlanState.networkTabs[deviceIndex]});
  }
  
  saveTreatmentPlanState();
  renderNetworkTabs(deviceIndex);
}

function renderNetworkTabs(deviceIndex) {
  const tabsContainer = document.getElementById(`networkTabsContainer_${deviceIndex}`);
  if (!tabsContainer) {
    console.warn('Network tabs container not found for device:', deviceIndex);
    return;
  }
  
  const networkTabs = (treatmentPlanState.networkTabs[deviceIndex] || [])
    .filter(tab => tab && tab.networkId !== undefined && tab.networkName);
  
  console.log('Rendering network tabs for device:', deviceIndex, 'Tab count:', networkTabs.length);
  
  if (networkTabs.length === 0) {
    tabsContainer.innerHTML = '<p class="text-sm text-slate-500 italic">No networks selected. Choose networks from the dropdown above.</p>';
    return;
  }
  
  tabsContainer.innerHTML = `
    <div class="flex flex-wrap gap-2 mb-4">
      ${networkTabs.map(tab => `
        <div class="flex items-center gap-2 px-3 py-2 rounded-lg border-2 transition-all ${
          tab.isActive 
            ? 'border-purple-600 bg-purple-50 text-purple-900' 
            : 'border-slate-300 bg-white text-slate-600 hover:border-purple-300'
        }">
          <button 
            onclick="switchNetworkTab(${deviceIndex}, ${tab.networkId})"
            class="flex items-center gap-2 hover:bg-purple-100 rounded px-2 py-1 transition-colors"
          >
            <i class="fa-solid fa-brain text-sm"></i>
            <span class="font-medium text-sm">${tab.networkName}</span>
          </button>
          <button 
            onclick="removeNetworkTab(${deviceIndex}, ${tab.networkId})"
            class="text-slate-400 hover:text-red-500 text-xs ml-1 p-1 rounded hover:bg-red-50 transition-colors"
            title="Close network tab"
          >
            <i class="fa-solid fa-times"></i>
          </button>
        </div>
      `).join('')}
    </div>
    
    <!-- Active Network Content -->
    <div id="activeNetworkContent_${deviceIndex}">
      ${renderActiveNetworkContent(deviceIndex)}
    </div>
  `;
}

function renderActiveNetworkContent(deviceIndex) {
  const networkTabs = (treatmentPlanState.networkTabs[deviceIndex] || [])
    .filter(tab => tab && tab.networkId !== undefined);
  const activeTab = networkTabs.find(tab => tab && tab.isActive);
  
  if (!activeTab || !activeTab.networkId) {
    return '<p class="text-sm text-slate-500 italic">No active network selected.</p>';
  }
  
  // Check if device exists
  if (!treatmentPlanState.devices[deviceIndex]) {
    return '<p class="text-sm text-red-500">Device not found.</p>';
  }
  
  const networks = getDummyNetworks(treatmentPlanState.devices[deviceIndex].value);
  if (!networks) {
    return '<p class="text-sm text-red-500">Networks not available for this device.</p>';
  }
  
  const network = networks[activeTab.networkId];
  
  if (!network) {
    return '<p class="text-sm text-red-500">Network configuration not found.</p>';
  }
  
  return `
    <div class="bg-white border-2 border-purple-200 rounded-lg p-4">
      <div class="mb-4">
        <h4 class="font-bold text-purple-900 text-lg flex items-center gap-2">
          <i class="fa-solid fa-bolt"></i>
          ${network.name}
        </h4>
        <p class="text-sm text-slate-600 mt-1">${network.description}</p>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
          <label class="text-xs font-bold text-slate-700 block mb-1">Anodes</label>
          <div class="bg-red-50 border border-red-200 rounded px-3 py-2">
            <span class="font-mono text-sm text-red-800">${network.anodes.join(', ')}</span>
          </div>
        </div>
        <div>
          <label class="text-xs font-bold text-slate-700 block mb-1">Cathode</label>
          <div class="bg-blue-50 border border-blue-200 rounded px-3 py-2">
            <span class="font-mono text-sm text-blue-800">${network.cathode}</span>
          </div>
        </div>
      </div>
      
      <div class="mb-4">
        <label class="text-xs font-bold text-slate-700 block mb-1">Clinical Indication</label>
        <p class="text-sm text-slate-600 bg-slate-50 border border-slate-200 rounded px-3 py-2">${network.indication}</p>
      </div>
      
      <div class="flex justify-end gap-2">
        <button 
          onclick="applyNetworkToDevice(${deviceIndex}, '${activeTab.networkId}')"
          class="btn-primary text-sm"
        >
          <i class="fa-solid fa-check mr-1"></i>Apply to Device
        </button>
      </div>
    </div>
  `;
}

function applyNetworkToDevice(deviceIndex, networkId) {
  console.log('Applying network to device:', {deviceIndex, networkId});
  
  // Check if device exists
  if (!treatmentPlanState.devices[deviceIndex]) {
    console.error('Device not found at index:', deviceIndex);
    return;
  }
  
  const networks = getDummyNetworks(treatmentPlanState.devices[deviceIndex].value);
  if (!networks || networks.length === 0) {
    console.error('Networks not available for device:', treatmentPlanState.devices[deviceIndex].value);
    return;
  }
  
  const nid = parseInt(networkId);
  const network = networks[nid];
  if (!network) {
    console.error('Network not found with ID:', networkId, 'Available networks:', networks.length);
    return;
  }
  
  console.log('Applying network:', network);
  
  // Apply network configuration to device
  treatmentPlanState.devices[deviceIndex].montage = {
    type: 'network',
    anodes: [...network.anodes],
    cathode: network.cathode,
    network: network.name
  };
  
  treatmentPlanState.devices[deviceIndex].selectedNetwork = networkId;
  
  // Update UI - highlight brain montage if this device uses brain montage
  if (usesBrainMontage(treatmentPlanState.devices[deviceIndex].value)) {
    highlightNetworkElectrodes(deviceIndex, network.anodes, network.cathode);
    
    // Update network info panel
    const networkInfo = document.getElementById(`networkInfo_${deviceIndex}`);
    if (networkInfo) {
      networkInfo.innerHTML = `
        <p class="text-xs font-bold text-purple-900 mb-1">
          <i class="fa-solid fa-network-wired mr-1"></i>${network.name}
        </p>
        <p class="text-xs text-purple-700">
          Anodes: ${network.anodes?.join(', ') || 'None'} | Cathode: ${network.cathode || 'None'}
        </p>
      `;
    }
    
    // Update network details panel
    const networkDetails = document.getElementById(`networkDetails_${deviceIndex}`);
    if (networkDetails) {
      networkDetails.classList.remove('hidden');
      
      const networkName = document.getElementById(`networkName_${deviceIndex}`);
      const networkDesc = document.getElementById(`networkDesc_${deviceIndex}`);
      const networkAnodes = document.getElementById(`networkAnodes_${deviceIndex}`);
      const networkCathode = document.getElementById(`networkCathode_${deviceIndex}`);
      const networkIndication = document.getElementById(`networkIndication_${deviceIndex}`);
      
      if (networkName) networkName.textContent = network.name;
      if (networkDesc) networkDesc.textContent = network.description || '';
      if (networkAnodes) networkAnodes.textContent = network.anodes?.join(', ') || 'None';
      if (networkCathode) networkCathode.textContent = network.cathode || 'None';
      if (networkIndication) networkIndication.textContent = network.indication || '';
    }
  }
  
  // Show success message
  showNotification(`Network "${network.name}" applied to device successfully!`, 'success');
  
  saveTreatmentPlanState();
}

// Add network from dropdown to tabs
function addNetworkFromDropdown(deviceIndex) {
  const select = document.getElementById(`networkSelect_${deviceIndex}`);
  if (!select || !select.value) {
    console.warn('No network select or no value selected for device:', deviceIndex);
    alert('Please select a network to add.');
    return;
  }
  
  // Check if device exists
  if (!treatmentPlanState.devices[deviceIndex]) {
    console.error('Device not found at index:', deviceIndex);
    alert('Device not found.');
    return;
  }
  
  const networkId = parseInt(select.value);
  const networks = getDummyNetworks(treatmentPlanState.devices[deviceIndex].value);
  
  console.log('Adding network:', {deviceIndex, networkId, deviceValue: treatmentPlanState.devices[deviceIndex].value, networksAvailable: networks?.length || 0});
  
  if (!networks || networks.length === 0) {
    console.error('Networks not available for device:', treatmentPlanState.devices[deviceIndex].value);
    alert('Networks not available for this device.');
    return;
  }
  
  const network = networks[networkId];
  
  if (!network) {
    console.error('Network not found with ID:', networkId, 'Available networks:', networks.length);
    alert('Network not found.');
    return;
  }
  
  console.log('Selected network:', network);
  
  // Add network tab
  addNetworkTab(deviceIndex, networkId);
  
  // Reset dropdown
  select.value = '';
}

// Disease and Disease-Specific Montage Management
function handleDiseaseSelection(deviceIndex, diseaseValue) {
  const diseaseMontageSection = document.getElementById(`diseaseMontageSection_${deviceIndex}`);
  const diseaseMontageSelect = document.getElementById(`diseaseMontageSelect_${deviceIndex}`);
  
  if (!diseaseValue) {
    diseaseMontageSection?.classList.add('hidden');
    return;
  }
  
  // Show the disease-specific montage section
  diseaseMontageSection?.classList.remove('hidden');
  
  // Get disease-specific montages
  const diseaseProtocols = getDiseaseMontages(diseaseValue);
  
  // Populate the disease montage dropdown
  if (diseaseMontageSelect) {
    diseaseMontageSelect.innerHTML = `
      <option value="">-- Select Network --</option>
      ${diseaseProtocols.map((protocol, idx) => `
        <option value="${diseaseValue}_${idx}">${protocol.name}</option>
      `).join('')}
    `;
  }
  
  console.log('Disease selected:', diseaseValue, 'Available protocols:', diseaseProtocols.length);
}

function handleDiseaseMontageSelection(deviceIndex, protocolValue) {
  if (!protocolValue) return;
  
  const [diseaseId, protocolIdx] = protocolValue.split('_');
  const protocols = getDiseaseMontages(diseaseId);
  const protocol = protocols[parseInt(protocolIdx)];
  
  if (!protocol) return;
  
  const device = treatmentPlanState.devices[deviceIndex];
  if (!device) return;
  
  // Apply the disease-specific protocol to the device
  device.montage.anodes = protocol.anodes;
  device.montage.cathode = protocol.cathode;
  device.selectedProtocol = protocolValue;
  device.protocolName = protocol.name;
  
  // Update visualization if this device uses brain montage
  if (usesBrainMontage(device.value)) {
    highlightNetworkElectrodes(deviceIndex, protocol.anodes, protocol.cathode);
    
    // Update network details panel
    document.getElementById(`networkDetails_${deviceIndex}`).classList.remove('hidden');
    document.getElementById(`networkName_${deviceIndex}`).textContent = `Protocol: ${protocol.name}`;
    document.getElementById(`networkDesc_${deviceIndex}`).textContent = protocol.description;
    document.getElementById(`networkAnodes_${deviceIndex}`).textContent = protocol.anodes.join(', ');
    document.getElementById(`networkCathode_${deviceIndex}`).textContent = protocol.cathode;
    document.getElementById(`networkIndication_${deviceIndex}`).textContent = `${getDiseaseLabel(diseaseId)} - ${protocol.indication}`;
    
    // Update left panel info
    document.getElementById(`networkInfo_${deviceIndex}`).innerHTML = `
      <div class="text-center">
        <div class="inline-flex items-center gap-2 px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-bold mb-2">
          <i class="fa-solid fa-check-circle"></i>
          ${protocol.name}
        </div>
        <p class="text-xs text-green-700">${getDiseaseLabel(diseaseId)} Protocol Active</p>
        <div class="mt-2 space-y-1 text-[10px] text-slate-600">
          <div class="flex justify-center gap-4">
            <span><span class="text-red-600">●</span> Anodes: ${protocol.anodes.length}</span>
            <span><span class="text-blue-600">●</span> Cathode: 1</span>
          </div>
        </div>
      </div>
    `;
  }
  
  // Show success notification
  showNotification(`✓ ${protocol.name} protocol applied successfully!`, 'success');
  
  saveTreatmentPlanState();
}

function getDiseaseMontages(diseaseId) {
  const diseaseMontages = {
    disease1: [ // Depression
      {
        name: "Left DLPFC Stimulation",
        description: "High-frequency stimulation of left dorsolateral prefrontal cortex",
        anodes: ['F3'],
        cathode: 'Fp2',
        indication: "Major Depressive Disorder - First-line protocol"
      },
      {
        name: "Bilateral DLPFC Protocol",
        description: "Bilateral dorsolateral prefrontal cortex targeting",
        anodes: ['F3', 'F4'],
        cathode: 'Cz',
        indication: "Treatment-resistant depression"
      },
      {
        name: "Left M1-Right DLPFC",
        description: "Motor cortex to right prefrontal stimulation",
        anodes: ['C3'],
        cathode: 'F4',
        indication: "Depression with motor symptoms"
      }
    ],
    disease2: [ // Anxiety Disorders
      {
        name: "Right DLPFC Modulation",
        description: "Low-frequency stimulation for anxiety reduction",
        anodes: ['F4'],
        cathode: 'F3',
        indication: "Generalized Anxiety Disorder"
      },
      {
        name: "Frontopolar Protocol",
        description: "Bilateral frontopolar cortex stimulation",
        anodes: ['Fp1', 'Fp2'],
        cathode: 'Cz',
        indication: "Social anxiety and panic disorders"
      },
      {
        name: "ACC-DLPFC Circuit",
        description: "Anterior cingulate to prefrontal connectivity",
        anodes: ['Fz'],
        cathode: 'F4',
        indication: "Anxiety with rumination"
      }
    ],
    disease3: [ // Chronic Pain
      {
        name: "Primary Motor Cortex",
        description: "M1 stimulation for pain modulation",
        anodes: ['C3'],
        cathode: 'Fp2',
        indication: "Neuropathic pain - Gold standard"
      },
      {
        name: "Bilateral Motor Protocol",
        description: "Bilateral primary motor cortex activation",
        anodes: ['C3', 'C4'],
        cathode: 'Cz',
        indication: "Fibromyalgia and widespread pain"
      },
      {
        name: "S1-M1 Complex",
        description: "Somatosensory and motor cortex co-stimulation",
        anodes: ['C3'],
        cathode: 'P3',
        indication: "Chronic regional pain syndrome"
      }
    ]
  };
  
  return diseaseMontages[diseaseId] || [];
}

function getDiseaseLabel(diseaseId) {
  const labels = {
    disease1: 'Depression',
    disease2: 'Anxiety Disorders',
    disease3: 'Chronic Pain'
  };
  return labels[diseaseId] || diseaseId;
}

// Expose functions to global scope for onclick handlers
window.addNetworkTab = addNetworkTab;
window.removeNetworkTab = removeNetworkTab;
window.switchNetworkTab = switchNetworkTab;
window.renderNetworkTabs = renderNetworkTabs;
window.applyNetworkToDevice = applyNetworkToDevice;
window.addNetworkFromDropdown = addNetworkFromDropdown;
window.handleDiseaseSelection = handleDiseaseSelection;
window.handleDiseaseMontageSelection = handleDiseaseMontageSelection;

// Dummy Network Data Generator - Device-Specific Montages
function getDummyNetworks(deviceValue) {
  // Device-specific network configurations based on device capabilities
  
  const deviceNetworks = {
    // TMS - Transcranial Magnetic Stimulation: Frontal targeting
    'device1': [
      {
        name: 'Left DLPFC Targeting',
        description: 'Primary left dorsolateral prefrontal cortex stimulation for depression',
        anodes: ['F3', 'F7'],
        cathode: 'Fp1',
        indication: 'Major Depressive Disorder, Treatment-Resistant Depression'
      },
      {
        name: 'Right DLPFC Protocol',
        description: 'Right dorsolateral prefrontal cortex for cognitive enhancement',
        anodes: ['F4', 'F8'],
        cathode: 'Fp2',
        indication: 'Cognitive Enhancement, Executive Function'
      },
      {
        name: 'Bilateral Frontal',
        description: 'Bilateral frontal quadrant stimulation',
        anodes: ['F3', 'F4'],
        cathode: 'Fz',
        indication: 'Anxiety with Depression, Mood Regulation'
      }
    ],
    
    // tDCS - Transcranial Direct Current: Full brain coverage
    'device2': [
      {
        name: 'Frontal-Parietal Circuit',
        description: 'Full cortical stimulation for mood and cognition',
        anodes: ['Fp1', 'Fp2'],
        cathode: 'Pz',
        indication: 'Depression with Cognitive Symptoms'
      },
      {
        name: 'Motor-Prefrontal Link',
        description: 'Motor cortex to prefrontal connection',
        anodes: ['C3', 'F3'],
        cathode: 'P4',
        indication: 'Movement Disorders, Chronic Pain'
      },
      {
        name: 'Central Executive Enhancement',
        description: 'Dorsolateral prefrontal enhancement protocol',
        anodes: ['F3', 'F4'],
        cathode: 'Cz',
        indication: 'ADHD, Working Memory Deficits'
      },
      {
        name: 'Global Connectivity',
        description: 'Distributed network activation',
        anodes: ['Fz', 'Cz'],
        cathode: 'O1',
        indication: 'General Neuroplasticity, Recovery'
      }
    ],
    
    // VNS - Vagus Nerve Stimulation: Neck/ear region
    'device3': [
      {
        name: 'Left Vagus Nerve',
        description: 'Standard left cervical vagus nerve stimulation',
        anodes: ['T3', 'T5'],
        cathode: 'C3',
        indication: 'Treatment-Resistant Depression, Epilepsy'
      },
      {
        name: 'Bilateral Vagal Tone',
        description: 'Bilateral vagus nerve modulation',
        anodes: ['T3', 'T4'],
        cathode: 'Cz',
        indication: 'Autonomic Regulation, Anxiety'
      }
    ],
    
    // Plato - Multi-target precision
    'plato': [
      {
        name: 'Block 1 Standard',
        description: 'Standard electrode placement - right frontal-parietal region',
        anodes: ['F4', 'C4', 'P4'],
        cathode: 'Fp2',
        indication: 'Standard therapeutic protocol for depression and cognitive enhancement'
      },
      {
        name: 'Block 2 Middle Device Place',
        description: 'Middle device placement - right temporal targeting',
        anodes: ['C4', 'T4'],
        cathode: 'C3',
        indication: 'Lateral cortical stimulation for mood regulation'
      },
      {
        name: 'Block 3 Middle Device Placement, Improved',
        description: 'Improved middle device placement - left posterior focus',
        anodes: ['P3'],
        cathode: 'O1',
        indication: 'Targeted posterior cortical modulation'
      },
      {
        name: 'Block 4 Back Device Placement, Invasive Back',
        description: 'Back device placement - invasive posterior targeting',
        anodes: ['P3', 'O1'],
        cathode: 'T3',
        indication: 'Deep posterior network stimulation for complex cases'
      }
    ],
    
    // Newronika - Closed-loop adaptive
    'newronika': [
      {
        name: 'Adaptive DMN Regulation',
        description: 'Closed-loop default mode network modulation',
        anodes: ['F3', 'P3'],
        cathode: 'Fz',
        indication: 'Adaptive Depression Treatment'
      },
      {
        name: 'Dynamic Attention Network',
        description: 'Real-time attention network optimization',
        anodes: ['Fp1', 'Fp2'],
        cathode: 'Cz',
        indication: 'ADHD with Real-time Feedback'
      },
      {
        name: 'Feedback-Driven Motor',
        description: 'Motor network with recording feedback',
        anodes: ['C3', 'C4'],
        cathode: 'Pz',
        indication: 'Movement Disorders, Rehabilitation'
      }
    ],
    
    // Alpha Stim AID - Earlobe clips (cranial electrotherapy)
    'alpha_stim_aid': [
      {
        name: 'Bilateral CES Mode',
        description: 'Cranial electrotherapy stimulation via ear clips',
        anodes: ['T3', 'T4'],
        cathode: 'Cz',
        indication: 'Anxiety, Insomnia, Depression'
      },
      {
        name: 'Left-Dominant CES',
        description: 'Left-ear focused cranial stimulation',
        anodes: ['T3', 'F7'],
        cathode: 'Fp2',
        indication: 'Anxiety Disorders, Stress'
      },
      {
        name: 'Balanced Hemispheric',
        description: 'Balanced bilateral ear stimulation',
        anodes: ['T3', 'T4'],
        cathode: 'Fz',
        indication: 'Mood Stabilization, Pain Management'
      }
    ],
    
    // Alpha Stim MET - Microcurrent with probe
    'alpha_stim_met': [
      {
        name: 'Microcurrent Pain Relief',
        description: 'Localized microcurrent therapy for pain',
        anodes: ['C3', 'T3'],
        cathode: 'P3',
        indication: 'Chronic Pain, Muscle Tension'
      },
      {
        name: 'Probe-Based Targeting',
        description: 'Precise probe placement for tissue healing',
        anodes: ['F3', 'C3'],
        cathode: 'T5',
        indication: 'Inflammation, Tissue Repair'
      },
      {
        name: 'Full-Body Circuit',
        description: 'Extended microcurrent pathway',
        anodes: ['Fp1', 'T3'],
        cathode: 'O1',
        indication: 'Systemic Pain, Fibromyalgia'
      }
    ],
    
    // tVNS - Transcutaneous vagus (ear-based)
    'tvns': [
      {
        name: 'Left Auricular Cymba',
        description: 'Left ear cymba conchae stimulation',
        anodes: ['T3', 'T5'],
        cathode: 'F7',
        indication: 'Depression, PTSD, Inflammation'
      },
      {
        name: 'Bilateral Auricular',
        description: 'Bilateral ear vagus stimulation',
        anodes: ['T3', 'T4'],
        cathode: 'Cz',
        indication: 'Autonomic Balance, Anxiety'
      }
    ],
    
    // TPS - Transcranial Pulse (ultrasound-based)
    'tps': [
      {
        name: 'Deep Brain Targeting',
        description: 'Ultrasound pulse for deep brain structures',
        anodes: ['Fz', 'Cz'],
        cathode: 'Pz',
        indication: 'Alzheimer\'s, Deep Brain Stimulation'
      },
      {
        name: 'Frontal Lobe Focus',
        description: 'Frontal ultrasound pulse therapy',
        anodes: ['Fp1', 'Fp2'],
        cathode: 'O1',
        indication: 'Cognitive Decline, Memory'
      },
      {
        name: 'Temporal-Hippocampal',
        description: 'Temporal lobe ultrasound targeting',
        anodes: ['T3', 'T5'],
        cathode: 'Cz',
        indication: 'Memory Formation, Dementia'
      }
    ],
    
    // Flow - Standard placement device
    'flow': [
      {
        name: 'Standard Placement',
        description: 'Fixed standard placement for Flow device (non-customizable)',
        anodes: ['F3', 'F7'],
        cathode: 'Fp2',
        indication: 'Standard therapeutic placement'
      }
    ],
    
    // Robotic Arm - Automated precision
    'robotic_arm': [
      {
        name: 'Standard Robotic Placement',
        description: 'Single standard robotic placement option (non-customizable)',
        anodes: ['F3', 'F7'],
        cathode: 'Cz',
        indication: 'Standard robotic placement'
      }
    ]
  };
  
  // Return device-specific networks or default networks
  return deviceNetworks[deviceValue] || [
    {
      name: 'Default Mode Network',
      description: 'General purpose stimulation protocol',
      anodes: ['F3', 'F4'],
      cathode: 'Pz',
      indication: 'General Neuromodulation'
    },
    {
      name: 'Central Executive Network',
      description: 'Attention and cognitive control',
      anodes: ['Fp1', 'Fp2'],
      cathode: 'Cz',
      indication: 'Cognitive Enhancement'
    }
  ];
}

// UI State for custom montage editing
const customMontageState = {
  isEditing: false,
  activeDeviceIndex: null,
  activeTool: 'anode' // 'anode' or 'cathode'
};

function startCustomMontage(deviceIndex) {
  customMontageState.isEditing = true;
  customMontageState.activeDeviceIndex = deviceIndex;
  customMontageState.activeTool = 'anode';
  
  // Clear current montage for editing (blank template)
  const device = treatmentPlanState.devices[deviceIndex];
  device.montage.anodes = [];
  device.montage.cathode = '';
  highlightNetworkElectrodes(deviceIndex, [], '');
  
  // Reset Name input
  const nameInput = document.getElementById(`customMontageName_${deviceIndex}`);
  if (nameInput) nameInput.value = '';
  
  document.getElementById(`customMontageControls_${deviceIndex}`).classList.remove('hidden');
  document.getElementById(`startCustomBtn_${deviceIndex}`).classList.add('hidden');
  
  updateToolUI(deviceIndex);
}

function setElectrodeTool(deviceIndex, tool) {
  customMontageState.activeTool = tool;
  updateToolUI(deviceIndex);
}

function updateToolUI(deviceIndex) {
  const anodeBtn = document.getElementById(`toolAnode_${deviceIndex}`);
  const cathodeBtn = document.getElementById(`toolCathode_${deviceIndex}`);
  const label = document.getElementById(`currentToolLabel_${deviceIndex}`);
  
  if (customMontageState.activeTool === 'anode') {
    anodeBtn.classList.add('ring-2', 'ring-red-400', 'bg-red-50');
    anodeBtn.classList.remove('bg-white', 'border-red-200');
    anodeBtn.classList.add('border-red-400');
    
    cathodeBtn.classList.remove('ring-2', 'ring-blue-400', 'bg-blue-50');
    cathodeBtn.classList.add('bg-white', 'border-blue-200');
    
    label.textContent = 'Anode (+)';
    label.className = 'font-bold text-red-600';
  } else {
    cathodeBtn.classList.add('ring-2', 'ring-blue-400', 'bg-blue-50');
    cathodeBtn.classList.remove('bg-white', 'border-blue-200');
    cathodeBtn.classList.add('border-blue-400');
    
    anodeBtn.classList.remove('ring-2', 'ring-red-400', 'bg-red-50');
    anodeBtn.classList.add('bg-white', 'border-red-200');
    
    label.textContent = 'Cathode (-)';
    label.className = 'font-bold text-blue-600';
  }
}

function handleElectrodeClick(deviceIndex, electrodeId) {
  if (!customMontageState.isEditing || customMontageState.activeDeviceIndex !== deviceIndex) return;
  
  const device = treatmentPlanState.devices[deviceIndex];
  
  let anodes = new Set(device.montage.anodes);
  // Ensure cathode is a string for single cathode logic
  let cathode = device.montage.cathode; 
  
  if (customMontageState.activeTool === 'anode') {
    // If clicking on existing cathode, remove it from cathode
    if (cathode === electrodeId) {
        cathode = '';
    }
    
    // Toggle anode
    if (anodes.has(electrodeId)) {
      anodes.delete(electrodeId);
    } else {
        // Enforce Max 2 Anodes
        if (anodes.size < 2) {
            anodes.add(electrodeId);
        } else {
            alert('Maximum of 2 anodes allowed.');
        }
    }
  } else if (customMontageState.activeTool === 'cathode') {
    // If clicking on existing anode, remove it
    if (anodes.has(electrodeId)) {
      anodes.delete(electrodeId);
    }
    
    // Toggle cathode (single cathode logic)
    if (cathode === electrodeId) {
      cathode = '';
    } else {
      cathode = electrodeId;
    }
  }
  
  // Update state
  device.montage.anodes = Array.from(anodes);
  device.montage.cathode = cathode;
  
  // Update visualization
  highlightNetworkElectrodes(deviceIndex, device.montage.anodes, device.montage.cathode);
}

function applySameMontage(deviceIndex) {
  const device = treatmentPlanState.devices[deviceIndex];
  const networks = getDummyNetworks(device.value);
  const selectedIndex = device.selectedNetwork;
  
  if (selectedIndex !== '') {
    const network = networks[selectedIndex];
    device.montage.anodes = [...network.anodes];
    device.montage.cathode = network.cathode;
    highlightNetworkElectrodes(deviceIndex, device.montage.anodes, device.montage.cathode);
  }
}

function saveCustomMontage(deviceIndex) {
  customMontageState.isEditing = false;
  customMontageState.activeDeviceIndex = null;
  
  document.getElementById(`customMontageControls_${deviceIndex}`).classList.add('hidden');
  document.getElementById(`startCustomBtn_${deviceIndex}`).classList.remove('hidden');
  
  // Feedback to user
  const networkName = document.getElementById(`networkName_${deviceIndex}`);
  const customNameInput = document.getElementById(`customMontageName_${deviceIndex}`);
  
  let displayName = '(Custom)';
  if (customNameInput && customNameInput.value.trim() !== '') {
      displayName = `(${customNameInput.value.trim()})`;
  }
  
  if (networkName) {
      const currentName = networkName.textContent.split('(')[0].trim(); // Remove existing custom suffix if any
      networkName.textContent = `${currentName} ${displayName}`;
  }
  
  // Save custom name to state
  const device = treatmentPlanState.devices[deviceIndex];
  if (device && customNameInput && customNameInput.value.trim() !== '') {
      device.customMontageName = displayName;
      
      // Save to custom montages library
      const baseNetworkName = networkName ? networkName.textContent.split('(')[0].trim() : 'Unknown Network';
      console.log('[saveCustomMontage] Saving to library with data:', {
        name: customNameInput.value.trim(),
        anodes: device.montage.anodes,
        cathode: device.montage.cathode,
        deviceType: device.value,
        baseNetwork: baseNetworkName
      });
      
      const savedMontage = saveCustomMontageToLibrary(
        customNameInput.value.trim(),
        device.montage.anodes,
        device.montage.cathode,
        device.value,
        baseNetworkName
      );
      
      console.log('[saveCustomMontage] Saved montage:', savedMontage);
      
      // Update all device dropdowns with the new montage
      populateCustomMontagesForAllDevices();
      
      showNotification(`✓ Custom montage "${customNameInput.value.trim()}" saved successfully!`, 'success', 4000);
  } else {
    console.log('[saveCustomMontage] Skipping library save - no custom name provided');
  }
  
  saveTreatmentPlanState();
}

// Generate electrode SVG elements for network visualization
function generateNetworkElectrodes(deviceIndex) {
  const electrodes = [
    { id: 'Fp1', cx: 120, cy: 65 },
    { id: 'Fp2', cx: 180, cy: 65 },
    { id: 'F7', cx: 65, cy: 95 },
    { id: 'F3', cx: 115, cy: 95 },
    { id: 'Fz', cx: 150, cy: 90 },
    { id: 'F4', cx: 185, cy: 95 },
    { id: 'F8', cx: 235, cy: 95 },
    { id: 'T3', cx: 50, cy: 150 },
    { id: 'C3', cx: 105, cy: 150 },
    { id: 'Cz', cx: 150, cy: 150 },
    { id: 'C4', cx: 195, cy: 150 },
    { id: 'T4', cx: 250, cy: 150 },
    { id: 'T5', cx: 65, cy: 205 },
    { id: 'P3', cx: 115, cy: 205 },
    { id: 'Pz', cx: 150, cy: 210 },
    { id: 'P4', cx: 185, cy: 205 },
    { id: 'T6', cx: 235, cy: 205 },
    { id: 'O1', cx: 120, cy: 235 },
    { id: 'O2', cx: 180, cy: 235 }
  ];
  
  return electrodes.map(e => `
    <g id="electrode_${deviceIndex}_${e.id}" 
       onclick="handleElectrodeClick(${deviceIndex}, '${e.id}')"
       class="electrode-node transition-all duration-300 cursor-pointer hover:opacity-80">
      <circle cx="${e.cx}" cy="${e.cy}" r="10" fill="#e2e8f0" stroke="#64748b" stroke-width="2"/>
      <text x="${e.cx}" y="${e.cy + 4}" text-anchor="middle" font-size="9" font-weight="bold" fill="#1e293b">${e.id}</text>
    </g>
  `).join('');
}

// Select and visualize a network
function selectNetwork(deviceIndex, networkIndex) {
  if (networkIndex === '') {
    // Clear selection
    clearNetworkHighlights(deviceIndex);
    document.getElementById(`networkDetails_${deviceIndex}`).classList.add('hidden');
    document.getElementById(`networkInfo_${deviceIndex}`).innerHTML = `
      <p class="text-xs font-semibold text-purple-900 text-center">
        Select a network from the right panel to view montage
      </p>
    `;
    return;
  }
  
  const device = treatmentPlanState.devices[deviceIndex];
  if (!device) return;
  
  const networks = getDummyNetworks(device.value);
  const network = networks[networkIndex];
  
  if (!network) return;
  
  // Update right panel details
  document.getElementById(`networkDetails_${deviceIndex}`).classList.remove('hidden');
  document.getElementById(`networkName_${deviceIndex}`).textContent = network.name;
  document.getElementById(`networkDesc_${deviceIndex}`).textContent = network.description;
  document.getElementById(`networkAnodes_${deviceIndex}`).textContent = network.anodes.join(', ');
  document.getElementById(`networkCathode_${deviceIndex}`).textContent = network.cathode;
  document.getElementById(`networkIndication_${deviceIndex}`).textContent = network.indication;
  
  // Update left panel info
  document.getElementById(`networkInfo_${deviceIndex}`).innerHTML = `
    <p class="text-xs font-bold text-purple-900 mb-1">
      <i class="fa-solid fa-bolt mr-1"></i>Active Network: ${network.name}
    </p>
    <p class="text-xs text-purple-700">
      Anodes: <span class="font-mono font-bold">${network.anodes.join(', ')}</span> | 
      Cathode: <span class="font-mono font-bold">${network.cathode}</span>
    </p>
  `;
  
  // Highlight electrodes on brain montage
  highlightNetworkElectrodes(deviceIndex, network.anodes, network.cathode);
  
  // Store selected network in device state
  device.selectedNetwork = networkIndex;
  device.montage.anodes = network.anodes;
  device.montage.cathode = network.cathode;
  
  // Clear custom name as we reset to standard
  delete device.customMontageName;
  saveTreatmentPlanState();
}

// Highlight electrodes based on network configuration
function highlightNetworkElectrodes(deviceIndex, anodes, cathode) {
  console.log('Highlighting electrodes for device:', deviceIndex, 'Anodes:', anodes, 'Cathode:', cathode);
  
  // First, reset all electrodes
  clearNetworkHighlights(deviceIndex);
  
  // Highlight anodes in red
  anodes.forEach(anodeId => {
    const electrode = document.getElementById(`electrode_${deviceIndex}_${anodeId}`);
    console.log('Looking for anode electrode:', `electrode_${deviceIndex}_${anodeId}`, 'Found:', !!electrode);
    if (electrode) {
      const circle = electrode.querySelector('circle');
      const text = electrode.querySelector('text');
      if (circle) {
        circle.setAttribute('fill', '#ef4444');
        circle.setAttribute('stroke', '#dc2626');
        circle.setAttribute('stroke-width', '3');
        circle.style.filter = 'drop-shadow(0 0 6px rgba(239, 68, 68, 0.6))';
      }
      if (text) {
        text.setAttribute('fill', '#ffffff');
      }
    }
  });
  
  // Highlight cathode in blue
  if (cathode) {
    const cathodeElectrode = document.getElementById(`electrode_${deviceIndex}_${cathode}`);
    console.log('Looking for cathode electrode:', `electrode_${deviceIndex}_${cathode}`, 'Found:', !!cathodeElectrode);
    if (cathodeElectrode) {
      const circle = cathodeElectrode.querySelector('circle');
      const text = cathodeElectrode.querySelector('text');
      if (circle) {
        circle.setAttribute('fill', '#3b82f6');
        circle.setAttribute('stroke', '#2563eb');
        circle.setAttribute('stroke-width', '3');
        circle.style.filter = 'drop-shadow(0 0 6px rgba(59, 130, 246, 0.6))';
      }
      if (text) {
        text.setAttribute('fill', '#ffffff');
      }
    }
  }
}

// Clear all electrode highlights
function clearNetworkHighlights(deviceIndex) {
  const allElectrodes = document.querySelectorAll(`[id^="electrode_${deviceIndex}_"]`);
  allElectrodes.forEach(electrode => {
    const circle = electrode.querySelector('circle');
    const text = electrode.querySelector('text');
    if (circle) {
      circle.setAttribute('fill', '#e2e8f0');
      circle.setAttribute('stroke', '#64748b');
      circle.setAttribute('stroke-width', '2');
      circle.style.filter = 'none';
    }
    if (text) {
      text.setAttribute('fill', '#1e293b');
    }
  });
}

// Helper function to determine if device uses brain montage
function usesBrainMontage(deviceValue) {
  const brainDevices = ['device1', 'device2', 'newronika', 'flow', 'robotic_arm', 'tps'];
  return brainDevices.includes(deviceValue);
}

// Helper function to get device-specific visualization
function getDeviceVisualization(deviceValue, deviceIndex) {
  // VNS - Neck Region
  if (deviceValue === 'device3') {
    return `
      <div class="flex flex-col items-center justify-center p-4">
        <img src="eardevice.png" alt="VNS Device Placement" class="max-w-full max-h-64 object-contain border border-slate-200 rounded bg-gradient-to-br from-slate-50 to-blue-50 p-2"/>
        <div class="mt-3 text-center">
          <p class="text-sm font-semibold text-purple-700">VNS Device</p>
          <p class="text-xs text-slate-600">Vagus Nerve Stimulation</p>
        </div>
      </div>
    `;
  }
  
  // Alpha Stim AID - Cranial Electrotherapy
  if (deviceValue === 'alpha_stim_aid') {
    return `
      <div class="flex flex-col items-center justify-center p-4">
        <img src="eardevice.png" alt="Alpha Stim AID Placement" class="max-w-full max-h-64 object-contain border border-slate-200 rounded bg-gradient-to-br from-slate-50 to-blue-50 p-2"/>
        <div class="mt-3 text-center">
          <p class="text-sm font-semibold text-orange-700">Alpha Stim AID</p>
          <p class="text-xs text-slate-600">Cranial Electrotherapy (CES Mode)</p>
        </div>
      </div>
    `;
  }
  
  // Alpha Stim MET - Microcurrent Therapy
  if (deviceValue === 'alpha_stim_met') {
    return `
      <div class="flex flex-col items-center justify-center p-4">
        <img src="eardevice.png" alt="Alpha Stim MET Placement" class="max-w-full max-h-64 object-contain border border-slate-200 rounded bg-gradient-to-br from-slate-50 to-blue-50 p-2"/>
        <div class="mt-3 text-center">
          <p class="text-sm font-semibold text-green-700">Alpha Stim MET</p>
          <p class="text-xs text-slate-600">Microcurrent Therapy</p>
        </div>
      </div>
    `;
  }
  
  // tVNS - Transcutaneous Vagus Nerve (Ear-based)
  if (deviceValue === 'tvns') {
    return `
      <svg viewBox="0 0 300 300" class="w-full max-w-xs border border-slate-200 rounded bg-gradient-to-br from-slate-50 to-blue-50 p-2 mx-auto">
        <!-- Ear outline -->
        <path d="M 120 100 Q 150 80 180 100 Q 200 150 180 200 Q 150 220 120 200 Q 100 150 120 100" fill="none" stroke="#94a3b8" stroke-width="3"/>
        <path d="M 130 110 Q 150 90 170 110 Q 185 150 170 190 Q 150 210 130 190 Q 115 150 130 110" fill="#fee2e2" fill-opacity="0.6" stroke="#ef4444" stroke-width="2"/>
        
        <!-- tVNS electrode on ear -->
        <circle cx="150" cy="150" r="12" fill="#7c3aed" fill-opacity="0.8" stroke="#5b21b6" stroke-width="3"/>
        <text x="150" y="155" text-anchor="middle" font-size="8" font-weight="bold" fill="white">tVNS</text>
        
        <!-- Nerve pathway -->
        <path d="M 150 150 Q 120 180 90 220" fill="none" stroke="#059669" stroke-width="4" stroke-dasharray="3,3"/>
        
        <text x="150" y="250" text-anchor="middle" font-size="11" font-weight="bold" fill="#7c3aed">Auricular</text>
      </svg>
    `;
  }
  
  // Plato - 4 Brain Region Blocks
  if (deviceValue === 'plato') {
    return `
      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <!-- Block 1: Forehead -->
          <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg border-2 border-purple-300">
            <div class="h-20 flex items-center justify-center mb-2">
              <img src="block1.png" alt="Block 1 - Forehead Placement" class="max-h-full max-w-full object-contain"/>
            </div>
            <p class="text-xs font-semibold text-purple-700 text-center">Block 1</p>
            <p class="text-xs text-purple-600 text-center">Forehead</p>
          </div>
          
          <!-- Block 2: Middle Device Placement -->
          <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border-2 border-blue-300">
            <div class="h-20 flex items-center justify-center mb-2">
              <img src="block2.png" alt="Block 2 - Middle Device Placement" class="max-h-full max-w-full object-contain"/>
            </div>
            <p class="text-xs font-semibold text-blue-700 text-center">Block 2</p>
            <p class="text-xs text-blue-600 text-center">Middle Device</p>
          </div>
          
          <!-- Block 3: Middle Device Placement (Inverted) -->
          <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg border-2 border-green-300">
            <div class="h-20 flex items-center justify-center mb-2">
              <img src="block3.png" alt="Block 3 - Middle Device Placement (Inverted)" class="max-h-full max-w-full object-contain"/>
            </div>
            <p class="text-xs font-semibold text-green-700 text-center">Block 3</p>
            <p class="text-xs text-green-600 text-center">Middle Device (Inverted)</p>
          </div>
          
          <!-- Block 4: Back Device Placement (Inverted) -->
          <div class="bg-gradient-to-br from-red-50 to-red-100 p-4 rounded-lg border-2 border-red-300">
            <div class="h-20 flex items-center justify-center mb-2">
              <img src="block4.png" alt="Block 4 - Back Device Placement (Inverted)" class="max-h-full max-w-full object-contain"/>
            </div>
            <p class="text-xs font-semibold text-red-700 text-center">Block 4</p>
            <p class="text-xs text-red-600 text-center">Back Device (Inverted)</p>
          </div>
        </div>
        
        <!-- Overall Plato Device Info -->
        <div class="mt-4 p-3 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg border-2 border-purple-200">
          <p class="text-sm font-semibold text-purple-900 text-center mb-1">
            <i class="fa-solid fa-microchip mr-2"></i>Plato Neurostimulation System
          </p>
          <p class="text-xs text-purple-700 text-center">
            4 specialized electrode blocks targeting specific brain regions
          </p>
        </div>
      </div>
    `;
  }
  
  // Default return empty if no specific visualization
  return '';
}

function renderDeviceJourney(device, deviceIndex) {
  if (!device) return '<p class="text-slate-500">No device selected</p>';
  
  // Get dummy networks for this device
  const networks = getDummyNetworks(device.value);
  const showBrainMontage = usesBrainMontage(device.value);
  // For some standard-placement devices we do not allow custom montage editing
  const disallowCustomMontageDevices = ['flow', 'robotic_arm'];
  const allowCustomMontage = !disallowCustomMontageDevices.includes(device.value);
  const showCustomMontageTab = showBrainMontage && allowCustomMontage;
  const deviceViz = getDeviceVisualization(device.value, deviceIndex);
  
  // Debug logging
  console.log('Rendering device journey for:', {
    deviceValue: device.value,
    deviceIndex,
    networksCount: networks?.length || 0,
    showBrainMontage,
    networks: networks?.map(n => n.name) || []
  });
  
  return `
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- LEFT PANEL: Visualization (Brain Montage or Device-Specific) -->
      <div class="bg-gradient-to-br from-slate-50 to-blue-50 p-6 rounded-xl border-2 border-slate-300 shadow-lg">
        <h4 class="text-lg font-bold text-slate-900 mb-4 flex items-center gap-2">
          <i class="fa-solid ${showBrainMontage ? 'fa-brain text-purple-600' : 'fa-microchip text-orange-600'}"></i>
          ${showBrainMontage ? 'Brain Montage Visualization' : 'Device Placement Visualization'}
        </h4>
        
        <div class="bg-white p-4 rounded-lg border border-slate-200">
          <p class="text-xs text-slate-600 mb-3 text-center">
            <i class="fa-solid fa-info-circle mr-1 text-blue-500"></i>
            ${showBrainMontage ? '10-20 Electrode System - Network-based highlighting' : 'Device-specific placement zones'}
          </p>
          
          ${showBrainMontage ? `
          <!-- Interactive Brain Montage SVG -->
          <svg id="brainMontage_${deviceIndex}" viewBox="0 0 300 300" class="w-full max-w-md mx-auto">
            <!-- Brain outline -->
            <circle cx="150" cy="150" r="120" fill="none" stroke="#94a3b8" stroke-width="3" stroke-dasharray="5,5"/>
            <circle cx="150" cy="150" r="110" fill="none" stroke="#cbd5e1" stroke-width="2"/>
            
            <!-- Reference markers -->
            <circle cx="150" cy="35" r="6" fill="#64748b" stroke="#475569" stroke-width="2"/>
            <text x="150" y="25" text-anchor="middle" font-size="10" font-weight="bold" fill="#475569">NASION</text>
            
            <circle cx="150" cy="265" r="6" fill="#64748b" stroke="#475569" stroke-width="2"/>
            <text x="150" y="285" text-anchor="middle" font-size="10" font-weight="bold" fill="#475569">INION</text>
            
            <!-- All electrode positions -->
            ${generateNetworkElectrodes(deviceIndex)}
          </svg>
          
          <!-- Legend -->
          <div class="mt-4 flex items-center justify-center gap-4 text-xs">
            <div class="flex items-center gap-1">
              <div class="w-3 h-3 rounded-full bg-red-500"></div>
              <span class="text-slate-700">Anode (+)</span>
            </div>
            <div class="flex items-center gap-1">
              <div class="w-3 h-3 rounded-full bg-blue-500"></div>
              <span class="text-slate-700">Cathode (-)</span>
            </div>
            <div class="flex items-center gap-1">
              <div class="w-3 h-3 rounded-full bg-slate-300"></div>
              <span class="text-slate-700">Inactive</span>
            </div>
          </div>
          ` : `
          <!-- Device-Specific Visualization -->
          ${deviceViz}
          
          <!-- Device-specific legend -->
          <div class="mt-4 p-3 bg-amber-50 rounded border border-amber-200">
            <p class="text-xs text-amber-900 text-center">
              <i class="fa-solid fa-lightbulb mr-1"></i>
              ${device.value === 'device3' ? 'This device uses neck-based stimulation' : 
                device.value === 'plato' ? 'Multi-region brain stimulation with 4 specialized blocks' : 
                'This device uses ear-based stimulation'}
            </p>
          </div>
          `}
          
          <!-- Current Network Info -->
          <div id="networkInfo_${deviceIndex}" class="mt-4 p-3 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg border border-purple-200">
            <p class="text-xs font-semibold text-purple-900 text-center">
              Select a network from the right panel to view ${showBrainMontage ? 'montage' : 'configuration'}
            </p>
          </div>
        </div>
      </div>
      
      <!-- RIGHT PANEL: Tabbed Interface for Network Selection & Custom Montages -->
      <div class="bg-gradient-to-br from-green-50 to-teal-50 p-6 rounded-xl border-2 border-green-300 shadow-lg">
        <!-- Tab Headers -->
          <div class="flex border-b-2 border-green-300 mb-4">
          <button 
            id="networkTab_${deviceIndex}" 
            onclick="switchMontageTab(${deviceIndex}, 'network')" 
            class="flex-1 px-4 py-3 font-semibold transition-all border-b-4 border-green-600 text-green-700 bg-green-100"
          >
            <i class="fa-solid fa-network-wired mr-2"></i>
          </button>
          ${showCustomMontageTab ? `
          <button 
            id="customTab_${deviceIndex}" 
            onclick="switchMontageTab(${deviceIndex}, 'custom')" 
            class="flex-1 px-4 py-3 font-semibold transition-all border-b-4 border-transparent text-slate-600 hover:bg-slate-50"
          >
            <i class="fa-solid fa-star mr-2"></i>Custom Montage
          </button>
          ` : ''}
        </div>
        
        <!-- Network Selection Tab Content -->
        <div id="networkTabContent_${deviceIndex}" class="space-y-4">
          <!-- Disease Selection (Only for non-standard placement devices) -->
          ${!['device3', 'alpha_stim_aid', 'alpha_stim_met', 'tvns', 'plato'].includes(device.value) ? `
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">
              <i class="fa-solid fa-stethoscope mr-1 text-green-600"></i>
              Clinical Condition
            </label>
            <select 
              id="diseaseSelect_${deviceIndex}" 
              class="input-royal w-full"
              onchange="handleDiseaseSelection(${deviceIndex}, this.value)"
            >
              <option value="">-- Select Clinical Condition --</option>
              <option value="disease1">Depression</option>
              <option value="disease2">Anxiety Disorders</option>
              <option value="disease3">Chronic Pain</option>
            </select>
            <p class="text-xs text-slate-500 mt-1">Select the primary condition to see relevant treatment protocols</p>
          </div>
          
          <!-- Disease-Specific Montage Selection (Hidden by default) -->
          <div id="diseaseMontageSection_${deviceIndex}" class="hidden">
            <label class="block text-sm font-semibold text-slate-700 mb-2">
              <i class="fa-solid fa-brain mr-1 text-purple-600"></i>
              Network
            </label>
            <select 
              id="diseaseMontageSelect_${deviceIndex}" 
              class="input-royal w-full"
              onchange="handleDiseaseMontageSelection(${deviceIndex}, this.value)"
            >
              <option value="">-- Select Network --</option>
              <!-- Options will be populated by JavaScript based on disease selection -->
            </select>
            <p class="text-xs text-slate-500 mt-1">Network-specific electrode configurations for optimal treatment</p>
          </div>
          ` : `
          <!-- Standard Placement Device - No Network Configuration Required -->
          <div class="bg-amber-50 border-2 border-amber-300 rounded-lg p-4">
            <div class="flex items-start gap-3">
              <div class="flex-shrink-0">
                <i class="fa-solid fa-exclamation-triangle text-amber-600 text-xl"></i>
              </div>
              <div>
                <h4 class="text-amber-900 font-bold text-sm mb-2">
                  <i class="fa-solid fa-map-pin mr-1"></i>
                  Standard Placement Device
                </h4>
                <p class="text-amber-800 text-xs leading-relaxed mb-2">
                  This device uses <strong>fixed electrode placement</strong> according to established clinical protocols. 
                  No network configuration is required as the placement is standardized for optimal therapeutic outcomes.
                </p>
                <div class="bg-amber-100 rounded p-2 border border-amber-200">
                  <p class="text-amber-900 text-[10px] font-semibold flex items-center gap-1">
                    <i class="fa-solid fa-info-circle"></i>
                    CAUTION: Follow device-specific placement guidelines as shown in the visualization panel
                  </p>
                </div>
              </div>
            </div>
          </div>
          `}
          
          <!-- Action Buttons -->
          <div class="flex gap-2">
            <button onclick="showFullMontageGuide()" class="btn-secondary text-sm flex-1">
              <i class="fa-solid fa-book mr-2"></i>Guide
            </button>
          </div>
        </div>
        
        <!-- Custom Montage Tab Content (Only for brain devices that allow custom montages) -->
        ${showCustomMontageTab ? `
        <div id="customTabContent_${deviceIndex}" class="hidden space-y-4">
          <!-- Load Saved Custom Montages Section -->
          <div class="bg-white p-4 rounded-lg border border-purple-200">
            <h5 class="text-sm font-bold text-purple-900 mb-3 flex items-center gap-2">
              <i class="fa-solid fa-star"></i>
              Load Saved Custom Montages
            </h5>
            <select 
              id="customMontageSelect_${deviceIndex}" 
              class="input-royal w-full text-sm mb-2" 
              onchange="loadCustomMontageForDevice(${deviceIndex}, this.value)"
            >
              <option value="">-- Select Custom Montage --</option>
              <optgroup label="Custom Montages" id="customMontagesOptgroup_${deviceIndex}">
                <!-- Custom montages will be populated here -->
              </optgroup>
            </select>
            <div class="flex gap-2">
              <button 
                id="deleteCustomMontageBtn_${deviceIndex}" 
                onclick="deleteCustomMontageForDevice(${deviceIndex})" 
                class="hidden flex-1 px-3 py-2 bg-red-500 text-white rounded text-xs hover:bg-red-600 transition-colors"
                title="Delete selected custom montage"
              >
                <i class="fa-solid fa-trash mr-1"></i>Delete Selected
              </button>
            </div>
            <p class="text-[9px] text-purple-600 mt-2 text-center">
              <i class="fa-solid fa-info-circle mr-1"></i>
              Select a saved custom montage to load it, or create a new one below
            </p>
          </div>
          
          <!-- Create Custom Montage Section -->
          <div class="bg-gradient-to-br from-indigo-50 to-purple-50 p-4 rounded-lg border border-indigo-200">
            <h5 class="text-sm font-bold text-indigo-900 mb-3 flex items-center gap-2">
              <i class="fa-solid fa-plus-circle"></i>
              Create New Custom Montage
            </h5>
            
            <div id="startCustomBtn_${deviceIndex}">
               <button onclick="startCustomMontage(${deviceIndex})" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white p-2.5 rounded-lg text-sm font-bold shadow-md transition-all flex items-center justify-center gap-2 transform active:scale-95">
                 <i class="fa-solid fa-sliders"></i> 
                 Start Custom Configuration
               </button>
               <p class="text-[10px] text-slate-500 text-center mt-2">Click to modify electrode placement for this patient</p>
            </div>
            
            <!-- Custom Edit Controls (Hidden by default) -->
            <div id="customMontageControls_${deviceIndex}" class="hidden mt-4 pt-4 border-t-2 border-dashed border-indigo-200">
                <h6 class="text-xs font-bold text-indigo-900 mb-3 flex items-center gap-2">
                  <i class="fa-solid fa-pen-to-square"></i> Configuration Mode Active
                </h6>
                
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <button id="toolAnode_${deviceIndex}" onclick="setElectrodeTool(${deviceIndex}, 'anode')" class="p-2 bg-white border border-red-200 rounded text-xs font-bold text-red-700 hover:bg-red-50 flex items-center justify-center gap-1 transition-all shadow-sm">
                        <div class="w-3 h-3 rounded-full bg-red-500"></div> Place Anode
                    </button>
                    <button id="toolCathode_${deviceIndex}" onclick="setElectrodeTool(${deviceIndex}, 'cathode')" class="p-2 bg-white border border-blue-200 rounded text-xs font-bold text-blue-700 hover:bg-blue-50 flex items-center justify-center gap-1 transition-all shadow-sm">
                        <div class="w-3 h-3 rounded-full bg-blue-500"></div> Place Cathode
                    </button>
                </div>
                
                <p class="text-[10px] text-indigo-600 text-center mb-3 bg-white/60 p-1.5 rounded border border-indigo-100">
                  <i class="fa-solid fa-mouse-pointer mr-1"></i>
                  Click nodes on the left to place <span id="currentToolLabel_${deviceIndex}" class="font-bold">Anode</span>
                  <br><span class="text-[9px] text-indigo-400">(Max 2 Anodes, 1 Cathode)</span>
                </p>
                
                <div class="mb-3">
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Custom Montage Name</label>
                    <input type="text" id="customMontageName_${deviceIndex}" placeholder="e.g., Patient Specific F3-F4" class="w-full text-xs p-2 border border-slate-300 rounded focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none">
                </div>
                
                <div class="space-y-2">
                     <button onclick="applySameMontage(${deviceIndex})" class="w-full bg-white hover:bg-slate-50 text-slate-700 border border-slate-300 p-2 rounded text-xs font-bold transition-colors flex items-center justify-center gap-2">
                       <i class="fa-solid fa-rotate-left"></i> Reset to Base Network
                     </button>
                     <button onclick="saveCustomMontage(${deviceIndex})" class="w-full bg-green-600 hover:bg-green-700 text-white p-2 rounded text-xs font-bold shadow transition-colors flex items-center justify-center gap-2">
                       <i class="fa-solid fa-check"></i> Save Custom Configuration
                     </button>
                </div>
            </div>
          </div>
          
          <!-- Help Section -->
          <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
            <p class="text-xs text-blue-900 mb-2">
              <i class="fa-solid fa-info-circle mr-1"></i>
              <strong>Custom Montage Guide:</strong>
            </p>
            <ul class="text-[10px] text-blue-800 space-y-1 ml-4 list-disc">
              <li>Start with a base network or create from scratch</li>
              <li>Click electrodes on the brain visualization to place anodes and cathodes</li>
              <li>Save your configuration with a descriptive name</li>
              <li>Saved montages can be loaded anytime from the dropdown above</li>
            </ul>
          </div>
        </div>
        ` : ''}
              <i class="fa-solid fa-book mr-2"></i>Guide
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Custom Montage Section (Hidden by default) -->
    ${showCustomMontageTab ? `
    <div id="customMontageSection_${deviceIndex}" class="mt-6 bg-gradient-to-br from-purple-50 to-pink-50 p-6 rounded-xl border-2 border-purple-300 hidden">
      <h4 class="text-lg font-bold text-slate-900 mb-4 flex items-center gap-2">
        <span class="w-8 h-8 bg-purple-600 text-white rounded-lg flex items-center justify-center text-sm font-bold">
          <i class="fa-solid fa-wand-magic-sparkles"></i>
        </span>
        Custom Montage Configuration
        <button onclick="toggleCustomMontage(${deviceIndex})" class="ml-auto text-red-500 hover:text-red-700" title="Close">
          <i class="fa-solid fa-times"></i>
        </button>
      </h4>
        
        <div class="space-y-4">
          <p class="text-sm text-slate-600"><i class="fa-solid fa-hand-pointer mr-2 text-purple-600"></i>Click on electrodes below to set Anode (+) and Cathode (-) positions</p>
          
          <!-- Electrode Mode Selection -->
          <div class="flex gap-3 mb-4">
            <button 
              onclick="setElectrodeMode(${deviceIndex}, 'anode')" 
              class="flex-1 py-3 px-4 rounded-lg font-semibold transition-all ${device.montage.anode ? 'bg-red-500 text-white' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'}"
            >
              <i class="fa-solid fa-plus mr-2"></i>Anode (+)
              ${device.montage.anode ? `<span class="ml-2 text-xs">${device.montage.anode}</span>` : ''}
            </button>
            <button 
              onclick="setElectrodeMode(${deviceIndex}, 'cathode')" 
              class="flex-1 py-3 px-4 rounded-lg font-semibold transition-all ${device.montage.cathode ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'}"
            >
              <i class="fa-solid fa-minus mr-2"></i>Cathode (-)
              ${device.montage.cathode ? `<span class="ml-2 text-xs">${device.montage.cathode}</span>` : ''}
            </button>
          </div>
          
          <!-- Interactive Montage Builder -->
          <div class="bg-white p-4 rounded-lg border-2 border-purple-300">
            <svg id="customMontage_${deviceIndex}" viewBox="0 0 300 300" class="w-full max-w-md mx-auto">
              <!-- Brain outline -->
              <circle cx="150" cy="150" r="120" fill="none" stroke="#94a3b8" stroke-width="3"/>
              
              <!-- Interactive electrodes -->
              ${generateInteractiveElectrodes(deviceIndex, device.montage)}
            </svg>
          </div>
          
          ${device.montage.anode && device.montage.cathode ? `
          <div class="mt-4 p-4 bg-white rounded-lg border-2 border-purple-400">
            <p class="text-sm font-bold text-purple-900 mb-2"><i class="fa-solid fa-check-circle mr-2"></i>Montage Configured:</p>
            <div class="grid grid-cols-2 gap-3 text-sm">
              <div class="bg-red-50 p-3 rounded border border-red-300">
                <span class="font-semibold text-red-700">Anode (+):</span>
                <span class="ml-2 text-red-900 font-bold">${device.montage.anode}</span>
              </div>
              <div class="bg-blue-50 p-3 rounded border border-blue-300">
                <span class="font-semibold text-blue-700">Cathode (-):</span>
                <span class="ml-2 text-blue-900 font-bold">${device.montage.cathode}</span>
              </div>
            </div>
            <button onclick="resetMontage(${deviceIndex})" class="mt-3 btn-secondary text-sm w-full">
              <i class="fa-solid fa-redo mr-2"></i>Reset Montage
            </button>
          </div>
          ` : ''}
        </div>
      </div>
    </div>
    ` : ''}
  `;
}

// Helper function to generate blank electrodes
function generateBlankElectrodes() {
  const electrodes = [
    { id: 'Fp1', cx: 120, cy: 65 },
    { id: 'Fp2', cx: 180, cy: 65 },
    { id: 'F7', cx: 65, cy: 95 },
    { id: 'F3', cx: 115, cy: 95 },
    { id: 'Fz', cx: 150, cy: 90 },
    { id: 'F4', cx: 185, cy: 95 },
    { id: 'F8', cx: 235, cy: 95 },
    { id: 'T3', cx: 50, cy: 150 },
    { id: 'C3', cx: 105, cy: 150 },
    { id: 'Cz', cx: 150, cy: 150 },
    { id: 'C4', cx: 195, cy: 150 },
    { id: 'T4', cx: 250, cy: 150 },
    { id: 'T5', cx: 65, cy: 205 },
    { id: 'P3', cx: 115, cy: 205 },
    { id: 'Pz', cx: 150, cy: 210 },
    { id: 'P4', cx: 185, cy: 205 },
    { id: 'T6', cx: 235, cy: 205 },
    { id: 'O1', cx: 120, cy: 235 },
    { id: 'O2', cx: 180, cy: 235 }
  ];
  
  return electrodes.map(e => `
    <g class="electrode">
      <circle cx="${e.cx}" cy="${e.cy}" r="10" fill="#e2e8f0" stroke="#64748b" stroke-width="2"/>
      <text x="${e.cx}" y="${e.cy + 4}" text-anchor="middle" font-size="9" font-weight="bold" fill="#1e293b">${e.id}</text>
    </g>
  `).join('');
}

// Helper function to generate interactive electrodes
function generateInteractiveElectrodes(deviceIndex, montage) {
  const electrodes = [
    { id: 'Fp1', cx: 120, cy: 65 },
    { id: 'Fp2', cx: 180, cy: 65 },
    { id: 'F7', cx: 65, cy: 95 },
    { id: 'F3', cx: 115, cy: 95 },
    { id: 'Fz', cx: 150, cy: 90 },
    { id: 'F4', cx: 185, cy: 95 },
    { id: 'F8', cx: 235, cy: 95 },
    { id: 'T3', cx: 50, cy: 150 },
    { id: 'C3', cx: 105, cy: 150 },
    { id: 'Cz', cx: 150, cy: 150 },
    { id: 'C4', cx: 195, cy: 150 },
    { id: 'T4', cx: 250, cy: 150 },
    { id: 'T5', cx: 65, cy: 205 },
    { id: 'P3', cx: 115, cy: 205 },
    { id: 'Pz', cx: 150, cy: 210 },
    { id: 'P4', cx: 185, cy: 205 },
    { id: 'T6', cx: 235, cy: 205 },
    { id: 'O1', cx: 120, cy: 235 },
    { id: 'O2', cx: 180, cy: 235 }
  ];
  
  return electrodes.map(e => {
    let fill = '#e2e8f0';
    let stroke = '#64748b';
    let strokeWidth = 2;
    
    if (montage.anode === e.id) {
      fill = '#ef4444';
      stroke = '#dc2626';
      strokeWidth = 3;
    } else if (montage.cathode === e.id) {
      fill = '#3b82f6';
      stroke = '#2563eb';
      strokeWidth = 3;
    }
    
    return `
      <g class="electrode cursor-pointer" onclick="selectElectrode(${deviceIndex}, '${e.id}')" style="cursor: pointer;">
        <circle cx="${e.cx}" cy="${e.cy}" r="12" fill="${fill}" stroke="${stroke}" stroke-width="${strokeWidth}" class="transition-all hover:opacity-80"/>
        <text x="${e.cx}" y="${e.cy + 4}" text-anchor="middle" font-size="10" font-weight="bold" fill="#fff" pointer-events="none">${e.id}</text>
      </g>
    `;
  }).join('');
}

// Electrode selection functions
let currentElectrodeMode_device = {}; // Track mode per device

function setElectrodeMode(deviceIndex, mode) {
  currentElectrodeMode_device[deviceIndex] = mode;
}

function selectElectrode(deviceIndex, electrodeId) {
  const device = treatmentPlanState.devices[deviceIndex];
  if (!device) return;
  
  const mode = currentElectrodeMode_device[deviceIndex] || 'anode';
  
  if (mode === 'anode') {
    device.montage.anode = electrodeId;
  } else if (mode === 'cathode') {
    device.montage.cathode = electrodeId;
  }
  
  // Re-render the device journey
  const content = document.getElementById('deviceTabContent');
  if (content) {
    content.innerHTML = renderDeviceJourney(device, deviceIndex);
  }
}

function resetMontage(deviceIndex) {
  if (confirm('Are you sure you want to reset this montage configuration?')) {
    const device = treatmentPlanState.devices[deviceIndex];
    if (device) {
      device.montage = {
        type: 'blank',
        anode: null,
        cathode: null
      };
      
      // Re-render
      const content = document.getElementById('deviceTabContent');
      if (content) {
        content.innerHTML = renderDeviceJourney(device, deviceIndex);
      }
    }
  }
}

function updateDeviceSymptoms(deviceIndex, symptom) {
  const device = treatmentPlanState.devices[deviceIndex];
  if (device && symptom) {
    device.symptoms = [symptom]; // For now, single selection
    
    // Re-render to show updated state
    const content = document.getElementById('deviceTabContent');
    if (content) {
      content.innerHTML = renderDeviceJourney(device, deviceIndex);
    }
  }
}

function updateDeviceNetwork(deviceIndex, network) {
  const device = treatmentPlanState.devices[deviceIndex];
  if (device) {
    device.network = network;
    
    // Re-render to show updated state
    const content = document.getElementById('deviceTabContent');
    if (content) {
      content.innerHTML = renderDeviceJourney(device, deviceIndex);
    }
  }
}

function showFullMontageGuide() {
  alert('Complete 10-20 Montage Guide:\n\nThis would open a detailed guide showing all electrode positions, measurement techniques, and standard montage configurations.');
}

function toggleCustomMontage(deviceIndex) {
  const section = document.getElementById(`customMontageSection_${deviceIndex}`);
  if (section) {
    section.classList.toggle('hidden');
    
    // Scroll to the section if it's being shown
    if (!section.classList.contains('hidden')) {
      setTimeout(() => {
        section.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }, 100);
    }
  }
}


// Global state for custom electrode placement
let customMontageConfig = null;
// Treatment plan specific functions continue...

// Get custom montage from storage if exists
function getCustomMontage(montageId) {
  return customMontagesLibrary.find(m => m.id === montageId) || null;
}

// Set electrode mode (anode, cathode, or remove)
function setElectrodeMode(mode) {
  currentElectrodeMode = mode;
  
  // Update button styles
  const anodeBtn = document.getElementById('selectAnodeMode');
  const cathodeBtn = document.getElementById('selectCathodeMode');
  const removeBtn = document.getElementById('selectRemoveMode');
  const modeIndicator = document.getElementById('activeModeIndicator');
  
  // Reset all buttons to inactive state
  anodeBtn.className = 'flex-1 px-3 py-2 text-xs font-bold rounded-lg border-2 transition-all shadow-sm hover:shadow-md bg-white text-red-700 border-red-300 hover:border-red-400';
  cathodeBtn.className = 'flex-1 px-3 py-2 text-xs font-bold rounded-lg border-2 transition-all shadow-sm hover:shadow-md bg-white text-blue-700 border-blue-300 hover:border-blue-400';
  removeBtn.className = 'flex-1 px-3 py-2 text-xs font-bold rounded-lg border-2 transition-all shadow-sm hover:shadow-md bg-white text-slate-700 border-slate-300 hover:border-slate-400';
  
  if (mode === 'anode') {
    // Active anode button style
    anodeBtn.className = 'flex-1 px-3 py-2 text-xs font-bold rounded-lg border-2 transition-all shadow-md bg-gradient-to-br from-red-500 to-red-600 text-white border-red-700';
    
    // Update mode indicator
    if (modeIndicator) {
      modeIndicator.textContent = 'ANODE MODE';
      modeIndicator.className = 'px-2 py-0.5 rounded text-xs font-bold bg-red-500 text-white';
    }
    
    // Add cursor indicator to brain diagram
    updateBrainCursorMode('anode');
  } else if (mode === 'cathode') {
    // Active cathode button style
    cathodeBtn.className = 'flex-1 px-3 py-2 text-xs font-bold rounded-lg border-2 transition-all shadow-md bg-gradient-to-br from-blue-500 to-blue-600 text-white border-blue-700';
    
    // Update mode indicator
    if (modeIndicator) {
      modeIndicator.textContent = 'CATHODE MODE';
      modeIndicator.className = 'px-2 py-0.5 rounded text-xs font-bold bg-blue-500 text-white';
    }
    
    // Add cursor indicator to brain diagram
    updateBrainCursorMode('cathode');
  } else if (mode === 'remove') {
    // Active remove button style
    removeBtn.className = 'flex-1 px-3 py-2 text-xs font-bold rounded-lg border-2 transition-all shadow-md bg-gradient-to-br from-slate-600 to-slate-700 text-white border-slate-800';
    
    // Update mode indicator
    if (modeIndicator) {
      modeIndicator.textContent = 'REMOVE MODE';
      modeIndicator.className = 'px-2 py-0.5 rounded text-xs font-bold bg-slate-600 text-white';
    }
    
    // Add cursor indicator to brain diagram
    updateBrainCursorMode('remove');
  }
  
  // Log mode change for debugging
  console.log(`🔄 Electrode mode changed to: ${mode.toUpperCase()}`);
}

// Update brain diagram cursor to reflect active mode
function updateBrainCursorMode(mode) {
  const svg = document.getElementById('brainLayoutTopView');
  if (!svg) return;
  
  // Add data attribute to track mode
  svg.setAttribute('data-active-mode', mode);
  
  // Update cursor style based on mode
  const electrodes = document.querySelectorAll('.electrode circle');
  electrodes.forEach(circle => {
    if (mode === 'anode') {
      circle.style.cursor = 'crosshair'; // Different cursor for anode mode
    } else if (mode === 'remove') {
      circle.style.cursor = 'not-allowed'; // Remove cursor
    } else {
      circle.style.cursor = 'pointer'; // Default cursor for cathode mode
    }
  });
}

// Enable electrode customization via click on electrodes
function enableCathodeCustomization() {
  // Show electrode mode selector for doctors
  const modeSelector = document.getElementById('electrodeModeSelector');
  if (modeSelector) {
    modeSelector.classList.remove('hidden');
    // Do NOT set a default mode - force doctor to explicitly choose
    // This prevents accidental cathode assignments
    currentElectrodeMode = null;
    
    // Set neutral button states
    const anodeBtn = document.getElementById('selectAnodeMode');
    const cathodeBtn = document.getElementById('selectCathodeMode');
    const removeBtn = document.getElementById('selectRemoveMode');
    const modeIndicator = document.getElementById('activeModeIndicator');
    
    if (anodeBtn) {
      anodeBtn.className = 'flex-1 px-3 py-2 text-xs font-bold rounded-lg border-2 transition-all shadow-sm hover:shadow-md bg-white text-red-700 border-red-300 hover:border-red-400';
    }
    if (cathodeBtn) {
      cathodeBtn.className = 'flex-1 px-3 py-2 text-xs font-bold rounded-lg border-2 transition-all shadow-sm hover:shadow-md bg-white text-blue-700 border-blue-300 hover:border-blue-400';
    }
    if (removeBtn) {
      removeBtn.className = 'flex-1 px-3 py-2 text-xs font-bold rounded-lg border-2 transition-all shadow-sm hover:shadow-md bg-white text-slate-700 border-slate-300 hover:border-slate-400';
    }
    if (modeIndicator) {
      modeIndicator.textContent = 'SELECT MODE';
      modeIndicator.className = 'px-2 py-0.5 rounded text-xs font-bold bg-gray-400 text-white animate-pulse';
    }
  }
  const electrodes = document.querySelectorAll('.electrode');
  
  electrodes.forEach(el => {
    const circle = el.querySelector('circle');
    if (circle) {
      // Make cursor pointer to indicate clickable
      circle.style.cursor = 'pointer';
      
      // Add click handler
      circle.addEventListener('click', function(e) {
        e.stopPropagation();
        const electrodeId = el.id.replace('-electrode', '').toUpperCase();
        toggleElectrodeSelection(electrodeId, el);
      });
      
      // Add hover effect
      circle.addEventListener('mouseenter', function() {
        if (currentRole === 'doctor' || currentRole === 'admin') {
          circle.style.opacity = '0.7';
        }
      });
      
      circle.addEventListener('mouseleave', function() {
        circle.style.opacity = '1';
      });
    }
  });
}

// Toggle electrode selection (anode or cathode)
function toggleElectrodeSelection(electrodeId, electrodeElement) {
  // Debounce rapid clicks to prevent performance issues
  const currentTime = Date.now();
  if (currentTime - lastElectrodeClickTime < 150) {
    return; // Ignore clicks within 150ms
  }
  lastElectrodeClickTime = currentTime;
  
  // Safety check: Ensure mode is selected
  if (!currentElectrodeMode) {
    // Clear any existing notification timeout
    if (notificationTimeout) {
      clearTimeout(notificationTimeout);
    }
    showNotification('⚠️ Please select Anode or Cathode mode first', 'error');
    
    // Highlight the mode selector
    const modeSelector = document.getElementById('electrodeModeSelector');
    if (modeSelector) {
      modeSelector.style.animation = 'pulse 0.5s ease-in-out 3';
      setTimeout(() => {
        modeSelector.style.animation = '';
      }, 1500);
    }
    return;
  }
  
  // Initialize custom config if not exists
  if (!customMontageConfig) {
    const selection = document.getElementById('clinicalIndicationSelect')?.value;
    const customStored = getCustomMontage(selection);
    const montageConfigs = getMontageConfigs();
    
    if (customStored) {
      customMontageConfig = JSON.parse(JSON.stringify(customStored));
    } else {
      customMontageConfig = JSON.parse(JSON.stringify(montageConfigs[selection] || {}));
    }
    
    // Ensure arrays exist
    if (!customMontageConfig.anodes) customMontageConfig.anodes = [];
    if (!customMontageConfig.cathodes) customMontageConfig.cathodes = [];
  }
  
  let actionTaken = '';
  let showSuccessNotification = false;
  
  if (currentElectrodeMode === 'remove') {
    // Handle removal of electrode
    const anodeIndex = customMontageConfig.anodes?.indexOf(electrodeId);
    const cathodeIndex = customMontageConfig.cathodes?.indexOf(electrodeId);
    
    if (anodeIndex > -1) {
      customMontageConfig.anodes.splice(anodeIndex, 1);
      document.getElementById('anodePlacement').value = customMontageConfig.anodes.join(', ');
      actionTaken = `Removed ${electrodeId} from anodes`;
      showSuccessNotification = true;
    } else if (cathodeIndex > -1) {
      customMontageConfig.cathodes.splice(cathodeIndex, 1);
      document.getElementById('cathodePlacement').value = customMontageConfig.cathodes.join(', ');
      actionTaken = `Removed ${electrodeId} from cathodes`;
      showSuccessNotification = true;
    } else {
      return; // Electrode wasn't selected, no action needed
    }
  } else if (currentElectrodeMode === 'cathode') {
    // Handle cathode selection
    const cathodeIndex = customMontageConfig.cathodes?.indexOf(electrodeId);
    
    if (cathodeIndex > -1) {
      // Deselect: Remove from cathodes
      customMontageConfig.cathodes.splice(cathodeIndex, 1);
      actionTaken = `Removed ${electrodeId} cathode`;
    } else {
      // Check limit: Maximum 1 cathode allowed
      if (customMontageConfig.cathodes.length >= 1) {
        showNotification('Maximum 1 cathode allowed', 'error', 2000);
        return;
      }
      
      // Remove from anodes if present (prevent conflict)
      const anodeIndex = customMontageConfig.anodes?.indexOf(electrodeId);
      if (anodeIndex > -1) {
        customMontageConfig.anodes.splice(anodeIndex, 1);
        document.getElementById('anodePlacement').value = customMontageConfig.anodes.join(', ');
      }
      
      customMontageConfig.cathodes.push(electrodeId);
      actionTaken = `Added ${electrodeId} as cathode`;
      showSuccessNotification = true;
    }
    
    // Update cathode placement text field
    document.getElementById('cathodePlacement').value = customMontageConfig.cathodes.join(', ');
  } else if (currentElectrodeMode === 'anode') {
    // Handle anode selection
    const anodeIndex = customMontageConfig.anodes?.indexOf(electrodeId);
    
    if (anodeIndex > -1) {
      // Deselect: Remove from anodes
      customMontageConfig.anodes.splice(anodeIndex, 1);
      actionTaken = `Removed ${electrodeId} anode`;
    } else {
      // Check limit: Maximum 2 anodes allowed
      if (customMontageConfig.anodes.length >= 2) {
        showNotification('Maximum 2 anodes allowed', 'error', 2000);
        return;
      }
      
      // Remove from cathodes if present (prevent conflict)
      const cathodeIndex = customMontageConfig.cathodes?.indexOf(electrodeId);
      if (cathodeIndex > -1) {
        customMontageConfig.cathodes.splice(cathodeIndex, 1);
        document.getElementById('cathodePlacement').value = customMontageConfig.cathodes.join(', ');
      }
      
      customMontageConfig.anodes.push(electrodeId);
      actionTaken = `Added ${electrodeId} as anode`;
      showSuccessNotification = true;
    }
    
    // Update anode placement text field
    document.getElementById('anodePlacement').value = customMontageConfig.anodes.join(', ');
  }
  
  // Optimized: Only update visualization if there was a change
  if (actionTaken) {
    // Batch DOM updates using requestAnimationFrame for better performance
    requestAnimationFrame(() => {
      updateBrainVisualization(customMontageConfig);
      addElectrodeClickFeedback(electrodeElement, currentElectrodeMode);
    });
    
    // Mark as having unsaved changes
    hasUnsavedChanges = true;
    updateUnsavedChangesIndicator();
    showSaveButton();
  }
}

// Remove the last selected electrode of a specific type
function removeLastElectrode(type) {
  if (!customMontageConfig) {
    showNotification('No electrodes to remove', 'info');
    return;
  }
  
  let removed = false;
  let electrodeId = '';
  
  if (type === 'anode') {
    if (customMontageConfig.anodes && customMontageConfig.anodes.length > 0) {
      electrodeId = customMontageConfig.anodes.pop();
      document.getElementById('anodePlacement').value = customMontageConfig.anodes.join(', ');
      removed = true;
    }
  } else if (type === 'cathode') {
    if (customMontageConfig.cathodes && customMontageConfig.cathodes.length > 0) {
      electrodeId = customMontageConfig.cathodes.pop();
      document.getElementById('cathodePlacement').value = customMontageConfig.cathodes.join(', ');
      removed = true;
    }
  }
  
  if (removed) {
    // Update visualization
    updateBrainVisualization(customMontageConfig);
    
    // Mark as having unsaved changes
    hasUnsavedChanges = true;
    
    // Show notification
    showNotification(`Removed ${electrodeId} from ${type.toUpperCase()}S`, 'success');
    
    // Update unsaved changes indicator
    updateUnsavedChangesIndicator();
    
    // Show save button
    showSaveButton();
  } else {
    showNotification(`No ${type}s to remove`, 'info');
  }
}

// Reset all electrode selections
function resetAllElectrodes() {
  if (!confirm('Clear all electrode selections? This will remove all anodes and cathodes.')) {
    return;
  }
  
  if (customMontageConfig) {
    customMontageConfig.anodes = [];
    customMontageConfig.cathodes = [];
    
    // Update fields
    document.getElementById('anodePlacement').value = '';
    document.getElementById('cathodePlacement').value = '';
    
    // Update visualization
    updateBrainVisualization(customMontageConfig);
    
    // Reset unsaved changes flag
    hasUnsavedChanges = false;
    
    showNotification('All electrode selections cleared', 'info');
  }
}

// Add visual feedback when electrode is clicked
function addElectrodeClickFeedback(electrodeElement, mode) {
  if (!electrodeElement) return;
  
  const circle = electrodeElement.querySelector('circle');
  if (!circle) return;
  
  // Clean up any existing feedback animations to prevent DOM buildup
  const existingAnimations = circle.getAnimations();
  existingAnimations.forEach(animation => animation.cancel());
  
  // Remove any lingering ripple effects
  const existingRipples = electrodeElement.querySelectorAll('circle:not(:first-child)');
  existingRipples.forEach(ripple => ripple.remove());
  
  // Store original properties
  const originalStroke = circle.getAttribute('stroke') || '#374151';
  const originalStrokeWidth = circle.getAttribute('stroke-width') || '2';
  const originalFilter = circle.style.filter || '';
  
  // Determine feedback color based on mode
  const feedbackColor = mode === 'anode' ? '#f59e0b' : 
                       mode === 'cathode' ? '#3b82f6' : '#6b7280';
  
  // Apply immediate visual feedback
  circle.setAttribute('stroke', feedbackColor);
  circle.setAttribute('stroke-width', '3');
  circle.style.filter = `drop-shadow(0 0 4px ${feedbackColor}60)`;
  
  // Use CSS animation for better performance instead of DOM manipulation
  circle.style.animation = 'electrode-pulse 0.3s ease-out';
  
  // Reset properties after feedback animation - reduced timeout for snappier response
  setTimeout(() => {
    if (circle.parentNode) { // Check if element still exists
      circle.setAttribute('stroke', originalStroke);
      circle.setAttribute('stroke-width', originalStrokeWidth);
      circle.style.filter = originalFilter;
      circle.style.animation = '';
    }
  }, 300);
}

// Show/update unsaved changes indicator
function updateUnsavedChangesIndicator() {
  const indicator = document.getElementById('unsavedChangesIndicator');
  if (indicator) {
    if (hasUnsavedChanges) {
      indicator.classList.remove('hidden');
    } else {
      indicator.classList.add('hidden');
    }
  }
}

// Show save button when changes are made
function showSaveButton() {
  const saveSection = document.getElementById('saveCustomMontageSection');
  if (saveSection && hasUnsavedChanges) {
    saveSection.classList.remove('hidden');
  }
}

// Hide save button
function hideSaveButton() {
  const saveSection = document.getElementById('saveCustomMontageSection');
  if (saveSection) {
    saveSection.classList.add('hidden');
  }
}

// Show save changes popup
function showSaveChangesPopup() {
  // Check if there are actually changes to save
  if (!hasUnsavedChanges) {
    showNotification('No changes to save', 'info');
    return;
  }
  
  // Validate that we have at least one electrode selected
  if (!customMontageConfig || 
      (!customMontageConfig.anodes?.length && !customMontageConfig.cathodes?.length)) {
    showNotification('Please select at least one electrode before saving', 'error');
    return;
  }
  
  // Remove existing popup if any
  const existingPopup = document.getElementById('saveChangesPopup');
  if (existingPopup) {
    existingPopup.remove();
  }
  
  // Create popup
  const popup = document.createElement('div');
  popup.id = 'saveChangesPopup';
  popup.className = 'modal';
  popup.innerHTML = `
    <div class="modal-content" style="max-width: 500px;">
      <div class="p-6">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center">
            <i class="fa-solid fa-save text-orange-600 text-xl"></i>
          </div>
          <div>
            <h3 class="text-lg font-bold text-slate-900">Save as New Montage</h3>
            <p class="text-sm text-slate-600">Create a custom montage configuration</p>
          </div>
        </div>
        
        <div class="mb-4">
          <label class="text-sm font-semibold text-slate-700 block mb-2">
            <i class="fa-solid fa-tag mr-1"></i>Montage Name *
          </label>
          <input type="text" id="newMontageName" class="input-royal w-full" placeholder="e.g., Custom DLPFC Protocol" />
          <p class="text-xs text-slate-500 mt-1">This will be saved as a new custom montage</p>
        </div>
        
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
          <p class="text-sm text-blue-800 mb-2">
            <i class="fa-solid fa-info-circle mr-1"></i>
            <strong>Configuration:</strong>
          </p>
          <div class="text-xs text-blue-900 space-y-1">
            <div><strong class="text-orange-700">Device:</strong> <span id="popupDeviceInfo"></span></div>
            <div><strong class="text-red-700">Anode(s):</strong> <span id="popupAnodeList"></span></div>
            <div><strong class="text-blue-700">Cathode(s):</strong> <span id="popupCathodeList"></span></div>
          </div>
        </div>
        
        <div class="bg-amber-50 border border-amber-300 rounded-lg p-3 mb-4">
          <p class="text-xs text-amber-800">
            <i class="fa-solid fa-info-circle mr-1"></i>
            <strong>Note:</strong> The original montage will remain unchanged. This creates a new custom configuration.
          </p>
        </div>
        
        <div class="flex gap-3 justify-end">
          <button onclick="cancelMontageChanges()" class="btn-secondary px-4 py-2">
            <i class="fa-solid fa-times mr-2"></i>Cancel
          </button>
          <button onclick="saveNewMontage()" class="btn-primary px-4 py-2">
            <i class="fa-solid fa-check mr-2"></i>Save as New
          </button>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(popup);
  
  // Get selected device info
  const deviceSelect = document.getElementById('deviceSelect');
  const selectedDevice = deviceSelect ? deviceSelect.value : '';
  const deviceText = selectedDevice ? 
    (deviceSelect.options[deviceSelect.selectedIndex]?.text || selectedDevice) : 
    'None selected';
  
  // Update electrode lists and device info in popup
  if (document.getElementById('popupDeviceInfo')) {
    document.getElementById('popupDeviceInfo').textContent = deviceText;
  }
  if (customMontageConfig?.anodes) {
    document.getElementById('popupAnodeList').textContent = customMontageConfig.anodes.join(', ') || 'None';
  }
  if (customMontageConfig?.cathodes) {
    document.getElementById('popupCathodeList').textContent = customMontageConfig.cathodes.join(', ') || 'None';
  }
}

// Save as new montage
function saveNewMontage() {
  if (!customMontageConfig) return;
  
  // Get montage name
  const montageName = document.getElementById('newMontageName')?.value?.trim();
  
  if (!montageName) {
    showNotification('Please enter a montage name', 'error');
    return;
  }
  
  // Get current clinical indication as base reference
  const selection = document.getElementById('clinicalIndicationSelect')?.value;
  const montageConfigs = getMontageConfigs();
  const baseConfig = montageConfigs[selection];
  
  // Get selected device from dropdown
  const deviceSelect = document.getElementById('deviceSelect');
  const selectedDevice = deviceSelect ? deviceSelect.value : '';
  
  // Create new montage object
  const newMontage = {
    ...customMontageConfig,
    name: montageName,
    basedOn: selection,
    baseCategory: baseConfig?.category || '',
    baseNetworkTarget: baseConfig?.networkTarget || '',
    selectedDevice: selectedDevice, // Save the selected device
    recommendedDevice: selectedDevice, // Also save as recommended for this montage
    timestamp: new Date().toISOString(),
    createdBy: currentRole,
    isCustom: true
  };
  
  // Generate unique ID for the montage
  const montageId = 'custom_' + Date.now();
  
  // Save to local storage
  const saved = saveCustomMontageToStorage(montageId, newMontage);
  if (!saved) {
    showNotification('Failed to save custom montage', 'error');
    return;
  }
  
  // Update the placement fields
  document.getElementById('anodePlacement').value = customMontageConfig.anodes?.join(', ') || '';
  document.getElementById('cathodePlacement').value = customMontageConfig.cathodes?.join(', ') || '';
  
  // Mark as saved
  hasUnsavedChanges = false;
  updateUnsavedChangesIndicator();
  hideSaveButton();
  
  // Close popup
  const popup = document.getElementById('saveChangesPopup');
  if (popup) popup.remove();
  
  // Show success notification with more details
  showNotification(`✓ Custom montage "${montageName}" saved successfully!`, 'success', 4000);
  
  // Add to dropdown
  populateCustomMontagesDropdown();
  
  // Set the dropdown to the newly created montage
  const clinicalSelect = document.getElementById('clinicalIndicationSelect');
  if (clinicalSelect) {
    clinicalSelect.value = montageId;
  }
  
  // Show delete button for the loaded custom montage
  showDeleteButton(montageId);
}

// Show delete button for custom montages
function showDeleteButton(montageId) {
  let deleteBtn = document.getElementById('deleteCustomMontageBtn');
  if (!deleteBtn) {
    // Create delete button if it doesn't exist
    deleteBtn = document.createElement('button');
    deleteBtn.id = 'deleteCustomMontageBtn';
    deleteBtn.className = 'px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors mt-2';
    deleteBtn.innerHTML = '<i class="fas fa-trash mr-2"></i>Delete Custom Montage';
    
    // Find a good place to insert the button (after montage category field)
    const categoryField = document.getElementById('montageCategory');
    if (categoryField && categoryField.parentNode) {
      categoryField.parentNode.insertAdjacentElement('afterend', deleteBtn);
    }
  }
  
  deleteBtn.style.display = 'block';
  deleteBtn.onclick = () => deleteCustomMontage(montageId);
}

// Delete a custom montage for a specific device
function deleteCustomMontageForDevice(deviceIndex) {
  const select = document.getElementById(`customMontageSelect_${deviceIndex}`);
  if (!select || !select.value) {
    showNotification('Please select a custom montage to delete', 'error');
    return;
  }
  
  const montageId = select.value;
  const montage = customMontagesLibrary.find(m => m.id === montageId);
  
  if (!montage) {
    showNotification('Montage not found', 'error');
    return;
  }
  
  if (!confirm(`Are you sure you want to delete "${montage.name}"? This action cannot be undone.`)) {
    return;
  }
  
  // Remove from library
  customMontagesLibrary = customMontagesLibrary.filter(m => m.id !== montageId);
  
  try {
    localStorage.setItem(CUSTOM_MONTAGES_KEY, JSON.stringify(customMontagesLibrary));
    showNotification(`Deleted custom montage "${montage.name}"`, 'success');
    
    // Reset the dropdown
    select.value = '';
    
    // Hide delete button
    const deleteBtn = document.getElementById(`deleteCustomMontageBtn_${deviceIndex}`);
    if (deleteBtn) deleteBtn.classList.add('hidden');
    
    // Update all device dropdowns
    populateCustomMontagesForAllDevices();
    
  } catch (e) {
    console.error('Failed to delete montage:', e);
    showNotification('Failed to delete montage', 'error');
  }
}

// Legacy delete function
function deleteCustomMontage(montageId) {
  const montage = customMontagesLibrary.find(m => m.id === montageId);
  if (!montage) {
    showNotification('Montage not found', 'error');
    return;
  }
  
  if (!confirm(`Are you sure you want to delete "${montage.name}"? This action cannot be undone.`)) {
    return;
  }
  
  // Remove from library
  customMontagesLibrary = customMontagesLibrary.filter(m => m.id !== montageId);
  
  try {
    localStorage.setItem(CUSTOM_MONTAGES_KEY, JSON.stringify(customMontagesLibrary));
    showNotification(`Deleted custom montage "${montage.name}"`, 'success');
    
    // Update all dropdowns
    populateCustomMontagesForAllDevices();
    populateCustomMontagesDropdown();
    
  } catch (e) {
    console.error('Failed to delete montage:', e);
    showNotification('Failed to delete montage', 'error');
  }
  
  // Update active montage info
  const activeAnodes = document.getElementById('activeAnodes');
  const activeCathodes = document.getElementById('activeCathodes');
  
  if (activeAnodes) {
    activeAnodes.textContent = customMontageConfig.anodes?.join(', ') || 'None';
  }
  if (activeCathodes) {
    if (customMontageConfig.extracephalic && customMontageConfig.cathodes?.length === 0) {
      activeCathodes.textContent = 'Shoulder/Torso (extracephalic)';
    } else {
      activeCathodes.textContent = customMontageConfig.cathodes?.join(', ') || 'None';
    }
  }
  
  // Refresh custom montage list
  loadCustomMontagesList();
}

// Cancel montage changes
function cancelMontageChanges() {
  // Revert to original base configuration (not custom)
  const selection = document.getElementById('clinicalIndicationSelect')?.value;
  if (selection) {
    const montageConfigs = getMontageConfigs();
    const originalConfig = montageConfigs[selection];
    
    if (originalConfig) {
      updateBrainVisualization(originalConfig);
      document.getElementById('anodePlacement').value = originalConfig.anodePlacement || originalConfig.anodes?.join(', ') || '';
      document.getElementById('cathodePlacement').value = originalConfig.cathodePlacement || originalConfig.cathodes?.join(', ') || '';
    }
  }
  
  // Reset custom config
  customMontageConfig = null;
  hasUnsavedChanges = false;
  updateUnsavedChangesIndicator();
  hideSaveButton();
  
  // Close popup
  const popup = document.getElementById('saveChangesPopup');
  if (popup) popup.remove();
}

// Helper function to show notification
function showNotification(message, type = 'info', duration = 3000) {
  // Prevent notification spam by clearing existing notifications of the same type
  const existingNotifications = document.querySelectorAll(`[data-notification-type="${type}"]`);
  existingNotifications.forEach(notif => {
    if (notif.textContent.trim() === message.trim()) {
      notif.remove(); // Remove duplicate notifications
    }
  });
  
  // Limit total notifications to prevent UI clutter
  const allNotifications = document.querySelectorAll('[data-notification-type]');
  if (allNotifications.length >= 3) {
    allNotifications[0].remove(); // Remove oldest notification
  }
  
  const notification = document.createElement('div');
  notification.setAttribute('data-notification-type', type);
  notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg flex items-center gap-3 animate-slide-in`;
  
  const colors = {
    success: 'bg-green-100 border-green-500 text-green-900',
    error: 'bg-red-100 border-red-500 text-red-900',
    info: 'bg-blue-100 border-blue-500 text-blue-900'
  };
  
  notification.className += ` ${colors[type]} border-l-4`;
  
  const icons = {
    success: 'fa-check-circle',
    error: 'fa-exclamation-circle',
    info: 'fa-info-circle'
  };
  
  notification.innerHTML = `
    <i class="fa-solid ${icons[type]} text-xl"></i>
    <span class="font-semibold">${message}</span>
  `;
  
  // Stack notifications vertically if there are multiple
  const notificationCount = document.querySelectorAll('[data-notification-type]').length;
  notification.style.top = `${4 + (notificationCount * 70)}px`;
  
  document.body.appendChild(notification);
  
  // Auto remove after specified duration
  setTimeout(() => {
    if (notification.parentNode) {
      notification.style.opacity = '0';
      notification.style.transform = 'translateX(100%)';
      setTimeout(() => {
        if (notification.parentNode) {
          notification.remove();
        }
      }, 300);
    }
  }, duration);
}

// Populate custom montages dropdown
function populateCustomMontagesDropdown() {
  const optgroup = document.getElementById('customMontagesOptgroup');
  
  if (!optgroup) return;
  
  if (customMontagesLibrary.length === 0) {
    optgroup.style.display = 'none';
    optgroup.innerHTML = '';
    return;
  }
  
  optgroup.style.display = 'block';
  
  // Build options from array
  let html = '';
  customMontagesLibrary.forEach(montage => {
    const deviceLabel = montage.deviceType || 'Unknown';
    html += `<option value="${montage.id}">⭐ ${montage.name} (${deviceLabel})</option>`;
  });
  
  optgroup.innerHTML = html;
}

// Load and display custom montages list
function loadCustomMontagesList() {
  const customMontages = loadCustomMontages();
  const customMontagesList = document.getElementById('customMontagesList');
  const customMontagesContent = document.getElementById('customMontagesContent');
  
  if (!customMontagesList || !customMontagesContent) return;
  
  const montageKeys = Object.keys(customMontages);
  
  if (montageKeys.length === 0) {
    customMontagesList.classList.add('hidden');
    return;
  }
  
  customMontagesList.classList.remove('hidden');
  
  // Also populate dropdown
  populateCustomMontagesDropdown();
  
  // Build montages list HTML
  let html = '';
  montageKeys.forEach(key => {
    const montage = customMontages[key];
    const date = new Date(montage.timestamp).toLocaleDateString();
    html += `
      <div class="bg-white p-3 rounded-lg border border-purple-200 hover:border-purple-400 transition-all">
        <div class="flex items-start justify-between">
          <div class="flex-1">
            <h5 class="font-bold text-sm text-purple-900">${montage.name}</h5>
            <p class="text-xs text-slate-600 mt-1">
              <i class="fa-solid fa-link mr-1"></i>Based on: ${getMontageLabel(montage.basedOn)}
            </p>
            <div class="mt-2 text-xs space-y-0.5">
              <div><strong class="text-red-700">Anodes:</strong> ${montage.anodes?.join(', ') || 'None'}</div>
              <div><strong class="text-blue-700">Cathodes:</strong> ${montage.cathodes?.join(', ') || 'None'}</div>
            </div>
            <p class="text-xs text-slate-500 mt-2">
              <i class="fa-solid fa-calendar mr-1"></i>${date} · ${montage.createdBy}
            </p>
          </div>
          <div class="flex gap-1 ml-2">
            <button onclick="loadCustomMontage('${key}')" class="px-2 py-1 bg-purple-500 text-white rounded text-xs hover:bg-purple-600" title="Load this montage">
              <i class="fa-solid fa-upload"></i>
            </button>
            <button onclick="deleteCustomMontage('${key}')" class="px-2 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600" title="Delete this montage">
              <i class="fa-solid fa-trash"></i>
            </button>
          </div>
        </div>
      </div>
    `;
  });
  
  customMontagesContent.innerHTML = html;
}

// Populate custom montages dropdown
// Duplicate removed - consolidated above

// Get readable label for montage type
function getMontageLabel(key) {
  const labels = {
    'ruminative_depression': 'Ruminative Depression',
    'cognitive_depression': 'Cognitive Depression',
    'anxious_depression': 'Anxious Depression'
  };
  return labels[key] || key;
}

// Toggle custom montages list visibility
function toggleCustomMontagesList() {
  const content = document.getElementById('customMontagesContent');
  const icon = document.getElementById('customMontagesToggleIcon');
  
  if (content.classList.contains('hidden')) {
    content.classList.remove('hidden');
    icon.className = 'fa-solid fa-chevron-up';
  } else {
    content.classList.add('hidden');
    icon.className = 'fa-solid fa-chevron-down';
  }
}

// Load a custom montage for a specific device
function loadCustomMontageForDevice(deviceIndex, montageId) {
  if (!montageId) {
    // Clear selection - hide delete button
    const deleteBtn = document.getElementById(`deleteCustomMontageBtn_${deviceIndex}`);
    if (deleteBtn) deleteBtn.classList.add('hidden');
    return;
  }
  
  const montage = customMontagesLibrary.find(m => m.id === montageId);
  
  if (!montage) {
    showNotification('Custom montage not found', 'error');
    return;
  }
  
  // Apply montage to the device
  const device = treatmentPlanState.devices[deviceIndex];
  if (!device) return;
  
  // Update device montage configuration
  device.montage = {
    anodes: montage.anodes || [],
    cathode: montage.cathode || ''
  };
  device.customMontageName = montage.name;
  
  // Update the visualization
  highlightNetworkElectrodes(deviceIndex, montage.anodes || [], montage.cathode || '');
  
  // Update the network info display
  const networkInfo = document.getElementById(`networkInfo_${deviceIndex}`);
  if (networkInfo) {
    networkInfo.innerHTML = `
      <div class="text-xs">
        <p class="font-bold text-purple-900 mb-2">🌟 ${montage.name}</p>
        <div class="space-y-1">
          <div><strong class="text-red-700">Anodes:</strong> <span class="font-mono">${montage.anodes?.join(', ') || 'None'}</span></div>
          <div><strong class="text-blue-700">Cathode:</strong> <span class="font-mono">${montage.cathode || 'None'}</span></div>
          ${montage.baseNetwork ? `<div class="mt-2 text-[10px] text-slate-600">Based on: ${montage.baseNetwork}</div>` : ''}
        </div>
      </div>
    `;
  }
  
  // Update network details section
  const networkName = document.getElementById(`networkName_${deviceIndex}`);
  if (networkName) networkName.textContent = `${montage.baseNetwork || 'Custom'} (${montage.name})`;
  
  const networkAnodes = document.getElementById(`networkAnodes_${deviceIndex}`);
  if (networkAnodes) networkAnodes.textContent = montage.anodes?.join(', ') || 'None';
  
  const networkCathode = document.getElementById(`networkCathode_${deviceIndex}`);
  if (networkCathode) networkCathode.textContent = montage.cathode || 'None';
  
  // Show network details
  const networkDetails = document.getElementById(`networkDetails_${deviceIndex}`);
  if (networkDetails) networkDetails.classList.remove('hidden');
  
  // Show delete button
  const deleteBtn = document.getElementById(`deleteCustomMontageBtn_${deviceIndex}`);
  if (deleteBtn) deleteBtn.classList.remove('hidden');
  
  // Save state
  saveTreatmentPlanState();
  
  showNotification(`Loaded custom montage "${montage.name}"`, 'success');
}

// Legacy function for backward compatibility
function loadCustomMontage(montageId) {
  loadCustomMontageForDevice(treatmentPlanState.activeDeviceTab || 0, montageId);
}

// Delete a custom montage
// Duplicate removed - consolidated array-based version above
function deleteCustomMontage_OLD(montageId) {
  // This function has been replaced by the array-based version above
  return;
}

// Delete the currently selected custom montage from dropdown
function deleteSelectedCustomMontage() {
  const clinicalSelect = document.getElementById('clinicalIndicationSelect');
  if (!clinicalSelect) return;
  
  const selection = clinicalSelect.value;
  
  if (!selection || !selection.startsWith('custom_')) {
    showNotification('Please select a custom montage to delete', 'error');
    return;
  }
  
  // Use the main deleteCustomMontage function
  deleteCustomMontage(selection);
}

// Helper function to get montage configs
function getMontageConfigs() {
  return {
    ruminative_depression: {
      category: 'Montage Category 1 - Standard 1-channel',
      clinicalIndication: 'Ruminative, melancholic depression; low drive; cognitive slowing',
      networkTarget: 'CEN (Central Executive Network)',
      secondaryNetwork: '—',
      anodePlacement: 'F3 (left executive hub), F4 (right-biased affective profile), optional Fz',
      anodeOptions: 'Limbic regulation, indirect DMN disengagement',
      cathodePlacement: 'Shoulder / torso (preferred); FPz or Cz if cephalic required',
      cathodeType: 'Extracephalic preferred',
      fnonLogic: 'Strengthens top-down executive control; reduces rumination indirectly via improved network switching',
      anodes: ['F3', 'F4', 'FZ'],
      cathodes: ['FPZ', 'CZ'],
      extracephalic: true
    },
    cognitive_depression: {
      category: 'Montage Category 2 - Standard 1-channel',
      clinicalIndication: 'Cognitive depression, attentional inefficiency',
      networkTarget: 'CEN (Central Executive Network)',
      secondaryNetwork: 'DAN / parietal integration',
      anodePlacement: 'F3 / F4 / Fz',
      anodeOptions: '',
      cathodePlacement: 'P3 / P4 (integrational integration) or extracephalic',
      cathodeType: 'Cephalic or extracephalic (case-dependent)',
      fnonLogic: 'Treats depression as network inefficiency rather than mood deficit',
      anodes: ['F3', 'F4', 'FZ'],
      cathodes: ['P3', 'P4'],
      extracephalic: false
    },
    anxious_depression: {
      category: 'Montage Category 3 - Standard 1-channel',
      clinicalIndication: 'Anxious depression, hypervigilance, stress sensitivity',
      networkTarget: 'SN (Salience Network - regulatory)',
      secondaryNetwork: 'CEN stabilization',
      anodePlacement: 'FCz, FC1 / FC2',
      anodeOptions: '',
      cathodePlacement: 'Shoulder / torso preferred; Cz or FPz if cephalic',
      cathodeType: 'Extracephalic preferred',
      fnonLogic: 'Normalizes pathological salience attribution and improves switching',
      anodes: ['FCZ', 'FC1', 'FC2'],
      cathodes: ['CZ', 'FPZ'],
      extracephalic: true
    }
  };
}

// Reset brain visualization to default state
function resetBrainVisualization() {
  const electrodes = document.querySelectorAll('.electrode');
  electrodes.forEach(el => {
    const circle = el.querySelector('circle');
    const text = el.querySelector('text');
    if (circle) {
      circle.setAttribute('fill', '#e2e8f0');
      circle.setAttribute('stroke', '#64748b');
      circle.setAttribute('stroke-width', '2.5');
      circle.style.animation = '';
    }
    if (text) {
      text.setAttribute('fill', '#1e293b');
      text.setAttribute('font-weight', 'bold');
    }
  });
  
  // Hide extracephalic note
  const extracephalicNote = document.getElementById('extracephalicNote');
  if (extracephalicNote) extracephalicNote.classList.add('hidden');
  
  // Reset active info
  const activeAnodes = document.getElementById('activeAnodes');
  const activeCathodes = document.getElementById('activeCathodes');
  const activeNetwork = document.getElementById('activeNetwork');
  
  if (activeAnodes) activeAnodes.textContent = 'Not selected';
  if (activeCathodes) activeCathodes.textContent = 'Not selected';
  if (activeNetwork) activeNetwork.textContent = '—';
}

// Add SVG gradients for electrode highlighting
function addSVGGradients() {
  const svg = document.getElementById('brainLayoutTopView');
  if (!svg) return;
  
  // Check if gradients already exist
  if (document.getElementById('anodeGradient')) return;
  
  // Create defs element
  const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
  
  // Anode gradient (red to orange)
  const anodeGradient = document.createElementNS('http://www.w3.org/2000/svg', 'radialGradient');
  anodeGradient.setAttribute('id', 'anodeGradient');
  anodeGradient.innerHTML = `
    <stop offset="0%" style="stop-color:#f87171;stop-opacity:1" />
    <stop offset="100%" style="stop-color:#ea580c;stop-opacity:1" />
  `;
  
  // Cathode gradient (blue to cyan)
  const cathodeGradient = document.createElementNS('http://www.w3.org/2000/svg', 'radialGradient');
  cathodeGradient.setAttribute('id', 'cathodeGradient');
  cathodeGradient.innerHTML = `
    <stop offset="0%" style="stop-color:#60a5fa;stop-opacity:1" />
    <stop offset="100%" style="stop-color:#2563eb;stop-opacity:1" />
  `;
  
  defs.appendChild(anodeGradient);
  defs.appendChild(cathodeGradient);
  svg.insertBefore(defs, svg.firstChild);
}



// -- PATIENT PORTAL TREATMENT PLAN --
function renderPatientTreatmentPlan() {
  // Separate patient-specific function with same structure and same data sources
  const area = document.getElementById('contentArea');
  
  // For patient role, auto-select their own patient context
  if(currentRole === 'patient' && !globalSelectedPatientId) {
    const ap = getActivePatient();
    if(ap?.id) globalSelectedPatientId = ap.id;
  }
  
  // Auto-populate patient details if globalSelectedPatientId is set
  if(globalSelectedPatientId && !globalState.currentPatient) {
    const selectedPatient = sampleData.patients.find(p => p.id === globalSelectedPatientId);
    if(selectedPatient) {
      globalState.currentPatient = selectedPatient;
    }
  }
  
  // SAME DATA SOURCE as doctor version
  const p = globalState.currentPatient || getActivePatient();
  if (!p) {
    area.innerHTML = `
      <div class="p-8">
        <div class="bg-slate-50 border border-slate-300 rounded-lg p-6">
          <p class="text-slate-700 font-bold">No patient selected</p>
          <p class="text-sm text-slate-700 mt-2">Please select a patient to view their treatment plan.</p>
        </div>
      </div>
    `;
    return;
  }
  
  // Get disease-specific treatment protocol for patient
  const patientCondition = p.condition || 'Depression';
  const diseaseProtocol = getPatientDiseaseProtocol(patientCondition);
  
  // Sample treatment data for patients (pre-filled by doctor with disease-specific protocols)
  const treatmentData = {
    session1: {
      number: '1-10',
      protocol: diseaseProtocol.primary.name || 'High Beta Training',
      duration: '20 minutes',
      frequency: '5x per week',
      notes: diseaseProtocol.primary.description || 'Focus on attention and cognitive performance improvement',
      targetArea: diseaseProtocol.primary.anodes?.join(', ') || 'Left DLPFC',
      modality: 'tDCS',
      intensity: '2mA',
      outcome: 'Improved attention, focus, and executive function. Reduction in cognitive fatigue and enhancement of working memory.'
    },
    session2: {
      number: '11-20',
      protocol: diseaseProtocol.secondary.name || 'Alpha/Theta Training',
      duration: '20 minutes',
      frequency: '3x per week',
      notes: diseaseProtocol.secondary.description || 'Relaxation and stress reduction protocol',
      targetArea: diseaseProtocol.secondary.anodes?.join(', ') || 'Right PFC',
      modality: 'Neurofeedback',
      intensity: 'Low-Medium',
      outcome: 'Stress reduction, improved emotional regulation, enhanced relaxation response, and better sleep quality.'
    },
    sessions: {
      count: 20,
      pricePerSession: '€100',
      multiplier: 20
    },
    suggestedDevice: {
      name: 'tDCS',
      price: '€1200',
      sessions: '15 sessions'
    },
    suggestedDevice2: {
      name: 'CES Device',
      description: 'Cranial Electrotherapy Stimulation',
      price: '€900',
      sessions: '12 sessions'
    },
    medications: `1. Medication: Low-dose Escitalopram 5mg
   Dosage: Once daily in the morning
   Duration: 12 weeks (to be reviewed)
   Instructions: Take with food. May be used in conjunction with neuromodulation therapy.

2. Supplement: Omega-3 Fatty Acids 1000mg
   Dosage: Twice daily with meals
   Duration: Ongoing
   Instructions: Supports brain health and complements treatment protocol.

Note: All medications to be taken as prescribed. Report any side effects to your healthcare provider immediately.`
  };
  
  // SAME HTML STRUCTURE as doctor version (renderTreatmentPlan)
  area.innerHTML = `
    <div class="p-8">
    
    ${getAssessmentNavigation('treatmentplan')}
    
    <div class="mb-6 flex items-center justify-between">
      <div>
        <h2 class="text-2xl font-bold text-slate-800">Treatment Plan</h2>
        <p class="text-slate-500">Neuromodulation Treatment Planning & Documentation</p>
      </div>
      ${currentRole !== 'patient' ? `
      <div class="flex items-center gap-3">
        <div class="relative">
          <select id="patientNavigationSelectTreatment" class="input-royal pr-10 font-bold text-slate-900 bg-white border-2 border-orange-300">
            <option value="">Select Patient...</option>
            ${sampleData.patients.map(patient => `
              <option value="${patient.id}" ${globalState.currentPatient?.id === patient.id ? 'selected' : ''}>
                ${patient.name} (${patient.id})
              </option>
            `).join('')}
          </select>
          <i class="fa-solid fa-user-group absolute right-3 top-3 text-orange-600 pointer-events-none"></i>
        </div>
        <button onclick="loadSection('patienthistory')" class="btn-secondary text-sm" title="Back to Patient History">
          <i class="fa-solid fa-arrow-left mr-2"></i>Patient View
        </button>
      </div>
      ` : ''}
    </div>

    ${globalState.currentPatient && currentRole !== 'patient' ? `
    <!-- Auto-populated Patient Context -->
    <div class="card p-6 mb-8 border-l-4 border-l-orange-600 bg-gradient-to-r from-orange-50 to-slate-50">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-bold text-orange-900"><i class="fa-solid fa-user-circle mr-2"></i>Patient: ${p.name}</h3>
        <span class="badge badge-sozo">ID: ${p.id}</span>
      </div>
      <div class="grid grid-cols-3 gap-4 text-sm">
        <div><span class="font-bold text-slate-700">Age:</span> <span class="text-slate-900">${p.age}</span></div>
        <div><span class="font-bold text-slate-700">Gender:</span> <span class="text-slate-900">${p.gender}</span></div>
        <div><span class="font-bold text-slate-700">Status:</span> <span class="badge badge-info">${p.status || 'Active'}</span></div>
      </div>
    </div>
    ` : ''}

    <!-- Treatment Plan Content -->
    <div class="card p-8">
      
      <!-- Patient Info -->
      <div class="mb-6">
        <label class="text-sm font-bold text-slate-800 block mb-2">Patient's Name & Date</label>
        <div class="grid grid-cols-2 gap-4">
          <input type="text" id="treatmentPatientName" class="input-royal" placeholder="Patient Name" value="${p.name}" ${currentRole === 'patient' ? 'readonly' : ''} />
          <input type="date" id="treatmentDate" class="input-royal" value="${new Date().toISOString().split('T')[0]}" ${currentRole === 'patient' ? 'readonly' : ''} />
        </div>
      </div>

      <!-- Treatment Sessions - First Row (PATIENT PORTAL: Pre-filled from doctor's plan) -->
      ${currentRole !== 'patient' ? `
      <div class="mb-6 bg-slate-50 p-6 rounded-lg border border-slate-200">
        <h3 class="text-lg font-bold text-slate-900 mb-4 border-b-2 border-sozo-600 pb-2">Treatment Session 1</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Brain Diagram 1 with Fields -->
          <div>
            <div class="mb-3">
              <svg viewBox="0 0 200 200" class="w-48 h-48 mx-auto mb-3">
                <!-- Brain mapping diagram -->
                <circle cx="100" cy="100" r="80" fill="none" stroke="#cbd5e1" stroke-width="2"/>
                <!-- Top markers -->
                <circle cx="100" cy="30" r="5" fill="none" stroke="#cbd5e1" stroke-width="1.5"/>
                <text x="100" y="20" text-anchor="middle" font-size="10" fill="#64748b">NASION</text>
                <!-- Row 1 -->
                <circle cx="70" cy="50" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="70" y="54" text-anchor="middle" font-size="8" fill="#64748b">FP1</text>
                <circle cx="100" cy="50" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="100" y="54" text-anchor="middle" font-size="8" fill="#64748b">FPZ</text>
                <circle cx="130" cy="50" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="130" y="54" text-anchor="middle" font-size="8" fill="#64748b">FP2</text>
                <!-- Row 2 -->
                <circle cx="50" cy="75" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="50" y="79" text-anchor="middle" font-size="8" fill="#64748b">F7</text>
                <circle cx="75" cy="75" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="75" y="79" text-anchor="middle" font-size="8" fill="#64748b">F3</text>
                <circle cx="100" cy="75" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="100" y="79" text-anchor="middle" font-size="8" fill="#64748b">FZ</text>
                <circle cx="125" cy="75" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="125" y="79" text-anchor="middle" font-size="8" fill="#64748b">F4</text>
                <circle cx="150" cy="75" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="150" y="79" text-anchor="middle" font-size="8" fill="#64748b">F8</text>
                <!-- Center row -->
                <circle cx="30" cy="100" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="30" y="104" text-anchor="middle" font-size="8" fill="#64748b">T3</text>
                <circle cx="65" cy="100" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="65" y="104" text-anchor="middle" font-size="8" fill="#64748b">C3</text>
                <circle cx="100" cy="100" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="100" y="104" text-anchor="middle" font-size="8" fill="#64748b">CZ</text>
                <circle cx="135" cy="100" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="135" y="104" text-anchor="middle" font-size="8" fill="#64748b">C4</text>
                <circle cx="170" cy="100" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="170" y="104" text-anchor="middle" font-size="8" fill="#64748b">T4</text>
                <!-- Row 4 -->
                <circle cx="50" cy="125" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="50" y="129" text-anchor="middle" font-size="8" fill="#64748b">T5</text>
                <circle cx="75" cy="125" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="75" y="129" text-anchor="middle" font-size="8" fill="#64748b">P3</text>
                <circle cx="100" cy="125" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="100" y="129" text-anchor="middle" font-size="8" fill="#64748b">PZ</text>
                <circle cx="125" cy="125" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="125" y="129" text-anchor="middle" font-size="8" fill="#64748b">P4</text>
                <circle cx="150" cy="125" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="150" y="129" text-anchor="middle" font-size="8" fill="#64748b">T6</text>
                <!-- Bottom row -->
                <circle cx="85" cy="150" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="85" y="154" text-anchor="middle" font-size="8" fill="#64748b">O1</text>
                <circle cx="100" cy="155" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="100" y="159" text-anchor="middle" font-size="8" fill="#64748b">OZ</text>
                <circle cx="115" cy="150" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="115" y="154" text-anchor="middle" font-size="8" fill="#64748b">O2</text>
                <!-- Bottom marker -->
                <circle cx="100" cy="170" r="5" fill="none" stroke="#cbd5e1" stroke-width="1.5"/>
                <text x="100" y="185" text-anchor="middle" font-size="10" fill="#64748b">INION</text>
              </svg>
            </div>
            <div class="space-y-2">
              <div class="flex items-center gap-2">
                <span class="w-32 text-xs font-semibold text-slate-700">Session #:</span>
                <input type="text" id="session1Number" class="input-royal flex-1 text-sm" placeholder="e.g., 1-10" value="${currentRole === 'patient' ? treatmentData.session1.number : ''}" ${currentRole === 'patient' ? 'readonly' : ''} />
              </div>
              <div class="flex items-center gap-2">
                <span class="w-32 text-xs font-semibold text-slate-700">Protocol:</span>
                <input type="text" id="session1Protocol" class="input-royal flex-1 text-sm" placeholder="e.g., High Beta" value="${currentRole === 'patient' ? treatmentData.session1.protocol : ''}" ${currentRole === 'patient' ? 'readonly' : ''} />
              </div>
              <div class="flex items-center gap-2">
                <span class="w-32 text-xs font-semibold text-slate-700">Duration:</span>
                <input type="text" id="session1Duration" class="input-royal flex-1 text-sm" placeholder="e.g., 20 min" value="${currentRole === 'patient' ? treatmentData.session1.duration : ''}" ${currentRole === 'patient' ? 'readonly' : ''} />
              </div>
              <div class="flex items-center gap-2">
                <span class="w-32 text-xs font-semibold text-slate-700">Frequency:</span>
                <input type="text" id="session1Frequency" class="input-royal flex-1 text-sm" placeholder="e.g., 5x/week" value="${currentRole === 'patient' ? treatmentData.session1.frequency : ''}" ${currentRole === 'patient' ? 'readonly' : ''} />
              </div>
              <div class="flex items-center gap-2">
                <span class="w-32 text-xs font-semibold text-slate-700">Notes:</span>
                <textarea id="session1Notes" class="input-royal flex-1 text-sm" rows="2" placeholder="Additional notes..." ${currentRole === 'patient' ? 'readonly' : ''}>${currentRole === 'patient' ? treatmentData.session1.notes : ''}</textarea>
              </div>
            </div>
          </div>

          <!-- Head Profile with Fields -->
          <div>
            <div class="mb-3">
              <svg viewBox="0 0 120 200" class="w-32 h-48 mx-auto mb-3">
                <!-- Head profile outline -->
                <path d="M 60 30 Q 90 30 90 60 L 90 120 Q 90 140 70 155 L 60 160 L 60 175 Q 75 175 75 185" 
                      fill="none" stroke="#ea580c" stroke-width="3" stroke-linecap="round"/>
                <circle cx="65" cy="80" r="6" fill="none" stroke="#ea580c" stroke-width="2"/>
                <path d="M 50 100 Q 55 105 60 100" fill="none" stroke="#ea580c" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </div>
            <div class="space-y-2">
              <div class="flex items-center gap-2">
                <span class="w-32 text-xs font-semibold text-slate-700">Target Area:</span>
                <input type="text" id="session1TargetArea" class="input-royal flex-1 text-sm" placeholder="e.g., Left DLPFC" value="${currentRole === 'patient' ? treatmentData.session1.targetArea : ''}" ${currentRole === 'patient' ? 'readonly' : ''} />
              </div>
              <div class="flex items-center gap-2">
                <span class="w-32 text-xs font-semibold text-slate-700">Modality:</span>
                <input type="text" id="session1Modality" class="input-royal flex-1 text-sm" placeholder="e.g., tDCS/rTMS" value="${currentRole === 'patient' ? treatmentData.session1.modality : ''}" ${currentRole === 'patient' ? 'readonly' : ''} />
              </div>
              <div class="flex items-center gap-2">
                <span class="w-32 text-xs font-semibold text-slate-700">Intensity:</span>
                <input type="text" id="session1Intensity" class="input-royal flex-1 text-sm" placeholder="e.g., 2mA" value="${currentRole === 'patient' ? treatmentData.session1.intensity : ''}" ${currentRole === 'patient' ? 'readonly' : ''} />
              </div>
              <div class="flex items-center gap-2">
                <span class="w-32 text-xs font-semibold text-slate-700">Expected Outcome:</span>
                <textarea id="session1Outcome" class="input-royal flex-1 text-sm" rows="3" placeholder="Expected therapeutic outcomes..." ${currentRole === 'patient' ? 'readonly' : ''}>${currentRole === 'patient' ? treatmentData.session1.outcome : ''}</textarea>
              </div>
            </div>
          </div>
        </div>
      </div>
      ` : ''}

      <!-- Treatment Sessions - Second Row -->
      ${currentRole !== 'patient' ? `
      <div class="mb-6 bg-slate-50 p-6 rounded-lg border border-slate-200">
        <h3 class="text-lg font-bold text-slate-900 mb-4 border-b-2 border-sozo-600 pb-2">Treatment Session 2</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Brain Diagram 2 with Fields -->
          <div>
            <div class="mb-3">
              <svg viewBox="0 0 200 200" class="w-48 h-48 mx-auto mb-3">
                <!-- Brain mapping diagram (same as above) -->
                <circle cx="100" cy="100" r="80" fill="none" stroke="#cbd5e1" stroke-width="2"/>
                <circle cx="100" cy="30" r="5" fill="none" stroke="#cbd5e1" stroke-width="1.5"/>
                <text x="100" y="20" text-anchor="middle" font-size="10" fill="#64748b">NASION</text>
                <circle cx="70" cy="50" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="70" y="54" text-anchor="middle" font-size="8" fill="#64748b">FP1</text>
                <circle cx="100" cy="50" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="100" y="54" text-anchor="middle" font-size="8" fill="#64748b">FPZ</text>
                <circle cx="130" cy="50" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="130" y="54" text-anchor="middle" font-size="8" fill="#64748b">FP2</text>
                <circle cx="50" cy="75" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="50" y="79" text-anchor="middle" font-size="8" fill="#64748b">F7</text>
                <circle cx="75" cy="75" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="75" y="79" text-anchor="middle" font-size="8" fill="#64748b">F3</text>
                <circle cx="100" cy="75" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="100" y="79" text-anchor="middle" font-size="8" fill="#64748b">FZ</text>
                <circle cx="125" cy="75" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="125" y="79" text-anchor="middle" font-size="8" fill="#64748b">F4</text>
                <circle cx="150" cy="75" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="150" y="79" text-anchor="middle" font-size="8" fill="#64748b">F8</text>
                <circle cx="30" cy="100" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="30" y="104" text-anchor="middle" font-size="8" fill="#64748b">T3</text>
                <circle cx="65" cy="100" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="65" y="104" text-anchor="middle" font-size="8" fill="#64748b">C3</text>
                <circle cx="100" cy="100" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="100" y="104" text-anchor="middle" font-size="8" fill="#64748b">CZ</text>
                <circle cx="135" cy="100" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="135" y="104" text-anchor="middle" font-size="8" fill="#64748b">C4</text>
                <circle cx="170" cy="100" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="170" y="104" text-anchor="middle" font-size="8" fill="#64748b">T4</text>
                <circle cx="50" cy="125" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="50" y="129" text-anchor="middle" font-size="8" fill="#64748b">T5</text>
                <circle cx="75" cy="125" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="75" y="129" text-anchor="middle" font-size="8" fill="#64748b">P3</text>
                <circle cx="100" cy="125" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="100" y="129" text-anchor="middle" font-size="8" fill="#64748b">PZ</text>
                <circle cx="125" cy="125" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="125" y="129" text-anchor="middle" font-size="8" fill="#64748b">P4</text>
                <circle cx="150" cy="125" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="150" y="129" text-anchor="middle" font-size="8" fill="#64748b">T6</text>
                <circle cx="85" cy="150" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="85" y="154" text-anchor="middle" font-size="8" fill="#64748b">O1</text>
                <circle cx="100" cy="155" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="100" y="159" text-anchor="middle" font-size="8" fill="#64748b">OZ</text>
                <circle cx="115" cy="150" r="8" fill="none" stroke="#ea580c" stroke-width="2"/>
                <text x="115" y="154" text-anchor="middle" font-size="8" fill="#64748b">O2</text>
                <circle cx="100" cy="170" r="5" fill="none" stroke="#cbd5e1" stroke-width="1.5"/>
                <text x="100" y="185" text-anchor="middle" font-size="10" fill="#64748b">INION</text>
              </svg>
            </div>
            <div class="space-y-2">
              <div class="flex items-center gap-2">
                <span class="w-32 text-xs font-semibold text-slate-700">Session #:</span>
                <input type="text" id="session2Number" class="input-royal flex-1 text-sm" placeholder="e.g., 11-20" value="${currentRole === 'patient' ? treatmentData.session2.number : ''}" ${currentRole === 'patient' ? 'readonly' : ''} />
              </div>
              <div class="flex items-center gap-2">
                <span class="w-32 text-xs font-semibold text-slate-700">Protocol:</span>
                <input type="text" id="session2Protocol" class="input-royal flex-1 text-sm" placeholder="e.g., Alpha/Theta" value="${currentRole === 'patient' ? treatmentData.session2.protocol : ''}" ${currentRole === 'patient' ? 'readonly' : ''} />
              </div>
              <div class="flex items-center gap-2">
                <span class="w-32 text-xs font-semibold text-slate-700">Duration:</span>
                <input type="text" id="session2Duration" class="input-royal flex-1 text-sm" placeholder="e.g., 20 min" value="${currentRole === 'patient' ? treatmentData.session2.duration : ''}" ${currentRole === 'patient' ? 'readonly' : ''} />
              </div>
              <div class="flex items-center gap-2">
                <span class="w-32 text-xs font-semibold text-slate-700">Frequency:</span>
                <input type="text" id="session2Frequency" class="input-royal flex-1 text-sm" placeholder="e.g., 3x/week" value="${currentRole === 'patient' ? treatmentData.session2.frequency : ''}" ${currentRole === 'patient' ? 'readonly' : ''} />
              </div>
              <div class="flex items-center gap-2">
                <span class="w-32 text-xs font-semibold text-slate-700">Notes:</span>
                <textarea id="session2Notes" class="input-royal flex-1 text-sm" rows="2" placeholder="Additional notes..." ${currentRole === 'patient' ? 'readonly' : ''}>${currentRole === 'patient' ? treatmentData.session2.notes : ''}</textarea>
              </div>
            </div>
          </div>

          <!-- Head Profile with Fields -->
          <div>
            <div class="mb-3">
              <svg viewBox="0 0 120 200" class="w-32 h-48 mx-auto mb-3">
                <path d="M 60 30 Q 90 30 90 60 L 90 120 Q 90 140 70 155 L 60 160 L 60 175 Q 75 175 75 185" 
                      fill="none" stroke="#ea580c" stroke-width="3" stroke-linecap="round"/>
                <circle cx="65" cy="80" r="6" fill="none" stroke="#ea580c" stroke-width="2"/>
                <path d="M 50 100 Q 55 105 60 100" fill="none" stroke="#ea580c" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </div>
            <div class="space-y-2">
              <div class="flex items-center gap-2">
                <span class="w-32 text-xs font-semibold text-slate-700">Target Area:</span>
                <input type="text" id="session2TargetArea" class="input-royal flex-1 text-sm" placeholder="e.g., Right PFC" value="${currentRole === 'patient' ? treatmentData.session2.targetArea : ''}" ${currentRole === 'patient' ? 'readonly' : ''} />
              </div>
              <div class="flex items-center gap-2">
                <span class="w-32 text-xs font-semibold text-slate-700">Modality:</span>
                <input type="text" id="session2Modality" class="input-royal flex-1 text-sm" placeholder="e.g., Neurofeedback" value="${currentRole === 'patient' ? treatmentData.session2.modality : ''}" ${currentRole === 'patient' ? 'readonly' : ''} />
              </div>
              <div class="flex items-center gap-2">
                <span class="w-32 text-xs font-semibold text-slate-700">Intensity:</span>
                <input type="text" id="session2Intensity" class="input-royal flex-1 text-sm" placeholder="e.g., Low" value="${currentRole === 'patient' ? treatmentData.session2.intensity : ''}" ${currentRole === 'patient' ? 'readonly' : ''} />
              </div>
              <div class="flex items-center gap-2">
                <span class="w-32 text-xs font-semibold text-slate-700">Expected Outcome:</span>
                <textarea id="session2Outcome" class="input-royal flex-1 text-sm" rows="3" placeholder="Expected therapeutic outcomes..." ${currentRole === 'patient' ? 'readonly' : ''}>${currentRole === 'patient' ? treatmentData.session2.outcome : ''}</textarea>
              </div>
            </div>
          </div>
        </div>
      </div>
      ` : ''}

      <!-- Device Suggestions Section -->
      <div class="mb-6 bg-slate-50 p-6 rounded-lg border border-slate-200">
        <h3 class="text-lg font-bold text-slate-900 mb-4 border-b-2 border-sozo-600 pb-2">Device Suggestions</h3>
        
        <!-- Brain Function Assessment Session -->
        <div class="mb-4">
          <div class="grid grid-cols-3 gap-4 mb-3">
            <div class="col-span-2">
              <label class="text-xs font-semibold text-slate-700 block mb-1">Brain Function Assessment Session</label>
            </div>
            <div>
              <input type="text" id="assessmentPrice" class="input-royal text-sm text-center" value="€300" ${currentRole === 'patient' ? 'readonly' : ''} />
            </div>
          </div>
          <div class="grid grid-cols-3 gap-4">
            <div>
              <label class="text-xs font-semibold text-slate-700 block mb-1">No. of Sessions</label>
              <input type="number" id="numSessions" class="input-royal text-sm text-center" placeholder="e.g., 15" value="${currentRole === 'patient' ? treatmentData.sessions.count : ''}" ${currentRole === 'patient' ? 'readonly' : ''} />
            </div>
            <div class="col-span-2">
              <label class="text-xs font-semibold text-slate-700 block mb-1">Price per Session</label>
              <div class="flex items-center gap-2">
                <input type="text" id="pricePerSession" class="input-royal text-sm flex-1" placeholder="€100" value="${currentRole === 'patient' ? treatmentData.sessions.pricePerSession : ''}" ${currentRole === 'patient' ? 'readonly' : ''} />
                <span class="text-slate-600">×</span>
                <input type="number" id="sessionMultiplier" class="input-royal text-sm w-20" placeholder="4" value="${currentRole === 'patient' ? treatmentData.sessions.multiplier : ''}" ${currentRole === 'patient' ? 'readonly' : ''} />
              </div>
            </div>
          </div>
        </div>

        ${currentRole === 'patient' ? `
        <!-- Patient View: Recommended Devices -->
        <div class="mb-4 p-4 bg-blue-50 border-2 border-blue-300 rounded-lg">
          <div class="flex items-center gap-2 mb-3">
            <i class="fa-solid fa-info-circle text-blue-600"></i>
            <p class="text-sm font-semibold text-blue-900">Your doctor has recommended the following devices based on your treatment plan:</p>
          </div>
          <div class="space-y-3">
            <div class="bg-white p-4 rounded-lg border-2 border-orange-400 shadow-sm">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                  <i class="fa-solid fa-circle-nodes text-3xl text-sozo-600"></i>
                  <div>
                    <div class="font-bold text-lg text-slate-900">${treatmentData.suggestedDevice.name}</div>
                    <div class="text-sm text-slate-600">Transcranial Direct Current Stimulation</div>
                  </div>
                </div>
                <div class="text-right">
                  <div class="text-2xl font-bold text-sozo-600">${treatmentData.suggestedDevice.price}</div>
                  <div class="text-sm text-slate-600">${treatmentData.suggestedDevice.sessions}</div>
                </div>
              </div>
            </div>
            <div class="bg-white p-4 rounded-lg border-2 border-blue-400 shadow-sm">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                  <i class="fa-solid fa-wave-square text-3xl text-blue-600"></i>
                  <div>
                    <div class="font-bold text-lg text-slate-900">${treatmentData.suggestedDevice2.name}</div>
                    <div class="text-sm text-slate-600">${treatmentData.suggestedDevice2.description}</div>
                  </div>
                </div>
                <div class="text-right">
                  <div class="text-2xl font-bold text-sozo-600">${treatmentData.suggestedDevice2.price}</div>
                  <div class="text-sm text-slate-600">${treatmentData.suggestedDevice2.sessions}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        ` : `
        <!-- Doctor View: Full Device Selection Table -->
        <!-- Neuromodulation Technique Table -->
        <div class="overflow-x-auto">
          <table class="w-full border-collapse border border-slate-300">
            <thead class="bg-gradient-to-r from-blue-600 to-orange-500 text-white">
              <tr>
                <th class="border border-slate-300 px-4 py-3 text-left text-sm font-bold">Select</th>
                <th class="border border-slate-300 px-4 py-3 text-left text-sm font-bold">Neuromodulation Technique</th>
                <th class="border border-slate-300 px-4 py-3 text-center text-sm font-bold">Price</th>
                <th class="border border-slate-300 px-4 py-3 text-center text-sm font-bold">Frequency/Sessions</th>
              </tr>
            </thead>
            <tbody class="bg-white">
              <tr class="hover:bg-slate-50">
                <td class="border border-slate-300 px-4 py-3 text-center">
                  <input type="radio" name="deviceSelection" value="HD-tDCS" class="w-4 h-4 text-sozo-600" ${currentRole === 'patient' ? 'disabled' : ''} />
                </td>
                <td class="border border-slate-300 px-4 py-3">
                  <div class="flex items-center gap-3">
                    <i class="fa-solid fa-microchip text-2xl text-slate-600"></i>
                    <span class="font-semibold text-slate-800">HD-tDCS</span>
                  </div>
                </td>
                <td class="border border-slate-300 px-4 py-3 text-center">
                  <span class="font-bold text-slate-900">€3000</span>
                </td>
                <td class="border border-slate-300 px-4 py-3 text-center">
                  <input type="text" class="input-royal text-sm w-32 text-center" placeholder="e.g., 10 sessions" ${currentRole === 'patient' ? 'disabled' : ''} />
                </td>
              </tr>
              <tr class="hover:bg-slate-50">
                <td class="border border-slate-300 px-4 py-3 text-center">
                  <input type="radio" name="deviceSelection" value="tDCS-1200" class="w-4 h-4 text-sozo-600" ${currentRole === 'patient' ? 'disabled' : ''} />
                </td>
                <td class="border border-slate-300 px-4 py-3">
                  <div class="flex items-center gap-3">
                    <i class="fa-solid fa-circle-nodes text-2xl text-slate-600"></i>
                    <span class="font-semibold text-slate-800">tDCS</span>
                  </div>
                </td>
                <td class="border border-slate-300 px-4 py-3 text-center">
                  <span class="font-bold text-slate-900">€1200</span>
                </td>
                <td class="border border-slate-300 px-4 py-3 text-center">
                  <input type="text" class="input-royal text-sm w-32 text-center" placeholder="e.g., 15 sessions" ${currentRole === 'patient' ? 'disabled' : ''} />
                </td>
              </tr>
              <tr class="hover:bg-slate-50">
                <td class="border border-slate-300 px-4 py-3 text-center">
                  <input type="radio" name="deviceSelection" value="tDCS-650" class="w-4 h-4 text-sozo-600" ${currentRole === 'patient' ? 'disabled' : ''} />
                </td>
                <td class="border border-slate-300 px-4 py-3">
                  <div class="flex items-center gap-3">
                    <i class="fa-solid fa-headset text-2xl text-slate-600"></i>
                    <span class="font-semibold text-slate-800">tDCS (Standard)</span>
                  </div>
                </td>
                <td class="border border-slate-300 px-4 py-3 text-center">
                  <span class="font-bold text-slate-900">€650</span>
                </td>
                <td class="border border-slate-300 px-4 py-3 text-center">
                  <input type="text" class="input-royal text-sm w-32 text-center" placeholder="e.g., 20 sessions" ${currentRole === 'patient' ? 'disabled' : ''} />
                </td>
              </tr>
              <tr class="hover:bg-slate-50">
                <td class="border border-slate-300 px-4 py-3 text-center">
                  <input type="radio" name="deviceSelection" value="CES" class="w-4 h-4 text-sozo-600" ${currentRole === 'patient' ? 'disabled' : ''} />
                </td>
                <td class="border border-slate-300 px-4 py-3">
                  <div class="flex items-center gap-3">
                    <i class="fa-solid fa-wave-square text-2xl text-slate-600"></i>
                    <span class="font-semibold text-slate-800">CES (Cranial Electrotherapy)</span>
                  </div>
                </td>
                <td class="border border-slate-300 px-4 py-3 text-center">
                  <span class="font-bold text-slate-900">€900</span>
                </td>
                <td class="border border-slate-300 px-4 py-3 text-center">
                  <input type="text" class="input-royal text-sm w-32 text-center" placeholder="e.g., 12 sessions" ${currentRole === 'patient' ? 'disabled' : ''} />
                </td>
              </tr>
              <tr class="hover:bg-slate-50">
                <td class="border border-slate-300 px-4 py-3 text-center">
                  <input type="radio" name="deviceSelection" value="MET" class="w-4 h-4 text-sozo-600" ${currentRole === 'patient' ? 'disabled' : ''} />
                </td>
                <td class="border border-slate-300 px-4 py-3">
                  <div class="flex items-center gap-3">
                    <i class="fa-solid fa-bolt text-2xl text-slate-600"></i>
                    <span class="font-semibold text-slate-800">MET (Microcurrent Therapy)</span>
                  </div>
                </td>
                <td class="border border-slate-300 px-4 py-3 text-center">
                  <span class="font-bold text-slate-900">€1400</span>
                </td>
                <td class="border border-slate-300 px-4 py-3 text-center">
                  <input type="text" class="input-royal text-sm w-32 text-center" placeholder="e.g., 8 sessions" ${currentRole === 'patient' ? 'disabled' : ''} />
                </td>
              </tr>
              <tr class="hover:bg-slate-50">
                <td class="border border-slate-300 px-4 py-3 text-center">
                  <input type="radio" name="deviceSelection" value="RehabGlove" class="w-4 h-4 text-sozo-600" ${currentRole === 'patient' ? 'disabled' : ''} />
                </td>
                <td class="border border-slate-300 px-4 py-3">
                  <div class="flex items-center gap-3">
                    <i class="fa-solid fa-hand text-2xl text-slate-600"></i>
                    <span class="font-semibold text-slate-800">Rehabilitation Glove</span>
                  </div>
                </td>
                <td class="border border-slate-300 px-4 py-3 text-center">
                  <span class="font-bold text-slate-900">€200</span>
                </td>
                <td class="border border-slate-300 px-4 py-3 text-center">
                  <input type="text" class="input-royal text-sm w-32 text-center" placeholder="e.g., Daily use" ${currentRole === 'patient' ? 'disabled' : ''} />
                </td>
              </tr>
              <tr class="hover:bg-slate-50">
                <td class="border border-slate-300 px-4 py-3 text-center">
                  <input type="radio" name="deviceSelection" value="TPS" class="w-4 h-4 text-sozo-600" ${currentRole === 'patient' ? 'disabled' : ''} />
                </td>
                <td class="border border-slate-300 px-4 py-3">
                  <div class="flex items-center gap-3">
                    <i class="fa-solid fa-podcast text-2xl text-slate-600"></i>
                    <span class="font-semibold text-slate-800">TPS (Transcranial Pulse Stimulation)</span>
                  </div>
                </td>
                <td class="border border-slate-300 px-4 py-3 text-center">
                  <input type="text" class="input-royal text-sm w-24 text-center" placeholder="€" ${currentRole === 'patient' ? 'disabled' : ''} />
                </td>
                <td class="border border-slate-300 px-4 py-3 text-center">
                  <input type="text" class="input-royal text-sm w-32 text-center" placeholder="e.g., 6 sessions" ${currentRole === 'patient' ? 'disabled' : ''} />
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        `}
      </div>

      <!-- Clinical Notes Section (First Visit Only) -->
      ${currentRole === 'patient' && selectedVisit === 'first-visit' ? `
      <div class="mb-8">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center shadow-lg">
            <i class="fa-solid fa-notes-medical text-white text-lg"></i>
          </div>
          <h3 class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-slate-600 bg-clip-text text-transparent">Clinical Notes</h3>
        </div>
        
        <div class="bg-white rounded-xl shadow-md border border-slate-200 p-6">
          <!-- Session 1 Notes -->
          <div class="mb-6">
            <div class="flex items-center gap-2 mb-3">
              <i class="fa-solid fa-file-medical text-blue-600 text-lg"></i>
              <h4 class="text-lg font-bold text-slate-800">Session 1 Notes</h4>
            </div>
            <div class="bg-slate-50 rounded-lg p-4 border-l-4 border-blue-500">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                  <p class="text-xs text-slate-600 mb-1">Date</p>
                  <p class="font-semibold text-slate-900">January 15, 2025</p>
                </div>
                <div>
                  <p class="text-xs text-slate-600 mb-1">Duration</p>
                  <p class="font-semibold text-slate-900">45 minutes</p>
                </div>
                <div>
                  <p class="text-xs text-slate-600 mb-1">Clinician</p>
                  <p class="font-semibold text-slate-900">Dr. Sarah Johnson</p>
                </div>
              </div>
              <div>
                <p class="text-xs text-slate-600 mb-2">Clinical Observations</p>
                <p class="text-sm text-slate-700 leading-relaxed">Patient presented with mild cognitive impairment symptoms. Initial assessment shows decreased attention span and memory recall difficulties. Patient is alert and cooperative. No adverse reactions noted during initial evaluation. Baseline cognitive scores established for treatment monitoring.</p>
              </div>
            </div>
          </div>

          <!-- Session 2 Notes -->
          <div>
            <div class="flex items-center gap-2 mb-3">
              <i class="fa-solid fa-file-medical text-sozo-600 text-lg"></i>
              <h4 class="text-lg font-bold text-slate-800">Session 2 Notes</h4>
            </div>
            <div class="bg-slate-50 rounded-lg p-4 border-l-4 border-slate-600">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                  <p class="text-xs text-slate-600 mb-1">Date</p>
                  <p class="font-semibold text-slate-900">January 22, 2025</p>
                </div>
                <div>
                  <p class="text-xs text-slate-600 mb-1">Duration</p>
                  <p class="font-semibold text-slate-900">50 minutes</p>
                </div>
                <div>
                  <p class="text-xs text-slate-600 mb-1">Clinician</p>
                  <p class="font-semibold text-slate-900">Dr. Sarah Johnson</p>
                </div>
              </div>
              <div>
                <p class="text-xs text-slate-600 mb-2">Clinical Observations</p>
                <p class="text-sm text-slate-700 leading-relaxed">Follow-up session shows patient adapting well to treatment protocol. Slight improvement in attention metrics noted. Patient reports feeling more focused during daily activities. No side effects reported. Treatment parameters adjusted based on initial response. Continue with current montage configuration.</p>
              </div>
            </div>
          </div>

          <!-- Treatment Progress Summary -->
          <div class="mt-6 bg-gradient-to-r from-blue-50 to-slate-50 rounded-lg p-4 border border-blue-200">
            <div class="flex items-start gap-3">
              <i class="fa-solid fa-chart-line text-blue-600 text-xl mt-1"></i>
              <div>
                <h5 class="font-bold text-slate-800 mb-2">Treatment Progress Summary</h5>
                <p class="text-sm text-slate-700">Patient is responding positively to initial treatment sessions. Early indicators suggest good tolerance to tDCS therapy. Recommend continuing with current protocol and monitoring cognitive improvement markers in upcoming sessions.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      ` : ''}

      <!-- Save Button -->
      ${currentRole !== 'patient' ? `
      <div class="flex justify-end gap-3 mt-6">
        <button id="saveTreatmentPlanBtn" class="btn-primary">
          <i class="fa-solid fa-save mr-2"></i>Save Treatment Plan
        </button>
      </div>
      ` : ''}
    </div>
    </div>
  `;
  
  // Attach event listeners  
  setTimeout(() => {
    // Clinical Indication Dropdown - trigger initial update if needed
    const clinicalSelect = document.getElementById('clinicalIndicationSelect');
    if (clinicalSelect) {
      // Initialize montage display if there's a pre-selected value
      if (clinicalSelect.value) {
        updateMontageMapping();
      }
    }
    
    // Patient Navigation Dropdown
    const patientNavSelect = document.getElementById('patientNavigationSelectTreatment');
    if (patientNavSelect) {
      patientNavSelect.addEventListener('change', (e) => {
        const patientId = e.target.value;
        if (patientId) {
          const patient = sampleData.patients.find(p => p.id === patientId);
          if (patient) {
            globalSelectedPatientId = patient.id;
            globalState.currentPatient = patient;
            renderPatientTreatmentPlan();
          }
        }
      });
    }
    
    // Save Button Handler
    const saveBtn = document.getElementById('saveTreatmentPlanBtn');
    if (saveBtn) {
      saveBtn.addEventListener('click', () => {
        // Collect treatment plan data
        const treatmentData = {
          patientId: p.id,
          patientName: document.getElementById('treatmentPatientName')?.value,
          treatmentDate: document.getElementById('treatmentDate')?.value,
          session1: {
            number: document.getElementById('session1Number')?.value,
            protocol: document.getElementById('session1Protocol')?.value,
            duration: document.getElementById('session1Duration')?.value,
            frequency: document.getElementById('session1Frequency')?.value,
            notes: document.getElementById('session1Notes')?.value,
            targetArea: document.getElementById('session1TargetArea')?.value,
            modality: document.getElementById('session1Modality')?.value,
            intensity: document.getElementById('session1Intensity')?.value,
            outcome: document.getElementById('session1Outcome')?.value
          },
          session2: {
            number: document.getElementById('session2Number')?.value,
            protocol: document.getElementById('session2Protocol')?.value,
            duration: document.getElementById('session2Duration')?.value,
            frequency: document.getElementById('session2Frequency')?.value,
            notes: document.getElementById('session2Notes')?.value,
            targetArea: document.getElementById('session2TargetArea')?.value,
            modality: document.getElementById('session2Modality')?.value,
            intensity: document.getElementById('session2Intensity')?.value,
            outcome: document.getElementById('session2Outcome')?.value
          }
        };
        
        console.log('Treatment Plan Saved:', treatmentData);
        
        // Show success message
        saveBtn.innerHTML = '<i class="fa-solid fa-check mr-2"></i>Saved!';
        saveBtn.classList.remove('bg-sozo-600');
        saveBtn.classList.add("bg-sozo-600");
        setTimeout(() => {
          saveBtn.innerHTML = '<i class="fa-solid fa-save mr-2"></i>Save Treatment Plan';
          saveBtn.classList.remove("bg-sozo-600");
          saveBtn.classList.add('bg-sozo-600');
        }, 2000);
      });
    }
  }, 100);
}

function getPatientDiseaseProtocol(condition) {
  const protocols = {
    'Depression': {
      primary: {
        name: 'Left DLPFC Stimulation',
        description: 'High-frequency stimulation of left dorsolateral prefrontal cortex for depression treatment',
        anodes: ['F3'],
        cathode: 'Fp2'
      },
      secondary: {
        name: 'Bilateral DLPFC Protocol',
        description: 'Bilateral dorsolateral prefrontal cortex targeting for treatment-resistant cases',
        anodes: ['F3', 'F4'],
        cathode: 'Cz'
      }
    },
    'Anxiety': {
      primary: {
        name: 'Right DLPFC Modulation',
        description: 'Low-frequency stimulation for anxiety reduction and emotional regulation',
        anodes: ['F4'],
        cathode: 'F3'
      },
      secondary: {
        name: 'Frontopolar Protocol',
        description: 'Bilateral frontopolar cortex stimulation for social anxiety',
        anodes: ['Fp1', 'Fp2'],
        cathode: 'Cz'
      }
    },
    'Chronic Pain': {
      primary: {
        name: 'Primary Motor Cortex',
        description: 'M1 stimulation for neuropathic pain modulation',
        anodes: ['C3'],
        cathode: 'Fp2'
      },
      secondary: {
        name: 'Bilateral Motor Protocol',
        description: 'Bilateral primary motor cortex activation for widespread pain',
        anodes: ['C3', 'C4'],
        cathode: 'Cz'
      }
    }
  };
  
  return protocols[condition] || protocols['Depression']; // Default to depression if condition not found
}

// -- FNON MODULE LOGIC --
function renderFNON() {
  const area = document.getElementById('contentArea');
  // For patient role, auto-select their own patient context
  if(currentRole === 'patient' && !globalSelectedPatientId) {
    const ap = getActivePatient();
    if(ap?.id) globalSelectedPatientId = ap.id;
  }
  
  // Auto-populate patient details if globalSelectedPatientId is set
  if(globalSelectedPatientId && !globalState.currentPatient) {
    const selectedPatient = sampleData.patients.find(p => p.id === globalSelectedPatientId);
    if(selectedPatient) {
      globalState.currentPatient = selectedPatient;
    }
  }
  
  area.innerHTML = `
    <div class="p-8">
    
    ${getAssessmentNavigation('fnon')}
    
    <div class="mb-6 flex items-center justify-between">
      <div>
        <h2 class="text-2xl font-bold text-slate-800">FNON Assessment</h2>
        <p class="text-slate-500">Functional Network of Neurons Checklist</p>
      </div>
      ${currentRole !== 'patient' ? `
      <div class="flex items-center gap-3">
        <div class="relative">
          <select id="patientNavigationSelect" class="input-royal pr-10 font-bold text-slate-900 bg-white border-2 border-orange-300">
            <option value="">Select Patient...</option>
            ${sampleData.patients.map(p => `
              <option value="${p.id}" ${globalState.currentPatient?.id === p.id ? 'selected' : ''}>
                ${p.name} (${p.id})
              </option>
            `).join('')}
          </select>
          <i class="fa-solid fa-user-group absolute right-3 top-3 text-orange-600 pointer-events-none"></i>
        </div>
        <button onclick="loadSection('patienthistory')" class="btn-secondary text-sm" title="Back to Patient History">
          <i class="fa-solid fa-arrow-left mr-2"></i>Patient View
        </button>
      </div>
      ` : ''}
    </div>

    ${globalState.currentPatient && currentRole !== 'patient' ? `
    <!-- Auto-populated Patient Context -->
    <div class="card p-6 mb-8 border-l-4 border-l-blue-600 bg-gradient-to-r from-blue-50 to-slate-50">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-bold text-xl text-slate-900"><i class="fa-solid fa-user-check mr-2"></i>Patient Context (Auto-populated)</h3>
        <button id="resetFNONForm" class="btn-secondary text-sm"><i class="fa-solid fa-rotate-left mr-2"></i>Change Patient</button>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Patient Information -->
        <div class="bg-white p-4 rounded-lg border border-blue-200">
          <p class="text-xs font-bold text-blue-900 uppercase mb-3"><i class="fa-solid fa-user mr-1"></i>Patient Information</p>
          <div class="space-y-2">
            <div class="flex justify-between">
              <span class="text-xs font-semibold text-slate-600">Name:</span>
              <span class="text-sm font-bold text-slate-900">${globalState.currentPatient.name}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-xs font-semibold text-slate-600">Patient ID:</span>
              <span class="text-sm font-mono text-slate-900">${globalState.currentPatient.id}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-xs font-semibold text-slate-600">Email:</span>
              <span class="text-sm text-slate-900">${globalState.currentPatient.email}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-xs font-semibold text-slate-600">Country:</span>
              <span class="text-sm text-slate-900">${globalState.currentPatient.country}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-xs font-semibold text-slate-600">Condition:</span>
              <span class="text-sm font-bold text-orange-600">${globalState.currentPatient.condition || 'N/A'}</span>
            </div>
          </div>
        </div>
        
        <!-- Doctor Information -->
        <div class="bg-white p-4 rounded-lg border border-slate-200">
          <p class="text-xs font-bold text-slate-700 uppercase mb-3"><i class="fa-solid fa-user-doctor mr-1"></i>Doctor Information</p>
          <div class="space-y-2">
            <div class="flex justify-between">
              <span class="text-xs font-semibold text-slate-600">Name:</span>
              <span class="text-sm font-bold text-slate-900">${globalState.currentDoctor.name}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-xs font-semibold text-slate-600">Email:</span>
              <span class="text-sm text-slate-900">${globalState.currentDoctor.email}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-xs font-semibold text-slate-600">Clinic:</span>
              <span class="text-sm text-slate-900">${globalState.currentDoctor.clinic}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-xs font-semibold text-slate-600">Date:</span>
              <span class="text-sm font-bold text-slate-900">${new Date().toLocaleDateString()}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    ` : ''}

    <div id="fnonContent" class="${globalState.currentPatient || currentRole === 'admin' ?'':'hidden'}">
      <!-- Admin Management Panel (Only for Admin role) -->
      ${currentRole === 'admin' ? `
      <div class="card p-6 mb-8 border-l-4 border-l-indigo-600 bg-gradient-to-r from-blue-50 to-slate-50">
        <div class="flex justify-between items-center mb-4">
          <h3 class="font-bold text-xl text-slate-900"><i class="fa-solid fa-sliders mr-2"></i>Section A Management (Admin Only)</h3>
          <div class="flex gap-2">
            <button id="addNetworkBtn" class="bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-sozo-700"><i class="fa-solid fa-plus mr-1"></i>Add Network</button>
            <button id="toggleEditMode" class="bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-sozo-700"><i class="fa-solid fa-edit mr-1"></i>Edit Mode</button>
          </div>
        </div>
        
        <div id="managementPanel" class="space-y-4 hidden">
          <div class="bg-white p-4 rounded-lg border border-blue-200">
            <h4 class="font-bold mb-3">Networks & Questions</h4>
            <div id="networksList" class="space-y-4"></div>
          </div>
        </div>
        
        <!-- Add New Network Form (Independent) -->
        <div id="addNetworkForm" class="bg-white p-4 rounded-lg border border-blue-200 hidden">
          <h4 class="font-bold mb-3">Add New Network</h4>
          <div class="space-y-3">
            <input id="newNetworkName" type="text" placeholder="Network name (e.g., DMN, CEN, SN)" class="input-royal" />
            <input id="newNetworkSigns" type="text" placeholder="Signs (e.g., Rumination, Mind-wandering)" class="input-royal" />
            <div id="newNetworkTests" class="space-y-2">
              <div class="flex justify-between items-center">
                <label class="text-xs font-bold">Tests (add as many as needed)</label>
                <button id="addTestFieldBtn" type="button" class="bg-blue-600 text-white px-2 py-1 rounded text-xs font-bold hover:bg-blue-700">
                  <i class="fa-solid fa-plus mr-1"></i>Add Test
                </button>
              </div>
              <div id="testInputsContainer" class="space-y-2">
                <input type="text" placeholder="Test 1" class="input-royal test-input" />
                <input type="text" placeholder="Test 2" class="input-royal test-input" />
                <input type="text" placeholder="Test 3" class="input-royal test-input" />
              </div>
            </div>
            <div class="flex gap-2">
              <button id="confirmAddNetwork" class="flex-1 bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-sozo-700">Save Network</button>
              <button id="cancelAddNetwork" class="flex-1 bg-slate-300 text-slate-700 px-4 py-2 rounded-lg font-bold hover:bg-slate-400">Cancel</button>
            </div>
          </div>
        </div>
      </div>
      ` : ''}
      
      <div class="card p-0 mb-8 overflow-hidden">
        <div class="bg-slate-800 text-white p-4 font-bold flex justify-between">
          <span>Section A: Clinical Checklist</span>
          <span class="text-xs font-normal opacity-70">0=Normal, 1=Mild, 2=Deficit</span>
        </div>
        <div class="p-6 space-y-6" id="sectionAContent">
          ${sampleData.fnon.sectionA.map((net, i) => `
            <div class="border-b border-slate-100 pb-6 last:border-0 network-item" data-network-index="${i}">
              <div class="flex justify-between items-center mb-3">
                <div class="flex items-center gap-3">
                  <h3 class="font-bold text-lg text-sozo-700">${net.net}</h3>
                  ${currentRole === 'admin' && document.getElementById('toggleEditMode')?.textContent.includes('Exit') ? `
                  <button class="removeNetworkBtn text-slate-600 hover:text-slate-700 font-bold" data-index="${i}"><i class="fa-solid fa-trash-alt"></i></button>
                  ` : ''}
                </div>
                <div class="flex items-center gap-3">
                  <span class="badge badge-sozo">Score: <span id="s_${i}">0</span></span>
                  <span class="badge badge-info">Norm: <span id="n_${i}">0.0</span>/10</span>
                </div>
              </div>
              <p class="text-xs text-slate-500 italic mb-3"><i class="fa-solid fa-triangle-exclamation"></i> ${net.signs}</p>
              <div class="grid grid-cols-1 gap-2">
                ${net.tests.map((t, ti) => `
                  <div class="flex justify-between items-center text-sm bg-slate-50 p-2 rounded hover:bg-slate-100 test-row" data-test-index="${ti}">
                    <span class="test-text">${t}</span>
                    <div class="flex gap-4">
                      ${[0,1,2].map(v => `<label class="cursor-pointer flex items-center gap-1"><input type="radio" name="n${i}t${ti}" value="${v}" ${v===0?'checked':''} onchange="calcFNON(${i})"> ${v}</label>`).join('')}
                    </div>
                    ${currentRole === 'admin' && document.getElementById('toggleEditMode')?.textContent.includes('Exit') ? `
                    <button class="removeTestBtn text-slate-600 hover:text-slate-700 text-xs font-bold ml-2" data-network="${i}" data-test="${ti}"><i class="fa-solid fa-times"></i></button>
                    ` : ''}
                  </div>
                `).join('')}
              </div>
            </div>
          `).join('')}
        </div>
      </div>

      <div class="card p-0 overflow-hidden">
        <div class="bg-sozo-600 text-white p-4 font-bold">Section B: Reference & Treatment Guide</div>
        <div class="overflow-x-auto">
          <table>
            <thead><tr><th>Network</th><th>Symptoms</th><th>Anatomy</th><th>EEG Sites</th></tr></thead>
            <tbody id="fnonRefBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Overall Summary -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
        <div class="card p-4 border border-slate-200">
          <p class="text-xs font-bold uppercase text-slate-500 mb-1">Overall Average</p>
          <p class="text-3xl font-black text-sozo-600" id="fnon-average">0.0</p>
        </div>
        <div class="card p-4 border border-slate-200">
          <p class="text-xs font-bold uppercase text-slate-500 mb-1">Highest Focus</p>
          <p class="text-sm font-bold text-slate-600" id="fnon-highest">--</p>
        </div>
        <div class="card p-4 border border-slate-200 bg-slate-50">
          <p class="text-xs font-bold uppercase text-slate-500 mb-1">Treatment Plan</p>
          <div id="fnon-plan" class="text-sm text-slate-700">No elevated findings. Maintain current plan.</div>
        </div>
      </div>

      <div class="flex flex-wrap gap-3 mt-6">
        <button id="doctorFnonSave" class="bg-slate-200 text-slate-800 px-4 py-2 rounded-lg font-bold hover:bg-slate-300">Save Progress</button>
        <button id="doctorFnonSubmit" class="bg-gradient-to-r from-sozo-600 to-orange-500 text-white px-5 py-2 rounded-lg font-bold hover:shadow-lg">Submit & Continue to Brain</button>
        <span class="text-xs text-slate-500">Submitting marks FNON complete and unlocks Brain Mapping.</span>
      </div>
    </div>
    </div>
  `;
  if(globalSelectedPatientId) updateRefTable();

  setTimeout(() => {
    // Patient Navigation Dropdown
    const patientNavSelect = document.getElementById('patientNavigationSelect');
    if (patientNavSelect) {
      patientNavSelect.addEventListener('change', (e) => {
        const patientId = e.target.value;
        if (patientId) {
          const patient = sampleData.patients.find(p => p.id === patientId);
          if (patient) {
            globalSelectedPatientId = patient.id;
            globalState.currentPatient = patient;
            // Reload the current assessment page with new patient
            renderFNON();
          }
        }
      });
    }
    
    // Smart Patient Search functionality
    const searchInput = document.getElementById('patientSearchInput');
    const searchDropdown = document.getElementById('patientSearchDropdown');
    const patientNameInput = document.getElementById('patientNameInput');
    const resetBtn = document.getElementById('resetFNONForm');

    if (searchInput && searchDropdown) {
      const patientEmailInput = document.getElementById('patientEmailInput');
      const patientCountryInput = document.getElementById('patientCountryInput');
      
      // Show all patients on focus
      searchInput.addEventListener('focus', () => {
        const query = searchInput.value.toLowerCase().trim();
        const matches = query ? 
          sampleData.patients.filter(p => 
            p.name.toLowerCase().includes(query) ||
            p.id.toLowerCase().includes(query) ||
            (p.email && p.email.toLowerCase().includes(query))
          ) : sampleData.patients;
        
        if (matches.length > 0) {
          searchDropdown.innerHTML = matches.slice(0, 10).map(p => `
            <div class="search-dropdown-item" data-patient-id="${p.id}">
              <div class="font-bold text-sm">${p.name}</div>
              <div class="text-xs text-slate-500">${p.id} • ${p.country} • ${p.email || 'N/A'}</div>
            </div>
          `).join('');
          searchDropdown.classList.remove('hidden');
          
          // Add click handlers
          searchDropdown.querySelectorAll('.search-dropdown-item').forEach(item => {
            item.addEventListener('click', () => {
              const patientId = item.dataset.patientId;
              const patient = sampleData.patients.find(p => p.id === patientId);
              if (patient) {
                globalSelectedPatientId = patient.id;
                const patientEmail = patient.email || `${patient.name.toLowerCase().replace(/\s+/g, '.')}@example.com`;
                globalState.currentPatient = {
                  ...patient,
                  email: patientEmail
                };
                globalState.sessionData.patient = {
                  name: patient.name,
                  email: patientEmail,
                  country: patient.country,
                  id: patient.id
                };
                searchInput.value = patient.name;
                if(patientNameInput) patientNameInput.value = patient.name;
                if(patientEmailInput) patientEmailInput.value = patientEmail;
                if(patientCountryInput) patientCountryInput.value = patient.country || 'N/A';
                searchDropdown.classList.add('hidden');
                document.getElementById('fnonContent').classList.remove('hidden');
              }
            });
          });
        }
      });
      
      searchInput.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase().trim();
        if (!query) {
          // Show all patients when empty
          searchDropdown.innerHTML = sampleData.patients.slice(0, 10).map(p => `
            <div class="search-dropdown-item" data-patient-id="${p.id}">
              <div class="font-bold text-sm">${p.name}</div>
              <div class="text-xs text-slate-500">${p.id} • ${p.country} • ${p.email || 'N/A'}</div>
            </div>
          `).join('');
          searchDropdown.classList.remove('hidden');
          
          searchDropdown.querySelectorAll('.search-dropdown-item').forEach(item => {
            item.addEventListener('click', () => {
              const patientId = item.dataset.patientId;
              const patient = sampleData.patients.find(p => p.id === patientId);
              if (patient) {
                globalSelectedPatientId = patient.id;
                const patientEmail = patient.email || `${patient.name.toLowerCase().replace(/\s+/g, '.')}@example.com`;
                globalState.currentPatient = {
                  ...patient,
                  email: patientEmail
                };
                globalState.sessionData.patient = {
                  name: patient.name,
                  email: patientEmail,
                  country: patient.country,
                  id: patient.id
                };
                searchInput.value = patient.name;
                if(patientNameInput) patientNameInput.value = patient.name;
                if(patientEmailInput) patientEmailInput.value = patientEmail;
                if(patientCountryInput) patientCountryInput.value = patient.country || 'N/A';
                searchDropdown.classList.add('hidden');
                document.getElementById('fnonContent').classList.remove('hidden');
              }
            });
          });
          return;
        }

        const matches = sampleData.patients.filter(p => 
          p.name.toLowerCase().includes(query) ||
          p.id.toLowerCase().includes(query) ||
          (p.email && p.email.toLowerCase().includes(query))
        );

        if (matches.length > 0) {
          searchDropdown.innerHTML = matches.map(p => `
            <div class="search-dropdown-item" data-patient-id="${p.id}">
              <div class="font-bold text-sm">${p.name}</div>
              <div class="text-xs text-slate-500">${p.id} • ${p.country} • ${p.email || 'N/A'}</div>
            </div>
          `).join('');
          searchDropdown.classList.remove('hidden');

          // Add click handlers for dropdown items
          searchDropdown.querySelectorAll('.search-dropdown-item').forEach(item => {
            item.addEventListener('click', () => {
              const patientId = item.dataset.patientId;
              const patient = sampleData.patients.find(p => p.id === patientId);
              if (patient) {
                globalSelectedPatientId = patient.id;
                const patientEmail = patient.email || `${patient.name.toLowerCase().replace(/\s+/g, '.')}@example.com`;
                globalState.currentPatient = {
                  ...patient,
                  email: patientEmail
                };
                globalState.sessionData.patient = {
                  name: patient.name,
                  email: patientEmail,
                  country: patient.country,
                  id: patient.id
                };
                searchInput.value = patient.name;
                if(patientNameInput) patientNameInput.value = patient.name;
                if(patientEmailInput) patientEmailInput.value = patientEmail;
                if(patientCountryInput) patientCountryInput.value = patient.country || 'N/A';
                searchDropdown.classList.add('hidden');
                document.getElementById('fnonContent').classList.remove('hidden');
              }
            });
          });
        } else {
          searchDropdown.innerHTML = '<div class="search-dropdown-item text-slate-500">No patients found</div>';
          searchDropdown.classList.remove('hidden');
        }
      });

      // Hide dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!searchInput.contains(e.target) && !searchDropdown.contains(e.target)) {
          searchDropdown.classList.add('hidden');
        }
      });
    }

    if (resetBtn) {
      resetBtn.addEventListener('click', () => {
        globalSelectedPatientId = null;
        globalState.currentPatient = null;
        // Reset all radio buttons
        document.querySelectorAll('input[type="radio"]').forEach(r => {
          if (r.value === '0') r.checked = true;
        });
        sampleData.fnon.sectionA.forEach((_, i) => calcFNON(i));
        // Navigate back to patients list
        loadSection('patients');
      });
    }

    // If doctor already saved scores, reflect them in the UI
    if(fnonState && Object.keys(fnonState.scores || {}).length) {
      sampleData.fnon.sectionA.forEach((row, i) => {
        const normalized = fnonState.scores[row.net] || 0;
        const maxRaw = (row.tests.length || 0) * 2;
        const approxRaw = maxRaw ? Math.round((normalized / 10) * maxRaw) : 0;
        const sEl = document.getElementById(`s_${i}`);
        const nEl = document.getElementById(`n_${i}`);
        if(sEl) sEl.textContent = approxRaw;
        if(nEl) nEl.textContent = normalized.toFixed(1);
      });
      refreshFnonOverall();
      updateRefTable();
    }

    const saveBtn = document.getElementById('doctorFnonSave');
    const submitBtn = document.getElementById('doctorFnonSubmit');

    if(saveBtn) {
      saveBtn.addEventListener('click', () => {
        refreshFnonOverall();
        setProgress('fnon', 'in-progress');
        updateProgressBadges();
        alert('FNON progress saved.');
      });
    }

    if(submitBtn) {
      submitBtn.addEventListener('click', () => {
        if(!globalSelectedPatientId && currentRole === 'doctor') {
          alert('Please select a patient first.');
          return;
        }
        refreshFnonOverall();
        setProgress('fnon', 'completed');
        setProgress('brain', 'in-progress');
        updateProgressBadges();
        saveFnonState();
        alert('FNON Assessment completed successfully. Proceeding to Brain Mapping.');
        loadSection(currentRole==='patient' ? 'brain' : 'brainmap');
      });
    }

    function renderNetworksManagement() {
        const networksList = document.getElementById('networksList');
        if(!networksList) return;
        
        networksList.innerHTML = sampleData.fnon.sectionA.map((net, idx) => `
          <div class="bg-slate-100 p-4 rounded-lg border border-slate-300">
            <div class="flex justify-between items-start mb-3">
              <div>
                <h5 class="font-bold text-lg text-slate-900">${net.net}</h5>
                <p class="text-sm text-slate-600">${net.signs}</p>
              </div>
              <button class="removeNetworkBtn bg-slate-600 text-white px-3 py-1 rounded font-bold text-sm hover:bg-slate-700" data-index="${idx}">
                <i class="fa-solid fa-trash-alt mr-1"></i>Remove Network
              </button>
            </div>
            <div class="mb-3">
              <div class="flex justify-between items-center mb-2">
                <p class="text-xs font-bold text-slate-700">Tests:</p>
                <button class="addTestBtn bg-sozo-600 text-white px-2 py-1 rounded font-bold text-xs hover:bg-sozo-700" data-network="${idx}">
                  <i class="fa-solid fa-plus mr-1"></i>Add Test
                </button>
              </div>
              <div class="space-y-1" id="tests-${idx}">
                ${net.tests.map((test, ti) => `
                  <div class="flex justify-between items-center bg-white p-2 rounded text-sm">
                    <span>${test}</span>
                    <div class="flex gap-2">
                      <button class="editTestBtn text-blue-600 hover:text-blue-800 font-bold text-xs" data-network="${idx}" data-test="${ti}">
                        <i class="fa-solid fa-edit"></i>
                      </button>
                      <button class="removeTestBtn text-slate-600 hover:text-slate-700 font-bold text-xs" data-network="${idx}" data-test="${ti}">
                        <i class="fa-solid fa-trash"></i>
                      </button>
                    </div>
                  </div>
                `).join('')}
              </div>
              <div id="addTestForm-${idx}" class="hidden mt-2 bg-white p-2 rounded">
                <input type="text" placeholder="New test name" class="input-royal text-sm mb-2" id="testInput-${idx}" />
                <div class="flex gap-2">
                  <button class="confirmAddTestBtn flex-1 bg-sozo-600 text-white px-2 py-1 rounded font-bold text-xs hover:bg-sozo-700" data-network="${idx}">Add</button>
                  <button class="cancelAddTestBtn flex-1 bg-slate-400 text-white px-2 py-1 rounded font-bold text-xs hover:bg-slate-500" data-network="${idx}">Cancel</button>
                </div>
              </div>
            </div>
          </div>
        `).join('');

        // Add event listeners for network management
        document.querySelectorAll('.removeNetworkBtn').forEach(btn => {
          btn.addEventListener('click', () => {
            const idx = parseInt(btn.dataset.index);
            if(confirm(`Remove network "${sampleData.fnon.sectionA[idx].net}"?`)) {
              sampleData.fnon.sectionA.splice(idx, 1);
              alert('Network removed successfully!');
              loadSection('fnon');
            }
          });
        });

        document.querySelectorAll('.addTestBtn').forEach(btn => {
          btn.addEventListener('click', () => {
            const netIdx = parseInt(btn.dataset.network);
            const form = document.getElementById(`addTestForm-${netIdx}`);
            if(form) form.classList.toggle('hidden');
          });
        });

        document.querySelectorAll('.confirmAddTestBtn').forEach(btn => {
          btn.addEventListener('click', () => {
            const netIdx = parseInt(btn.dataset.network);
            const input = document.getElementById(`testInput-${netIdx}`);
            const testName = input.value.trim();
            
            if(!testName) {
              alert('Please enter a test name');
              return;
            }

            sampleData.fnon.sectionA[netIdx].tests.push(testName);
            alert(`Test "${testName}" added successfully!`);
            input.value = '';
            document.getElementById(`addTestForm-${netIdx}`).classList.add('hidden');
            renderNetworksManagement();
          });
        });

        document.querySelectorAll('.cancelAddTestBtn').forEach(btn => {
          btn.addEventListener('click', () => {
            const netIdx = parseInt(btn.dataset.network);
            const form = document.getElementById(`addTestForm-${netIdx}`);
            if(form) form.classList.add('hidden');
          });
        });

        document.querySelectorAll('.removeTestBtn').forEach(btn => {
          btn.addEventListener('click', () => {
            const netIdx = parseInt(btn.dataset.network);
            const testIdx = parseInt(btn.dataset.test);
            const testName = sampleData.fnon.sectionA[netIdx].tests[testIdx];
            if(confirm(`Remove test "${testName}"?`)) {
              sampleData.fnon.sectionA[netIdx].tests.splice(testIdx, 1);
              alert('Test removed successfully!');
              renderNetworksManagement();
              
              // Update Section A display - refresh the entire network section
              const sectionAContent = document.getElementById('sectionAContent');
              if(sectionAContent) {
                const networkItem = sectionAContent.querySelector(`[data-network-index="${netIdx}"]`);
                if(networkItem) {
                  const testGrid = networkItem.querySelector('.grid');
                  if(testGrid) {
                    testGrid.innerHTML = sampleData.fnon.sectionA[netIdx].tests.map((t, ti) => `
                      <div class="flex justify-between items-center text-sm bg-slate-50 p-2 rounded hover:bg-slate-100 test-row" data-test-index="${ti}">
                        <span class="test-text">${t}</span>
                        <div class="flex gap-4">
                          ${[0,1,2].map(v => `<label class="cursor-pointer flex items-center gap-1"><input type="radio" name="n${netIdx}t${ti}" value="${v}" ${v===0?'checked':''} onchange="calcFNON(${netIdx})"> ${v}</label>`).join('')}
                        </div>
                        ${currentRole === 'admin' && document.getElementById('toggleEditMode')?.textContent.includes('Exit') ? `
                        <button class="removeTestBtn text-slate-600 hover:text-slate-700 text-xs font-bold ml-2" data-network="${netIdx}" data-test="${ti}"><i class="fa-solid fa-times"></i></button>
                        ` : ''}
                      </div>
                    `).join('');
                  }
                }
              }
            }
          });
        });

        document.querySelectorAll('.editTestBtn').forEach(btn => {
          btn.addEventListener('click', () => {
            const netIdx = parseInt(btn.dataset.network);
            const testIdx = parseInt(btn.dataset.test);
            const testName = sampleData.fnon.sectionA[netIdx].tests[testIdx];
            
            const newName = prompt(`Edit test name:\n\nCurrent: "${testName}"`, testName);
            if(newName !== null && newName.trim() !== '') {
              sampleData.fnon.sectionA[netIdx].tests[testIdx] = newName.trim();
              alert(`Test updated to "${newName.trim()}" successfully!`);
              renderNetworksManagement();
              
              // Update Section A display with new test name
              const sectionAContent = document.getElementById('sectionAContent');
              if(sectionAContent) {
                const testRow = sectionAContent.querySelector(`[data-network-index="${netIdx}"] .test-row[data-test-index="${testIdx}"]`);
                if(testRow) {
                  const testText = testRow.querySelector('.test-text');
                  if(testText) {
                    testText.textContent = newName.trim();
                  }
                }
              }
            }
          });
        });
    }

    // Admin Management Panel for Section A - Setup Event Listeners
    if(currentRole === 'admin') {
      setTimeout(() => {
        const toggleEditBtn = document.getElementById('toggleEditMode');
        const addNetworkBtn = document.getElementById('addNetworkBtn');
        const managementPanel = document.getElementById('managementPanel');
        const addNetworkForm = document.getElementById('addNetworkForm');
        const confirmAddBtn = document.getElementById('confirmAddNetwork');
        const cancelAddBtn = document.getElementById('cancelAddNetwork');

        // Toggle Edit Mode button
        if(toggleEditBtn) {
          toggleEditBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const isHidden = managementPanel.classList.toggle('hidden');
            toggleEditBtn.innerHTML = isHidden ? 
              '<i class="fa-solid fa-edit mr-1"></i>Edit Mode' : 
              '<i class="fa-solid fa-check mr-1"></i>Management Active';
            if(!isHidden) {
              renderNetworksManagement();
            }
          });
        }

        // Add Network button
        if(addNetworkBtn) {
          addNetworkBtn.addEventListener('click', function(e) {
            e.preventDefault();
            addNetworkForm.classList.toggle('hidden');
            if(!addNetworkForm.classList.contains('hidden')) {
              document.getElementById('newNetworkName').focus();
            }
          });
        }

        // Confirm/Save Network button
        if(confirmAddBtn) {
          confirmAddBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const nameVal = document.getElementById('newNetworkName').value.trim();
            const signsVal = document.getElementById('newNetworkSigns').value.trim();
            const tests = Array.from(document.querySelectorAll('#newNetworkTests .test-input'))
              .map(inp => inp.value.trim())
              .filter(v => v);

            if(!nameVal || !signsVal || tests.length === 0) {
              alert('Please fill in all fields (name, signs, and at least one test)');
              return;
            }

            sampleData.fnon.sectionA.push({
              net: nameVal,
              signs: signsVal,
              tests: tests
            });

            alert(`Network "${nameVal}" added successfully!`);
            document.getElementById('newNetworkName').value = '';
            document.getElementById('newNetworkSigns').value = '';
            document.querySelectorAll('#newNetworkTests .test-input').forEach(inp => inp.value = '');
            addNetworkForm.classList.add('hidden');
            renderNetworksManagement();
            loadSection('fnon');
          });
        }

        // Dynamic Test Fields - Add/Remove functionality
        const addTestFieldBtn = document.getElementById('addTestFieldBtn');
        if(addTestFieldBtn) {
          addTestFieldBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const container = document.getElementById('testInputsContainer');
            const testCount = container.querySelectorAll('.test-input').length + 1;
            
            const newInput = document.createElement('div');
            newInput.className = 'flex gap-2 items-center';
            newInput.innerHTML = `
              <input type="text" placeholder="Test ${testCount}" class="input-royal test-input flex-1" />
              <button type="button" class="removeTestFieldBtn bg-slate-600 text-white px-2 py-1 rounded text-xs font-bold hover:bg-slate-700">
                <i class="fa-solid fa-times"></i>
              </button>
            `;
            
            container.appendChild(newInput);
            
            // Add event listener to the new remove button
            newInput.querySelector('.removeTestFieldBtn').addEventListener('click', function(e) {
              e.preventDefault();
              newInput.remove();
            });
          });
        }

        // Remove test field buttons (for initially generated ones)
        document.querySelectorAll('#testInputsContainer .removeTestFieldBtn').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.preventDefault();
            btn.closest('div').remove();
          });
        });

        // Cancel button
        if(cancelAddBtn) {
          cancelAddBtn.addEventListener('click', function(e) {
            e.preventDefault();
            addNetworkForm.classList.add('hidden');
            document.getElementById('newNetworkName').value = '';
            document.getElementById('newNetworkSigns').value = '';
            document.querySelectorAll('#newNetworkTests .test-input').forEach(inp => inp.value = '');
            // Reset to 3 default inputs
            const container = document.getElementById('testInputsContainer');
            if(container) {
              container.innerHTML = `
                <input type="text" placeholder="Test 1" class="input-royal test-input" />
                <input type="text" placeholder="Test 2" class="input-royal test-input" />
                <input type="text" placeholder="Test 3" class="input-royal test-input" />
              `;
            }
          });
        }
      }, 100);
    }
  }, 30);
}

function syncPatient(id) {
  globalSelectedPatientId = id;
  loadSection('fnon'); // Refresh
}

function calcFNON(idx) {
  let total = 0;
  // In a real app, querySelectorAll checked inputs for this section
  // Simulating sum for UI update
  const radios = document.querySelectorAll(`input[name^="n${idx}"]:checked`);
  radios.forEach(r => total += parseInt(r.value));
  document.getElementById(`s_${idx}`).innerText = total;
  const testsCount = sampleData.fnon.sectionA[idx].tests.length;
  const maxRaw = testsCount * 2; // 0..2 per question
  const normalized = maxRaw ? (total / maxRaw) * 10 : 0;
  const nEl = document.getElementById(`n_${idx}`);
  if(nEl) nEl.textContent = normalized.toFixed(1);
  updateRefTable();
  refreshFnonOverall();
}

function updateRefTable() {
  const tbody = document.getElementById('fnonRefBody');
  tbody.innerHTML = '';
  sampleData.fnon.sectionB.forEach((row, i) => {
    const scoreEl = document.getElementById(`s_${i}`);
    const score = scoreEl ? parseInt(scoreEl.innerText) : 0;
    const highlight = score > 0;
    tbody.innerHTML += `
      <tr class="${highlight ? 'fnon-highlight font-medium text-sozo-900' : ''}">
        <td>${row.net} ${highlight ? '<i class="fa-solid fa-circle-exclamation text-sozo-600 ml-2"></i>' : ''}</td>
        <td>${row.sym}</td>
        <td>${row.anat}</td>
        <td class="font-mono text-xs">${row.eeg}</td>
      </tr>
    `;
  });
}

function refreshFnonOverall() {
  // Compute average of normalized per network
  let sum = 0; let count = sampleData.fnon.sectionA.length; let highest = { label: '--', val: -1 };
  const scoreMap = {};
  sampleData.fnon.sectionA.forEach((row, i) => {
    const nEl = document.getElementById(`n_${i}`);
    const val = nEl ? parseFloat(nEl.textContent || '0') : 0;
    scoreMap[row.net] = val;
    sum += val;
    if(val > highest.val) highest = { label: row.net, val };
  });
  const avg = count ? (sum / count) : 0;
  const avgEl = document.getElementById('fnon-average');
  if(avgEl) avgEl.textContent = avg.toFixed(1);
  const highEl = document.getElementById('fnon-highest');
  if(highEl) highEl.textContent = highest.label;
  // Treatment plan suggestion
  const plan = document.getElementById('fnon-plan');
  const flagged = [];
  sampleData.fnon.sectionA.forEach((row, i) => {
    const val = scoreMap[row.net] || 0;
    if(val >= 6) flagged.push(`${row.net} (${val.toFixed(1)}/10)`);
  });
  if(plan) {
    plan.innerHTML = flagged.length ? `
      <ul class="list-disc ml-4">
        ${flagged.map(x => `<li>Focus on ${x}: 2x/week targeted training + tDCS protocol</li>`).join('')}
      </ul>
    ` : 'No elevated findings. Maintain current plan.';
  }

  fnonState = {
    scores: scoreMap,
    average: avg,
    highestLabel: highest.label,
    updatedAt: new Date().toISOString(),
    doctor: { ...selectedDoctor }
  };
  saveFnonState();
}

function attachUploadHistoryEventListeners() {
  const uploadHistoryList = document.getElementById('uploadHistoryList');
  const uploadCount = document.getElementById('uploadCount');
  const errEl = document.getElementById('doctorBrainError');
  const okEl = document.getElementById('doctorBrainSuccess');
  
  document.querySelectorAll('.replaceUploadBtn').forEach(btn => {
    btn.addEventListener('click', function() {
      const idx = parseInt(this.dataset.index);
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = '.easy,.nedf,.pdf';
      fileInput.onchange = function(e) {
        const newFile = e.target.files[0];
        if(newFile) {
          globalState.uploadHistory[idx].name = newFile.name;
          globalState.uploadHistory[idx].date = new Date().toLocaleDateString();
          globalState.uploadHistory[idx].time = new Date().toLocaleTimeString();
          attachUploadHistoryEventListeners();
          if(errEl) errEl.textContent = '';
          if(okEl) okEl.textContent = `"${newFile.name}" replaced successfully`;
          if(okEl) setTimeout(() => okEl.textContent = '', 3000);
        }
      };
      fileInput.click();
    });
  });
  
  document.querySelectorAll('.editUploadBtn').forEach(btn => {
    btn.addEventListener('click', function() {
      const idx = parseInt(this.dataset.index);
      const entry = globalState.uploadHistory[idx];
      const newName = prompt('Edit file name:', entry.name);
      if(newName && newName.trim()) {
        globalState.uploadHistory[idx].name = newName.trim();
        // Refresh the display
        if (uploadHistoryList) {
          uploadHistoryList.innerHTML = globalState.uploadHistory.map((e, i) => `
            <div class="upload-success">
              <i class="fa-solid fa-circle-check text-sozo-600"></i>
              <div class="flex-1">
                <p class="font-bold text-sm">${e.name}</p>
                <p class="text-xs text-slate-600">${e.date} at ${e.time}</p>
              </div>
              <div class="flex gap-2">
                <button class="replaceUploadBtn text-sozo-600 hover:text-slate-700 font-bold" data-index="${i}"><i class="fa-solid fa-exchange"></i></button>
                <button class="editUploadBtn text-blue-600 hover:text-blue-800 font-bold" data-index="${i}"><i class="fa-solid fa-edit"></i></button>
                <button class="deleteUploadBtn text-slate-600 hover:text-slate-700 font-bold" data-index="${i}"><i class="fa-solid fa-trash"></i></button>
              </div>
              <span class="badge badge-success">Processed</span>
            </div>
          `).join('');
          attachUploadHistoryEventListeners();
        }
      }
    });
  });
  
  document.querySelectorAll('.deleteUploadBtn').forEach(btn => {
    btn.addEventListener('click', function() {
      const idx = parseInt(this.dataset.index);
      const entry = globalState.uploadHistory[idx];
      if(confirm(`Delete "${entry.name}" from upload history?`)) {
        globalState.uploadHistory.splice(idx, 1);
        if(uploadCount) uploadCount.textContent = globalState.uploadHistory.length;
        
        if (uploadHistoryList) {
          if (globalState.uploadHistory.length === 0) {
            uploadHistoryList.innerHTML = '<p class="text-sm text-slate-500 italic">No files uploaded yet</p>';
          } else {
            uploadHistoryList.innerHTML = globalState.uploadHistory.map((e, i) => `
              <div class="upload-success">
                <i class="fa-solid fa-circle-check text-sozo-600"></i>
                <div class="flex-1">
                  <p class="font-bold text-sm">${e.name}</p>
                  <p class="text-xs text-slate-600">${e.date} at ${e.time}</p>
                </div>
                <div class="flex gap-2">
                  <button class="replaceUploadBtn text-sozo-600 hover:text-slate-700 font-bold" data-index="${i}"><i class="fa-solid fa-exchange"></i></button>
                  <button class="editUploadBtn text-blue-600 hover:text-blue-800 font-bold" data-index="${i}"><i class="fa-solid fa-edit"></i></button>
                  <button class="deleteUploadBtn text-slate-600 hover:text-slate-700 font-bold" data-index="${i}"><i class="fa-solid fa-trash"></i></button>
                </div>
                <span class="badge badge-success">Processed</span>
              </div>
            `).join('');
            attachUploadHistoryEventListeners();
          }
        }
      }
    });
  });
}

function renderBrainMap() {
  const area = document.getElementById('contentArea');
  
  // For patient role, auto-select their own patient context
  if(currentRole === 'patient' && !globalSelectedPatientId) {
    const ap = getActivePatient();
    if(ap?.id) globalSelectedPatientId = ap.id;
  }
  
  // Auto-populate patient details if globalSelectedPatientId is set
  if(globalSelectedPatientId && !globalState.currentPatient) {
    const selectedPatient = sampleData.patients.find(p => p.id === globalSelectedPatientId);
    if(selectedPatient) {
      globalState.currentPatient = selectedPatient;
    }
  }
  
  // Sync globalSelectedPatientId from globalState.currentPatient if missing
  if(!globalSelectedPatientId && globalState.currentPatient) {
    globalSelectedPatientId = globalState.currentPatient.id;
  }
  
  // Allow admin to access without patient selection
  if(!globalSelectedPatientId && currentRole !== 'admin') { 
    area.innerHTML = `<div class="p-10 text-center text-slate-400">Please select a patient in FNON Checklist first.</div>`; 
    return; 
  }
  
  const p = globalSelectedPatientId ? getActivePatient() : { name: 'No Patient Selected', email: 'N/A', country: 'N/A', id: 'N/A' };
  area.innerHTML = `
    <div class="p-8">
    ${getAssessmentNavigation('brainmapping')}
    
    <div class="mb-6 flex items-center justify-between">
      <div>
        <h2 class="text-2xl font-bold text-slate-900"><i class="fa-solid fa-brain mr-2 text-sozo-600"></i>Brain Mapping Assessment</h2>
        <p class="text-slate-600">Upload .easy or .nedf files for quantitative EEG analysis</p>
      </div>
      ${currentRole !== 'patient' && currentRole !== 'admin' ? `
      <div class="flex items-center gap-3">
        <div class="relative">
          <select id="patientNavigationSelectBrain" class="input-royal pr-10 font-bold text-slate-900 bg-white border-2 border-slate-300">
            <option value="">Select Patient...</option>
            ${sampleData.patients.map(pt => `
              <option value="${pt.id}" ${globalState.currentPatient?.id === pt.id ? 'selected' : ''}>
                ${pt.name} (${pt.id})
              </option>
            `).join('')}
          </select>
          <i class="fa-solid fa-user-group absolute right-3 top-3 text-sozo-600 pointer-events-none"></i>
        </div>
        <button onclick="loadSection('patienthistory')" class="btn-secondary text-sm" title="Back to Patient History">
          <i class="fa-solid fa-arrow-left mr-2"></i>Patient View
        </button>
      </div>
      ` : ''}
    </div>
    
    ${currentRole === 'admin' ? `
    <!-- Custom Fields Management Section (Admin Only) -->
    <div class="card p-6 mb-6 bg-gradient-to-r from-slate-50 to-slate-50 border-l-4 border-l-purple-600">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-bold text-lg text-slate-900"><i class="fa-solid fa-sliders mr-2"></i>Custom Assessment Fields Management</h3>
        <button id="addBrainMappingField" class="bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-sozo-700 transition">
          <i class="fa-solid fa-plus mr-2"></i>Add Custom Field
        </button>
      </div>
      <div id="customBrainFields" class="space-y-3">
        <p class="text-sm text-slate-500 italic">No custom fields added yet. Click "Add Custom Field" to create one.</p>
      </div>
    </div>
    ` : ''}

    <!-- Assessment Context Card -->
    <div class="card p-6 mb-6 bg-gradient-to-r from-blue-50 to-slate-50 border-l-4 border-l-blue-600">
      <h3 class="font-bold text-lg mb-4 text-slate-900"><i class="fa-solid fa-clipboard-user mr-2"></i>Assessment Context (Auto-populated from FNON)</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div class="bg-slate-100 p-3 rounded-lg">
          <p class="text-xs font-bold text-slate-500 uppercase mb-2">Doctor Information</p>
          <div class="space-y-2">
            <div>
              <label class="text-xs text-slate-600">Name:</label>
              <p class="font-bold text-sm">${getDoctorDisplay()}</p>
            </div>
            <div>
              <label class="text-xs text-slate-600">Email:</label>
              <p class="text-sm font-mono">${globalState.currentDoctor.email}</p>
            </div>
          </div>
        </div>
        <div class="bg-blue-100 p-3 rounded-lg border border-blue-300">
          <p class="text-xs font-bold text-blue-900 uppercase mb-2"><i class="fa-solid fa-user mr-1"></i>Patient Information</p>
          <div class="space-y-3">
            <div>
              <div class="flex items-center justify-between mb-1">
                <label class="text-xs text-blue-700 font-bold">Name:</label>
                <button type="button" class="editPatientField bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs font-bold transition" data-field="brainPatientName" title="Edit"><i class="fa-solid fa-edit mr-1"></i>Edit</button>
              </div>
              <input type="text" id="brainPatientName" class="input-royal bg-white w-full text-sm" value="${p.name}" readonly />
            </div>
            <div>
              <div class="flex items-center justify-between mb-1">
                <label class="text-xs text-blue-700 font-bold">Email:</label>
                <button type="button" class="editPatientField bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs font-bold transition" data-field="brainPatientEmail" title="Edit"><i class="fa-solid fa-edit mr-1"></i>Edit</button>
              </div>
              <input type="email" id="brainPatientEmail" class="input-royal bg-white w-full text-sm font-mono" value="${p.email || 'N/A'}" readonly />
            </div>
            <div>
              <div class="flex items-center justify-between mb-1">
                <label class="text-xs text-blue-700 font-bold">Country:</label>
                <button type="button" class="editPatientField bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs font-bold transition" data-field="brainPatientCountry" title="Edit"><i class="fa-solid fa-edit mr-1"></i>Edit</button>
              </div>
              <input type="text" id="brainPatientCountry" class="input-royal bg-white w-full text-sm" value="${p.country || 'N/A'}" readonly />
            </div>
            <div>
              <div class="flex items-center justify-between mb-1">
                <label class="text-xs text-blue-700 font-bold">Patient ID:</label>
                <button type="button" class="editPatientField bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs font-bold transition" data-field="brainPatientId" title="Edit"><i class="fa-solid fa-edit mr-1"></i>Edit</button>
              </div>
              <input type="text" id="brainPatientId" class="input-royal bg-white w-full text-sm font-mono" value="${p.id}" readonly />
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="card p-6 space-y-4">

      <div class="border-2 border-dashed border-slate-200 rounded-xl p-6 text-center bg-slate-50" id="doctorBrainDrop">
        <p class="font-bold text-slate-800 mb-2">Drop .easy / .nedf / .pdf files here or click to select</p>
        <p class="text-xs text-slate-500">Other formats are not accepted.</p>
        <input type="file" id="doctorBrainFile" accept=".easy,.nedf,.pdf" class="hidden" />
      </div>

      <div class="flex gap-3 flex-wrap items-center justify-between">
        <div class="flex gap-3 items-center">
          <button id="doctorBrainUploadBtn" class="bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-sozo-700 transition">
            <i class="fa-solid fa-upload mr-2"></i>Upload
          </button>
          <span id="doctorBrainError" class="text-sm text-slate-600"></span>
          <span id="doctorBrainSuccess" class="text-sm text-sozo-600"></span>
        </div>
        <button onclick="loadSection('prs')" class="bg-slate-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-slate-700 transition">
          Next: PRS Assessment <i class="fa-solid fa-arrow-right ml-2"></i>
        </button>
      </div>

      <!-- Upload History Section -->
      <div class="mt-6 border-t border-slate-200 pt-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-bold text-lg text-slate-900">Upload History</h3>
          <span class="badge badge-sozo">Files Uploaded: <span id="uploadCount">0</span></span>
        </div>
        <div id="uploadHistoryList" class="space-y-2">
          <p class="text-sm text-slate-500 italic">No files uploaded yet</p>
        </div>
      </div>
    </div>

    ${(() => {
      const customFields = globalState.customBrainFields || [];
      if (customFields.length === 0) return '';
      
      const fieldsHTML = customFields.map((field, idx) => {
        const stepAttr = field.type === 'number' ? 'step="0.01"' : '';
        return '<div><label class="text-sm font-bold text-slate-700 block mb-2">' + field.label + '</label><input type="' + field.type + '" id="customBrainFieldValue_' + idx + '" class="input-royal w-full" placeholder="' + (field.placeholder || 'Enter value...') + '" ' + stepAttr + ' /></div>';
      }).join('');
      
      return `
        <!-- Custom Assessment Fields (For All Users) -->
        <div class="card p-6 mt-6 bg-gradient-to-r from-blue-50 to-white border-l-4 border-l-blue-600">
          <div class="flex items-center gap-2 mb-4">
            <i class="fa-solid fa-star text-blue-600"></i>
            <h3 class="font-bold text-lg text-slate-900">Additional Assessment Data</h3>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            ${fieldsHTML}
          </div>
        </div>
      `;
    })()}

    <div id="doctorBottomMsg" class="fixed bottom-3 right-3 hidden bg-sozo-600 text-white px-4 py-2 rounded-lg shadow-lg">Files uploaded successfully</div>
    </div>
  `;

  setTimeout(() => {
    // Patient Navigation Dropdown for Brain Mapping
    const patientNavSelectBrain = document.getElementById('patientNavigationSelectBrain');
    if (patientNavSelectBrain) {
      patientNavSelectBrain.addEventListener('change', (e) => {
        const patientId = e.target.value;
        if (patientId) {
          const patient = sampleData.patients.find(p => p.id === patientId);
          if (patient) {
            globalSelectedPatientId = patient.id;
            globalState.currentPatient = patient;
            // Reload the Brain Mapping page with new patient
            renderBrainMap();
          }
        }
      });
    }
    
    const drop = document.getElementById('doctorBrainDrop');
    const fileInput = document.getElementById('doctorBrainFile');
    const uploadBtn = document.getElementById('doctorBrainUploadBtn');
    const errEl = document.getElementById('doctorBrainError');
    const okEl = document.getElementById('doctorBrainSuccess');
    const bottomMsg = document.getElementById('doctorBottomMsg');

    // Custom Fields Management (Admin Only)
    if (!globalState.customBrainFields) {
      globalState.customBrainFields = [];
    }

    const addFieldBtn = document.getElementById('addBrainMappingField');
    const customFieldsContainer = document.getElementById('customBrainFields');

    function renderCustomFields() {
      if (!customFieldsContainer) return; // Skip if not admin
      
      if (globalState.customBrainFields.length === 0) {
        customFieldsContainer.innerHTML = '<p class="text-sm text-slate-500 italic">No custom fields added yet. Click "Add Custom Field" to create one.</p>';
      } else {
        customFieldsContainer.innerHTML = globalState.customBrainFields.map((field, idx) => `
          <div class="bg-white p-4 rounded-lg border border-slate-200 flex items-center gap-4">
            <div class="flex-1">
              <label class="text-xs font-bold text-slate-600 block mb-1">${field.label}</label>
              <input type="${field.type}" 
                     id="customBrainField_${idx}" 
                     class="input-royal w-full" 
                     placeholder="${field.placeholder || 'Enter value...'}"
                     ${field.type === 'number' ? 'min="0" step="0.01"' : ''} />
            </div>
            <div class="flex gap-2">
              <button class="editCustomBrainField text-blue-600 hover:text-blue-800 font-bold p-2" data-index="${idx}" title="Edit Field">
                <i class="fa-solid fa-edit"></i>
              </button>
              <button class="deleteCustomBrainField text-slate-600 hover:text-slate-700 font-bold p-2" data-index="${idx}" title="Remove Field">
                <i class="fa-solid fa-trash"></i>
              </button>
            </div>
          </div>
        `).join('');

        // Attach event listeners
        document.querySelectorAll('.editCustomBrainField').forEach(btn => {
          btn.addEventListener('click', function() {
            const idx = parseInt(this.dataset.index);
            const field = globalState.customBrainFields[idx];
            const newLabel = prompt('Edit field label:', field.label);
            if (newLabel && newLabel.trim()) {
              globalState.customBrainFields[idx].label = newLabel.trim();
              renderCustomFields();
            }
          });
        });

        document.querySelectorAll('.deleteCustomBrainField').forEach(btn => {
          btn.addEventListener('click', function() {
            const idx = parseInt(this.dataset.index);
            if (confirm('Remove this custom field?')) {
              globalState.customBrainFields.splice(idx, 1);
              renderCustomFields();
            }
          });
        });
      }
    }

    if (addFieldBtn) {
      addFieldBtn.addEventListener('click', () => {
        const fieldLabel = prompt('Enter field label (e.g., "Dominant Frequency", "Alpha Wave Peak"):');
        if (!fieldLabel || !fieldLabel.trim()) return;

        const fieldType = confirm('Is this a numeric field?\n\nClick OK for Number\nClick Cancel for Text') ? 'number' : 'text';

        globalState.customBrainFields.push({
          label: fieldLabel.trim(),
          type: fieldType,
          placeholder: `Enter ${fieldLabel.trim().toLowerCase()}...`
        });

        renderCustomFields();
        okEl.textContent = `Custom field "${fieldLabel}" added successfully`;
        setTimeout(() => okEl.textContent = '', 3000);
      });

      renderCustomFields();
    }

    function resetMsgs() { errEl.textContent=''; okEl.textContent=''; }

    // Patient Fields Edit Toggle Functionality - Setup after DOM is ready
    setTimeout(() => {
      document.querySelectorAll('.editPatientField').forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          const fieldId = this.dataset.field;
          const inputField = document.getElementById(fieldId);
          const isReadonly = inputField.hasAttribute('readonly');
          
          if (isReadonly) {
            // Enable edit mode
            inputField.removeAttribute('readonly');
            inputField.classList.remove('bg-slate-100');
            inputField.classList.add('bg-white', 'border-sozo-600', 'border-2');
            this.classList.remove('bg-blue-500', 'hover:bg-blue-600');
            this.classList.add('bg-orange-500', 'hover:bg-sozo-600');
            this.innerHTML = '<i class="fa-solid fa-check mr-1"></i>Save';
            inputField.focus();
          } else {
            // Disable edit mode (Save)
            inputField.setAttribute('readonly', '');
            inputField.classList.remove('bg-white', 'border-sozo-600', 'border-2');
            inputField.classList.add('bg-slate-100');
            this.classList.remove('bg-orange-500', 'hover:bg-sozo-600');
            this.classList.add('bg-blue-500', 'hover:bg-blue-600');
            this.innerHTML = '<i class="fa-solid fa-pen-to-square mr-1"></i>Edit';
          }
        });
      });
    }, 50);

    function resetMsgs() { errEl.textContent=''; okEl.textContent=''; }

    function validateFile(file) {
      if(!file) return 'Please select a file.';
      const ext = file.name.split('.').pop().toLowerCase();
      if(!['easy','nedf','pdf'].includes(ext)) return 'Only .easy or .nedf files are allowed.';
      return '';
    }

    drop.addEventListener('click', () => fileInput.click());
    drop.addEventListener('dragover', (e) => { e.preventDefault(); drop.classList.add('bg-orange-50','border-sozo-400'); });
    drop.addEventListener('dragleave', () => drop.classList.remove('bg-orange-50','border-sozo-400'));
    drop.addEventListener('drop', (e) => {
      e.preventDefault();
      drop.classList.remove('bg-orange-50','border-sozo-400');
      if(e.dataTransfer.files?.length) fileInput.files = e.dataTransfer.files;
    });

    uploadBtn.addEventListener('click', async () => {
      resetMsgs();
      const file = fileInput.files?.[0];
      const validation = validateFile(file);
      if(validation) { errEl.textContent = validation; return; }
      
      // Add to upload history
      const uploadEntry = {
        name: file.name,
        date: new Date().toLocaleDateString(),
        time: new Date().toLocaleTimeString()
      };
      globalState.uploadHistory.push(uploadEntry);
      
      // Update upload history display
      const uploadHistoryList = document.getElementById('uploadHistoryList');
      const uploadCount = document.getElementById('uploadCount');
      if (uploadHistoryList && uploadCount) {
        uploadCount.textContent = globalState.uploadHistory.length;
        if (globalState.uploadHistory.length === 0) {
          uploadHistoryList.innerHTML = '<p class="text-sm text-slate-500 italic">No files uploaded yet</p>';
        } else {
          uploadHistoryList.innerHTML = globalState.uploadHistory.map((entry, idx) => `
            <div class="upload-success">
              <i class="fa-solid fa-circle-check text-sozo-600"></i>
              <div class="flex-1">
                <p class="font-bold text-sm">${entry.name}</p>
                <p class="text-xs text-slate-600">${entry.date} at ${entry.time}</p>
              </div>
              <div class="flex gap-2">
                <button class="replaceUploadBtn text-sozo-600 hover:text-slate-700 font-bold" data-index="${idx}"><i class="fa-solid fa-exchange"></i></button>
                <button class="editUploadBtn text-blue-600 hover:text-blue-800 font-bold" data-index="${idx}"><i class="fa-solid fa-edit"></i></button>
                <button class="deleteUploadBtn text-slate-600 hover:text-slate-700 font-bold" data-index="${idx}"><i class="fa-solid fa-trash"></i></button>
              </div>
              <span class="badge badge-success">Processed</span>
            </div>
          `).join('');
          
          // Add event listeners for replace, edit and delete buttons
          document.querySelectorAll('.replaceUploadBtn').forEach(btn => {
            btn.addEventListener('click', function() {
              const idx = parseInt(this.dataset.index);
              const fileInput = document.createElement('input');
              fileInput.type = 'file';
              fileInput.accept = '.easy,.nedf,.pdf';
              fileInput.onchange = function(e) {
                const newFile = e.target.files[0];
                if(newFile) {
                  globalState.uploadHistory[idx].name = newFile.name;
                  globalState.uploadHistory[idx].date = new Date().toLocaleDateString();
                  globalState.uploadHistory[idx].time = new Date().toLocaleTimeString();
                  attachUploadHistoryEventListeners();
                  errEl.textContent = '';
                  okEl.textContent = `"${newFile.name}" replaced successfully`;
                  setTimeout(() => okEl.textContent = '', 3000);
                }
              };
              fileInput.click();
            });
          });
          
          document.querySelectorAll('.editUploadBtn').forEach(btn => {
            btn.addEventListener('click', function() {
              const idx = parseInt(this.dataset.index);
              const entry = globalState.uploadHistory[idx];
              const newName = prompt('Edit file name:', entry.name);
              if(newName && newName.trim()) {
                globalState.uploadHistory[idx].name = newName.trim();
                // Refresh the display
                uploadHistoryList.innerHTML = globalState.uploadHistory.map((e, i) => `
                  <div class="upload-success">
                    <i class="fa-solid fa-circle-check text-sozo-600"></i>
                    <div class="flex-1">
                      <p class="font-bold text-sm">${e.name}</p>
                      <p class="text-xs text-slate-600">${e.date} at ${e.time}</p>
                    </div>
                    <div class="flex gap-2">
                      <button class="replaceUploadBtn text-sozo-600 hover:text-slate-700 font-bold" data-index="${i}"><i class="fa-solid fa-exchange"></i></button>
                      <button class="editUploadBtn text-blue-600 hover:text-blue-800 font-bold" data-index="${i}"><i class="fa-solid fa-edit"></i></button>
                      <button class="deleteUploadBtn text-slate-600 hover:text-slate-700 font-bold" data-index="${i}"><i class="fa-solid fa-trash"></i></button>
                    </div>
                    <span class="badge badge-success">Processed</span>
                  </div>
                `).join('');
                attachUploadHistoryEventListeners();
              }
            });
          });
          
          document.querySelectorAll('.deleteUploadBtn').forEach(btn => {
            btn.addEventListener('click', function() {
              const idx = parseInt(this.dataset.index);
              const entry = globalState.uploadHistory[idx];
              if(confirm(`Delete "${entry.name}" from upload history?`)) {
                globalState.uploadHistory.splice(idx, 1);
                uploadCount.textContent = globalState.uploadHistory.length;
                
                if (globalState.uploadHistory.length === 0) {
                  uploadHistoryList.innerHTML = '<p class="text-sm text-slate-500 italic">No files uploaded yet</p>';
                } else {
                  uploadHistoryList.innerHTML = globalState.uploadHistory.map((e, i) => `
                    <div class="upload-success">
                      <i class="fa-solid fa-circle-check text-sozo-600"></i>
                      <div class="flex-1">
                        <p class="font-bold text-sm">${e.name}</p>
                        <p class="text-xs text-slate-600">${e.date} at ${e.time}</p>
                      </div>
                      <div class="flex gap-2">
                        <button class="replaceUploadBtn text-sozo-600 hover:text-slate-700 font-bold" data-index="${i}"><i class="fa-solid fa-exchange"></i></button>
                        <button class="editUploadBtn text-blue-600 hover:text-blue-800 font-bold" data-index="${i}"><i class="fa-solid fa-edit"></i></button>
                        <button class="deleteUploadBtn text-slate-600 hover:text-slate-700 font-bold" data-index="${i}"><i class="fa-solid fa-trash"></i></button>
                      </div>
                      <span class="badge badge-success">Processed</span>
                    </div>
                  `).join('');
                  attachUploadHistoryEventListeners();
                }
              }
            });
          });
        }
      }
      
      okEl.textContent = 'Files uploaded successfully';
      bottomMsg.classList.remove('hidden');
      setTimeout(() => bottomMsg.classList.add('hidden'), 2500);
      setProgress('brain', 'completed');
      setProgress('prs', 'in-progress');
      fileInput.value = ''; // Clear input
      
      // Show proceed to PRS button
      const proceedBtn = document.createElement('button');
      proceedBtn.id = 'proceedToPRS';
      proceedBtn.className = 'bg-gradient-to-r from-sozo-600 to-orange-500 text-white px-6 py-3 rounded-lg font-bold hover:shadow-lg transition mt-4';
      proceedBtn.innerHTML = '<i class="fa-solid fa-arrow-right mr-2"></i>Proceed to PRS Assessment';
      proceedBtn.onclick = () => loadSection('prs');
      
      const buttonContainer = uploadBtn.parentElement;
      if(!document.getElementById('proceedToPRS')) {
        buttonContainer.appendChild(proceedBtn);
      }
    });
  }, 50);
}

function renderPRSDoctor() {
  const area = document.getElementById('contentArea');
  
  // For patient role, auto-select their own patient context
  if(currentRole === 'patient' && !globalSelectedPatientId) {
    const ap = getActivePatient();
    if(ap?.id) globalSelectedPatientId = ap.id;
  }
  
  // Auto-populate patient details if globalSelectedPatientId is set
  if(globalSelectedPatientId && !globalState.currentPatient) {
    const selectedPatient = sampleData.patients.find(p => p.id === globalSelectedPatientId);
    if(selectedPatient) {
      globalState.currentPatient = selectedPatient;
    }
  }
  
  // Sync globalSelectedPatientId from globalState.currentPatient if missing
  if(!globalSelectedPatientId && globalState.currentPatient) {
    globalSelectedPatientId = globalState.currentPatient.id;
  }
  
  // Allow admin to access without patient selection
  if(!globalSelectedPatientId && currentRole !== 'admin') { 
    area.innerHTML = `
      <div class="p-10 text-center">
        <i class="fa-solid fa-user-slash text-6xl text-slate-300 mb-4"></i>
        <p class="text-slate-400 text-lg">Please select a patient in FNON Assessment first.</p>
        <button onclick="loadSection('fnon')" class="btn-primary mt-4">Go to FNON Assessment</button>
      </div>
    `; 
    return; 
  }
  
  const p = globalSelectedPatientId ? getActivePatient() : { name: 'No Patient Selected', email: 'N/A', country: 'N/A', id: 'N/A' };
  
  // Store patient info for PRS landing to use
  globalState.prsPatientContext = {
    patientId: globalSelectedPatientId,
    patient: p
  };
  
  // Render PRS landing with navigation
  renderPRSLanding();
}

// Revenue Breakdown Data & Logic
const revenueData = {
  day: {
    subscriptions: { val: '€450', h: '40%' },
    appointments: { val: '€890', h: '75%' },
    devices: { val: '€320', h: '30%' }
  },
  week: {
    subscriptions: { val: '€2.8K', h: '55%' },
    appointments: { val: '€4.2K', h: '85%' },
    devices: { val: '€1.9K', h: '45%' }
  },
  month: {
    subscriptions: { val: '€12.5K', h: '70%' },
    appointments: { val: '€18.3K', h: '95%' },
    devices: { val: '€8.7K', h: '55%' }
  },
  quarter: {
    subscriptions: { val: '€35.2K', h: '80%' },
    appointments: { val: '€52.8K', h: '100%' },
    devices: { val: '€24.1K', h: '60%' }
  }
};

function updateRevenueBreakdown(period) {
  const data = revenueData[period];
  const container = document.getElementById('revenue-chart-container');
  if (!container) return;

  // Update buttons
  ['day', 'week', 'month', 'quarter'].forEach(p => {
    const btn = document.getElementById(`rev-btn-${p}`);
    if (btn) {
      if (p === period) {
        btn.className = "px-3 py-1 text-xs font-medium rounded-md bg-white shadow-sm text-slate-900 border border-slate-200";
      } else {
        btn.className = "px-3 py-1 text-xs font-medium rounded-md transition-all hover:bg-white hover:shadow-sm text-slate-600 border border-transparent";
      }
    }
  });

  container.innerHTML = `
    <div class="flex items-end justify-around h-56 px-4 gap-4">
      <div class="flex-1 bg-blue-500 rounded-t relative group hover:opacity-90 transition-all cursor-pointer" style="height: ${data.subscriptions.h}" title="Subscriptions">
        <span class="absolute -top-8 left-1/2 transform -translate-x-1/2 text-xs font-bold text-slate-700 whitespace-nowrap">Subscriptions</span>
      </div>
      <div class="flex-1 bg-orange-500 rounded-t relative group hover:opacity-90 transition-all cursor-pointer" style="height: ${data.appointments.h}" title="Appointments">
        <span class="absolute -top-8 left-1/2 transform -translate-x-1/2 text-xs font-bold text-slate-700 whitespace-nowrap">Appointments</span>
      </div>
      <div class="flex-1 bg-orange-500 rounded-t relative group hover:opacity-90 transition-all cursor-pointer" style="height: ${data.devices.h}" title="Devices">
        <span class="absolute -top-8 left-1/2 transform -translate-x-1/2 text-xs font-bold text-slate-700 whitespace-nowrap">Devices</span>
      </div>
    </div>
    <div class="flex justify-around mt-8 px-4 text-xs text-slate-600 font-medium">
      <span>${data.subscriptions.val}</span>
      <span>${data.appointments.val}</span>
      <span>${data.devices.val}</span>
    </div>
  `;
  // Clear date filters
  document.getElementById('revenueStartDate').value = '';
  document.getElementById('revenueEndDate').value = '';
  document.getElementById('revenueSingleDate').value = '';
}

function updateRevenueByDateRange() {
  const startDate = document.getElementById('revenueStartDate').value;
  const endDate = document.getElementById('revenueEndDate').value;
  
  if (!startDate || !endDate) {
    alert('Please select both start and end dates');
    return;
  }
  
  const container = document.getElementById('revenue-chart-container');
  if (!container) return;
  
  // Calculate days in range
  const start = new Date(startDate);
  const end = new Date(endDate);
  const daysInRange = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
  
  // Generate dynamic data based on date range for Subscriptions, Appointments, and Devices
  const subscriptionsVal = Math.floor(Math.random() * 15000 + 8000);
  const appointmentsVal = Math.floor(Math.random() * 25000 + 12000);
  const devicesVal = Math.floor(Math.random() * 10000 + 5000);
  
  const maxVal = Math.max(subscriptionsVal, appointmentsVal, devicesVal);
  
  container.innerHTML = `
    <div class="mb-3 p-3 bg-blue-50 rounded border border-blue-200">
      <p class="text-sm font-bold text-blue-900">Period: ${new Date(startDate).toLocaleDateString()} to ${new Date(endDate).toLocaleDateString()} (${daysInRange} days)</p>
    </div>
    <div class="flex items-end justify-around h-56 px-4 gap-4">
      <div class="flex-1 bg-blue-500 rounded-t relative group hover:opacity-90 transition-all cursor-pointer" style="height: ${(subscriptionsVal/maxVal)*100}%" title="Subscriptions: €${subscriptionsVal.toLocaleString()}">
        <span class="absolute -top-8 left-1/2 transform -translate-x-1/2 text-xs font-bold text-slate-700 whitespace-nowrap">Subscriptions</span>
      </div>
      <div class="flex-1 bg-orange-500 rounded-t relative group hover:opacity-90 transition-all cursor-pointer" style="height: ${(appointmentsVal/maxVal)*100}%" title="Appointments: €${appointmentsVal.toLocaleString()}">
        <span class="absolute -top-8 left-1/2 transform -translate-x-1/2 text-xs font-bold text-slate-700 whitespace-nowrap">Appointments</span>
      </div>
      <div class="flex-1 bg-orange-500 rounded-t relative group hover:opacity-90 transition-all cursor-pointer" style="height: ${(devicesVal/maxVal)*100}%" title="Devices: €${devicesVal.toLocaleString()}">
        <span class="absolute -top-8 left-1/2 transform -translate-x-1/2 text-xs font-bold text-slate-700 whitespace-nowrap">Devices</span>
      </div>
    </div>
    <div class="flex justify-around mt-8 px-4 text-xs text-slate-600 font-medium">
      <span>€${subscriptionsVal.toLocaleString()}</span>
      <span>€${appointmentsVal.toLocaleString()}</span>
      <span>€${devicesVal.toLocaleString()}</span>
    </div>
  `;
  
  // Clear single date filter
  document.getElementById('revenueSingleDate').value = '';
}

function updateRevenueByDate() {
  const selectedDate = document.getElementById('revenueSingleDate').value;
  
  if (!selectedDate) {
    alert('Please select a date');
    return;
  }
  
  const container = document.getElementById('revenue-chart-container');
  if (!container) return;
  
  // Generate random data for selected date for Subscriptions, Appointments, and Devices
  const subscriptionsVal = Math.floor(Math.random() * 4000 + 1500);
  const appointmentsVal = Math.floor(Math.random() * 6000 + 2000);
  const devicesVal = Math.floor(Math.random() * 3000 + 1000);
  
  const maxVal = Math.max(subscriptionsVal, appointmentsVal, devicesVal);
  
  container.innerHTML = `
    <div class="mb-3 p-3 bg-orange-50 rounded border border-orange-200">
      <p class="text-sm font-bold text-slate-900">Revenue Breakdown for: ${new Date(selectedDate).toLocaleDateString()}</p>
    </div>
    <div class="flex items-end justify-around h-56 px-4 gap-4">
      <div class="flex-1 bg-blue-500 rounded-t relative group hover:opacity-90 transition-all cursor-pointer" style="height: ${(subscriptionsVal/maxVal)*100}%" title="Subscriptions: €${subscriptionsVal.toLocaleString()}">
        <span class="absolute -top-8 left-1/2 transform -translate-x-1/2 text-xs font-bold text-slate-700 whitespace-nowrap">Subscriptions</span>
      </div>
      <div class="flex-1 bg-orange-500 rounded-t relative group hover:opacity-90 transition-all cursor-pointer" style="height: ${(appointmentsVal/maxVal)*100}%" title="Appointments: €${appointmentsVal.toLocaleString()}">
        <span class="absolute -top-8 left-1/2 transform -translate-x-1/2 text-xs font-bold text-slate-700 whitespace-nowrap">Appointments</span>
      </div>
      <div class="flex-1 bg-orange-500 rounded-t relative group hover:opacity-90 transition-all cursor-pointer" style="height: ${(devicesVal/maxVal)*100}%" title="Devices: €${devicesVal.toLocaleString()}">
        <span class="absolute -top-8 left-1/2 transform -translate-x-1/2 text-xs font-bold text-slate-700 whitespace-nowrap">Devices</span>
      </div>
    </div>
    <div class="flex justify-around mt-8 px-4 text-xs text-slate-600 font-medium">
      <span>€${subscriptionsVal.toLocaleString()}</span>
      <span>€${appointmentsVal.toLocaleString()}</span>
      <span>€${devicesVal.toLocaleString()}</span>
    </div>
  `;
  
  // Clear date range filters
  document.getElementById('revenueStartDate').value = '';
  document.getElementById('revenueEndDate').value = '';
}

// ==========================================
// 4A. RECEPTIONIST PORTAL (Appointment Booking)
// ==========================================
let appointmentTimeInterval = 15; // Default 15 minutes
let selectedDoctorId = null; // Track selected doctor
let calendarAppointmentFilter = 'all'; // Track calendar filter

function renderReceptionist(key) {
  const area = document.getElementById('contentArea');
  const rec = currentUser || { name: 'Receptionist', id: 'REC-001' };

  if(key === 'home') {
    // Get the selected date from localStorage or use default
    let selectedDate = localStorage.getItem('receptionistCalendarDate') || '2026-01-22';
    
    // Calendar view - Can be clinic-based or doctor-based
    const today = new Date(selectedDate);
    
    // Determine view type: clinic-based or doctor-based
    let clinicsToDisplay = [];
    let calendarTitle = 'Clinic Schedules';
    let calendarDescription = 'View clinic availability and create appointments at your preferred location';
    
    if (selectedDoctorId) {
      // Doctor-based view
      const selectedDoctor = sampleData.doctors.find(d => d.id === selectedDoctorId);
      calendarTitle = `${selectedDoctor.name} Schedule`;
      calendarDescription = `Viewing appointments for ${selectedDoctor.name} (${selectedDoctor.specialty})`;
      
      // Get clinics where this doctor works
      clinicsToDisplay = clinicLocations.filter(clinic => clinic.doctors.includes(selectedDoctorId));
    } else {
      // Clinic-based view (default)
      clinicsToDisplay = clinicLocations.slice(0, 4);
    }
    
    let html = `
      <div class="p-4 sm:p-6 lg:p-8 max-w-full overflow-hidden">
        <div class="mb-6">
          <h2 class="text-2xl sm:text-3xl font-black text-slate-900">${calendarTitle}</h2>
          <p class="text-slate-600 mt-1">${calendarDescription}</p>
        </div>
        
        <!-- Date Navigation & Doctor Selector -->
        <div class="card p-4 mb-6 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
          <div class="flex flex-wrap items-center gap-2 sm:gap-4">
            <button class="btn-secondary px-3 py-2" onclick="receptionistChangeDate(-1)" title="Previous">&larr;</button>
            <input type="date" id="calendarDate" value="${selectedDate}" class="input-royal py-2 px-3" onchange="receptionistChangeDate(0)">
            <button class="btn-secondary px-3 py-2" onclick="receptionistChangeDate(1)" title="Next">&rarr;</button>
            
            <div style="width: 1px; height: 30px; background-color: #e2e8f0; margin: 0 8px;"></div>
            
            <label class="text-sm font-bold text-slate-900">Calendar:</label>
            <select id="doctorSelect" class="input-royal py-2 px-3 w-full sm:w-56" onchange="selectDoctorView(this.value)">
              <option value="">-- All Clinics --</option>
              ${sampleData.doctors.map(d => `<option value="${d.id}" ${selectedDoctorId === d.id ? 'selected' : ''}>${d.name} (${d.specialty})</option>`).join('')}
            </select>
          </div>
          <div class="flex flex-wrap items-center gap-2">
            <button class="btn-primary px-3 sm:px-4 py-2 text-sm" onclick="loadSection('createappt')">
              <i class="fa-solid fa-plus mr-2"></i>Create Appointment
            </button>
          </div>
        </div>
        
        <!-- Time Interval Selector Dropdown -->
        <div class="mb-6 flex flex-col sm:flex-row items-start sm:items-center gap-3 sm:gap-6">
          <div class="flex items-center gap-3">
            <label class="text-sm font-bold text-slate-900">Time Interval:</label>
            <select id="timeIntervalSelect" class="input-royal py-2 px-3 w-full sm:w-40" onchange="setTimeInterval(parseInt(this.value))">
              <option value="15" ${appointmentTimeInterval === 15 ? 'selected' : ''}>15 Minutes</option>
              <option value="30" ${appointmentTimeInterval === 30 ? 'selected' : ''}>30 Minutes</option>
              <option value="45" ${appointmentTimeInterval === 45 ? 'selected' : ''}>45 Minutes</option>
              <option value="60" ${appointmentTimeInterval === 60 ? 'selected' : ''}>60 Minutes</option>
            </select>
          </div>
          
          <div class="flex items-center gap-3">
            <label class="text-sm font-bold text-slate-900">Filter:</label>
            <select id="calendarFilter" class="input-royal py-2 px-3 w-full sm:w-48" onchange="applyCalendarFilter(this.value)">
              <option value="all">-- All Appointments --</option>
              <option value="scheduled">Scheduled</option>
              <option value="confirmed">Confirmed</option>
              <option value="completed">Completed</option>
              <option value="cancelled">Cancelled</option>
              <option value="available">Available Slots Only</option>
            </select>
          </div>
        </div>
        
        <!-- Date and Doctor Info -->
        <div class="mb-4 px-4 py-2 text-center">
          <p class="text-xs font-semibold" style="color: #dc2626;">
            Date: ${selectedDate} 
            ${selectedDoctorId ? `| ${sampleData.doctors.find(d => d.id === selectedDoctorId)?.name || 'Unknown'}` : '| All Clinics'}
          </p>
        </div>
        
        <!-- Calendar Grid -->
        <div class="card overflow-x-auto p-0 border-0">
          <div class="table-scrollable">
            <table class="w-full" style="table-layout: fixed; min-width: 800px;">
              <thead>
                <tr class="bg-slate-900 text-white">
                  <th class="px-2 sm:px-4 py-3 text-left w-16 sm:w-24 sticky left-0 z-10 bg-slate-900">Time</th>
    `;
    
    // Define light background colors for clinics
    const clinicColors = {
      'CLINIC-NIK': '#dcfce7', // Light green
      'CLINIC-LIM': '#fee2e2', // Light red
      'CLINIC-LON': '#fef3c7', // Light yellow
      'CLINIC-BER': '#fed7aa'  // Light orange
    };
    
    // Add clinic columns with colors
    clinicsToDisplay.forEach(clinic => {
      const bgColor = clinicColors[clinic.id] || '#f1f5f9';
      html += `<th class="px-2 sm:px-4 py-3 text-center text-sm font-bold border-l border-slate-700 whitespace-nowrap" style="background-color: ${bgColor}; color: #1e293b;">${clinic.name}<br><span class="text-xs font-normal hidden sm:inline">${clinic.country}</span></th>`;
    });
    
    html += `
              </tr>
            </thead>
            <tbody>
    `;
    
    // Time slots (dynamic intervals from 06:00 to 22:00)
    const minuteValues = [];
    for (let mins = 0; mins < 60; mins += appointmentTimeInterval) {
      minuteValues.push(mins);
    }
    
    for (let hour = 6; hour < 22; hour++) {
      for (let min of minuteValues) {
        const timeStr = `${String(hour).padStart(2, '0')}:${String(min).padStart(2, '0')}`;
        const slotStartMinutes = hour * 60 + min;
        const slotEndMinutes = slotStartMinutes + appointmentTimeInterval;
        
        html += `<tr class="border-b border-slate-200 hover:bg-slate-50">
          <td class="px-2 sm:px-4 py-3 font-bold text-xs sm:text-sm bg-slate-100 sticky left-0 z-10">${timeStr}</td>`;
        
        clinicsToDisplay.forEach(clinic => {
          // Find appointment that overlaps with this time slot
          let appt = receptionist_appointments.find(a => {
            if (a.clinicId !== clinic.id || a.date !== selectedDate) return false;
            if (selectedDoctorId && a.doctorId !== selectedDoctorId) return false;
            
            // Parse appointment times
            const apptStartHour = parseInt(a.startTime.split(':')[0]);
            const apptStartMin = parseInt(a.startTime.split(':')[1]);
            const apptStartMinutes = apptStartHour * 60 + apptStartMin;
            
            const apptEndHour = parseInt(a.endTime.split(':')[0]);
            const apptEndMin = parseInt(a.endTime.split(':')[1]);
            const apptEndMinutes = apptEndHour * 60 + apptEndMin;
            
            // Check if appointment overlaps with this slot
            return apptStartMinutes < slotEndMinutes && apptEndMinutes > slotStartMinutes;
          });
          
          // Apply filter
          if (appt && calendarAppointmentFilter !== 'all' && calendarAppointmentFilter !== 'available') {
            if (appt.status.toLowerCase() !== calendarAppointmentFilter) {
              appt = null;
            }
          }
          
          // Handle "available slots only" filter
          if (calendarAppointmentFilter === 'available' && appt) {
            appt = null;
          }
          
          const bgColor = clinicColors[clinic.id] || '#f1f5f9';
          
          if(appt) {
            const service = appointmentServices.find(s => s.id === appt.service);
            html += `<td class="px-2 py-1 border-l border-slate-200" onclick="showAppointmentDetails('${appt.id}')" style="background-color: ${bgColor};">
              <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-2 rounded text-xs cursor-pointer hover:shadow-md transition">
                <div class="font-bold truncate">${appt.patientName}</div>
                <div class="text-xs">${service?.name || appt.service}</div>
              </div>
            </td>`;
          } else {
            html += `<td class="px-2 py-1 border-l border-slate-200" onclick="openCreateAppointmentModal('${clinic.id}', '${timeStr}', '${selectedDate}')" style="background-color: ${bgColor};">
              <div class="h-12 hover:bg-blue-100 rounded border-2 border-dashed border-slate-300 cursor-pointer transition"></div>
            </td>`;
          }
        });
        
        html += `</tr>`;
      }
    }
    
    html += `
            </tbody>
          </table>
          </div>
        </div>
        
        <!-- Legend -->
        <div class="card p-4 mt-6">
          <h4 class="font-bold text-sm mb-3">Legend</h4>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="flex items-center gap-2">
              <div class="w-6 h-6 bg-gradient-to-r from-blue-500 to-blue-600 rounded flex-shrink-0"></div>
              <span class="text-sm">Scheduled Appointment (Click to view/edit)</span>
            </div>
            <div class="flex items-center gap-2">
              <div class="w-6 h-6 bg-slate-50 border-2 border-dashed border-slate-300 rounded flex-shrink-0"></div>
              <span class="text-sm">Available Slot (Click to book)</span>
            </div>
          </div>
        </div>
      </div>
    `;
    
    area.innerHTML = html;
    
  } else if(key === 'createappt') {
    area.innerHTML = `
      <div class="p-4 sm:p-6 lg:p-8 max-w-full overflow-hidden">
        <div class="mb-6">
          <h2 class="text-2xl sm:text-3xl font-black text-slate-900">Create Appointment</h2>
          <p class="text-slate-600 mt-1">Book a new appointment for a patient</p>
        </div>
        
        <form onsubmit="submitNewAppointment(event)" class="card p-4 sm:p-6 lg:p-8">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-8">
            <!-- Left Column -->
            <div class="space-y-6">
              <!-- Clinic Selection -->
              <div>
                <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Select Clinic</label>
                <select id="appointmentClinic" class="input-royal w-full" required onchange="updateClinicDoctors()">
                  <option value="">-- Choose a clinic --</option>
                  ${clinicLocations.map(c => `<option value="${c.id}">${c.name} - ${c.country}</option>`).join('')}
                </select>
              </div>
              
              <!-- Patient Search -->
              <div>
                <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Patient Search</label>
                <div class="relative">
                  <input type="text" id="patientSearch" placeholder="Search by name, email, MRN, or ID" 
                    class="input-royal w-full" oninput="searchPatients(this.value)">
                  <div id="patientSearchResults" class="search-dropdown" style="display: none;">
                  </div>
                </div>
                <input type="hidden" id="selectedPatientId" required>
                <div id="selectedPatientDisplay" class="text-sm text-slate-600 mt-2"></div>
              </div>
              
              <!-- Selected Patient Info -->
              <div id="selectedPatientInfo" style="display: none;" class="bg-slate-50 p-4 rounded border border-slate-200">
                <h4 class="font-bold text-sm mb-3">Patient Information</h4>
                <div class="space-y-2 text-sm">
                  <div><span class="font-bold">Name:</span> <span id="pi-name"></span></div>
                  <div><span class="font-bold">Age:</span> <span id="pi-age"></span></div>
                  <div><span class="font-bold">Email:</span> <span id="pi-email"></span></div>
                  <div><span class="font-bold">Phone:</span> <span id="pi-phone"></span></div>
                </div>
              </div>
              
              <!-- Service Selection -->
              <div>
                <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Service / Session Type</label>
                <select id="appointmentService" class="input-royal w-full" required onchange="updateServiceDuration()">
                  <option value="">-- Choose service --</option>
                  ${appointmentServices.map(s => `<option value="${s.id}" data-duration="${s.duration}">${s.name} (${s.duration} min)</option>`).join('')}
                </select>
              </div>
              
              <!-- Duration (Auto-calculated) -->
              <div>
                <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Duration</label>
                <input type="text" id="appointmentDuration" class="input-royal w-full bg-slate-100" readonly placeholder="Auto-calculated">
              </div>
            </div>
            
            <!-- Right Column -->
            <div class="space-y-6">
              <!-- Date Selection -->
              <div>
                <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Date</label>
                <input type="date" id="appointmentDate" class="input-royal w-full" required onchange="updateDoctorAvailability()">
              </div>
              
              <!-- Doctor Selection (filtered by clinic) -->
              <div>
                <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Select Doctor</label>
                <select id="appointmentDoctor" class="input-royal w-full" required onchange="updateDoctorAvailability()">
                  <option value="">-- Choose a doctor --</option>
                </select>
              </div>
              
              <!-- Time Selection -->
              <div>
                <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Start Time</label>
                <select id="appointmentTime" class="input-royal w-full" required>
                  <option value="">-- Select time slot --</option>
                </select>
                <div id="availabilityWarning" class="text-xs text-orange-600 mt-1" style="display: none;"></div>
              </div>
              
              <!-- Room Selection (optional) -->
              <div>
                <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Room (Optional)</label>
                <select id="appointmentRoom" class="input-royal w-full">
                  <option value="">-- Auto-assign --</option>
                  ${['Room 101', 'Room 102', 'Room 103', 'Room 201', 'Room 202', 'Room 203'].map(r => `<option value="${r}">${r}</option>`).join('')}
                </select>
              </div>
              
              <!-- Internal Notes -->
              <div>
                <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Internal Notes (Optional)</label>
                <textarea id="appointmentNotes" class="input-royal w-full" rows="3" placeholder="Any special notes..."></textarea>
              </div>
            </div>
          </div>
          
          <!-- Action Buttons -->
          <div class="flex gap-3 mt-8 pt-6 border-t border-slate-200">
            <button type="submit" class="btn-primary px-6 py-2">
              <i class="fa-solid fa-calendar-plus mr-2"></i>Create Appointment
            </button>
            <button type="button" onclick="loadSection('home')" class="btn-secondary px-6 py-2">
              Cancel
            </button>
          </div>
        </form>
      </div>
    `;
    
    // Set today's date as default
    document.getElementById('appointmentDate').valueAsDate = new Date('2026-01-22');
    
  } else if(key === 'manageappts') {
    // Manage/view/reschedule/cancel appointments
    area.innerHTML = `
      <div class="p-4 sm:p-6 lg:p-8 max-w-full overflow-hidden">
        <div class="mb-6">
          <h2 class="text-2xl sm:text-3xl font-black text-slate-900">Manage Appointments</h2>
          <p class="text-slate-600 mt-1">View, reschedule, or cancel appointments</p>
        </div>
        
        <div class="card p-4 sm:p-6">
          <div class="table-scrollable">
            <table class="w-full">
              <thead>
                <tr class="bg-slate-100 border-b border-slate-200">
                  <th class="px-2 sm:px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase whitespace-nowrap">Date & Time</th>
                  <th class="px-2 sm:px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase whitespace-nowrap">Patient</th>
                  <th class="px-2 sm:px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase whitespace-nowrap hidden sm:table-cell">Clinic</th>
                  <th class="px-2 sm:px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase whitespace-nowrap hidden md:table-cell">Doctor</th>
                  <th class="px-2 sm:px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase whitespace-nowrap hidden lg:table-cell">Service</th>
                  <th class="px-2 sm:px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase whitespace-nowrap hidden sm:table-cell">Status</th>
                  <th class="px-2 sm:px-4 py-3 text-center text-xs font-bold text-slate-600 uppercase whitespace-nowrap">Actions</th>
                </tr>
              </thead>
              <tbody>
                ${receptionist_appointments.map(appt => {
                  const svc = appointmentServices.find(s => s.id === appt.service);
                  const doc = sampleData.doctors.find(d => d.id === appt.doctorId);
                  const clinic = clinicLocations.find(c => c.id === appt.clinicId);
                  return `
                    <tr class="border-b border-slate-200 hover:bg-slate-50">
                      <td class="px-2 sm:px-4 py-3 text-sm font-bold whitespace-nowrap">${appt.date}<br class="sm:hidden">${appt.startTime}</td>
                      <td class="px-2 sm:px-4 py-3 text-sm">${appt.patientName}</td>
                      <td class="px-2 sm:px-4 py-3 text-sm hidden sm:table-cell"><span class="font-semibold text-sozo-600">${clinic?.name || 'N/A'}</span><br><span class="text-xs text-slate-500">${clinic?.country || ''}</span></td>
                      <td class="px-2 sm:px-4 py-3 text-sm hidden md:table-cell">${doc?.name || 'N/A'}</td>
                      <td class="px-2 sm:px-4 py-3 text-sm hidden lg:table-cell">${svc?.name || appt.service}</td>
                      <td class="px-2 sm:px-4 py-3 hidden sm:table-cell"><span class="badge badge-info">${appt.status}</span></td>
                      <td class="px-2 sm:px-4 py-3 text-center">
                        <div class="flex flex-col gap-1 sm:flex-row sm:gap-2 justify-center">
                          <button class="text-xs font-bold text-blue-600 hover:underline" onclick="editAppointment('${appt.id}')">Edit</button>
                          <button class="text-xs font-bold text-slate-600 hover:underline" onclick="cancelAppointment('${appt.id}')">Cancel</button>
                        </div>
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
          </table>
        </div>
      </div>
    `;
    
  } else if(key === 'patientsearch') {
    // Advanced patient search
    area.innerHTML = `
      <div class="p-4 sm:p-6 lg:p-8 max-w-full overflow-hidden">
        <div class="mb-6">
          <h2 class="text-2xl sm:text-3xl font-black text-slate-900">Patient Search</h2>
          <p class="text-slate-600 mt-1">Search and view patient information</p>
        </div>
        
        <div class="card p-4 sm:p-8">
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
            <input type="text" id="searchName" placeholder="Name" class="input-royal" onkeyup="performPatientSearch()">
            <input type="text" id="searchEmail" placeholder="Email" class="input-royal" onkeyup="performPatientSearch()">
            <input type="text" id="searchPhone" placeholder="Phone" class="input-royal" onkeyup="performPatientSearch()">
          </div>
          
          <div id="patientSearchTable" class="mt-6">
            <div class="table-scrollable">
              <table class="w-full">
                <thead>
                  <tr class="bg-slate-100 border-b border-slate-200">
                    <th class="px-2 sm:px-4 py-3 text-left text-xs font-bold uppercase whitespace-nowrap">Name</th>
                    <th class="px-2 sm:px-4 py-3 text-left text-xs font-bold uppercase whitespace-nowrap hidden sm:table-cell">Age</th>
                    <th class="px-2 sm:px-4 py-3 text-left text-xs font-bold uppercase whitespace-nowrap hidden md:table-cell">Email</th>
                    <th class="px-2 sm:px-4 py-3 text-left text-xs font-bold uppercase whitespace-nowrap">Phone</th>
                    <th class="px-2 sm:px-4 py-3 text-left text-xs font-bold uppercase whitespace-nowrap hidden lg:table-cell">Status</th>
                    <th class="px-2 sm:px-4 py-3 text-center text-xs font-bold uppercase whitespace-nowrap">Action</th>
                  </tr>
                </thead>
              <tbody>
                ${sampleData.patients.map(p => `
                  <tr class="border-b border-slate-200 hover:bg-slate-50">
                    <td class="px-2 sm:px-4 py-3 text-sm font-bold">${p.name}</td>
                    <td class="px-2 sm:px-4 py-3 text-sm hidden sm:table-cell">${p.age}</td>
                    <td class="px-2 sm:px-4 py-3 text-sm hidden md:table-cell">${p.email}</td>
                    <td class="px-2 sm:px-4 py-3 text-sm">${p.mobile}</td>
                    <td class="px-2 sm:px-4 py-3 hidden lg:table-cell"><span class="badge badge-success">${p.status}</span></td>
                    <td class="px-2 sm:px-4 py-3 text-center">
                      <button class="text-xs font-bold text-blue-600 hover:underline" onclick="selectPatientForAppointment('${p.id}')">Book Appointment</button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    `;
    
  } else if(key === 'doctorsearch') {
    // Doctor search page
    area.innerHTML = `
      <div class="p-4 sm:p-6 lg:p-8 max-w-full overflow-hidden">
        <div class="mb-6">
          <h2 class="text-2xl sm:text-3xl font-black text-slate-900">Doctor Search</h2>
          <p class="text-slate-600 mt-1">Search and view doctor information</p>
        </div>
        
        <div class="card p-4 sm:p-8">
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
            <input type="text" id="searchDoctorName" placeholder="Doctor Name" class="input-royal" onkeyup="performDoctorSearch()">
            <select id="searchDoctorSpecialty" class="input-royal" onchange="performDoctorSearch()">
              <option value="">-- All Specialties --</option>
              <option value="Neurologist">Neurologist</option>
              <option value="Psychiatrist">Psychiatrist</option>
              <option value="Clinical Psychologist">Clinical Psychologist</option>
              <option value="Neuroscientist">Neuroscientist</option>
              <option value="Specialist">Specialist</option>
            </select>
            <select id="searchDoctorClinic" class="input-royal" onchange="performDoctorSearch()">
              <option value="">-- All Clinics --</option>
              ${clinicLocations.map(c => `<option value="${c.id}">${c.name} (${c.country})</option>`).join('')}
            </select>
          </div>
          
          <div id="doctorSearchTable" class="mt-6">
            <div class="table-scrollable">
              <table class="w-full">
                <thead>
                  <tr class="bg-slate-100 border-b border-slate-200">
                    <th class="px-2 sm:px-4 py-3 text-left text-xs font-bold uppercase whitespace-nowrap">Name</th>
                    <th class="px-2 sm:px-4 py-3 text-left text-xs font-bold uppercase whitespace-nowrap hidden md:table-cell">Specialty</th>
                    <th class="px-2 sm:px-4 py-3 text-left text-xs font-bold uppercase whitespace-nowrap hidden lg:table-cell">Clinics</th>
                    <th class="px-2 sm:px-4 py-3 text-left text-xs font-bold uppercase whitespace-nowrap hidden sm:table-cell">Email</th>
                    <th class="px-2 sm:px-4 py-3 text-left text-xs font-bold uppercase whitespace-nowrap">Phone</th>
                    <th class="px-2 sm:px-4 py-3 text-center text-xs font-bold uppercase whitespace-nowrap">Action</th>
                  </tr>
                </thead>
              <tbody>
                ${sampleData.doctors.map(d => {
                  const doctorClinics = clinicLocations.filter(c => c.doctors.includes(d.id));
                  return `
                    <tr class="border-b border-slate-200 hover:bg-slate-50">
                      <td class="px-2 sm:px-4 py-3 text-sm font-bold">${d.name}</td>
                      <td class="px-2 sm:px-4 py-3 text-sm hidden md:table-cell"><span class="badge badge-warning">${d.specialty}</span></td>
                      <td class="px-2 sm:px-4 py-3 text-sm hidden lg:table-cell">${doctorClinics.map(c => c.name).join(', ')}</td>
                      <td class="px-2 sm:px-4 py-3 text-sm hidden sm:table-cell">${d.email || 'N/A'}</td>
                      <td class="px-2 sm:px-4 py-3 text-sm">${d.phone || 'N/A'}</td>
                      <td class="px-2 sm:px-4 py-3 text-center">
                        <button class="text-xs font-bold text-blue-600 hover:underline" onclick="viewDoctorSchedule('${d.id}')">View Schedule</button>
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    `;
    
  } else if(key === 'profile') {
    // Receptionist profile
    area.innerHTML = `
      <div class="p-4 sm:p-6 lg:p-8 max-w-full overflow-hidden">
        <div class="mb-6">
          <h2 class="text-2xl sm:text-3xl font-black text-slate-900">My Profile</h2>
          <p class="text-slate-600 mt-1">Receptionist information and settings</p>
        </div>
        
        <div class="card p-4 sm:p-6 lg:p-8">
          <div class="flex flex-col sm:flex-row items-start gap-4 sm:gap-8">
            <div class="w-20 h-20 sm:w-32 sm:h-32 rounded-full bg-gradient-to-br from-orange-500 to-orange-600 flex items-center justify-center text-white flex-shrink-0">
              <i class="fa-solid fa-user text-3xl sm:text-5xl"></i>
            </div>
            <div class="flex-1 min-w-0">
              <h3 class="text-xl sm:text-2xl font-bold text-slate-900">${rec.name}</h3>
              <p class="text-slate-600 mt-1">Receptionist</p>
              <div class="mt-4 space-y-2 text-sm">
                <div class="break-words"><span class="font-bold">ID:</span> ${rec.id}</div>
                <div class="break-words"><span class="font-bold">Email:</span> ${rec.email}</div>
                <div><span class="font-bold">Clinic:</span> ${rec.clinic || 'SOZO Brain Center'}</div>
                <div><span class="font-bold">Country:</span> ${rec.country || 'Germany'}</div>
              </div>
            </div>
          </div>
          
          <div class="mt-8 pt-8 border-t border-slate-200">
            <h4 class="font-bold text-lg mb-4">Permissions</h4>
            <div class="space-y-2 text-sm">
              <div class="flex items-center gap-2"><i class="fa-solid fa-check text-sozo-600"></i><span>View all doctors' calendars</span></div>
              <div class="flex items-center gap-2"><i class="fa-solid fa-check text-sozo-600"></i><span>Create and manage appointments</span></div>
              <div class="flex items-center gap-2"><i class="fa-solid fa-check text-sozo-600"></i><span>Search and view patient demographic info</span></div>
              <div class="flex items-center gap-2"><i class="fa-solid fa-ban text-slate-600"></i><span>Cannot access patient medical records</span></div>
              <div class="flex items-center gap-2"><i class="fa-solid fa-ban text-slate-600"></i><span>Cannot modify doctor profiles or availability</span></div>
              <div class="flex items-center gap-2"><i class="fa-solid fa-ban text-slate-600"></i><span>Cannot access admin configurations</span></div>
            </div>
          </div>
        </div>
      </div>
    `;
  }
}

// Receptionist Helper Functions
function searchPatients(query) {
  const resultsDiv = document.getElementById('patientSearchResults');
  if (!query || query.length < 2) {
    resultsDiv.style.display = 'none';
    return;
  }
  
  const filtered = sampleData.patients.filter(p => 
    p.name.toLowerCase().includes(query.toLowerCase()) ||
    p.email.toLowerCase().includes(query.toLowerCase()) ||
    (p.id && p.id.toLowerCase().includes(query.toLowerCase()))
  );
  
  if (filtered.length === 0) {
    resultsDiv.innerHTML = '<div class="px-3 py-2 text-sm text-slate-600">No patients found</div>';
  } else {
    resultsDiv.innerHTML = filtered.map(p => `
      <div class="search-dropdown-item" onclick="selectReceptionistPatient('${p.id}', '${p.name}', '${p.email}', ${p.age}, '${p.mobile}')">
        <div class="font-bold text-sm">${p.name}</div>
        <div class="text-xs text-slate-600">${p.email} • ${p.id}</div>
      </div>
    `).join('');
  }
  resultsDiv.style.display = 'block';
}

function selectReceptionistPatient(patientId, name, email, age, phone) {
  document.getElementById('selectedPatientId').value = patientId;
  document.getElementById('patientSearch').value = name;
  document.getElementById('patientSearchResults').style.display = 'none';
  
  // Show patient info
  document.getElementById('selectedPatientInfo').style.display = 'block';
  document.getElementById('pi-name').textContent = name;
  document.getElementById('pi-age').textContent = age;
  document.getElementById('pi-email').textContent = email;
  document.getElementById('pi-phone').textContent = phone;
}

function updateServiceDuration() {
  const select = document.getElementById('appointmentService');
  const selectedOption = select.options[select.selectedIndex];
  const duration = selectedOption.getAttribute('data-duration');
  document.getElementById('appointmentDuration').value = duration ? `${duration} minutes` : '';
}

function updateClinicDoctors() {
  // Update doctor dropdown based on selected clinic
  const clinicId = document.getElementById('appointmentClinic').value;
  const doctorSelect = document.getElementById('appointmentDoctor');
  
  if (!clinicId) {
    doctorSelect.innerHTML = '<option value="">-- Choose a doctor --</option>';
    return;
  }
  
  const clinic = clinicLocations.find(c => c.id === clinicId);
  if (!clinic) return;
  
  const clinicDoctors = sampleData.doctors.filter(d => clinic.doctors.includes(d.id));
  
  doctorSelect.innerHTML = '<option value="">-- Choose a doctor --</option>' +
    clinicDoctors.map(d => `<option value="${d.id}">${d.name} (${d.specialty})</option>`).join('');
}

function updateDoctorAvailability() {
  // Generate time slots based on doctor's schedule
  const doctorId = document.getElementById('appointmentDoctor').value;
  const date = document.getElementById('appointmentDate').value;
  const timeSelect = document.getElementById('appointmentTime');
  
  if (!doctorId || !date) {
    timeSelect.innerHTML = '<option value="">-- Select time slot --</option>';
    return;
  }
  
  // Generate slots based on selected interval (dynamic)
  const slots = [];
  const minuteValues = [];
  for (let mins = 0; mins < 60; mins += appointmentTimeInterval) {
    minuteValues.push(mins);
  }
  
  for (let hour = 6; hour < 22; hour++) {
    for (let min of minuteValues) {
      const time = `${String(hour).padStart(2, '0')}:${String(min).padStart(2, '0')}`;
      slots.push(time);
    }
  }
  
  timeSelect.innerHTML = '<option value="">-- Select time slot --</option>' +
    slots.map(slot => `<option value="${slot}">${slot}</option>`).join('');
}

function submitNewAppointment(e) {
  e.preventDefault();
  
  const clinicId = document.getElementById('appointmentClinic').value;
  const patientId = document.getElementById('selectedPatientId').value;
  const doctorId = document.getElementById('appointmentDoctor').value;
  const serviceId = document.getElementById('appointmentService').value;
  const date = document.getElementById('appointmentDate').value;
  const startTime = document.getElementById('appointmentTime').value;
  const room = document.getElementById('appointmentRoom').value || 'Auto-assigned';
  const notes = document.getElementById('appointmentNotes').value;
  
  if (!clinicId || !patientId || !doctorId || !serviceId || !date || !startTime) {
    alert('Please fill in all required fields including clinic selection');
    return;
  }
  
  // Get patient, clinic, doctor and service info
  const patient = sampleData.patients.find(p => p.id === patientId);
  const clinic = clinicLocations.find(c => c.id === clinicId);
  const doctor = sampleData.doctors.find(d => d.id === doctorId);
  const service = appointmentServices.find(s => s.id === serviceId);
  
  // Check for conflicts
  const conflict = receptionist_appointments.find(a => 
    a.clinicId === clinicId &&
    a.doctorId === doctorId && 
    a.date === date && 
    a.startTime === startTime
  );
  
  if (conflict) {
    alert('This time slot is already booked at this clinic. Please select another time.');
    return;
  }
  
  // Create appointment
  const newAppt = {
    id: `APPT-${Date.now()}`,
    clinicId: clinicId,
    clinicName: clinic.name,
    doctorId: doctorId,
    patientId: patientId,
    patientName: patient.name,
    doctorName: doctor.name,
    date: date,
    startTime: startTime,
    endTime: calculateEndTime(startTime, service.duration),
    service: serviceId,
    room: room,
    status: 'Scheduled',
    notes: notes
  };
  
  receptionist_appointments.push(newAppt);
  alert(`Appointment created successfully!\\nPatient: ${patient.name}\\nClinic: ${clinic.name}\\nDate: ${date} at ${startTime}`);
  loadSection('home');
}

function calculateEndTime(startTime, duration) {
  const [hours, mins] = startTime.split(':').map(Number);
  const totalMins = hours * 60 + mins + duration;
  const endHours = Math.floor(totalMins / 60);
  const endMins = totalMins % 60;
  return `${String(endHours).padStart(2, '0')}:${String(endMins).padStart(2, '0')}`;
}

function openCreateAppointmentModal(clinicId, startTime, date) {
  loadSection('createappt');
  setTimeout(() => {
    document.getElementById('appointmentClinic').value = clinicId;
    document.getElementById('appointmentDate').value = date;
    document.getElementById('appointmentTime').value = startTime;
    document.getElementById('appointmentClinic').dispatchEvent(new Event('change'));
  }, 100);
}

function showAppointmentDetails(apptId) {
  const appt = receptionist_appointments.find(a => a.id === apptId);
  if (!appt) return;
  
  const svc = appointmentServices.find(s => s.id === appt.service);
  alert(`Appointment Details\\n\\nPatient: ${appt.patientName}\\nService: ${svc?.name}\\nDate: ${appt.date}\\nTime: ${appt.startTime} - ${appt.endTime}\\nRoom: ${appt.room}\\nStatus: ${appt.status}\\nNotes: ${appt.notes || 'None'}`);
}

function selectPatientForAppointment(patientId) {
  loadSection('createappt');
  setTimeout(() => {
    const patient = sampleData.patients.find(p => p.id === patientId);
    if (patient) {
      selectReceptionistPatient(patient.id, patient.name, patient.email, patient.age, patient.mobile);
    }
  }, 100);
}

function editAppointment(apptId) {
  alert('Edit appointment: ' + apptId + ' - Coming soon');
}

function cancelAppointment(apptId) {
  if (confirm('Are you sure you want to cancel this appointment?')) {
    const idx = receptionist_appointments.findIndex(a => a.id === apptId);
    if (idx >= 0) {
      receptionist_appointments.splice(idx, 1);
      alert('Appointment cancelled successfully');
      loadSection('manageappts');
    }
  }
}

function setTimeInterval(interval) {
  appointmentTimeInterval = interval;
  loadSection('home');
}

function applyCalendarFilter(filterValue) {
  calendarAppointmentFilter = filterValue;
  loadSection('home');
}

function selectDoctorView(doctorId) {
  selectedDoctorId = doctorId ? doctorId : null;
  loadSection('home');
}

function receptionistChangeDate(offset) {
  const dateInput = document.getElementById('calendarDate');
  const currentDate = new Date(dateInput.value);
  currentDate.setDate(currentDate.getDate() + offset);
  dateInput.value = currentDate.toISOString().split('T')[0];
  localStorage.setItem('receptionistCalendarDate', dateInput.value);
  loadSection('home');
}

function performPatientSearch() {
  // Perform search based on input fields
  const name = document.getElementById('searchName').value.toLowerCase();
  const email = document.getElementById('searchEmail').value.toLowerCase();
  const phone = document.getElementById('searchPhone').value.toLowerCase();
  
  const filtered = sampleData.patients.filter(p => 
    (!name || p.name.toLowerCase().includes(name)) &&
    (!email || p.email.toLowerCase().includes(email)) &&
    (!phone || p.mobile.toLowerCase().includes(phone))
  );
  
  // Update table (if needed, re-render the table here)
}

function performDoctorSearch() {
  // Perform search based on input fields
  const name = document.getElementById('searchDoctorName').value.toLowerCase();
  const specialty = document.getElementById('searchDoctorSpecialty').value;
  const clinic = document.getElementById('searchDoctorClinic').value;
  
  const filtered = sampleData.doctors.filter(d => {
    const matchesName = !name || d.name.toLowerCase().includes(name);
    const matchesSpecialty = !specialty || d.specialty === specialty;
    const matchesClinic = !clinic || clinicLocations.find(c => c.id === clinic && c.doctors.includes(d.id));
    return matchesName && matchesSpecialty && matchesClinic;
  });
  
  // Update table (if needed, re-render the table here)
}

function viewDoctorSchedule(doctorId) {
  // Set doctor filter and go to calendar view
  selectedDoctorId = doctorId;
  loadSection('home');
}

function selectPatientForAppointment(patientId) {
  // Navigate to create appointment with pre-selected patient
  loadSection('createappt');
  setTimeout(() => {
    const patient = sampleData.patients.find(p => p.id === patientId);
    if (patient) {
      selectReceptionistPatient(patientId, patient.name, patient.email, patient.age, patient.mobile);
    }
  }, 100);
}

// ==========================================
// 5. ADMIN PORTAL (ERP)
// ==========================================
function renderAdmin(key) {
  const area = document.getElementById('contentArea');
  
  if (key === 'dashboard') {
    // Calculate dynamic values from actual data
    const totalPatients = 120000;
    const totalDoctors = 250;
    const activeDoctors = 225;
    const inactiveDoctors = totalDoctors - activeDoctors;
    const activePartnerships = 6;
    
    // Calculate monthly profit from finance data
    const currentMonth = new Date().getMonth();
    const currentYear = new Date().getFullYear();
    const monthlyProfit = 1600000;
    const monthlyProfitFormatted = '€1.6M';
    
    // Calculate average health score properly
    const patientsWithScore = sampleData.patients.filter(p => p.healthScore && p.healthScore > 0);
    const avgHealthScore = patientsWithScore.length > 0 
      ? Math.round(patientsWithScore.reduce((sum, p) => sum + p.healthScore, 0) / patientsWithScore.length)
      : 75;
    
    const deviceInventory = 8;
    
    // Calculate total revenue from finance data
    const totalRevenue = sampleData.finance?.totalRev || 50000;
    const totalRevenueFormatted = '€' + (totalRevenue / 1000000).toFixed(1) + 'M';
    
    // Calculate workshops count
    const workshopsCount = 40;
    
    // Calculate Monthly Revenue Expectation
    const expectedMonthlyRevenue = 9718500; // Updated monthly revenue expectation
    const expectedMonthlyRevenueFormatted = '€97,180';
    const currentMonthRevenue = 845000;
    const currentMonthRevenueFormatted = '€84,500';
    
    const kpis = [
      {l:'Total Patients', v:totalPatients.toLocaleString(), i:'fa-users', c:'blue'},
      {l:'Monthly Profit', v:monthlyProfitFormatted, i:'fa-chart-line', c:'green'},
      {l:'Total Doctors', v:totalDoctors.toString(), i:'fa-user-doctor', c:'slate'},
      {l:'Active Doctors', v:activeDoctors.toString(), i:'fa-check-circle', c:'emerald'},
      {l:'Inactive Doctors', v:inactiveDoctors.toString(), i:'fa-circle-xmark', c:'red'},
      {l:'Device Inventory', v:deviceInventory.toString(), i:'fa-microchip', c:'cyan'},
      {l:'Total Revenue', v:totalRevenueFormatted, i:'fa-sack-dollar', c:'sozo'},
      {l:'Workshops', v:workshopsCount.toString(), i:'fa-chalkboard-user', c:'purple'},
      {l:'Active Partnerships', v:activePartnerships.toString(), i:'fa-handshake', c:'indigo'}
    ];
    area.innerHTML = `
      <div class="p-8">
      <div class="mb-10">
        <h2 class="text-3xl font-bold text-slate-900">Enterprise Overview</h2>
        <p class="text-slate-600 text-sm mt-1">Real-time business metrics and system performance</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-10">
        ${kpis.map(k => {
          const bgClass = k.c === 'sozo' ? 'bg-orange-50 text-orange-600' : k.c === 'blue' ? 'bg-blue-50 text-blue-600' : k.c === 'green' ? 'bg-orange-50 text-sozo-600' : k.c === 'emerald' ? 'bg-orange-50 text-sozo-600' : k.c === 'purple' ? 'bg-slate-50 text-sozo-600' : k.c === 'red' ? 'bg-slate-50 text-slate-600' : k.c === 'slate' ? 'bg-slate-100 text-slate-600' : k.c === 'orange' ? 'bg-orange-50 text-orange-500' : k.c === 'cyan' ? 'bg-blue-50 text-brand-blue' : 'bg-blue-50 text-brand-blue';
          return `
            <div class="kpi-card">
              <div class="kpi-icon ${bgClass}"><i class="fa-solid ${k.i}"></i></div>
              <div>
                <div class="kpi-label">${k.l}</div>
                <div class="kpi-value">${k.v}</div>
              </div>
            </div>
          `;
        }).join('')}
      </div>
      
      <!-- Monthly Revenue Expectation Widget -->
      <div class="card p-6 mb-10 bg-gradient-to-r from-orange-50 to-orange-100 border-2 border-orange-200">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-4">
            <div class="bg-orange-500 text-white p-4 rounded-xl">
              <i class="fa-solid fa-chart-line-up text-3xl"></i>
            </div>
            <div>
              <h3 class="text-lg font-bold text-slate-900">Monthly Revenue Expectation</h3>
              <p class="text-xs text-slate-600 mt-1">Projected revenue based on current trends & growth rate</p>
            </div>
          </div>
          <div class="text-right">
            <div class="text-4xl font-bold text-sozo-600">${expectedMonthlyRevenueFormatted}</div>
            <div class="text-xs text-slate-600 mt-1 flex items-center justify-end gap-1">
              <span class="bg-orange-500 text-white px-2 py-1 rounded font-bold">+15%</span>
              <span>projected growth</span>
            </div>
          </div>
        </div>
        <div class="mt-4 pt-4 border-t border-orange-200">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-center">
            <div>
              <div class="text-xs text-slate-600 uppercase font-bold mb-1">Current Month</div>
              <div class="text-lg font-bold text-slate-900">€2.0M</div>
            </div>
            <div>
              <div class="text-xs text-slate-600 uppercase font-bold mb-1">Expected</div>
              <div class="text-lg font-bold text-sozo-600">€2.6M</div>
            </div>
            <div>
              <div class="text-xs text-slate-600 uppercase font-bold mb-1">Growth Rate</div>
              <div class="text-lg font-bold text-sozo-600">Good</div>
            </div>
            <div>
              <div class="text-xs text-slate-600 uppercase font-bold mb-1">Confidence</div>
              <div class="text-lg font-bold text-blue-600">High</div>
            </div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="card p-6">
          <div class="mb-6">
            <div class="flex justify-between items-start mb-4">
              <div>
                <h3 class="text-lg font-bold text-slate-900">Revenue Breakdown</h3>
                <p class="text-xs text-slate-500 mt-1">Revenue by category</p>
              </div>
              <div class="flex bg-slate-100 rounded-lg p-1">
                 <button onclick="updateRevenueBreakdown('day')" class="px-3 py-1 text-xs font-medium rounded-md transition-all hover:bg-white hover:shadow-sm text-slate-600 border border-transparent" id="rev-btn-day">Day</button>
                 <button onclick="updateRevenueBreakdown('week')" class="px-3 py-1 text-xs font-medium rounded-md transition-all hover:bg-white hover:shadow-sm text-slate-600 border border-transparent" id="rev-btn-week">Week</button>
                 <button onclick="updateRevenueBreakdown('month')" class="px-3 py-1 text-xs font-medium rounded-md bg-white shadow-sm text-slate-900 border border-slate-200" id="rev-btn-month">Month</button>
                 <button onclick="updateRevenueBreakdown('quarter')" class="px-3 py-1 text-xs font-medium rounded-md transition-all hover:bg-white hover:shadow-sm text-slate-600 border border-transparent" id="rev-btn-quarter">Last 3M</button>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">Start Date</label>
                <input type="date" id="revenueStartDate" class="input-royal w-full" onchange="updateRevenueByDateRange()">
              </div>
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">End Date</label>
                <input type="date" id="revenueEndDate" class="input-royal w-full" onchange="updateRevenueByDateRange()">
              </div>
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">Or Select Date</label>
                <input type="date" id="revenueSingleDate" class="input-royal w-full" onchange="updateRevenueByDate()">
              </div>
            </div>
          </div>
          <div id="revenue-chart-container">
            <div class="flex items-end justify-around h-56 px-4 gap-4">
              <div class="flex-1 bg-blue-500 rounded-t relative group hover:opacity-90 transition-all cursor-pointer" style="height: 70%" title="Subscriptions">
                <span class="absolute -top-8 left-1/2 transform -translate-x-1/2 text-xs font-bold text-slate-700 whitespace-nowrap">Subscriptions</span>
              </div>
              <div class="flex-1 bg-orange-500 rounded-t relative group hover:opacity-90 transition-all cursor-pointer" style="height: 95%" title="Appointments">
                <span class="absolute -top-8 left-1/2 transform -translate-x-1/2 text-xs font-bold text-slate-700 whitespace-nowrap">Appointments</span>
              </div>
              <div class="flex-1 bg-orange-500 rounded-t relative group hover:opacity-90 transition-all cursor-pointer" style="height: 55%" title="Devices">
                <span class="absolute -top-8 left-1/2 transform -translate-x-1/2 text-xs font-bold text-slate-700 whitespace-nowrap">Devices</span>
              </div>
            </div>
            <div class="flex justify-around mt-8 px-4 text-xs text-slate-600 font-medium">
              <span>€12.5K</span>
              <span>€18.3K</span>
              <span>€8.7K</span>
            </div>
          </div>
        </div>

        <div class="card p-6">
          <div class="mb-6">
            <h3 class="text-lg font-bold text-slate-900">System Status</h3>
            <p class="text-xs text-slate-500 mt-1">Platform health and performance</p>
          </div>
          <div class="space-y-5">
            <div class="flex items-center justify-between">
              <span class="text-sm text-slate-700 font-medium">Uptime</span>
              <span class="text-sm text-sozo-600 font-bold">99.99%</span>
            </div>
            <div class="w-full bg-slate-200 rounded-full h-2">
              <div class="bg-orange-500 h-2 rounded-full" style="width: 99.99%"></div>
            </div>

            <div class="flex items-center justify-between mt-5">
              <span class="text-sm text-slate-700 font-medium">Database</span>
              <span class="text-sm text-sozo-600 font-bold">Healthy</span>
            </div>
            <p class="text-xs text-slate-500">200k+ records, optimal performance</p>

            <div class="flex items-center justify-between mt-5">
              <span class="text-sm text-slate-700 font-medium">Active Employees</span>
              <span class="text-lg font-bold text-slate-900">45</span>
            </div>
          </div>
        </div>
      </div>
      </div>
    `;

    // Initialize Today's Schedule filtering and sorting
    setTimeout(() => {
      const adminScheduleData = [
        { time: '08:00 AM', timeValue: 800, patient: 'Robert Martinez', doctor: 'Dr. Smith', room: 'Room 101', roomNum: 101, type: 'Initial Consultation', status: 'Completed' },
        { time: '08:30 AM', timeValue: 830, patient: 'Jennifer Davis', doctor: 'Dr. Johnson', room: 'Room 205', roomNum: 205, type: 'Follow-up', status: 'Completed' },
        { time: '09:00 AM', timeValue: 900, patient: 'William Garcia', doctor: 'Dr. Wilson', room: 'Room 102', roomNum: 102, type: 'FNON Assessment', status: 'Completed' },
        { time: '10:00 AM', timeValue: 1000, patient: 'Patricia Lee', doctor: 'Dr. Chen', room: 'Room 304', roomNum: 304, type: 'Cognitive Assessment', status: 'In Progress' },
        { time: '11:30 AM', timeValue: 1130, patient: 'Christopher White', doctor: 'Dr. Smith', room: 'Room 101', roomNum: 101, type: 'Brain Mapping', status: 'Scheduled' },
        { time: '01:00 PM', timeValue: 1300, patient: 'Amanda Harris', doctor: 'Dr. Johnson', room: 'Room 205', roomNum: 205, type: 'PRS Assessment', status: 'Scheduled' },
        { time: '02:30 PM', timeValue: 1430, patient: 'Thomas Wilson', doctor: 'Dr. Wilson', room: 'Room 102', roomNum: 102, type: 'Treatment Review', status: 'Scheduled' },
        { time: '03:00 PM', timeValue: 1500, patient: 'Margaret Taylor', doctor: 'Dr. Chen', room: 'Room 304', roomNum: 304, type: 'Follow-up', status: 'Scheduled' },
        { time: '04:30 PM', timeValue: 1630, patient: 'Kevin Anderson', doctor: 'Dr. Smith', room: 'Room 101', roomNum: 101, type: 'Initial Consultation', status: 'Scheduled' },
        { time: '05:00 PM', timeValue: 1700, patient: 'Nancy Thomas', doctor: 'Dr. Johnson', room: 'Room 205', roomNum: 205, type: 'Final Report Review', status: 'Scheduled' }
      ];

      let currentSearch = '';
      let currentStatusFilter = '';
      let currentSort = 'time';

      const tbody = document.getElementById('adminScheduleTableBody');
      const searchInput = document.getElementById('adminScheduleSearch');
      const statusFilter = document.getElementById('adminScheduleStatusFilter');
      const sortSelect = document.getElementById('adminScheduleSort');
      const clearBtn = document.getElementById('adminScheduleClearFilters');
      const resultCount = document.getElementById('adminScheduleResultCount');
      const totalCount = document.getElementById('adminScheduleTotalCount');

      if (!tbody || !searchInput || !statusFilter || !sortSelect) return;

      function renderAdminSchedule() {
        let filteredData = adminScheduleData.filter(item => {
          const matchesSearch = !currentSearch || 
            item.patient.toLowerCase().includes(currentSearch.toLowerCase()) ||
            item.doctor.toLowerCase().includes(currentSearch.toLowerCase()) ||
            item.room.toLowerCase().includes(currentSearch.toLowerCase()) ||
            item.type.toLowerCase().includes(currentSearch.toLowerCase());
          
          const matchesStatus = !currentStatusFilter || item.status === currentStatusFilter;
          
          return matchesSearch && matchesStatus;
        });

        filteredData.sort((a, b) => {
          switch(currentSort) {
            case 'time':
              return a.timeValue - b.timeValue;
            case 'time-desc':
              return b.timeValue - a.timeValue;
            case 'patient':
              return a.patient.localeCompare(b.patient);
            case 'patient-desc':
              return b.patient.localeCompare(a.patient);
            case 'doctor':
              return a.doctor.localeCompare(b.doctor);
            case 'room':
              return a.roomNum - b.roomNum;
            case 'type':
              return a.type.localeCompare(b.type);
            case 'status':
              return a.status.localeCompare(b.status);
            default:
              return 0;
          }
        });

        resultCount.textContent = 'Showing ' + filteredData.length + ' of ' + adminScheduleData.length + ' appointments';
        totalCount.textContent = adminScheduleData.length + ' appointments across all doctors today';

        if (filteredData.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="py-8 text-center text-slate-500">No appointments found matching your filters</td></tr>';
        } else {
          tbody.innerHTML = filteredData.map(item => {
            const isInProgress = item.status === 'In Progress';
            const isCompleted = item.status === 'Completed';
            const rowClass = isInProgress ? 'border-b border-slate-100 hover:bg-blue-50 bg-blue-50' : 'border-b border-slate-100 hover:bg-slate-50';
            const textClass = isInProgress ? 'text-blue-900' : 'text-slate-900';
            const boldClass = isInProgress ? 'font-bold' : '';
            
            let statusBadge;
            if (isCompleted) {
              statusBadge = '<span class="badge badge-success text-xs">Completed</span>';
            } else if (isInProgress) {
              statusBadge = '<span class="badge badge-primary text-xs">In Progress</span>';
            } else {
              statusBadge = '<span class="badge bg-slate-200 text-slate-700 text-xs">Scheduled</span>';
            }
            
            return '<tr class="' + rowClass + '">' +
              '<td class="py-3 px-4 text-sm font-medium ' + textClass + '">' + item.time + '</td>' +
              '<td class="py-3 px-4 text-sm ' + textClass + ' ' + boldClass + '">' + item.patient + '</td>' +
              '<td class="py-3 px-4 text-sm ' + (isInProgress ? 'text-blue-700' : 'text-slate-600') + '">' + item.doctor + '</td>' +
              '<td class="py-3 px-4 text-sm ' + (isInProgress ? 'text-blue-700' : 'text-slate-600') + '">' + item.room + '</td>' +
              '<td class="py-3 px-4 text-sm ' + (isInProgress ? 'text-blue-700' : 'text-slate-600') + '">' + item.type + '</td>' +
              '<td class="py-3 px-4 text-center">' + statusBadge + '</td>' +
              '</tr>';
          }).join('');
        }
      }

      searchInput.addEventListener('input', (e) => {
        currentSearch = e.target.value;
        renderAdminSchedule();
      });

      statusFilter.addEventListener('change', (e) => {
        currentStatusFilter = e.target.value;
        renderAdminSchedule();
      });

      sortSelect.addEventListener('change', (e) => {
        currentSort = e.target.value;
        renderAdminSchedule();
      });

      clearBtn.addEventListener('click', () => {
        currentSearch = '';
        currentStatusFilter = '';
        currentSort = 'time';
        searchInput.value = '';
        statusFilter.value = '';
        sortSelect.value = 'time';
        renderAdminSchedule();
      });

      renderAdminSchedule();
    }, 50);
  }
  else if (key === 'schedule') {
    area.innerHTML = `
      <div class="p-8">
      <div class="mb-6">
        <h2 class="text-2xl font-bold text-slate-900">Enterprise Schedule</h2>
        <p class="text-slate-500">${new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
              <div class="mt-6 grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="card p-4 border-l-4 border-l-green-500">
          <div class="text-xs text-slate-500 uppercase mb-1">Completed</div>
          <div class="text-2xl font-bold text-sozo-600" id="adminSchedCompletedCount">3</div>
        </div>
        <div class="card p-4 border-l-4 border-l-blue-500">
          <div class="text-xs text-slate-500 uppercase mb-1">In Progress</div>
          <div class="text-2xl font-bold text-blue-600" id="adminSchedInProgressCount">1</div>
        </div>
        <div class="card p-4 border-l-4 border-l-slate-400">
          <div class="text-xs text-slate-500 uppercase mb-1">Remaining</div>
          <div class="text-2xl font-bold text-slate-700" id="adminSchedRemainingCount">6</div>
        </div>
        <div class="card p-4 border-l-4 border-l-sozo-500">
          <div class="text-xs text-slate-500 uppercase mb-1">Total Today</div>
          <div class="text-2xl font-bold text-sozo-600" id="adminSchedTotalCount">10</div>
        </div>
      </div>
      </div>

      <!-- Filters and Sort Section -->
      <div class="card p-4 mb-4 bg-slate-50 border-slate-200">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
          <div class="md:col-span-2">
            <label class="text-xs font-bold text-slate-500 uppercase">Search</label>
            <div class="relative mt-1">
              <i class="fa-solid fa-magnifying-glass absolute left-3 top-3 text-slate-400"></i>
              <input type="text" id="adminScheduleSearch" class="input-royal pl-9" placeholder="Search by patient, doctor, room, or type..." />
            </div>
          </div>
          <div>
            <label class="text-xs font-bold text-slate-500 uppercase">Filter by Status</label>
            <select id="adminScheduleStatusFilter" class="input-royal mt-1">
              <option value="">All Statuses</option>
              <option value="Completed">Completed</option>
              <option value="In Progress">In Progress</option>
              <option value="Scheduled">Scheduled</option>
            </select>
          </div>
          <div>
            <label class="text-xs font-bold text-slate-500 uppercase">Sort By</label>
            <select id="adminScheduleSort" class="input-royal mt-1">
              <option value="time">Time (Earliest First)</option>
              <option value="time-desc">Time (Latest First)</option>
              <option value="patient">Patient Name (A-Z)</option>
              <option value="patient-desc">Patient Name (Z-A)</option>
              <option value="doctor">Doctor Name</option>
              <option value="room">Room Number</option>
              <option value="type">Appointment Type</option>
              <option value="status">Status</option>
            </select>
          </div>
        </div>
        <div class="flex justify-between items-center mt-3 text-sm">
          <button id="adminScheduleClearFilters" class="text-slate-600 font-bold hover:text-sozo-600">
            <i class="fa-solid fa-rotate-left mr-1"></i> Clear filters
          </button>
          <span id="adminScheduleResultCount" class="text-slate-600 font-medium"></span>
        </div>
      </div>

      <div class="card p-0 overflow-hidden">
        <table class="w-full">
          <thead>
            <tr class="bg-slate-100">
              <th class="text-left py-4 px-6 text-sm font-bold text-slate-700">Time</th>
              <th class="text-left py-4 px-6 text-sm font-bold text-slate-700">Patient Name</th>
              <th class="text-left py-4 px-6 text-sm font-bold text-slate-700">Doctor</th>
              <th class="text-left py-4 px-6 text-sm font-bold text-slate-700">Room</th>
              <th class="text-left py-4 px-6 text-sm font-bold text-slate-700">Type</th>
              <th class="text-center py-4 px-6 text-sm font-bold text-slate-700">Status</th>
              <th class="text-center py-4 px-6 text-sm font-bold text-slate-700">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr class="border-b border-slate-100 hover:bg-slate-50">
              <td class="py-4 px-6 text-sm font-medium text-slate-900">08:00 AM</td>
              <td class="py-4 px-6 text-sm text-slate-900">Robert Martinez</td>
              <td class="py-4 px-6 text-sm text-slate-600">Dr. Smith</td>
              <td class="py-4 px-6 text-sm text-slate-600">Room 101</td>
              <td class="py-4 px-6 text-sm text-slate-600">Initial Consultation</td>
              <td class="py-4 px-6 text-center"><span class="badge badge-success text-xs">Completed</span></td>
              <td class="py-4 px-6 text-center"><button class="text-sozo-600 font-bold text-xs hover:text-sozo-700">View Report</button></td>
            </tr>
            <tr class="border-b border-slate-100 hover:bg-slate-50">
              <td class="py-4 px-6 text-sm font-medium text-slate-900">08:30 AM</td>
              <td class="py-4 px-6 text-sm text-slate-900">Jennifer Davis</td>
              <td class="py-4 px-6 text-sm text-slate-600">Dr. Johnson</td>
              <td class="py-4 px-6 text-sm text-slate-600">Room 205</td>
              <td class="py-4 px-6 text-sm text-slate-600">Follow-up</td>
              <td class="py-4 px-6 text-center"><span class="badge badge-success text-xs">Completed</span></td>
              <td class="py-4 px-6 text-center"><button class="text-sozo-600 font-bold text-xs hover:text-sozo-700">View Report</button></td>
            </tr>
            <tr class="border-b border-slate-100 hover:bg-slate-50">
              <td class="py-4 px-6 text-sm font-medium text-slate-900">09:00 AM</td>
              <td class="py-4 px-6 text-sm text-slate-900">William Garcia</td>
              <td class="py-4 px-6 text-sm text-slate-600">Dr. Wilson</td>
              <td class="py-4 px-6 text-sm text-slate-600">Room 102</td>
              <td class="py-4 px-6 text-sm text-slate-600">FNON Assessment</td>
              <td class="py-4 px-6 text-center"><span class="badge badge-success text-xs">Completed</span></td>
              <td class="py-4 px-6 text-center"><button class="text-sozo-600 font-bold text-xs hover:text-sozo-700">View Report</button></td>
            </tr>
            <tr class="border-b border-slate-100 hover:bg-blue-50 bg-blue-50">
              <td class="py-4 px-6 text-sm font-medium text-blue-900">10:00 AM</td>
              <td class="py-4 px-6 text-sm text-blue-900 font-bold">Patricia Lee</td>
              <td class="py-4 px-6 text-sm text-blue-700">Dr. Chen</td>
              <td class="py-4 px-6 text-sm text-blue-700">Room 304</td>
              <td class="py-4 px-6 text-sm text-blue-700">Cognitive Assessment</td>
              <td class="py-4 px-6 text-center"><span class="badge badge-primary text-xs">In Progress</span></td>
              <td class="py-4 px-6 text-center"><button class="bg-blue-600 text-white px-3 py-1 rounded-lg text-xs font-bold hover:bg-blue-700">Monitor</button></td>
            </tr>
            <tr class="border-b border-slate-100 hover:bg-slate-50">
              <td class="py-4 px-6 text-sm font-medium text-slate-900">11:30 AM</td>
              <td class="py-4 px-6 text-sm text-slate-900">Christopher White</td>
              <td class="py-4 px-6 text-sm text-slate-600">Dr. Smith</td>
              <td class="py-4 px-6 text-sm text-slate-600">Room 101</td>
              <td class="py-4 px-6 text-sm text-slate-600">Brain Mapping</td>
              <td class="py-4 px-6 text-center"><span class="badge bg-slate-200 text-slate-700 text-xs">Scheduled</span></td>
              <td class="py-4 px-6 text-center"><button class="text-slate-600 font-bold text-xs hover:text-slate-700">View Details</button></td>
            </tr>
            <tr class="border-b border-slate-100 hover:bg-slate-50">
              <td class="py-4 px-6 text-sm font-medium text-slate-900">01:00 PM</td>
              <td class="py-4 px-6 text-sm text-slate-900">Amanda Harris</td>
              <td class="py-4 px-6 text-sm text-slate-600">Dr. Johnson</td>
              <td class="py-4 px-6 text-sm text-slate-600">Room 205</td>
              <td class="py-4 px-6 text-sm text-slate-600">PRS Assessment</td>
              <td class="py-4 px-6 text-center"><span class="badge bg-slate-200 text-slate-700 text-xs">Scheduled</span></td>
              <td class="py-4 px-6 text-center"><button class="text-slate-600 font-bold text-xs hover:text-slate-700">View Details</button></td>
            </tr>
            <tr class="border-b border-slate-100 hover:bg-slate-50">
              <td class="py-4 px-6 text-sm font-medium text-slate-900">02:30 PM</td>
              <td class="py-4 px-6 text-sm text-slate-900">Thomas Wilson</td>
              <td class="py-4 px-6 text-sm text-slate-600">Dr. Wilson</td>
              <td class="py-4 px-6 text-sm text-slate-600">Room 102</td>
              <td class="py-4 px-6 text-sm text-slate-600">Treatment Review</td>
              <td class="py-4 px-6 text-center"><span class="badge bg-slate-200 text-slate-700 text-xs">Scheduled</span></td>
              <td class="py-4 px-6 text-center"><button class="text-slate-600 font-bold text-xs hover:text-slate-700">View Details</button></td>
            </tr>
            <tr class="border-b border-slate-100 hover:bg-slate-50">
              <td class="py-4 px-6 text-sm font-medium text-slate-900">03:00 PM</td>
              <td class="py-4 px-6 text-sm text-slate-900">Margaret Taylor</td>
              <td class="py-4 px-6 text-sm text-slate-600">Dr. Chen</td>
              <td class="py-4 px-6 text-sm text-slate-600">Room 304</td>
              <td class="py-4 px-6 text-sm text-slate-600">Follow-up</td>
              <td class="py-4 px-6 text-center"><span class="badge bg-slate-200 text-slate-700 text-xs">Scheduled</span></td>
              <td class="py-4 px-6 text-center"><button class="text-slate-600 font-bold text-xs hover:text-slate-700">View Details</button></td>
            </tr>
            <tr class="border-b border-slate-100 hover:bg-slate-50">
              <td class="py-4 px-6 text-sm font-medium text-slate-900">04:30 PM</td>
              <td class="py-4 px-6 text-sm text-slate-900">Kevin Anderson</td>
              <td class="py-4 px-6 text-sm text-slate-600">Dr. Smith</td>
              <td class="py-4 px-6 text-sm text-slate-600">Room 101</td>
              <td class="py-4 px-6 text-sm text-slate-600">Initial Consultation</td>
              <td class="py-4 px-6 text-center"><span class="badge bg-slate-200 text-slate-700 text-xs">Scheduled</span></td>
              <td class="py-4 px-6 text-center"><button class="text-slate-600 font-bold text-xs hover:text-slate-700">View Details</button></td>
            </tr>
            <tr class="border-b border-slate-100 hover:bg-slate-50">
              <td class="py-4 px-6 text-sm font-medium text-slate-900">05:00 PM</td>
              <td class="py-4 px-6 text-sm text-slate-900">Nancy Thomas</td>
              <td class="py-4 px-6 text-sm text-slate-600">Dr. Johnson</td>
              <td class="py-4 px-6 text-sm text-slate-600">Room 205</td>
              <td class="py-4 px-6 text-sm text-slate-600">Final Report Review</td>
              <td class="py-4 px-6 text-center"><span class="badge bg-slate-200 text-slate-700 text-xs">Scheduled</span></td>
              <td class="py-4 px-6 text-center"><button class="text-slate-600 font-bold text-xs hover:text-slate-700">View Details</button></td>
            </tr>
          </tbody>
        </table>
      </div>


      </div>
    `;
  }
  else if (key === 'fnon') renderFNON();
  else if (key === 'treatmentplan') {
    if (currentRole === 'patient') {
      renderPatientTreatmentPlan();
    } else {
      renderTreatmentPlan();
    }
  }
  else if (key === 'brainmap') renderBrainMap();
  else if (key === 'prs') renderPRSDoctor();
  else if (key === 'finalreport') {
    renderFinalReport();
  }
  else if (key === 'finance') {
    const f = sampleData.finance;
    const transactionData = [
      {date:'2024-12-20', entity:'Munich Medical', type:'Partnership Fee', amount:80000, status:'Paid', paymentStatus:'Completed', category:'Sozo Payments', cardType:'Wire Transfer', insurance:'N/A'},
      {date:'2024-12-18', entity:'Dr. Wilson', type:'Workshop Revenue', amount:3000, status:'Paid', paymentStatus:'Completed', category:'Sozo Payments', cardType:'Wire Transfer', insurance:'N/A'},
      {date:'2024-12-15', entity:'London Brain Institute', type:'Partnership Fee', amount:95000, status:'Paid', paymentStatus:'Completed', category:'Sozo Payments', cardType:'Wire Transfer', insurance:'N/A'},
      {date:'2024-12-12', entity:'Patient Subscription', type:'Device Sales', amount:12500, status:'Paid', paymentStatus:'Completed', category:'Commission from Patients', cardType:'Credit Card', insurance:'N/A'},
      {date:'2024-12-10', entity:'Sydney Neuro Clinic', type:'Partnership Payment', amount:45000, status:'Pending', paymentStatus:'Pending', category:'Sozo Payments', cardType:'Wire Transfer', insurance:'N/A'},
      {date:'2024-12-08', entity:'Dr. Sarah Smith', type:'Workshop Revenue', amount:5600, status:'Paid', paymentStatus:'Completed', category:'Sozo Payments', cardType:'Check', insurance:'N/A'},
      {date:'2024-12-05', entity:'New York Medical', type:'Device Supply', amount:28000, status:'Paid', paymentStatus:'Completed', category:'Sozo Payments', cardType:'Wire Transfer', insurance:'N/A'},
      {date:'2024-12-01', entity:'Paris Health Solutions', type:'Partnership Fee', amount:75000, status:'Pending', paymentStatus:'Pending', category:'Sozo Payments', cardType:'Wire Transfer', insurance:'N/A'},
      {date:'2024-11-28', entity:'Patient Refund', type:'Chargeback', amount:-2500, status:'Pending', paymentStatus:'Disputed', category:'Commission from Patients', cardType:'Credit Card', insurance:'N/A'},
      {date:'2024-11-25', entity:'Berlin Wellness', type:'Device Supply', amount:18000, status:'Paid', paymentStatus:'Completed', category:'Sozo Payments', cardType:'Wire Transfer', insurance:'N/A'},
      {date:'2024-12-22', entity:'Patient - John Doe', type:'Consultation Fee', amount:150, status:'Paid', paymentStatus:'Completed', category:'Commission from Patients', cardType:'Visa •••• 4242', insurance:'Aetna PPO'},
      {date:'2024-12-21', entity:'Patient - Jane Smith', type:'Lab Work', amount:85, status:'Paid', paymentStatus:'Completed', category:'Commission from Patients', cardType:'Mastercard •••• 5555', insurance:'Blue Cross'},
      {date:'2024-12-19', entity:'Patient - Robert Johnson', type:'Device Purchase', amount:299, status:'Paid', paymentStatus:'Completed', category:'Commission from Patients', cardType:'Debit Card', insurance:'N/A'},
      {date:'2024-12-17', entity:'Patient - Emily Davis', type:'Subscription', amount:29, status:'Paid', paymentStatus:'Completed', category:'Commission from Patients', cardType:'Visa •••• 8888', insurance:'N/A'},
      {date:'2024-12-14', entity:'Patient - Michael Brown', type:'Therapy Session', amount:200, status:'Pending', paymentStatus:'Pending', category:'Commission from Patients', cardType:'Insurance Claim', insurance:'UnitedHealth'}
    ];
    
    // Calculate category totals
    const commissionFromPatients = transactionData
      .filter(t => t.category === 'Commission from Patients' && t.amount > 0)
      .reduce((sum, t) => sum + t.amount, 0);
    const sozoPayments = transactionData
      .filter(t => t.category === 'Sozo Payments' && t.amount > 0)
      .reduce((sum, t) => sum + t.amount, 0);
    const partnershipPayments = commissionFromPatients * 0.15;
    const totalCategoryRevenue = commissionFromPatients + sozoPayments + partnershipPayments;
    const commissionPercentage = totalCategoryRevenue > 0 ? ((commissionFromPatients / totalCategoryRevenue) * 100).toFixed(1) : 0;
    const sozoPercentage = totalCategoryRevenue > 0 ? ((sozoPayments / totalCategoryRevenue) * 100).toFixed(1) : 0;
    const partnershipPercentage = totalCategoryRevenue > 0 ? ((partnershipPayments / totalCategoryRevenue) * 100).toFixed(1) : 0;
    
    area.innerHTML = `
      <div class="p-8">
      <div class="mb-6"><h2 class="text-2xl font-bold">Finance & Accounts</h2></div>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-6 mb-8">
        <div class="card p-4 border-l-4 border-l-green-500">
          <div class="text-xs text-slate-500 uppercase">Total Revenue</div>
          <div class="text-2xl font-bold">€${(f.totalRev/1000000).toFixed(0)}M</div>
        </div>
        <div class="card p-4 border-l-4 border-l-sozo-500">
          <div class="text-xs text-slate-500 uppercase">Patients</div>
          <div class="text-2xl font-bold">€${(f.patients/1000000).toFixed(0)}M</div>
        </div>
        <div class="card p-4 border-l-4 border-l-blue-500">
          <div class="text-xs text-slate-500 uppercase">Devices</div>
          <div class="text-2xl font-bold">€${(f.devices/1000000).toFixed(0)}M</div>
        </div>
        <div class="card p-4 border-l-4 border-l-purple-500">
          <div class="text-xs text-slate-500 uppercase">Partners</div>
          <div class="text-2xl font-bold">€${(f.partners/1000000).toFixed(0)}M</div>
        </div>
        <div class="card p-4 border-l-4 border-l-indigo-500">
          <div class="text-xs text-slate-500 uppercase">Doctors</div>
          <div class="text-2xl font-bold">€${(f.doctors/1000000).toFixed(0)}M</div>
        </div>
        <div class="card p-4 border-l-4 border-l-pink-500">
          <div class="text-xs text-slate-500 uppercase">Subscriptions</div>
          <div class="text-2xl font-bold">€${(f.subscriptions/1000000).toFixed(0)}M</div>
        </div>
      </div>
      
      <!-- Payment Category Breakdown -->
      <div class="card p-6 mb-8">
        <h3 class="font-bold text-lg mb-4"><i class="fa-solid fa-chart-pie mr-2 text-sozo-500"></i>Payment Category Breakdown</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="border-2 border-blue-500 rounded-lg p-4 bg-blue-50">
            <div class="flex items-center justify-between mb-2">
              <div class="text-sm font-bold text-blue-700 uppercase">Payments from Patients</div>
              <span class="text-xs font-bold bg-blue-500 text-white px-2 py-1 rounded">${commissionPercentage}%</span>
            </div>
            <div class="text-3xl font-bold text-blue-600">€1.2M</div>
            <div class="text-xs text-slate-600 mt-2">Patient consultations, subscriptions, devices & services</div>
          </div>
          <div class="border-2 border-slate-600 rounded-lg p-4 bg-slate-50">
            <div class="flex items-center justify-between mb-2">
              <div class="text-sm font-bold text-slate-700 uppercase">Sozo Payments</div>
              <span class="text-xs font-bold bg-slate-500 text-white px-2 py-1 rounded">${sozoPercentage}%</span>
            </div>
            <div class="text-3xl font-bold text-sozo-600">€3.6M</div>
            <div class="text-xs text-slate-600 mt-2">Partnerships, workshops, device supplies & corporate fees</div>
          </div>
          <div class="border-2 border-sozo-600 rounded-lg p-4 bg-orange-50">
            <div class="flex items-center justify-between mb-2">
              <div class="text-sm font-bold text-slate-700 uppercase">Partnership Payments</div>
              <span class="text-xs font-bold bg-orange-500 text-white px-2 py-1 rounded">${partnershipPercentage}%</span>
            </div>
            <div class="text-3xl font-bold text-sozo-600">€800K</div>
            <div class="text-xs text-slate-600 mt-2">Affiliate commissions, strategic partnerships & collaborations</div>
          </div>
        </div>
      </div>
      <div class="card p-6">
        <div class="mb-6">
          <div class="flex flex-col md:flex-row md:items-center justify-between mb-4 gap-4">
            <h3 class="font-bold text-lg">Transaction Ledger</h3>
            <div class="relative">
                <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                <input type="text" id="financeSearch" placeholder="Search by entity, type, or status..." class="pl-10 pr-4 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:border-sozo-500 w-full md:w-64">
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
            <div>
              <label class="text-xs font-bold text-slate-600 block mb-2">From Date</label>
              <input type="date" id="financeStartDate" class="input-royal w-full">
            </div>
            <div>
              <label class="text-xs font-bold text-slate-600 block mb-2">To Date</label>
              <input type="date" id="financeEndDate" class="input-royal w-full">
            </div>
            <div>
              <label class="text-xs font-bold text-slate-600 block mb-2">Specific Date</label>
              <input type="date" id="financeSpecificDate" class="input-royal w-full">
            </div>
          </div>
          <div class="flex flex-wrap gap-2">
            <button class="financeSort sort-btn active" data-sort="date">Sort by Date</button>
            <button class="financeSort sort-btn" data-sort="payment">Sort by Payment Status</button>
            <button class="financeSort sort-btn" data-sort="entity">Sort by Entity</button>
            <button class="financeSort sort-btn" data-sort="type">Sort by Type</button>
            <button class="financeSort sort-btn" data-sort="amount">Sort by Amount</button>
          </div>
        </div>
        <div class="max-h-96 overflow-y-auto">
          <table>
            <thead><tr><th>Date</th><th>Entity</th><th>Type</th><th>Category</th><th>Amount</th><th>Payment Status</th><th>Actions</th></tr></thead>
            <tbody id="financeTable"></tbody>
          </table>
        </div>
      </div>
      
      <!-- Transaction Details Modal -->
      <div id="transactionDetailsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
          <div class="p-6 border-b border-slate-200 flex justify-between items-center">
            <h3 class="text-xl font-bold"><i class="fa-solid fa-receipt mr-2 text-sozo-500"></i>Transaction Details</h3>
            <button onclick="document.getElementById('transactionDetailsModal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600">
              <i class="fa-solid fa-times text-xl"></i>
            </button>
          </div>
          <div id="transactionDetailsContent" class="p-6"></div>
        </div>
      </div>
      
      </div>
    `;
    
    setTimeout(() => {
      let currentData = [...transactionData];
      let currentSort = 'date';
      
      const table = document.getElementById('financeTable');
      const searchInput = document.getElementById('financeSearch');

      function applySort() {
          if (currentSort === 'date') {
            currentData.sort((a, b) => new Date(b.date) - new Date(a.date));
          } else if (currentSort === 'payment') {
            const order = {'Completed': 1, 'Pending': 2, 'Disputed': 3};
            currentData.sort((a, b) => order[a.paymentStatus] - order[b.paymentStatus]);
          } else if (currentSort === 'entity') {
            currentData.sort((a, b) => a.entity.localeCompare(b.entity));
          } else if (currentSort === 'type') {
            currentData.sort((a, b) => a.type.localeCompare(b.type));
          } else if (currentSort === 'amount') {
            currentData.sort((a, b) => b.amount - a.amount);
          }
      }

      function renderTable() {
        table.innerHTML = currentData.map((row, idx) => `
          <tr>
            <td>${row.date}</td>
            <td><strong>${row.entity}</strong></td>
            <td>${row.type}</td>
            <td><span class="badge badge-${row.category === 'Commission from Patients' ? 'info' : 'secondary'}">${row.category}</span></td>
            <td class="${row.amount < 0 ? 'text-slate-600' : 'text-sozo-600'} font-mono">€${row.amount.toLocaleString()}</td>
            <td><span class="badge badge-${row.paymentStatus === 'Completed' ? 'success' : row.paymentStatus === 'Pending' ? 'warning' : 'danger'}">${row.paymentStatus}</span></td>
            <td>
              <button onclick="showTransactionDetails(${idx})" class="text-sozo-500 hover:text-sozo-600 font-medium text-sm">
                <i class="fa-solid fa-eye mr-1"></i>View Details
              </button>
            </td>
          </tr>
        `).join('');
      }
      
      // Make showTransactionDetails globally accessible
      window.showTransactionDetails = function(index) {
        const transaction = currentData[index];
        const modal = document.getElementById('transactionDetailsModal');
        const content = document.getElementById('transactionDetailsContent');
        
        content.innerHTML = `
          <div class="space-y-4">
            <!-- Transaction Overview -->
            <div class="bg-gradient-to-r from-sozo-50 to-blue-50 p-4 rounded-lg border border-sozo-200">
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <div class="text-xs text-slate-600 uppercase font-bold mb-1">Transaction Amount</div>
                  <div class="text-3xl font-bold ${transaction.amount < 0 ? 'text-slate-600' : 'text-sozo-600'}">€${transaction.amount.toLocaleString()}</div>
                </div>
                <div>
                  <div class="text-xs text-slate-600 uppercase font-bold mb-1">Payment Status</div>
                  <span class="badge badge-${transaction.paymentStatus === 'Completed' ? 'success' : transaction.paymentStatus === 'Pending' ? 'warning' : 'danger'} text-lg px-3 py-1">${transaction.paymentStatus}</span>
                </div>
              </div>
            </div>
            
            <!-- Basic Information -->
            <div class="card p-4 bg-slate-50">
              <h4 class="font-bold text-sm mb-3 text-sozo-600"><i class="fa-solid fa-info-circle mr-2"></i>Basic Information</h4>
              <div class="grid grid-cols-2 gap-3 text-sm">
                <div>
                  <div class="text-xs text-slate-500 font-bold uppercase">Date</div>
                  <div class="font-medium">${transaction.date}</div>
                </div>
                <div>
                  <div class="text-xs text-slate-500 font-bold uppercase">Entity</div>
                  <div class="font-medium">${transaction.entity}</div>
                </div>
                <div>
                  <div class="text-xs text-slate-500 font-bold uppercase">Transaction Type</div>
                  <div class="font-medium">${transaction.type}</div>
                </div>
                <div>
                  <div class="text-xs text-slate-500 font-bold uppercase">Category</div>
                  <span class="badge badge-${transaction.category === 'Commission from Patients' ? 'info' : 'secondary'}">${transaction.category}</span>
                </div>
              </div>
            </div>
            
            <!-- Payment Details -->
            <div class="card p-4 bg-blue-50">
              <h4 class="font-bold text-sm mb-3 text-blue-700"><i class="fa-solid fa-credit-card mr-2"></i>Payment Details</h4>
              <div class="grid grid-cols-2 gap-3 text-sm">
                <div>
                  <div class="text-xs text-slate-600 font-bold uppercase">Payment Method</div>
                  <div class="font-medium flex items-center">
                    <i class="fa-solid ${transaction.cardType.includes('Credit') ? 'fa-credit-card' : transaction.cardType.includes('Debit') ? 'fa-money-check' : transaction.cardType.includes('Wire') ? 'fa-building-columns' : transaction.cardType.includes('Check') ? 'fa-money-check-dollar' : 'fa-file-invoice'} mr-2 text-blue-600"></i>
                    ${transaction.cardType}
                  </div>
                </div>
                <div>
                  <div class="text-xs text-slate-600 font-bold uppercase">Insurance Provider</div>
                  <div class="font-medium ${transaction.insurance === 'N/A' ? 'text-slate-400' : 'text-blue-600'}">
                    <i class="fa-solid ${transaction.insurance === 'N/A' ? 'fa-xmark' : 'fa-shield-halved'} mr-2"></i>
                    ${transaction.insurance}
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Additional Information -->
            <div class="card p-4">
              <h4 class="font-bold text-sm mb-3 text-slate-700"><i class="fa-solid fa-list-check mr-2"></i>Additional Information</h4>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between py-2 border-b border-slate-200">
                  <span class="text-slate-600">Transaction Status:</span>
                  <span class="font-medium">${transaction.status}</span>
                </div>
                <div class="flex justify-between py-2 border-b border-slate-200">
                  <span class="text-slate-600">Processing Date:</span>
                  <span class="font-medium">${transaction.date}</span>
                </div>
                <div class="flex justify-between py-2">
                  <span class="text-slate-600">Category Type:</span>
                  <span class="font-medium">${transaction.category}</span>
                </div>
              </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex gap-3 pt-4">
              <button onclick="alert('Export functionality would be implemented here')" class="btn btn-outline flex-1">
                <i class="fa-solid fa-download mr-2"></i>Export Receipt
              </button>
              <button onclick="alert('Print functionality would be implemented here')" class="btn btn-outline flex-1">
                <i class="fa-solid fa-print mr-2"></i>Print
              </button>
            </div>
          </div>
        `;
        
        modal.classList.remove('hidden');
      };

      function handleSearch() {
        const searchTerm = searchInput.value.toLowerCase();
        const startDate = document.getElementById('financeStartDate').value;
        const endDate = document.getElementById('financeEndDate').value;
        const specificDate = document.getElementById('financeSpecificDate').value;
        
        currentData = transactionData.filter(row => {
          // Text search
          const matchesText = 
            row.entity.toLowerCase().includes(searchTerm) || 
            row.type.toLowerCase().includes(searchTerm) ||
            row.status.toLowerCase().includes(searchTerm) ||
            row.paymentStatus.toLowerCase().includes(searchTerm) ||
            row.date.includes(searchTerm);
          
          if (!matchesText) return false;
          
          // Date range filter
          if (startDate || endDate) {
            const transDate = new Date(row.date);
            if (startDate && transDate < new Date(startDate)) return false;
            if (endDate && transDate > new Date(endDate)) return false;
          }
          
          // Specific date filter
          if (specificDate && row.date !== specificDate) return false;
          
          return true;
        });
        applySort();
        renderTable();
      }

      if (searchInput) {
        searchInput.addEventListener('input', handleSearch);
      }
      
      // Add event listeners for date filters
      const startDateInput = document.getElementById('financeStartDate');
      const endDateInput = document.getElementById('financeEndDate');
      const specificDateInput = document.getElementById('financeSpecificDate');
      
      if (startDateInput) startDateInput.addEventListener('change', handleSearch);
      if (endDateInput) endDateInput.addEventListener('change', handleSearch);
      if (specificDateInput) specificDateInput.addEventListener('change', handleSearch);
      
      document.querySelectorAll('.financeSort').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.financeSort').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          currentSort = this.dataset.sort;
          applySort();
          renderTable();
        });
      });
      
      renderTable();
    }, 50);
  }
  else if (key === 'partnerships') {
    // Calculate partnership statistics
    const totalPartners = sampleData.partnerships.length;
    const activePartners = sampleData.partnerships.filter(p => p.status === 'Active').length;
    const pendingPartners = sampleData.partnerships.filter(p => p.status === 'Pending').length;
    const totalRevenue = sampleData.partnerships.reduce((sum, p) => sum + p.revenue, 0);
    const avgRevenue = Math.round(totalRevenue / totalPartners);
    
    area.innerHTML = `
      <div class="p-8">
      <div class="mb-6 flex justify-between items-center">
        <div>
          <h2 class="text-2xl font-bold">Partnerships</h2>
          <p class="text-slate-500 text-sm mt-1">Manage and monitor partnership relationships</p>
        </div>
        <button class="bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold shadow-lg shadow-sozo-500/20" onclick="openRegisterPartnerModal()">+ Register Partner (Fee €80k)</button>
      </div>

      <!-- Partnership KPI Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
        <div class="card p-5 border-l-4 border-l-green-500">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-full bg-orange-50 flex items-center justify-center">
              <i class="fa-solid fa-check-circle text-2xl text-sozo-600"></i>
            </div>
            <div>
              <div class="text-xs text-slate-500 uppercase font-bold">Active Partners</div>
              <div class="text-2xl font-bold text-slate-900">${activePartners}</div>
            </div>
          </div>
        </div>
        
        <div class="card p-5 border-l-4 border-l-orange-500">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-full bg-orange-50 flex items-center justify-center">
              <i class="fa-solid fa-clock text-2xl text-orange-600"></i>
            </div>
            <div>
              <div class="text-xs text-slate-500 uppercase font-bold">Pending</div>
              <div class="text-2xl font-bold text-slate-900">${pendingPartners}</div>
            </div>
          </div>
        </div>
        
        <div class="card p-5 border-l-4 border-l-blue-500">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-full bg-blue-50 flex items-center justify-center">
              <i class="fa-solid fa-handshake text-2xl text-blue-600"></i>
            </div>
            <div>
              <div class="text-xs text-slate-500 uppercase font-bold">Total Partners</div>
              <div class="text-2xl font-bold text-slate-900">${totalPartners}</div>
            </div>
          </div>
        </div>
        
        <div class="card p-5 border-l-4 border-l-emerald-500">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-full bg-orange-50 flex items-center justify-center">
              <i class="fa-solid fa-euro-sign text-2xl text-sozo-600"></i>
            </div>
            <div>
              <div class="text-xs text-slate-500 uppercase font-bold">Total Revenue</div>
              <div class="text-2xl font-bold text-slate-900">€${Math.round(totalRevenue/1000)}K</div>
            </div>
          </div>
        </div>
        
        <div class="card p-5 border-l-4 border-l-purple-500">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-full bg-slate-50 flex items-center justify-center">
              <i class="fa-solid fa-chart-line text-2xl text-sozo-600"></i>
            </div>
            <div>
              <div class="text-xs text-slate-500 uppercase font-bold">Avg Revenue</div>
              <div class="text-2xl font-bold text-slate-900">€${Math.round(avgRevenue/1000)}K</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Major Partnerships List -->
      <div class="card p-6 mb-8">
        <h3 class="font-bold text-lg mb-4"><i class="fa-solid fa-star mr-2 text-sozo-500"></i>Major Partnerships</h3>
        <div class="space-y-3">
          ${sampleData.partnerships.map(p => `
            <div class="flex items-center justify-between p-4 border border-slate-200 rounded-lg hover:border-sozo-400 hover:bg-sozo-50 transition cursor-pointer" onclick="viewPartnerDetails('${p.id}')">
              <div class="flex-1">
                <div class="flex items-center gap-3">
                  <h3 class="font-bold text-slate-900">${p.name}</h3>
                  <span class="badge badge-${p.status==='Active'?'success':'warning'}">${p.status}</span>
                </div>
                <p class="text-sm text-slate-600 mt-1">${p.city}, ${p.country}</p>
              </div>
              <div class="text-right">
                <p class="text-lg font-bold text-sozo-600">€${p.revenue.toLocaleString()}</p>
                <p class="text-xs text-slate-500">${p.email}</p>
              </div>
              <div class="ml-4 flex gap-2">
                <button class="text-blue-600 hover:text-blue-800 font-bold" onclick="event.stopPropagation(); openEditPartnerModal('${p.id}')"><i class="fa-solid fa-edit"></i></button>
                <button class="text-slate-600 hover:text-slate-700 font-bold" onclick="event.stopPropagation(); deletePartner('${p.id}')"><i class="fa-solid fa-trash"></i></button>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
      
      <div class="card p-0 overflow-hidden">
        <div class="p-4 border-b bg-slate-50">
          <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold">Detailed Partnership Directory</h3>
            <button onclick="document.getElementById('partnerFilterPanel').classList.toggle('hidden')" class="px-3 py-1 bg-slate-200 hover:bg-slate-300 rounded-lg text-sm font-bold transition"><i class="fa-solid fa-filter mr-2"></i>Filters</button>
          </div>
          
          <!-- Filter Panel -->
          <div id="partnerFilterPanel" class="hidden grid grid-cols-1 md:grid-cols-4 gap-3 mb-4 p-4 bg-white border border-slate-300 rounded-lg">
            <div>
              <label class="text-xs font-bold text-slate-600 block mb-1">Search Name/Email</label>
              <input type="text" id="partnerSearch" placeholder="Search partners..." class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:border-sozo-500">
            </div>
            <div>
              <label class="text-xs font-bold text-slate-600 block mb-1">Filter by Country</label>
              <select id="partnerCountryFilter" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:border-sozo-500">
                <option value="">All Countries</option>
                ${[...new Set(sampleData.partnerships.map(p => p.country))].sort().map(c => `<option value="${c}">${c}</option>`).join('')}
              </select>
            </div>
            <div>
              <label class="text-xs font-bold text-slate-600 block mb-1">Filter by Status</label>
              <select id="partnerStatusFilter" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:border-sozo-500">
                <option value="">All Status</option>
                <option value="Active">Active</option>
                <option value="Inactive">Inactive</option>
              </select>
            </div>
            <div>
              <label class="text-xs font-bold text-slate-600 block mb-1">Sort By</label>
              <select id="partnerSortBy" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:border-sozo-500">
                <option value="name">Organization Name</option>
                <option value="revenue-desc">Revenue (High to Low)</option>
                <option value="revenue-asc">Revenue (Low to High)</option>
                <option value="country">Country</option>
                <option value="status">Status</option>
              </select>
            </div>
          </div>

          <!-- Summary Stats -->
          <div class="grid grid-cols-2 md:grid-cols-5 gap-2 p-2 bg-blue-50 border border-blue-200 rounded-lg">
            <div class="text-center">
              <p class="text-xs text-slate-600">Total Partners</p>
              <p class="text-lg font-bold text-slate-900">${sampleData.partnerships.length}</p>
            </div>
            <div class="text-center">
              <p class="text-xs text-slate-600">Active Partners</p>
              <p class="text-lg font-bold text-sozo-600">${sampleData.partnerships.filter(p => p.status === 'Active').length}</p>
            </div>
            <div class="text-center">
              <p class="text-xs text-slate-600">Unique Countries</p>
              <p class="text-lg font-bold text-blue-600">${[...new Set(sampleData.partnerships.map(p => p.country))].length}</p>
            </div>
            <div class="text-center">
              <p class="text-xs text-slate-600">Total Revenue</p>
              <p class="text-lg font-bold text-sozo-600">€${(sampleData.partnerships.reduce((sum, p) => sum + p.revenue, 0) / 1000).toFixed(0)}K</p>
            </div>
            <div class="text-center">
              <p class="text-xs text-slate-600">Avg Revenue</p>
              <p class="text-lg font-bold text-orange-600">€${(sampleData.partnerships.reduce((sum, p) => sum + p.revenue, 0) / sampleData.partnerships.length / 1000).toFixed(0)}K</p>
            </div>
          </div>
        </div>

        <!-- Partners by Country Summary -->
        <div class="p-4 border-b bg-slate-50">
          <p class="text-xs font-bold text-slate-600 uppercase mb-2">Partners by Country</p>
          <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2">
            ${Object.entries(sampleData.partnerships.reduce((acc, p) => { acc[p.country] = (acc[p.country] || 0) + 1; return acc; }, {})).sort((a,b) => b[1] - a[1]).map(([country, count]) => `
              <div class="bg-white border border-slate-300 rounded-lg p-2 text-center cursor-pointer hover:bg-blue-50 transition" onclick="document.getElementById('partnerCountryFilter').value='${country}'; filterPartnerTable()">
                <p class="font-bold text-slate-900">${count}</p>
                <p class="text-xs text-slate-600">${country}</p>
              </div>
            `).join('')}
          </div>
        </div>

        <table>
          <thead><tr><th>ID</th><th>Organization</th><th>Contact Person</th><th>Location</th><th>Revenue</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="partnerTableBody">
            ${sampleData.partnerships.map(p => `
              <tr>
                <td><strong>${p.id}</strong></td>
                <td>${p.name}</td>
                <td>${p.contactPerson}</td>
                <td>${p.city}, ${p.country}</td>
                <td class="text-sozo-600 font-mono">€${p.revenue.toLocaleString()}</td>
                <td><span class="badge badge-${p.status==='Active'?'success':'warning'}">${p.status}</span></td>
                <td class="flex gap-2">
                  <button class="text-blue-600 hover:text-blue-800 font-bold" onclick="alert('Contact: ${p.phone}\\nEmail: ${p.email}')"><i class="fa-solid fa-info-circle"></i></button>
                  <button class="text-slate-600 hover:text-blue-600 font-bold" onclick="openEditPartnerModal('${p.id}')"><i class="fa-solid fa-edit"></i></button>
                  <button class="text-slate-600 hover:text-slate-600 font-bold" onclick="deletePartner('${p.id}')"><i class="fa-solid fa-trash"></i></button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
      </div>
    `;
    window.viewPartnerDetails = (id) => {
      const partner = sampleData.partnerships.find(p => p.id === id);
      if (!partner) return;
      
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/40 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-2xl max-w-3xl w-[90%] max-h-[90vh] overflow-y-auto">
          <div class="p-6 border-b border-slate-200 sticky top-0 bg-white">
            <div class="flex justify-between items-start">
              <div>
                <h3 class="text-2xl font-bold text-slate-900">${partner.name}</h3>
                <p class="text-sm text-slate-600 mt-1">Partnership ID: <span class="font-mono font-bold">${partner.id}</span></p>
              </div>
              <span class="badge badge-${partner.status==='Active'?'success':'warning'}">${partner.status}</span>
            </div>
          </div>
          <div class="p-6">
            <!-- Status Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
              <div class="card p-4 border-l-4 border-l-green-600">
                <p class="text-xs text-slate-500 uppercase font-bold mb-1">Annual Revenue</p>
                <p class="text-3xl font-bold text-sozo-600">€${partner.revenue.toLocaleString()}</p>
              </div>
              <div class="card p-4 border-l-4 border-l-blue-600">
                <p class="text-xs text-slate-500 uppercase font-bold mb-1">Contract Date</p>
                <p class="text-xl font-bold text-blue-600">${new Date(partner.contractDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
              </div>
            </div>

            <!-- Organization Information -->
            <div class="mb-8">
              <h4 class="text-lg font-bold text-slate-900 mb-4 pb-2 border-b border-slate-200"><i class="fa-solid fa-building mr-2 text-sozo-600"></i>Organization Information</h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <p class="text-xs text-slate-500 uppercase font-bold">Organization Name</p>
                  <p class="text-sm font-bold text-slate-900 mt-1">${partner.name}</p>
                </div>
                <div>
                  <p class="text-xs text-slate-500 uppercase font-bold">Location</p>
                  <p class="text-sm font-bold text-slate-900 mt-1">${partner.city}, ${partner.country}</p>
                </div>
              </div>
            </div>

            <!-- Contact Information -->
            <div class="mb-8">
              <h4 class="text-lg font-bold text-slate-900 mb-4 pb-2 border-b border-slate-200"><i class="fa-solid fa-user mr-2 text-sozo-600"></i>Contact Information</h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <p class="text-xs text-slate-500 uppercase font-bold">Contact Person</p>
                  <p class="text-sm font-bold text-slate-900 mt-1">${partner.contactPerson}</p>
                </div>
                <div>
                  <p class="text-xs text-slate-500 uppercase font-bold">Email</p>
                  <p class="text-sm font-mono text-sozo-600 mt-1">
                    <a href="mailto:${partner.email}" class="hover:underline">${partner.email}</a>
                  </p>
                </div>
                <div>
                  <p class="text-xs text-slate-500 uppercase font-bold">Phone</p>
                  <p class="text-sm font-mono text-slate-900 mt-1">
                    <a href="tel:${partner.phone}" class="hover:text-sozo-600">${partner.phone}</a>
                  </p>
                </div>
                <div>
                  <p class="text-xs text-slate-500 uppercase font-bold">City</p>
                  <p class="text-sm font-bold text-slate-900 mt-1">${partner.city}</p>
                </div>
              </div>
            </div>

            <!-- Partnership Details -->
            <div class="mb-8 p-4 bg-orange-50 rounded-lg border border-orange-200">
              <h4 class="text-lg font-bold text-slate-900 mb-4 pb-2 border-b border-orange-200"><i class="fa-solid fa-handshake mr-2 text-sozo-600"></i>Partnership Details</h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <p class="text-xs text-slate-500 uppercase font-bold">Partnership Status</p>
                  <p class="text-sm font-bold text-slate-900 mt-1">
                    <span class="badge badge-${partner.status==='Active'?'success':'warning'}">${partner.status}</span>
                  </p>
                </div>
                <div>
                  <p class="text-xs text-slate-500 uppercase font-bold">Registration Fee</p>
                  <p class="text-sm font-bold text-sozo-600 mt-1">€80,000</p>
                </div>
                <div>
                  <p class="text-xs text-slate-500 uppercase font-bold">Contract Date</p>
                  <p class="text-sm font-bold text-slate-900 mt-1">${new Date(partner.contractDate).toLocaleDateString()}</p>
                </div>
                <div>
                  <p class="text-xs text-slate-500 uppercase font-bold">Annual Revenue Share</p>
                  <p class="text-sm font-bold text-sozo-600 mt-1">90% Revenue Split</p>
                </div>
              </div>
            </div>

            <!-- Benefits -->
            <div class="mb-8">
              <h4 class="text-lg font-bold text-slate-900 mb-4 pb-2 border-b border-slate-200"><i class="fa-solid fa-star mr-2 text-slate-600"></i>Partnership Benefits</h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div class="flex gap-3 p-3 bg-slate-50 rounded">
                  <i class="fa-solid fa-check text-sozo-600 mt-1"></i>
                  <div>
                    <p class="font-bold text-sm text-slate-900">90% Revenue Share</p>
                    <p class="text-xs text-slate-600">Higher than standard 85%</p>
                  </div>
                </div>
                <div class="flex gap-3 p-3 bg-slate-50 rounded">
                  <i class="fa-solid fa-check text-sozo-600 mt-1"></i>
                  <div>
                    <p class="font-bold text-sm text-slate-900">Priority Referrals</p>
                    <p class="text-xs text-slate-600">Direct patient routing</p>
                  </div>
                </div>
                <div class="flex gap-3 p-3 bg-slate-50 rounded">
                  <i class="fa-solid fa-check text-sozo-600 mt-1"></i>
                  <div>
                    <p class="font-bold text-sm text-slate-900">Advanced Analytics</p>
                    <p class="text-xs text-slate-600">Full business intelligence</p>
                  </div>
                </div>
                <div class="flex gap-3 p-3 bg-slate-50 rounded">
                  <i class="fa-solid fa-check text-sozo-600 mt-1"></i>
                  <div>
                    <p class="font-bold text-sm text-slate-900">24/7 Support</p>
                    <p class="text-xs text-slate-600">Dedicated account manager</p>
                  </div>
                </div>
                <div class="flex gap-3 p-3 bg-slate-50 rounded">
                  <i class="fa-solid fa-check text-sozo-600 mt-1"></i>
                  <div>
                    <p class="font-bold text-sm text-slate-900">Training Workshops</p>
                    <p class="text-xs text-slate-600">Exclusive partner events</p>
                  </div>
                </div>
                <div class="flex gap-3 p-3 bg-slate-50 rounded">
                  <i class="fa-solid fa-check text-sozo-600 mt-1"></i>
                  <div>
                    <p class="font-bold text-sm text-slate-900">Co-Marketing</p>
                    <p class="text-xs text-slate-600">Joint promotion opportunities</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="p-6 border-t border-slate-200 flex justify-end gap-3 sticky bottom-0 bg-white">
            <button onclick="this.closest('.fixed').remove()" class="bg-slate-200 text-slate-700 px-6 py-2 rounded-lg font-bold hover:bg-slate-300">Close</button>
            <button onclick="openEditPartnerModal('${partner.id}')" class="bg-sozo-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-sozo-700">Edit Partner</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    };
    
    window.openEditPartnerModal = (id) => {
      const partner = sampleData.partnerships.find(p => p.id === id);
      if (!partner) return;
      
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/40 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-[90%] max-h-[90vh] overflow-y-auto">
          <div class="p-6 border-b border-slate-200 sticky top-0 bg-white">
            <h3 class="text-2xl font-bold text-slate-900">Edit Partnership</h3>
            <p class="text-sm text-slate-600 mt-1">Update partnership details</p>
          </div>
          <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">Partnership ID</label>
                <input type="text" value="${partner.id}" readonly class="input-royal bg-slate-50 cursor-not-allowed" />
              </div>
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">Organization Name *</label>
                <input type="text" id="editPartnerName" value="${partner.name}" class="input-royal" />
              </div>
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">Contact Person *</label>
                <input type="text" id="editPartnerContact" value="${partner.contactPerson}" class="input-royal" />
              </div>
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">Email *</label>
                <input type="email" id="editPartnerEmail" value="${partner.email}" class="input-royal" />
              </div>
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">Phone *</label>
                <input type="tel" id="editPartnerPhone" value="${partner.phone}" class="input-royal" />
              </div>
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">Revenue (€) *</label>
                <input type="number" id="editPartnerRevenue" value="${partner.revenue}" class="input-royal" />
              </div>
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">City *</label>
                <input type="text" id="editPartnerCity" value="${partner.city}" class="input-royal" />
              </div>
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">Country *</label>
                <input type="text" id="editPartnerCountry" value="${partner.country}" class="input-royal" />
              </div>
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">Contract Date *</label>
                <input type="date" id="editPartnerContract" value="${partner.contractDate}" class="input-royal" />
              </div>
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">Status *</label>
                <select id="editPartnerStatus" class="input-royal">
                  <option value="Active" ${partner.status === 'Active' ? 'selected' : ''}>Active</option>
                  <option value="Inactive" ${partner.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                  <option value="Pending" ${partner.status === 'Pending' ? 'selected' : ''}>Pending</option>
                </select>
              </div>
            </div>
          </div>
          <div class="p-6 border-t border-slate-200 flex justify-end gap-3 sticky bottom-0 bg-white">
            <button onclick="this.closest('.fixed').remove()" class="bg-slate-200 text-slate-700 px-6 py-2 rounded-lg font-bold hover:bg-slate-300">Cancel</button>
            <button onclick="saveEditPartner('${partner.id}')" class="bg-sozo-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-sozo-700">Save Changes</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    };
    
    window.saveEditPartner = (id) => {
      const partner = sampleData.partnerships.find(p => p.id === id);
      if (!partner) return;
      
      // Update partner data
      partner.name = document.getElementById('editPartnerName').value.trim();
      partner.contactPerson = document.getElementById('editPartnerContact').value.trim();
      partner.email = document.getElementById('editPartnerEmail').value.trim();
      partner.phone = document.getElementById('editPartnerPhone').value.trim();
      partner.revenue = parseInt(document.getElementById('editPartnerRevenue').value) || 0;
      partner.city = document.getElementById('editPartnerCity').value.trim();
      partner.country = document.getElementById('editPartnerCountry').value.trim();
      partner.contractDate = document.getElementById('editPartnerContract').value;
      partner.status = document.getElementById('editPartnerStatus').value;
      
      // Validate required fields
      if (!partner.name || !partner.contactPerson || !partner.email || !partner.phone || !partner.city || !partner.country) {
        alert('Please fill in all required fields');
        return;
      }
      
      alert('Partnership updated successfully!');
      document.querySelector('.fixed')?.remove();
      renderAdmin('partnerships');
    };
    
    window.openRegisterPartnerModal = () => {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/40 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-[90%] max-h-[90vh] overflow-y-auto">
          <div class="p-6 border-b border-slate-200 sticky top-0 bg-white">
            <h3 class="text-2xl font-bold text-slate-900">Register New Partnership</h3>
            <p class="text-sm text-slate-600 mt-1">One-time partnership fee: <span class="font-bold text-sozo-600">€80,000</span></p>
          </div>
          <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">Organization Name *</label>
                <input type="text" id="regPartnerName" placeholder="e.g., Munich Medical Center" class="input-royal" />
              </div>
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">Contact Person *</label>
                <input type="text" id="regPartnerContact" placeholder="e.g., Dr. Hans Müller" class="input-royal" />
              </div>
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">Email *</label>
                <input type="email" id="regPartnerEmail" placeholder="e.g., contact@organization.de" class="input-royal" />
              </div>
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">Phone *</label>
                <input type="tel" id="regPartnerPhone" placeholder="e.g., +49 30 123456" class="input-royal" />
              </div>
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">City *</label>
                <input type="text" id="regPartnerCity" placeholder="e.g., Munich" class="input-royal" />
              </div>
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">Country *</label>
                <input type="text" id="regPartnerCountry" placeholder="e.g., Germany" class="input-royal" />
              </div>
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">Annual Revenue (€) *</label>
                <input type="number" id="regPartnerRevenue" placeholder="e.g., 250000" class="input-royal" />
              </div>
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">Contract Date *</label>
                <input type="date" id="regPartnerContract" class="input-royal" />
              </div>
              <div class="md:col-span-2">
                <label class="text-xs font-bold text-slate-600 block mb-2">Organization Description</label>
                <textarea id="regPartnerDescription" placeholder="Brief description of your organization..." class="input-royal" rows="3"></textarea>
              </div>
              <div class="md:col-span-2 p-4 bg-blue-50 rounded-lg border border-blue-200">
                <p class="text-xs text-blue-900"><strong>Partnership Fee:</strong> €80,000 (one-time) includes premium support, priority referrals, and advanced analytics dashboard.</p>
              </div>
              <div class="md:col-span-2">
                <label class="flex items-center gap-3 cursor-pointer">
                  <input type="checkbox" id="regPartnerAgree" class="w-4 h-4 rounded" />
                  <span class="text-xs text-slate-700">I agree to the partnership terms and one-time €80,000 registration fee</span>
                </label>
              </div>
            </div>
          </div>
          <div class="p-6 border-t border-slate-200 flex justify-end gap-3 sticky bottom-0 bg-white">
            <button onclick="this.closest('.fixed').remove()" class="bg-slate-200 text-slate-700 px-6 py-2 rounded-lg font-bold hover:bg-slate-300">Cancel</button>
            <button onclick="submitPartnerRegistration()" class="bg-sozo-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-sozo-700">Register Partnership</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    };
    
    window.submitPartnerRegistration = () => {
      // Get form values
      const name = document.getElementById('regPartnerName').value.trim();
      const contactPerson = document.getElementById('regPartnerContact').value.trim();
      const email = document.getElementById('regPartnerEmail').value.trim();
      const phone = document.getElementById('regPartnerPhone').value.trim();
      const city = document.getElementById('regPartnerCity').value.trim();
      const country = document.getElementById('regPartnerCountry').value.trim();
      const revenue = parseInt(document.getElementById('regPartnerRevenue').value) || 0;
      const contractDate = document.getElementById('regPartnerContract').value;
      const agreed = document.getElementById('regPartnerAgree').checked;
      
      // Validate required fields
      if (!name || !contactPerson || !email || !phone || !city || !country || !contractDate) {
        alert('Please fill in all required fields');
        return;
      }
      
      // Validate email format
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        alert('Please enter a valid email address');
        return;
      }
      
      // Check agreement
      if (!agreed) {
        alert('Please agree to the partnership terms');
        return;
      }
      
      // Generate new partnership ID
      const existingIds = sampleData.partnerships.map(p => parseInt(p.id.split('-')[1]));
      const newId = 'PA-' + String(Math.max(0, ...existingIds) + 1).padStart(3, '0');
      
      // Create new partnership
      const newPartnership = {
        id: newId,
        name: name,
        city: city,
        country: country,
        revenue: revenue,
        status: 'Active',
        contactPerson: contactPerson,
        email: email,
        phone: phone,
        contractDate: contractDate
      };
      
      // Add to partnerships
      sampleData.partnerships.unshift(newPartnership);
      
      // Show success message
      alert('Partnership registered successfully!\n\nPartnership ID: ' + newId + '\nRegistration Fee: €80,000 charged\n\nWelcome to the Sozo Partnership Program!');
      
      // Close modal and refresh
      document.querySelector('.fixed')?.remove();
      renderAdmin('partnerships');
    };
    
    window.deletePartner = (id) => {
      if(confirm('Are you sure you want to delete this partner?')) {
        sampleData.partnerships = sampleData.partnerships.filter(p => p.id !== id);
        renderAdmin('partnerships');
      }
    };

    // Filter and Sort functionality
    window.filterPartnerTable = () => {
      const searchTerm = document.getElementById('partnerSearch')?.value.toLowerCase() || '';
      const countryFilter = document.getElementById('partnerCountryFilter')?.value || '';
      const statusFilter = document.getElementById('partnerStatusFilter')?.value || '';
      const sortBy = document.getElementById('partnerSortBy')?.value || 'name';
      const tableBody = document.getElementById('partnerTableBody');
      
      if(!tableBody) return;
      
      // Get all rows
      let rows = Array.from(tableBody.getElementsByTagName('tr')).map(row => ({
        element: row,
        data: {
          name: row.cells[1]?.textContent || '',
          organization: row.cells[1]?.textContent || '',
          email: row.cells[2]?.textContent || '',
          location: row.cells[3]?.textContent || '',
          country: row.cells[3]?.textContent.split(',')[1]?.trim() || '',
          revenue: parseInt(row.cells[4]?.textContent.replace(/[^0-9]/g, '') || 0),
          status: row.cells[5]?.textContent.trim() || ''
        }
      }));
      
      // Apply filters
      rows = rows.filter(row => {
        const matchSearch = !searchTerm || 
          row.data.name.toLowerCase().includes(searchTerm) || 
          row.data.email.toLowerCase().includes(searchTerm);
        const matchCountry = !countryFilter || row.data.country.includes(countryFilter);
        const matchStatus = !statusFilter || row.data.status.includes(statusFilter);
        return matchSearch && matchCountry && matchStatus;
      });
      
      // Apply sorting
      rows.sort((a, b) => {
        switch(sortBy) {
          case 'revenue-desc':
            return b.data.revenue - a.data.revenue;
          case 'revenue-asc':
            return a.data.revenue - b.data.revenue;
          case 'country':
            return a.data.country.localeCompare(b.data.country);
          case 'status':
            return a.data.status.localeCompare(b.data.status);
          case 'name':
          default:
            return a.data.name.localeCompare(b.data.name);
        }
      });
      
      // Update visibility
      Array.from(tableBody.getElementsByTagName('tr')).forEach(row => {
        row.style.display = 'none';
      });
      
      rows.forEach(row => {
        row.element.style.display = '';
      });
    };

    // Search functionality
    setTimeout(() => {
      const searchInput = document.getElementById('partnerSearch');
      const countryFilter = document.getElementById('partnerCountryFilter');
      const statusFilter = document.getElementById('partnerStatusFilter');
      const sortBy = document.getElementById('partnerSortBy');
      
      if(searchInput) searchInput.addEventListener('input', filterPartnerTable);
      if(countryFilter) countryFilter.addEventListener('change', filterPartnerTable);
      if(statusFilter) statusFilter.addEventListener('change', filterPartnerTable);
      if(sortBy) sortBy.addEventListener('change', filterPartnerTable);
    }, 100);
  }
  else if (key === 'appointments') {
    area.innerHTML = `
      <div class="p-8">
      <div class="mb-6 flex justify-between items-center flex-wrap gap-4">
        <div>
          <h2 class="text-2xl font-bold">Appointments Management</h2>
          <p class="text-slate-500 text-sm">Schedule and manage patient appointments</p>
        </div>
        <button class="bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-sozo-700" onclick="openScheduleAppointmentModal()">+ Schedule Appointment</button>
      </div>

      <div class="card p-0 overflow-hidden">
        <div class="p-4 border-b bg-slate-50 flex justify-between items-center">
          <h3 class="font-bold">Appointments List</h3>
          <div class="relative">
            <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
            <input type="text" id="appointmentSearch" placeholder="Search appointments..." class="pl-10 pr-4 py-1 border border-slate-300 rounded-lg text-sm focus:outline-none focus:border-sozo-500 w-64">
          </div>
        </div>
        <table>
          <thead><tr><th>ID</th><th>Patient Name</th><th>Doctor</th><th>Date</th><th>Time</th><th>Type</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="appointmentTableBody">
            ${sampleData.appointments.map(apt => `
              <tr>
                <td><strong>${apt.id}</strong></td>
                <td>${apt.patientName}</td>
                <td>${apt.doctorName}</td>
                <td>${apt.date}</td>
                <td>${apt.time}</td>
                <td>${apt.type}</td>
                <td><span class="badge badge-${apt.status === 'Completed' ? 'success' : apt.status === 'Rescheduled' ? 'warning' : 'info'}">${apt.status}</span></td>
                <td class="flex gap-2">
                  <button class="text-blue-600 hover:text-blue-800 font-bold" onclick="showAppointmentDetail('${apt.id}')"><i class="fa-solid fa-info-circle"></i></button>
                  <button class="text-slate-400 hover:text-blue-600 font-bold" onclick="openEditAppointmentModal('${apt.id}')"><i class="fa-solid fa-edit"></i></button>
                  <button class="text-slate-400 hover:text-slate-600 font-bold" onclick="deleteAppointment('${apt.id}')"><i class="fa-solid fa-trash"></i></button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>

      <div id="appointmentDetailModal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 max-h-96 overflow-y-auto">
          <button onclick="document.getElementById('appointmentDetailModal').classList.add('hidden')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times text-xl"></i></button>
          <div id="appointmentDetailContent"></div>
        </div>
      </div>

      <div id="scheduleAppointmentModal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto flex flex-col">
          <div class="sticky top-0 bg-white border-b p-6 flex justify-between items-center">
            <h2 class="text-2xl font-bold">Schedule New Appointment</h2>
            <button onclick="document.getElementById('scheduleAppointmentModal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times text-xl"></i></button>
          </div>
          
          <div class="p-6 flex-1">
            <div class="space-y-4">
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-bold mb-1">Patient Name *</label>
                  <input type="text" id="schedulePatientName" class="input-royal w-full" placeholder="Select patient" />
                </div>
                <div>
                  <label class="block text-sm font-bold mb-1">Patient ID *</label>
                  <input type="text" id="schedulePatientId" class="input-royal w-full" placeholder="P-001" />
                </div>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-bold mb-1">Doctor Name *</label>
                  <input type="text" id="scheduleDoctorName" class="input-royal w-full" placeholder="Select doctor" />
                </div>
                <div>
                  <label class="block text-sm font-bold mb-1">Doctor ID *</label>
                  <input type="text" id="scheduleDoctorId" class="input-royal w-full" placeholder="D-001" />
                </div>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-bold mb-1">Date *</label>
                  <input type="date" id="scheduleDate" class="input-royal w-full" />
                </div>
                <div>
                  <label class="block text-sm font-bold mb-1">Time *</label>
                  <input type="time" id="scheduleTime" class="input-royal w-full" />
                </div>
              </div>

              <div>
                <label class="block text-sm font-bold mb-1">Appointment Type *</label>
                <select id="scheduleType" class="input-royal w-full">
                  <option value="">Select Type</option>
                  <option value="FNON Assessment">FNON Assessment</option>
                  <option value="Brain Mapping">Brain Mapping</option>
                  <option value="PRS Assessment">PRS Assessment</option>
                  <option value="Final Report Review">Final Report Review</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-bold mb-1">Location *</label>
                <input type="text" id="scheduleLocation" class="input-royal w-full" placeholder="e.g., Berlin, Germany" />
              </div>

              <div>
                <label class="block text-sm font-bold mb-1">Status *</label>
                <select id="scheduleStatus" class="input-royal w-full">
                  <option value="Scheduled">Scheduled</option>
                  <option value="Completed">Completed</option>
                  <option value="Rescheduled">Rescheduled</option>
                  <option value="Cancelled">Cancelled</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-bold mb-1">Notes</label>
                <textarea id="scheduleNotes" class="input-royal w-full h-20" placeholder="Add appointment notes..."></textarea>
              </div>
            </div>
          </div>

          <div class="sticky bottom-0 bg-white border-t p-6 flex gap-2">
            <button class="flex-1 bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-sozo-700" onclick="saveScheduleAppointment()">Schedule Appointment</button>
            <button class="flex-1 bg-slate-300 text-slate-700 px-4 py-2 rounded-lg font-bold hover:bg-slate-400" onclick="document.getElementById('scheduleAppointmentModal').classList.add('hidden')">Cancel</button>
          </div>
        </div>
      </div>

      <div id="editAppointmentModal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto flex flex-col">
          <div class="sticky top-0 bg-white border-b p-6 flex justify-between items-center">
            <h2 class="text-2xl font-bold">Edit Appointment</h2>
            <button onclick="document.getElementById('editAppointmentModal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times text-xl"></i></button>
          </div>
          
          <div class="p-6 flex-1">
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-bold mb-1">Appointment ID (Read-only)</label>
                <input type="text" id="editAptId" readonly class="input-royal w-full bg-slate-100" />
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-bold mb-1">Patient Name *</label>
                  <input type="text" id="editPatientName" class="input-royal w-full" />
                </div>
                <div>
                  <label class="block text-sm font-bold mb-1">Patient ID *</label>
                  <input type="text" id="editPatientId" class="input-royal w-full" />
                </div>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-bold mb-1">Doctor Name *</label>
                  <input type="text" id="editDoctorName" class="input-royal w-full" />
                </div>
                <div>
                  <label class="block text-sm font-bold mb-1">Doctor ID *</label>
                  <input type="text" id="editDoctorId" class="input-royal w-full" />
                </div>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-bold mb-1">Date *</label>
                  <input type="date" id="editDate" class="input-royal w-full" />
                </div>
                <div>
                  <label class="block text-sm font-bold mb-1">Time *</label>
                  <input type="time" id="editTime" class="input-royal w-full" />
                </div>
              </div>

              <div>
                <label class="block text-sm font-bold mb-1">Appointment Type *</label>
                <select id="editType" class="input-royal w-full">
                  <option value="">Select Type</option>
                  <option value="FNON Assessment">FNON Assessment</option>
                  <option value="Brain Mapping">Brain Mapping</option>
                  <option value="PRS Assessment">PRS Assessment</option>
                  <option value="Final Report Review">Final Report Review</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-bold mb-1">Location *</label>
                <input type="text" id="editLocation" class="input-royal w-full" />
              </div>

              <div>
                <label class="block text-sm font-bold mb-1">Status *</label>
                <select id="editStatus" class="input-royal w-full">
                  <option value="Scheduled">Scheduled</option>
                  <option value="Completed">Completed</option>
                  <option value="Rescheduled">Rescheduled</option>
                  <option value="Cancelled">Cancelled</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-bold mb-1">Notes</label>
                <textarea id="editNotes" class="input-royal w-full h-20" placeholder="Add appointment notes..."></textarea>
              </div>
            </div>
          </div>

          <div class="sticky bottom-0 bg-white border-t p-6 flex gap-2">
            <button class="flex-1 bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-sozo-700" onclick="saveEditAppointment()">Save Changes</button>
            <button class="flex-1 bg-slate-300 text-slate-700 px-4 py-2 rounded-lg font-bold hover:bg-slate-400" onclick="document.getElementById('editAppointmentModal').classList.add('hidden')">Cancel</button>
          </div>
        </div>
      </div>
      </div>
    `;

    window.showAppointmentDetail = (id) => {
      const apt = sampleData.appointments.find(x => x.id === id);
      if (!apt) return;
      const modal = document.getElementById('appointmentDetailModal');
      const content = document.getElementById('appointmentDetailContent');
      content.innerHTML = `
        <h3 class="text-2xl font-bold mb-4">${apt.patientName}</h3>
        <div class="grid grid-cols-2 gap-4 mb-6">
          <div><strong>Appointment ID:</strong> ${apt.id}</div>
          <div><strong>Status:</strong> <span class="badge badge-${apt.status === 'Completed' ? 'success' : apt.status === 'Rescheduled' ? 'warning' : 'info'}">${apt.status}</span></div>
          <div><strong>Patient ID:</strong> ${apt.patientId}</div>
          <div><strong>Doctor:</strong> ${apt.doctorName} (${apt.docId})</div>
          <div><strong>Date:</strong> ${apt.date}</div>
          <div><strong>Time:</strong> ${apt.time}</div>
          <div><strong>Type:</strong> ${apt.type}</div>
          <div><strong>Location:</strong> ${apt.location}</div>
        </div>
        <div class="bg-slate-100 p-4 rounded-lg mb-6">
          <strong>Notes:</strong>
          <p class="text-slate-700 mt-2">${apt.notes}</p>
        </div>
        <div class="flex gap-2">
          <button class="flex-1 bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-sozo-700">Edit Appointment</button>
          <button class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700">Send Reminder</button>
          <button class="flex-1 bg-slate-100 text-slate-600 px-4 py-2 rounded-lg font-bold hover:bg-slate-200" onclick="deleteAppointment('${apt.id}'); document.getElementById('appointmentDetailModal').classList.add('hidden')">Delete</button>
        </div>
      `;
      modal.classList.remove('hidden');
    };

    window.deleteAppointment = (id) => {
      if(confirm('Are you sure you want to delete this appointment?')) {
        sampleData.appointments = sampleData.appointments.filter(a => a.id !== id);
        loadSection('appointments');
      }
    };

    window.openScheduleAppointmentModal = () => {
      const modal = document.getElementById('scheduleAppointmentModal');
      document.getElementById('schedulePatientName').value = '';
      document.getElementById('schedulePatientId').value = '';
      document.getElementById('scheduleDoctorName').value = '';
      document.getElementById('scheduleDoctorId').value = '';
      document.getElementById('scheduleDate').value = '';
      document.getElementById('scheduleTime').value = '';
      document.getElementById('scheduleType').value = '';
      document.getElementById('scheduleLocation').value = '';
      document.getElementById('scheduleStatus').value = 'Scheduled';
      document.getElementById('scheduleNotes').value = '';
      modal.classList.remove('hidden');
    };

    window.saveScheduleAppointment = () => {
      const patientName = document.getElementById('schedulePatientName').value.trim();
      const patientId = document.getElementById('schedulePatientId').value.trim();
      const doctorName = document.getElementById('scheduleDoctorName').value.trim();
      const docId = document.getElementById('scheduleDoctorId').value.trim();
      const date = document.getElementById('scheduleDate').value;
      const time = document.getElementById('scheduleTime').value;
      const type = document.getElementById('scheduleType').value;
      const location = document.getElementById('scheduleLocation').value.trim();
      const status = document.getElementById('scheduleStatus').value;
      const notes = document.getElementById('scheduleNotes').value.trim();

      // Validation
      if (!patientName || !patientId || !doctorName || !docId || !date || !time || !type || !location) {
        alert('Please fill in all required fields');
        return;
      }

      // Generate appointment ID
      const nextId = Math.max(...sampleData.appointments.map(a => parseInt(a.id.split('-')[1])), 0) + 1;
      const newId = `APT-${String(nextId).padStart(3, '0')}`;

      // Create appointment
      const newAppointment = {
        id: newId,
        patientName,
        patientId,
        doctorName,
        docId,
        date,
        time,
        type,
        location,
        status,
        notes
      };

      sampleData.appointments.unshift(newAppointment);
      document.getElementById('scheduleAppointmentModal').classList.add('hidden');
      loadSection('appointments');
      alert(`Appointment "${newId}" scheduled successfully!`);
    };

    window.openEditAppointmentModal = (id) => {
      const apt = sampleData.appointments.find(a => a.id === id);
      if (!apt) return;

      document.getElementById('editAptId').value = apt.id;
      document.getElementById('editPatientName').value = apt.patientName;
      document.getElementById('editPatientId').value = apt.patientId;
      document.getElementById('editDoctorName').value = apt.doctorName;
      document.getElementById('editDoctorId').value = apt.docId;
      document.getElementById('editDate').value = apt.date;
      document.getElementById('editTime').value = apt.time;
      document.getElementById('editType').value = apt.type;
      document.getElementById('editLocation').value = apt.location;
      document.getElementById('editStatus').value = apt.status;
      document.getElementById('editNotes').value = apt.notes;

      document.getElementById('editAppointmentModal').classList.remove('hidden');
    };

    window.saveEditAppointment = () => {
      const id = document.getElementById('editAptId').value;
      const patientName = document.getElementById('editPatientName').value.trim();
      const patientId = document.getElementById('editPatientId').value.trim();
      const doctorName = document.getElementById('editDoctorName').value.trim();
      const docId = document.getElementById('editDoctorId').value.trim();
      const date = document.getElementById('editDate').value;
      const time = document.getElementById('editTime').value;
      const type = document.getElementById('editType').value;
      const location = document.getElementById('editLocation').value.trim();
      const status = document.getElementById('editStatus').value;
      const notes = document.getElementById('editNotes').value.trim();

      // Validation
      if (!patientName || !patientId || !doctorName || !docId || !date || !time || !type || !location) {
        alert('Please fill in all required fields');
        return;
      }

      // Update appointment
      const apt = sampleData.appointments.find(a => a.id === id);
      if (apt) {
        apt.patientName = patientName;
        apt.patientId = patientId;
        apt.doctorName = doctorName;
        apt.docId = docId;
        apt.date = date;
        apt.time = time;
        apt.type = type;
        apt.location = location;
        apt.status = status;
        apt.notes = notes;
      }

      document.getElementById('editAppointmentModal').classList.add('hidden');
      loadSection('appointments');
      alert('Appointment updated successfully!');
    };

    // Search functionality
    setTimeout(() => {
      const searchInput = document.getElementById('appointmentSearch');
      const tableBody = document.getElementById('appointmentTableBody');
      
      if(searchInput && tableBody) {
        searchInput.addEventListener('input', (e) => {
          const term = e.target.value.toLowerCase();
          const rows = tableBody.getElementsByTagName('tr');
          
          Array.from(rows).forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(term) ? '' : 'none';
          });
        });
      }
    }, 50);
  }
  else if (key === 'createvisit') {
    area.innerHTML = `
      <div class="p-8 flex flex-col items-center">
        <div class="mb-6 w-full max-w-4xl flex justify-between items-start">
          <div>
            <h2 class="text-2xl font-bold">Create Patient Visit</h2>
            <p class="text-slate-500 text-sm">Register a new patient visit with complete information</p>
          </div>
          <button type="button" onclick="window.openEditQuestionsModal()" class="bg-slate-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-slate-700"><i class="fa-solid fa-pencil mr-2"></i>Edit Questions</button>
        </div>
        
        <div class="card p-6 max-w-4xl mb-8 w-full" >
          <form id="visitForm" >
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
              <!-- Patient Selection -->
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">Select Patient <span class="text-slate-600">*</span></label>
                <select id="visitPatient" class="input-royal">
                  <option value="">Choose a patient</option>
                </select>
              </div>
              
              <!-- Doctor/Provider -->
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">Treating Doctor <span class="text-slate-600">*</span></label>
                <select id="visitDoctor" class="input-royal">
                  <option value="">Select doctor</option>
                </select>
              </div>
              
              <!-- Visit Reason -->
              <div class="md:col-span-2">
                <label class="text-xs font-bold text-slate-600 block mb-2">Visit Reason <span class="text-slate-600">*</span></label>
                <textarea id="visitReason" class="input-royal" rows="3" placeholder="e.g., Follow-up consultation, Initial assessment, Treatment review"></textarea>
              </div>
              
              <!-- Referred By -->
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">Referred By</label>
                <input id="visitReferredBy" type="text" class="input-royal" placeholder="Doctor/Hospital name"/>
              </div>
              
              <!-- Recommended By -->
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">Recommended By</label>
                <input id="visitRecommendedBy" type="text" class="input-royal" placeholder="Person/Organization"/>
              </div>
              
              <!-- Admission Date -->
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">Admission Date <span class="text-slate-600">*</span></label>
                <input id="visitAdmissionDate" type="date" class="input-royal"/>
              </div>
              
              <!-- Visit Date & Time -->
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">Visit Date & Time <span class="text-slate-600">*</span></label>
                <input id="visitDateTime" type="datetime-local" class="input-royal"/>
              </div>
              
              <!-- Visit Type -->
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">Visit Type <span class="text-slate-600">*</span></label>
                <select id="visitType" class="input-royal">
                  <option value="">Select type</option>
                  <option value="In-Person">In-Person</option>
                  <option value="Telehealth">Telehealth</option>
                  <option value="Follow-up">Follow-up</option>
                  <option value="Emergency">Emergency</option>
                </select>
              </div>
              
              <!-- Priority -->
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">Priority <span class="text-slate-600">*</span></label>
                <select id="visitPriority" class="input-royal">
                  <option value="">Select priority</option>
                  <option value="Routine">Routine</option>
                  <option value="Urgent">Urgent</option>
                  <option value="Emergency">Emergency</option>
                </select>
              </div>
              
              <!-- Chief Complaint -->
              <div class="md:col-span-2">
                <label class="text-xs font-bold text-slate-600 block mb-2">Chief Complaint</label>
                <textarea id="visitChiefComplaint" class="input-royal" rows="2" placeholder="Patient's main complaint or symptoms"></textarea>
              </div>
              
              <!-- Vital Signs -->
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">Blood Pressure (mmHg)</label>
                <input id="visitBP" type="text" class="input-royal" placeholder="e.g., 120/80"/>
              </div>
              
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">Heart Rate (bpm)</label>
                <input id="visitHR" type="number" class="input-royal" placeholder="e.g., 72"/>
              </div>
              
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">Temperature (°C)</label>
                <input id="visitTemp" type="number" step="0.1" class="input-royal" placeholder="e.g., 37.2"/>
              </div>
              
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-2">Weight (kg)</label>
                <input id="visitWeight" type="number" step="0.1" class="input-royal" placeholder="e.g., 70"/>
              </div>
              
              <!-- Notes -->
              <div class="md:col-span-2">
                <label class="text-xs font-bold text-slate-600 block mb-2">Additional Notes</label>
                <textarea id="visitNotes" class="input-royal" rows="3" placeholder="Any additional medical notes or observations"></textarea>
              </div>

              <!-- Custom Fields Section -->
              <div class="md:col-span-2 border-t pt-6">
                <div class="flex justify-between items-center mb-4">
                  <label class="text-xs font-bold text-slate-600">Custom Fields</label>
                  <button type="button" id="addCustomFieldBtn" class="bg-blue-500 text-white px-3 py-1 rounded text-xs font-bold hover:bg-blue-600">+ Add Field</button>
                </div>
                <div id="customFieldsContainer"></div>
              </div>
            </div>
            
            <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg mb-6">
              <p class="text-xs text-blue-800"><span class="font-bold">Note:</span> Fields marked with <span class="text-slate-600">*</span> are required. You can add custom fields using the "+ Add Field" button</p>
            </div>
            
            <div class="flex gap-3">
              <button type="submit" class="flex-1 bg-sozo-600 text-white px-4 py-3 rounded-lg font-bold hover:bg-sozo-700" id="visitSubmitBtn">Create Visit</button>
              <button type="reset" class="flex-1 bg-slate-300 text-slate-700 px-4 py-3 rounded-lg font-bold hover:bg-slate-400">Clear Form</button>
              <button type="button" class="flex-1 bg-slate-600 text-white px-4 py-3 rounded-lg font-bold hover:bg-slate-700" id="visitCancelEdit">Cancel</button>
            </div>
          </form>
        </div>

        <!-- Recent Visits List -->
        <div class="w-full max-w-6xl">
            <div class="mb-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <h3 class="text-xl font-bold text-slate-800">Recent Visits</h3>
            <div class="flex flex-wrap gap-2 w-full md:w-auto">
                <div class="relative flex-grow md:flex-grow-0">
                    <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                    <input type="text" id="visitSearch" placeholder="Search visits..." class="pl-10 pr-4 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:border-sozo-500 w-full md:w-64">
                </div>
                <div class="flex gap-1">
                    <button class="visitSort sort-btn active" data-sort="date-desc">Newest</button>
                    <button class="visitSort sort-btn" data-sort="date-asc">Oldest</button>
                    <button class="visitSort sort-btn" data-sort="priority">Priority</button>
                </div>
            </div>
            </div>

            <div class="card p-0 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                <thead class="bg-slate-50 text-slate-600 font-bold border-b">
                    <tr>
                    <th class="px-4 py-3">Date</th>
                    <th class="px-4 py-3">Patient</th>
                    <th class="px-4 py-3">Doctor</th>
                    <th class="px-4 py-3">Type</th>
                    <th class="px-4 py-3">Priority</th>
                    <th class="px-4 py-3">Reason</th>
                    <th class="px-4 py-3">Status</th>
                    <th class="px-4 py-3">Action</th>
                    </tr>
                </thead>
                <tbody id="visitTableBody">
                    <!-- Rows will be injected here -->
                </tbody>
                </table>
            </div>
            </div>
        </div>

      <!-- Edit Questions Modal -->
      <div id="editQuestionsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
          <h3 class="text-xl font-bold mb-4">Edit Form Questions</h3>
          <div id="editQuestionsContainer" class="space-y-3 mb-6">
            <!-- Questions will be injected here -->
          </div>
          <div class="flex gap-3">
            <button onclick="window.saveFormQuestions()" class="flex-1 bg-sozo-600 text-white px-4 py-3 rounded-lg font-bold hover:bg-sozo-700">Save Questions</button>
            <button onclick="window.closeEditQuestionsModal()" class="flex-1 bg-slate-600 text-white px-4 py-3 rounded-lg font-bold hover:bg-slate-700">Cancel</button>
          </div>
        </div>
      </div>
      </div>
    `;
    
    // Initialize form questions from localStorage
    const defaultFormQuestions = {
      visitPatient: 'Select Patient',
      visitDoctor: 'Treating Doctor',
      visitReason: 'Visit Reason',
      visitReferredBy: 'Referred By',
      visitRecommendedBy: 'Recommended By',
      visitAdmissionDate: 'Admission Date',
      visitDateTime: 'Visit Date & Time',
      visitType: 'Visit Type',
      visitPriority: 'Priority',
      visitChiefComplaint: 'Chief Complaint',
      visitBP: 'Blood Pressure (mmHg)',
      visitHR: 'Heart Rate (bpm)',
      visitTemp: 'Temperature (°C)',
      visitWeight: 'Weight (kg)',
      visitNotes: 'Additional Notes'
    };

    let formQuestions = JSON.parse(localStorage.getItem('visitFormQuestions')) || defaultFormQuestions;

    // Function to update form labels with custom questions
    function updateFormLabels() {
      Object.entries(formQuestions).forEach(([fieldId, question]) => {
        const element = document.getElementById(fieldId);
        if (element) {
          const label = element.closest('div').querySelector('label');
          if (label) {
            const required = label.textContent.includes('*') ? ' <span class="text-slate-600">*</span>' : '';
            label.innerHTML = question + required;
          }
        }
      });
    }

    // Window function to open edit questions modal
    window.openEditQuestionsModal = () => {
      const modal = document.getElementById('editQuestionsModal');
      const container = document.getElementById('editQuestionsContainer');
      
      container.innerHTML = Object.entries(formQuestions).map(([fieldId, question]) => `
        <div class="flex gap-2 items-center">
          <label class="w-40 text-xs font-bold text-slate-600">${fieldId}</label>
          <input type="text" class="flex-1 input-royal edit-question-input" data-field-id="${fieldId}" value="${question}"/>
        </div>
      `).join('');
      
      modal.classList.remove('hidden');
    };

    window.closeEditQuestionsModal = () => {
      document.getElementById('editQuestionsModal').classList.add('hidden');
    };

    window.saveFormQuestions = () => {
      document.querySelectorAll('.edit-question-input').forEach(input => {
        const fieldId = input.dataset.fieldId;
        const newQuestion = input.value.trim();
        if (newQuestion) {
          formQuestions[fieldId] = newQuestion;
        }
      });
      
      localStorage.setItem('visitFormQuestions', JSON.stringify(formQuestions));
      updateFormLabels();
      window.closeEditQuestionsModal();
      alert('Form questions updated successfully!');
    };

    // Populate dropdowns
    setTimeout(() => {
      const patientSelect = document.getElementById('visitPatient');
      const doctorSelect = document.getElementById('visitDoctor');
      const visitForm = document.getElementById('visitForm');
      
      if (!patientSelect || !doctorSelect) {
        console.error('Form elements not found');
        return;
      }
      
      // Populate patients
      if (sampleData && sampleData.patients) {
        sampleData.patients.forEach(p => {
          const option = document.createElement('option');
          option.value = p.id;
          option.textContent = p.name + ' (' + p.id + ')';
          patientSelect.appendChild(option);
        });
      }
      
      // Populate doctors
      if (sampleData && sampleData.doctors) {
        sampleData.doctors.forEach(d => {
          const option = document.createElement('option');
          option.value = d.id;
          option.textContent = d.name + ' - ' + (d.specialty || 'General');
          doctorSelect.appendChild(option);
        });
      }

      // Load visits from localStorage
      const storedVisits = localStorage.getItem('adminVisits');
      if (storedVisits) {
          sampleData.visits = JSON.parse(storedVisits);
      } else if (!sampleData.visits) {
          sampleData.visits = [];
      }

      function renderVisits() {
        const tbody = document.getElementById('visitTableBody');
        const searchInput = document.getElementById('visitSearch');
        if (!tbody || !searchInput) return;

        const searchTerm = searchInput.value.toLowerCase();
        const activeSortBtn = document.querySelector('.visitSort.active');
        const sortType = activeSortBtn ? activeSortBtn.dataset.sort : 'date-desc';

        let filtered = sampleData.visits.filter(v => 
            v.patientName.toLowerCase().includes(searchTerm) ||
            v.doctorName.toLowerCase().includes(searchTerm) ||
            v.visitReason.toLowerCase().includes(searchTerm) ||
            v.id.toLowerCase().includes(searchTerm)
        );

        // Sort
        filtered.sort((a, b) => {
            if (sortType === 'date-desc') return new Date(b.visitDateTime) - new Date(a.visitDateTime);
            if (sortType === 'date-asc') return new Date(a.visitDateTime) - new Date(b.visitDateTime);
            if (sortType === 'priority') {
                const pMap = { 'Emergency': 3, 'Urgent': 2, 'Routine': 1 };
                return (pMap[b.priority] || 0) - (pMap[a.priority] || 0);
            }
            return 0;
        });

        tbody.innerHTML = filtered.map(v => `
            <tr class="border-b hover:bg-slate-50">
                <td class="px-4 py-3 whitespace-nowrap">${new Date(v.visitDateTime).toLocaleString()}</td>
                <td class="px-4 py-3 font-medium">${v.patientName}</td>
                <td class="px-4 py-3">${v.doctorName}</td>
                <td class="px-4 py-3">${v.visitType}</td>
                <td class="px-4 py-3"><span class="badge badge-${v.priority === 'Emergency' ? 'danger' : v.priority === 'Urgent' ? 'warning' : 'info'}">${v.priority}</span></td>
                <td class="px-4 py-3 truncate max-w-xs" title="${v.visitReason}">${v.visitReason}</td>
                <td class="px-4 py-3"><span class="badge badge-success">${v.status}</span></td>
                <td class="px-4 py-3 text-center">
                  <button onclick="window.editVisit('${v.id}')" class="text-blue-600 hover:text-blue-800 mr-2" title="Edit"><i class="fa-solid fa-pen-to-square"></i></button>
                  <button onclick="window.deleteVisit('${v.id}')" class="text-slate-600 hover:text-slate-700" title="Delete"><i class="fa-solid fa-trash"></i></button>
                </td>
            </tr>
        `).join('') || '<tr><td colspan="8" class="p-4 text-center text-slate-500">No visits found</td></tr>';
      }

      // Event Listeners
      const searchInput = document.getElementById('visitSearch');
      if (searchInput) {
          searchInput.addEventListener('input', renderVisits);
      }

      document.querySelectorAll('.visitSort').forEach(btn => {
          btn.addEventListener('click', function() {
              document.querySelectorAll('.visitSort').forEach(b => b.classList.remove('active'));
              this.classList.add('active');
              renderVisits();
          });
      });

      renderVisits();

      // Apply custom questions to form labels
      updateFormLabels();
      
      // Custom Fields Management
      let customFieldCounter = 0;
      const customFieldsContainer = document.getElementById('customFieldsContainer');
      const addCustomFieldBtn = document.getElementById('addCustomFieldBtn');

      function addCustomField(fieldName = '', fieldValue = '') {
        customFieldCounter++;
        const fieldId = 'customField_' + customFieldCounter;
        const fieldDiv = document.createElement('div');
        fieldDiv.id = fieldId;
        fieldDiv.className = 'flex gap-2 mb-3';
        fieldDiv.innerHTML = `
          <input type="text" class="flex-1 input-royal custom-field-name" placeholder="Field name" value="${fieldName}"/>
          <input type="text" class="flex-1 input-royal custom-field-value" placeholder="Field value" value="${fieldValue}"/>
          <button type="button" class="bg-slate-600 text-white px-3 py-2 rounded text-xs font-bold hover:bg-slate-600 delete-custom-field" data-field-id="${fieldId}">Remove</button>
        `;
        customFieldsContainer.appendChild(fieldDiv);

        fieldDiv.querySelector('.delete-custom-field').addEventListener('click', () => {
          fieldDiv.remove();
        });
      }

      if (addCustomFieldBtn) {
        addCustomFieldBtn.addEventListener('click', (e) => {
          e.preventDefault();
          addCustomField();
        });
      }
      
      // Form submission
      window.currentEditingVisitId = null;

      if (visitForm) {
        visitForm.addEventListener('submit', (e) => {
          e.preventDefault();
          
          const patientId = document.getElementById('visitPatient').value;
          const doctorId = document.getElementById('visitDoctor').value;
          const visitReason = document.getElementById('visitReason').value.trim();
          const visitDate = document.getElementById('visitDateTime').value;
          const visitType = document.getElementById('visitType').value;
          const priority = document.getElementById('visitPriority').value;
          
          if (!patientId || !doctorId || !visitReason || !visitDate || !visitType || !priority) {
            alert('Please fill all required fields');
            return;
          }
          
          // Collect custom fields
          const customFields = {};
          document.querySelectorAll('#customFieldsContainer > div').forEach(fieldDiv => {
            const name = fieldDiv.querySelector('.custom-field-name').value.trim();
            const value = fieldDiv.querySelector('.custom-field-value').value.trim();
            if (name && value) {
              customFields[name] = value;
            }
          });

          if (window.currentEditingVisitId) {
            // Edit existing visit
            const visitIndex = sampleData.visits.findIndex(v => v.id === window.currentEditingVisitId);
            if (visitIndex !== -1) {
              sampleData.visits[visitIndex] = {
                ...sampleData.visits[visitIndex],
                patientId,
                patientName: patientSelect.options[patientSelect.selectedIndex].text.split(' (')[0],
                doctorId,
                doctorName: doctorSelect.options[doctorSelect.selectedIndex].text,
                visitReason,
                referredBy: document.getElementById('visitReferredBy').value.trim(),
                recommendedBy: document.getElementById('visitRecommendedBy').value.trim(),
                admissionDate: document.getElementById('visitAdmissionDate').value,
                visitDateTime: visitDate,
                visitType,
                priority,
                chiefComplaint: document.getElementById('visitChiefComplaint').value.trim(),
                bloodPressure: document.getElementById('visitBP').value.trim(),
                heartRate: document.getElementById('visitHR').value.trim(),
                temperature: document.getElementById('visitTemp').value.trim(),
                weight: document.getElementById('visitWeight').value.trim(),
                notes: document.getElementById('visitNotes').value.trim(),
                customFields: customFields
              };
              localStorage.setItem('adminVisits', JSON.stringify(sampleData.visits));
              alert('Visit updated successfully!');
            }
          } else {
            // Create new visit
            const visitRecord = {
              id: 'VISIT-' + Math.floor(100000 + Math.random() * 900000),
              patientId,
              patientName: patientSelect.options[patientSelect.selectedIndex].text.split(' (')[0],
              doctorId,
              doctorName: doctorSelect.options[doctorSelect.selectedIndex].text,
              visitReason,
              referredBy: document.getElementById('visitReferredBy').value.trim(),
              recommendedBy: document.getElementById('visitRecommendedBy').value.trim(),
              admissionDate: document.getElementById('visitAdmissionDate').value,
              visitDateTime: visitDate,
              visitType,
              priority,
              chiefComplaint: document.getElementById('visitChiefComplaint').value.trim(),
              bloodPressure: document.getElementById('visitBP').value.trim(),
              heartRate: document.getElementById('visitHR').value.trim(),
              temperature: document.getElementById('visitTemp').value.trim(),
              weight: document.getElementById('visitWeight').value.trim(),
              notes: document.getElementById('visitNotes').value.trim(),
              customFields: customFields,
              createdAt: new Date().toISOString(),
              status: 'Scheduled'
            };
            
            // Store visit record
            if (!sampleData.visits) sampleData.visits = [];
            sampleData.visits.unshift(visitRecord);
            localStorage.setItem('adminVisits', JSON.stringify(sampleData.visits));
            alert('Visit record created successfully!');
          }
          
          visitForm.reset();
          document.getElementById('customFieldsContainer').innerHTML = '';
          customFieldCounter = 0;
          document.getElementById('visitSubmitBtn').textContent = 'Create Visit';
          document.getElementById('visitCancelEdit').style.display = 'none';
          window.currentEditingVisitId = null;
          renderVisits();
        });
      }

      // Edit visit function
      window.editVisit = (visitId) => {
        const visit = sampleData.visits.find(v => v.id === visitId);
        if (!visit) return;

        // Populate form fields
        document.getElementById('visitPatient').value = visit.patientId;
        document.getElementById('visitDoctor').value = visit.doctorId;
        document.getElementById('visitReason').value = visit.visitReason;
        document.getElementById('visitReferredBy').value = visit.referredBy || '';
        document.getElementById('visitRecommendedBy').value = visit.recommendedBy || '';
        document.getElementById('visitAdmissionDate').value = visit.admissionDate || '';
        document.getElementById('visitDateTime').value = visit.visitDateTime;
        document.getElementById('visitType').value = visit.visitType;
        document.getElementById('visitPriority').value = visit.priority;
        document.getElementById('visitChiefComplaint').value = visit.chiefComplaint || '';
        document.getElementById('visitBP').value = visit.bloodPressure || '';
        document.getElementById('visitHR').value = visit.heartRate || '';
        document.getElementById('visitTemp').value = visit.temperature || '';
        document.getElementById('visitWeight').value = visit.weight || '';
        document.getElementById('visitNotes').value = visit.notes || '';

        // Populate custom fields
        document.getElementById('customFieldsContainer').innerHTML = '';
        customFieldCounter = 0;
        if (visit.customFields && Object.keys(visit.customFields).length > 0) {
          Object.entries(visit.customFields).forEach(([fieldName, fieldValue]) => {
            addCustomField(fieldName, fieldValue);
          });
        }

        // Update button state
        document.getElementById('visitSubmitBtn').textContent = 'Update Visit';
        document.getElementById('visitCancelEdit').style.display = 'inline-block';
        window.currentEditingVisitId = visitId;

        // Scroll form into view
        document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
      };

      // Delete visit function
      window.deleteVisit = (visitId) => {
        if (confirm('Are you sure you want to delete this visit record?')) {
          sampleData.visits = sampleData.visits.filter(v => v.id !== visitId);
          localStorage.setItem('adminVisits', JSON.stringify(sampleData.visits));
          alert('Visit deleted successfully!');
          renderVisits();
        }
      };

      // Cancel edit function
      const cancelBtn = document.getElementById('visitCancelEdit');
      if (cancelBtn) {
        cancelBtn.addEventListener('click', (e) => {
          e.preventDefault();
          visitForm.reset();
          document.getElementById('customFieldsContainer').innerHTML = '';
          customFieldCounter = 0;
          document.getElementById('visitSubmitBtn').textContent = 'Create Visit';
          cancelBtn.style.display = 'none';
          window.currentEditingVisitId = null;
        });
      }
    }, 50);
  }
  else if (key === 'devices') {
    area.innerHTML = `
      <div class="p-8">
        <div class="mb-6 flex justify-between items-center flex-wrap gap-4">
          <div>
            <h2 class="text-2xl font-bold">Supply Chain Management</h2>
            <p class="text-slate-500 text-sm">Monitor inventory, orders, and device utilization</p>
          </div>
          <div class="flex gap-2">
            <button onclick="window.openImportCSVModal()" class="bg-white border border-slate-300 text-slate-600 px-4 py-2 rounded-lg font-bold text-sm hover:bg-slate-50"><i class="fa-solid fa-file-import mr-2"></i>Import CSV</button>
            <button onclick="window.openNewOrderModal()" class="bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-sozo-700"><i class="fa-solid fa-plus mr-2"></i>New Order</button>
          </div>
        </div>

        <!-- Time Period Filter -->
        <div class="mb-6 flex flex-wrap gap-3 items-center">
          <label class="text-xs font-bold text-slate-600">TIME PERIOD:</label>
          <button class="supplySort active" data-period="day">Day</button>
          <button class="supplySort" data-period="week">Week</button>
          <button class="supplySort" data-period="quarter">Quarter</button>
          <button class="supplySort" data-period="half-year">Half-Year</button>
          <button class="supplySort" data-period="year">Year</button>
        </div>

        <!-- KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <!-- Pending Orders -->
          <div class="kpi-card">
            <div class="kpi-icon" style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: white;">
              <i class="fa-solid fa-clock"></i>
            </div>
            <div class="flex-1">
              <div class="kpi-label">Pending Orders</div>
              <div class="kpi-value" id="scPendingOrders">24</div>
              <div class="text-xs text-slate-500 mt-1">Awaiting fulfillment</div>
            </div>
          </div>

          <!-- Device Usage -->
          <div class="kpi-card">
            <div class="kpi-icon" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;">
              <i class="fa-solid fa-chart-line"></i>
            </div>
            <div class="flex-1">
              <div class="kpi-label">Device Usage Rate</div>
              <div class="kpi-value" id="scDeviceUsage">87<span class="text-xl">%</span></div>
              <div class="text-xs text-slate-500 mt-1">Active devices in circulation</div>
            </div>
          </div>

          <!-- Stock Levels -->
          <div class="kpi-card">
            <div class="kpi-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
              <i class="fa-solid fa-boxes-stacked"></i>
            </div>
            <div class="flex-1">
              <div class="kpi-label">Stock Levels</div>
              <div class="kpi-value" id="scStockLevel">342</div>
              <div class="text-xs text-slate-500 mt-1">Units in warehouse</div>
            </div>
          </div>
        </div>

        <!-- Device Usage Analytics Section -->
        <div class="card p-6 mb-8">
          <div class="mb-6">
            <h3 class="font-bold text-lg mb-4">Device Usage Analytics</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <!-- User Type Filter -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">User Type</label>
                <select id="analyticsUserType" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sozo-500 focus:border-transparent">
                  <option value="doctor">Doctor Usage</option>
                  <option value="patient">Patient Usage</option>
                </select>
              </div>
              
              <!-- Time Period Filter -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">Time Period</label>
                <select id="analyticsTimePeriod" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sozo-500 focus:border-transparent">
                  <option value="day">Day</option>
                  <option value="week">Week</option>
                  <option value="month">Month</option>
                  <option value="half-year">Half-Year</option>
                  <option value="year">Year</option>
                </select>
              </div>

              <!-- Refresh Button -->
              <div class="flex items-end">
                <button onclick="window.generateDeviceChart()" class="w-full px-4 py-2 bg-sozo-600 text-white rounded-lg hover:bg-sozo-700 font-medium">
                  <i class="fa-solid fa-chart-line mr-2"></i>Generate Chart
                </button>
              </div>
            </div>
          </div>

          <!-- Chart Container -->
          <div class="bg-slate-50 rounded-lg p-6 border border-slate-200">
            <canvas id="deviceUsageChart" height="80"></canvas>
          </div>

          <!-- Chart Legend -->
          <div class="mt-4 grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
            <div class="flex items-center">
              <div class="w-3 h-3 bg-blue-600 rounded-full mr-2"></div>
              <span class="text-slate-700">Device 1 (Neuro Headset Pro)</span>
            </div>
            <div class="flex items-center">
              <div class="w-3 h-3 bg-sozo-600 rounded-full mr-2"></div>
              <span class="text-slate-700">Device 2 (Bio-Sensor Kit)</span>
            </div>
            <div class="flex items-center">
              <div class="w-3 h-3 bg-slate-600 rounded-full mr-2"></div>
              <span class="text-slate-700">Device 3 (Sleep Tracker Elite)</span>
            </div>
            <div class="flex items-center">
              <div class="w-3 h-3 bg-orange-600 rounded-full mr-2"></div>
              <span class="text-slate-700">Device 4 (Sozo Ring)</span>
            </div>
            <div class="flex items-center">
              <div class="w-3 h-3 bg-slate-600 rounded-full mr-2"></div>
              <span class="text-slate-700">Device 5 (Pulse Monitor)</span>
            </div>
            <div class="flex items-center">
              <div class="w-3 h-3 bg-brand-blue rounded-full mr-2"></div>
              <span class="text-slate-700">Device 6 (Brain Stim Device)</span>
            </div>
          </div>
        </div>

        <!-- Inventory Table -->
        <div class="card p-0 overflow-hidden mb-6">
          <div class="p-6 border-b border-slate-200 bg-slate-50">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-bold text-lg">Inventory Overview</h3>
            </div>
            <!-- Filters -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Search</label>
                <input type="text" id="inventorySearchInput" placeholder="Search by name or SKU..." class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sozo-500 focus:border-transparent">
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Category</label>
                <select id="inventoryCategoryFilter" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sozo-500 focus:border-transparent">
                  <option value="">All Categories</option>
                  <option value="Neurofeedback">Neurofeedback</option>
                  <option value="Monitoring">Monitoring</option>
                  <option value="Sleep Analysis">Sleep Analysis</option>
                  <option value="Wearable">Wearable</option>
                  <option value="Neuromodulation">Neuromodulation</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Status</label>
                <select id="inventoryStatusFilter" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sozo-500 focus:border-transparent">
                  <option value="">All Status</option>
                  <option value="In Stock">In Stock</option>
                  <option value="Low Stock">Low Stock</option>
                  <option value="Critical">Critical</option>
                </select>
              </div>
              <div class="flex items-end">
                <button onclick="window.resetInventoryFilters()" class="w-full px-4 py-2 bg-slate-500 text-white rounded-lg hover:bg-slate-600 font-medium">
                  <i class="fa-solid fa-rotate-right mr-2"></i>Reset
                </button>
              </div>
            </div>
          </div>
          <div class="overflow-x-auto">
            <table>
              <thead>
                <tr>
                  <th>SKU</th>
                  <th>Device Name</th>
                  <th>Category</th>
                  <th>In Stock</th>
                  <th>Reserved</th>
                  <th>Available</th>
                  <th>Reorder Level</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="supplyChainTableBody">
                <tr>
                  <td class="font-mono text-xs">SKU-NH-001</td>
                  <td class="font-bold">Neuro Headset Pro</td>
                  <td>Neurofeedback</td>
                  <td class="font-bold">145</td>
                  <td>32</td>
                  <td class="text-sozo-600 font-bold">113</td>
                  <td>50</td>
                  <td><span class="badge badge-success">In Stock</span></td>
                  <td>
                    <button onclick="window.editInventoryItem(this)" class="text-sozo-600 hover:text-sozo-700 mr-2" title="Edit"><i class="fa-solid fa-edit"></i></button>
                    <button onclick="window.quickOrderFromInventory(this)" class="text-blue-600 hover:text-blue-700" title="Order"><i class="fa-solid fa-cart-plus"></i></button>
                  </td>
                </tr>
                <tr>
                  <td class="font-mono text-xs">SKU-BS-002</td>
                  <td class="font-bold">Bio-Sensor Kit</td>
                  <td>Monitoring</td>
                  <td class="font-bold">89</td>
                  <td>15</td>
                  <td class="text-sozo-600 font-bold">74</td>
                  <td>30</td>
                  <td><span class="badge badge-success">In Stock</span></td>
                  <td>
                    <button onclick="window.editInventoryItem(this)" class="text-sozo-600 hover:text-sozo-700 mr-2" title="Edit"><i class="fa-solid fa-edit"></i></button>
                    <button onclick="window.quickOrderFromInventory(this)" class="text-blue-600 hover:text-blue-700" title="Order"><i class="fa-solid fa-cart-plus"></i></button>
                  </td>
                </tr>
                <tr>
                  <td class="font-mono text-xs">SKU-ST-003</td>
                  <td class="font-bold">Sleep Tracker Elite</td>
                  <td>Sleep Analysis</td>
                  <td class="font-bold">23</td>
                  <td>8</td>
                  <td class="text-slate-600 font-bold">15</td>
                  <td>25</td>
                  <td><span class="badge badge-warning">Low Stock</span></td>
                  <td>
                    <button onclick="window.editInventoryItem(this)" class="text-sozo-600 hover:text-sozo-700 mr-2" title="Edit"><i class="fa-solid fa-edit"></i></button>
                    <button onclick="window.quickOrderFromInventory(this)" class="text-blue-600 hover:text-blue-700" title="Order"><i class="fa-solid fa-cart-plus"></i></button>
                  </td>
                </tr>
                <tr>
                  <td class="font-mono text-xs">SKU-SR-004</td>
                  <td class="font-bold">Sozo Ring</td>
                  <td>Wearable</td>
                  <td class="font-bold">67</td>
                  <td>12</td>
                  <td class="text-sozo-600 font-bold">55</td>
                  <td>40</td>
                  <td><span class="badge badge-success">In Stock</span></td>
                  <td>
                    <button onclick="window.editInventoryItem(this)" class="text-sozo-600 hover:text-sozo-700 mr-2" title="Edit"><i class="fa-solid fa-edit"></i></button>
                    <button onclick="window.quickOrderFromInventory(this)" class="text-blue-600 hover:text-blue-700" title="Order"><i class="fa-solid fa-cart-plus"></i></button>
                  </td>
                </tr>
                <tr>
                  <td class="font-mono text-xs">SKU-PM-005</td>
                  <td class="font-bold">Pulse Monitor</td>
                  <td>Monitoring</td>
                  <td class="font-bold">5</td>
                  <td>3</td>
                  <td class="text-slate-600 font-bold">2</td>
                  <td>20</td>
                  <td><span class="badge badge-danger">Critical</span></td>
                  <td>
                    <button onclick="window.editInventoryItem(this)" class="text-sozo-600 hover:text-sozo-700 mr-2" title="Edit"><i class="fa-solid fa-edit"></i></button>
                    <button onclick="window.quickOrderFromInventory(this)" class="text-blue-600 hover:text-blue-700" title="Order"><i class="fa-solid fa-cart-plus"></i></button>
                  </td>
                </tr>
                <tr>
                  <td class="font-mono text-xs">SKU-BS-006</td>
                  <td class="font-bold">Brain Stim Device</td>
                  <td>Neuromodulation</td>
                  <td class="font-bold">13</td>
                  <td>7</td>
                  <td class="text-slate-600 font-bold">6</td>
                  <td>10</td>
                  <td><span class="badge badge-warning">Low Stock</span></td>
                  <td>
                    <button onclick="window.editInventoryItem(this)" class="text-sozo-600 hover:text-sozo-700 mr-2" title="Edit"><i class="fa-solid fa-edit"></i></button>
                    <button onclick="window.quickOrderFromInventory(this)" class="text-blue-600 hover:text-blue-700" title="Order"><i class="fa-solid fa-cart-plus"></i></button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Recent Orders -->
        <div class="card p-0 overflow-hidden">
          <div class="p-6 border-b border-slate-200 bg-slate-50">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-bold text-lg">Recent Orders</h3>
            </div>
            <!-- Filters -->
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mt-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Search</label>
                <input type="text" id="ordersSearchInput" placeholder="Search by Order ID or Device..." class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sozo-500 focus:border-transparent">
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Status</label>
                <select id="ordersStatusFilter" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sozo-500 focus:border-transparent">
                  <option value="">All Status</option>
                  <option value="In Transit">In Transit</option>
                  <option value="Processing">Processing</option>
                  <option value="Delivered">Delivered</option>
                  <option value="Cancelled">Cancelled</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Supplier</label>
                <select id="ordersSupplierFilter" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sozo-500 focus:border-transparent">
                  <option value="">All Suppliers</option>
                  <option value="MedTech Corp">MedTech Corp</option>
                  <option value="HealthTech Inc">HealthTech Inc</option>
                  <option value="NeuroSupply Ltd">NeuroSupply Ltd</option>
                  <option value="BioMed Solutions">BioMed Solutions</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Date From</label>
                <input type="date" id="ordersDateFrom" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sozo-500 focus:border-transparent">
              </div>
              <div class="flex items-end">
                <button onclick="window.resetOrdersFilters()" class="w-full px-4 py-2 bg-slate-500 text-white rounded-lg hover:bg-slate-600 font-medium">
                  <i class="fa-solid fa-rotate-right mr-2"></i>Reset
                </button>
              </div>
            </div>
          </div>
          <div class="overflow-x-auto">
            <table>
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Date</th>
                  <th>Device</th>
                  <th>Quantity</th>
                  <th>Supplier</th>
                  <th>Expected Delivery</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="font-mono text-xs">ORD-2026-0089</td>
                  <td>Jan 1, 2026</td>
                  <td class="font-bold">Pulse Monitor</td>
                  <td class="font-bold">50</td>
                  <td>MedTech Corp</td>
                  <td>Jan 15, 2026</td>
                  <td><span class="badge badge-warning">In Transit</span></td>
                </tr>
                <tr>
                  <td class="font-mono text-xs">ORD-2026-0088</td>
                  <td>Dec 28, 2025</td>
                  <td class="font-bold">Sleep Tracker Elite</td>
                  <td class="font-bold">30</td>
                  <td>HealthTech Inc</td>
                  <td>Jan 10, 2026</td>
                  <td><span class="badge badge-warning">Processing</span></td>
                </tr>
                <tr>
                  <td class="font-mono text-xs">ORD-2025-0087</td>
                  <td>Dec 20, 2025</td>
                  <td class="font-bold">Neuro Headset Pro</td>
                  <td class="font-bold">25</td>
                  <td>NeuroSupply Ltd</td>
                  <td>Jan 5, 2026</td>
                  <td><span class="badge badge-success">Delivered</span></td>
                </tr>
                <tr>
                  <td class="font-mono text-xs">ORD-2025-0086</td>
                  <td>Dec 15, 2025</td>
                  <td class="font-bold">Bio-Sensor Kit</td>
                  <td class="font-bold">40</td>
                  <td>BioMed Solutions</td>
                  <td>Dec 30, 2025</td>
                  <td><span class="badge badge-success">Delivered</span></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Import CSV Modal -->
        <div id="importCSVModal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
          <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-8">
            <div class="flex justify-between items-center mb-6">
              <h3 class="font-bold text-2xl text-sozo-700">Import Device Inventory from CSV</h3>
              <button onclick="document.getElementById('importCSVModal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600">
                <i class="fa-solid fa-times text-xl"></i>
              </button>
            </div>
            
            <div class="mb-6">
              <div class="border-2 border-dashed border-slate-300 rounded-lg p-8 text-center hover:border-sozo-500 transition cursor-pointer" id="csvDropZone">
                <i class="fa-solid fa-cloud-arrow-up text-5xl text-slate-400 mb-4"></i>
                <p class="text-lg font-medium text-slate-700 mb-2">Drag and drop your CSV file here</p>
                <p class="text-sm text-slate-500 mb-4">or</p>
                <label class="inline-block bg-sozo-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-sozo-700 cursor-pointer">
                  <i class="fa-solid fa-file-arrow-up mr-2"></i>Browse Files
                  <input type="file" id="csvFileInput" accept=".csv" class="hidden">
                </label>
                <p class="text-xs text-slate-500 mt-4">Maximum file size: 10MB</p>
              </div>
              <div id="csvFileName" class="mt-4 text-sm text-slate-600 hidden">
                <i class="fa-solid fa-file-csv text-sozo-600 mr-2"></i>
                <span id="csvFileNameText"></span>
                <button onclick="window.clearCSVFile()" class="ml-2 text-slate-600 hover:text-slate-700">
                  <i class="fa-solid fa-times"></i>
                </button>
              </div>
            </div>

            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
              <h4 class="font-bold text-blue-900 mb-2"><i class="fa-solid fa-info-circle mr-2"></i>CSV Format Requirements</h4>
              <p class="text-sm text-blue-800 mb-2">Your CSV file should contain the following columns:</p>
              <code class="block bg-white p-2 rounded text-xs text-slate-800 mb-2">SKU, Device Name, Category, In Stock, Reserved, Available, Reorder Level, Status</code>
              <a href="#" onclick="window.downloadCSVTemplate(); return false;" class="text-sm text-blue-600 hover:text-blue-700 font-medium">
                <i class="fa-solid fa-download mr-1"></i>Download Template CSV
              </a>
            </div>

            <div class="flex gap-3">
              <button onclick="document.getElementById('importCSVModal').classList.add('hidden')" class="flex-1 px-4 py-3 border border-slate-300 text-slate-700 rounded-lg font-bold hover:bg-slate-50">
                Cancel
              </button>
              <button onclick="window.processCSVImport()" class="flex-1 px-4 py-3 bg-sozo-600 text-white rounded-lg font-bold hover:bg-sozo-700">
                <i class="fa-solid fa-file-import mr-2"></i>Import Data
              </button>
            </div>
          </div>
        </div>

        <!-- New Order Modal -->
        <div id="newOrderModal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50 overflow-y-auto p-4">
          <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto p-8 my-4">
            <div class="flex justify-between items-center mb-6">
              <h3 class="font-bold text-2xl text-sozo-700">Create New Device Order</h3>
              <button onclick="document.getElementById('newOrderModal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600">
                <i class="fa-solid fa-times text-xl"></i>
              </button>
            </div>
            
            <form id="newOrderForm" onsubmit="window.submitNewOrder(event)" class="space-y-6">
              <!-- Order Information -->
              <div class="bg-slate-50 p-4 rounded-lg">
                <h4 class="font-bold text-lg text-slate-700 mb-4">Order Information</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Order ID <span class="text-slate-600">*</span></label>
                    <input type="text" id="orderId" value="ORD-2026-" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sozo-500 focus:border-transparent">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Order Date <span class="text-slate-600">*</span></label>
                    <input type="date" id="orderDate" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sozo-500 focus:border-transparent">
                  </div>
                </div>
              </div>

              <!-- Device Details -->
              <div class="bg-slate-50 p-4 rounded-lg">
                <h4 class="font-bold text-lg text-slate-700 mb-4">Device Details</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Device Name <span class="text-slate-600">*</span></label>
                    <select id="deviceName" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sozo-500 focus:border-transparent">
                      <option value="">Select Device</option>
                      <option value="Neuro Headset Pro">Neuro Headset Pro</option>
                      <option value="Bio-Sensor Kit">Bio-Sensor Kit</option>
                      <option value="Sleep Tracker Elite">Sleep Tracker Elite</option>
                      <option value="Sozo Ring">Sozo Ring</option>
                      <option value="Pulse Monitor">Pulse Monitor</option>
                      <option value="Brain Stim Device">Brain Stim Device</option>
                      <option value="EEG Headband">EEG Headband</option>
                      <option value="Heart Rate Monitor">Heart Rate Monitor</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Quantity <span class="text-slate-600">*</span></label>
                    <input type="number" id="orderQuantity" min="1" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sozo-500 focus:border-transparent" placeholder="e.g., 50">
                  </div>
                </div>
              </div>

              <!-- Supplier Information -->
              <div class="bg-slate-50 p-4 rounded-lg">
                <h4 class="font-bold text-lg text-slate-700 mb-4">Supplier Information</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Supplier <span class="text-slate-600">*</span></label>
                    <select id="supplierName" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sozo-500 focus:border-transparent">
                      <option value="">Select Supplier</option>
                      <option value="MedTech Corp">MedTech Corp</option>
                      <option value="HealthTech Inc">HealthTech Inc</option>
                      <option value="NeuroSupply Ltd">NeuroSupply Ltd</option>
                      <option value="BioMed Solutions">BioMed Solutions</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Expected Delivery <span class="text-slate-600">*</span></label>
                    <input type="date" id="expectedDelivery" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sozo-500 focus:border-transparent">
                  </div>
                </div>
              </div>

              <!-- Order Status -->
              <div class="bg-slate-50 p-4 rounded-lg">
                <h4 class="font-bold text-lg text-slate-700 mb-4">Order Status</h4>
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-1">Status <span class="text-slate-600">*</span></label>
                  <select id="orderStatus" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sozo-500 focus:border-transparent">
                    <option value="Processing">Processing</option>
                    <option value="In Transit">In Transit</option>
                    <option value="Delivered">Delivered</option>
                    <option value="Cancelled">Cancelled</option>
                  </select>
                </div>
              </div>

              <!-- Notes -->
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Order Notes (Optional)</label>
                <textarea id="orderNotes" rows="3" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sozo-500 focus:border-transparent" placeholder="Add any additional notes about this order..."></textarea>
              </div>

              <div class="flex gap-3 pt-4 border-t">
                <button type="button" onclick="document.getElementById('newOrderModal').classList.add('hidden')" class="flex-1 px-4 py-3 border border-slate-300 text-slate-700 rounded-lg font-bold hover:bg-slate-50">
                  Cancel
                </button>
                <button type="submit" class="flex-1 px-4 py-3 bg-sozo-600 text-white rounded-lg font-bold hover:bg-sozo-700">
                  <i class="fa-solid fa-plus mr-2"></i>Create Order
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Edit Inventory Item Modal -->
        <div id="editInventoryModal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50 overflow-y-auto p-4">
          <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto p-8 my-4">
            <div class="flex justify-between items-center mb-6">
              <h3 class="font-bold text-2xl text-sozo-700">Edit Inventory Item</h3>
              <button onclick="document.getElementById('editInventoryModal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600">
                <i class="fa-solid fa-times text-xl"></i>
              </button>
            </div>
            
            <form id="editInventoryForm" onsubmit="window.saveInventoryItem(event)" class="space-y-6">
              <!-- Device Information -->
              <div class="bg-slate-50 p-4 rounded-lg">
                <h4 class="font-bold text-lg text-slate-700 mb-4">Device Information</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">SKU <span class="text-slate-600">*</span></label>
                    <input type="text" id="editSKU" readonly class="w-full px-3 py-2 border border-slate-300 rounded-lg bg-slate-100" placeholder="SKU-NH-001">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Device Name <span class="text-slate-600">*</span></label>
                    <input type="text" id="editDeviceName" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sozo-500 focus:border-transparent" placeholder="Neuro Headset Pro">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Category <span class="text-slate-600">*</span></label>
                    <select id="editCategory" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sozo-500 focus:border-transparent">
                      <option value="">Select Category</option>
                      <option value="Neurofeedback">Neurofeedback</option>
                      <option value="Monitoring">Monitoring</option>
                      <option value="Sleep Analysis">Sleep Analysis</option>
                      <option value="Wearable">Wearable</option>
                      <option value="Neuromodulation">Neuromodulation</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Reorder Level <span class="text-slate-600">*</span></label>
                    <input type="number" id="editReorderLevel" required min="0" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sozo-500 focus:border-transparent" placeholder="50">
                  </div>
                </div>
              </div>

              <!-- Stock Information -->
              <div class="bg-slate-50 p-4 rounded-lg">
                <h4 class="font-bold text-lg text-slate-700 mb-4">Stock Information</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">In Stock <span class="text-slate-600">*</span></label>
                    <input type="number" id="editInStock" required min="0" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sozo-500 focus:border-transparent" placeholder="145">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Reserved <span class="text-slate-600">*</span></label>
                    <input type="number" id="editReserved" required min="0" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sozo-500 focus:border-transparent" placeholder="32">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Available (Calculated)</label>
                    <input type="number" id="editAvailable" readonly class="w-full px-3 py-2 border border-slate-300 rounded-lg bg-slate-100" placeholder="113">
                  </div>
                </div>
              </div>

              <div class="flex gap-3 pt-4 border-t">
                <button type="button" onclick="document.getElementById('editInventoryModal').classList.add('hidden')" class="flex-1 px-4 py-3 border border-slate-300 text-slate-700 rounded-lg font-bold hover:bg-slate-50">
                  Cancel
                </button>
                <button type="submit" class="flex-1 px-4 py-3 bg-sozo-600 text-white rounded-lg font-bold hover:bg-sozo-700">
                  <i class="fa-solid fa-save mr-2"></i>Save Changes
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    `;

    // Supply Chain Filter Logic
    setTimeout(() => {
      const supplyData = {
        day: { pending: 3, usage: 92, stock: 342 },
        week: { pending: 8, usage: 89, stock: 342 },
        quarter: { pending: 24, usage: 87, stock: 342 },
        'half-year': { pending: 45, usage: 84, stock: 342 },
        year: { pending: 78, usage: 81, stock: 342 }
      };

      document.querySelectorAll('.supplySort').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.supplySort').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          
          const period = this.dataset.period;
          const data = supplyData[period];
          
          document.getElementById('scPendingOrders').textContent = data.pending;
          document.getElementById('scDeviceUsage').innerHTML = data.usage + '<span class="text-xl">%</span>';
          document.getElementById('scStockLevel').textContent = data.stock;
        });
      });

      // Inventory Overview Filter Functions
      const inventoryTableBody = document.getElementById('supplyChainTableBody');
      const inventoryRows = Array.from(inventoryTableBody.querySelectorAll('tr'));
      
      const filterInventory = () => {
        const searchValue = document.getElementById('inventorySearchInput').value.toLowerCase();
        const categoryValue = document.getElementById('inventoryCategoryFilter').value;
        const statusValue = document.getElementById('inventoryStatusFilter').value;
        
        inventoryRows.forEach(row => {
          const sku = row.cells[0]?.textContent.toLowerCase() || '';
          const name = row.cells[1]?.textContent.toLowerCase() || '';
          const category = row.cells[2]?.textContent || '';
          const statusBadge = row.cells[7]?.querySelector('.badge')?.textContent || '';
          
          const matchesSearch = searchValue === '' || sku.includes(searchValue) || name.includes(searchValue);
          const matchesCategory = categoryValue === '' || category === categoryValue;
          const matchesStatus = statusValue === '' || statusBadge === statusValue;
          
          row.style.display = matchesSearch && matchesCategory && matchesStatus ? '' : 'none';
        });
      };
      
      document.getElementById('inventorySearchInput')?.addEventListener('input', filterInventory);
      document.getElementById('inventoryCategoryFilter')?.addEventListener('change', filterInventory);
      document.getElementById('inventoryStatusFilter')?.addEventListener('change', filterInventory);
      
      window.resetInventoryFilters = () => {
        document.getElementById('inventorySearchInput').value = '';
        document.getElementById('inventoryCategoryFilter').value = '';
        document.getElementById('inventoryStatusFilter').value = '';
        filterInventory();
      };

      // Recent Orders Filter Functions
      const ordersTableBody = document.querySelector('.card.p-0.overflow-hidden:not(.mb-6) tbody');
      const ordersRows = ordersTableBody ? Array.from(ordersTableBody.querySelectorAll('tr')) : [];
      
      const filterOrders = () => {
        const searchValue = document.getElementById('ordersSearchInput')?.value.toLowerCase() || '';
        const statusValue = document.getElementById('ordersStatusFilter')?.value || '';
        const supplierValue = document.getElementById('ordersSupplierFilter')?.value || '';
        const dateFromValue = document.getElementById('ordersDateFrom')?.value || '';
        
        ordersRows.forEach(row => {
          const orderId = row.cells[0]?.textContent.toLowerCase() || '';
          const orderDate = row.cells[1]?.textContent || '';
          const device = row.cells[2]?.textContent.toLowerCase() || '';
          const supplier = row.cells[4]?.textContent || '';
          const statusBadge = row.cells[6]?.querySelector('.badge')?.textContent || '';
          
          const matchesSearch = searchValue === '' || orderId.includes(searchValue) || device.includes(searchValue);
          const matchesStatus = statusValue === '' || statusBadge === statusValue;
          const matchesSupplier = supplierValue === '' || supplier === supplierValue;
          
          let matchesDate = true;
          if (dateFromValue) {
            const rowDate = new Date(orderDate);
            const filterDate = new Date(dateFromValue);
            matchesDate = rowDate >= filterDate;
          }
          
          row.style.display = matchesSearch && matchesStatus && matchesSupplier && matchesDate ? '' : 'none';
        });
      };
      
      document.getElementById('ordersSearchInput')?.addEventListener('input', filterOrders);
      document.getElementById('ordersStatusFilter')?.addEventListener('change', filterOrders);
      document.getElementById('ordersSupplierFilter')?.addEventListener('change', filterOrders);
      document.getElementById('ordersDateFrom')?.addEventListener('change', filterOrders);
      
      window.resetOrdersFilters = () => {
        if (document.getElementById('ordersSearchInput')) document.getElementById('ordersSearchInput').value = '';
        if (document.getElementById('ordersStatusFilter')) document.getElementById('ordersStatusFilter').value = '';
        if (document.getElementById('ordersSupplierFilter')) document.getElementById('ordersSupplierFilter').value = '';
        if (document.getElementById('ordersDateFrom')) document.getElementById('ordersDateFrom').value = '';
        filterOrders();
      };

      // Import CSV Modal Functions
      window.openImportCSVModal = () => {
        document.getElementById('importCSVModal').classList.remove('hidden');
        // Set today's date as default
        const today = new Date().toISOString().split('T')[0];
      };

      let selectedCSVFile = null;

      window.clearCSVFile = () => {
        selectedCSVFile = null;
        document.getElementById('csvFileInput').value = '';
        document.getElementById('csvFileName').classList.add('hidden');
      };

      const csvFileInput = document.getElementById('csvFileInput');
      const csvDropZone = document.getElementById('csvDropZone');

      if (csvFileInput) {
        csvFileInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
            if (file.size > 10 * 1024 * 1024) {
              alert('File size exceeds 10MB limit!');
              return;
            }
            if (!file.name.endsWith('.csv')) {
              alert('Please select a CSV file!');
              return;
            }
            selectedCSVFile = file;
            document.getElementById('csvFileNameText').textContent = file.name;
            document.getElementById('csvFileName').classList.remove('hidden');
          }
        });
      }

      if (csvDropZone) {
        csvDropZone.addEventListener('dragover', (e) => {
          e.preventDefault();
          csvDropZone.classList.add('border-sozo-500', 'bg-sozo-50');
        });

        csvDropZone.addEventListener('dragleave', () => {
          csvDropZone.classList.remove('border-sozo-500', 'bg-sozo-50');
        });

        csvDropZone.addEventListener('drop', (e) => {
          e.preventDefault();
          csvDropZone.classList.remove('border-sozo-500', 'bg-sozo-50');
          const file = e.dataTransfer.files[0];
          if (file) {
            if (file.size > 10 * 1024 * 1024) {
              alert('File size exceeds 10MB limit!');
              return;
            }
            if (!file.name.endsWith('.csv')) {
              alert('Please select a CSV file!');
              return;
            }
            selectedCSVFile = file;
            document.getElementById('csvFileNameText').textContent = file.name;
            document.getElementById('csvFileName').classList.remove('hidden');
          }
        });
      }

      window.downloadCSVTemplate = () => {
        const template = 'SKU,Device Name,Category,In Stock,Reserved,Available,Reorder Level,Status\n' +
                        'SKU-NH-001,Neuro Headset Pro,Neurofeedback,145,32,113,50,In Stock\n' +
                        'SKU-BS-002,Bio-Sensor Kit,Monitoring,89,15,74,30,In Stock\n' +
                        'SKU-ST-003,Sleep Tracker Elite,Sleep Analysis,23,8,15,25,Low Stock';
        
        const blob = new Blob([template], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'device_inventory_template.csv';
        a.click();
        window.URL.revokeObjectURL(url);
      };

      window.processCSVImport = () => {
        if (!selectedCSVFile) {
          alert('Please select a CSV file first!');
          return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const csv = e.target.result;
            const lines = csv.split('\n');
            const headers = lines[0].split(',');
            
            let importedCount = 0;
            const tbody = document.getElementById('supplyChainTableBody');
            
            for (let i = 1; i < lines.length; i++) {
              if (lines[i].trim() === '') continue;
              
              const values = lines[i].split(',');
              if (values.length < 8) continue;
              
              const row = document.createElement('tr');
              row.innerHTML = `
                <td class="font-mono text-xs">${values[0]}</td>
                <td class="font-bold">${values[1]}</td>
                <td>${values[2]}</td>
                <td class="font-bold">${values[3]}</td>
                <td>${values[4]}</td>
                <td class="text-sozo-600 font-bold">${values[5]}</td>
                <td>${values[6]}</td>
                <td><span class="badge badge-${values[7].includes('Low') ? 'warning' : values[7].includes('Critical') ? 'danger' : 'success'}">${values[7]}</span></td>
                <td>
                  <button class="text-sozo-600 hover:text-sozo-700 mr-2" title="Edit"><i class="fa-solid fa-edit"></i></button>
                  <button class="text-blue-600 hover:text-blue-700" title="Order"><i class="fa-solid fa-cart-plus"></i></button>
                </td>
              `;
              tbody.appendChild(row);
              importedCount++;
            }
            
            alert(`Successfully imported ${importedCount} devices!`);
            document.getElementById('importCSVModal').classList.add('hidden');
            window.clearCSVFile();
          } catch (error) {
            alert('Error processing CSV file. Please check the format and try again.');
            console.error(error);
          }
        };
        reader.readAsText(selectedCSVFile);
      };

      // New Order Modal Functions
      window.openNewOrderModal = () => {
        document.getElementById('newOrderModal').classList.remove('hidden');
        // Set today's date and generate order ID
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('orderDate').value = today;
        
        // Generate next order ID
        const orderNum = String(Math.floor(Math.random() * 9000) + 1000).padStart(4, '0');
        document.getElementById('orderId').value = `ORD-2026-${orderNum}`;
        
        // Set default expected delivery (2 weeks from now)
        const delivery = new Date();
        delivery.setDate(delivery.getDate() + 14);
        document.getElementById('expectedDelivery').value = delivery.toISOString().split('T')[0];
      };

      window.submitNewOrder = (event) => {
        event.preventDefault();
        
        const orderId = document.getElementById('orderId').value;
        const orderDate = document.getElementById('orderDate').value;
        const deviceName = document.getElementById('deviceName').value;
        const quantity = document.getElementById('orderQuantity').value;
        const supplier = document.getElementById('supplierName').value;
        const expectedDelivery = document.getElementById('expectedDelivery').value;
        const status = document.getElementById('orderStatus').value;
        const notes = document.getElementById('orderNotes').value;

        // Format dates
        const formatDate = (dateStr) => {
          const date = new Date(dateStr);
          return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        };

        // Get the Recent Orders table body
        const ordersTable = document.querySelector('.card.p-0.overflow-hidden:not(.mb-6) tbody');
        
        // Create new row
        const newRow = document.createElement('tr');
        const statusClass = status === 'Delivered' ? 'success' : status === 'In Transit' ? 'warning' : status === 'Processing' ? 'warning' : 'danger';
        
        newRow.innerHTML = `
          <td class="font-mono text-xs">${orderId}</td>
          <td>${formatDate(orderDate)}</td>
          <td class="font-bold">${deviceName}</td>
          <td class="font-bold">${quantity}</td>
          <td>${supplier}</td>
          <td>${formatDate(expectedDelivery)}</td>
          <td><span class="badge badge-${statusClass}">${status}</span></td>
        `;
        
        // Add to top of table
        ordersTable.insertBefore(newRow, ordersTable.firstChild);
        
        // Show success message
        alert(`Order ${orderId} created successfully!\n\nDevice: ${deviceName}\nQuantity: ${quantity}\nSupplier: ${supplier}\nStatus: ${status}${notes ? '\nNotes: ' + notes : ''}`);
        
        // Close modal and reset form
        document.getElementById('newOrderModal').classList.add('hidden');
        document.getElementById('newOrderForm').reset();
      };

      // Edit Inventory Item Function
      window.editInventoryItem = (button) => {
        const row = button.closest('tr');
        const cells = row.cells;
        
        // Populate the edit form with current values
        document.getElementById('editSKU').value = cells[0].textContent.trim();
        document.getElementById('editDeviceName').value = cells[1].textContent.trim();
        document.getElementById('editCategory').value = cells[2].textContent.trim();
        document.getElementById('editInStock').value = cells[3].textContent.trim();
        document.getElementById('editReserved').value = cells[4].textContent.trim();
        document.getElementById('editAvailable').value = cells[5].textContent.trim();
        document.getElementById('editReorderLevel').value = cells[6].textContent.trim();
        
        // Store the row reference for saving later
        window.currentEditingRow = row;
        
        // Calculate available on change
        const updateAvailable = () => {
          const inStock = parseInt(document.getElementById('editInStock').value) || 0;
          const reserved = parseInt(document.getElementById('editReserved').value) || 0;
          document.getElementById('editAvailable').value = inStock - reserved;
        };
        
        document.getElementById('editInStock').addEventListener('input', updateAvailable);
        document.getElementById('editReserved').addEventListener('input', updateAvailable);
        
        // Show modal
        document.getElementById('editInventoryModal').classList.remove('hidden');
      };

      // Save Inventory Item Function
      window.saveInventoryItem = (event) => {
        event.preventDefault();
        
        if (!window.currentEditingRow) return;
        
        const row = window.currentEditingRow;
        const cells = row.cells;
        
        // Get form values
        const sku = document.getElementById('editSKU').value;
        const deviceName = document.getElementById('editDeviceName').value;
        const category = document.getElementById('editCategory').value;
        const inStock = document.getElementById('editInStock').value;
        const reserved = document.getElementById('editReserved').value;
        const available = document.getElementById('editAvailable').value;
        const reorderLevel = document.getElementById('editReorderLevel').value;
        
        // Calculate status
        const availableNum = parseInt(available);
        const reorderNum = parseInt(reorderLevel);
        let status, badgeClass, textClass;
        
        if (availableNum <= 5) {
          status = 'Critical';
          badgeClass = 'badge-danger';
          textClass = 'text-slate-600';
        } else if (availableNum <= reorderNum) {
          status = 'Low Stock';
          badgeClass = 'badge-warning';
          textClass = 'text-slate-600';
        } else {
          status = 'In Stock';
          badgeClass = 'badge-success';
          textClass = 'text-sozo-600';
        }
        
        // Update the row
        cells[0].innerHTML = `<span class="font-mono text-xs">${sku}</span>`;
        cells[1].innerHTML = `<span class="font-bold">${deviceName}</span>`;
        cells[2].textContent = category;
        cells[3].innerHTML = `<span class="font-bold">${inStock}</span>`;
        cells[4].textContent = reserved;
        cells[5].innerHTML = `<span class="${textClass} font-bold">${available}</span>`;
        cells[6].textContent = reorderLevel;
        cells[7].innerHTML = `<span class="badge ${badgeClass}">${status}</span>`;
        
        // Success message
        alert(`Inventory item "${deviceName}" updated successfully!`);
        
        // Close modal
        document.getElementById('editInventoryModal').classList.add('hidden');
        window.currentEditingRow = null;
      };

      // Quick Order from Inventory Function
      window.quickOrderFromInventory = (button) => {
        const row = button.closest('tr');
        const cells = row.cells;
        
        const deviceName = cells[1].textContent.trim();
        const available = parseInt(cells[5].textContent.trim());
        const reorderLevel = parseInt(cells[6].textContent.trim());
        const status = cells[7].textContent.trim();
        
        // Open new order modal
        window.openNewOrderModal();
        
        // Pre-fill with device name
        setTimeout(() => {
          document.getElementById('deviceName').value = deviceName;
          
          // Suggest quantity based on status
          let suggestedQty;
          if (status === 'Critical') {
            suggestedQty = Math.max(reorderLevel * 2, 50);
          } else if (status === 'Low Stock') {
            suggestedQty = Math.max(reorderLevel - available, 30);
          } else {
            suggestedQty = reorderLevel;
          }
          
          document.getElementById('orderQuantity').value = suggestedQty;
          
          // Add note about stock status
          if (status === 'Critical' || status === 'Low Stock') {
            document.getElementById('orderNotes').value = `Urgent restock needed - Current status: ${status} (${available} available)`;
          }
        }, 100);
      };
    }, 50);
  }
  else if (key === 'patients') {
    area.innerHTML = `
      <div class="p-8">
      <div class="mb-6 flex justify-between items-center flex-wrap gap-4">
        <div>
          <h2 class="text-2xl font-bold">Patients Database</h2>
          <p class="text-slate-500 text-sm">Manage all patient records and health data</p>
        </div>
        <button class="bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-sozo-700" id="addPatientBtnPatients">+ Add Patient</button>
      </div>
      
      <div class="mb-6 flex flex-wrap gap-3 items-end">
        <div>
          <label class="text-xs font-bold text-slate-500 block mb-1">Search by Name/ID</label>
          <input id="patientSearch" type="text" placeholder="e.g., Alex Johnson or PAT-001" class="input-royal w-64">
        </div>
        <div>
          <label class="text-xs font-bold text-slate-500 block mb-1">Country</label>
          <select id="patientCountryFilter" class="input-royal w-48">
            <option value="">All Countries</option>
          </select>
        </div>
        <div>
          <label class="text-xs font-bold text-slate-500 block mb-1">Sort By</label>
          <select id="patientSort" class="input-royal w-48">
            <option value="name">Name (A-Z)</option>
            <option value="age">Age (Young to Old)</option>
            <option value="country">Country (A-Z)</option>
            <option value="health">Health Score (High to Low)</option>
            <option value="recent">Most Recent Visit</option>
          </select>
        </div>
      </div>
      
      <div class="card p-0 overflow-hidden">
        <div class="overflow-y-auto" style="max-height: calc(100vh - 220px); min-height: 400px;">
          <table>
            <thead><tr><th>ID</th><th>Name</th><th>Age</th><th>Gender</th><th>Country</th><th>Health Score</th><th>Condition</th><th>Last Visit</th></tr></thead>
            <tbody id="patientTableBody"></tbody>
          </table>
        </div>
      </div>
      
      <div id="patientDetailModal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-11/12 h-5/6 max-w-6xl p-8 overflow-y-auto">
          <button onclick="document.getElementById('patientDetailModal').classList.add('hidden')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times text-xl"></i></button>
          <div id="patientDetailContent"></div>
        </div>
      </div>
      
      <!-- Edit Patient Modal -->
      <div id="editPatientModal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50 overflow-y-auto p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto p-6 my-4">
          <button onclick="document.getElementById('editPatientModal').classList.add('hidden')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times text-xl"></i></button>
          <h3 class="font-bold text-2xl mb-6 text-sozo-700 sticky top-0 bg-white">Edit Patient Demographics</h3>
          <div id="editPatientForm"></div>
        </div>
      </div>
      
      <!-- Edit Doctor Modal -->
      <div id="editDoctorModal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50 overflow-y-auto p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto p-6 my-4">
          <button onclick="document.getElementById('editDoctorModal').classList.add('hidden')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times text-xl"></i></button>
          <h3 class="font-bold text-2xl mb-6 text-sozo-700 sticky top-0 bg-white">Edit Doctor Information</h3>
          <div id="editDoctorForm"></div>
        </div>
      </div>
      
      </div>
    `;
    
    // Create the modal outside of innerHTML so it persists
    if(!document.getElementById('addPatientModal')) {
      const modalHTML = document.createElement('div');
      modalHTML.id = 'addPatientModal';
      modalHTML.className = 'hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50 overflow-y-auto';
      modalHTML.innerHTML = `
        <div class="card p-6 w-[90%] max-w-4xl my-8">
          <h3 class="font-bold text-2xl mb-6 text-sozo-700">Add New Patient - Demographics</h3>
          
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div><label class="text-xs font-bold text-slate-600">First Name <span class="text-slate-600">*</span></label><input id="npFirstName" class="input-royal"/></div>
            <div><label class="text-xs font-bold text-slate-600">Last Name <span class="text-slate-600">*</span></label><input id="npLastName" class="input-royal"/></div>
            <div><label class="text-xs font-bold text-slate-600">Middle Name</label><input id="npMiddleName" class="input-royal"/></div>
            
            <div><label class="text-xs font-bold text-slate-600">Mother's Name</label><input id="npMotherName" class="input-royal"/></div>
            <div><label class="text-xs font-bold text-slate-600">Father's Name</label><input id="npFatherName" class="input-royal"/></div>
            <div><label class="text-xs font-bold text-slate-600">Date of Birth <span class="text-slate-600">*</span></label><input id="npDOB" type="date" class="input-royal"/></div>
            
            <div><label class="text-xs font-bold text-slate-600">Sex <span class="text-slate-600">*</span></label><select id="npSex" class="input-royal"><option value="">Select</option><option>Male</option><option>Female</option><option>Other</option></select></div>
            <div><label class="text-xs font-bold text-slate-600">TRN</label><input id="npTRN" class="input-royal" placeholder="Tax Reference Number"/></div>
            <div><label class="text-xs font-bold text-slate-600">Tax Office</label><input id="npTaxOffice" class="input-royal"/></div>
            
            <div><label class="text-xs font-bold text-slate-600">AMKA</label><input id="npAMKA" class="input-royal" placeholder="Social Security Number"/></div>
            <div><label class="text-xs font-bold text-slate-600">Identity Number <span class="text-slate-600">*</span></label><input id="npIdentityNum" class="input-royal"/></div>
            <div><label class="text-xs font-bold text-slate-600">ID Issue Date</label><input id="npIDIssueDate" type="date" class="input-royal"/></div>
            
            <div><label class="text-xs font-bold text-slate-600">ID Issue Body</label><input id="npIDIssueBody" class="input-royal"/></div>
            <div><label class="text-xs font-bold text-slate-600">Occupation Category</label><input id="npOccupationCat" class="input-royal"/></div>
            <div><label class="text-xs font-bold text-slate-600">Job Title</label><input id="npJobTitle" class="input-royal"/></div>
            
            <div><label class="text-xs font-bold text-slate-600">Email <span class="text-slate-600">*</span></label><input id="npEmail" type="email" class="input-royal"/></div>
            <div><label class="text-xs font-bold text-slate-600">Email 2</label><input id="npEmail2" type="email" class="input-royal"/></div>
            <div><label class="text-xs font-bold text-slate-600">Patient Category</label><input id="npPatientCategory" class="input-royal"/></div>
            
            <div><label class="text-xs font-bold text-slate-600">Phone</label><input id="npPhone" type="tel" class="input-royal"/></div>
            <div><label class="text-xs font-bold text-slate-600">Work Phone</label><input id="npWorkPhone" type="tel" class="input-royal"/></div>
            <div><label class="text-xs font-bold text-slate-600">Mobile <span class="text-slate-600">*</span></label><input id="npMobile" type="tel" class="input-royal"/></div>
            
            <div><label class="text-xs font-bold text-slate-600">First Visit Date</label><input id="npFirstVisitDate" type="date" class="input-royal"/></div>
            <div><label class="text-xs font-bold text-slate-600">Cancer Patient</label><div class="flex items-center gap-4 mt-1"><label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="npCancerPatient" class="w-5 h-5 rounded border-slate-300 text-sozo-600 focus:ring-sozo-500" /><span class="text-sm">Yes</span></label></div></div>
          </div>

          <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg mb-4">
            <p class="text-xs text-blue-800"><span class="font-bold">Note:</span> Fields marked with <span class="text-slate-600">*</span> are required</p>
          </div>

          <div class="flex gap-3">
            <button id="npSave" class="flex-1 bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-sozo-700">Save Patient</button>
            <button id="npCancel" class="flex-1 bg-slate-300 text-slate-700 px-4 py-2 rounded-lg font-bold hover:bg-slate-400">Cancel</button>
          </div>
        </div>
      `;
      document.body.appendChild(modalHTML);
    }

    setTimeout(() => {
      let patientList = [...sampleData.patients];
      const searchInput = document.getElementById('patientSearch');
      const sortSelect = document.getElementById('patientSort');
      const tbody = document.getElementById('patientTableBody');
      const addPatientBtn = document.getElementById('addPatientBtnPatients');
      const modal = document.getElementById('addPatientModal');
      const npSave = document.getElementById('npSave');
      const npCancel = document.getElementById('npCancel');
      
      if(addPatientBtn) {
        addPatientBtn.addEventListener('click', () => {
          modal.classList.remove('hidden');
        });
      }
      
      if(npCancel) {
        npCancel.addEventListener('click', () => {
          modal.classList.add('hidden');
        });
      }
      
      if(npSave) {
        npSave.addEventListener('click', () => {
          const firstName = document.getElementById('npFirstName').value.trim();
          const lastName = document.getElementById('npLastName').value.trim();
          const dob = document.getElementById('npDOB').value;
          const sex = document.getElementById('npSex').value;
          const identityNum = document.getElementById('npIdentityNum').value.trim();
          const email = document.getElementById('npEmail').value.trim();
          const mobile = document.getElementById('npMobile').value.trim();

          if(!firstName || !lastName || !dob || !sex || !identityNum || !email || !mobile) {
            alert('Please fill all required fields (marked with *)');
            return;
          }

          const birthDate = new Date(dob);
          const today = new Date();
          const age = today.getFullYear() - birthDate.getFullYear() - (today < new Date(today.getFullYear(), birthDate.getMonth(), birthDate.getDate()) ? 1 : 0);

          const id = generateSozoId(sampleData.patients.length + 1);
          const newPatient = {
            id, firstName, lastName,
            middleName: document.getElementById('npMiddleName').value.trim(),
            motherName: document.getElementById('npMotherName').value.trim(),
            fatherName: document.getElementById('npFatherName').value.trim(),
            dob, age, sex, name: `${firstName} ${lastName}`, gender: sex,
            trn: document.getElementById('npTRN').value.trim(),
            taxOffice: document.getElementById('npTaxOffice').value.trim(),
            amka: document.getElementById('npAMKA').value.trim(),
            identityNumber: identityNum,
            idIssueDate: document.getElementById('npIDIssueDate').value,
            idIssueBody: document.getElementById('npIDIssueBody').value.trim(),
            occupationCategory: document.getElementById('npOccupationCat').value.trim(),
            jobTitle: document.getElementById('npJobTitle').value.trim(),
            email, email2: document.getElementById('npEmail2').value.trim(),
            patientCategory: document.getElementById('npPatientCategory').value.trim(),
            phone: document.getElementById('npPhone').value.trim(),
            workPhone: document.getElementById('npWorkPhone').value.trim(),
            mobile, firstVisitDate: document.getElementById('npFirstVisitDate').value || new Date().toISOString().slice(0,10),
            cancerPatient: document.getElementById('npCancerPatient').value || 'No',
            country: 'Germany', city: 'Berlin', healthScore: 75,
            condition: 'General Check-up', subscription: 'Standard',
            lastVisit: new Date().toISOString().slice(0,10), status: 'Active'
          };

          sampleData.patients.unshift(newPatient);
          
          document.getElementById('npFirstName').value = '';
          document.getElementById('npLastName').value = '';
          document.getElementById('npMiddleName').value = '';
          document.getElementById('npMotherName').value = '';
          document.getElementById('npFatherName').value = '';
          document.getElementById('npDOB').value = '';
          document.getElementById('npSex').value = '';
          document.getElementById('npTRN').value = '';
          document.getElementById('npTaxOffice').value = '';
          document.getElementById('npAMKA').value = '';
          document.getElementById('npIdentityNum').value = '';
          document.getElementById('npIDIssueDate').value = '';
          document.getElementById('npIDIssueBody').value = '';
          document.getElementById('npOccupationCat').value = '';
          document.getElementById('npJobTitle').value = '';
          document.getElementById('npEmail').value = '';
          document.getElementById('npEmail2').value = '';
          document.getElementById('npPatientCategory').value = '';
          document.getElementById('npPhone').value = '';
          document.getElementById('npWorkPhone').value = '';
          document.getElementById('npMobile').value = '';
          document.getElementById('npFirstVisitDate').value = '';
          document.getElementById('npCancerPatient').value = '';

          alert(`Patient "${firstName} ${lastName}" added successfully!`);
          modal.classList.add('hidden');
          renderPatients();
        });
      }
      
      function renderPatients() {
        const countryFilterSelect = document.getElementById('patientCountryFilter');
        const selectedCountry = countryFilterSelect?.value;
        
        const filtered = patientList.filter(p => {
          const matchCountry = !selectedCountry || p.country === selectedCountry;
          return matchCountry;
        });
        
        tbody.innerHTML = filtered.map(p => `
          <tr onclick="showPatientDetail('${p.id}')">
            <td><strong>${p.id}</strong></td>
            <td>${p.name}</td>
            <td>${p.age}</td>
            <td>${p.gender}</td>
            <td>${p.country}</td>
            <td><strong>${p.healthScore}</strong></td>
            <td><span class="badge badge-info">${p.condition}</span></td>
            <td>${p.lastVisit}</td>
            
          </tr>
        `).join('');
      }
      
      searchInput.addEventListener('input', () => {
        const query = searchInput.value.toLowerCase();
        patientList = sampleData.patients.filter(p => {
          const searchableFields = [
            p.id, p.name, p.firstName, p.lastName, p.middleName, 
            p.motherName, p.fatherName, p.dob, p.age, p.sex, p.gender,
            p.trn, p.taxOffice, p.amka, p.identityNumber, p.idIssueDate, 
            p.idIssueBody, p.occupationCategory, p.jobTitle, p.email, p.email2,
            p.patientCategory, p.phone, p.workPhone, p.mobile, p.firstVisitDate,
            p.cancerPatient, p.country, p.city, p.healthScore, p.condition,
            p.subscription, p.lastVisit, p.status
          ];
          return searchableFields.some(field => 
            field && String(field).toLowerCase().includes(query)
          );
        });
        sortPatients();
      });
      
      // Populate country dropdown
      const countryFilterSelect = document.getElementById('patientCountryFilter');
      const uniqueCountries = [...new Set(sampleData.patients.map(p => p.country))].sort();
      uniqueCountries.forEach(country => {
        const option = document.createElement('option');
        option.value = country;
        option.textContent = country;
        countryFilterSelect.appendChild(option);
      });
      
      countryFilterSelect.addEventListener('change', renderPatients);
      sortSelect.addEventListener('change', sortPatients);
      
      function sortPatients() {
        const sortBy = sortSelect.value;
        if (sortBy === 'name') patientList.sort((a, b) => a.name.localeCompare(b.name));
        else if (sortBy === 'age') patientList.sort((a, b) => a.age - b.age);
        else if (sortBy === 'country') patientList.sort((a, b) => a.country.localeCompare(b.country));
        else if (sortBy === 'health') patientList.sort((a, b) => b.healthScore - a.healthScore);
        else if (sortBy === 'recent') patientList.sort((a, b) => new Date(b.lastVisit) - new Date(a.lastVisit));
        renderPatients();
      }
      
      window.showPatientDetail = (id) => {
        const p = sampleData.patients.find(x => x.id === id);
        if (!p) return;
        const modal = document.getElementById('patientDetailModal');
        const content = document.getElementById('patientDetailContent');
        content.innerHTML = `
          <h3 class="text-3xl font-bold mb-6 text-sozo-700">Patient Demographics: ${p.name}</h3>
          <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 text-base">
            <div class="space-y-2"><strong class="text-base font-bold block">Patient ID:</strong> <span class="font-mono text-sm bg-slate-100 px-3 py-2 rounded block">${p.id}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">First Name:</strong> <span class="text-base block">${p.firstName || 'N/A'}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">Last Name:</strong> <span class="text-base block">${p.lastName || 'N/A'}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">Middle Name:</strong> <span class="text-base block">${p.middleName || 'N/A'}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">Mother's Name:</strong> <span class="text-base block">${p.motherName || 'N/A'}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">Father's Name:</strong> <span class="text-base block">${p.fatherName || 'N/A'}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">Date of Birth:</strong> <span class="text-base block">${p.dob || 'N/A'}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">Age:</strong> <span class="text-base block">${p.age} years</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">Sex:</strong> <span class="text-base block">${p.sex || p.gender || 'N/A'}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">TRN:</strong> <span class="text-base block">${p.trn || 'N/A'}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">Tax Office:</strong> <span class="text-base block">${p.taxOffice || 'N/A'}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">AMKA:</strong> <span class="text-base block">${p.amka || 'N/A'}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">Identity Number:</strong> <span class="text-base block">${p.identityNumber || 'N/A'}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">ID Issue Date:</strong> <span class="text-base block">${p.idIssueDate || 'N/A'}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">ID Issue Body:</strong> <span class="text-base block">${p.idIssueBody || 'N/A'}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">Occupation Category:</strong> <span class="text-base block">${p.occupationCategory || 'N/A'}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">Job Title:</strong> <span class="text-base block">${p.jobTitle || 'N/A'}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">Email:</strong> <span class="text-base block">${p.email || 'N/A'}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">Email 2:</strong> <span class="text-base block">${p.email2 || 'N/A'}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">Patient Category:</strong> <span class="text-base block">${p.patientCategory || 'N/A'}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">Phone:</strong> <span class="text-base block">${p.phone || 'N/A'}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">Work Phone:</strong> <span class="text-base block">${p.workPhone || 'N/A'}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">Mobile:</strong> <span class="text-base block">${p.mobile || 'N/A'}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">First Visit Date:</strong> <span class="text-base block">${p.firstVisitDate || 'N/A'}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">Cancer Patient:</strong> <span class="text-base block">${p.cancerPatient || 'No'}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">Country:</strong> <span class="text-base block">${p.country}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">City:</strong> <span class="text-base block">${p.city}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">Health Score:</strong> <span class="text-2xl font-bold text-sozo-600 block">${p.healthScore}/100</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">Condition:</strong> <span class="text-base block">${p.condition}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">Subscription:</strong> <span class="text-base block">${p.subscription}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">Last Visit:</strong> <span class="text-base block">${p.lastVisit}</span></div>
          </div>
          <div class="mt-6 flex gap-2">
            <button onclick="editPatient('${p.id}')" class="flex-1 bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-sozo-700">Edit Patient</button>
            <button onclick="viewPatientHistory('${p.id}')" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700">View History</button>
            <button onclick="deletePatient('${p.id}')" class="flex-1 bg-slate-100 text-slate-600 px-4 py-2 rounded-lg font-bold hover:bg-slate-200">Delete</button>
            <button onclick="document.getElementById('patientDetailModal').classList.add('hidden')" class="flex-1 bg-slate-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-slate-700">Back</button>
          </div>
        `;
        modal.classList.remove('hidden');
      };
      
      // Edit Patient Function
      window.editPatient = (id) => {
        const p = sampleData.patients.find(x => x.id === id);
        if (!p) return;
        
        const modal = document.getElementById('editPatientModal');
        const form = document.getElementById('editPatientForm');
        
        form.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div><label class="text-xs font-bold text-slate-600">First Name *</label><input id="epFirstName" value="${p.firstName || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            <div><label class="text-xs font-bold text-slate-600">Last Name *</label><input id="epLastName" value="${p.lastName || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            <div><label class="text-xs font-bold text-slate-600">Middle Name</label><input id="epMiddleName" value="${p.middleName || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            
            <div><label class="text-xs font-bold text-slate-600">Mother's Name</label><input id="epMotherName" value="${p.motherName || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            <div><label class="text-xs font-bold text-slate-600">Father's Name</label><input id="epFatherName" value="${p.fatherName || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            <div><label class="text-xs font-bold text-slate-600">Date of Birth</label><input id="epDob" type="date" value="${p.dob || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            
            <div><label class="text-xs font-bold text-slate-600">Age</label><input id="epAge" type="number" value="${p.age || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            <div><label class="text-xs font-bold text-slate-600">Sex</label><select id="epSex" class="w-full px-4 py-2 border rounded-lg"><option value="Male" ${(p.sex || p.gender) === 'Male' ? 'selected' : ''}>Male</option><option value="Female" ${(p.sex || p.gender) === 'Female' ? 'selected' : ''}>Female</option><option value="Other" ${(p.sex || p.gender) === 'Other' ? 'selected' : ''}>Other</option></select></div>
            <div><label class="text-xs font-bold text-slate-600">TRN</label><input id="epTrn" value="${p.trn || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            
            <div><label class="text-xs font-bold text-slate-600">Tax Office</label><input id="epTaxOffice" value="${p.taxOffice || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            <div><label class="text-xs font-bold text-slate-600">AMKA</label><input id="epAmka" value="${p.amka || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            <div><label class="text-xs font-bold text-slate-600">Identity Number</label><input id="epIdentityNumber" value="${p.identityNumber || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            
            <div><label class="text-xs font-bold text-slate-600">ID Issue Date</label><input id="epIdIssueDate" type="date" value="${p.idIssueDate || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            <div><label class="text-xs font-bold text-slate-600">ID Issue Body</label><input id="epIdIssueBody" value="${p.idIssueBody || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            <div><label class="text-xs font-bold text-slate-600">Occupation Category</label><input id="epOccupationCategory" value="${p.occupationCategory || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            
            <div><label class="text-xs font-bold text-slate-600">Job Title</label><input id="epJobTitle" value="${p.jobTitle || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            <div><label class="text-xs font-bold text-slate-600">Email</label><input id="epEmail" type="email" value="${p.email || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            <div><label class="text-xs font-bold text-slate-600">Email 2</label><input id="epEmail2" type="email" value="${p.email2 || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            
            <div><label class="text-xs font-bold text-slate-600">Patient Category</label><input id="epPatientCategory" value="${p.patientCategory || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            <div><label class="text-xs font-bold text-slate-600">Phone</label><input id="epPhone" value="${p.phone || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            <div><label class="text-xs font-bold text-slate-600">Work Phone</label><input id="epWorkPhone" value="${p.workPhone || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            
            <div><label class="text-xs font-bold text-slate-600">Mobile</label><input id="epMobile" value="${p.mobile || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            <div><label class="text-xs font-bold text-slate-600">First Visit Date</label><input id="epFirstVisitDate" type="date" value="${p.firstVisitDate || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            <div><label class="text-xs font-bold text-slate-600">Cancer Patient</label><div class="flex items-center gap-4 mt-1"><label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="epCancerPatient" class="w-5 h-5 rounded border-slate-300 text-sozo-600 focus:ring-sozo-500" ${p.cancerPatient === 'Yes' ? 'checked' : ''} /><span class="text-sm">Yes</span></label></div></div>
            
            <div><label class="text-xs font-bold text-slate-600">Country</label><input id="epCountry" value="${p.country || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            <div><label class="text-xs font-bold text-slate-600">Address 1</label><input id="epAddress1" value="${p.address1 || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            <div><label class="text-xs font-bold text-slate-600">Address 2</label><input id="epAddress2" value="${p.address2 || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            
            <div><label class="text-xs font-bold text-slate-600">Postal Code</label><input id="epPostalCode" value="${p.postalCode || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            <div><label class="text-xs font-bold text-slate-600">Contact Person</label><input id="epContactPerson" value="${p.contactPerson || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            <div><label class="text-xs font-bold text-slate-600">Contact Phone</label><input id="epContactPhone" value="${p.contactPhone || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
          </div>
          
          <div class="flex gap-2 mt-6">
            <button onclick="savePatient('${p.id}')" class="flex-1 bg-sozo-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-sozo-700">Save Changes</button>
            <button onclick="document.getElementById('editPatientModal').classList.add('hidden')" class="flex-1 bg-slate-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-slate-700">Cancel</button>
          </div>
        `;
        
        modal.classList.remove('hidden');
      };
      
      // Save Patient Function
      window.savePatient = (id) => {
        const p = sampleData.patients.find(x => x.id === id);
        if (!p) return;
        
        p.firstName = document.getElementById('epFirstName').value;
        p.lastName = document.getElementById('epLastName').value;
        p.middleName = document.getElementById('epMiddleName').value;
        p.motherName = document.getElementById('epMotherName').value;
        p.fatherName = document.getElementById('epFatherName').value;
        p.dob = document.getElementById('epDob').value;
        p.age = parseInt(document.getElementById('epAge').value) || p.age;
        p.sex = document.getElementById('epSex').value;
        p.gender = document.getElementById('epSex').value;
        p.trn = document.getElementById('epTrn').value;
        p.taxOffice = document.getElementById('epTaxOffice').value;
        p.amka = document.getElementById('epAmka').value;
        p.identityNumber = document.getElementById('epIdentityNumber').value;
        p.idIssueDate = document.getElementById('epIdIssueDate').value;
        p.idIssueBody = document.getElementById('epIdIssueBody').value;
        p.occupationCategory = document.getElementById('epOccupationCategory').value;
        p.jobTitle = document.getElementById('epJobTitle').value;
        p.email = document.getElementById('epEmail').value;
        p.email2 = document.getElementById('epEmail2').value;
        p.patientCategory = document.getElementById('epPatientCategory').value;
        p.phone = document.getElementById('epPhone').value;
        p.workPhone = document.getElementById('epWorkPhone').value;
        p.mobile = document.getElementById('epMobile').value;
        p.firstVisitDate = document.getElementById('epFirstVisitDate').value;
        p.cancerPatient = document.getElementById('epCancerPatient').value;
        p.country = document.getElementById('epCountry').value;
        p.address1 = document.getElementById('epAddress1').value;
        p.address2 = document.getElementById('epAddress2').value;
        p.postalCode = document.getElementById('epPostalCode').value;
        p.contactPerson = document.getElementById('epContactPerson').value;
        p.contactPhone = document.getElementById('epContactPhone').value;
        
        p.name = p.firstName + ' ' + p.lastName;
        
        document.getElementById('editPatientModal').classList.add('hidden');
        document.getElementById('patientDetailModal').classList.add('hidden');
        
        renderPatients();
        
        alert('Patient information updated successfully!');
      };
      
      // View Patient History Function
      window.viewPatientHistory = (id) => {
        const p = sampleData.patients.find(x => x.id === id);
        if (!p) return;
        
        // Create sample visit history data
        const visitHistory = [
          { date: '2025-12-20', type: 'Consultation', doctor: 'Dr. James Wilson', notes: 'Regular checkup - All vitals normal' },
          { date: '2025-11-15', type: 'Lab Test', doctor: 'Dr. Sarah Miller', notes: 'Blood work - Results normal' },
          { date: '2025-10-10', type: 'Follow-up', doctor: 'Dr. James Wilson', notes: 'Post-treatment evaluation' },
          { date: '2025-09-05', type: 'Consultation', doctor: 'Dr. Robert Lee', notes: 'Initial assessment' }
        ];
        
        alert(`Patient History for ${p.name}:\n\nRecent Visits:\n${visitHistory.map(v => `${v.date} - ${v.type} with ${v.doctor}\n${v.notes}`).join('\n\n')}`);
      };
      
      // Delete Patient Function
      window.deletePatient = (id) => {
        const p = sampleData.patients.find(x => x.id === id);
        if (!p) return;
        
        if (confirm(`Are you sure you want to delete patient "${p.name}"? This action cannot be undone.`)) {
          const index = sampleData.patients.findIndex(x => x.id === id);
          if (index > -1) {
            sampleData.patients.splice(index, 1);
            document.getElementById('patientDetailModal').classList.add('hidden');
            renderPatients();
            alert(`Patient "${p.name}" has been deleted successfully!`);
          }
        }
      };
      
      renderPatients();
    }, 50);
  }
  else if (key === 'doctors') {
    area.innerHTML = `
      <div class="p-8">
      <div class="mb-6 flex justify-between items-center flex-wrap gap-4">
        <div>
          <h2 class="text-2xl font-bold">Doctors Database</h2>
          <p class="text-slate-500 text-sm">Manage medical professionals and their profiles</p>
        </div>
        <button class="bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-sozo-700" id="addDoctorBtnMain">+ Add Doctor</button>
      </div>
      
      <div class="mb-6 flex flex-wrap gap-3 items-end">
        <div>
          <label class="text-xs font-bold text-slate-500 block mb-1">Search by Name/ID</label>
          <input id="doctorSearch" type="text" placeholder="e.g., Dr. Wilson or DR-001" class="input-royal w-64">
        </div>
        <div>
          <label class="text-xs font-bold text-slate-500 block mb-1">Country</label>
          <select id="doctorCountryFilter" class="input-royal w-48">
            <option value="">All Countries</option>
          </select>
        </div>
        <div>
          <label class="text-xs font-bold text-slate-500 block mb-1">Sort By</label>
          <select id="doctorSort" class="input-royal w-48">
            <option value="name">Name (A-Z)</option>
            <option value="specialist">Specialty (A-Z)</option>
            <option value="country">Country (A-Z)</option>
            <option value="experience">Experience (Most Experienced)</option>
            <option value="patients">Patient Count</option>
          </select>
        </div>
      </div>
      
      <div class="card p-0 overflow-hidden">
        <div class="overflow-y-auto" style="max-height: calc(100vh - 220px); min-height: 400px;">
          <table>
            <thead><tr><th>ID</th><th>Name</th><th>Age</th><th>Specialty</th><th>Country</th><th>Experience</th><th>Patients</th><th>Status</th></tr></thead>
            <tbody id="doctorTableBody"></tbody>
          </table>
        </div>
      </div>
      
      <div id="doctorDetailModal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-11/12 h-5/6 max-w-6xl p-8 overflow-y-auto">
          <button onclick="document.getElementById('doctorDetailModal').classList.add('hidden')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times text-xl"></i></button>
          <div id="doctorDetailContent"></div>
        </div>
      </div>
      
      <!-- Edit Doctor Modal -->
      <div id="editDoctorModal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50 overflow-y-auto p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto p-6 my-4">
          <button onclick="document.getElementById('editDoctorModal').classList.add('hidden')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times text-xl"></i></button>
          <div id="editDoctorForm"></div>
        </div>
      </div>
      </div>
    `;
    
    // Create Doctor Modal
    if(!document.getElementById('addDoctorModal')) {
      const doctorModalHTML = document.createElement('div');
      doctorModalHTML.id = 'addDoctorModal';
      doctorModalHTML.className = 'hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50 overflow-y-auto';
      doctorModalHTML.innerHTML = `
        <div class="card p-6 w-[95%] max-w-4xl max-h-[90vh] overflow-y-auto my-4">
          <h3 class="font-bold text-2xl mb-6 text-sozo-700">Add New Doctor - Professional Information</h3>
          
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div><label class="text-xs font-bold text-slate-600">Salutation</label><select id="ndSalutation" class="input-royal"><option>Dr.</option><option>Prof.</option><option>Mr.</option><option>Ms.</option><option>Mrs.</option></select></div>
            <div><label class="text-xs font-bold text-slate-600">Last Name <span class="text-slate-600">*</span></label><input id="ndLastName" class="input-royal"/></div>
            <div><label class="text-xs font-bold text-slate-600">First Name <span class="text-slate-600">*</span></label><input id="ndFirstName" class="input-royal"/></div>
            
            <div><label class="text-xs font-bold text-slate-600">Father's Name</label><input id="ndFatherName" class="input-royal"/></div>
            <div><label class="text-xs font-bold text-slate-600">Identity Number</label><input id="ndIdentity" class="input-royal"/></div>
            <div><label class="text-xs font-bold text-slate-600">Medical Identity <span class="text-slate-600">*</span></label><input id="ndMedicalIdentity" class="input-royal"/></div>
            
            <div><label class="text-xs font-bold text-slate-600">Sex <span class="text-slate-600">*</span></label><select id="ndSex" class="input-royal"><option value="">Select</option><option>Male</option><option>Female</option><option>Other</option></select></div>
            <div><label class="text-xs font-bold text-slate-600">Specialty <span class="text-slate-600">*</span></label><input id="ndSpecialty" class="input-royal" placeholder="e.g., Neurology"/></div>
            <div><label class="text-xs font-bold text-slate-600">Group</label><input id="ndGroup" class="input-royal"/></div>
            
            <div><label class="text-xs font-bold text-slate-600">Surgeon?</label><select id="ndSurgeon" class="input-royal"><option value="">Select</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
            <div><label class="text-xs font-bold text-slate-600">Nurse?</label><select id="ndNurse" class="input-royal"><option value="">Select</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
            
            <div><label class="text-xs font-bold text-slate-600">Email <span class="text-slate-600">*</span></label><input id="ndEmail" type="email" class="input-royal"/></div>
            <div><label class="text-xs font-bold text-slate-600">Email 2</label><input id="ndEmail2" type="email" class="input-royal"/></div>
            <div><label class="text-xs font-bold text-slate-600">Email 3</label><input id="ndEmail3" type="email" class="input-royal"/></div>
            
            <div><label class="text-xs font-bold text-slate-600">Office Phone</label><input id="ndOfficePhone" type="tel" class="input-royal"/></div>
            <div><label class="text-xs font-bold text-slate-600">Home Phone</label><input id="ndHomePhone" type="tel" class="input-royal"/></div>
            <div><label class="text-xs font-bold text-slate-600">Mobile <span class="text-slate-600">*</span></label><input id="ndMobile" type="tel" class="input-royal"/></div>
            
            <div><label class="text-xs font-bold text-slate-600">Fax</label><input id="ndFax" type="tel" class="input-royal"/></div>
            <div><label class="text-xs font-bold text-slate-600">Address</label><input id="ndAddress" class="input-royal"/></div>
          </div>

          <div class="grid grid-cols-1 gap-4 mb-6">
            <div><label class="text-xs font-bold text-slate-600">General Comments</label><textarea id="ndComments" class="input-royal" rows="3" placeholder="Additional notes about the doctor"></textarea></div>
            <div><label class="text-xs font-bold text-slate-600">Institution/Hospitals</label><textarea id="ndInstitutions" class="input-royal" rows="3" placeholder="List of institutions and hospitals"></textarea></div>
          </div>

          <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg mb-4">
            <p class="text-xs text-blue-800"><span class="font-bold">Note:</span> Fields marked with <span class="text-slate-600">*</span> are required</p>
          </div>

          <div class="flex gap-3">
            <button id="ndSave" class="flex-1 bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-sozo-700">Save Doctor</button>
            <button id="ndCancel" class="flex-1 bg-slate-300 text-slate-700 px-4 py-2 rounded-lg font-bold hover:bg-slate-400">Cancel</button>
          </div>
        </div>
      `;
      document.body.appendChild(doctorModalHTML);
    }
    
    setTimeout(() => {
      let doctorList = [...sampleData.doctors];
      const searchInput = document.getElementById('doctorSearch');
      const sortSelect = document.getElementById('doctorSort');
      const tbody = document.getElementById('doctorTableBody');
      const addDoctorBtn = document.getElementById('addDoctorBtnMain');
      const doctorModal = document.getElementById('addDoctorModal');
      const ndSave = document.getElementById('ndSave');
      const ndCancel = document.getElementById('ndCancel');
      
      if(addDoctorBtn) {
        addDoctorBtn.addEventListener('click', () => {
          const modal = document.getElementById('addDoctorModal');
          if(modal) modal.classList.remove('hidden');
        });
      }
      
      if(ndCancel) {
        ndCancel.addEventListener('click', () => {
          const modal = document.getElementById('addDoctorModal');
          if(modal) modal.classList.add('hidden');
        });
      }
      
      if(ndSave) {
        ndSave.addEventListener('click', () => {
          const lastName = document.getElementById('ndLastName').value.trim();
          const firstName = document.getElementById('ndFirstName').value.trim();
          const medicalIdentity = document.getElementById('ndMedicalIdentity').value.trim();
          const sex = document.getElementById('ndSex').value;
          const specialty = document.getElementById('ndSpecialty').value.trim();
          const email = document.getElementById('ndEmail').value.trim();
          const mobile = document.getElementById('ndMobile').value.trim();

          if(!lastName || !firstName || !medicalIdentity || !sex || !specialty || !email || !mobile) {
            alert('Please fill all required fields (marked with *)');
            return;
          }

          const id = generateSozoId(sampleData.doctors.length + 1);
          const newDoctor = {
            id, firstName, lastName,
            salutation: document.getElementById('ndSalutation').value,
            fatherName: document.getElementById('ndFatherName').value.trim(),
            identity: document.getElementById('ndIdentity').value.trim(),
            medicalIdentity,
            sex, gender: sex,
            specialty,
            group: document.getElementById('ndGroup').value.trim(),
            surgeon: document.getElementById('ndSurgeon').value || 'No',
            nurse: document.getElementById('ndNurse').value || 'No',
            email, email2: document.getElementById('ndEmail2').value.trim(),
            email3: document.getElementById('ndEmail3').value.trim(),
            officePhone: document.getElementById('ndOfficePhone').value.trim(),
            homePhone: document.getElementById('ndHomePhone').value.trim(),
            mobile,
            fax: document.getElementById('ndFax').value.trim(),
            address: document.getElementById('ndAddress').value.trim(),
            comments: document.getElementById('ndComments').value.trim(),
            institutions: document.getElementById('ndInstitutions').value.trim(),
            name: `${document.getElementById('ndSalutation').value} ${firstName} ${lastName}`,
            age: 45,
            specialist: specialty,
            type: 'Specialist',
            phone: mobile,
            licenseNo: medicalIdentity,
            country: 'Germany',
            experience: 12,
            patients: 28,
            status: 'Active'
          };

          sampleData.doctors.unshift(newDoctor);
          
          // Clear form
          document.getElementById('ndSalutation').value = 'Dr.';
          document.getElementById('ndLastName').value = '';
          document.getElementById('ndFirstName').value = '';
          document.getElementById('ndFatherName').value = '';
          document.getElementById('ndIdentity').value = '';
          document.getElementById('ndMedicalIdentity').value = '';
          document.getElementById('ndSex').value = '';
          document.getElementById('ndSpecialty').value = '';
          document.getElementById('ndGroup').value = '';
          document.getElementById('ndSurgeon').value = '';
          document.getElementById('ndNurse').value = '';
          document.getElementById('ndEmail').value = '';
          document.getElementById('ndEmail2').value = '';
          document.getElementById('ndEmail3').value = '';
          document.getElementById('ndOfficePhone').value = '';
          document.getElementById('ndHomePhone').value = '';
          document.getElementById('ndMobile').value = '';
          document.getElementById('ndFax').value = '';
          document.getElementById('ndAddress').value = '';
          document.getElementById('ndComments').value = '';
          document.getElementById('ndInstitutions').value = '';

          alert(`Doctor "${firstName} ${lastName}" added successfully!`);
          const modal = document.getElementById('addDoctorModal');
          if(modal) modal.classList.add('hidden');
          renderDoctors();
        });
      }
      
      function renderDoctors() {
        const countryFilterSelect = document.getElementById('doctorCountryFilter');
        const selectedCountry = countryFilterSelect?.value;
        
        const filtered = doctorList.filter(d => {
          const matchCountry = !selectedCountry || d.country === selectedCountry;
          return matchCountry;
        });
        
        tbody.innerHTML = filtered.map(d => `
          <tr onclick="showDoctorDetail('${d.id}')">
            <td><strong>${d.id}</strong></td>
            <td>${d.name}</td>
            <td>${d.age}</td>
            <td>${d.specialist}</td>
            <td>${d.country}</td>
            <td>${d.experience} yrs</td>
            <td><strong>${d.patients}</strong></td>
            <td><span class="badge badge-success">${d.status}</span></td>
            
          </tr>
        `).join('');
      }
      
      searchInput.addEventListener('input', () => {
        const query = searchInput.value.toLowerCase();
        doctorList = sampleData.doctors.filter(d => {
          const searchableFields = [
            d.id, d.name, d.firstName, d.lastName, d.fatherName, d.identity,
            d.salutation, d.medicalIdentity, d.licenseNo, d.sex, d.gender,
            d.specialty, d.group, d.surgeon, d.nurse, d.email, d.email2, d.email3,
            d.officePhone, d.homePhone, d.mobile, d.fax, d.address,
            d.comments, d.institutions, d.country, d.experience, d.patients,
            d.status, d.type, d.phone
          ];
          return searchableFields.some(field => 
            field && String(field).toLowerCase().includes(query)
          );
        });
        sortDoctors();
      });
      
      // Populate country dropdown
      const countryFilterSelect = document.getElementById('doctorCountryFilter');
      const uniqueCountries = [...new Set(sampleData.doctors.map(d => d.country))].sort();
      uniqueCountries.forEach(country => {
        const option = document.createElement('option');
        option.value = country;
        option.textContent = country;
        countryFilterSelect.appendChild(option);
      });
      
      countryFilterSelect.addEventListener('change', renderDoctors);
      sortSelect.addEventListener('change', sortDoctors);
      
      function sortDoctors() {
        const sortBy = sortSelect.value;
        if (sortBy === 'name') doctorList.sort((a, b) => a.name.localeCompare(b.name));
        else if (sortBy === 'specialist') doctorList.sort((a, b) => a.specialist.localeCompare(b.specialist));
        else if (sortBy === 'country') doctorList.sort((a, b) => a.country.localeCompare(b.country));
        else if (sortBy === 'experience') doctorList.sort((a, b) => b.experience - a.experience);
        else if (sortBy === 'patients') doctorList.sort((a, b) => b.patients - a.patients);
        renderDoctors();
      }
      
      window.showDoctorDetail = (id) => {
        const d = sampleData.doctors.find(x => x.id === id);
        if (!d) return;
        const modal = document.getElementById('doctorDetailModal');
        const content = document.getElementById('doctorDetailContent');
        content.innerHTML = `
          <h3 class="text-3xl font-bold mb-6 text-sozo-700">Doctor Professional Information: ${d.name}</h3>
          <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 text-base">
            <div class="space-y-2"><strong class="text-base font-bold block">Doctor ID:</strong> <span class="font-mono text-sm bg-slate-100 px-3 py-2 rounded block">${d.id}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">Salutation:</strong> <span class="text-base block">${d.salutation || 'N/A'}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">First Name:</strong> <span class="text-base block">${d.firstName || 'N/A'}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">Last Name:</strong> <span class="text-base block">${d.lastName || 'N/A'}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">Father's Name:</strong> <span class="text-base block">${d.fatherName || 'N/A'}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">Identity Number:</strong> <span class="text-base block">${d.identity || 'N/A'}</span></div>
            
            <div class="space-y-2"><strong class="text-base font-bold block">Medical Identity:</strong> <span class="font-mono text-sm bg-sozo-100 text-sozo-800 px-3 py-2 rounded block">${d.medicalIdentity || 'N/A'}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">License No:</strong> <span class="text-base block">${d.licenseNo || 'N/A'}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">Sex:</strong> <span class="text-base block">${d.sex || 'N/A'}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">Age:</strong> <span class="text-base block">${d.age || 'N/A'} years</span></div>
            
            <div class="space-y-2"><strong class="text-base font-bold block">Specialty:</strong> <span class="text-base font-bold text-sozo-600 block">${d.specialty || d.specialist || 'N/A'}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">Group:</strong> <span class="text-base block">${d.group || 'N/A'}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">Surgeon:</strong> <span class="text-base block">${d.surgeon || 'No'}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">Nurse:</strong> <span class="text-base block">${d.nurse || 'No'}</span></div>
            
            <div class="space-y-2"><strong class="text-base font-bold block">Email 1:</strong> <span class="text-base block">${d.email || 'N/A'}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">Email 2:</strong> <span class="text-base block">${d.email2 || 'N/A'}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">Email 3:</strong> <span class="text-base block">${d.email3 || 'N/A'}</span></div>
            
            <div class="space-y-2"><strong class="text-base font-bold block">Office Phone:</strong> <span class="text-base block">${d.officePhone || 'N/A'}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">Home Phone:</strong> <span class="text-base block">${d.homePhone || 'N/A'}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">Mobile:</strong> <span class="text-base block">${d.mobile || d.phone || 'N/A'}</span></div>
            
            <div class="space-y-2"><strong class="text-base font-bold block">Fax:</strong> <span class="text-base block">${d.fax || 'N/A'}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">Address:</strong> <span class="text-base block">${d.address || 'N/A'}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">Country:</strong> <span class="text-base block">${d.country || 'N/A'}</span></div>
            
            <div class="space-y-2"><strong class="text-base font-bold block">Experience:</strong> <span class="text-base block">${d.experience || 'N/A'} years</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">Active Patients:</strong> <span class="text-base block">${d.patients || 0}</span></div>
            <div class="space-y-2"><strong class="text-base font-bold block">Status:</strong> <span class="badge badge-success block">${d.status || 'Active'}</span></div>
          </div>
          
          ${d.comments ? `<div class="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200"><strong>General Comments:</strong><p class="text-sm mt-2">${d.comments}</p></div>` : ''}
          
          ${d.institutions ? `<div class="mt-4 p-4 bg-slate-50 rounded-lg border border-slate-200"><strong>Institution/Hospitals:</strong><p class="text-sm mt-2">${d.institutions}</p></div>` : ''}
          
          <div class="mt-6 flex gap-2">
            <button onclick="editDoctor('${d.id}')" class="flex-1 bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-sozo-700">Edit Doctor</button>
            <button onclick="viewDoctorPatients('${d.id}')" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700">View Patients</button>
            <button onclick="deleteDoctor('${d.id}')" class="flex-1 bg-slate-100 text-slate-600 px-4 py-2 rounded-lg font-bold hover:bg-slate-200">Delete</button>
            <button onclick="document.getElementById('doctorDetailModal').classList.add('hidden')" class="flex-1 bg-slate-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-slate-700">Back</button>
          </div>
        `;
        modal.classList.remove('hidden');
      };
      
      // Edit Doctor Function
      window.editDoctor = (id) => {
        const d = sampleData.doctors.find(x => x.id === id);
        if (!d) return;
        
        const modal = document.getElementById('editDoctorModal');
        const form = document.getElementById('editDoctorForm');
        
        form.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div><label class="text-xs font-bold text-slate-600">Salutation</label><input id="edSalutation" value="${d.salutation || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            <div><label class="text-xs font-bold text-slate-600">First Name *</label><input id="edFirstName" value="${d.firstName || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            <div><label class="text-xs font-bold text-slate-600">Last Name *</label><input id="edLastName" value="${d.lastName || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            
            <div><label class="text-xs font-bold text-slate-600">Father's Name</label><input id="edFatherName" value="${d.fatherName || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            <div><label class="text-xs font-bold text-slate-600">Identity Number</label><input id="edIdentity" value="${d.identity || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            <div><label class="text-xs font-bold text-slate-600">Medical Identity</label><input id="edMedicalIdentity" value="${d.medicalIdentity || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            
            <div><label class="text-xs font-bold text-slate-600">License No</label><input id="edLicenseNo" value="${d.licenseNo || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            <div><label class="text-xs font-bold text-slate-600">Sex</label><select id="edSex" class="w-full px-4 py-2 border rounded-lg"><option value="Male" ${d.sex === 'Male' ? 'selected' : ''}>Male</option><option value="Female" ${d.sex === 'Female' ? 'selected' : ''}>Female</option><option value="Other" ${d.sex === 'Other' ? 'selected' : ''}>Other</option></select></div>
            <div><label class="text-xs font-bold text-slate-600">Age</label><input id="edAge" type="number" value="${d.age || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            
            <div><label class="text-xs font-bold text-slate-600">Specialty *</label><input id="edSpecialty" value="${d.specialty || d.specialist || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            <div><label class="text-xs font-bold text-slate-600">Group</label><input id="edGroup" value="${d.group || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            <div><label class="text-xs font-bold text-slate-600">Surgeon</label><select id="edSurgeon" class="w-full px-4 py-2 border rounded-lg"><option value="No" ${d.surgeon === 'No' ? 'selected' : ''}>No</option><option value="Yes" ${d.surgeon === 'Yes' ? 'selected' : ''}>Yes</option></select></div>
            
            <div><label class="text-xs font-bold text-slate-600">Nurse</label><select id="edNurse" class="w-full px-4 py-2 border rounded-lg"><option value="No" ${d.nurse === 'No' ? 'selected' : ''}>No</option><option value="Yes" ${d.nurse === 'Yes' ? 'selected' : ''}>Yes</option></select></div>
            <div><label class="text-xs font-bold text-slate-600">Email 1</label><input id="edEmail" type="email" value="${d.email || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            <div><label class="text-xs font-bold text-slate-600">Email 2</label><input id="edEmail2" type="email" value="${d.email2 || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            
            <div><label class="text-xs font-bold text-slate-600">Email 3</label><input id="edEmail3" type="email" value="${d.email3 || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            <div><label class="text-xs font-bold text-slate-600">Office Phone</label><input id="edOfficePhone" value="${d.officePhone || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            <div><label class="text-xs font-bold text-slate-600">Home Phone</label><input id="edHomePhone" value="${d.homePhone || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            
            <div><label class="text-xs font-bold text-slate-600">Mobile</label><input id="edMobile" value="${d.mobile || d.phone || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            <div><label class="text-xs font-bold text-slate-600">Fax</label><input id="edFax" value="${d.fax || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            <div><label class="text-xs font-bold text-slate-600">Address</label><input id="edAddress" value="${d.address || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            
            <div><label class="text-xs font-bold text-slate-600">Country</label><input id="edCountry" value="${d.country || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            <div><label class="text-xs font-bold text-slate-600">Experience (years)</label><input id="edExperience" type="number" value="${d.experience || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            <div><label class="text-xs font-bold text-slate-600">Active Patients</label><input id="edPatients" type="number" value="${d.patients || ''}" class="w-full px-4 py-2 border rounded-lg"/></div>
            
            <div><label class="text-xs font-bold text-slate-600">Status</label><select id="edStatus" class="w-full px-4 py-2 border rounded-lg"><option value="Active" ${d.status === 'Active' ? 'selected' : ''}>Active</option><option value="Inactive" ${d.status === 'Inactive' ? 'selected' : ''}>Inactive</option></select></div>
            <div class="md:col-span-2"><label class="text-xs font-bold text-slate-600">General Comments</label><textarea id="edComments" rows="2" class="w-full px-4 py-2 border rounded-lg">${d.comments || ''}</textarea></div>
            
            <div class="md:col-span-3"><label class="text-xs font-bold text-slate-600">Institution/Hospitals</label><textarea id="edInstitutions" rows="2" class="w-full px-4 py-2 border rounded-lg">${d.institutions || ''}</textarea></div>
          </div>
          
          <div class="flex gap-2 mt-6">
            <button onclick="saveDoctor('${d.id}')" class="flex-1 bg-sozo-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-sozo-700">Save Changes</button>
            <button onclick="document.getElementById('editDoctorModal').classList.add('hidden')" class="flex-1 bg-slate-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-slate-700">Cancel</button>
          </div>
        `;
        
        modal.classList.remove('hidden');
      };
      
      // Save Doctor Function
      window.saveDoctor = (id) => {
        const d = sampleData.doctors.find(x => x.id === id);
        if (!d) return;
        
        d.salutation = document.getElementById('edSalutation').value;
        d.firstName = document.getElementById('edFirstName').value;
        d.lastName = document.getElementById('edLastName').value;
        d.fatherName = document.getElementById('edFatherName').value;
        d.identity = document.getElementById('edIdentity').value;
        d.medicalIdentity = document.getElementById('edMedicalIdentity').value;
        d.licenseNo = document.getElementById('edLicenseNo').value;
        d.sex = document.getElementById('edSex').value;
        d.age = parseInt(document.getElementById('edAge').value) || d.age;
        d.specialty = document.getElementById('edSpecialty').value;
        d.specialist = document.getElementById('edSpecialty').value;
        d.group = document.getElementById('edGroup').value;
        d.surgeon = document.getElementById('edSurgeon').value;
        d.nurse = document.getElementById('edNurse').value;
        d.email = document.getElementById('edEmail').value;
        d.email2 = document.getElementById('edEmail2').value;
        d.email3 = document.getElementById('edEmail3').value;
        d.officePhone = document.getElementById('edOfficePhone').value;
        d.homePhone = document.getElementById('edHomePhone').value;
        d.mobile = document.getElementById('edMobile').value;
        d.phone = document.getElementById('edMobile').value;
        d.fax = document.getElementById('edFax').value;
        d.address = document.getElementById('edAddress').value;
        d.country = document.getElementById('edCountry').value;
        d.experience = parseInt(document.getElementById('edExperience').value) || d.experience;
        d.patients = parseInt(document.getElementById('edPatients').value) || d.patients;
        d.status = document.getElementById('edStatus').value;
        d.comments = document.getElementById('edComments').value;
        d.institutions = document.getElementById('edInstitutions').value;
        
        d.name = d.salutation + ' ' + d.firstName + ' ' + d.lastName;
        
        document.getElementById('editDoctorModal').classList.add('hidden');
        document.getElementById('doctorDetailModal').classList.add('hidden');
        
        renderDoctors();
        
        alert('Doctor information updated successfully!');
      };
      
      // View Doctor Patients Function
      window.viewDoctorPatients = (id) => {
        const d = sampleData.doctors.find(x => x.id === id);
        if (!d) return;
        
        // Get patients associated with this doctor (sample data)
        const doctorPatients = sampleData.patients.slice(0, Math.min(d.patients || 5, sampleData.patients.length));
        
        if (doctorPatients.length === 0) {
          alert(`No patients found for Dr. ${d.name}`);
          return;
        }
        
        const patientList = doctorPatients.map(p => `${p.name} (ID: ${p.id}, Condition: ${p.condition})`).join('\n');
        alert(`Active Patients for ${d.name}:\n\n${patientList}`);
      };
      
      // Delete Doctor Function
      window.deleteDoctor = (id) => {
        const d = sampleData.doctors.find(x => x.id === id);
        if (!d) return;
        
        if (confirm(`Are you sure you want to delete doctor "${d.name}"? This action cannot be undone.`)) {
          const index = sampleData.doctors.findIndex(x => x.id === id);
          if (index > -1) {
            sampleData.doctors.splice(index, 1);
            document.getElementById('doctorDetailModal').classList.add('hidden');
            renderDoctors();
            alert(`Doctor "${d.name}" has been deleted successfully!`);
          }
        }
      };
      
      renderDoctors();
    }, 50);
  }
  else if (key === 'workshops') {
    area.innerHTML = `
      <div class="p-8">
      <div class="mb-6 flex justify-between items-center flex-wrap gap-4">
        <div>
          <h2 class="text-2xl font-bold">Workshops Management</h2>
          <p class="text-slate-500 text-sm">Schedule and manage training workshops</p>
        </div>
        <button class="bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-sozo-700" onclick="openCreateWorkshopModal()">+ Create Workshop</button>
      </div>

      <!-- KPI Score Cards -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
        <div class="kpi-card">
          <div class="kpi-icon" style="background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); color: white;">
            <i class="fa-solid fa-chalkboard-user"></i>
          </div>
          <div class="flex-1">
            <div class="kpi-label">Total Workshops</div>
            <div class="kpi-value">40</div>
            <p class="text-xs text-slate-500 mt-1">${sampleData.workshops.filter(w => w.status === 'Completed').length} completed</p>
          </div>
        </div>
        
        <div class="kpi-card">
          <div class="kpi-icon" style="background: linear-gradient(135deg, #10b981 0%, #047857 100%); color: white;">
            <i class="fa-solid fa-euro-sign"></i>
          </div>
          <div class="flex-1">
            <div class="kpi-label">Total Revenue</div>
            <div class="kpi-value">€2M</div>
            <p class="text-xs text-slate-500 mt-1">From workshop fees</p>
          </div>
        </div>
        
        <div class="kpi-card">
          <div class="kpi-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
            <i class="fa-solid fa-star"></i>
          </div>
          <div class="flex-1">
            <div class="kpi-label">Average Rating</div>
            <div class="kpi-value">4.5</div>
            <p class="text-xs text-slate-500 mt-1">Out of 5.0 stars</p>
          </div>
        </div>
      </div>

      <!-- Upcoming Workshops List with Filters -->
      <div class="card p-0 overflow-hidden mb-8">
        <div class="p-4 border-b bg-slate-50">
          <h3 class="font-bold mb-4">Upcoming Workshops</h3>
          <div class="flex flex-wrap gap-3 items-end">
            <div>
              <label class="text-xs font-bold text-slate-500 block mb-1">Filter by Status</label>
              <select id="wsStatusFilter" class="input-royal w-40">
                <option value="">All Status</option>
                <option value="Upcoming">Upcoming</option>
                <option value="In Progress">In Progress</option>
                <option value="Completed">Completed</option>
                <option value="Cancelled">Cancelled</option>
              </select>
            </div>
            <div>
              <label class="text-xs font-bold text-slate-500 block mb-1">Filter by Location</label>
              <select id="wsLocationFilter" class="input-royal w-48">
                <option value="">All Locations</option>
              </select>
            </div>
            <div>
              <label class="text-xs font-bold text-slate-500 block mb-1">Filter by Instructor</label>
              <select id="wsInstructorFilter" class="input-royal w-48">
                <option value="">All Instructors</option>
              </select>
            </div>
            <div>
              <label class="text-xs font-bold text-slate-500 block mb-1">Search</label>
              <input type="text" id="wsSearch" placeholder="Search workshops..." class="input-royal w-64">
            </div>
          </div>
        </div>
        <div id="workshopsListContainer" style="max-height:calc(100vh - 350px); overflow-y:auto;">
          <div id="workshopsList"></div>
        </div>
      </div>

      <div class="card p-0 overflow-hidden mt-8">
        <div class="p-4 border-b bg-slate-50">
          <h3 class="font-bold mb-4">Detailed Workshop Directory</h3>
          <div class="flex flex-wrap gap-3 items-end">
            <div class="relative">
              <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
              <input type="text" id="workshopSearch" placeholder="Search workshops..." class="pl-10 pr-4 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:border-sozo-500 w-64">
            </div>
            <div>
              <label class="text-xs font-bold text-slate-500 block mb-1">Filter by Status</label>
              <select id="wsDirStatusFilter" class="input-royal w-40">
                <option value="">All Status</option>
                <option value="Upcoming">Upcoming</option>
                <option value="In Progress">In Progress</option>
                <option value="Completed">Completed</option>
                <option value="Cancelled">Cancelled</option>
              </select>
            </div>
            <div>
              <label class="text-xs font-bold text-slate-500 block mb-1">Filter by Location</label>
              <select id="wsDirLocationFilter" class="input-royal w-48">
                <option value="">All Locations</option>
              </select>
            </div>
            <div>
              <label class="text-xs font-bold text-slate-500 block mb-1">Filter by Instructor</label>
              <select id="wsDirInstructorFilter" class="input-royal w-48">
                <option value="">All Instructors</option>
              </select>
            </div>
          </div>
        </div>
        <div style="max-height:calc(100vh - 600px); overflow-y:auto;">
          <table>
            <thead><tr><th>ID</th><th>Title</th><th>Date</th><th>Location</th><th>Instructor</th><th>Status</th><th>Registered</th><th>Fee</th><th>Actions</th></tr></thead>
            <tbody id="workshopTableBody"></tbody>
          </table>
        </div>
      </div>
      
      <div id="workshopDetailModal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 max-h-96 overflow-y-auto">
          <button onclick="document.getElementById('workshopDetailModal').classList.add('hidden')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times text-xl"></i></button>
          <div id="workshopDetailContent"></div>
        </div>
      </div>

      <div id="editWorkshopModal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[95vh] overflow-y-auto flex flex-col">
          <div class="sticky top-0 bg-white border-b p-6 flex justify-between items-center">
            <h2 class="text-2xl font-bold">Edit Workshop</h2>
            <button onclick="document.getElementById('editWorkshopModal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times text-xl"></i></button>
          </div>
          <div class="p-6 flex-1 space-y-6">
            <!-- Basic Information Section -->
            <div class="border-b pb-6">
              <h3 class="text-lg font-bold mb-4"><i class="fa-solid fa-info-circle text-sozo-600 mr-2"></i>Basic Information</h3>
              <input type="text" id="editWsId" placeholder="Workshop ID" readonly class="w-full p-2 border rounded-lg bg-slate-100 mb-4" />
              <input type="text" id="editWsTitle" placeholder="Workshop Title" class="w-full p-2 border rounded-lg mb-4" />
              <textarea id="editWsDescription" placeholder="Detailed Description" class="w-full p-2 border rounded-lg h-24 mb-4"></textarea>
            </div>

            <!-- Schedule Section -->
            <div class="border-b pb-6">
              <h3 class="text-lg font-bold mb-4"><i class="fa-solid fa-calendar text-sozo-600 mr-2"></i>Schedule & Duration</h3>
              <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                  <label class="text-xs font-bold text-slate-600 block mb-1">Date</label>
                  <input type="date" id="editWsDate" class="w-full p-2 border rounded-lg" />
                </div>
                <div>
                  <label class="text-xs font-bold text-slate-600 block mb-1">Time</label>
                  <input type="time" id="editWsTime" class="w-full p-2 border rounded-lg" />
                </div>
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="text-xs font-bold text-slate-600 block mb-1">Duration (hours)</label>
                  <input type="number" id="editWsDuration" min="0.5" step="0.5" placeholder="e.g., 2" class="w-full p-2 border rounded-lg" />
                </div>
                <div>
                  <label class="text-xs font-bold text-slate-600 block mb-1">Difficulty Level</label>
                  <select id="editWsDifficulty" class="w-full p-2 border rounded-lg">
                    <option value="Beginner">Beginner</option>
                    <option value="Intermediate">Intermediate</option>
                    <option value="Advanced">Advanced</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Location & Venue Section -->
            <div class="border-b pb-6">
              <h3 class="text-lg font-bold mb-4"><i class="fa-solid fa-map-pin text-sozo-600 mr-2"></i>Location & Venue</h3>
              <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                  <label class="text-xs font-bold text-slate-600 block mb-1">Location/City</label>
                  <input type="text" id="editWsLocation" placeholder="e.g., Berlin, Germany" class="w-full p-2 border rounded-lg" />
                </div>
                <div>
                  <label class="text-xs font-bold text-slate-600 block mb-1">Venue/Room</label>
                  <input type="text" id="editWsVenue" placeholder="e.g., Hall A, Conference Room" class="w-full p-2 border rounded-lg" />
                </div>
              </div>
              <textarea id="editWsVenueDetails" placeholder="Venue Details (address, directions, parking)" class="w-full p-2 border rounded-lg h-16"></textarea>
            </div>

            <!-- Instructor & Capacity Section -->
            <div class="border-b pb-6">
              <h3 class="text-lg font-bold mb-4"><i class="fa-solid fa-users text-sozo-600 mr-2"></i>Instructor & Capacity</h3>
              <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                  <label class="text-xs font-bold text-slate-600 block mb-1">Lead Instructor</label>
                  <input type="text" id="editWsInstructor" placeholder="e.g., Dr. Jane Smith" class="w-full p-2 border rounded-lg" />
                </div>
                <div>
                  <label class="text-xs font-bold text-slate-600 block mb-1">Co-Instructor (Optional)</label>
                  <input type="text" id="editWsCoInstructor" placeholder="e.g., Dr. John Doe" class="w-full p-2 border rounded-lg" />
                </div>
              </div>
              <div class="grid grid-cols-3 gap-4">
                <div>
                  <label class="text-xs font-bold text-slate-600 block mb-1">Capacity</label>
                  <input type="number" id="editWsCapacity" min="1" placeholder="Max attendees" class="w-full p-2 border rounded-lg" />
                </div>
                <div>
                  <label class="text-xs font-bold text-slate-600 block mb-1">Registered</label>
                  <input type="number" id="editWsRegistered" min="0" placeholder="Current registrations" class="w-full p-2 border rounded-lg" />
                </div>
                <div>
                  <label class="text-xs font-bold text-slate-600 block mb-1">Min. Required</label>
                  <input type="number" id="editWsMinAttendees" min="1" placeholder="Minimum to run" class="w-full p-2 border rounded-lg" />
                </div>
              </div>
            </div>

            <!-- Pricing & Status Section -->
            <div class="border-b pb-6">
              <h3 class="text-lg font-bold mb-4"><i class="fa-solid fa-euro-sign text-sozo-600 mr-2"></i>Pricing & Status</h3>
              <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                  <label class="text-xs font-bold text-slate-600 block mb-1">Fee (€)</label>
                  <input type="number" id="editWsFee" min="0" step="0.01" placeholder="0" class="w-full p-2 border rounded-lg" />
                </div>
                <div>
                  <label class="text-xs font-bold text-slate-600 block mb-1">Discount (%)</label>
                  <input type="number" id="editWsDiscount" min="0" max="100" step="0.1" placeholder="0" class="w-full p-2 border rounded-lg" />
                </div>
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="text-xs font-bold text-slate-600 block mb-1">Status</label>
                  <select id="editWsStatus" class="w-full p-2 border rounded-lg">
                    <option value="Upcoming">Upcoming</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Completed">Completed</option>
                    <option value="Cancelled">Cancelled</option>
                  </select>
                </div>
                <div>
                  <label class="text-xs font-bold text-slate-600 block mb-1">Rating</label>
                  <div class="flex items-center gap-2">
                    <input type="number" id="editWsRating" min="0" max="5" step="0.1" placeholder="0-5" class="w-full p-2 border rounded-lg" />
                    <span class="text-slate-600"><i class="fa-solid fa-star"></i></span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Additional Details Section -->
            <div class="border-b pb-6">
              <h3 class="text-lg font-bold mb-4"><i class="fa-solid fa-file-alt text-sozo-600 mr-2"></i>Additional Details</h3>
              <div class="mb-4">
                <label class="text-xs font-bold text-slate-600 block mb-1">Prerequisites</label>
                <textarea id="editWsPrerequisites" placeholder="e.g., Basic knowledge of neurology required" class="w-full p-2 border rounded-lg h-16"></textarea>
              </div>
              <div class="mb-4">
                <label class="text-xs font-bold text-slate-600 block mb-1">Materials/Resources</label>
                <textarea id="editWsMaterials" placeholder="e.g., Presentation slides, Handouts, Reference documents" class="w-full p-2 border rounded-lg h-16"></textarea>
              </div>
              <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="flex items-center">
                  <input type="checkbox" id="editWsCertificate" class="w-4 h-4 mr-2" />
                  <label class="text-sm font-bold">Certificate Offered</label>
                </div>
                <div class="flex items-center">
                  <input type="checkbox" id="editWsRecording" class="w-4 h-4 mr-2" />
                  <label class="text-sm font-bold">Recording Available</label>
                </div>
              </div>
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-1">Cancellation Policy/Notes</label>
                <textarea id="editWsCancellationNotes" placeholder="e.g., Full refund if cancelled 48hrs before" class="w-full p-2 border rounded-lg h-16"></textarea>
              </div>
            </div>
          </div>

          <div class="sticky bottom-0 bg-white border-t p-6 flex gap-2">
            <button class="flex-1 bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-sozo-700" onclick="saveEditWorkshop()"><i class="fa-solid fa-save mr-2"></i>Save Changes</button>
            <button class="flex-1 bg-slate-300 text-slate-700 px-4 py-2 rounded-lg font-bold hover:bg-slate-400" onclick="document.getElementById('editWorkshopModal').classList.add('hidden')">Cancel</button>
          </div>
        </div>
      </div>

      <div id="createWorkshopModal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto flex flex-col">
          <div class="sticky top-0 bg-white border-b p-6"><h2 class="text-2xl font-bold">Create Workshop</h2></div>
          <div class="p-6 flex-1 space-y-4">
            <input type="text" id="createWsTitle" placeholder="Workshop Title" class="w-full p-2 border rounded-lg" />
            <div class="grid grid-cols-2 gap-4">
              <input type="date" id="createWsDate" class="w-full p-2 border rounded-lg" />
              <input type="time" id="createWsTime" class="w-full p-2 border rounded-lg" />
            </div>
            <div class="grid grid-cols-2 gap-4">
              <input type="text" id="createWsLocation" placeholder="Location" class="w-full p-2 border rounded-lg" />
              <input type="text" id="createWsInstructor" placeholder="Instructor" class="w-full p-2 border rounded-lg" />
            </div>
            <div class="grid grid-cols-3 gap-4">
              <input type="number" id="createWsCapacity" placeholder="Capacity" min="1" class="w-full p-2 border rounded-lg" />
              <input type="number" id="createWsFee" placeholder="Fee (€)" min="0" class="w-full p-2 border rounded-lg" />
              <select id="createWsStatus" class="w-full p-2 border rounded-lg">
                <option value="Upcoming">Upcoming</option>
                <option value="In Progress">In Progress</option>
                <option value="Completed">Completed</option>
              </select>
            </div>
            <textarea id="createWsDescription" placeholder="Description" class="w-full p-2 border rounded-lg h-20"></textarea>
          </div>
          <div class="sticky bottom-0 bg-white border-t p-6 flex gap-2">
            <button class="flex-1 bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold" onclick="saveCreateWorkshop()">Create</button>
            <button class="flex-1 bg-slate-300 px-4 py-2 rounded-lg font-bold" onclick="document.getElementById('createWorkshopModal').classList.add('hidden')">Cancel</button>
          </div>
        </div>
      </div>

      <div id="workshopAttendeesModal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto flex flex-col">
          <div class="sticky top-0 bg-white border-b p-6"><h2 class="text-2xl font-bold">Workshop Attendees</h2></div>
          <div class="p-6 flex-1">
            <div id="attendeesContent"></div>
          </div>
          <div class="sticky bottom-0 bg-white border-t p-6">
            <button class="px-4 py-2 bg-slate-300 rounded-lg" onclick="document.getElementById('workshopAttendeesModal').classList.add('hidden')">Close</button>
          </div>
        </div>
      </div>
    </div>
    `;

    // Define all functions IMMEDIATELY (BEFORE setTimeout) so onclick handlers work right away
    window.openCreateWorkshopModal = () => {
      document.getElementById('createWsTitle').value = '';
      document.getElementById('createWsDate').value = '';
      document.getElementById('createWsTime').value = '';
      document.getElementById('createWsLocation').value = '';
      document.getElementById('createWsInstructor').value = '';
      document.getElementById('createWsCapacity').value = '';
      document.getElementById('createWsFee').value = '';
      document.getElementById('createWsStatus').value = 'Upcoming';
      document.getElementById('createWsDescription').value = '';
      document.getElementById('createWorkshopModal').classList.remove('hidden');
    };

    window.saveCreateWorkshop = () => {
      const title = document.getElementById('createWsTitle').value.trim();
      const date = document.getElementById('createWsDate').value;
      const time = document.getElementById('createWsTime').value;
      const location = document.getElementById('createWsLocation').value.trim();
      const instructor = document.getElementById('createWsInstructor').value.trim();
      const capacity = parseInt(document.getElementById('createWsCapacity').value);
      const fee = parseInt(document.getElementById('createWsFee').value);
      const status = document.getElementById('createWsStatus').value;
      const description = document.getElementById('createWsDescription').value.trim();

      if (!title || !date || !time || !location || !instructor || !capacity || isNaN(fee) || !description) {
        alert('Please fill in all required fields');
        return;
      }

      const maxId = Math.max(...sampleData.workshops.map(w => parseInt(w.id.split('-')[1])), 0);
      const newId = `WS-${String(maxId + 1).padStart(3, '0')}`;

      sampleData.workshops.unshift({
        id: newId, title, date, time, location, instructor, capacity, registered: 0, fee, status, description, rating: 4.5
      });

      document.getElementById('createWorkshopModal').classList.add('hidden');
      renderAdmin('workshops');
      alert(`✓ Workshop "${title}" created successfully!`);
    };

    window.openEditWorkshopModal = (id) => {
      const w = sampleData.workshops.find(x => x.id === id);
      if (!w) return;
      document.getElementById('editWsId').value = w.id;
      document.getElementById('editWsTitle').value = w.title;
      document.getElementById('editWsDate').value = w.date;
      document.getElementById('editWsTime').value = w.time;
      document.getElementById('editWsLocation').value = w.location;
      document.getElementById('editWsInstructor').value = w.instructor;
      document.getElementById('editWsCapacity').value = w.capacity;
      document.getElementById('editWsRegistered').value = w.registered;
      document.getElementById('editWsFee').value = w.fee;
      document.getElementById('editWsStatus').value = w.status;
      document.getElementById('editWsDescription').value = w.description;
      document.getElementById('editWsVenue').value = w.venue || '';
      document.getElementById('editWsVenueDetails').value = w.venueDetails || '';
      document.getElementById('editWsDuration').value = w.duration || '';
      document.getElementById('editWsDifficulty').value = w.difficulty || 'Intermediate';
      document.getElementById('editWsCoInstructor').value = w.coInstructor || '';
      document.getElementById('editWsMinAttendees').value = w.minAttendees || '5';
      document.getElementById('editWsDiscount').value = w.discount || '0';
      document.getElementById('editWsRating').value = w.rating || '0';
      document.getElementById('editWsPrerequisites').value = w.prerequisites || '';
      document.getElementById('editWsMaterials').value = w.materials || '';
      document.getElementById('editWsCertificate').checked = w.certificate || false;
      document.getElementById('editWsRecording').checked = w.recording || false;
      document.getElementById('editWsCancellationNotes').value = w.cancellationNotes || '';
      document.getElementById('editWorkshopModal').classList.remove('hidden');
    };

    window.saveEditWorkshop = () => {
      const id = document.getElementById('editWsId').value;
      const title = document.getElementById('editWsTitle').value.trim();
      const date = document.getElementById('editWsDate').value;
      const time = document.getElementById('editWsTime').value;
      const location = document.getElementById('editWsLocation').value.trim();
      const instructor = document.getElementById('editWsInstructor').value.trim();
      const capacity = parseInt(document.getElementById('editWsCapacity').value);
      const registered = parseInt(document.getElementById('editWsRegistered').value);
      const fee = parseFloat(document.getElementById('editWsFee').value) || 0;
      const status = document.getElementById('editWsStatus').value;
      const description = document.getElementById('editWsDescription').value.trim();
      const venue = document.getElementById('editWsVenue').value.trim();
      const venueDetails = document.getElementById('editWsVenueDetails').value.trim();
      const duration = document.getElementById('editWsDuration').value;
      const difficulty = document.getElementById('editWsDifficulty').value;
      const coInstructor = document.getElementById('editWsCoInstructor').value.trim();
      const minAttendees = parseInt(document.getElementById('editWsMinAttendees').value) || 5;
      const discount = parseFloat(document.getElementById('editWsDiscount').value) || 0;
      const rating = parseFloat(document.getElementById('editWsRating').value) || 0;
      const prerequisites = document.getElementById('editWsPrerequisites').value.trim();
      const materials = document.getElementById('editWsMaterials').value.trim();
      const certificate = document.getElementById('editWsCertificate').checked;
      const recording = document.getElementById('editWsRecording').checked;
      const cancellationNotes = document.getElementById('editWsCancellationNotes').value.trim();

      if (!title || !date || !time || !location || !instructor || !capacity || isNaN(registered) || !description) {
        alert('Please fill in all required fields');
        return;
      }

      if (registered > capacity) {
        alert('Registered count cannot exceed capacity');
        return;
      }

      if (rating < 0 || rating > 5) {
        alert('Rating must be between 0 and 5');
        return;
      }

      const w = sampleData.workshops.find(x => x.id === id);
      if (w) {
        w.title = title;
        w.date = date;
        w.time = time;
        w.location = location;
        w.instructor = instructor;
        w.capacity = capacity;
        w.registered = registered;
        w.fee = fee;
        w.status = status;
        w.description = description;
        w.venue = venue;
        w.venueDetails = venueDetails;
        w.duration = duration;
        w.difficulty = difficulty;
        w.coInstructor = coInstructor;
        w.minAttendees = minAttendees;
        w.discount = discount;
        w.rating = rating;
        w.prerequisites = prerequisites;
        w.materials = materials;
        w.certificate = certificate;
        w.recording = recording;
        w.cancellationNotes = cancellationNotes;
      }

      document.getElementById('editWorkshopModal').classList.add('hidden');
      renderAdmin('workshops');
      alert(`✓ Workshop "${title}" updated successfully!`);
    };

    window.showWorkshopDetail = (id) => {
      const w = sampleData.workshops.find(x => x.id === id);
      if (!w) return;
      document.getElementById('workshopDetailContent').innerHTML = `
        <h3 class="text-2xl font-bold mb-4">${w.title}</h3>
        <div class="grid grid-cols-2 gap-4 mb-6">
          <div><strong>ID:</strong> ${w.id}</div>
          <div><strong>Status:</strong> ${w.status}</div>
          <div><strong>Date:</strong> ${w.date}</div>
          <div><strong>Time:</strong> ${w.time}</div>
          <div><strong>Location:</strong> ${w.location}</div>
          <div><strong>Instructor:</strong> ${w.instructor}</div>
          <div><strong>Capacity:</strong> ${w.capacity}</div>
          <div><strong>Registered:</strong> ${w.registered}</div>
          <div><strong>Fee:</strong> €${w.fee}</div>
        </div>
        <p class="mb-6">${w.description}</p>
        <div class="flex gap-2">
          <button class="flex-1 bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold" onclick="openEditWorkshopModal('${w.id}'); document.getElementById('workshopDetailModal').classList.add('hidden')">Edit</button>
          <button class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg font-bold" onclick="showWorkshopAttendees('${w.id}'); document.getElementById('workshopDetailModal').classList.add('hidden')">Attendees (${w.registered})</button>
          <button class="flex-1 bg-slate-600 text-white px-4 py-2 rounded-lg font-bold" onclick="deleteWorkshop('${w.id}'); document.getElementById('workshopDetailModal').classList.add('hidden')">Delete</button>
        </div>
      `;
      document.getElementById('workshopDetailModal').classList.remove('hidden');
    };

    window.showWorkshopAttendees = (id) => {
      const w = sampleData.workshops.find(x => x.id === id);
      if (!w) return;
      const names = ['Alex Johnson', 'Maria Gomez', 'Liam Smith', 'Emma Chen', 'Noah Brown', 'Sophia Martinez', 'Oliver Davis', 'Isabella Garcia', 'James Wilson', 'Amelia Rodriguez'];
      const attendees = Array.from({length: w.registered}).map((_, i) => ({
        id: `ATT-${String(i+1).padStart(3,'0')}`,
        name: names[i % names.length],
        email: names[i % names.length].toLowerCase().replace(' ', '.') + '@healthcare.com',
        date: w.date,
        status: Math.random() > 0.1 ? 'Registered' : 'Waitlist'
      }));
      document.getElementById('attendeesContent').innerHTML = `
        <h3 class="text-xl font-bold mb-4">${w.title} (${w.registered}/${w.capacity})</h3>
        <table class="w-full text-sm">
          <thead><tr style="background:#f1f5f9"><th class="p-2 text-left">ID</th><th class="p-2 text-left">Name</th><th class="p-2 text-left">Email</th><th class="p-2 text-left">Status</th></tr></thead>
          <tbody>
            ${attendees.map(a => `<tr style="border-bottom:1px solid #e2e8f0"><td class="p-2">${a.id}</td><td class="p-2">${a.name}</td><td class="p-2">${a.email}</td><td class="p-2"><span class="badge badge-${a.status === 'Registered' ? 'success' : 'warning'}">${a.status}</span></td></tr>`).join('')}
          </tbody>
        </table>
      `;
      document.getElementById('workshopAttendeesModal').classList.remove('hidden');
    };

    window.deleteWorkshop = (id) => {
      const w = sampleData.workshops.find(x => x.id === id);
      if (!w || !confirm(`Delete "${w.title}"?`)) return;
      sampleData.workshops = sampleData.workshops.filter(x => x.id !== id);
      renderAdmin('workshops');
      alert(`✓ Workshop deleted!`);
    };

    // Setup rendering after small delay
    setTimeout(() => {
      let filteredWorkshops = [...sampleData.workshops];
      let filterWsStatus = '';
      let filterWsLocation = '';
      let filterWsInstructor = '';
      let searchTerm = '';

      // Populate dropdown options
      const uniqueLocations = [...new Set(sampleData.workshops.map(w => w.location))].sort();
      const uniqueInstructors = [...new Set(sampleData.workshops.map(w => w.instructor))].sort();

      const locationSelect = document.getElementById('wsLocationFilter');
      const instructorSelect = document.getElementById('wsInstructorFilter');
      const dirLocationSelect = document.getElementById('wsDirLocationFilter');
      const dirInstructorSelect = document.getElementById('wsDirInstructorFilter');

      if (locationSelect) {
        uniqueLocations.forEach(loc => {
          const option = document.createElement('option');
          option.value = loc;
          option.textContent = loc;
          locationSelect.appendChild(option);
        });
      }

      if (instructorSelect) {
        uniqueInstructors.forEach(instr => {
          const option = document.createElement('option');
          option.value = instr;
          option.textContent = instr;
          instructorSelect.appendChild(option);
        });
      }

      if (dirLocationSelect) {
        uniqueLocations.forEach(loc => {
          const option = document.createElement('option');
          option.value = loc;
          option.textContent = loc;
          dirLocationSelect.appendChild(option);
        });
      }

      if (dirInstructorSelect) {
        uniqueInstructors.forEach(instr => {
          const option = document.createElement('option');
          option.value = instr;
          option.textContent = instr;
          dirInstructorSelect.appendChild(option);
        });
      }

      function renderWorkshopsList() {
        const filtered = sampleData.workshops.filter(w => {
          const matchStatus = !filterWsStatus || w.status === filterWsStatus;
          const matchLocation = !filterWsLocation || w.location === filterWsLocation;
          const matchInstructor = !filterWsInstructor || w.instructor === filterWsInstructor;
          const matchSearch = !searchTerm || w.title.toLowerCase().includes(searchTerm) || w.id.toLowerCase().includes(searchTerm);
          return matchStatus && matchLocation && matchInstructor && matchSearch;
        });

        const listContainer = document.getElementById('workshopsList');
        if (!listContainer) return;

        listContainer.innerHTML = filtered.map(w => `
          <div class="border-b last:border-b-0 p-4 hover:bg-slate-50 transition">
            <div class="flex justify-between items-start gap-4">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-2">
                  <h4 class="font-bold text-lg text-slate-900">${w.title}</h4>
                  <span class="badge badge-${w.status === 'Upcoming' ? 'info' : w.status === 'Completed' ? 'success' : 'warning'}">${w.status}</span>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm text-slate-600">
                  <div><i class="fa-solid fa-calendar text-sozo-600 mr-2"></i>${w.date}</div>
                  <div><i class="fa-solid fa-clock text-sozo-600 mr-2"></i>${w.time}</div>
                  <div><i class="fa-solid fa-map-pin text-sozo-600 mr-2"></i>${w.location}</div>
                  <div><i class="fa-solid fa-user-tie text-sozo-600 mr-2"></i>${w.instructor}</div>
                </div>
                <div class="flex items-center gap-4 mt-2">
                  <span class="text-xs text-slate-500"><strong>${w.registered}/${w.capacity}</strong> Registered</span>
                  <div class="flex-1 h-2 bg-slate-200 rounded-full overflow-hidden max-w-xs">
                    <div class="h-full bg-sozo-600" style="width: ${(w.registered/w.capacity)*100}%"></div>
                  </div>
                  <span class="text-xs text-slate-500">€${w.fee}</span>
                </div>
              </div>
              <div class="flex gap-2">
                <button class="px-3 py-2 bg-sozo-600 text-white rounded-lg text-sm font-bold hover:bg-sozo-700" onclick="openEditWorkshopModal('${w.id}')"><i class="fa-solid fa-edit"></i></button>
                <button class="px-3 py-2 bg-blue-100 text-blue-600 rounded-lg text-sm font-bold hover:bg-blue-200" onclick="showWorkshopDetail('${w.id}')"><i class="fa-solid fa-info-circle"></i></button>
                <button class="px-3 py-2 bg-orange-100 text-sozo-600 rounded-lg text-sm font-bold hover:bg-orange-200" onclick="showWorkshopAttendees('${w.id}')"><i class="fa-solid fa-users mr-1"></i>${w.registered} Attendees</button>
              </div>
            </div>
          </div>
        `).join('') || '<div class="p-8 text-center text-slate-500">No workshops found</div>';
      }

      function renderWorkshopsTable() {
        const filtered = sampleData.workshops.filter(w => {
          const matchStatus = !document.getElementById('wsDirStatusFilter')?.value || w.status === document.getElementById('wsDirStatusFilter').value;
          const matchLocation = !document.getElementById('wsDirLocationFilter')?.value || w.location === document.getElementById('wsDirLocationFilter').value;
          const matchInstructor = !document.getElementById('wsDirInstructorFilter')?.value || w.instructor === document.getElementById('wsDirInstructorFilter').value;
          const matchSearch = !document.getElementById('workshopSearch')?.value || w.title.toLowerCase().includes(document.getElementById('workshopSearch').value.toLowerCase()) || w.id.toLowerCase().includes(document.getElementById('workshopSearch').value.toLowerCase());
          return matchStatus && matchLocation && matchInstructor && matchSearch;
        });

        const tbody = document.getElementById('workshopTableBody');
        if (!tbody) return;

        tbody.innerHTML = filtered.map(w => `
          <tr>
            <td><strong>${w.id}</strong></td>
            <td>${w.title}</td>
            <td>${w.date}</td>
            <td>${w.location}</td>
            <td>${w.instructor}</td>
            <td><span class="badge badge-${w.status === 'Upcoming' ? 'info' : w.status === 'Completed' ? 'success' : 'warning'}">${w.status}</span></td>
            <td><strong>${w.registered}/${w.capacity}</strong></td>
            <td>€${w.fee}</td>
            <td class="flex gap-2">
              <button class="text-blue-600 hover:text-blue-800 font-bold" onclick="showWorkshopDetail('${w.id}')"><i class="fa-solid fa-info-circle"></i></button>
              <button class="text-slate-400 hover:text-blue-600 font-bold" onclick="openEditWorkshopModal('${w.id}')"><i class="fa-solid fa-edit"></i></button>
              <button class="text-slate-400 hover:text-slate-600" onclick="deleteWorkshop('${w.id}')"><i class="fa-solid fa-trash"></i></button>
            </td>
          </tr>
        `).join('') || '<tr><td colspan="9" class="p-8 text-center text-slate-500">No workshops found</td></tr>';
      }

      // Event listeners for upcoming workshops filters
      const wsStatusFilter = document.getElementById('wsStatusFilter');
      const wsLocationFilter = document.getElementById('wsLocationFilter');
      const wsInstructorFilter = document.getElementById('wsInstructorFilter');
      const wsSearch = document.getElementById('wsSearch');

      if (wsStatusFilter) wsStatusFilter.addEventListener('change', (e) => { filterWsStatus = e.target.value; renderWorkshopsList(); });
      if (wsLocationFilter) wsLocationFilter.addEventListener('change', (e) => { filterWsLocation = e.target.value; renderWorkshopsList(); });
      if (wsInstructorFilter) wsInstructorFilter.addEventListener('change', (e) => { filterWsInstructor = e.target.value; renderWorkshopsList(); });
      if (wsSearch) wsSearch.addEventListener('input', (e) => { searchTerm = e.target.value.toLowerCase(); renderWorkshopsList(); });

      // Event listeners for detailed directory filters
      const workshopSearch = document.getElementById('workshopSearch');
      const wsDirStatusFilter = document.getElementById('wsDirStatusFilter');
      const wsDirLocationFilter = document.getElementById('wsDirLocationFilter');
      const wsDirInstructorFilter = document.getElementById('wsDirInstructorFilter');

      if (workshopSearch) workshopSearch.addEventListener('input', renderWorkshopsTable);
      if (wsDirStatusFilter) wsDirStatusFilter.addEventListener('change', renderWorkshopsTable);
      if (wsDirLocationFilter) wsDirLocationFilter.addEventListener('change', renderWorkshopsTable);
      if (wsDirInstructorFilter) wsDirInstructorFilter.addEventListener('change', renderWorkshopsTable);

      // Initial render
      renderWorkshopsList();
      renderWorkshopsTable();
    }, 100);

    // Complete HTML template with all modals and forms
    area.innerHTML += `
      <div id="workshopDetailModal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 max-h-96 overflow-y-auto">
          <button onclick="document.getElementById('workshopDetailModal').classList.add('hidden')" class="absolute top-4 right-4 text-slate-400"><i class="fa-solid fa-times"></i></button>
          <div id="workshopDetailContent"></div>
        </div>
      </div>

      <div id="createWorkshopModal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto flex flex-col">
          <div class="sticky top-0 bg-white border-b p-6"><h2 class="text-2xl font-bold">Create Workshop</h2></div>
          <div class="p-6 flex-1 space-y-4">
            <input type="text" id="createWsTitle" placeholder="Workshop Title" class="w-full p-2 border rounded-lg" />
            <div class="grid grid-cols-2 gap-4">
              <input type="date" id="createWsDate" class="w-full p-2 border rounded-lg" />
              <input type="time" id="createWsTime" class="w-full p-2 border rounded-lg" />
            </div>
            <div class="grid grid-cols-2 gap-4">
              <input type="text" id="createWsLocation" placeholder="Location" class="w-full p-2 border rounded-lg" />
              <input type="text" id="createWsInstructor" placeholder="Instructor" class="w-full p-2 border rounded-lg" />
            </div>
            <div class="grid grid-cols-3 gap-4">
              <input type="number" id="createWsCapacity" placeholder="Capacity" min="1" class="w-full p-2 border rounded-lg" />
              <input type="number" id="createWsFee" placeholder="Fee (€)" min="0" class="w-full p-2 border rounded-lg" />
              <select id="createWsStatus" class="w-full p-2 border rounded-lg">
                <option value="Upcoming">Upcoming</option>
                <option value="In Progress">In Progress</option>
                <option value="Completed">Completed</option>
              </select>
            </div>
            <textarea id="createWsDescription" placeholder="Description" class="w-full p-2 border rounded-lg h-20"></textarea>
          </div>
          <div class="sticky bottom-0 bg-white border-t p-6 flex gap-2">
            <button class="flex-1 bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold" onclick="saveCreateWorkshop()">Create</button>
            <button class="flex-1 bg-slate-300 px-4 py-2 rounded-lg font-bold" onclick="document.getElementById('createWorkshopModal').classList.add('hidden')">Cancel</button>
          </div>
        </div>
      </div>

      <div id="editWorkshopModal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[95vh] overflow-y-auto flex flex-col">
          <div class="sticky top-0 bg-white border-b p-6 flex justify-between items-center">
            <h2 class="text-2xl font-bold">Edit Workshop</h2>
            <button onclick="document.getElementById('editWorkshopModal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times text-xl"></i></button>
          </div>
          <div class="p-6 flex-1 space-y-6">
            <!-- Basic Information Section -->
            <div class="border-b pb-6">
              <h3 class="text-lg font-bold mb-4"><i class="fa-solid fa-info-circle text-sozo-600 mr-2"></i>Basic Information</h3>
              <input type="text" id="editWsId" placeholder="Workshop ID" readonly class="w-full p-2 border rounded-lg bg-slate-100 mb-4" />
              <input type="text" id="editWsTitle" placeholder="Workshop Title" class="w-full p-2 border rounded-lg mb-4" />
              <textarea id="editWsDescription" placeholder="Detailed Description" class="w-full p-2 border rounded-lg h-24 mb-4"></textarea>
            </div>

            <!-- Schedule Section -->
            <div class="border-b pb-6">
              <h3 class="text-lg font-bold mb-4"><i class="fa-solid fa-calendar text-sozo-600 mr-2"></i>Schedule & Duration</h3>
              <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                  <label class="text-xs font-bold text-slate-600 block mb-1">Date</label>
                  <input type="date" id="editWsDate" class="w-full p-2 border rounded-lg" />
                </div>
                <div>
                  <label class="text-xs font-bold text-slate-600 block mb-1">Time</label>
                  <input type="time" id="editWsTime" class="w-full p-2 border rounded-lg" />
                </div>
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="text-xs font-bold text-slate-600 block mb-1">Duration (hours)</label>
                  <input type="number" id="editWsDuration" min="0.5" step="0.5" placeholder="e.g., 2" class="w-full p-2 border rounded-lg" />
                </div>
                <div>
                  <label class="text-xs font-bold text-slate-600 block mb-1">Difficulty Level</label>
                  <select id="editWsDifficulty" class="w-full p-2 border rounded-lg">
                    <option value="Beginner">Beginner</option>
                    <option value="Intermediate">Intermediate</option>
                    <option value="Advanced">Advanced</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Location & Venue Section -->
            <div class="border-b pb-6">
              <h3 class="text-lg font-bold mb-4"><i class="fa-solid fa-map-pin text-sozo-600 mr-2"></i>Location & Venue</h3>
              <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                  <label class="text-xs font-bold text-slate-600 block mb-1">Location/City</label>
                  <input type="text" id="editWsLocation" placeholder="e.g., Berlin, Germany" class="w-full p-2 border rounded-lg" />
                </div>
                <div>
                  <label class="text-xs font-bold text-slate-600 block mb-1">Venue/Room</label>
                  <input type="text" id="editWsVenue" placeholder="e.g., Hall A, Conference Room" class="w-full p-2 border rounded-lg" />
                </div>
              </div>
              <textarea id="editWsVenueDetails" placeholder="Venue Details (address, directions, parking)" class="w-full p-2 border rounded-lg h-16"></textarea>
            </div>

            <!-- Instructor & Capacity Section -->
            <div class="border-b pb-6">
              <h3 class="text-lg font-bold mb-4"><i class="fa-solid fa-users text-sozo-600 mr-2"></i>Instructor & Capacity</h3>
              <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                  <label class="text-xs font-bold text-slate-600 block mb-1">Lead Instructor</label>
                  <input type="text" id="editWsInstructor" placeholder="e.g., Dr. Jane Smith" class="w-full p-2 border rounded-lg" />
                </div>
                <div>
                  <label class="text-xs font-bold text-slate-600 block mb-1">Co-Instructor (Optional)</label>
                  <input type="text" id="editWsCoInstructor" placeholder="e.g., Dr. John Doe" class="w-full p-2 border rounded-lg" />
                </div>
              </div>
              <div class="grid grid-cols-3 gap-4">
                <div>
                  <label class="text-xs font-bold text-slate-600 block mb-1">Capacity</label>
                  <input type="number" id="editWsCapacity" min="1" placeholder="Max attendees" class="w-full p-2 border rounded-lg" />
                </div>
                <div>
                  <label class="text-xs font-bold text-slate-600 block mb-1">Registered</label>
                  <input type="number" id="editWsRegistered" min="0" placeholder="Current registrations" class="w-full p-2 border rounded-lg" />
                </div>
                <div>
                  <label class="text-xs font-bold text-slate-600 block mb-1">Min. Required</label>
                  <input type="number" id="editWsMinAttendees" min="1" placeholder="Minimum to run" class="w-full p-2 border rounded-lg" />
                </div>
              </div>
            </div>

            <!-- Pricing & Status Section -->
            <div class="border-b pb-6">
              <h3 class="text-lg font-bold mb-4"><i class="fa-solid fa-euro-sign text-sozo-600 mr-2"></i>Pricing & Status</h3>
              <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                  <label class="text-xs font-bold text-slate-600 block mb-1">Fee (€)</label>
                  <input type="number" id="editWsFee" min="0" step="0.01" placeholder="0" class="w-full p-2 border rounded-lg" />
                </div>
                <div>
                  <label class="text-xs font-bold text-slate-600 block mb-1">Discount (%)</label>
                  <input type="number" id="editWsDiscount" min="0" max="100" step="0.1" placeholder="0" class="w-full p-2 border rounded-lg" />
                </div>
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="text-xs font-bold text-slate-600 block mb-1">Status</label>
                  <select id="editWsStatus" class="w-full p-2 border rounded-lg">
                    <option value="Upcoming">Upcoming</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Completed">Completed</option>
                    <option value="Cancelled">Cancelled</option>
                  </select>
                </div>
                <div>
                  <label class="text-xs font-bold text-slate-600 block mb-1">Rating</label>
                  <div class="flex items-center gap-2">
                    <input type="number" id="editWsRating" min="0" max="5" step="0.1" placeholder="0-5" class="w-full p-2 border rounded-lg" />
                    <span class="text-slate-600"><i class="fa-solid fa-star"></i></span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Additional Details Section -->
            <div class="border-b pb-6">
              <h3 class="text-lg font-bold mb-4"><i class="fa-solid fa-file-alt text-sozo-600 mr-2"></i>Additional Details</h3>
              <div class="mb-4">
                <label class="text-xs font-bold text-slate-600 block mb-1">Prerequisites</label>
                <textarea id="editWsPrerequisites" placeholder="e.g., Basic knowledge of neurology required" class="w-full p-2 border rounded-lg h-16"></textarea>
              </div>
              <div class="mb-4">
                <label class="text-xs font-bold text-slate-600 block mb-1">Materials/Resources</label>
                <textarea id="editWsMaterials" placeholder="e.g., Presentation slides, Handouts, Reference documents" class="w-full p-2 border rounded-lg h-16"></textarea>
              </div>
              <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="flex items-center">
                  <input type="checkbox" id="editWsCertificate" class="w-4 h-4 mr-2" />
                  <label class="text-sm font-bold">Certificate Offered</label>
                </div>
                <div class="flex items-center">
                  <input type="checkbox" id="editWsRecording" class="w-4 h-4 mr-2" />
                  <label class="text-sm font-bold">Recording Available</label>
                </div>
              </div>
              <div>
                <label class="text-xs font-bold text-slate-600 block mb-1">Cancellation Policy/Notes</label>
                <textarea id="editWsCancellationNotes" placeholder="e.g., Full refund if cancelled 48hrs before" class="w-full p-2 border rounded-lg h-16"></textarea>
              </div>
            </div>
          </div>

          <div class="sticky bottom-0 bg-white border-t p-6 flex gap-2">
            <button class="flex-1 bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-sozo-700" onclick="saveEditWorkshop()"><i class="fa-solid fa-save mr-2"></i>Save Changes</button>
            <button class="flex-1 bg-slate-300 text-slate-700 px-4 py-2 rounded-lg font-bold hover:bg-slate-400" onclick="document.getElementById('editWorkshopModal').classList.add('hidden')">Cancel</button>
          </div>
        </div>
      </div>

      <div id="workshopAttendeesModal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto flex flex-col">
          <div class="sticky top-0 bg-white border-b p-6"><h2 class="text-2xl font-bold">Workshop Attendees</h2></div>
          <div class="p-6 flex-1">
            <div id="attendeesContent"></div>
          </div>
          <div class="sticky bottom-0 bg-white border-t p-6">
            <button class="px-4 py-2 bg-slate-300 rounded-lg" onclick="document.getElementById('workshopAttendeesModal').classList.add('hidden')">Close</button>
          </div>
        </div>
      </div>
    `;
    `
          
          <div class="p-6 flex-1">
            <div class="space-y-4">
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-bold mb-1">Workshop ID (Read-only)</label>
                  <input type="text" id="editWsId" readonly class="w-full p-2 border border-slate-300 rounded-lg bg-slate-100" />
                </div>
                <div>
                  <label class="block text-sm font-bold mb-1">Status</label>
                  <select id="editWsStatus" class="w-full p-2 border border-slate-300 rounded-lg focus:outline-none focus:border-sozo-500">
                    <option value="Upcoming">Upcoming</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Completed">Completed</option>
                    <option value="Cancelled">Cancelled</option>
                  </select>
                </div>
              </div>

              <div>
                <label class="block text-sm font-bold mb-1">Workshop Title *</label>
                <input type="text" id="editWsTitle" class="w-full p-2 border border-slate-300 rounded-lg focus:outline-none focus:border-sozo-500" />
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-bold mb-1">Date *</label>
                  <input type="date" id="editWsDate" class="w-full p-2 border border-slate-300 rounded-lg focus:outline-none focus:border-sozo-500" />
                </div>
                <div>
                  <label class="block text-sm font-bold mb-1">Time *</label>
                  <input type="time" id="editWsTime" class="w-full p-2 border border-slate-300 rounded-lg focus:outline-none focus:border-sozo-500" />
                </div>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-bold mb-1">Location *</label>
                  <input type="text" id="editWsLocation" class="w-full p-2 border border-slate-300 rounded-lg focus:outline-none focus:border-sozo-500" />
                </div>
                <div>
                  <label class="block text-sm font-bold mb-1">Instructor *</label>
                  <input type="text" id="editWsInstructor" class="w-full p-2 border border-slate-300 rounded-lg focus:outline-none focus:border-sozo-500" />
                </div>
              </div>

              <div class="grid grid-cols-3 gap-4">
                <div>
                  <label class="block text-sm font-bold mb-1">Capacity *</label>
                  <input type="number" id="editWsCapacity" class="w-full p-2 border border-slate-300 rounded-lg focus:outline-none focus:border-sozo-500" min="1" />
                </div>
                <div>
                  <label class="block text-sm font-bold mb-1">Registered *</label>
                  <input type="number" id="editWsRegistered" class="w-full p-2 border border-slate-300 rounded-lg focus:outline-none focus:border-sozo-500" min="0" />
                </div>
                <div>
                  <label class="block text-sm font-bold mb-1">Fee (€) *</label>
                  <input type="number" id="editWsFee" class="w-full p-2 border border-slate-300 rounded-lg focus:outline-none focus:border-sozo-500" min="0" />
                </div>
              </div>

              <div>
                <label class="block text-sm font-bold mb-1">Description *</label>
                <textarea id="editWsDescription" class="w-full p-2 border border-slate-300 rounded-lg focus:outline-none focus:border-sozo-500 h-24"></textarea>
              </div>
            </div>
          </div>

          <div class="sticky bottom-0 bg-white border-t p-6 flex gap-2">
            <button class="flex-1 bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-sozo-700" onclick="saveEditWorkshop()">Save Changes</button>
            <button class="flex-1 bg-slate-300 text-slate-700 px-4 py-2 rounded-lg font-bold hover:bg-slate-400" onclick="document.getElementById('editWorkshopModal').classList.add('hidden')">Cancel</button>
          </div>
        </div>
      </div>

      <!-- Workshop Attendees Modal -->
      <div id="workshopAttendeesModal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto flex flex-col">
          <div class="sticky top-0 bg-white border-b p-6 flex justify-between items-center">
            <h2 class="text-2xl font-bold">Workshop Attendees</h2>
            <button onclick="document.getElementById('workshopAttendeesModal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times text-xl"></i></button>
          </div>
          <div class="p-6 flex-1">
            <div id="attendeesContent"></div>
          </div>
        </div>
      </div>

      <div id="createWorkshopModal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto flex flex-col">
          <div class="sticky top-0 bg-white border-b p-6 flex justify-between items-center">
            <h2 class="text-2xl font-bold">Create New Workshop</h2>
            <button onclick="document.getElementById('createWorkshopModal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times text-xl"></i></button>
          </div>
          
          <div class="p-6 flex-1">
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-bold mb-1">Workshop Title *</label>
                <input type="text" id="createWsTitle" class="w-full p-2 border border-slate-300 rounded-lg focus:outline-none focus:border-sozo-500" placeholder="e.g., Advanced Neuroimaging Techniques" />
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-bold mb-1">Date *</label>
                  <input type="date" id="createWsDate" class="w-full p-2 border border-slate-300 rounded-lg focus:outline-none focus:border-sozo-500" />
                </div>
                <div>
                  <label class="block text-sm font-bold mb-1">Time *</label>
                  <input type="time" id="createWsTime" class="w-full p-2 border border-slate-300 rounded-lg focus:outline-none focus:border-sozo-500" />
                </div>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-bold mb-1">Location *</label>
                  <input type="text" id="createWsLocation" class="w-full p-2 border border-slate-300 rounded-lg focus:outline-none focus:border-sozo-500" placeholder="e.g., Berlin, Germany" />
                </div>
                <div>
                  <label class="block text-sm font-bold mb-1">Instructor *</label>
                  <input type="text" id="createWsInstructor" class="w-full p-2 border border-slate-300 rounded-lg focus:outline-none focus:border-sozo-500" placeholder="e.g., Dr. Jane Smith" />
                </div>
              </div>

              <div class="grid grid-cols-3 gap-4">
                <div>
                  <label class="block text-sm font-bold mb-1">Capacity *</label>
                  <input type="number" id="createWsCapacity" class="w-full p-2 border border-slate-300 rounded-lg focus:outline-none focus:border-sozo-500" min="1" placeholder="50" />
                </div>
                <div>
                  <label class="block text-sm font-bold mb-1">Fee (€) *</label>
                  <input type="number" id="createWsFee" class="w-full p-2 border border-slate-300 rounded-lg focus:outline-none focus:border-sozo-500" min="0" placeholder="150" />
                </div>
                <div>
                  <label class="block text-sm font-bold mb-1">Status</label>
                  <select id="createWsStatus" class="w-full p-2 border border-slate-300 rounded-lg focus:outline-none focus:border-sozo-500">
                    <option value="Upcoming">Upcoming</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Completed">Completed</option>
                    <option value="Cancelled">Cancelled</option>
                  </select>
                </div>
              </div>

              <div>
                <label class="block text-sm font-bold mb-1">Description *</label>
                <textarea id="createWsDescription" class="w-full p-2 border border-slate-300 rounded-lg focus:outline-none focus:border-sozo-500 h-24" placeholder="Enter workshop description, objectives, and key topics..."></textarea>
              </div>
            </div>
          </div>

          <div class="sticky bottom-0 bg-white border-t p-6 flex gap-2">
            <button class="flex-1 bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-sozo-700" onclick="saveCreateWorkshop()">Create Workshop</button>
            <button class="flex-1 bg-slate-300 text-slate-700 px-4 py-2 rounded-lg font-bold hover:bg-slate-400" onclick="document.getElementById('createWorkshopModal').classList.add('hidden')">Cancel</button>
          </div>
        </div>
      </div>
      </div>
    `;
    window.openCreateWorkshopModal = () => {
      // Clear form
      document.getElementById('createWsTitle').value = '';
      document.getElementById('createWsDate').value = '';
      document.getElementById('createWsTime').value = '';
      document.getElementById('createWsLocation').value = '';
      document.getElementById('createWsInstructor').value = '';
      document.getElementById('createWsCapacity').value = '';
      document.getElementById('createWsFee').value = '';
      document.getElementById('createWsStatus').value = 'Upcoming';
      document.getElementById('createWsDescription').value = '';
      
      document.getElementById('createWorkshopModal').classList.remove('hidden');
    };

    window.saveCreateWorkshop = () => {
      const title = document.getElementById('createWsTitle').value.trim();
      const date = document.getElementById('createWsDate').value;
      const time = document.getElementById('createWsTime').value;
      const location = document.getElementById('createWsLocation').value.trim();
      const instructor = document.getElementById('createWsInstructor').value.trim();
      const capacity = parseInt(document.getElementById('createWsCapacity').value);
      const fee = parseInt(document.getElementById('createWsFee').value);
      const status = document.getElementById('createWsStatus').value;
      const description = document.getElementById('createWsDescription').value.trim();

      // Validation
      if (!title || !date || !time || !location || !instructor || !capacity || isNaN(fee) || !description) {
        alert('Please fill in all required fields');
        return;
      }

      if (capacity < 1) {
        alert('Capacity must be at least 1');
        return;
      }

      if (fee < 0) {
        alert('Fee cannot be negative');
        return;
      }

      // Generate new ID
      const maxId = Math.max(...sampleData.workshops.map(w => parseInt(w.id.split('-')[1])), 0);
      const newId = `WS-${String(maxId + 1).padStart(3, '0')}`;

      // Create new workshop object
      const newWorkshop = {
        id: newId,
        title,
        date,
        time,
        location,
        instructor,
        capacity,
        registered: 0,
        fee,
        status,
        description,
        rating: 4.5
      };

      // Add to workshops array
      sampleData.workshops.unshift(newWorkshop);
      
      document.getElementById('createWorkshopModal').classList.add('hidden');
      renderAdmin('workshops');
      
      // Show success notification
      const notification = document.createElement('div');
      notification.className = 'fixed top-4 right-4 bg-orange-500 text-white px-6 py-3 rounded-lg shadow-lg z-[9999] animate-pulse';
      notification.textContent = `✓ Workshop "${title}" created successfully!`;
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), 3000);
    };

    window.showWorkshopDetail = (id) => {
      const w = sampleData.workshops.find(x => x.id === id);
      if (!w) return;
      const modal = document.getElementById('workshopDetailModal');
      const content = document.getElementById('workshopDetailContent');
      content.innerHTML = `
        <h3 class="text-2xl font-bold mb-4">${w.title}</h3>
        <div class="grid grid-cols-2 gap-4 mb-6">
          <div><strong>Workshop ID:</strong> ${w.id}</div>
          <div><strong>Status:</strong> <span class="badge badge-info">${w.status}</span></div>
          <div><strong>Date:</strong> ${w.date}</div>
          <div><strong>Time:</strong> ${w.time}</div>
          <div><strong>Location:</strong> ${w.location}</div>
          <div><strong>Instructor:</strong> ${w.instructor}</div>
          <div><strong>Capacity:</strong> ${w.capacity}</div>
          <div><strong>Registered:</strong> ${w.registered}</div>
          <div><strong>Fee:</strong> €${w.fee}</div>
        </div>
        <div class="bg-slate-100 p-4 rounded-lg mb-6">
          <strong>Description:</strong>
          <p class="text-slate-700 mt-2">${w.description}</p>
        </div>
        <div class="flex gap-2">
          <button class="flex-1 bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-sozo-700" onclick="openEditWorkshopModal('${w.id}'); document.getElementById('workshopDetailModal').classList.add('hidden')">Edit Workshop</button>
          <button class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700" onclick="showWorkshopAttendees('${w.id}'); document.getElementById('workshopDetailModal').classList.add('hidden')">View Attendees (${w.registered})</button>
          <button class="flex-1 bg-slate-100 text-slate-600 px-4 py-2 rounded-lg font-bold hover:bg-slate-200" onclick="deleteWorkshop('${w.id}'); document.getElementById('workshopDetailModal').classList.add('hidden')">Delete</button>
        </div>
      `;
      modal.classList.remove('hidden');
    };

    window.showWorkshopAttendees = (workshopId) => {
      const w = sampleData.workshops.find(x => x.id === workshopId);
      if (!w) return;

      // Generate sample attendees based on registered count
      const attendeeNames = [
        'Alex Johnson', 'Maria Gomez', 'Liam Smith', 'Emma Chen', 'Noah Brown',
        'Sophia Martinez', 'Oliver Davis', 'Isabella Garcia', 'James Wilson', 'Amelia Rodriguez',
        'Benjamin Lee', 'Mia Anderson', 'Lucas Thomas', 'Charlotte Taylor', 'Henry Moore',
        'Evelyn Jackson', 'Sebastian White', 'Harper Harris', 'Jack Martin', 'Aria Thompson',
        'Ethan Miller', 'Abigail Jones', 'Mason Garcia', 'Emily Rodriguez', 'Logan Davis',
        'Harper Lee', 'Alexander Taylor', 'Ella Anderson', 'Michael Brown', 'Avery Wilson'
      ];

      const attendees = Array.from({ length: w.registered }).map((_, i) => ({
        id: `ATT-${String(i + 1).padStart(3, '0')}`,
        name: attendeeNames[i % attendeeNames.length],
        email: `${attendeeNames[i % attendeeNames.length].toLowerCase().replace(' ', '.')}@healthcare.com`,
        registrationDate: new Date(new Date(w.date).getTime() - Math.random() * 30 * 24 * 60 * 60 * 1000).toLocaleDateString(),
        status: Math.random() > 0.1 ? 'Registered' : 'Waitlist'
      }));

      const modal = document.getElementById('workshopAttendeesModal');
      const content = document.getElementById('attendeesContent');
      
      content.innerHTML = `
        <div class="mb-6">
          <h3 class="text-xl font-bold mb-2">${w.title}</h3>
          <div class="grid grid-cols-4 gap-4 text-sm text-slate-600">
            <div><i class="fa-solid fa-calendar mr-2"></i><strong>${w.date}</strong></div>
            <div><i class="fa-solid fa-map-pin mr-2"></i><strong>${w.location}</strong></div>
            <div><i class="fa-solid fa-user-tie mr-2"></i><strong>${w.instructor}</strong></div>
            <div><i class="fa-solid fa-users mr-2"></i><strong>${w.registered}/${w.capacity}</strong> Registered</div>
          </div>
        </div>

        <div class="bg-slate-50 p-4 rounded-lg mb-4">
          <div class="text-sm text-slate-600">
            <strong>Total Attendees:</strong> ${attendees.length} 
            <span class="ml-4"><strong>Registered:</strong> ${attendees.filter(a => a.status === 'Registered').length}</span>
            <span class="ml-4"><strong>Waitlist:</strong> ${attendees.filter(a => a.status === 'Waitlist').length}</span>
          </div>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full">
            <thead>
              <tr style="background:#f1f5f9">
                <th class="p-3 text-left text-xs font-bold text-slate-700">ID</th>
                <th class="p-3 text-left text-xs font-bold text-slate-700">Name</th>
                <th class="p-3 text-left text-xs font-bold text-slate-700">Email</th>
                <th class="p-3 text-left text-xs font-bold text-slate-700">Registration Date</th>
                <th class="p-3 text-left text-xs font-bold text-slate-700">Status</th>
              </tr>
            </thead>
            <tbody>
              ${attendees.map(a => `
                <tr style="border-bottom: 1px solid #e2e8f0">
                  <td class="p-3 text-sm"><strong>${a.id}</strong></td>
                  <td class="p-3 text-sm">${a.name}</td>
                  <td class="p-3 text-sm text-slate-600">${a.email}</td>
                  <td class="p-3 text-sm text-slate-600">${a.registrationDate}</td>
                  <td class="p-3 text-sm"><span class="badge badge-${a.status === 'Registered' ? 'success' : 'warning'}">${a.status}</span></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
      
      modal.classList.remove('hidden');
    };

    window.deleteWorkshop = (id) => {
      const workshop = sampleData.workshops.find(w => w.id === id);
      if (!workshop) return;
      
      if(confirm(`Are you sure you want to delete "${workshop.title}"? This action cannot be undone.`)) {
        sampleData.workshops = sampleData.workshops.filter(w => w.id !== id);
        renderAdmin('workshops');
        
        // Show success notification
        const notification = document.createElement('div');
        notification.className = 'fixed top-4 right-4 bg-slate-600 text-white px-6 py-3 rounded-lg shadow-lg z-[9999] animate-pulse';
        notification.textContent = `✓ Workshop "${workshop.title}" deleted successfully!`;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
      }
    };

    window.openEditWorkshopModal = (id) => {
      const workshop = sampleData.workshops.find(w => w.id === id);
      if (!workshop) return;
      
      const modal = document.getElementById('editWorkshopModal');
      document.getElementById('editWsId').value = workshop.id;
      document.getElementById('editWsTitle').value = workshop.title;
      document.getElementById('editWsDate').value = workshop.date;
      document.getElementById('editWsTime').value = workshop.time;
      document.getElementById('editWsLocation').value = workshop.location;
      document.getElementById('editWsInstructor').value = workshop.instructor;
      document.getElementById('editWsCapacity').value = workshop.capacity;
      document.getElementById('editWsRegistered').value = workshop.registered;
      document.getElementById('editWsFee').value = workshop.fee;
      document.getElementById('editWsStatus').value = workshop.status;
      document.getElementById('editWsDescription').value = workshop.description;
      
      modal.classList.remove('hidden');
    };

    window.saveEditWorkshop = () => {
      const id = document.getElementById('editWsId').value;
      const title = document.getElementById('editWsTitle').value.trim();
      const date = document.getElementById('editWsDate').value;
      const time = document.getElementById('editWsTime').value;
      const location = document.getElementById('editWsLocation').value.trim();
      const instructor = document.getElementById('editWsInstructor').value.trim();
      const capacity = parseInt(document.getElementById('editWsCapacity').value);
      const registered = parseInt(document.getElementById('editWsRegistered').value);
      const fee = parseInt(document.getElementById('editWsFee').value);
      const status = document.getElementById('editWsStatus').value;
      const description = document.getElementById('editWsDescription').value.trim();

      // Validation
      if (!title || !date || !time || !location || !instructor || !capacity || isNaN(registered) || isNaN(fee) || !description) {
        alert('Please fill in all required fields');
        return;
      }

      if (registered > capacity) {
        alert('Registered count cannot exceed capacity');
        return;
      }

      // Find and update workshop
      const workshop = sampleData.workshops.find(w => w.id === id);
      if (workshop) {
        workshop.title = title;
        workshop.date = date;
        workshop.time = time;
        workshop.location = location;
        workshop.instructor = instructor;
        workshop.capacity = capacity;
        workshop.registered = registered;
        workshop.fee = fee;
        workshop.status = status;
        workshop.description = description;
      }

      document.getElementById('editWorkshopModal').classList.add('hidden');
      renderAdmin('workshops');
      
      // Show success notification
      const notification = document.createElement('div');
      notification.className = 'fixed top-4 right-4 bg-blue-500 text-white px-6 py-3 rounded-lg shadow-lg z-[9999] animate-pulse';
      notification.textContent = `✓ Workshop "${title}" updated successfully!`;
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), 3000);
    };

    // Search functionality
    setTimeout(() => {
      const searchInput = document.getElementById('workshopSearch');
      const tableBody = document.getElementById('workshopTableBody');
      
      if(searchInput && tableBody) {
        searchInput.addEventListener('input', (e) => {
          const term = e.target.value.toLowerCase();
          const rows = tableBody.getElementsByTagName('tr');
          
          Array.from(rows).forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(term) ? '' : 'none';
          });
        });
      }
    }, 100);
  }
  else if (key === 'settings') {
    area.innerHTML = `
      <div class="p-8">
      <div class="mb-8">
        <h2 class="text-3xl font-bold">System Settings</h2>
        <p class="text-slate-500">Manage security, network, and platform configurations</p>
      </div>
      
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Sidebar -->
        <div class="card p-0 overflow-hidden h-fit">
          <div class="bg-sozo-600 text-white p-4">
            <h3 class="font-bold">Configuration Menu</h3>
          </div>
          <div class="p-0">
            <button class="settings-tab w-full text-left px-4 py-3 border-b hover:bg-slate-50 active" data-tab="security">
              <i class="fa-solid fa-lock mr-2"></i> Security Settings
            </button>
            <button class="settings-tab w-full text-left px-4 py-3 border-b hover:bg-slate-50" data-tab="network">
              <i class="fa-solid fa-network-wired mr-2"></i> Network & Firewall
            </button>
            <button class="settings-tab w-full text-left px-4 py-3 border-b hover:bg-slate-50" data-tab="password">
              <i class="fa-solid fa-key mr-2"></i> Password Policy
            </button>
            <button class="settings-tab w-full text-left px-4 py-3 border-b hover:bg-slate-50" data-tab="backup">
              <i class="fa-solid fa-database mr-2"></i> Backup & Recovery
            </button>
            <button class="settings-tab w-full text-left px-4 py-3 border-b hover:bg-slate-50" data-tab="audit">
              <i class="fa-solid fa-scroll mr-2"></i> Audit Logs
            </button>
            <button class="settings-tab w-full text-left px-4 py-3 hover:bg-slate-50" data-tab="users">
              <i class="fa-solid fa-users-gear mr-2"></i> User Management
            </button>
          </div>
        </div>
        
        <!-- Main Content -->
        <div class="lg:col-span-2">
          <!-- Security Settings -->
          <div id="tab-security" class="settings-content card p-6">
            <h3 class="text-xl font-bold mb-6">Security Settings</h3>
            <div class="space-y-6">
              <div class="border-b pb-6">
                <h4 class="font-bold text-lg mb-3">Two-Factor Authentication</h4>
                <div class="flex items-center justify-between p-4 bg-orange-50 rounded-lg">
                  <div>
                    <p class="font-bold text-slate-900">Status: <span class="text-sozo-600">Enabled</span></p>
                    <p class="text-sm text-slate-600">All admin accounts require 2FA</p>
                  </div>
                  <button class="bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold">Manage</button>
                </div>
              </div>
              
              <div class="border-b pb-6">
                <h4 class="font-bold text-lg mb-3">SSL/TLS Certificates</h4>
                <div class="p-4 bg-blue-50 rounded-lg">
                  <p class="text-sm mb-2"><strong>Status:</strong> <span class="text-sozo-600">Valid</span></p>
                  <p class="text-sm mb-2"><strong>Domain:</strong> sozo-brain-center.com</p>
                  <p class="text-sm mb-4"><strong>Expires:</strong> 2025-12-31</p>
                  <button class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold">Renew Certificate</button>
                </div>
              </div>
              
              <div class="pb-6">
                <h4 class="font-bold text-lg mb-3">Session Timeout</h4>
                <div class="flex items-center gap-4">
                  <span>Inactivity Timeout (minutes):</span>
                  <input type="number" value="30" class="input-royal w-24">
                  <button class="bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold text-sm">Save</button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Network & Firewall -->
          <div id="tab-network" class="settings-content card p-6 hidden">
            <h3 class="text-xl font-bold mb-6">Network & Firewall Configuration</h3>
            <div class="space-y-6">
              <div class="border-b pb-6">
                <h4 class="font-bold text-lg mb-3">Firewall Rules</h4>
                <table class="w-full text-sm">
                  <thead><tr class="bg-slate-100"><th class="p-2 text-left">Rule</th><th class="p-2">Type</th><th class="p-2">Status</th><th class="p-2">Action</th></tr></thead>
                  <tbody>
                    <tr class="border-b"><td class="p-2">Allow HTTPS (443)</td><td>Inbound</td><td><span class="badge badge-success">Active</span></td><td><button class="text-slate-600 text-sm">Disable</button></td></tr>
                    <tr class="border-b"><td class="p-2">Allow HTTP (80)</td><td>Inbound</td><td><span class="badge badge-success">Active</span></td><td><button class="text-slate-600 text-sm">Disable</button></td></tr>
                    <tr class="border-b"><td class="p-2">Block Suspicious IPs</td><td>Inbound</td><td><span class="badge badge-success">Active</span></td><td><button class="text-blue-600 text-sm">Edit</button></td></tr>
                    <tr><td class="p-2">Rate Limiting</td><td>Inbound</td><td><span class="badge badge-warning">Configured</span></td><td><button class="text-blue-600 text-sm">Edit</button></td></tr>
                  </tbody>
                </table>
              </div>
              
              <div class="pb-6">
                <h4 class="font-bold text-lg mb-3">IP Whitelist/Blacklist</h4>
                <div class="p-4 bg-slate-50 rounded-lg">
                  <textarea class="input-royal mb-3" rows="4" placeholder="Enter IP addresses (one per line)"></textarea>
                  <button class="bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold">Update Whitelist</button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Password Policy -->
          <div id="tab-password" class="settings-content card p-6 hidden">
            <h3 class="text-xl font-bold mb-6">Password Policy</h3>
            <div class="space-y-6">
              <div class="border-b pb-6">
                <h4 class="font-bold text-lg mb-3">Requirements</h4>
                <div class="space-y-3">
                  <div class="flex items-center gap-3">
                    <input type="checkbox" checked> Minimum 8 characters
                  </div>
                  <div class="flex items-center gap-3">
                    <input type="checkbox" checked> Require uppercase letters
                  </div>
                  <div class="flex items-center gap-3">
                    <input type="checkbox" checked> Require numbers
                  </div>
                  <div class="flex items-center gap-3">
                    <input type="checkbox" checked> Require special characters (!@#$%^&*)
                  </div>
                  <div class="flex items-center gap-3">
                    <input type="checkbox" checked> Expire passwords every 90 days
                  </div>
                </div>
              </div>
              
              <div class="pb-6">
                <h4 class="font-bold text-lg mb-3">Account Lockout</h4>
                <div class="space-y-3 text-sm">
                  <div class="flex items-center gap-4">
                    <span>Failed attempts before lockout:</span>
                    <input type="number" value="5" class="input-royal w-24">
                  </div>
                  <div class="flex items-center gap-4">
                    <span>Lockout duration (minutes):</span>
                    <input type="number" value="30" class="input-royal w-24">
                  </div>
                  <button class="bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold mt-2">Save Policy</button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Backup & Recovery -->
          <div id="tab-backup" class="settings-content card p-6 hidden">
            <h3 class="text-xl font-bold mb-6">Backup & Recovery</h3>
            <div class="space-y-6">
              <div class="border-b pb-6">
                <h4 class="font-bold text-lg mb-3">Automatic Backups</h4>
                <div class="p-4 bg-orange-50 rounded-lg mb-4">
                  <p class="font-bold text-slate-900 mb-2">✓ Status: Active</p>
                  <p class="text-sm text-slate-700">Last backup: 2025-01-08 03:15 UTC</p>
                  <p class="text-sm text-slate-700">Next backup: 2025-01-09 03:15 UTC</p>
                </div>
                <div class="flex gap-2">
                  <button class="bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold text-sm">Backup Now</button>
                  <button class="bg-slate-200 text-slate-700 px-4 py-2 rounded-lg font-bold text-sm">View History</button>
                </div>
              </div>
              
              <div class="pb-6">
                <h4 class="font-bold text-lg mb-3">Backup Schedule</h4>
                <div class="space-y-3 text-sm">
                  <div class="flex items-center gap-4">
                    <span>Frequency:</span>
                    <select class="input-royal w-48">
                      <option>Daily</option>
                      <option>Twice Daily</option>
                      <option>Weekly</option>
                    </select>
                  </div>
                  <div class="flex items-center gap-4">
                    <span>Time:</span>
                    <input type="time" value="03:15" class="input-royal w-48">
                  </div>
                  <div class="flex items-center gap-4">
                    <span>Retention (days):</span>
                    <input type="number" value="30" class="input-royal w-24">
                  </div>
                  <button class="bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold mt-2">Save Schedule</button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Audit Logs -->
          <div id="tab-audit" class="settings-content card p-6 hidden">
            <h3 class="text-xl font-bold mb-6">Audit Logs</h3>
            <div class="max-h-64 overflow-y-auto">
              <table class="w-full text-sm">
                <thead><tr class="bg-slate-100 sticky top-0"><th class="p-2 text-left">Timestamp</th><th class="p-2">User</th><th class="p-2">Action</th><th class="p-2">Status</th></tr></thead>
                <tbody>
                  <tr class="border-b"><td class="p-2">2025-01-08 14:32</td><td>admin@sozo.de</td><td>Security settings changed</td><td><span class="badge badge-warning">Modified</span></td></tr>
                  <tr class="border-b"><td class="p-2">2025-01-08 10:15</td><td>admin@sozo.de</td><td>Backup completed successfully</td><td><span class="badge badge-success">Success</span></td></tr>
                  <tr class="border-b"><td class="p-2">2025-01-07 09:45</td><td>doctor@sozo.de</td><td>Patient record accessed</td><td><span class="badge badge-info">Access</span></td></tr>
                  <tr class="border-b"><td class="p-2">2025-01-07 08:20</td><td>user@sozo.de</td><td>Login failed (wrong password)</td><td><span class="badge badge-danger">Failed</span></td></tr>
                  <tr class="border-b"><td class="p-2">2025-01-06 16:50</td><td>admin@sozo.de</td><td>New user created: doctor2@sozo.de</td><td><span class="badge badge-success">Created</span></td></tr>
                  <tr><td class="p-2">2025-01-06 12:30</td><td>admin@sozo.de</td><td>System configuration updated</td><td><span class="badge badge-warning">Modified</span></td></tr>
                </tbody>
              </table>
            </div>
          </div>
          
          <!-- User Management -->
          <div id="tab-users" class="settings-content card p-6 hidden">
            <h3 class="text-xl font-bold mb-6">User Management</h3>
            <div class="mb-6">
              <button class="bg-sozo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-sozo-700 mb-4">+ Add New User</button>
            </div>
            <div class="max-h-64 overflow-y-auto">
              <table class="w-full text-sm">
                <thead><tr class="bg-slate-100 sticky top-0"><th class="p-2 text-left">Email</th><th class="p-2">Role</th><th class="p-2">Status</th><th class="p-2">2FA</th><th class="p-2">Actions</th></tr></thead>
                <tbody>
                  <tr class="border-b"><td class="p-2">admin@sozo.de</td><td>Admin</td><td><span class="badge badge-success">Active</span></td><td>✓</td><td><button class="text-blue-600 text-sm hover:underline">Edit</button></td></tr>
                  <tr class="border-b"><td class="p-2">doctor1@sozo.de</td><td>Doctor</td><td><span class="badge badge-success">Active</span></td><td>✓</td><td><button class="text-blue-600 text-sm hover:underline">Edit</button></td></tr>
                  <tr class="border-b"><td class="p-2">doctor2@sozo.de</td><td>Doctor</td><td><span class="badge badge-success">Active</span></td><td></td><td><button class="text-blue-600 text-sm hover:underline">Edit</button></td></tr>
                  <tr><td class="p-2">patient@sozo.de</td><td>Patient</td><td><span class="badge badge-success">Active</span></td><td></td><td><button class="text-blue-600 text-sm hover:underline">Edit</button></td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      </div>
    `;
    
    setTimeout(() => {
      document.querySelectorAll('.settings-tab').forEach(tab => {
        tab.addEventListener('click', function() {
          document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active', 'bg-sozo-50'));
          document.querySelectorAll('.settings-content').forEach(c => c.classList.add('hidden'));
          
          this.classList.add('active', 'bg-sozo-50');
          const tabId = 'tab-' + this.dataset.tab;
          document.getElementById(tabId).classList.remove('hidden');
        });
      });
    }, 50);
  }
}

// -- SHARED COMPONENTS --
function renderDevicesView() {
  const devices = [
    {name:'Sozo Ring', model:'SR-02', serial:'SR-2024-8891', status:'Connected', battery:'84%', lastSync:'2m ago'},
    {name:'Sozo Watch', model:'SW-01', serial:'SW-2024-5521', status:'Connected', battery:'76%', lastSync:'10m ago'},
    {name:'Neronika', model:'NX-10', serial:'NX-2024-3311', status:'Offline', battery:'--', lastSync:'1d ago'},
    {name:'Pluto', model:'PL-08', serial:'PL-2024-1199', status:'Connected', battery:'65%', lastSync:'45m ago'},
    {name:'Tvns', model:'TV-02', serial:'TV-2024-4422', status:'Offline', battery:'--', lastSync:'3d ago'},
    {name:'Gloves', model:'GL-05', serial:'GL-2024-7755', status:'Connected', battery:'92%', lastSync:'5m ago'}
  ];

  const prices = {
    'Sozo Ring': '$299',
    'Sozo Watch': '$349',
    'Neronika': '$450',
    'Pluto': '$199',
    'Tvns': '$150',
    'Gloves': '$179'
  };

  const area = document.getElementById('contentArea');
  area.innerHTML = `
    <div class="p-8">
    <div class="mb-6 flex items-center justify-between">
      <h2 class="text-2xl font-bold">Device Ecosystem</h2>
      <p class="text-sm text-slate-500">Click a device to manage connection</p>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="deviceGrid">
      ${devices.map((d, idx) => `
        <div class="card p-5 border-t-4 ${d.status==='Connected' ? 'border-t-sozo-500' : 'border-t-slate-400'} cursor-pointer hover:border-sozo-400" data-device-card="${idx}">
          <div class="flex justify-between mb-2">
            <h3 class="font-bold text-lg">${d.name}</h3>
            <span class="badge ${d.status==='Connected' ? 'badge-success' : 'badge-danger'} device-badge">${d.status}</span>
          </div>
          <p class="text-sm text-slate-600">Model: ${d.model} • Serial: ${d.serial}</p>
          <p class="text-xs text-slate-500">Battery: ${d.battery} • Last Sync: ${d.lastSync}</p>
        </div>
      `).join('')}
    </div>

    <div class="mt-8 card p-0 overflow-hidden">
      <div class="p-4 border-b border-slate-100 bg-slate-50"><h3 class="font-bold text-slate-800">Purchase History</h3></div>
      <table class="w-full">
        <thead><tr><th>Date</th><th>Device</th><th>Model</th><th>Price</th><th>Status</th></tr></thead>
        <tbody>
          ${devices.slice(0,6).map((d,i) => `
            <tr class="border-b"><td>2024-0${(i%6)+5}-15</td><td>${d.name}</td><td>${d.model}</td><td>${prices[d.name] || '$199'}</td><td><span class="badge badge-success">Delivered</span></td></tr>
          `).join('')}
        </tbody>
      </table>
    </div>

    <div id="deviceModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden items-center justify-center z-50">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6 relative">
        <button id="deviceModalClose" class="absolute top-3 right-3 text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark"></i></button>
        <div id="deviceModalBody"></div>
      </div>
    </div>
    </div>
  `;

  setTimeout(() => {
    const modal = document.getElementById('deviceModal');
    const modalBody = document.getElementById('deviceModalBody');
    const modalClose = document.getElementById('deviceModalClose');

    function openModal(idx) {
      const d = devices[idx];
      modalBody.innerHTML = `
        <div class="flex items-center justify-between mb-4">
          <div>
            <p class="text-xs uppercase text-slate-500 font-bold">Device</p>
            <h3 class="text-xl font-bold text-slate-900">${d.name}</h3>
            <p class="text-sm text-slate-600">Model ${d.model} • Serial ${d.serial}</p>
          </div>
          <span class="badge ${d.status==='Connected' ? 'badge-success' : 'badge-danger'}">${d.status}</span>
        </div>
        <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-100">
          <div>
            <p class="text-sm font-bold text-slate-800">Connection</p>
            <p class="text-xs text-slate-500">Toggle to connect or disconnect this device.</p>
          </div>
          <label class="inline-flex items-center gap-2 cursor-pointer">
            <input type="checkbox" id="deviceToggle" ${d.status==='Connected' ? 'checked' : ''} class="w-5 h-5 accent-sozo-600" />
            <span class="text-sm font-bold">${d.status==='Connected' ? 'Connected' : 'Disconnected'}</span>
          </label>
        </div>
      `;
      modal.classList.remove('hidden');

      const toggle = document.getElementById('deviceToggle');
      if(toggle) {
        toggle.addEventListener('change', () => {
          d.status = toggle.checked ? 'Connected' : 'Disconnected';
          const badge = document.querySelector(`[data-device-card="${idx}"] .device-badge`);
          if(badge) {
            badge.textContent = d.status;
            badge.className = `badge ${d.status==='Connected' ? 'badge-success' : 'badge-danger'} device-badge`;
          }
          const label = toggle.nextElementSibling;
          if(label) label.textContent = d.status;
        });
      }
    }

    document.querySelectorAll('[data-device-card]').forEach(card => {
      card.addEventListener('click', () => openModal(Number(card.dataset.deviceCard)));
    });

    modalClose.addEventListener('click', () => modal.classList.add('hidden'));
    modal.addEventListener('click', (e) => {
      if(e.target === modal) modal.classList.add('hidden');
    });
  }, 50);
}

function renderShopView() {
  const area = document.getElementById('contentArea');
  area.innerHTML = `
    <div class="p-8">
    <div class="mb-6 flex items-center justify-between">
      <div>
        <h2 class="text-2xl font-bold">Medical E-Shop</h2>
        <p class="text-slate-600 mt-1">Professional medical devices and equipment</p>
      </div>
      <button onclick="showCart()" class="btn-primary flex items-center gap-2">
        <i class="fa-solid fa-shopping-cart"></i>
        View Cart (<span id="cartCount">${globalState.cart.length}</span>)
      </button>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
      ${(sampleData.devices || sampleData.shop).map(item => `
        <div class="card p-5 flex flex-col h-full hover:shadow-xl transition">
          <div class="h-40 bg-gradient-to-br from-slate-50 to-slate-100 rounded-xl flex items-center justify-center mb-4 text-sozo-400 group-hover:text-sozo-600 transition">
            <i class="fa-solid ${item.icon || item.img} text-6xl"></i>
          </div>
          <h3 class="font-bold text-lg mb-2">${item.name}</h3>
          <p class="text-sm text-slate-500 mb-4 flex-1">${item.desc}</p>
          <div class="flex justify-between items-center mt-auto pt-4 border-t border-slate-100">
            <span class="font-bold text-2xl text-slate-900">$${item.price}</span>
            <button onclick="addToCart(${item.id || item.price}, '${item.name}', ${item.price})" class="bg-sozo-600 text-white px-4 py-2.5 rounded-lg text-sm font-bold hover:bg-sozo-700 transition">Add to Cart</button>
          </div>
        </div>
      `).join('')}
    </div>
    </div>
  `;
}

// Shopping Cart Functions
function addToCart(id, name, price) {
  globalState.cart.push({ id, name, price });
  const cartCount = document.getElementById('cartCount');
  if (cartCount) cartCount.textContent = globalState.cart.length;
  
  // Show notification
  const notification = document.createElement('div');
  notification.className = 'fixed top-4 right-4 bg-sozo-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
  notification.innerHTML = `<i class="fa-solid fa-check-circle mr-2"></i> Added to cart!`;
  document.body.appendChild(notification);
  setTimeout(() => notification.remove(), 2000);
}

function showCart() {
  if (globalState.cart.length === 0) {
    alert('Your cart is empty!');
    return;
  }
  
  const total = globalState.cart.reduce((sum, item) => sum + item.price, 0);
  const items = globalState.cart.map((item, i) => `${i + 1}. ${item.name} - $${item.price}`).join('\n');
  
  if (confirm(`Shopping Cart (${globalState.cart.length} items)\n\n${items}\n\nTotal: $${total}\n\nProceed to checkout?`)) {
    alert('Proceeding to secure payment page... (Demo)');
    globalState.cart = [];
    const cartCount = document.getElementById('cartCount');
    if (cartCount) cartCount.textContent = '0';
  }
}

// Mock upload handler
function handleFileUpload(file, doctorId) {
  return new Promise((resolve, reject) => {
    setTimeout(() => {
      if(!file) return reject(new Error('No file'));
      resolve({ ok:true, doctorId, fileName:file.name });
    }, 500);
  });
}

// Scoring helper for FNON Section A
function calculateSectionScore(answers, totalQuestions) {
  const maxRaw = totalQuestions * 2; // 0-2 per question
  const raw = answers.reduce((sum, val) => sum + Number(val || 0), 0);
  if(maxRaw === 0) return 0;
  const normalized = (raw / maxRaw) * 10;
  return Math.round(normalized * 10) / 10; // one decimal place
}

// -- GLOBAL UTILS --
function switchLoginView(view) {
  document.getElementById('loginViewLogin').style.display = view === 'login' ? 'block' : 'none';
  document.getElementById('loginViewRegister').style.display = view === 'register' ? 'block' : 'none';
  if(view === 'register') {
    document.getElementById('registerForm').reset();
  } else {
    document.getElementById('loginForm').reset();
  }
}

function downloadReportAsPDF() {
  // Get the report container
  const reportElement = document.getElementById('finalReportContent');
  if (!reportElement) {
    alert('Report content not found');
    return;
  }

  // Get patient info for filename
  const p = getActivePatient();
  const patientName = p ? p.name.replace(/\s+/g, '_') : 'Patient';
  const date = new Date().toISOString().slice(0, 10);
  const filename = `${patientName}_Assessment_Report_${date}.pdf`;

  // PDF options
  const opt = {
    margin: [10, 10, 10, 10],
    filename: filename,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true, letterRendering: true },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
  };

  // Generate and download PDF
  html2pdf().set(opt).from(reportElement).save();
}

function downloadBrainMappingPDF() {
  // Get the brain mapping container
  const brainElement = document.getElementById('brainMappingContent');
  if (!brainElement) {
    alert('Brain mapping content not found');
    return;
  }

  // Get patient info for filename
  const p = getActivePatient();
  const patientName = p ? p.name.replace(/\s+/g, '_') : 'Patient';
  const date = new Date().toISOString().slice(0, 10);
  const filename = `${patientName}_Brain_Mapping_${date}.pdf`;

  // PDF options
  const opt = {
    margin: [10, 10, 10, 10],
    filename: filename,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true, letterRendering: true },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
  };

  // Generate and download PDF
  html2pdf().set(opt).from(brainElement).save();
}

window.autoFill = function(role) {
  const usernameField = document.getElementById('loginUsername');
  const passwordField = document.getElementById('loginPassword');
  
  if (!usernameField || !passwordField) {
    console.error('Login fields not found');
    return;
  }
  
  if(role === 'admin') {
    usernameField.value = 'admin@sozobrain.com';
    passwordField.value = 'admin123';
  } else if(role === 'doctor') {
    usernameField.value = 'doctor@sozobrain.com';
    passwordField.value = 'doctor123';
  } else if(role === 'receptionist') {
    usernameField.value = 'receptionist@sozobrain.com';
    passwordField.value = 'receptionist123';
  } else if(role === 'patient') {
    usernameField.value = 'patient@sozobrain.com';
    passwordField.value = 'patient123';
  }
  
  // Optional: Add visual feedback
  usernameField.focus();
  passwordField.focus();
  usernameField.focus();
}

function initSozoApp() {
  console.log('=== Sozo Brain App Loading ===');
  console.log('Demo Users:', users);
  loadFnonState();
  
  // Try to restore previous session from localStorage
  const sessionRestored = autoRestoreSession();
  
  if (sessionRestored && currentUser && currentRole) {
    console.log('✓ Auto-restoring session for:', currentUser.name, '(' + currentRole + ')');
    
    // Restore selected visit for patients
    if (currentRole === 'patient') {
      selectedVisit = loadFromLocalStorage('sozo_selected_visit');
      console.log('✓ Restored visit:', selectedVisit);
    }
    
    // Auto-login: Skip login page and go to main app (or visit selection for patients without visit)
    const loginPage = document.getElementById('loginPage');
    const visitSelectionPage = document.getElementById('visitSelectionPage');
    const mainApp = document.getElementById('mainApp');
    
    if (loginPage && mainApp) {
      loginPage.style.display = 'none';
      
      // For patients without selected visit, show visit selection
      if (currentRole === 'patient' && !selectedVisit) {
        if(visitSelectionPage) {
          visitSelectionPage.style.display = 'flex';
          const welcomeEl = document.getElementById('visitSelectionWelcome');
          if(welcomeEl) welcomeEl.textContent = `Welcome back ${currentUser.name}, please select your visit stage to continue`;
        }
        console.log('✓ Patient session restored - showing visit selection');
        return;
      }
      
      mainApp.style.display = 'block';
      
      // Setup UI for restored session
      const sidebarName = document.getElementById('sidebarName');
      const sidebarRole = document.getElementById('sidebarRole');
      const sidebarAvatar = document.getElementById('sidebarAvatar');
      
      if(sidebarName) sidebarName.innerText = currentUser.name;
      if(sidebarRole) sidebarRole.innerText = currentRole.toUpperCase();
      if(sidebarAvatar) {
        sidebarAvatar.innerHTML = '<i class="fa-solid fa-user text-white text-2xl"></i>';
      }
      
      // Render sidebar and load home
      renderSidebar();
      loadSection('home');
      
      // Auto-select doctor if role is doctor
      if(currentRole === 'doctor') {
        selectedDoctor = {
          id: currentUser.id || 'DOC-001',
          name: currentUser.name,
          email: currentUser.email
        };
        globalState.currentDoctor = {
          id: currentUser.id || 'DOC-001',
          name: currentUser.name,
          email: currentUser.email,
          clinic: currentUser.clinic || 'SOZO Brain Center'
        };
      }
      
      console.log('✓ Session restored and UI initialized');
    }
  }
  
  const loginForm = document.getElementById('loginForm');
  const registerForm = document.getElementById('registerForm');
  
  console.log('Login form found:', !!loginForm);
  console.log('Register form found:', !!registerForm);
  
  if(loginForm) {
    loginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      console.log('=== Login Form Submitted ===');
      try {
        const email = document.getElementById('loginUsername').value.trim();
        const password = document.getElementById('loginPassword').value;
        const loginErrEl = document.getElementById('loginError');
        if (loginErrEl) loginErrEl.textContent = '';
        
        console.log('Attempting login with email:', email);
        
        if(!email || !password) {
          alert('Please enter both email and password');
          return;
        }
        
        const allUsers = getAllUsers();
        console.log('All available users:', Object.keys(allUsers));
        
        let foundUser = null;
        
        // Check demo users by email
        for(let key in users) {
          console.log('Checking demo user:', key, 'email match:', users[key].email === email, 'password match:', users[key].password === password);
          if(users[key].email === email && users[key].password === password) {
            foundUser = users[key];
            console.log('Found demo user:', foundUser.name);
            break;
          }
        }
        
        // Check registered users by email
        if(!foundUser) {
          for(let key in allUsers) {
            if(key === email && allUsers[key].password === password) {
              foundUser = allUsers[key];
              console.log('Found registered user:', foundUser.name);
              break;
            }
          }
        }
        
        if(foundUser) {
          console.log('Login successful for:', foundUser.name, 'Role:', foundUser.role);
          currentUser = foundUser;
          currentRole = foundUser.role;
          
          // Save user session to localStorage
          saveUserSession(foundUser, foundUser.role);
          
          // Auto-select doctor if role is doctor
          if(currentRole === 'doctor') {
            selectedDoctor = {
              id: foundUser.id || 'DOC-001',
              name: foundUser.name,
              email: foundUser.email
            };
            globalState.currentDoctor = {
              id: foundUser.id || 'DOC-001',
              name: foundUser.name,
              email: foundUser.email,
              clinic: foundUser.clinic || 'SOZO Brain Center'
            };
            console.log('Doctor auto-selected:', selectedDoctor);
          }
          
          // Header and Sidebar Setup
          const sidebarName = document.getElementById('sidebarName');
          const sidebarRole = document.getElementById('sidebarRole');
          const sidebarAvatar = document.getElementById('sidebarAvatar');
          
          if(sidebarName) sidebarName.innerText = currentUser.name;
          if(sidebarRole) sidebarRole.innerText = currentUser.role.toUpperCase();
          if(sidebarAvatar) sidebarAvatar.innerHTML = '<i class="fa-solid fa-user text-white text-2xl"></i>';
  
          // Transition
          const loginPage = document.getElementById('loginPage');
          const visitSelectionPage = document.getElementById('visitSelectionPage');
          const mainApp = document.getElementById('mainApp');
          console.log('Login page:', !!loginPage, 'Main app:', !!mainApp);
          
          // For patients, show visit selection page first
          if(currentRole === 'patient') {
            if(loginPage) { loginPage.style.display = 'none'; loginPage.classList.add('hidden'); }
            if(visitSelectionPage) { 
              visitSelectionPage.style.display = 'flex'; 
              visitSelectionPage.classList.remove('hidden'); 
              // Update welcome message
              const welcomeEl = document.getElementById('visitSelectionWelcome');
              if(welcomeEl) welcomeEl.textContent = `Welcome ${currentUser.name}, please select your visit stage to continue`;
            }
            console.log('✓ Patient login - showing visit selection page');
          } else {
            // For non-patients, go directly to main app
            if(loginPage) { loginPage.style.display = 'none'; loginPage.classList.add('hidden'); }
            if(mainApp) { mainApp.style.display = 'flex'; mainApp.classList.remove('hidden'); }
            
            // Render sidebar with error handling
            setTimeout(() => {
              try {
                console.log('Rendering sidebar for role:', currentRole);
                renderSidebar();
              } catch(err) {
                console.error('Sidebar render error:', err);
                alert('Error loading interface. Please refresh the page.');
              }
            }, 50);
          }
        } else {
          console.log('Login failed: User not found');
          if (loginErrEl) loginErrEl.textContent = 'Invalid email or password. Please try again.';
          else alert('Invalid email or password. Please try again.');
        }
      } catch(err) {
        console.error('Login error:', err);
        const loginErrEl = document.getElementById('loginError');
        if (loginErrEl) loginErrEl.textContent = 'Login failed: ' + (err.message || 'Unexpected error');
        else alert('Login failed: ' + err.message);
      }
    });
  }
  
  if(registerForm) {
    registerForm.addEventListener('submit', (e) => {
      e.preventDefault();
      console.log('=== Registration Form Submitted ===');
      try {
        const firstName = document.getElementById('regFirstName').value.trim();
        const lastName = document.getElementById('regLastName').value.trim();
        const email = document.getElementById('regEmail').value.trim();
        const password = document.getElementById('regPassword').value;
        const country = document.getElementById('regCountry').value;
        const role = document.getElementById('regRole').value;
        const mobile = document.getElementById('regMobile').value.trim();
        
        console.log('Registration data:', {firstName, lastName, email, country, role, mobile});
        
        if(!firstName || !lastName || !email || !password || !country || !role || !mobile) {
          alert('Please fill all fields');
          return;
        }
        
        if(password.length < 6) {
          alert('Password must be at least 6 characters');
          return;
        }
        
        if(registerNewUser(firstName, lastName, email, password, country, role, mobile)) {
          console.log('Registration successful');
          alert('Registration successful! Please login with your email and password.');
          switchLoginView('login');
          document.getElementById('loginUsername').value = email;
          document.getElementById('loginPassword').value = '';
          document.getElementById('loginPassword').focus();
        }
      } catch(err) {
        console.error('Registration error:', err);
        alert('Registration failed: ' + err.message);
      }
    });
  }
  
  console.log('=== App Ready ===');
}

// Ensure init runs even if DOMContentLoaded already fired
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initSozoApp);
} else {
  initSozoApp();
}

function handleLogout() {
  if(confirm('Are you sure you want to logout?')) {
    // Clear user session and localStorage
    logoutUser();
    
    // Reset UI
    globalSelectedPatientId = null;
    document.getElementById('mainApp').style.display = 'none';
    document.getElementById('loginPage').style.display = 'flex';
    document.getElementById('loginForm').reset();
    
    console.log('✓ User logged out successfully');
  }
}

// Device Usage Chart Generation
window.generateDeviceChart = function() {
  const userType = document.getElementById('analyticsUserType').value;
  const timePeriod = document.getElementById('analyticsTimePeriod').value;
  
  // Device data structure
  const devices = [
    { name: 'Neuro Headset Pro', color: '#2563eb' },
    { name: 'Bio-Sensor Kit', color: '#16a34a' },
    { name: 'Sleep Tracker Elite', color: '#9333ea' },
    { name: 'Sozo Ring', color: '#ea580c' },
    { name: 'Pulse Monitor', color: '#dc2626' },
    { name: 'Brain Stim Device', color: '#4f46e5' }
  ];

  // Sample data based on user type and time period
  const generateData = (period, type) => {
    const baseValues = {
      doctor: [45, 52, 48, 55, 60, 58, 65, 70, 68, 72, 75, 80],
      patient: [120, 135, 128, 145, 155, 160, 175, 185, 190, 200, 210, 220]
    };
    
    const deviceFactors = [1.0, 1.2, 0.9, 1.1, 0.85, 1.3];
    
    return devices.map((device, idx) => ({
      label: device.name,
      data: baseValues[type].map(v => Math.round(v * deviceFactors[idx] * (0.8 + Math.random() * 0.4))),
      borderColor: device.color,
      backgroundColor: device.color + '20',
      borderWidth: 2,
      tension: 0.4,
      fill: true
    }));
  };

  // Generate labels based on time period
  const generateLabels = (period) => {
    const labelSets = {
      day: ['12 AM', '2 AM', '4 AM', '6 AM', '8 AM', '10 AM', '12 PM', '2 PM', '4 PM', '6 PM', '8 PM', '10 PM'],
      week: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri'],
      month: ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 1', 'Week 2', 'Week 3', 'Week 4'],
      'half-year': ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
      year: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']
    };
    return labelSets[period] || labelSets.week;
  };

  const ctx = document.getElementById('deviceUsageChart');
  
  // Destroy existing chart if it exists
  if (window.deviceChartInstance) {
    window.deviceChartInstance.destroy();
  }

  // Create new chart
  window.deviceChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: generateLabels(timePeriod),
      datasets: generateData(timePeriod, userType)
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            boxWidth: 12,
            font: { size: 12 },
            padding: 15,
            usePointStyle: true
          }
        },
        title: {
          display: true,
          text: `Device ${userType === 'doctor' ? 'Doctor' : 'Patient'} Usage - ${timePeriod.charAt(0).toUpperCase() + timePeriod.slice(1)}`,
          font: { size: 14, weight: 'bold' }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Usage Count'
          },
          ticks: {
            stepSize: 20
          }
        },
        x: {
          title: {
            display: true,
            text: timePeriod === 'day' ? 'Time' : 'Period'
          }
        }
      },
      interaction: {
        mode: 'index',
        intersect: false
      }
    }
  });
};

// Initialize chart on page load
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(() => {
    if(document.getElementById('deviceUsageChart')) {
      window.generateDeviceChart();
    }
  }, 500);
});

</script>
</body>
</html>