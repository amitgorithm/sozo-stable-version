<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOZO Clinical Journey - Sozo Clinical Operating System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --orange-primary: rgb(244, 121, 32);
            --blue-primary: rgb(0, 161, 228);
            --dark-bg: #0f172a;
            --light-bg: #f8f9fa;
            --slate-border: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--light-bg);
            color: #1e293b;
        }

        .container-journey {
            padding: 24px;
            width: 85%;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* ASSESSMENT SECTION */
        .assessment-section {
            margin-bottom: 24px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .assessment-section.expanded {
            border-color: var(--orange-primary);
        }

        .assessment-section.locked {
            opacity: 0.7;
        }

        .assessment-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .assessment-header:hover:not(.locked) {
            background: rgba(244, 121, 32, 0.05);
        }

        .assessment-header.locked {
            cursor: not-allowed;
        }

        .assessment-title {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .assessment-title h2 {
            font-size: 20px;
            font-weight: 700;
            color: #0f172a;
        }

        .expand-icon {
            font-size: 18px;
            color: #64748b;
            transition: transform 0.3s ease;
            margin-left: 12px;
        }

        .assessment-section.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .assessment-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .assessment-badge.completed {
            background: rgba(244, 121, 32, 0.15);
            color: var(--orange-primary);
        }

        .assessment-badge.active {
            background: rgba(0, 161, 228, 0.15);
            color: var(--blue-primary);
        }

        .assessment-meta {
            font-size: 12px;
            color: #64748b;
            display: flex;
            gap: 16px;
            margin-top: 8px;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .assessment-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
        }

        .assessment-section.expanded .assessment-content {
            max-height: 2000px;
        }

        .assessment-content-inner {
            padding: 0 20px 20px 20px;
        }

        .progress-bar {
            height: 4px;
            background: #e5e7eb;
            margin-top: 12px;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--orange-primary), #dc6027);
            transition: width 0.3s ease;
        }

        /* BLOCKS HORIZONTAL GRID */
        .blocks-container {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 16px;
            position: relative;
            overflow: visible;
            align-items: start;
        }

        .block-card {
            background: white;
            border-radius: 12px;
            border: 1px solid var(--slate-border);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            overflow: visible;
            min-height: fit-content;
            align-self: start;
            height: auto;
        }

        .block-card.expanded {
            overflow: visible;
            padding-bottom: 24px;
            z-index: 1;
            position: relative;
            min-height: fit-content;
            word-wrap: break-word;
            box-sizing: border-box;
        }

        .block-card.expanded:hover {
            z-index: 10;
        }

        .block-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: transparent;
            transition: all 0.3s ease;
        }

        .block-card:hover {
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            transform: translateY(-4px);
        }

        /* STATE-BASED COLORS */
        .block-card.completed::before {
            background: var(--orange-primary);
        }

        .block-card.pending::before {
            background: var(--blue-primary);
        }

        .block-card.active::before {
            background: #10b981;
        }

        .block-card.locked::before {
            background: #cbd5e1;
        }

        /* ICON CIRCLE */
        .block-icon {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin-bottom: 12px;
            flex-shrink: 0;
        }

        /* STATE-BASED ICON COLORS */
        .block-card.completed .block-icon {
            background: rgba(244, 121, 32, 0.15);
            color: var(--orange-primary);
        }

        .block-card.pending .block-icon {
            background: rgba(0, 161, 228, 0.15);
            color: var(--blue-primary);
        }

        .block-card.active .block-icon {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
        }

        .block-card.locked .block-icon {
            background: rgba(203, 213, 225, 0.3);
            color: #cbd5e1;
        }

        /* BLOCK TITLE & SUBTITLE */
        .block-name {
            font-size: 14px;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 4px;
        }

        .block-desc {
            font-size: 12px;
            color: #64748b;
            line-height: 1.4;
        }

        /* STATUS OVERLAY */
        .block-status {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 4px 10px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            font-weight: 700;
            background: white;
            border: 1.5px solid var(--slate-border);
        }

        .block-status-icon {
            font-size: 12px;
        }

        .block-status-text {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .block-card.completed .block-status {
            background: rgba(244, 121, 32, 0.15);
            color: var(--orange-primary);
            border-color: var(--orange-primary);
        }

        .block-card.pending .block-status {
            background: rgba(0, 161, 228, 0.15);
            color: var(--blue-primary);
            border-color: var(--blue-primary);
        }

        .block-card.active .block-status {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
            border-color: #10b981;
            animation: pulse 2s infinite;
        }

        .block-card.locked .block-status {
            background: rgba(148, 163, 184, 0.15);
            color: #64748b;
            border-color: #94a3b8;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }
        }

        /* SESSIONS ROW */
        .sessions-row {
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--slate-border);
        }

        .sessions-title {
            font-size: 12px;
            font-weight: 700;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        .sessions-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }

        /* SESSION BOX CARD */
        .session-box {
            background: white;
            border: 1px solid var(--slate-border);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .session-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: transparent;
            transition: all 0.3s ease;
        }

        .session-box.completed::before {
            background: var(--orange-primary);
        }

        .session-box.pending::before {
            background: var(--blue-primary);
        }

        .session-box.active::before {
            background: #10b981;
        }

        .session-box.disabled::before {
            background: #cbd5e1;
        }

        .session-box:hover:not(.disabled) {
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            transform: translateY(-4px);
        }

        /* SESSION ICON */
        .session-icon {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 12px;
            flex-shrink: 0;
        }

        .session-box.completed .session-icon {
            background: rgba(244, 121, 32, 0.15);
            color: var(--orange-primary);
        }

        .session-box.pending .session-icon {
            background: rgba(0, 161, 228, 0.15);
            color: var(--blue-primary);
        }

        .session-box.disabled .session-icon {
            background: rgba(203, 213, 225, 0.3);
            color: #cbd5e1;
            opacity: 0.6;
        }

        .session-box.active .session-icon {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
            animation: subtle-pulse 2s infinite;
        }

        @keyframes subtle-pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        /* SESSION HEADER */
        .session-header {
            font-size: 14px;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 8px;
        }

        /* SESSION STATUS BADGE */
        .session-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            font-weight: 700;
            padding: 6px 12px;
            border-radius: 12px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .session-status-icon {
            font-size: 12px;
        }

        .session-box.completed .session-status-badge {
            background: rgba(244, 121, 32, 0.15);
            color: var(--orange-primary);
            border: 1.5px solid var(--orange-primary);
        }

        .session-box.pending .session-status-badge {
            background: rgba(0, 161, 228, 0.15);
            color: var(--blue-primary);
            border: 1.5px solid var(--blue-primary);
        }

        .session-box.active .session-status-badge {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
            border: 1.5px solid #10b981;
        }

        .session-box.disabled .session-status-badge {
            background: rgba(148, 163, 184, 0.15);
            color: #64748b;
            border: 1.5px solid #94a3b8;
        }

        /* SESSION INFO */
        .session-info {
            font-size: 11px;
            color: #64748b;
            line-height: 1.6;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .session-info-item {
            margin: 4px 0;
        }

        .session-info-label {
            font-weight: 600;
            color: #475569;
        }

        .session-info-value {
            color: #64748b;
            font-size: 10px;
        }

        /* PAGE HEADER */
        .page-header {
            margin-bottom: 32px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--slate-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .page-header-left {
            flex: 1;
        }

        .page-header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 6px;
        }

        .page-subtitle {
            font-size: 14px;
            color: #64748b;
        }

        /* IMPROVEMENTS BUTTON */
        .improvements-section {
            margin-top: 32px;
            padding: 24px;
            background: white;
            border-radius: 12px;
            border: 2px solid var(--slate-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .improvements-text h3 {
            font-size: 16px;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 4px;
        }

        .improvements-text p {
            font-size: 13px;
            color: #64748b;
        }

        .improvements-btn {
            background: linear-gradient(135deg, var(--orange-primary) 0%, rgb(202, 65, 12) 100%);
            color: white;
            border: none;
            padding: 12px 28px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .improvements-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(244, 121, 32, 0.3);
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* TABS */
        .tabs-container {
            background: white;
            border-radius: 12px;
            padding: 8px;
            margin-bottom: 24px;
            display: flex;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .tab-button {
            flex: 1;
            padding: 12px 24px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-button:hover {
            background: rgba(244, 121, 32, 0.1);
            color: var(--orange-primary);
        }

        .tab-button.active {
            background: var(--orange-primary);
            color: white;
            box-shadow: 0 2px 8px rgba(244, 121, 32, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ROLE DISPLAY BANNER */
        .role-display-banner {
            background: linear-gradient(135deg, #f8fafc, #ffffff);
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px 32px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .role-display-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .role-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
        }

        .role-icon.doctor,
        .role-icon.clinical-assistant,
        .role-icon.patient,
        .role-icon.receptionist {
            background: linear-gradient(135deg, var(--orange-primary), #dc6027);
        }

        .role-info h3 {
            font-size: 18px;
            font-weight: 700;
            color: #0f172a;
            margin: 0 0 4px 0;
        }

        .role-info p {
            font-size: 13px;
            color: #64748b;
            margin: 0;
        }

        .role-badge {
            padding: 8px 20px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .role-badge.doctor,
        .role-badge.clinical-assistant,
        .role-badge.patient,
        .role-badge.receptionist {
            background: rgba(244, 121, 32, 0.1);
            color: #dc6027;
        }

        /* ROLE SELECTOR */
        .role-selector-container {
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .role-label {
            font-size: 14px;
            font-weight: 600;
            color: #64748b;
        }

        .role-select {
            padding: 8px 16px;
            border: 2px solid var(--slate-border);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #0f172a;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .role-select:hover {
            border-color: var(--orange-primary);
        }

        .role-select:focus {
            outline: none;
            border-color: var(--orange-primary);
            box-shadow: 0 0 0 3px rgba(244, 121, 32, 0.1);
        }

        /* PATIENT NAVIGATION BUTTONS */
        .patient-navigation {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-button {
            padding: 8px 16px;
            border: 2px solid #e2e8f0;
            background: white;
            color: #0f172a;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .nav-button:hover:not(:disabled) {
            border-color: var(--orange-primary);
            background: rgba(244, 121, 32, 0.05);
            color: var(--orange-primary);
        }

        .nav-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .patient-counter {
            padding: 6px 12px;
            background: #f1f5f9;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
        }

        /* TODAY'S VIEW */
        .today-header {
            background: rgba(244, 121, 32, 0.1);
            border: 2px solid rgba(244, 121, 32, 0.3);
            color: #0f172a;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .today-header h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #0f172a;
        }

        .today-header p {
            font-size: 14px;
            color: #64748b;
        }

        .today-blocks-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .today-blocks-section h3 {
            font-size: 18px;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 16px;
        }

        .block-expanded-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, opacity 0.3s ease;
            margin-top: 16px;
            opacity: 0;
            width: 100%;
            position: relative;
            padding: 0;
            box-sizing: border-box;
        }

        .block-card.expanded .block-expanded-details {
            max-height: 1000px;
            overflow: visible;
            opacity: 1;
            padding: 8px 12px 16px 12px;
            margin-bottom: 8px;
            width: calc(100% - 24px);
            margin-left: auto;
            margin-right: auto;
        }

        /* Always show details for pending and locked blocks */
        .block-card.pending .block-expanded-details,
        .block-card.locked .block-expanded-details {
            max-height: 1000px;
            overflow: visible;
            opacity: 1;
            padding: 8px 12px 16px 12px;
            margin-bottom: 8px;
            width: calc(100% - 24px);
            margin-left: auto;
            margin-right: auto;
        }

        .block-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 10px;
            background: #f8fafc;
            padding: 14px;
            border-radius: 8px;
            position: relative;
            z-index: 1;
            margin: 0;
            width: 100%;
            box-sizing: border-box;
            overflow: hidden;
            word-wrap: break-word;
        }

        .block-info-item {
            display: flex;
            flex-direction: column;
            min-width: 0;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            text-align: left;
            align-items: flex-start;
            justify-content: flex-start;
        }

        .block-info-label {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            color: #64748b;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
            line-height: 1.2;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .block-info-value {
            font-size: 12px;
            font-weight: 700;
            color: #0f172a;
            line-height: 1.3;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            white-space: normal;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .action-button {
            padding: 10px 20px;
            border-radius: 8px;
            border: 2px solid var(--slate-border);
            background: white;
            font-size: 13px;
            font-weight: 600;
            color: #0f172a;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .action-button:hover {
            border-color: var(--orange-primary);
            color: var(--orange-primary);
        }

        .action-button.primary {
            background: var(--orange-primary);
            border-color: var(--orange-primary);
            color: white;
        }

        .action-button.primary:hover {
            background: #dc6027;
            transform: translateY(-1px);
        }

        .activity-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
            position: relative;
            z-index: 100;
            width: 100%;
            box-sizing: border-box;
            padding: 0;
            justify-content: flex-start;
            align-items: flex-start;
            overflow: visible;
        }

        .activity-tag {
            padding: 6px 10px;
            background: rgba(0, 161, 228, 0.15);
            color: #0369a1;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 101;
            white-space: nowrap;
            overflow: visible;
            text-overflow: ellipsis;
            max-width: 120px;
            text-align: center;
            box-sizing: border-box;
        }

        .activity-tag:hover {
            background: rgba(0, 161, 228, 0.25);
            transform: translateY(-2px);
            z-index: 99999;
            overflow: visible;
        }

        .activity-tag-image {
            display: none;
            position: absolute;
            bottom: calc(100% + 12px);
            left: 50%;
            transform: translateX(-50%);
            z-index: 100000;
            width: 250px;
            height: auto;
            max-height: 250px;
            border-radius: 12px;
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.4);
            border: 4px solid white;
            pointer-events: none;
            background: white;
            object-fit: contain;
        }

        .activity-tag:hover .activity-tag-image {
            display: block;
        }

        .detail-section {
            margin-top: 12px;
            position: relative;
            z-index: 50;
            overflow: visible;
            padding: 0;
            width: 100%;
            box-sizing: border-box;
            word-wrap: break-word;
        }

        .detail-section-title {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            color: #64748b;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .block-action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            width: 100%;
            flex-wrap: wrap;
            box-sizing: border-box;
            padding: 0;
            justify-content: center;
            align-items: center;
        }

        /* Single button - centered and full width */
        .block-action-buttons:has(:only-child) {
            justify-content: center;
        }

        .block-action-buttons:has(:only-child) .block-action-btn {
            min-width: 140px;
            max-width: 180px;
        }

        /* Two buttons - side by side */
        .block-action-buttons:has(:nth-child(2):last-child) {
            justify-content: center;
            gap: 10px;
        }

        .block-action-buttons:has(:nth-child(2):last-child) .block-action-btn {
            flex: 1;
            max-width: 120px;
        }

        /* Three or more buttons - flexible grid */
        .block-action-buttons:has(:nth-child(3)) {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 8px;
        }

        .block-action-btn {
            padding: 10px 16px;
            border-radius: 6px;
            border: 2px solid;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            position: relative;
            z-index: 10;
            pointer-events: auto;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            box-sizing: border-box;
            text-align: center;
        }

        .block-action-btn.view {
            background: white;
            border-color: var(--blue-primary);
            color: var(--blue-primary);
        }

        .block-action-btn.view:hover {
            background: var(--blue-primary);
            color: white;
        }

        .block-action-btn.edit {
            background: var(--orange-primary);
            border-color: var(--orange-primary);
            color: white;
        }

        .block-action-btn.edit:hover {
            background: #dc6027;
            transform: translateY(-1px);
        }

        .block-action-btn.disabled {
            background: #e2e8f0;
            border-color: #cbd5e1;
            color: #94a3b8;
            cursor: not-allowed;
        }

        .block-action-btn.start {
            background: var(--orange-primary);
            border-color: var(--orange-primary);
            color: white;
        }

        .block-action-btn.start:hover {
            background: #dc6027;
            transform: translateY(-1px);
        }

        .accordion-indicator {
            position: absolute;
            bottom: 8px;
            right: 12px;
            font-size: 12px;
            color: #94a3b8;
            transition: transform 0.3s ease;
            z-index: 1;
            pointer-events: none;
        }

        .block-card.expanded .accordion-indicator {
            transform: rotate(180deg);
            bottom: 12px;
        }

        .next-up-banner {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 16px 20px;
            border-radius: 8px;
            margin-top: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .next-up-icon {
            font-size: 24px;
        }

        .next-up-text {
            flex: 1;
        }

        .next-up-text strong {
            display: block;
            font-size: 14px;
            color: #78350f;
            margin-bottom: 4px;
        }

        .next-up-text span {
            font-size: 13px;
            color: #92400e;
        }

        /* WORKING JOURNEY STYLES */
        .patient-info-banner {
            background: rgba(244, 121, 32, 0.1);
            border: 2px solid rgba(244, 121, 32, 0.3);
            color: #0f172a;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .patient-info-banner h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #0f172a;
        }

        .patient-info-banner p {
            font-size: 14px;
            color: #64748b;
        }

        .patient-meta {
            display: flex;
            gap: 24px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .patient-meta-item {
            display: flex;
            flex-direction: column;
        }

        .patient-meta-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: #64748b;
            letter-spacing: 0.5px;
        }

        .patient-meta-value {
            font-size: 14px;
            font-weight: 700;
            color: #0f172a;
            margin-top: 4px;
        }

        .block-card.can-start {
            cursor: pointer;
            border-color: rgba(244, 121, 32, 0.3);
        }

        .block-card.can-start:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
            border-color: var(--orange-primary);
        }

        .block-status.ready {
            background: rgba(16, 185, 129, 0.15);
            color: var(--green-primary);
            border: 1.5px solid #10b981;
        }

        .block-status.view-only {
            background: rgba(0, 161, 228, 0.15);
            color: var(--blue-primary);
            border: 1.5px solid #00a1e4;
        }

        .start-button {
            width: 100%;
            padding: 10px 16px;
            border-radius: 8px;
            border: none;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .start-button.primary {
            background: var(--orange-primary);
            color: white;
        }

        .start-button.primary:hover {
            background: #dc6027;
            transform: translateY(-1px);
        }

        .start-button.disabled {
            background: #e2e8f0;
            color: #94a3b8;
            cursor: not-allowed;
        }

        .start-button.view-only {
            background: rgba(0, 161, 228, 0.1);
            color: var(--blue-primary);
            border: 2px solid rgba(0, 161, 228, 0.3);
        }

        .tooltip {
            position: relative;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #0f172a;
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 11px;
        }

        .tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #0f172a transparent transparent transparent;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .permission-legend {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .permission-legend h3 {
            font-size: 16px;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 16px;
        }

        .legend-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .legend-badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .legend-badge.ready {
            background: rgba(16, 185, 129, 0.15);
            color: var(--green-primary);
        }

        .legend-badge.locked {
            background: rgba(100, 116, 139, 0.15);
            color: #64748b;
        }

        .legend-badge.view-only {
            background: rgba(0, 161, 228, 0.15);
            color: var(--blue-primary);
        }

        .legend-text {
            font-size: 13px;
            color: #64748b;
        }

        /* DEVICE LOCKING STYLES */
        .device-state-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .device-state-header {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid;
        }

        .device-state-header.locked-state {
            background: rgba(239, 68, 68, 0.05);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .device-state-header.unlocked-state {
            background: rgba(16, 185, 129, 0.05);
            border-color: rgba(16, 185, 129, 0.3);
        }

        .state-icon {
            font-size: 32px;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .locked-state .state-icon {
            background: rgba(239, 68, 68, 0.15);
            color: #dc2626;
        }

        .unlocked-state .state-icon {
            background: rgba(16, 185, 129, 0.15);
            color: var(--green-primary);
        }

        .state-info {
            flex: 1;
        }

        .state-info h3 {
            font-size: 18px;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 4px;
        }

        .state-info p {
            font-size: 13px;
            color: #64748b;
        }

        .state-badge {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 8px;
            letter-spacing: 0.5px;
        }

        .locked-badge {
            background: rgba(239, 68, 68, 0.15);
            color: #dc2626;
        }

        .unlocked-badge {
            background: rgba(16, 185, 129, 0.15);
            color: var(--green-primary);
        }

        .payment-warning {
            background: rgba(239, 68, 68, 0.1);
            border-left: 4px solid #dc2626;
            padding: 12px 16px;
            border-radius: 6px;
            margin-top: 12px;
            font-size: 12px;
            color: #991b1b;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .payment-success {
            background: rgba(16, 185, 129, 0.1);
            border-left: 4px solid var(--green-primary);
            padding: 12px 16px;
            border-radius: 6px;
            margin-top: 12px;
            font-size: 12px;
            color: #065f46;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ASSESSMENT MODAL STYLES */
        .assessment-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .assessment-modal.open {
            opacity: 1;
            visibility: visible;
        }

        .assessment-modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(40px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .assessment-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 24px;
            border-bottom: 2px solid #e2e8f0;
            background: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .assessment-modal-title {
            flex: 1;
        }

        .assessment-modal-title h2 {
            font-size: 24px;
            font-weight: 700;
            color: #0f172a;
            margin: 0 0 4px 0;
        }

        .assessment-modal-title p {
            font-size: 13px;
            color: #64748b;
            margin: 0;
        }

        .assessment-modal-close {
            width: 40px;
            height: 40px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            color: #64748b;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .assessment-modal-close:hover {
            background: #f8fafc;
            border-color: var(--orange-primary);
            color: var(--orange-primary);
        }

        .assessment-modal-body {
            padding: 32px;
        }

        .assessment-section-group {
            margin-bottom: 32px;
        }

        .assessment-section-title {
            font-size: 16px;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--orange-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .assessment-info-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 24px;
        }

        .assessment-info-table thead {
            background: #f8fafc;
        }

        .assessment-info-table th {
            padding: 12px 16px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            color: #475569;
            text-align: left;
            border: 1px solid #e2e8f0;
            letter-spacing: 0.5px;
        }

        .assessment-info-table td {
            padding: 14px 16px;
            border: 1px solid #e2e8f0;
            font-size: 14px;
            color: #0f172a;
        }

        .assessment-info-table tbody tr:hover {
            background: #f8fafc;
        }

        .assessment-badge-info {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .assessment-badge-info.sozo {
            background: rgba(244, 121, 32, 0.15);
            color: var(--orange-primary);
        }

        .assessment-badge-info.blue {
            background: rgba(0, 161, 228, 0.15);
            color: var(--blue-primary);
        }

        .assessment-conclusion-box {
            background: #f8fafc;
            padding: 16px;
            border-left: 4px solid var(--orange-primary);
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .assessment-conclusion-box h4 {
            font-size: 13px;
            font-weight: 700;
            color: #475569;
            margin: 0 0 8px 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .assessment-conclusion-box p {
            font-size: 13px;
            color: #0f172a;
            margin: 0;
            line-height: 1.6;
        }

        /* ========================================
           MOBILE RESPONSIVE STYLES
           ======================================== */
        @media (max-width: 768px) {
            /* Container & Layout */
            .container-journey {
                padding: 12px;
            }

            /* Header & Title */
            .assessment-header {
                padding: 16px;
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .assessment-title {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
                width: 100%;
            }

            .assessment-title h2 {
                font-size: 18px;
            }

            .expand-icon {
                align-self: flex-end;
                position: absolute;
                right: 16px;
                top: 16px;
            }

            .assessment-meta {
                flex-direction: column;
                gap: 8px;
            }

            .assessment-content-inner {
                padding: 0 12px 16px 12px;
            }

            /* Tabs */
            .tabs-container {
                padding: 6px;
                gap: 6px;
                flex-wrap: wrap;
            }

            .tab-button {
                padding: 10px 16px;
                font-size: 14px;
                flex: 1 1 45%;
            }

            /* Role Selector */
            .role-selector-container {
                padding: 12px 16px;
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .role-select {
                width: 100%;
                padding: 10px 12px;
            }

            /* Blocks Grid */
            .blocks-container {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .block-card {
                padding: 16px;
                min-height: auto;
            }

            .block-icon {
                width: 48px;
                height: 48px;
                font-size: 20px;
                margin-bottom: 12px;
            }

            .block-name {
                font-size: 15px;
                margin-bottom: 6px;
            }

            .block-desc {
                font-size: 12px;
                margin-bottom: 12px;
            }

            .block-status {
                padding: 4px 10px;
                font-size: 11px;
            }

            /* Block Info Grid */
            .block-info-grid {
                grid-template-columns: 1fr;
                gap: 8px;
                padding: 12px;
            }

            .block-info-item {
                padding: 8px;
            }

            /* Action Buttons - Mobile stacked but centered */
            .block-action-buttons {
                display: flex;
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }

            .block-action-buttons:has(:only-child) .block-action-btn,
            .block-action-buttons:has(:nth-child(2):last-child) .block-action-btn,
            .block-action-btn {
                width: 100%;
                max-width: 100%;
                padding: 12px 16px;
                font-size: 14px;
            }

            /* Expanded Details */
            .block-expanded-details {
                width: 100%;
                padding: 12px;
            }

            /* Next Up Banner */
            .next-up-banner {
                padding: 12px 16px;
                font-size: 13px;
            }

            /* Progress Bar */
            .progress-fill {
                height: 3px;
            }

            /* Assessment Badges */
            .assessment-badge {
                padding: 4px 8px;
                font-size: 11px;
            }

            /* Meta Items */
            .meta-item {
                font-size: 11px;
            }

            /* Conclusion Box */
            .assessment-conclusion-box {
                padding: 12px;
            }

            .assessment-conclusion-box h4 {
                font-size: 12px;
            }

            .assessment-conclusion-box p {
                font-size: 12px;
            }

            /* Block Meta */
            .block-meta {
                font-size: 12px;
            }
        }

        /* Tablet Responsive (769px - 1024px) */
        @media (min-width: 769px) and (max-width: 1024px) {
            .container-journey {
                padding: 20px;
            }

            .blocks-container {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 16px;
            }

            .tab-button {
                padding: 10px 18px;
                font-size: 14px;
            }
        }

        /* Payment Override Modal Styles */
        .payment-override-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(4px);
        }

        .payment-override-modal.open {
            opacity: 1;
            visibility: visible;
        }

        .payment-override-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 520px;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.35);
            animation: modalSlideIn 0.3s ease;
            overflow: hidden;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(30px) scale(0.95);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        .payment-override-header {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            padding: 24px 28px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .payment-override-header-icon {
            width: 56px;
            height: 56px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .payment-override-header-text h3 {
            color: white;
            font-size: 20px;
            font-weight: 700;
            margin: 0 0 4px 0;
        }

        .payment-override-header-text p {
            color: rgba(255, 255, 255, 0.85);
            font-size: 13px;
            margin: 0;
        }

        .payment-override-body {
            padding: 28px;
        }

        .payment-override-warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .payment-override-warning i {
            color: #d97706;
            font-size: 20px;
            margin-top: 2px;
        }

        .payment-override-warning-text {
            font-size: 13px;
            color: #92400e;
            line-height: 1.5;
        }

        .payment-override-warning-text strong {
            display: block;
            font-size: 14px;
            margin-bottom: 4px;
            color: #78350f;
        }

        .payment-override-consent {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .payment-override-consent-title {
            font-weight: 700;
            color: #0f172a;
            font-size: 14px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .payment-override-consent-title i {
            color: #6366f1;
        }

        .payment-override-consent-text {
            font-size: 13px;
            color: #475569;
            line-height: 1.6;
            margin-bottom: 16px;
        }

        .payment-override-checkbox {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            cursor: pointer;
        }

        .payment-override-checkbox input {
            width: 20px;
            height: 20px;
            accent-color: #dc2626;
            cursor: pointer;
            margin-top: 2px;
        }

        .payment-override-checkbox label {
            font-size: 13px;
            color: #0f172a;
            line-height: 1.5;
            cursor: pointer;
            font-weight: 500;
        }

        .payment-override-footer {
            display: flex;
            gap: 12px;
            padding-top: 8px;
        }

        .payment-override-btn {
            flex: 1;
            padding: 14px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .payment-override-btn-cancel {
            background: white;
            border: 2px solid #e2e8f0;
            color: #64748b;
        }

        .payment-override-btn-cancel:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
        }

        .payment-override-btn-confirm {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            border: none;
            color: white;
            opacity: 0.5;
            cursor: not-allowed;
        }

        .payment-override-btn-confirm.enabled {
            opacity: 1;
            cursor: pointer;
        }

        .payment-override-btn-confirm.enabled:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);
        }

        .override-payment-btn {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .override-payment-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
        }

        /* Payment Override Success State */
        .payment-override-success {
            display: none;
            text-align: center;
            padding: 20px 0;
        }

        .payment-override-success.show {
            display: block;
        }

        .payment-override-success-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 36px;
            color: white;
            box-shadow: 0 10px 40px rgba(16, 185, 129, 0.3);
            animation: successPop 0.4s ease;
        }

        @keyframes successPop {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        .payment-override-success h3 {
            font-size: 22px;
            font-weight: 700;
            color: #0f172a;
            margin: 0 0 8px 0;
        }

        .payment-override-success p {
            font-size: 14px;
            color: #64748b;
            margin: 0 0 24px 0;
        }

        .payment-override-start-btn {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.3);
        }

        .payment-override-start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.4);
        }

        .payment-override-close-link {
            display: block;
            margin-top: 16px;
            font-size: 13px;
            color: #64748b;
            cursor: pointer;
            text-decoration: underline;
        }

        .payment-override-close-link:hover {
            color: #475569;
        }

        .payment-override-form {
            display: block;
        }

        .payment-override-form.hide {
            display: none;
        }
    </style>
</head>

<body>
    <div class="container-journey">
        <!-- PAGE HEADER -->
        <div class="page-header">
            <div class="page-header-left">
                <h1 class="page-title">SOZO Clinical Journey</h1>
                <p class="page-subtitle">Clinical Assessment Progress & Session Timeline</p>
            </div>
            <div class="page-header-right">
                <!-- Role Selector -->
                <div id="topRoleSelector" style="display: none;">
                    <label style="font-size: 12px; font-weight: 600; color: #475569; margin-right: 8px;">VIEW AS:</label>
                    <select id="topRoleSelect" onchange="handleTopRoleChange()"
                        style="padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 13px; font-weight: 600; color: #0f172a; cursor: pointer; background: white;">
                        <option value="receptionist" selected>Receptionist</option>
                        <option value="patient">Patient</option>
                        <option value="doctor">Doctor</option>
                        <option value="clinical-assistant">Clinical Assistant</option>
                    </select>
                </div>
                <!-- Clarity Wireframes Dropdown -->
                <div id="topClarityWireframes" style="display: none;">
                    <label style="font-size: 12px; font-weight: 600; color: #475569; margin-right: 8px;">CLARITY WIREFRAMES:</label>
                    <select id="topClaritySelector" onchange="handleTopClarityWireframeChange()"
                        style="padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 13px; font-weight: 600; color: #0f172a; cursor: pointer; background: white;">
                        <option value="none" selected>-- Select Wireframe --</option>
                        <option value="working">Working Active Journey</option>
                        <option value="device">Device Locking</option>
                    </select>
                </div>
                <!-- Back to List Button -->
                <button id="topBackToListBtn" onclick="backToPatientList()" style="display: none; padding: 10px 20px; border: 2px solid #e2e8f0; background: white; color: #64748b; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                    <i class="fa-solid fa-arrow-left"></i> Back to List
                </button>
            </div>
        </div>

        <!-- PATIENT REGISTRATION QUESTIONNAIRE PAGE (Hidden by default) -->
        <div id="questionnaireScreen" style="display: none; max-width: 900px; margin: 0 auto; padding: 40px 20px;">
            <div style="background: white; border-radius: 20px; padding: 48px; box-shadow: 0 12px 48px rgba(0, 0, 0, 0.15); border: 1px solid #e2e8f0;">
                <!-- Header -->
                <div style="text-align: center; margin-bottom: 40px;">
                    <div style="display: inline-flex; align-items: center; justify-content: center; width: 80px; height: 80px; background: linear-gradient(135deg, var(--orange-primary), #dc6027); border-radius: 50%; margin-bottom: 20px;">
                        <i class="fa-solid fa-clipboard-list" style="font-size: 36px; color: white;"></i>
                    </div>
                    <h2 style="font-size: 28px; font-weight: 700; color: #0f172a; margin-bottom: 8px;">Patient Registration Questionnaire</h2>
                    <p style="font-size: 14px; color: #64748b;">Help us understand your medical background better (optional)</p>
                </div>

                <!-- Questionnaire Form -->
                <form id="questionnaireForm" style="margin-bottom: 32px;">
                    <!-- Medical History Section -->
                    <div style="background: #f8fafc; border-radius: 12px; padding: 24px; margin-bottom: 24px; border-left: 4px solid var(--orange-primary);">
                        <h3 style="font-size: 16px; font-weight: 700; color: #0f172a; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <i class="fa-solid fa-hospital" style="color: var(--orange-primary);"></i>
                            Medical History
                        </h3>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-size: 13px; font-weight: 600; color: #475569; margin-bottom: 8px;">Have you been diagnosed with any neurological conditions?</label>
                            <textarea id="neurologicalConditions" rows="3" placeholder="e.g., Parkinson's Disease, Essential Tremor, Epilepsy, etc." style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical;"></textarea>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-size: 13px; font-weight: 600; color: #475569; margin-bottom: 8px;">Do you have any other medical conditions we should know about?</label>
                            <textarea id="otherMedicalConditions" rows="3" placeholder="e.g., Diabetes, Hypertension, Heart Disease, etc." style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical;"></textarea>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-size: 13px; font-weight: 600; color: #475569; margin-bottom: 8px;">Are you currently taking any medications?</label>
                            <textarea id="currentMedications" rows="3" placeholder="List all medications with dosage if known" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical;"></textarea>
                        </div>

                        <div style="margin-bottom: 0;">
                            <label style="display: block; font-size: 13px; font-weight: 600; color: #475569; margin-bottom: 8px;">Do you have any allergies (medications, latex, etc.)?</label>
                            <input type="text" id="allergies" placeholder="e.g., Penicillin, Latex, None" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                        </div>
                    </div>

                    <!-- Previous Treatments Section -->
                    <div style="background: #f8fafc; border-radius: 12px; padding: 24px; margin-bottom: 24px; border-left: 4px solid #10b981;">
                        <h3 style="font-size: 16px; font-weight: 700; color: #0f172a; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <i class="fa-solid fa-notes-medical" style="color: #10b981;"></i>
                            Previous Treatments
                        </h3>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-size: 13px; font-weight: 600; color: #475569; margin-bottom: 8px;">Have you received tDCS or other brain stimulation therapy before?</label>
                            <div style="display: flex; gap: 16px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" name="previousTDCS" value="yes" style="cursor: pointer;">
                                    <span style="font-size: 14px; color: #0f172a;">Yes</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" name="previousTDCS" value="no" checked style="cursor: pointer;">
                                    <span style="font-size: 14px; color: #0f172a;">No</span>
                                </label>
                            </div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-size: 13px; font-weight: 600; color: #475569; margin-bottom: 8px;">If yes, please provide details:</label>
                            <textarea id="previousTDCSDetails" rows="2" placeholder="Type of therapy, when, where, outcomes..." style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical;"></textarea>
                        </div>

                        <div style="margin-bottom: 0;">
                            <label style="display: block; font-size: 13px; font-weight: 600; color: #475569; margin-bottom: 8px;">What other treatments have you tried for your condition?</label>
                            <textarea id="otherTreatments" rows="3" placeholder="e.g., Physical therapy, Medications, Surgery, etc." style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical;"></textarea>
                        </div>
                    </div>

                    <!-- Lifestyle Section -->
                    <div style="background: #f8fafc; border-radius: 12px; padding: 24px; margin-bottom: 24px; border-left: 4px solid #3b82f6;">
                        <h3 style="font-size: 16px; font-weight: 700; color: #0f172a; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <i class="fa-solid fa-heartbeat" style="color: #3b82f6;"></i>
                            Lifestyle Information
                        </h3>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-size: 13px; font-weight: 600; color: #475569; margin-bottom: 8px;">Do you smoke or use tobacco?</label>
                            <div style="display: flex; gap: 16px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" name="smoking" value="yes" style="cursor: pointer;">
                                    <span style="font-size: 14px; color: #0f172a;">Yes</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" name="smoking" value="no" checked style="cursor: pointer;">
                                    <span style="font-size: 14px; color: #0f172a;">No</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" name="smoking" value="former" style="cursor: pointer;">
                                    <span style="font-size: 14px; color: #0f172a;">Former</span>
                                </label>
                            </div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-size: 13px; font-weight: 600; color: #475569; margin-bottom: 8px;">Do you consume alcohol?</label>
                            <div style="display: flex; gap: 16px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" name="alcohol" value="never" checked style="cursor: pointer;">
                                    <span style="font-size: 14px; color: #0f172a;">Never</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" name="alcohol" value="occasionally" style="cursor: pointer;">
                                    <span style="font-size: 14px; color: #0f172a;">Occasionally</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" name="alcohol" value="regularly" style="cursor: pointer;">
                                    <span style="font-size: 14px; color: #0f172a;">Regularly</span>
                                </label>
                            </div>
                        </div>

                        <div style="margin-bottom: 0;">
                            <label style="display: block; font-size: 13px; font-weight: 600; color: #475569; margin-bottom: 8px;">Do you exercise regularly?</label>
                            <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" name="exercise" value="daily" style="cursor: pointer;">
                                    <span style="font-size: 14px; color: #0f172a;">Daily</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" name="exercise" value="weekly" checked style="cursor: pointer;">
                                    <span style="font-size: 14px; color: #0f172a;">Few times/week</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" name="exercise" value="rarely" style="cursor: pointer;">
                                    <span style="font-size: 14px; color: #0f172a;">Rarely</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="radio" name="exercise" value="never" style="cursor: pointer;">
                                    <span style="font-size: 14px; color: #0f172a;">Never</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Information Section -->
                    <div style="background: #f8fafc; border-radius: 12px; padding: 24px; margin-bottom: 0; border-left: 4px solid #8b5cf6;">
                        <h3 style="font-size: 16px; font-weight: 700; color: #0f172a; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <i class="fa-solid fa-comment-medical" style="color: #8b5cf6;"></i>
                            Additional Information
                        </h3>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-size: 13px; font-weight: 600; color: #475569; margin-bottom: 8px;">What are your main goals for treatment?</label>
                            <textarea id="treatmentGoals" rows="3" placeholder="e.g., Reduce tremors, Improve mobility, Better sleep, etc." style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical;"></textarea>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-size: 13px; font-weight: 600; color: #475569; margin-bottom: 8px;">How did you hear about our clinic?</label>
                            <select id="referralSource" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: white; cursor: pointer;">
                                <option value="">Please select...</option>
                                <option value="doctor">Doctor Referral</option>
                                <option value="friend">Friend/Family</option>
                                <option value="online">Online Search</option>
                                <option value="social">Social Media</option>
                                <option value="advertisement">Advertisement</option>
                                <option value="other">Other</option>
                            </select>
                        </div>

                        <div style="margin-bottom: 0;">
                            <label style="display: block; font-size: 13px; font-weight: 600; color: #475569; margin-bottom: 8px;">Any other information you'd like to share?</label>
                            <textarea id="additionalNotes" rows="3" placeholder="Any concerns, questions, or information you think we should know..." style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical;"></textarea>
                        </div>
                    </div>
                </form>

                <!-- Info Notice -->
                <div style="background: #fef3c7; border: 2px solid #fbbf24; border-radius: 12px; padding: 16px; margin-bottom: 32px; display: flex; gap: 12px;">
                    <i class="fa-solid fa-info-circle" style="color: #f59e0b; font-size: 20px; flex-shrink: 0;"></i>
                    <div style="font-size: 13px; color: #78350f;">
                        <strong style="display: block; margin-bottom: 4px;">This questionnaire is optional</strong>
                        You can skip this step and complete it later. However, providing this information helps your doctor create a more personalized treatment plan.
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 16px; justify-content: center;">
                    <button type="button" onclick="skipQuestionnaire()" style="padding: 16px 32px; background: white; color: #64748b; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; min-width: 180px;">
                        <i class="fa-solid fa-forward"></i> Skip for Now
                    </button>
                    <button type="button" onclick="submitQuestionnaire()" style="padding: 16px 32px; background: linear-gradient(135deg, var(--orange-primary), #dc6027); color: white; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; min-width: 180px; box-shadow: 0 4px 12px rgba(234, 88, 12, 0.3);">
                        Continue <i class="fa-solid fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- CONSENT FORM PAGE -->
        <div id="consentFormPage" style="display: none;">
            <div style="max-width: 900px; margin: 0 auto;">
                <!-- Header -->
                <div style="text-align: center; margin-bottom: 32px;">
                    <div
                        style="width: 72px; height: 72px; border-radius: 50%; background: linear-gradient(135deg, var(--blue-primary), #0284c7); margin: 0 auto 20px; display: flex; align-items: center; justify-content: center;">
                        <i class="fa-solid fa-file-signature" style="font-size: 32px; color: white;"></i>
                    </div>
                    <h2 style="font-size: 28px; font-weight: 700; color: #0f172a; margin-bottom: 8px;">Patient Consent
                        Form</h2>
                    <p style="font-size: 14px; color: #64748b;">Please review and sign the consent form to proceed</p>
                </div>

                <!-- PDF Viewer -->
                <div
                    style="background: white; border-radius: 16px; padding: 24px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12); margin-bottom: 32px;">
                    <div
                        style="background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 24px; margin-bottom: 24px;">
                        <embed src="consent.pdf" type="application/pdf" width="100%" height="600px"
                            style="border-radius: 8px;" />
                    </div>

                    <!-- E-Signature Section -->
                    <div
                        style="background: linear-gradient(135deg, rgba(0, 161, 228, 0.05), rgba(2, 132, 199, 0.05)); border: 2px solid var(--blue-primary); border-radius: 12px; padding: 24px;">
                        <h3 style="font-size: 16px; font-weight: 700; color: #0f172a; margin-bottom: 16px;">Electronic
                            Signature</h3>

                        <div style="display: grid; gap: 16px;">
                            <!-- Full Name -->
                            <div>
                                <label
                                    style="display: block; font-size: 12px; font-weight: 600; color: #475569; margin-bottom: 8px;">FULL
                                    NAME *</label>
                                <input type="text" id="consentFullName" readonly
                                    style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: #f8fafc; color: #0f172a; font-weight: 600;">
                            </div>

                            <!-- Signature Canvas -->
                            <div>
                                <label
                                    style="display: block; font-size: 12px; font-weight: 600; color: #475569; margin-bottom: 8px;">SIGNATURE
                                    *</label>
                                <div style="position: relative;">
                                    <canvas id="signatureCanvas" width="800" height="200"
                                        style="border: 2px solid #e2e8f0; border-radius: 8px; cursor: crosshair; background: white; width: 100%; height: 200px;"></canvas>
                                    <button type="button" onclick="clearSignature()"
                                        style="position: absolute; top: 8px; right: 8px; padding: 6px 12px; background: white; border: 2px solid #e2e8f0; border-radius: 6px; color: #64748b; font-size: 11px; font-weight: 600; cursor: pointer;">
                                        <i class="fa-solid fa-eraser"></i> Clear
                                    </button>
                                </div>
                                <p style="font-size: 11px; color: #94a3b8; margin-top: 8px;"><i
                                        class="fa-solid fa-info-circle"></i> Draw your signature using mouse or touch
                                </p>
                            </div>

                            <!-- Date -->
                            <div>
                                <label
                                    style="display: block; font-size: 12px; font-weight: 600; color: #475569; margin-bottom: 8px;">DATE</label>
                                <input type="text" id="consentDate" readonly value="February 1, 2026"
                                    style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: #f8fafc; color: #64748b;">
                            </div>

                            <!-- Checkbox -->
                            <div
                                style="display: flex; align-items: start; gap: 12px; padding: 16px; background: white; border-radius: 8px;">
                                <input type="checkbox" id="consentCheckbox"
                                    style="width: 20px; height: 20px; margin-top: 2px; cursor: pointer;">
                                <label for="consentCheckbox" style="font-size: 13px; color: #475569; cursor: pointer;">
                                    I have read and understood the consent form. I agree to the terms and conditions
                                    outlined above and provide my consent for the proposed treatment.
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 12px; justify-content: center;">
                    <button type="button" onclick="backToPatientSelection()"
                        style="padding: 16px 32px; border: 2px solid #e2e8f0; background: white; color: #64748b; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                        <i class="fa-solid fa-arrow-left"></i> Back
                    </button>
                    <button type="button" id="submitConsentBtn" onclick="submitConsent()" disabled
                        style="padding: 16px 48px; border: none; background: linear-gradient(135deg, var(--blue-primary), #0284c7); color: white; border-radius: 12px; font-size: 15px; font-weight: 700; cursor: not-allowed; opacity: 0.5; transition: all 0.2s; box-shadow: 0 4px 12px rgba(0, 161, 228, 0.3);">
                        Sign & Continue <i class="fa-solid fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- PAYMENT PAGE -->
        <div id="paymentPage" style="display: none;">
            <div style="max-width: 900px; margin: 0 auto;">
                <!-- Header -->
                <div style="text-align: center; margin-bottom: 32px;">
                    <div
                        style="width: 72px; height: 72px; border-radius: 50%; background: linear-gradient(135deg, #10b981, #059669); margin: 0 auto 20px; display: flex; align-items: center; justify-content: center;">
                        <i class="fa-solid fa-credit-card" style="font-size: 32px; color: white;"></i>
                    </div>
                    <h2 style="font-size: 28px; font-weight: 700; color: #0f172a; margin-bottom: 8px;">Secure Payment
                    </h2>
                    <p style="font-size: 14px; color: #64748b;">Powered by <strong>Stripe</strong>  PCI DSS Compliant 
                        256-bit SSL Encryption</p>
                </div>

                <!-- Payment Summary -->
                <div
                    style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1)); border: 2px solid #10b981; border-radius: 16px; padding: 24px; margin-bottom: 32px;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <span style="font-size: 14px; color: #64748b;" class="payment-description">Initial Consultation
                            Fee</span>
                        <span style="font-size: 24px; font-weight: 700; color: #0f172a;"
                            class="payment-amount">300</span>
                    </div>
                    <div style="padding-top: 12px; border-top: 2px dashed #10b981; font-size: 12px; color: #64748b;"
                        class="payment-details">
                        <i class="fa-solid fa-info-circle"></i> This includes initial assessments (PRS, FNON, EEG) and
                        onboarding
                    </div>
                </div>

                <!-- Payment Method Selection -->
                <div
                    style="background: white; border-radius: 16px; padding: 32px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12); margin-bottom: 24px;">
                    <h3 style="font-size: 18px; font-weight: 700; color: #0f172a; margin-bottom: 20px;">Select Payment
                        Method</h3>

                    <!-- Payment Method Tabs -->
                    <div
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 32px;">
                        <!-- Card Payment (Selected) -->
                        <div id="paymentMethodCard" onclick="selectPaymentMethod('card')"
                            style="padding: 16px; border: 3px solid #10b981; background: rgba(16, 185, 129, 0.05); border-radius: 12px; cursor: pointer; text-align: center; transition: all 0.3s;">
                            <i class="fa-solid fa-credit-card"
                                style="font-size: 24px; color: #10b981; margin-bottom: 8px;"></i>
                            <div style="font-size: 13px; font-weight: 700; color: #0f172a;">Card Payment</div>
                            <div style="font-size: 11px; color: #64748b; margin-top: 4px;">Visa, Mastercard, Amex</div>
                        </div>

                        <!-- Digital Wallets -->
                        <div id="paymentMethodWallet" onclick="selectPaymentMethod('wallet')"
                            style="padding: 16px; border: 2px solid #e2e8f0; background: white; border-radius: 12px; cursor: pointer; text-align: center; transition: all 0.3s;">
                            <i class="fa-brands fa-apple-pay"
                                style="font-size: 24px; color: #64748b; margin-bottom: 8px;"></i>
                            <div style="font-size: 13px; font-weight: 700; color: #0f172a;">Digital Wallet</div>
                            <div style="font-size: 11px; color: #64748b; margin-top: 4px;">Apple Pay, Google Pay</div>
                        </div>

                        <!-- QR Code Payment -->
                        <div id="paymentMethodQR" onclick="selectPaymentMethod('qr')"
                            style="padding: 16px; border: 2px solid #e2e8f0; background: white; border-radius: 12px; cursor: pointer; text-align: center; transition: all 0.3s;">
                            <i class="fa-solid fa-qrcode"
                                style="font-size: 24px; color: #64748b; margin-bottom: 8px;"></i>
                            <div style="font-size: 13px; font-weight: 700; color: #0f172a;">QR Code</div>
                            <div style="font-size: 11px; color: #64748b; margin-top: 4px;">WeChat, Alipay, UPI</div>
                        </div>

                        <!-- Bank Transfer -->
                        <div id="paymentMethodBank" onclick="selectPaymentMethod('bank')"
                            style="padding: 16px; border: 2px solid #e2e8f0; background: white; border-radius: 12px; cursor: pointer; text-align: center; transition: all 0.3s;">
                            <i class="fa-solid fa-building-columns"
                                style="font-size: 24px; color: #64748b; margin-bottom: 8px;"></i>
                            <div style="font-size: 13px; font-weight: 700; color: #0f172a;">Bank Transfer</div>
                            <div style="font-size: 11px; color: #64748b; margin-top: 4px;">SEPA, ACH, Wire</div>
                        </div>
                    </div>

                    <!-- Card Payment Form (Default Selected) -->
                    <div id="cardPaymentSection">
                        <div
                            style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid #e2e8f0;">
                            <h4 style="font-size: 16px; font-weight: 700; color: #0f172a;">Card Details</h4>
                            <div style="display: flex; gap: 8px;">
                                <i class="fa-brands fa-cc-visa" style="font-size: 32px; color: #1a1f71;"></i>
                                <i class="fa-brands fa-cc-mastercard" style="font-size: 32px; color: #eb001b;"></i>
                                <i class="fa-brands fa-cc-amex" style="font-size: 32px; color: #006fcf;"></i>
                                <i class="fa-brands fa-cc-discover" style="font-size: 32px; color: #ff6000;"></i>
                            </div>
                        </div>

                        <form id="paymentForm">
                            <!-- Cardholder Name -->
                            <div style="margin-bottom: 20px;">
                                <label
                                    style="display: block; font-size: 12px; font-weight: 600; color: #475569; margin-bottom: 8px;">CARDHOLDER
                                    NAME</label>
                                <input type="text" id="cardholderName" value="Sarah Mitchell"
                                    style="width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;"
                                    onfocus="this.style.borderColor='#10b981'"
                                    onblur="this.style.borderColor='#e2e8f0'">
                            </div>

                            <!-- Card Number with Stripe Element Simulation -->
                            <div style="margin-bottom: 20px;">
                                <label
                                    style="display: block; font-size: 12px; font-weight: 600; color: #475569; margin-bottom: 8px;">CARD
                                    NUMBER</label>
                                <div style="position: relative;">
                                    <input type="text" id="cardNumber" value="4242 4242 4242 4242" maxlength="19"
                                        style="width: 100%; padding: 14px 50px 14px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s; font-family: 'Courier New', monospace; letter-spacing: 2px;"
                                        onfocus="this.style.borderColor='#10b981'"
                                        onblur="this.style.borderColor='#e2e8f0'" oninput="detectCardType(this.value)">
                                    <i id="cardTypeIcon" class="fa-brands fa-cc-visa"
                                        style="position: absolute; right: 16px; top: 50%; transform: translateY(-50%); font-size: 24px; color: #1a1f71;"></i>
                                </div>
                                <div style="font-size: 11px; color: #64748b; margin-top: 6px;">
                                    <i class="fa-solid fa-shield-halved" style="color: #10b981;"></i> Stripe secure
                                    element  Data never stored on our servers
                                </div>
                            </div>

                            <!-- Expiry and CVC -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                                <div>
                                    <label
                                        style="display: block; font-size: 12px; font-weight: 600; color: #475569; margin-bottom: 8px;">EXPIRY
                                        DATE</label>
                                    <input type="text" id="cardExpiry" value="12/28" maxlength="5" placeholder="MM/YY"
                                        style="width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s; font-family: 'Courier New', monospace;"
                                        onfocus="this.style.borderColor='#10b981'"
                                        onblur="this.style.borderColor='#e2e8f0'">
                                </div>
                                <div>
                                    <label
                                        style="display: block; font-size: 12px; font-weight: 600; color: #475569; margin-bottom: 8px;">CVC</label>
                                    <div style="position: relative;">
                                        <input type="text" id="cardCvc" value="123" maxlength="4" placeholder="123"
                                            style="width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s; font-family: 'Courier New', monospace;"
                                            onfocus="this.style.borderColor='#10b981'"
                                            onblur="this.style.borderColor='#e2e8f0'">
                                        <i class="fa-solid fa-circle-question"
                                            style="position: absolute; right: 16px; top: 50%; transform: translateY(-50%); color: #94a3b8; cursor: help;"
                                            title="3-digit security code on the back of your card"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- Country and ZIP -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                                <div>
                                    <label
                                        style="display: block; font-size: 12px; font-weight: 600; color: #475569; margin-bottom: 8px;">COUNTRY</label>
                                    <select id="billingCountry"
                                        style="width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s; background: white; cursor: pointer;"
                                        onfocus="this.style.borderColor='#10b981'"
                                        onblur="this.style.borderColor='#e2e8f0'">
                                        <option value="IE" selected> Ireland</option>
                                        <option value="GB"> United Kingdom</option>
                                        <option value="US"> United States</option>
                                        <option value="DE"> Germany</option>
                                        <option value="FR"> France</option>
                                        <option value="IN"> India</option>
                                        <option value="CN"> China</option>
                                    </select>
                                </div>
                                <div>
                                    <label
                                        style="display: block; font-size: 12px; font-weight: 600; color: #475569; margin-bottom: 8px;">POSTAL
                                        CODE</label>
                                    <input type="text" id="billingZip" value="D02 XY45" maxlength="10"
                                        style="width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;"
                                        onfocus="this.style.borderColor='#10b981'"
                                        onblur="this.style.borderColor='#e2e8f0'">
                                </div>
                            </div>

                            <!-- Save Card Option -->
                            <div style="margin-bottom: 20px;">
                                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="saveCard" checked
                                        style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="font-size: 13px; color: #475569;">Save card for future payments (PCI
                                        compliant tokenization)</span>
                                </label>
                            </div>
                        </form>
                    </div>

                    <!-- Digital Wallet Section (Hidden by default) -->
                    <div id="walletPaymentSection" style="display: none;">
                        <div style="text-align: center; padding: 40px 20px;">
                            <div style="display: flex; justify-content: center; gap: 16px; margin-bottom: 24px;">
                                <button
                                    style="padding: 16px 32px; background: black; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                    <i class="fa-brands fa-apple-pay" style="font-size: 24px;"></i> Apple Pay
                                </button>
                                <button
                                    style="padding: 16px 32px; background: white; border: 2px solid #e2e8f0; color: #0f172a; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                    <i class="fa-brands fa-google-pay" style="font-size: 24px;"></i> Google Pay
                                </button>
                            </div>
                            <p style="font-size: 12px; color: #64748b;">Quick checkout with your saved payment methods
                            </p>
                        </div>
                    </div>

                    <!-- QR Code Section (Hidden by default) -->
                    <div id="qrPaymentSection" style="display: none;">
                        <div style="text-align: center; padding: 20px;">
                            <h4 style="font-size: 16px; font-weight: 700; color: #0f172a; margin-bottom: 20px;">Scan to
                                Pay</h4>

                            <!-- QR Code Display -->
                            <div
                                style="background: white; padding: 24px; border: 2px solid #e2e8f0; border-radius: 16px; display: inline-block; margin-bottom: 20px;">
                                <div
                                    style="width: 200px; height: 200px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 3px solid #10b981; border-radius: 12px; display: flex; align-items: center; justify-content: center; position: relative;">
                                    <i class="fa-solid fa-qrcode"
                                        style="font-size: 120px; color: #0f172a; opacity: 0.8;"></i>
                                    <div
                                        style="position: absolute; bottom: 8px; right: 8px; width: 32px; height: 32px; background: #10b981; border-radius: 6px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fa-solid fa-check" style="color: white; font-size: 16px;"></i>
                                    </div>
                                </div>
                            </div>

                            <p style="font-size: 14px; color: #0f172a; font-weight: 600; margin-bottom: 8px;">Scan with
                                your mobile payment app</p>
                            <p style="font-size: 12px; color: #64748b; margin-bottom: 24px;">Supported: WeChat Pay,
                                Alipay, UPI, Paytm</p>

                            <!-- Payment Options -->
                            <div style="display: flex; justify-content: center; gap: 12px; flex-wrap: wrap;">
                                <div
                                    style="padding: 8px 16px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 11px; color: #64748b;">
                                    <i class="fa-brands fa-weixin" style="color: #09b83e;"></i> WeChat Pay
                                </div>
                                <div
                                    style="padding: 8px 16px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 11px; color: #64748b;">
                                    <i class="fa-solid fa-mobile-screen-button" style="color: #1677ff;"></i> Alipay
                                </div>
                                <div
                                    style="padding: 8px 16px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 11px; color: #64748b;">
                                    <i class="fa-solid fa-building-columns" style="color: #ff6b00;"></i> UPI
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bank Transfer Section (Hidden by default) -->
                    <div id="bankPaymentSection" style="display: none;">
                        <div style="padding: 20px;">
                            <div
                                style="background: #fef3c7; border: 1px solid #fbbf24; border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <i class="fa-solid fa-circle-info" style="color: #d97706; font-size: 20px;"></i>
                                    <div>
                                        <div
                                            style="font-size: 13px; font-weight: 700; color: #92400e; margin-bottom: 4px;">
                                            Bank transfer takes 2-3 business days</div>
                                        <div style="font-size: 12px; color: #78350f;">Your appointment will be confirmed
                                            once payment is received</div>
                                    </div>
                                </div>
                            </div>

                            <div
                                style="background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px;">
                                <h4 style="font-size: 14px; font-weight: 700; color: #0f172a; margin-bottom: 16px;">Bank
                                    Details</h4>
                                <div style="display: grid; gap: 12px; font-size: 13px;">
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #64748b;">Bank Name:</span>
                                        <span style="font-weight: 600; color: #0f172a;">Allied Irish Bank (AIB)</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #64748b;">Account Name:</span>
                                        <span style="font-weight: 600; color: #0f172a;">Sozo Clinic Ltd</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #64748b;">IBAN:</span>
                                        <span
                                            style="font-weight: 600; color: #0f172a; font-family: 'Courier New', monospace;">IE29
                                            AIBK 9311 5212 3456 78</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #64748b;">BIC/SWIFT:</span>
                                        <span
                                            style="font-weight: 600; color: #0f172a; font-family: 'Courier New', monospace;">AIBKIE2D</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #64748b;">Reference:</span>
                                        <span
                                            style="font-weight: 600; color: #10b981; font-family: 'Courier New', monospace;">PAT-SM-2026-001</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Security Notice -->
                    <div
                        style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; margin-top: 24px;">
                        <i class="fa-solid fa-shield-halved" style="color: #16a34a; font-size: 16px;"></i>
                        <span style="font-size: 12px; color: #15803d;">256-bit SSL encryption  PCI DSS Level 1
                            certified  Your data is never stored</span>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 12px;">
                    <button type="button" onclick="backFromPayment()"
                        style="padding: 16px 24px; border: 2px solid #e2e8f0; background: white; color: #64748b; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                        <i class="fa-solid fa-arrow-left"></i> Back
                    </button>
                    <button type="button" onclick="selectPayLater()"
                        style="flex: 1; padding: 16px; border: 2px solid #e2e8f0; background: white; color: #64748b; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                        <i class="fa-solid fa-clock"></i> Pay Later
                    </button>
                    <button type="button" onclick="processPayment()"
                        style="flex: 2; padding: 16px; border: none; background: linear-gradient(135deg, #10b981, #059669); color: white; border-radius: 12px; font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                        <i class="fa-solid fa-lock"></i> Secure Payment <span class="payment-amount">300</span>
                    </button>
                </div>

                <!-- Payment Providers -->
                <div style="text-align: center; margin-top: 24px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                    <p style="font-size: 11px; color: #94a3b8; margin-bottom: 12px;">Payment processed securely by</p>
                    <div
                        style="display: flex; justify-content: center; align-items: center; gap: 24px; flex-wrap: wrap;">
                        <div style="font-size: 20px; font-weight: 700; color: #635bff;">Stripe</div>
                        <div style="font-size: 11px; color: #cbd5e1;">|</div>
                        <i class="fa-solid fa-shield-halved" style="font-size: 16px; color: #10b981;"></i>
                        <div style="font-size: 11px; color: #64748b; font-weight: 600;">PCI DSS Compliant</div>
                        <div style="font-size: 11px; color: #cbd5e1;">|</div>
                        <i class="fa-solid fa-lock" style="font-size: 14px; color: #64748b;"></i>
                        <div style="font-size: 11px; color: #64748b; font-weight: 600;">SSL Secured</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PATIENT SELECTION / ENTRY SCREEN -->
        <div id="patientEntryScreen" style="display: block;">
            <!-- Centered Container -->
            <div style="max-width: 600px; margin: 60px auto; text-align: center;">
                <!-- Role Selector for Entry -->
                <div style="margin-bottom: 32px;">
                    <label style="font-size: 12px; font-weight: 600; color: #64748b; margin-right: 12px;">I AM:</label>
                    <select id="entryRoleSelector" onchange="handleEntryRoleChange()"
                        style="padding: 10px 20px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; font-weight: 600; color: #0f172a; cursor: pointer; background: white;">
                        <option value="receptionist" selected>Receptionist</option>
                        <option value="patient">Patient</option>
                        <option value="doctor">Doctor</option>
                        <option value="clinical-assistant">Clinical Assistant</option>
                    </select>
                </div>

                <!-- Welcome Message -->
                <div style="margin-bottom: 48px;">
                    <div style="font-size: 32px; font-weight: 700; color: #0f172a; margin-bottom: 12px;">
                        <span id="welcomeMessage">Welcome Back!</span>
                    </div>
                    <p style="font-size: 16px; color: #64748b;">Select a patient to view their journey</p>
                </div>

                <!-- Search and Select Patient -->
                <div
                    style="background: white; border-radius: 16px; padding: 32px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12); margin-bottom: 32px;">
                    <!-- Search Input -->
                    <div style="position: relative; margin-bottom: 20px;">
                        <input type="text" id="patientSearchInput" placeholder="Search by name or ID..."
                            oninput="filterPatients()"
                            style="width: 100%; padding: 16px 48px 16px 48px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 15px; transition: all 0.3s; background: #f8fafc;"
                            onfocus="this.style.borderColor='var(--orange-primary)'; this.style.background='white';"
                            onblur="this.style.borderColor='#e2e8f0'; this.style.background='#f8fafc';">
                        <i class="fa-solid fa-search"
                            style="position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: #94a3b8; font-size: 16px;"></i>
                        <i class="fa-solid fa-filter"
                            style="position: absolute; right: 18px; top: 50%; transform: translateY(-50%); color: #94a3b8; font-size: 16px;"></i>
                    </div>

                    <!-- Selected Patient Display -->
                    <div id="selectedPatientDisplay"
                        style="display: none; background: linear-gradient(135deg, rgba(244, 121, 32, 0.1), rgba(220, 96, 39, 0.1)); border: 2px solid var(--orange-primary); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <div
                                style="width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(135deg, var(--orange-primary), #dc6027); display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; font-weight: 700; flex-shrink: 0;">
                                <span id="selectedPatientInitials">SM</span>
                            </div>
                            <div style="flex: 1; text-align: left;">
                                <div style="font-size: 18px; font-weight: 700; color: #0f172a; margin-bottom: 4px;"
                                    id="selectedPatientName">Sarah Mitchell</div>
                                <div style="display: flex; gap: 16px; font-size: 13px; color: #64748b;">
                                    <span><i class="fa-solid fa-calendar"></i> <span id="selectedPatientAge">42
                                            yrs</span></span>
                                    <span><i class="fa-solid fa-stethoscope"></i> <span
                                            id="selectedPatientCondition">Parkinson's</span></span>
                                </div>
                            </div>
                            <button onclick="clearPatientSelection()"
                                style="padding: 8px 12px; background: white; border: 2px solid #e2e8f0; border-radius: 8px; color: #64748b; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                <i class="fa-solid fa-times"></i> Change
                            </button>
                        </div>
                    </div>

                    <!-- Patient Dropdown List -->
                    <div id="patientDropdownList"
                        style="max-height: 400px; overflow-y: auto; border-radius: 12px; border: 2px solid #e2e8f0; background: #f8fafc;">
                        <!-- Patient options will be rendered here -->
                    </div>

                    <!-- No results message -->
                    <div id="noResultsMessage"
                        style="display: none; padding: 40px; text-align: center; color: #94a3b8;">
                        <i class="fa-solid fa-search" style="font-size: 32px; margin-bottom: 12px; display: block;"></i>
                        <p style="font-size: 14px;">No patients found</p>
                    </div>
                </div>

                <!-- Add New Patient Button (for receptionist) -->
                <div id="addPatientButtonContainer" style="display: none;">
                    <div style="position: relative; margin: 40px 0;">
                        <div style="position: absolute; top: 50%; left: 0; right: 0; height: 1px; background: #e2e8f0;">
                        </div>
                        <div
                            style="position: relative; background: var(--light-bg); display: inline-block; padding: 0 16px;">
                            <span style="font-size: 13px; color: #94a3b8; font-weight: 600;">OR</span>
                        </div>
                    </div>

                    <button onclick="showAddNewPatient()"
                        style="display: inline-flex; align-items: center; gap: 12px; padding: 16px 32px; background: linear-gradient(135deg, var(--orange-primary), #dc6027); border: none; border-radius: 12px; color: white; font-size: 15px; font-weight: 700; cursor: pointer; box-shadow: 0 8px 20px rgba(244, 121, 32, 0.35); transition: all 0.3s;">
                        <div
                            style="width: 32px; height: 32px; background: rgba(255, 255, 255, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <i class="fa-solid fa-plus" style="font-size: 16px;"></i>
                        </div>
                        <span>Add New Patient</span>
                    </button>
                </div>
            </div>

            <!-- ADD NEW PATIENT FORM (Hidden by default) -->
            <div id="addNewPatientSection" style="display: none;">
                <div
                    style="background: white; border-radius: 16px; padding: 40px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12); max-width: 700px; margin: 0 auto;">
                    <div style="text-align: center; margin-bottom: 32px;">
                        <div
                            style="width: 72px; height: 72px; border-radius: 50%; background: linear-gradient(135deg, var(--orange-primary), #dc6027); margin: 0 auto 20px; display: flex; align-items: center; justify-content: center;">
                            <i class="fa-solid fa-user-plus" style="font-size: 32px; color: white;"></i>
                        </div>
                        <h2 style="font-size: 26px; font-weight: 700; color: #0f172a; margin-bottom: 8px;">Add New
                            Patient</h2>
                        <p style="font-size: 14px; color: #64748b;">Enter patient information to create their record</p>
                    </div>

                    <form id="newPatientForm" style="display: grid; gap: 20px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label
                                    style="display: block; font-size: 12px; font-weight: 600; color: #475569; margin-bottom: 8px;">FIRST
                                    NAME *</label>
                                <input type="text" required
                                    style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;"
                                    placeholder="John" onfocus="this.style.borderColor='var(--orange-primary)'"
                                    onblur="this.style.borderColor='#e2e8f0'">
                            </div>
                            <div>
                                <label
                                    style="display: block; font-size: 12px; font-weight: 600; color: #475569; margin-bottom: 8px;">LAST
                                    NAME *</label>
                                <input type="text" required
                                    style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;"
                                    placeholder="Doe" onfocus="this.style.borderColor='var(--orange-primary)'"
                                    onblur="this.style.borderColor='#e2e8f0'">
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label
                                    style="display: block; font-size: 12px; font-weight: 600; color: #475569; margin-bottom: 8px;">DATE
                                    OF BIRTH *</label>
                                <input type="date" required
                                    style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;"
                                    onfocus="this.style.borderColor='var(--orange-primary)'"
                                    onblur="this.style.borderColor='#e2e8f0'">
                            </div>
                            <div>
                                <label
                                    style="display: block; font-size: 12px; font-weight: 600; color: #475569; margin-bottom: 8px;">GENDER
                                    *</label>
                                <select required
                                    style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;"
                                    onfocus="this.style.borderColor='var(--orange-primary)'"
                                    onblur="this.style.borderColor='#e2e8f0'">
                                    <option value="">Select</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label
                                style="display: block; font-size: 12px; font-weight: 600; color: #475569; margin-bottom: 8px;">EMAIL
                                *</label>
                            <input type="email" required
                                style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;"
                                placeholder="john.doe@example.com"
                                onfocus="this.style.borderColor='var(--orange-primary)'"
                                onblur="this.style.borderColor='#e2e8f0'">
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label
                                    style="display: block; font-size: 12px; font-weight: 600; color: #475569; margin-bottom: 8px;">PHONE
                                    *</label>
                                <input type="tel" required
                                    style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;"
                                    placeholder="+1 (555) 123-4567"
                                    onfocus="this.style.borderColor='var(--orange-primary)'"
                                    onblur="this.style.borderColor='#e2e8f0'">
                            </div>
                            <div>
                                <label
                                    style="display: block; font-size: 12px; font-weight: 600; color: #475569; margin-bottom: 8px;">CONDITION
                                    *</label>
                                <select required
                                    style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;"
                                    onfocus="this.style.borderColor='var(--orange-primary)'"
                                    onblur="this.style.borderColor='#e2e8f0'">
                                    <option value="">Select</option>
                                    <option value="parkinsons">Parkinson's</option>
                                    <option value="depression">Depression</option>
                                    <option value="anxiety">Anxiety</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>

                        <div style="display: flex; gap: 12px; margin-top: 16px;">
                            <button type="button" onclick="cancelAddPatient()"
                                style="flex: 1; padding: 14px; border: 2px solid #e2e8f0; background: white; color: #64748b; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                Cancel
                            </button>
                            <button type="submit" onclick="submitNewPatient(event)"
                                style="flex: 2; padding: 14px; border: none; background: linear-gradient(135deg, var(--orange-primary), #dc6027); color: white; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(244, 121, 32, 0.3);">
                                <i class="fa-solid fa-check"></i> Create Patient
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- SELECTED PATIENT HEADER (Hidden by default) -->
        <div id="selectedPatientHeader"
            style="display: none; background: white; border-radius: 12px; padding: 24px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); border-left: 4px solid var(--orange-primary);">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div
                        style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, var(--orange-primary), #dc6027); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: 700;">
                        <span id="patientInitials">SM</span>
                    </div>
                    <div>
                        <h2 id="patientFullName"
                            style="font-size: 20px; font-weight: 700; color: #0f172a; margin-bottom: 4px;">Sarah
                            Mitchell</h2>
                        <div style="display: flex; gap: 16px; font-size: 13px; color: #64748b;">
                            <span><i class="fa-solid fa-calendar"></i> <span id="patientAge">42 years</span></span>
                            <span><i class="fa-solid fa-venus-mars"></i> <span id="patientGender">Female</span></span>
                            <span><i class="fa-solid fa-stethoscope"></i> <span id="patientCondition">Parkinson's
                                    Disease</span></span>
                        </div>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <!-- Patient Navigation Buttons (Doctor & Clinical Assistant only) -->
                    <div id="patientNavigation" class="patient-navigation" style="display: none;">
                        <button id="prevPatientBtn" class="nav-button" onclick="navigateToPreviousPatient()">
                            <i class="fa-solid fa-chevron-left"></i> Previous
                        </button>
                        <span id="patientCounter" class="patient-counter">1 / 10</span>
                        <button id="nextPatientBtn" class="nav-button" onclick="navigateToNextPatient()">
                            Next <i class="fa-solid fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- JOURNEY CONTENT (Hidden by default) -->
        <div id="journeyContent" style="display: none;">

            <!-- TABS -->
            <div class="tabs-container">
                <button class="tab-button active" id="todayTab" onclick="switchTab('today')">Today's Journey</button>
                <button class="tab-button" id="overallTab" onclick="switchTab('overall')">Overall Journey</button>
            </div>

            <!-- ROLE DISPLAY BANNER -->
            <div id="roleDisplayBanner" class="role-display-banner">
                <div class="role-display-left">
                    <div id="roleIcon" class="role-icon receptionist">
                        <i class="fa-solid fa-user-tie"></i>
                    </div>
                    <div class="role-info">
                        <h3 id="roleTitle">Receptionist</h3>
                        <p id="roleDescription">Manage patient records and appointments</p>
                    </div>
                </div>
                <div id="roleBadge" class="role-badge receptionist">Receptionist</div>
            </div>

            <!-- OVERALL JOURNEY TAB -->
            <div id="overallTabContent" class="tab-content" style="display: none;">

                <!-- ASSESSMENTS STACK -->
                <div id="assessmentsContainer"></div>

                <!-- IMPROVEMENTS CTA -->
                <div class="improvements-section">
                    <div class="improvements-text">
                        <h3>Track Your Progress</h3>
                        <p>Compare metrics across clinical assessments and see improvements over time</p>
                    </div>
                    <button class="improvements-btn" onclick="window.open('improvements.html', '_blank')">
                        See Improvements
                        <i class="fa-solid fa-arrow-right"></i>
                    </button>
                </div>

            </div>
            <!-- END OVERALL JOURNEY TAB -->

            <!-- TODAY'S JOURNEY TAB -->
            <div id="todayTabContent" class="tab-content active">
                <div class="today-header" id="todayHeaderSection" style="display: none;">
                    <h2>Today's Activity</h2>
                    <p id="todayDate"></p>
                </div>

                <div id="todayContent">
                    <!-- Today's content will be rendered here -->
                </div>
            </div>
            <!-- END TODAY'S JOURNEY TAB -->

            <!-- WORKING ACTIVE JOURNEY TAB -->
            <div id="workingTabContent" class="tab-content" style="display: none;">
                <div class="patient-info-banner">
                    <h2>New Patient Check-In</h2>
                    <p>Patient has just arrived at the clinic</p>
                    <div class="patient-meta">
                        <div class="patient-meta-item">
                            <div class="patient-meta-label">Patient Name</div>
                            <div class="patient-meta-value">Sarah Mitchell</div>
                        </div>
                        <div class="patient-meta-item">
                            <div class="patient-meta-label">Check-In Time</div>
                            <div class="patient-meta-value">10:30 AM</div>
                        </div>
                        <div class="patient-meta-item">
                            <div class="patient-meta-label">Assessment</div>
                            <div class="patient-meta-value">Clinical Assessment 2</div>
                        </div>
                        <div class="patient-meta-item">
                            <div class="patient-meta-label">Status</div>
                            <div class="patient-meta-value">Ready to Begin</div>
                        </div>
                    </div>
                </div>

                <div id="workingBlocksContainer" class="blocks-container"></div>

                <div class="permission-legend">
                    <h3>Permission Guide</h3>
                    <div class="legend-items">
                        <div class="legend-item">
                            <span class="legend-badge ready">Can Start</span>
                            <span class="legend-text">You can initiate this assessment</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-badge view-only">View Only</span>
                            <span class="legend-text">Visible but requires doctor permission</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-badge locked">Locked</span>
                            <span class="legend-text">Complete previous steps first</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- END WORKING ACTIVE JOURNEY TAB -->

            <!-- DEVICE LOCKING TAB -->
            <div id="deviceTabContent" class="tab-content" style="display: none;">
                <div class="patient-info-banner">
                    <h2>Device Activation & Payment Flow</h2>
                    <p>EEG Device locking mechanism based on payment status</p>
                    <div class="patient-meta">
                        <div class="patient-meta-item">
                            <div class="patient-meta-label">Patient Name</div>
                            <div class="patient-meta-value">Sarah Mitchell</div>
                        </div>
                        <div class="patient-meta-item">
                            <div class="patient-meta-label">Assessment</div>
                            <div class="patient-meta-value">Clinical Assessment 2</div>
                        </div>
                        <div class="patient-meta-item">
                            <div class="patient-meta-label">Device Required</div>
                            <div class="patient-meta-value">EEG Headset</div>
                        </div>
                    </div>
                </div>

                <!-- STATE 1: PAYMENT NOT PROCESSED - DEVICE LOCKED -->
                <div class="device-state-section">
                    <div class="device-state-header locked-state">
                        <div class="state-icon">
                            <i class="fa-solid fa-lock"></i>
                        </div>
                        <div class="state-info">
                            <h3>State 1: Payment Not Processed</h3>
                            <p>Device activation blocked until payment confirmation</p>
                        </div>
                        <div class="state-badge locked-badge">
                            <i class="fa-solid fa-circle-xmark"></i>
                            Device Locked
                        </div>
                    </div>
                    <div id="deviceLockedContainer" class="blocks-container" style="margin-top: 20px;"></div>
                </div>

                <!-- STATE 2: PAYMENT PROCESSED - DEVICE UNLOCKED -->
                <div class="device-state-section" style="margin-top: 32px;">
                    <div class="device-state-header unlocked-state">
                        <div class="state-icon">
                            <i class="fa-solid fa-lock-open"></i>
                        </div>
                        <div class="state-info">
                            <h3>State 2: Payment Processed</h3>
                            <p>Device activated and ready for assessment</p>
                        </div>
                        <div class="state-badge unlocked-badge">
                            <i class="fa-solid fa-circle-check"></i>
                            Device Active
                        </div>
                    </div>
                    <div id="deviceUnlockedContainer" class="blocks-container" style="margin-top: 20px;"></div>
                </div>

                <!-- DEVICE INFO -->
                <div class="permission-legend" style="margin-top: 32px;">
                    <h3>Payment & Device Activation Flow</h3>
                    <div class="legend-items">
                        <div class="legend-item">
                            <span class="legend-badge locked"
                                style="background: rgba(239, 68, 68, 0.15); color: #dc2626;">
                                <i class="fa-solid fa-lock"></i> Locked
                            </span>
                            <span class="legend-text">Payment pending - Device cannot be activated</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-badge ready">
                                <i class="fa-solid fa-lock-open"></i> Active
                            </span>
                            <span class="legend-text">Payment confirmed - Device ready for use</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-badge view-only">
                                <i class="fa-solid fa-eye"></i> Visible
                            </span>
                            <span class="legend-text">All roles can see payment status</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- END DEVICE LOCKING TAB -->

        </div>
        <!-- END JOURNEY CONTENT -->

    </div>
    <!-- END CONTAINER -->

    <!-- DEVICE ACTIVATION MODAL -->
    <div id="deviceActivationModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 16px; padding: 40px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);" onclick="event.stopPropagation()">
            <!-- Header -->
            <div style="text-align: center; margin-bottom: 32px;">
                <div style="display: inline-flex; align-items: center; justify-content: center; width: 80px; height: 80px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 50%; margin-bottom: 16px;">
                    <i class="fa-solid fa-check-circle" style="font-size: 40px; color: white;"></i>
                </div>
                <h2 style="font-size: 24px; font-weight: 700; color: #0f172a; margin: 0 0 8px 0;">Payment Confirmed</h2>
                <p style="font-size: 14px; color: #64748b; margin: 0;">Ready to activate device for brain mapping</p>
            </div>

            <!-- Patient Info -->
            <div style="background: #f0fdf4; border: 2px solid #86efac; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                <p style="font-size: 12px; font-weight: 600; color: #065f46; margin: 0 0 8px 0;">PATIENT</p>
                <p id="activationPatientName" style="font-size: 18px; font-weight: 700; color: #0f172a; margin: 0;">James Wilson</p>
            </div>

            <!-- Step 1: Generate Key -->
            <div id="activationStep1">
                <div style="background: #fffbeb; border: 2px solid #fde047; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                    <p style="font-size: 13px; color: #713f12; margin: 0; line-height: 1.6;">
                        <i class="fa-solid fa-info-circle" style="margin-right: 8px;"></i>
                        <strong>Device Activation Required:</strong> Generate a unique serial key to activate the EEG device for this patient.
                    </p>
                </div>

                <button onclick="generateSerialKey()" style="width: 100%; background: linear-gradient(135deg, #f97316, #ea580c); color: white; padding: 16px; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3); transition: all 0.2s;">
                    <i class="fa-solid fa-key" style="margin-right: 8px;"></i>
                    Generate Serial Key
                </button>
            </div>

            <!-- Step 2: Show Key and Proceed -->
            <div id="activationStep2" style="display: none;">
                <div style="background: #eff6ff; border: 2px solid #93c5fd; border-radius: 12px; padding: 24px; margin-bottom: 24px; text-align: center;">
                    <p style="font-size: 12px; font-weight: 600; color: #1e3a8a; margin: 0 0 12px 0; text-transform: uppercase; letter-spacing: 1px;">Serial Key Generated</p>
                    <div style="background: white; border: 2px solid #3b82f6; border-radius: 8px; padding: 20px; margin-bottom: 16px;">
                        <p id="serialKeyDisplay" style="font-size: 28px; font-weight: 900; color: #1e3a8a; margin: 0; letter-spacing: 2px; font-family: 'Courier New', monospace;">XXXX-XXXX-XXXX</p>
                    </div>
                    <p style="font-size: 13px; color: #1e40af; margin: 0; line-height: 1.6;">
                        <i class="fa-solid fa-lightbulb" style="margin-right: 6px;"></i>
                        Enter this key in the EEG device to activate it for this patient.
                    </p>
                </div>

                <button onclick="proceedToBrainMapping()" style="width: 100%; background: linear-gradient(135deg, #f97316, #ea580c); color: white; padding: 16px; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3); transition: all 0.2s; margin-bottom: 12px;">
                    <i class="fa-solid fa-arrow-right" style="margin-right: 8px;"></i>
                    Proceed to Brain Mapping
                </button>

                <button onclick="closeDeviceActivationModal()" style="width: 100%; background: #f3f4f6; color: #64748b; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- FNON ASSESSMENT MODAL -->
    <div id="fnonAssessmentModal" class="assessment-modal" onclick="closeAssessmentModal(event)">
        <div class="assessment-modal-content" onclick="event.stopPropagation()">
            <div class="assessment-modal-header">
                <div class="assessment-modal-title">
                    <h2>FNON Assessment</h2>
                    <p id="assessmentPatientName">Patient Name</p>
                </div>
                <button class="assessment-modal-close" onclick="closeAssessmentModal()">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>

            <div class="assessment-modal-body">
                <!-- FNON Assessment Header -->
                <div style="margin-bottom: 24px;">
                    <h2 style="font-size: 24px; font-weight: 900; color: #0f172a; margin: 0 0 8px 0;">FNON Assessment
                    </h2>
                    <p style="font-size: 14px; color: #64748b; margin: 0;">Functional Network of Neurons - Assessment
                        Overview</p>
                </div>

                <!-- FNON Assessment Read-Only Display -->
                <div
                    style="border-radius: 12px; border: 2px solid #bfdbfe; background: linear-gradient(135deg, #eff6ff 0%, #eff6ff 100%); padding: 24px; margin-bottom: 32px;">
                    <div
                        style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid #93c5fd;">
                        <div>
                            <h3 style="font-size: 20px; font-weight: 900; color: #1e3a8a; margin: 0 0 4px 0;">Assessment
                                Overview</h3>
                            <p style="font-size: 13px; color: #2563eb; margin: 0;">Functional Network Assessment - Read
                                Only</p>
                        </div>
                        <i class="fa-solid fa-brain" style="font-size: 32px; color: #3b82f6; opacity: 0.7;"></i>
                    </div>

                    <div
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-bottom: 24px;">
                        <div
                            style="background: white; border-radius: 8px; border-left: 4px solid #3b82f6; padding: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                            <p
                                style="font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #475569; margin: 0 0 8px 0;">
                                Assessment Status</p>
                            <p style="font-size: 22px; font-weight: 900; color: #0f172a; margin: 0;">Assessment Ready
                            </p>
                            <p style="font-size: 12px; color: #64748b; margin: 4px 0 0 0;">Review the questions below to
                                understand this assessment</p>
                        </div>
                        <div
                            style="background: white; border-radius: 8px; border-left: 4px solid #2563eb; padding: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                            <p
                                style="font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #475569; margin: 0 0 8px 0;">
                                Assessment Type</p>
                            <p style="font-size: 18px; font-weight: 900; color: #2563eb; margin: 0;">Neural Network
                                Evaluation</p>
                            <p style="font-size: 12px; color: #64748b; margin: 4px 0 0 0;">7 functional networks
                                assessment</p>
                        </div>
                    </div>

                    <!-- FNON Assessment Questions -->
                    <div style="background: white; border-radius: 8px; border: 1px solid #e2e8f0; padding: 20px;">
                        <h4 style="font-weight: 700; color: #0f172a; margin: 0 0 16px 0; font-size: 16px;">Assessment Questions</h4>
                        <div>
                            <div style="display: flex; gap: 16px; padding-bottom: 16px; margin-bottom: 16px; border-bottom: 1px solid #f1f5f9;">
                                <div style="width: 32px; height: 32px; border-radius: 50%; background: #3b82f6; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 12px; flex-shrink: 0;">1</div>
                                <div style="flex: 1;">
                                    <p style="font-weight: 700; color: #0f172a; margin: 0 0 6px 0; font-size: 15px;">
                                        Motor Network Function</p>
                                    <p style="font-size: 13px; color: #475569; margin: 0 0 8px 0; line-height: 1.5;">How
                                        well can you perform coordinated movements and physical tasks?</p>
                                    <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                        <span style="font-size: 12px; font-weight: 600; color: #475569;">Scoring:</span>
                                        <span
                                            style="background: #0ea5e9; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">0=Normal</span>
                                        <span
                                            style="background: #f59e0b; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">1=Mild</span>
                                        <span
                                            style="background: #ef4444; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">2=Deficit</span>
                                    </div>
                                </div>
                            </div>

                            <div
                                style="display: flex; gap: 16px; padding-bottom: 16px; margin-bottom: 16px; border-bottom: 1px solid #f1f5f9;">
                                <div
                                    style="width: 32px; height: 32px; border-radius: 50%; background: #3b82f6; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 12px; flex-shrink: 0;">
                                    2</div>
                                <div style="flex: 1;">
                                    <p style="font-weight: 700; color: #0f172a; margin: 0 0 6px 0; font-size: 15px;">
                                        Cognitive Processing Speed</p>
                                    <p style="font-size: 13px; color: #475569; margin: 0 0 8px 0; line-height: 1.5;">How
                                        quickly can you process information and make decisions?</p>
                                    <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                        <span style="font-size: 12px; font-weight: 600; color: #475569;">Scoring:</span>
                                        <span
                                            style="background: #0ea5e9; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">0=Normal</span>
                                        <span
                                            style="background: #f59e0b; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">1=Mild</span>
                                        <span
                                            style="background: #ef4444; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">2=Deficit</span>
                                    </div>
                                </div>
                            </div>

                            <div
                                style="display: flex; gap: 16px; padding-bottom: 16px; margin-bottom: 16px; border-bottom: 1px solid #f1f5f9;">
                                <div
                                    style="width: 32px; height: 32px; border-radius: 50%; background: #3b82f6; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 12px; flex-shrink: 0;">
                                    3</div>
                                <div style="flex: 1;">
                                    <p style="font-weight: 700; color: #0f172a; margin: 0 0 6px 0; font-size: 15px;">
                                        Memory & Recall</p>
                                    <p style="font-size: 13px; color: #475569; margin: 0 0 8px 0; line-height: 1.5;">How
                                        effectively do you recall recent and past events?</p>
                                    <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                        <span style="font-size: 12px; font-weight: 600; color: #475569;">Scoring:</span>
                                        <span
                                            style="background: #0ea5e9; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">0=Normal</span>
                                        <span
                                            style="background: #f59e0b; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">1=Mild</span>
                                        <span
                                            style="background: #ef4444; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">2=Deficit</span>
                                    </div>
                                </div>
                            </div>

                            <div
                                style="display: flex; gap: 16px; padding-bottom: 16px; margin-bottom: 16px; border-bottom: 1px solid #f1f5f9;">
                                <div
                                    style="width: 32px; height: 32px; border-radius: 50%; background: #3b82f6; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 12px; flex-shrink: 0;">
                                    4</div>
                                <div style="flex: 1;">
                                    <p style="font-weight: 700; color: #0f172a; margin: 0 0 6px 0; font-size: 15px;">
                                        Attention & Focus</p>
                                    <p style="font-size: 13px; color: #475569; margin: 0 0 8px 0; line-height: 1.5;">How
                                        well can you concentrate on a single task?</p>
                                    <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                        <span style="font-size: 12px; font-weight: 600; color: #475569;">Scoring:</span>
                                        <span
                                            style="background: #0ea5e9; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">0=Normal</span>
                                        <span
                                            style="background: #f59e0b; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">1=Mild</span>
                                        <span
                                            style="background: #ef4444; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">2=Deficit</span>
                                    </div>
                                </div>
                            </div>

                            <div
                                style="display: flex; gap: 16px; padding-bottom: 16px; margin-bottom: 16px; border-bottom: 1px solid #f1f5f9;">
                                <div
                                    style="width: 32px; height: 32px; border-radius: 50%; background: #3b82f6; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 12px; flex-shrink: 0;">
                                    5</div>
                                <div style="flex: 1;">
                                    <p style="font-weight: 700; color: #0f172a; margin: 0 0 6px 0; font-size: 15px;">
                                        Language & Communication</p>
                                    <p style="font-size: 13px; color: #475569; margin: 0 0 8px 0; line-height: 1.5;">How
                                        clear and effective is your verbal and written communication?</p>
                                    <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                        <span style="font-size: 12px; font-weight: 600; color: #475569;">Scoring:</span>
                                        <span
                                            style="background: #0ea5e9; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">0=Normal</span>
                                        <span
                                            style="background: #f59e0b; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">1=Mild</span>
                                        <span
                                            style="background: #ef4444; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">2=Deficit</span>
                                    </div>
                                </div>
                            </div>

                            <div
                                style="display: flex; gap: 16px; padding-bottom: 16px; margin-bottom: 16px; border-bottom: 1px solid #f1f5f9;">
                                <div
                                    style="width: 32px; height: 32px; border-radius: 50%; background: #3b82f6; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 12px; flex-shrink: 0;">
                                    6</div>
                                <div style="flex: 1;">
                                    <p style="font-weight: 700; color: #0f172a; margin: 0 0 6px 0; font-size: 15px;">
                                        Emotional Regulation</p>
                                    <p style="font-size: 13px; color: #475569; margin: 0 0 8px 0; line-height: 1.5;">How
                                        well do you manage emotions and respond to stress?</p>
                                    <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                        <span style="font-size: 12px; font-weight: 600; color: #475569;">Scoring:</span>
                                        <span
                                            style="background: #0ea5e9; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">0=Normal</span>
                                        <span
                                            style="background: #f59e0b; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">1=Mild</span>
                                        <span
                                            style="background: #ef4444; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">2=Deficit</span>
                                    </div>
                                </div>
                            </div>

                            <div style="display: flex; gap: 16px;">
                                <div
                                    style="width: 32px; height: 32px; border-radius: 50%; background: #3b82f6; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 12px; flex-shrink: 0;">
                                    7</div>
                                <div style="flex: 1;">
                                    <p style="font-weight: 700; color: #0f172a; margin: 0 0 6px 0; font-size: 15px;">
                                        Sleep & Autonomic Function</p>
                                    <p style="font-size: 13px; color: #475569; margin: 0 0 8px 0; line-height: 1.5;">How
                                        satisfied are you with your sleep patterns and autonomic regulation?</p>
                                    <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                        <span style="font-size: 12px; font-weight: 600; color: #475569;">Scoring:</span>
                                        <span
                                            style="background: #0ea5e9; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">0=Normal</span>
                                        <span
                                            style="background: #f59e0b; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">1=Mild</span>
                                        <span
                                            style="background: #ef4444; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">2=Deficit</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Information Box -->
                    <div
                        style="margin-top: 16px; padding: 16px; background: #dbeafe; border: 1px solid #93c5fd; border-radius: 8px;">
                        <p style="font-size: 12px; color: #1e3a8a; margin: 0;"><strong> Note:</strong> This assessment
                            evaluates functional brain networks. Each question is scored on a scale from 0-2, where 0
                            indicates normal function, 1 indicates mild concerns, and 2 indicates significant deficits.
                            This assessment helps create a personalized treatment plan.</p>
                    </div>
                </div>

                <!-- Section A: Clinical Checklist - Read Only -->
                <div style="border-radius: 8px; overflow: hidden; border: 1px solid #e2e8f0; margin-bottom: 32px;">
                    <div
                        style="background: #1e293b; color: white; padding: 16px; font-weight: 700; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 15px; font-weight: 700;">Section A: Clinical Checklist</span>
                        <span style="font-size: 11px; font-weight: 400; opacity: 0.7;">0=Normal, 1=Mild,
                            2=Deficit</span>
                    </div>
                    <div style="padding: 24px; background: white;">
                        <div style="margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid #e2e8f0;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                <h3 style="font-weight: 700; font-size: 16px; color: #ea580c; margin: 0;">Dorsal
                                    Attention Mapping Interface (DAMI)</h3>
                            </div>
                            <p style="font-size: 12px; color: #64748b; font-style: italic; margin: 0 0 12px 0;"><i class="fa-solid fa-triangle-exclamation"></i> Signs: Hypervigilance, sustained attention deficits, distractibility</p>
                            <div style="display: grid; grid-template-columns: 1fr; gap: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 13px; background: #f8fafc; padding: 12px; border-radius: 6px; border-left: 4px solid #93c5fd;">
                                    <span style="font-weight: 500; color: #475569;">Attention Orientation Stability</span>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <span style="font-size: 11px; font-weight: 600; color: #475569;">Score:</span>
                                        <span
                                            style="background: #0ea5e9; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; box-shadow: 0 0 8px rgba(14, 165, 233, 0.6);">1
                                            </span>
                                        <span
                                            style="background: #0ea5e9; opacity: 0.4; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">1</span>
                                        <span
                                            style="background: #ef4444; opacity: 0.4; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">2</span>
                                    </div>
                                </div>
                                <div
                                    style="display: flex; justify-content: space-between; align-items: center; font-size: 13px; background: #f8fafc; padding: 12px; border-radius: 6px; border-left: 4px solid #93c5fd;">
                                    <span style="font-weight: 500; color: #475569;">Attention Span Capacity</span>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <span style="font-size: 11px; font-weight: 600; color: #475569;">Score:</span>
                                        <span
                                            style="background: #0ea5e9; opacity: 0.4; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">0</span>
                                        <span
                                            style="background: #f59e0b; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; box-shadow: 0 0 8px rgba(245, 158, 11, 0.6);">1
                                            </span>
                                        <span
                                            style="background: #ef4444; opacity: 0.4; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">2</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid #e2e8f0;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                <h3 style="font-weight: 700; font-size: 16px; color: #ea580c; margin: 0;">Central
                                    Executive Network (CEN)</h3>
                            </div>
                            <p style="font-size: 12px; color: #64748b; font-style: italic; margin: 0 0 12px 0;"><i class="fa-solid fa-triangle-exclamation"></i> Signs: Impaired decision-making, working memory deficits, executive dysfunction</p>
                            <div style="display: grid; grid-template-columns: 1fr; gap: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 13px; background: #f8fafc; padding: 12px; border-radius: 6px; border-left: 4px solid #93c5fd;">
                                    <span style="font-weight: 500; color: #475569;">Working Memory Function</span>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <span style="font-size: 11px; font-weight: 600; color: #475569;">Score:</span>
                                        <span
                                            style="background: #0ea5e9; opacity: 0.4; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">0</span>
                                        <span
                                            style="background: #f59e0b; opacity: 0.4; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">1</span>
                                        <span
                                            style="background: #ef4444; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; box-shadow: 0 0 8px rgba(239, 68, 68, 0.6);">2
                                            </span>
                                    </div>
                                </div>
                                <div
                                    style="display: flex; justify-content: space-between; align-items: center; font-size: 13px; background: #f8fafc; padding: 12px; border-radius: 6px; border-left: 4px solid #93c5fd;">
                                    <span style="font-weight: 500; color: #475569;">Planning & Decision Making</span>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <span style="font-size: 11px; font-weight: 600; color: #475569;">Score:</span>
                                        <span
                                            style="background: #0ea5e9; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; box-shadow: 0 0 8px rgba(14, 165, 233, 0.6);">0
                                            </span>
                                        <span
                                            style="background: #f59e0b; opacity: 0.4; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">1</span>
                                        <span
                                            style="background: #ef4444; opacity: 0.4; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">2</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="margin-bottom: 24px;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                <h3 style="font-weight: 700; font-size: 16px; color: #ea580c; margin: 0;">Limbic
                                    Emotional Processing</h3>
                            </div>
                            <p style="font-size: 12px; color: #64748b; font-style: italic; margin: 0 0 12px 0;"><i class="fa-solid fa-triangle-exclamation"></i> Signs: Emotional lability, impaired emotional recognition, heightened reactivity</p>
                            <div style="display: grid; grid-template-columns: 1fr; gap: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 13px; background: #f8fafc; padding: 12px; border-radius: 6px; border-left: 4px solid #93c5fd;">
                                    <span style="font-weight: 500; color: #475569;">Emotional Regulation Ability</span>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <span style="font-size: 11px; font-weight: 600; color: #475569;">Score:</span>
                                        <span
                                            style="background: #0ea5e9; opacity: 0.4; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">0</span>
                                        <span
                                            style="background: #f59e0b; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; box-shadow: 0 0 8px rgba(245, 158, 11, 0.6);">1
                                            </span>
                                        <span
                                            style="background: #ef4444; opacity: 0.4; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px;">2</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Assessment Summary -->
                        <div
                            style="margin-top: 24px; padding: 24px; background: linear-gradient(135deg, #f8fafc 0%, #eff6ff 100%); border-radius: 8px; border: 2px solid #e2e8f0;">
                            <div
                                style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                                <h3 style="font-size: 18px; font-weight: 700; color: #0f172a; margin: 0;">
                                    <i class="fa-solid fa-chart-line" style="margin-right: 8px; color: #ea580c;"></i>
                                    Assessment Summary
                                </h3>
                                <div style="text-align: right;">
                                    <p
                                        style="font-size: 11px; color: #64748b; text-transform: uppercase; font-weight: 600; margin: 0;">
                                        Assessed by</p>
                                    <p style="font-size: 13px; font-weight: 700; color: #0f172a; margin: 4px 0 0 0;">Dr.
                                        James Wilson</p>
                                </div>
                            </div>

                            <div
                                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 16px;">
                                <div
                                    style="background: white; border-radius: 8px; border-left: 4px solid #2563eb; padding: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                                    <p
                                        style="font-size: 11px; font-weight: 700; text-transform: uppercase; color: #64748b; margin: 0 0 6px 0;">
                                        Total Score</p>
                                    <p style="font-size: 32px; font-weight: 900; color: #0f172a; margin: 0;">14</p>
                                    <p style="font-size: 11px; color: #64748b; margin: 4px 0 0 0;">out of 42 points</p>
                                </div>

                                <div
                                    style="background: white; border-radius: 8px; border-left: 4px solid #475569; padding: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                                    <p
                                        style="font-size: 11px; font-weight: 700; text-transform: uppercase; color: #64748b; margin: 0 0 6px 0;">
                                        Score Percentage</p>
                                    <p style="font-size: 32px; font-weight: 900; color: #0f172a; margin: 0;">46.7%</p>
                                    <p style="font-size: 11px; color: #64748b; margin: 4px 0 0 0;">deficit index</p>
                                </div>

                                <div
                                    style="background: white; border-radius: 8px; border-left: 4px solid #ea580c; padding: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                                    <p
                                        style="font-size: 11px; font-weight: 700; text-transform: uppercase; color: #64748b; margin: 0 0 6px 0;">
                                        Assessment Date</p>
                                    <p style="font-size: 16px; font-weight: 900; color: #0f172a; margin: 0;">Feb 2, 2026
                                    </p>
                                    <p style="font-size: 11px; color: #64748b; margin: 4px 0 0 0;">completed</p>
                                </div>
                            </div>

                            <div
                                style="padding: 16px; background: #fed7aa; border: 2px solid #fb923c; border-radius: 8px;">
                                <p style="font-weight: 700; margin: 0 0 6px 0; color: #7c2d12;">
                                    <i class="fa-solid fa-stethoscope" style="margin-right: 8px;"></i>
                                    Clinical Interpretation
                                </p>
                                <p style="font-size: 13px; font-weight: 600; margin: 0; color: #92400e;">Moderate -
                                    Several areas need attention</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div
                    style="margin-top: 32px; padding-top: 24px; border-top: 2px solid #e2e8f0; text-align: center; color: #64748b; font-size: 12px;">
                    <p style="margin: 0 0 4px 0;">This assessment report is confidential and intended for clinical use
                        only.</p>
                    <p style="margin: 0;">SOZ Brain Center - FNON Assessment</p>
                </div>
            </div>
        </div>
    </div>
    <!-- END FNON ASSESSMENT MODAL -->

    <!-- DEVICE ACTIVATION MODAL -->
    <div id="deviceActivationModal" class="assessment-modal" style="display: none;">
        <div class="assessment-modal-content" style="max-width: 600px;" onclick="event.stopPropagation()">
            <div class="assessment-modal-header">
                <div class="assessment-modal-title">
                    <h2><i class="fa-solid fa-unlock-keyhole"></i> Device Activation</h2>
                    <p>Activate your EEG device for brain mapping assessment</p>
                </div>
                <button class="close-modal-btn" onclick="closeDeviceActivationModal()">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <div class="assessment-modal-body" style="padding: 32px;">
                <!-- Step 1: Payment Verification -->
                <div id="activationStep1" class="activation-step">
                    <div class="device-state-header unlocked-state" style="margin-bottom: 24px;">
                        <div class="state-icon">
                            <i class="fa-solid fa-circle-check"></i>
                        </div>
                        <div class="state-info">
                            <h3>Payment Verified</h3>
                            <p>Your payment has been confirmed. Ready to activate device.</p>
                        </div>
                    </div>
                    
                    <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="display: grid; gap: 12px;">
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e2e8f0;">
                                <span style="color: #64748b; font-size: 14px;">Device Type</span>
                                <span style="color: #0f172a; font-weight: 600; font-size: 14px;">EEG Headset</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e2e8f0;">
                                <span style="color: #64748b; font-size: 14px;">Assessment</span>
                                <span style="color: #0f172a; font-weight: 600; font-size: 14px;">Brain Mapping</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                                <span style="color: #64748b; font-size: 14px;">Patient</span>
                                <span style="color: #0f172a; font-weight: 600; font-size: 14px;" id="activationPatientName">James Wilson</span>
                            </div>
                        </div>
                    </div>
                    
                    <button class="block-action-btn start" onclick="generateSerialKey()" style="width: 100%; margin-top: 12px;">
                        <i class="fa-solid fa-key"></i> Generate Activation Key
                    </button>
                </div>

                <!-- Step 2: Serial Key Generation -->
                <div id="activationStep2" class="activation-step" style="display: none;">
                    <div class="device-state-header unlocked-state" style="margin-bottom: 24px;">
                        <div class="state-icon">
                            <i class="fa-solid fa-key"></i>
                        </div>
                        <div class="state-info">
                            <h3>Device Activated Successfully</h3>
                            <p>Your EEG device has been activated and is ready to use</p>
                        </div>
                    </div>

                    <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 24px; border-radius: 12px; margin-bottom: 24px; text-align: center;">
                        <div style="color: rgba(255, 255, 255, 0.9); font-size: 12px; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;">Device Serial Key</div>
                        <div id="serialKeyDisplay" style="font-family: 'Courier New', monospace; font-size: 28px; font-weight: 700; color: white; letter-spacing: 4px; margin: 12px 0;">XXXX-XXXX-XXXX</div>
                        <div style="color: rgba(255, 255, 255, 0.8); font-size: 11px; margin-top: 8px;"><i class="fa-solid fa-circle-info"></i> Keep this key safe for device authentication</div>
                    </div>

                    <div style="background: #fef3c7; border: 1px solid #fbbf24; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="display: flex; gap: 12px; align-items: start;">
                            <i class="fa-solid fa-lightbulb" style="color: #f59e0b; font-size: 20px; margin-top: 2px;"></i>
                            <div>
                                <div style="font-weight: 600; color: #92400e; font-size: 13px; margin-bottom: 4px;">Next Steps</div>
                                <div style="color: #92400e; font-size: 12px; line-height: 1.5;">
                                    Your device is now active. You can proceed to start the brain mapping assessment.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px;">
                        <button class="block-action-btn" onclick="closeDeviceActivationModal()" style="flex: 1; background: #94a3b8; color: white;">
                            <i class="fa-solid fa-xmark"></i> Close
                        </button>
                        <button class="block-action-btn start" onclick="proceedToBrainMapping()" style="flex: 2;">
                            <i class="fa-solid fa-play"></i> Start Brain Mapping
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- END DEVICE ACTIVATION MODAL -->

    <!-- ANAMNESIS MODAL -->
    <div id="anamnesisModal" class="assessment-modal" onclick="closeAnamnesisModal(event)">
        <div class="assessment-modal-content" onclick="event.stopPropagation()">
            <div class="assessment-modal-header">
                <div class="assessment-modal-title">
                    <h2>Anamnesis Assessment</h2>
                    <p>Patient symptoms and medical history</p>
                </div>
                <button class="assessment-modal-close" onclick="closeAnamnesisModal(event)">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="assessment-modal-body" id="anamnesisModalBody">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>
    <!-- END ANAMNESIS MODAL -->

    <!-- PRS ASSESSMENT MODAL -->
    <div id="prsAssessmentModal" class="assessment-modal" onclick="closePrsModal(event)">
        <div class="assessment-modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;"
            onclick="event.stopPropagation()">
            <div class="assessment-modal-header">
                <div class="assessment-modal-title">
                    <h2>PRS Assessment</h2>
                    <p id="prsPatientName">Patient Name</p>
                </div>
                <button class="assessment-modal-close" onclick="closePrsModal()">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>

            <div class="assessment-modal-body" id="prsModalBody">
                <!-- PRS content will be rendered here -->
            </div>
        </div>
    </div>
    <!-- END PRS ASSESSMENT MODAL -->

    <!-- DOCTOR'S NOTES MODAL -->
    <div id="doctorNotesModal" class="assessment-modal" onclick="closeDoctorNotesModal(event)" style="z-index: 1001;">
        <div class="assessment-modal-content" onclick="event.stopPropagation()">
            <div class="assessment-modal-header">
                <h2>Doctor's Notes & Clinical Observations</h2>
                <button class="assessment-modal-close" onclick="closeDoctorNotesModal()" title="Close modal">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>

            <div class="assessment-modal-body" id="doctorNotesModalBody">
                <!-- Doctor's Notes content will be rendered here -->
            </div>
        </div>
    </div>
    <!-- END DOCTOR'S NOTES MODAL -->
    
    <!-- EEG PDF VIEWER MODAL -->
    <div id="eegPdfViewerModal" class="assessment-modal" onclick="closeEegPdfViewer(event)" style="z-index: 1002;">
        <div class="assessment-modal-content" style="width: 95vw; height: 95vh; max-width: none; max-height: none; display: flex; flex-direction: column;" onclick="event.stopPropagation()">
            <div class="assessment-modal-header">
                <div class="assessment-modal-title">
                    <h2>Here is your EEG Report</h2>
                </div>
                <button class="assessment-modal-close" onclick="closeEegPdfViewer()" title="Close modal">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div style="flex: 1; overflow: auto; background: #f1f5f9; padding: 16px;">
                <iframe id="eegReportFrame" src="" style="width: 100%; height: 100%; border: none; border-radius: 8px;"></iframe>
            </div>
            <div class="assessment-modal-header" style="border-top: 1px solid #e2e8f0;">
                <button class="assessment-modal-close" onclick="closeEegPdfViewer()" style="background: #64748b; color: white; padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold;">
                    <i class="fa-solid fa-arrow-left mr-2"></i>Close
                </button>
            </div>
        </div>
    </div>
    <!-- END EEG PDF VIEWER MODAL -->

    <!-- PAYMENT OVERRIDE MODAL -->
    <div id="paymentOverrideModal" class="payment-override-modal" onclick="closePaymentOverrideModal(event)">
        <div class="payment-override-content" onclick="event.stopPropagation()">
            <div class="payment-override-header" id="overrideModalHeader">
                <div class="payment-override-header-icon">
                    <i class="fa-solid fa-credit-card"></i>
                </div>
                <div class="payment-override-header-text">
                    <h3>Payment Override Request</h3>
                    <p>Brain Mapping Assessment</p>
                </div>
            </div>
            <div class="payment-override-body">
                <!-- Form View -->
                <div id="overrideFormView" class="payment-override-form">
                    <div class="payment-override-warning">
                        <i class="fa-solid fa-triangle-exclamation"></i>
                        <div class="payment-override-warning-text">
                            <strong>Important Notice</strong>
                            You are about to override the payment requirement for this assessment. 
                            The patient has not completed their payment for this service.
                        </div>
                    </div>
                    <div class="payment-override-consent">
                        <div class="payment-override-consent-title">
                            <i class="fa-solid fa-file-signature"></i>
                            Doctor's Consent Declaration
                        </div>
                        <div class="payment-override-consent-text">
                            By proceeding with this override, you acknowledge and agree to the following terms:
                        </div>
                        <ul style="font-size: 13px; color: #475569; margin: 0 0 16px 20px; line-height: 1.8;">
                            <li>The patient's payment is currently pending for this assessment</li>
                            <li>You are authorizing the Brain Mapping assessment to proceed without payment</li>
                            <li>Sozo Medical reserves the right to charge the override amount to your account</li>
                            <li>This action will be logged in the patient's record for audit purposes</li>
                        </ul>
                        <div class="payment-override-checkbox">
                            <input type="checkbox" id="overrideConsentCheckbox" onchange="toggleOverrideButton()">
                            <label for="overrideConsentCheckbox">
                                I, as the attending physician, authorize this payment override and accept responsibility for any charges that may be applied to my account by Sozo Medical.
                            </label>
                        </div>
                    </div>
                    <div class="payment-override-footer">
                        <button class="payment-override-btn payment-override-btn-cancel" onclick="closePaymentOverrideModal()">
                            <i class="fa-solid fa-xmark"></i>
                            Cancel
                        </button>
                        <button id="confirmOverrideBtn" class="payment-override-btn payment-override-btn-confirm" onclick="confirmPaymentOverride()" disabled>
                            <i class="fa-solid fa-unlock"></i>
                            Confirm Override
                        </button>
                    </div>
                </div>
                
                <!-- Success View -->
                <div id="overrideSuccessView" class="payment-override-success">
                    <div class="payment-override-success-icon">
                        <i class="fa-solid fa-check"></i>
                    </div>
                    <h3>Brain Mapping Unlocked!</h3>
                    <p>The payment override has been recorded. You can now proceed with the Brain Mapping assessment.</p>
                    <button class="payment-override-start-btn" onclick="startBrainMappingFromOverride()">
                        <i class="fa-solid fa-brain"></i>
                        Start Brain Mapping
                    </button>
                    <span class="payment-override-close-link" onclick="closePaymentOverrideModal()">Close and return later</span>
                </div>
            </div>
        </div>
    </div>
    <!-- END PAYMENT OVERRIDE MODAL -->
    
    <script>
        // PATIENT STATE - SINGLE SOURCE OF TRUTH
        const patientState = {
            patientId: 'PAT-001',
            patientName: 'Sarah Mitchell',
            clinicalAssessments: [
                {
                    id: 'ca-1',
                    number: 1,
                    status: 'completed',
                    startDate: '2025-09-15',
                    completedDate: '2025-10-20',
                    blocks: [
                        { 
                            id: 'fnon-1', 
                            name: 'FNON', 
                            desc: 'Network Analysis',
                            type: 'fnon',
                            status: 'completed',
                            completedBy: 'Dr. James',
                            completedAt: '2025-09-18'
                        },
                        {
                            id: 'eeg-1',
                            name: 'Brain Mapping',
                            desc: 'EEG Imaging',
                            type: 'brain-mapping',
                            status: 'completed',
                            completedBy: 'Tech Sarah',
                            completedAt: '2025-09-22'
                        },
                        {
                            id: 'prs-1',
                            name: 'PRS',
                            desc: 'Symptoms',
                            type: 'prs',
                            status: 'completed', 
                            completedBy: 'Dr. James', 
                            completedAt: '2025-09-25',
                            totalScore: 28,
                            maxScore: 50,
                            scorePercentage: 56,
                            severity: 'Moderate',
                            diseaseScores: [
                                { disease: 'Depression', score: 12, max: 20 },
                                { disease: 'Anxiety', score: 10, max: 15 },
                                { disease: 'Sleep', score: 6, max: 15 }
                            ]
                        },
                        {
                            id: 'ana-1',
                            name: "Doctor's Notes",
                            desc: 'Clinical Notes',
                            type: 'doctor-notes',
                            status: 'completed',
                            completedBy: 'Dr. James',
                            completedAt: '2025-10-01'
                        },
                        {
                            id: 'treatment-1',
                            name: 'Treatment Plan',
                            desc: 'Therapy Design',
                            type: 'treatment-plan',
                            status: 'completed',
                            completedBy: 'Dr. James',
                            completedAt: '2025-10-10'
                        },
                        {
                            id: 'report-1',
                            name: 'Final Report',
                            desc: 'Comprehensive',
                            type: 'final-report',
                            status: 'completed',
                            completedBy: 'Dr. James',
                            completedAt: '2025-10-20'
                        }
                    ],
                    sessions: [
                        { id: 'sess-1-1', number: 1, status: 'completed', device: 'TMS-Unit-A', montage: 'Motor Cortex', completedAt: '2025-10-25' },
                        { id: 'sess-1-2', number: 2, status: 'completed', device: 'TMS-Unit-A', montage: 'DLPFC', completedAt: '2025-10-28' },
                        { id: 'sess-1-3', number: 3, status: 'completed', device: 'TMS-Unit-A', montage: 'DLPFC', completedAt: '2025-11-01' },
                        { id: 'sess-1-4', number: 4, status: 'completed', device: 'TMS-Unit-A', montage: 'Motor Cortex', completedAt: '2025-11-05' },
                        { id: 'sess-1-5', number: 5, status: 'completed', device: 'TMS-Unit-A', montage: 'DLPFC', completedAt: '2025-11-08' }
                    ]
                },
                {
                    id: 'ca-2',
                    number: 2,
                    status: 'active',
                    startDate: '2026-01-15',
                    completedDate: null,
                    blocks: [
                        { 
                            id: 'anamnesis-2', 
                            name: 'Anamnesis', 
                            desc: 'Patient Symptoms',
                            type: 'anamnesis',
                            status: 'completed', 
                            completedBy: 'Clinical Assistant Maria', 
                            completedAt: '2026-01-29',
                            diagnosis: 'Chronic fatigue syndrome with cognitive symptoms'
                        },
                        { 
                            id: 'fnon-2', 
                            name: 'FNON', 
                            desc: 'Network Analysis',
                            type: 'fnon',
                            status: 'completed',
                            completedBy: 'Dr. James',
                            completedAt: '2026-01-15',
                            score: 32
                        },
                        {
                            id: 'eeg-2',
                            name: 'Brain Mapping',
                            desc: 'EEG Imaging',
                            type: 'brain-mapping',
                            status: 'completed',
                            completedBy: 'Tech Sarah',
                            completedAt: '2026-01-17',
                            channelsCaptured: 32
                        },
                        {
                            id: 'prs-2',
                            name: 'PRS',
                            desc: 'Symptoms',
                            type: 'prs',
                            status: 'active', 
                            currentProgress: 40, 
                            performer: 'Clinical Assistant Alex', 
                            startedAt: '2026-01-30',
                            totalScore: 18,
                            maxScore: 50,
                            scorePercentage: 36,
                            severity: 'Mild',
                            diseaseScores: [
                                { disease: 'Depression', score: 8, max: 20 },
                                { disease: 'Anxiety', score: 6, max: 15 },
                                { disease: 'Sleep', score: 4, max: 15 }
                            ]
                        },
                        {
                            id: 'ana-2',
                            name: "Doctor's Notes",
                            desc: 'Clinical Notes',
                            type: 'doctor-notes',
                            status: 'pending',
                            performer: null
                        },
                        {
                            id: 'treatment-2',
                            name: 'Treatment Plan',
                            desc: 'Therapy Design',
                            type: 'treatment-plan',
                            status: 'locked',
                            performer: null
                        },
                        {
                            id: 'report-2',
                            name: 'Final Report',
                            desc: 'Comprehensive',
                            type: 'final-report',
                            status: 'locked',
                            performer: null
                        }
                    ],
                    sessions: [
                        { id: 'sess-2-1', number: 1, status: 'pending', device: 'TMS-Unit-B', montage: 'DLPFC', prerequisite: 'Doctor Review' },
                        { id: 'sess-2-2', number: 2, status: 'disabled', device: null, montage: null },
                        { id: 'sess-2-3', number: 3, status: 'disabled', device: null, montage: null },
                        { id: 'sess-2-4', number: 4, status: 'disabled', device: null, montage: null },
                        { id: 'sess-2-5', number: 5, status: 'disabled', device: null, montage: null }
                    ]
                },
                {
                    id: 'ca-3',
                    number: 3,
                    status: 'locked',
                    startDate: '2026-04-15',
                    completedDate: null,
                    blocks: [
                        { id: 'anamnesis-3', name: 'Anamnesis', desc: 'Patient Symptoms', type: 'anamnesis', status: 'locked', completedBy: null, completedAt: null },
                        { id: 'fnon-3', name: 'FNON', desc: 'Network Analysis', type: 'fnon', status: 'locked', completedBy: null, completedAt: null },
                        { id: 'eeg-3', name: 'Brain Mapping', desc: 'EEG Imaging', type: 'brain-mapping', status: 'locked', completedBy: null, completedAt: null },
                        { id: 'prs-3', name: 'PRS', desc: 'Symptoms', type: 'prs', status: 'locked', completedBy: null, completedAt: null },
                        { id: 'ana-3', name: "Doctor's Notes", desc: 'Clinical Notes', type: 'doctor-notes', status: 'locked', completedBy: null, completedAt: null },
                        { id: 'treatment-3', name: 'Treatment Plan', desc: 'Therapy Design', type: 'treatment-plan', status: 'locked', completedBy: null, completedAt: null },
                        { id: 'report-3', name: 'Final Report', desc: 'Comprehensive', type: 'final-report', status: 'locked', completedBy: null, completedAt: null }
                    ],
                    sessions: [
                        { id: 'sess-3-1', number: 1, status: 'disabled', device: null, montage: null },
                        { id: 'sess-3-2', number: 2, status: 'disabled', device: null, montage: null },
                        { id: 'sess-3-3', number: 3, status: 'disabled', device: null, montage: null },
                        { id: 'sess-3-4', number: 4, status: 'disabled', device: null, montage: null },
                        { id: 'sess-3-5', number: 5, status: 'disabled', device: null, montage: null }
                    ]
                },
                {
                    id: 'ca-4',
                    number: 4,
                    status: 'locked',
                    startDate: '2026-07-15',
                    completedDate: null,
                    blocks: [
                        { id: 'anamnesis-4', name: 'Anamnesis', desc: 'Patient Symptoms', type: 'anamnesis', status: 'locked', completedBy: null, completedAt: null },
                        { id: 'fnon-4', name: 'FNON', desc: 'Network Analysis', type: 'fnon', status: 'locked', completedBy: null, completedAt: null },
                        { id: 'eeg-4', name: 'Brain Mapping', desc: 'EEG Imaging', type: 'brain-mapping', status: 'locked', completedBy: null, completedAt: null },
                        { id: 'prs-4', name: 'PRS', desc: 'Symptoms', type: 'prs', status: 'locked', completedBy: null, completedAt: null },
                        { id: 'ana-4', name: "Doctor's Notes", desc: 'Clinical Notes', type: 'doctor-notes', status: 'locked', completedBy: null, completedAt: null },
                        { id: 'treatment-4', name: 'Treatment Plan', desc: 'Therapy Design', type: 'treatment-plan', status: 'locked', completedBy: null, completedAt: null },
                        { id: 'report-4', name: 'Final Report', desc: 'Comprehensive', type: 'final-report', status: 'locked', completedBy: null, completedAt: null }
                    ],
                    sessions: [
                        { id: 'sess-4-1', number: 1, status: 'disabled', device: null, montage: null },
                        { id: 'sess-4-2', number: 2, status: 'disabled', device: null, montage: null },
                        { id: 'sess-4-3', number: 3, status: 'disabled', device: null, montage: null },
                        { id: 'sess-4-4', number: 4, status: 'disabled', device: null, montage: null },
                        { id: 'sess-4-5', number: 5, status: 'disabled', device: null, montage: null }
                    ]
                }
            ]
        };

        // ICON MAPPING
        const iconMap = {
            'anamnesis': 'fa-stethoscope',
            'fnon': 'fa-list-check',
            'brain-mapping': 'fa-brain',
            'prs': 'fa-comments',
            'doctor-notes': 'fa-clipboard',
            'treatment-plan': 'fa-prescription-bottle-medical',
            'final-report': 'fa-file-pdf'
        };

        // RENDER MAIN CONTENT
        function renderAssessments() {
            const container = document.getElementById('assessmentsContainer');
            container.innerHTML = '';

            patientState.clinicalAssessments.forEach((ca, index) => {
                const caDiv = document.createElement('div');
                caDiv.className = 'assessment-section';
                if (ca.status === 'locked') caDiv.classList.add('locked');
                if (index === 1) caDiv.classList.add('expanded'); // Start with assessment 2 expanded

                // Calculate progress
                const completedBlocks = ca.blocks.filter(b => b.status === 'completed').length;
                const completedSessions = ca.sessions.filter(s => s.status === 'completed').length;
                const totalItems = ca.blocks.length + ca.sessions.length;
                const completedItems = completedBlocks + completedSessions;
                const progressPercent = (completedItems / totalItems) * 100;

                // Header
                const headerDiv = document.createElement('div');
                headerDiv.className = `assessment-header ${ca.status === 'locked' ? 'locked' : ''}`;

                const statusIcon = ca.status === 'completed' ? '' : ca.status === 'active' ? '' : '';
                const statusText = ca.status === 'completed' ? 'Completed' : ca.status === 'active' ? 'Active' : 'Locked';

                headerDiv.innerHTML = `
                    <div class="assessment-title">
                        <h2>Clinical Assessment ${ca.number}</h2>
                        <span class="assessment-badge ${ca.status}">
                            ${statusIcon} ${statusText}
                        </span>
                    </div>
                    ${ca.status !== 'locked' ? '<span class="expand-icon"></span>' : ''}
                `;

                // Add click handler for accordion
                if (ca.status !== 'locked') {
                    headerDiv.onclick = () => {
                        caDiv.classList.toggle('expanded');
                    };
                }

                caDiv.appendChild(headerDiv);

                // Create content wrapper
                const contentDiv = document.createElement('div');
                contentDiv.className = 'assessment-content';

                const innerDiv = document.createElement('div');
                innerDiv.className = 'assessment-content-inner';

                // Add meta and progress
                const metaDiv = document.createElement('div');
                metaDiv.innerHTML = `
                    <div class="assessment-meta">
                        <div class="meta-item">
                            <i class="fa-solid fa-calendar"></i>
                            <span>${ca.status === 'completed' ? `Completed: ${new Date(ca.completedDate).toLocaleDateString()}` : ca.status === 'active' ? 'In Progress' : `Starts: ${ca.startDate}`}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fa-solid fa-cube"></i>
                            <span>${completedBlocks}/${ca.blocks.length} Blocks</span>
                        </div>
                        <div class="meta-item">
                            <i class="fa-solid fa-dumbbell"></i>
                            <span>${completedSessions}/${ca.sessions.length} Sessions</span>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progressPercent}%"></div>
                    </div>
                `;
                innerDiv.appendChild(metaDiv);

                // Blocks Grid
                const blocksDiv = document.createElement('div');
                blocksDiv.className = 'blocks-container';
                blocksDiv.style.marginTop = '20px';

                ca.blocks.forEach(block => {
                    const blockDiv = document.createElement('div');
                    blockDiv.className = `block-card ${block.type} ${block.status}`;

                    let statusIcon, statusText;
                    if (block.status === 'completed') {
                        statusIcon = '';
                        statusText = 'Done';
                    } else if (block.status === 'active') {
                        statusIcon = '';
                        statusText = 'Active';
                    } else if (block.status === 'pending') {
                        statusIcon = '';
                        statusText = 'Pending';
                    } else {
                        statusIcon = '';
                        statusText = 'Locked';
                    }

                    let scoreHTML = '';
                    if (block.type === 'prs' && (block.status === 'completed' || block.status === 'active') && block.totalScore !== undefined) {
                        scoreHTML = `
                            
                        `;
                    }

                    blockDiv.innerHTML = `
                        <div class="block-status">
                            <span class="block-status-icon">${statusIcon}</span>
                            <span class="block-status-text">${statusText}</span>
                        </div>
                        <div class="block-icon">
                            <i class="fa-solid ${iconMap[block.type] || 'fa-circle'}"></i>
                        </div>
                        <div class="block-name">${block.name}</div>
                        <div class="block-desc">${block.desc}</div>
                        ${scoreHTML}
                    `;

                    blocksDiv.appendChild(blockDiv);
                });

                innerDiv.appendChild(blocksDiv);

                // Sessions Row
                if (ca.sessions.length > 0) {
                    const sessionsDiv = document.createElement('div');
                    sessionsDiv.className = 'sessions-row';

                    const sessTitle = document.createElement('div');
                    sessTitle.className = 'sessions-title';
                    sessTitle.textContent = 'Treatment Sessions';
                    sessionsDiv.appendChild(sessTitle);

                    const containerDiv = document.createElement('div');
                    containerDiv.className = 'sessions-container';

                    ca.sessions.forEach(sess => {
                        const box = document.createElement('div');
                        box.className = `session-box ${sess.status}`;

                        let iconClass = 'fa-dumbbell';
                        let statusIcon = '';
                        let statusText = '';
                        let infoHTML = '';

                        if (sess.status === 'completed') {
                            iconClass = 'fa-check-circle';
                            statusIcon = '';
                            statusText = 'Completed';
                            infoHTML = `
                                <div class="session-info">
                                    <div class="session-info-item">
                                        <span class="session-info-label">Device:</span> ${sess.device}
                                    </div>
                                    <div class="session-info-item">
                                        <span class="session-info-label">Montage:</span> ${sess.montage}
                                    </div>
                                    <div class="session-info-item">
                                        <span class="session-info-label">Date:</span> ${new Date(sess.completedAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                                    </div>
                                </div>
                            `;
                        } else if (sess.status === 'pending') {
                            iconClass = 'fa-play-circle';
                            statusIcon = '';
                            statusText = 'Pending';
                            infoHTML = `
                                <div class="session-info">
                                    <div class="session-info-item">
                                        <span class="session-info-label">Ready to start</span>
                                    </div>
                                    <div class="session-info-item">
                                        <span class="session-info-label">Device:</span> ${sess.device}
                                    </div>
                                    <div class="session-info-item">
                                        <span class="session-info-label">Montage:</span> ${sess.montage}
                                    </div>
                                </div>
                            `;
                        } else if (sess.status === 'disabled') {
                            iconClass = 'fa-lock';
                            statusIcon = '';
                            statusText = 'Locked';
                            infoHTML = `
                                <div class="session-info">
                                    <div class="session-info-item">
                                        Awaiting prior sessions
                                    </div>
                                </div>
                            `;
                        }

                        box.innerHTML = `
                            <div class="session-status-badge">
                                <span class="session-status-icon">${statusIcon}</span>
                                <span>${statusText}</span>
                            </div>
                            <div class="session-icon">
                                <i class="fa-solid ${iconClass}"></i>
                            </div>
                            <div class="session-header">Session ${sess.number}</div>
                            ${infoHTML}
                        `;

                        containerDiv.appendChild(box);
                    });

                    sessionsDiv.appendChild(containerDiv);
                    innerDiv.appendChild(sessionsDiv);
                }

                contentDiv.appendChild(innerDiv);
                caDiv.appendChild(contentDiv);

                container.appendChild(caDiv);
            });
        }

        // CURRENT ROLE STATE
        let currentRole = 'receptionist';

        // TAB SWITCHING
        function switchTab(tab, skipURLUpdate = false) {
            // Reset clarity wireframes dropdown
            const clarityDropdown = document.getElementById('clarityWireframesSelector');
            if (clarityDropdown) clarityDropdown.value = 'none';

            // Update tab buttons
            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(btn => btn.classList.remove('active'));

            // Find and activate the clicked button
            if (tab === 'today') {
                const todayTab = document.getElementById('todayTab');
                if (todayTab) todayTab.classList.add('active');
            } else if (tab === 'overall') {
                const overallTab = document.getElementById('overallTab');
                if (overallTab) overallTab.classList.add('active');
            }

            // Update tab content visibility
            document.getElementById('todayTabContent').style.display = 'none';
            document.getElementById('overallTabContent').style.display = 'none';
            document.getElementById('workingTabContent').style.display = 'none';
            document.getElementById('deviceTabContent').style.display = 'none';

            // Update URL with current tab (only if not being restored from URL)
            if (!skipURLUpdate && selectedPatientData) {
                updateURL(selectedPatientData.id, currentRole, tab);
            }

            if (tab === 'today') {
                document.getElementById('todayTabContent').style.display = 'block';
                renderTodayView();
            } else if (tab === 'overall') {
                document.getElementById('overallTabContent').style.display = 'block';
            } else if (tab === 'working') {
                document.getElementById('workingTabContent').style.display = 'block';
                renderWorkingView();
            } else if (tab === 'device') {
                document.getElementById('deviceTabContent').style.display = 'block';
                renderDeviceView();
            }
        }

        // CLARITY WIREFRAMES DROPDOWN HANDLER
        function handleClarityWireframeChange() {
            const selectedWireframe = document.getElementById('clarityWireframesSelector').value;
            
            // Sync the top dropdown
            const topSelector = document.getElementById('topClaritySelector');
            if (topSelector) topSelector.value = selectedWireframe;
            
            if (selectedWireframe === 'none') {
                return;
            }

            // Deactivate all tab buttons
            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(btn => btn.classList.remove('active'));

            // Hide all tab content
            document.getElementById('todayTabContent').style.display = 'none';
            document.getElementById('overallTabContent').style.display = 'none';
            document.getElementById('workingTabContent').style.display = 'none';
            document.getElementById('deviceTabContent').style.display = 'none';

            // Show selected wireframe content
            if (selectedWireframe === 'working') {
                document.getElementById('workingTabContent').style.display = 'block';
                renderWorkingView();
            } else if (selectedWireframe === 'device') {
                document.getElementById('deviceTabContent').style.display = 'block';
                renderDeviceView();
            }
        }

        // ROLE CHANGE HANDLER
        function handleRoleChange() {
            const roleSelector = document.getElementById('roleSelector');
            if (!roleSelector) return;

            currentRole = roleSelector.value;
            renderTodayView();
            renderWorkingView();
            renderDeviceView();
        }

        // GET ROLE PERMISSIONS
        function getRolePermissions(role) {
            const permissions = {
                'patient': {
                    canViewReports: true,
                    canEditData: false,
                    canViewScores: true,
                    showPendingItems: true,
                    label: 'Patient View'
                },
                'doctor': {
                    canViewReports: true,
                    canEditData: true,
                    canViewScores: true,
                    showPendingItems: false,
                    label: 'Doctor View'
                },
                'clinical-assistant': {
                    canViewReports: true,
                    canEditData: true,
                    canViewScores: true,
                    showPendingItems: false,
                    label: 'Clinical Assistant View'
                },
                'receptionist': {
                    canViewReports: false,
                    canEditData: false,
                    canViewScores: false,
                    showPendingItems: false,
                    label: 'Receptionist View'
                }
            };
            return permissions[role];
        }

        // PATIENT STATE MAPPING - Maps each patient to their wireframe
        const patientWireframeMapping = {
            'P-NEW-1': 'assessment-blocks',  // Just paid - 4 pending, 3 locked
            'P-NEW-2': 'assessment-blocks',  // Payment pending - all locked
            'P-NEW-3': 'assessment-blocks',  // Device activation needed
            'P-NEW-4': 'assessment-blocks',  // Payment pending - doctor override available
            'P001': 'assessment-blocks',     // 2/4 done
            'P002': 'assessment-blocks',     // 4/4 done, doctor notes open
            'P003': 'assessment-blocks',     // All blocks done
            'P004': 'assessment-blocks',     // Sessions started
            'P005': 'assessment-blocks'      // Mid-sessions
        };

        // PATIENT STATE DATA - Define block states for each patient
        const patientStateData = {
            'P-NEW-1': { // Alex Martinez - Just paid, all 4 initial pending
                assessmentNumber: 1,
                startDate: '2026-02-03',
                blocks: [
                    { id: 'anamnesis-1', name: 'Anamnesis', desc: 'Patient Symptoms', type: 'anamnesis', status: 'pending' },
                    { id: 'fnon-1', name: 'FNON', desc: 'Network Analysis', type: 'fnon', status: 'pending' },
                    { id: 'prs-1', name: 'PRS', desc: 'Symptoms', type: 'prs', status: 'pending' },
                    { id: 'eeg-1', name: 'Brain Mapping', desc: 'EEG Imaging', type: 'brain-mapping', status: 'pending' },
                    { id: 'ana-1', name: "Doctor's Notes", desc: 'Clinical Notes', type: 'doctor-notes', status: 'locked', lockReason: 'assessment' },
                    { id: 'treatment-1', name: 'Treatment Plan', desc: 'Therapy Design', type: 'treatment-plan', status: 'locked', lockReason: 'assessment' },
                    { id: 'report-1', name: 'Final Report', desc: 'Comprehensive', type: 'final-report', status: 'locked', lockReason: 'assessment' }
                ]
            },
            'P-NEW-2': { // Rachel Kim - Payment pending, some assessments can start
                assessmentNumber: 1,
                startDate: '2026-02-03',
                paymentPending: true,
                blocks: [
                    { id: 'anamnesis-1', name: 'Anamnesis', desc: 'Patient Symptoms', type: 'anamnesis', status: 'pending' },
                    { id: 'fnon-1', name: 'FNON', desc: 'Network Analysis', type: 'fnon', status: 'locked', lockReason: 'payment' },
                    { id: 'prs-1', name: 'PRS', desc: 'Symptoms', type: 'prs', status: 'locked', lockReason: 'payment' },
                    { id: 'eeg-1', name: 'Brain Mapping', desc: 'EEG Imaging', type: 'brain-mapping', status: 'locked', lockReason: 'payment' },
                    { id: 'ana-1', name: "Doctor's Notes", desc: 'Clinical Notes', type: 'doctor-notes', status: 'locked', lockReason: 'assessment' },
                    { id: 'treatment-1', name: 'Treatment Plan', desc: 'Therapy Design', type: 'treatment-plan', status: 'locked', lockReason: 'assessment' },
                    { id: 'report-1', name: 'Final Report', desc: 'Comprehensive', type: 'final-report', status: 'locked', lockReason: 'assessment' }
                ]
            },
            'P-NEW-3': { // James Wilson - Payment done, device activation needed for brain mapping
                assessmentNumber: 1,
                startDate: '2026-02-03',
                deviceActivationNeeded: true,
                blocks: [
                    { id: 'anamnesis-1', name: 'Anamnesis', desc: 'Patient Symptoms', type: 'anamnesis', status: 'pending' },
                    { id: 'fnon-1', name: 'FNON', desc: 'Network Analysis', type: 'fnon', status: 'pending' },
                    { id: 'prs-1', name: 'PRS', desc: 'Symptoms', type: 'prs', status: 'pending' },
                    { id: 'eeg-1', name: 'Brain Mapping', desc: 'EEG Imaging', type: 'brain-mapping', status: 'pending', requiresDeviceActivation: true },
                    { id: 'ana-1', name: "Doctor's Notes", desc: 'Clinical Notes', type: 'doctor-notes', status: 'locked', lockReason: 'assessment' },
                    { id: 'treatment-1', name: 'Treatment Plan', desc: 'Therapy Design', type: 'treatment-plan', status: 'locked', lockReason: 'assessment' },
                    { id: 'report-1', name: 'Final Report', desc: 'Comprehensive', type: 'final-report', status: 'locked', lockReason: 'assessment' }
                ]
            },
            'P-NEW-4': { // Thomas Brown - Payment pending, doctor can override for brain mapping
                assessmentNumber: 1,
                startDate: '2026-02-04',
                paymentPending: true,
                allowPaymentOverride: true,
                paymentOverrideBlocks: ['brain-mapping'],
                blocks: [
                    { id: 'anamnesis-1', name: 'Anamnesis', desc: 'Patient Symptoms', type: 'anamnesis', status: 'locked', lockReason: 'payment' },
                    { id: 'fnon-1', name: 'FNON', desc: 'Network Analysis', type: 'fnon', status: 'locked', lockReason: 'payment' },
                    { id: 'prs-1', name: 'PRS', desc: 'Symptoms', type: 'prs', status: 'locked', lockReason: 'payment' },
                    { id: 'eeg-1', name: 'Brain Mapping', desc: 'EEG Imaging', type: 'brain-mapping', status: 'locked', lockReason: 'payment', allowOverride: true },
                    { id: 'ana-1', name: "Doctor's Notes", desc: 'Clinical Notes', type: 'doctor-notes', status: 'locked', lockReason: 'assessment' },
                    { id: 'treatment-1', name: 'Treatment Plan', desc: 'Therapy Design', type: 'treatment-plan', status: 'locked', lockReason: 'assessment' },
                    { id: 'report-1', name: 'Final Report', desc: 'Comprehensive', type: 'final-report', status: 'locked', lockReason: 'assessment' }
                ]
            },
            'P001': { // Sarah Johnson - Assessments 2/4 complete
                assessmentNumber: 2,
                startDate: '2026-01-15',
                blocks: [
                    { id: 'anamnesis-2', name: 'Anamnesis', desc: 'Patient Symptoms', type: 'anamnesis', status: 'completed', completedBy: 'Clinical Assistant Maria', completedAt: '2026-01-16' },
                    { id: 'fnon-2', name: 'FNON', desc: 'Network Analysis', type: 'fnon', status: 'completed', completedBy: 'Dr. James', completedAt: '2026-01-18', score: 32 },
                    { id: 'prs-2', name: 'PRS', desc: 'Symptoms', type: 'prs', status: 'pending', performer: null },
                    { id: 'eeg-2', name: 'Brain Mapping', desc: 'EEG Imaging', type: 'brain-mapping', status: 'pending', performer: null },
                    { id: 'ana-2', name: "Doctor's Notes", desc: 'Clinical Notes', type: 'doctor-notes', status: 'locked', performer: null },
                    { id: 'treatment-2', name: 'Treatment Plan', desc: 'Therapy Design', type: 'treatment-plan', status: 'locked', performer: null },
                    { id: 'report-2', name: 'Final Report', desc: 'Comprehensive', type: 'final-report', status: 'locked', performer: null }
                ]
            },
            'P002': { // Michael Chen - All 4 assessments complete, ready for doctor review
                assessmentNumber: 2,
                startDate: '2026-01-10',
                blocks: [
                    { id: 'anamnesis-2', name: 'Anamnesis', desc: 'Patient Symptoms', type: 'anamnesis', status: 'completed', completedBy: 'Clinical Assistant Maria', completedAt: '2026-01-11' },
                    { id: 'fnon-2', name: 'FNON', desc: 'Network Analysis', type: 'fnon', status: 'completed', completedBy: 'Dr. James', completedAt: '2026-01-12', score: 45 },
                    { id: 'prs-2', name: 'PRS', desc: 'Symptoms', type: 'prs', status: 'completed', completedBy: 'Clinical Assistant Alex', completedAt: '2026-01-13' },
                    { id: 'eeg-2', name: 'Brain Mapping', desc: 'EEG Imaging', type: 'brain-mapping', status: 'completed', completedBy: 'Tech Sarah', completedAt: '2026-01-14' },
                    { id: 'ana-2', name: "Doctor's Notes", desc: 'Clinical Notes', type: 'doctor-notes', status: 'pending', performer: null },
                    { id: 'treatment-2', name: 'Treatment Plan', desc: 'Therapy Design', type: 'treatment-plan', status: 'locked', performer: null },
                    { id: 'report-2', name: 'Final Report', desc: 'Comprehensive', type: 'final-report', status: 'locked', performer: null }
                ]
            },
            'P003': { // Emma Rodriguez - Treatment plan ready
                assessmentNumber: 2,
                startDate: '2026-01-05',
                blocks: [
                    { id: 'anamnesis-2', name: 'Anamnesis', desc: 'Patient Symptoms', type: 'anamnesis', status: 'completed', completedBy: 'Clinical Assistant Maria', completedAt: '2026-01-06' },
                    { id: 'fnon-2', name: 'FNON', desc: 'Network Analysis', type: 'fnon', status: 'completed', completedBy: 'Dr. James', completedAt: '2026-01-07', score: 38 },
                    { id: 'prs-2', name: 'PRS', desc: 'Symptoms', type: 'prs', status: 'completed', completedBy: 'Clinical Assistant Alex', completedAt: '2026-01-08' },
                    { id: 'eeg-2', name: 'Brain Mapping', desc: 'EEG Imaging', type: 'brain-mapping', status: 'completed', completedBy: 'Tech Sarah', completedAt: '2026-01-09' },
                    { id: 'ana-2', name: "Doctor's Notes", desc: 'Clinical Notes', type: 'doctor-notes', status: 'completed', completedBy: 'Dr. James', completedAt: '2026-01-10' },
                    { id: 'treatment-2', name: 'Treatment Plan', desc: 'Therapy Design', type: 'treatment-plan', status: 'completed', completedBy: 'Dr. James', completedAt: '2026-01-12' },
                    { id: 'report-2', name: 'Final Report', desc: 'Comprehensive', type: 'final-report', status: 'pending', performer: null }
                ]
            },
            'P004': { // David Park - Session 1 today
                assessmentNumber: 2,
                startDate: '2026-01-01',
                blocks: [
                    { id: 'anamnesis-2', name: 'Anamnesis', desc: 'Patient Symptoms', type: 'anamnesis', status: 'completed', completedBy: 'Clinical Assistant Maria', completedAt: '2026-01-02' },
                    { id: 'fnon-2', name: 'FNON', desc: 'Network Analysis', type: 'fnon', status: 'completed', completedBy: 'Dr. James', completedAt: '2026-01-03', score: 42 },
                    { id: 'prs-2', name: 'PRS', desc: 'Symptoms', type: 'prs', status: 'completed', completedBy: 'Clinical Assistant Alex', completedAt: '2026-01-04' },
                    { id: 'eeg-2', name: 'Brain Mapping', desc: 'EEG Imaging', type: 'brain-mapping', status: 'completed', completedBy: 'Tech Sarah', completedAt: '2026-01-05' },
                    { id: 'ana-2', name: "Doctor's Notes", desc: 'Clinical Notes', type: 'doctor-notes', status: 'completed', completedBy: 'Dr. James', completedAt: '2026-01-06' },
                    { id: 'treatment-2', name: 'Treatment Plan', desc: 'Therapy Design', type: 'treatment-plan', status: 'completed', completedBy: 'Dr. James', completedAt: '2026-01-08' },
                    { id: 'report-2', name: 'Final Report', desc: 'Comprehensive', type: 'final-report', status: 'completed', completedBy: 'Dr. James', completedAt: '2026-01-10' }
                ],
                sessions: [
                    { id: 'session-1', name: 'Session 1', desc: 'Initial therapy session', status: 'pending', scheduledDate: '2026-02-03' },
                    { id: 'session-2', name: 'Session 2', desc: 'Follow-up therapy', status: 'locked', lockReason: 'Complete Session 1 first' },
                    { id: 'session-3', name: 'Session 3', desc: 'Continued therapy', status: 'locked', lockReason: 'Complete Session 1 first' },
                    { id: 'session-4', name: 'Session 4', desc: 'Advanced therapy', status: 'locked', lockReason: 'Complete Session 1 first' },
                    { id: 'session-5', name: 'Session 5', desc: 'Maintenance therapy', status: 'locked', lockReason: 'Complete Session 1 first' }
                ]
            },
            'P005': { // Lisa Thompson - 3 sessions complete
                assessmentNumber: 2,
                startDate: '2025-12-20',
                blocks: [
                    { id: 'anamnesis-2', name: 'Anamnesis', desc: 'Patient Symptoms', type: 'anamnesis', status: 'completed', completedBy: 'Clinical Assistant Maria', completedAt: '2025-12-21' },
                    { id: 'fnon-2', name: 'FNON', desc: 'Network Analysis', type: 'fnon', status: 'completed', completedBy: 'Dr. James', completedAt: '2025-12-22', score: 50 },
                    { id: 'prs-2', name: 'PRS', desc: 'Symptoms', type: 'prs', status: 'completed', completedBy: 'Clinical Assistant Alex', completedAt: '2025-12-23' },
                    { id: 'eeg-2', name: 'Brain Mapping', desc: 'EEG Imaging', type: 'brain-mapping', status: 'completed', completedBy: 'Tech Sarah', completedAt: '2025-12-24' },
                    { id: 'ana-2', name: "Doctor's Notes", desc: 'Clinical Notes', type: 'doctor-notes', status: 'completed', completedBy: 'Dr. James', completedAt: '2025-12-26' },
                    { id: 'treatment-2', name: 'Treatment Plan', desc: 'Therapy Design', type: 'treatment-plan', status: 'completed', completedBy: 'Dr. James', completedAt: '2025-12-28' },
                    { id: 'report-2', name: 'Final Report', desc: 'Comprehensive', type: 'final-report', status: 'completed', completedBy: 'Dr. James', completedAt: '2025-12-30' }
                ],
                sessions: [
                    { 
                        id: 'session-1', 
                        name: 'Session 1', 
                        desc: 'Initial therapy session', 
                        status: 'completed', 
                        completedAt: '2026-01-15', 
                        duration: '60 min', 
                        completedBy: 'Dr. James',
                        device: 'Neuronika',
                        montage: 'F3-F4 (DLPFC)',
                        symptoms: 'Mild tingling sensation, no adverse effects',
                        clinicalNotes: 'Patient tolerated treatment well. Reported improved focus immediately after session.',
                        activities: ['Sudoku', 'Crossword', 'Balance Test']
                    },
                    { 
                        id: 'session-2', 
                        name: 'Session 2', 
                        desc: 'Follow-up therapy', 
                        status: 'completed', 
                        completedAt: '2026-01-22', 
                        duration: '60 min', 
                        completedBy: 'Clinical Assistant Maria',
                        device: 'tVNS',
                        symptoms: 'No adverse effects reported',
                        clinicalNotes: 'Session proceeded smoothly. Patient reports better sleep quality since last week.',
                        activities: ['Walking', 'Toe Touch', 'Breathing Exercise']
                    },
                    { 
                        id: 'session-3', 
                        name: 'Session 3', 
                        desc: 'Continued therapy', 
                        status: 'completed', 
                        completedAt: '2026-01-29', 
                        duration: '60 min', 
                        completedBy: 'Dr. James',
                        device: 'TPS',
                        montage: 'C3-C4 (Motor Cortex)',
                        symptoms: 'Slight headache post-session (resolved within 30 mins)',
                        clinicalNotes: 'Good response to treatment. Motor function improvement noted in assessments.',
                        activities: ['Balance Test', 'Sudoku', 'Memory Game']
                    },
                    { id: 'session-4', name: 'Session 4', desc: 'Advanced therapy', status: 'pending', scheduledDate: '2026-02-05' },
                    { id: 'session-5', name: 'Session 5', desc: 'Maintenance therapy', status: 'pending', scheduledDate: '2026-02-12' }
                ]
            }
        };

        // RENDER TODAY'S JOURNEY VIEW
        function renderTodayView() {
            const container = document.getElementById('todayContent');
            if (!container) return;
            
            const permissions = getRolePermissions(currentRole);
            container.innerHTML = '';

            if (!selectedPatientData) return;

            const patientId = selectedPatientData.id;
            const wireframeToShow = patientWireframeMapping[patientId] || 'assessment-blocks';

            // WIREFRAME: ASSESSMENT BLOCKS (Used for ALL patients with different states)
            if (wireframeToShow === 'assessment-blocks') {
                const patientData = patientStateData[patientId];
                const activeAssessment = {
                    number: patientData.assessmentNumber,
                    startDate: patientData.startDate,
                    blocks: patientData.blocks
                };

            // Determine if showing sessions only or assessments
            const hasSessions = patientData.sessions && patientData.sessions.length > 0;
            
            // Add Header - different for sessions vs assessments
            const headerDiv = document.createElement('div');
            headerDiv.className = 'today-journey-header';
            headerDiv.style.cssText = 'background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.05)); border-left: 4px solid #10b981; padding: 20px 24px; border-radius: 12px; margin-bottom: 32px;';
            
            if (hasSessions) {
                // Find today's session (pending or completed today)
                const todayDate = '2026-02-03'; // Current date
                const todaySession = patientData.sessions.find(s => 
                    s.status === 'pending' || 
                    (s.status === 'completed' && s.completedAt === todayDate)
                );
                
                // Count completed sessions
                const completedCount = patientData.sessions.filter(s => s.status === 'completed').length;
                const totalSessions = patientData.sessions.length;
                
                let sessionTitle = 'Treatment Sessions';
                let sessionSubtitle = `${completedCount} of ${totalSessions} sessions completed`;
                
                if (todaySession) {
                    if (todaySession.status === 'pending') {
                        sessionTitle = `Today: ${todaySession.name}`;
                        sessionSubtitle = `Scheduled for ${todaySession.scheduledDate || 'today'}`;
                    } else if (todaySession.status === 'completed') {
                        sessionTitle = `${todaySession.name} Completed`;
                        sessionSubtitle = `Completed by ${todaySession.completedBy} - ${todaySession.completedAt}`;
                    }
                }
                
                headerDiv.innerHTML = `
                    <h3 style="font-size: 22px; font-weight: 700; color: #0f172a; margin: 0 0 8px 0; display: flex; align-items: center; gap: 10px;">
                        <i class="fa-solid fa-calendar-check" style="color: #10b981; font-size: 24px;"></i> 
                        <span>${sessionTitle}</span>
                    </h3>
                    <p style="font-size: 15px; color: #475569; margin: 0;">${sessionSubtitle}</p>
                `;
            } else {
                // Check if this is first visit or ongoing assessment
                const completedBlocks = patientData.blocks.filter(b => b.status === 'completed').length;
                const totalBlocks = patientData.blocks.length;
                const isFirstVisit = activeAssessment.number === 1 || completedBlocks === 0;
                
                let assessmentTitle = isFirstVisit ? 'First Visit - Clinical Assessment' : `Clinical Assessment ${activeAssessment.number}`;
                let assessmentSubtitle = `${completedBlocks} of ${totalBlocks} assessments completed`;
                
                if (isFirstVisit && completedBlocks === 0) {
                    assessmentSubtitle = `Initial consultation - Started ${activeAssessment.startDate}`;
                } else if (completedBlocks === totalBlocks) {
                    assessmentSubtitle = 'All assessments completed - Ready for treatment planning';
                }
                
                headerDiv.innerHTML = `
                    <h3 style="font-size: 22px; font-weight: 700; color: #0f172a; margin: 0 0 8px 0; display: flex; align-items: center; gap: 10px;">
                        <i class="fa-solid fa-calendar-day" style="color: #10b981; font-size: 24px;"></i> 
                        <span>${assessmentTitle}</span>
                    </h3>
                    <p style="font-size: 15px; color: #475569; margin: 0;">${assessmentSubtitle}</p>
                `;
            }
            container.appendChild(headerDiv);

            // Only show assessment blocks if patient doesn't have sessions yet
            // Once sessions start, show ONLY sessions (not assessments)
            if (!hasSessions) {
            // Create blocks grid (reuse same design)
            const blocksGrid = document.createElement('div');
            blocksGrid.className = 'blocks-container';

            // Show ALL Blocks (complete flow)
            const activeBlocks = activeAssessment.blocks;

            activeBlocks.forEach(block => {
                const blockDiv = document.createElement('div');
                blockDiv.className = `block-card ${block.type} ${block.status}`;

                let statusIcon, statusText;
                if (block.status === 'completed') {
                    statusIcon = '';
                    statusText = 'Done';
                } else if (block.status === 'active') {
                    statusIcon = '';
                    statusText = 'Active';
                } else if (block.status === 'pending') {
                    statusIcon = '';
                    statusText = 'Pending';
                } else {
                    statusIcon = '';
                    statusText = 'Locked';
                }

                // Build expanded details based on role and block type
                let expandedDetailsHTML = '';

                if (permissions.canViewScores || permissions.canViewReports || permissions.canEditData) {
                    let detailsContent = '';

                    if (block.status === 'completed') {
                        if (block.type === 'fnon' && permissions.canViewScores) {
                            detailsContent = `
                                <div class="block-info-grid">
                                    <div class="block-info-item">
                                        <div class="block-info-label">FNON Score</div>
                                        <div class="block-info-value">${block.score || 55}</div>
                                    </div>
                                    <div class="block-info-item">
                                        <div class="block-info-label">Improvement</div>
                                        <div class="block-info-value" style="color: var(--green-primary);">+23%</div>
                                    </div>
                                    <div class="block-info-item">
                                        <div class="block-info-label">Duration</div>
                                        <div class="block-info-value" style="font-size: 12px;">45 min</div>
                                    </div>
                                    <div class="block-info-item">
                                        <div class="block-info-label">Completed By</div>
                                        <div class="block-info-value" style="font-size: 12px;">${block.completedBy}</div>
                                    </div>
                                </div>
                                <div class="detail-section">
                                    <div class="detail-section-title">Activities Performed</div>
                                    <div class="activity-tags">
                                        <span class="activity-tag">
                                            Crossword
                                            <img src="crossword.avif" alt="Crossword" class="activity-tag-image">
                                        </span>
                                        <span class="activity-tag">
                                            Toe Touch
                                            <img src="exercise.png" alt="Toe Touch" class="activity-tag-image">
                                        </span>
                                        <span class="activity-tag">
                                            Walking
                                            <img src="walking.jpeg" alt="Walking" class="activity-tag-image">
                                        </span>
                                        <span class="activity-tag">
                                            Sudoku
                                            <img src="sudoku.jpg" alt="Sudoku" class="activity-tag-image">
                                        </span>
                                        <span class="activity-tag">
                                            Balance Test
                                            <img src="balance.jpeg" alt="Balance Test" class="activity-tag-image">
                                        </span>
                                    </div>
                                </div>
                            `;
                            if (permissions.canViewReports || permissions.canEditData) {
                                detailsContent += '<div class="block-action-buttons">';
                                if (permissions.canViewReports) {
                                    detailsContent += '<button class="block-action-btn view" onclick="viewBlockDetails(\'fnon\')" title="View detailed FNON report"><i class="fa-solid fa-eye"></i> View Details</button>';
                                }
                                if (permissions.canEditData) {
                                    detailsContent += '<button class="block-action-btn edit" onclick="editBlockDetails(\'fnon\')" title="Edit FNON assessment data"><i class="fa-solid fa-pen"></i> Edit Details</button>';
                                }
                                detailsContent += '</div>';
                            }
                        } else if (block.type === 'brain-mapping' && permissions.canViewScores) {
                            detailsContent = `
                                <div class="block-info-grid">
                                    <div class="block-info-item">
                                        <div class="block-info-label">Channels</div>
                                        <div class="block-info-value">${block.channelsCaptured || 32}</div>
                                    </div>
                                    <div class="block-info-item">
                                        <div class="block-info-label">Quality</div>
                                        <div class="block-info-value" style="font-size: 12px;">High</div>
                                    </div>
                                    <div class="block-info-item">
                                        <div class="block-info-label">Duration</div>
                                        <div class="block-info-value" style="font-size: 12px;">20 min</div>
                                    </div>
                                    <div class="block-info-item">
                                        <div class="block-info-label">Completed By</div>
                                        <div class="block-info-value" style="font-size: 12px;">${block.completedBy}</div>
                                    </div>
                                </div>
                            `;
                            if (permissions.canViewReports || (currentRole === 'doctor' && permissions.canEditData)) {
                                detailsContent += '<div class="block-action-buttons">';
                                if (permissions.canViewReports) {
                                    detailsContent += '<button class="block-action-btn view" onclick="viewBlockDetails(\'brain-mapping\')" title="View EEG data and analysis"><i class="fa-solid fa-eye"></i> View Details</button>';
                                }
                                if (currentRole === 'doctor') {
                                    detailsContent += '<button class="block-action-btn edit" onclick="editBlockDetails(\'brain-mapping\')" title="Edit EEG analysis (Doctor only)"><i class="fa-solid fa-pen"></i> Edit Details</button>';
                                } else if (currentRole === 'clinical-assistant' || currentRole === 'patient') {
                                    detailsContent += '<button class="block-action-btn disabled" title="Only doctors can edit EEG data"><i class="fa-solid fa-lock"></i> Edit Restricted</button>';
                                }
                                detailsContent += '</div>';
                            }
                        } else if (block.type === 'treatment-plan') {
                            detailsContent = `
                                <div class="block-info-grid">
                                    <div class="block-info-item">
                                        <div class="block-info-label">Status</div>
                                        <div class="block-info-value" style="font-size: 12px;">Completed</div>
                                    </div>
                                    <div class="block-info-item">
                                        <div class="block-info-label">Created By</div>
                                        <div class="block-info-value" style="font-size: 12px;">${block.completedBy}</div>
                                    </div>
                                    <div class="block-info-item">
                                        <div class="block-info-label">Date</div>
                                        <div class="block-info-value" style="font-size: 12px;">${block.completedAt}</div>
                                    </div>
                                </div>
                            `;
                            if (currentRole === 'doctor') {
                                detailsContent += '<div class="block-action-buttons">';
                                detailsContent += '<button class="block-action-btn view" onclick="viewBlockDetails(\'treatment-plan\')" title="View treatment plan"><i class="fa-solid fa-eye"></i> View Details</button>';
                                detailsContent += '<button class="block-action-btn edit" onclick="window.open(\'treatment-plan-doctor.html\', \'_blank\')" title="Edit treatment plan"><i class="fa-solid fa-pen"></i> Edit Plan</button>';
                                detailsContent += '</div>';
                            } else if (currentRole === 'clinical-assistant') {
                                detailsContent += '<div class="block-action-buttons">';
                                detailsContent += '<button class="block-action-btn view" onclick="viewBlockDetails(\'treatment-plan\')" title="View treatment plan"><i class="fa-solid fa-eye"></i> View Details</button>';
                                detailsContent += '</div>';
                            }
                        } else if (block.type === 'prs' && permissions.canViewScores) {
                            detailsContent = `
                                <div class="block-info-grid">
                                    <div class="block-info-item">
                                        <div class="block-info-label">Total Score</div>
                                        <div class="block-info-value">18/50</div>
                                    </div>
                                    <div class="block-info-item">
                                        <div class="block-info-label">Severity</div>
                                        <div class="block-info-value" style="color: var(--orange-primary);">Mild (36%)</div>
                                    </div>
                                    <div class="block-info-item">
                                        <div class="block-info-label">Completed By</div>
                                        <div class="block-info-value" style="font-size: 12px;">${block.completedBy}</div>
                                    </div>
                                </div>
                            `;
                            if (permissions.canViewReports || permissions.canEditData) {
                                detailsContent += '<div class="block-action-buttons">';
                                if (permissions.canViewReports) {
                                    detailsContent += '<button class="block-action-btn view" onclick="viewBlockDetails(\'' + block.type + '\')" title="View detailed report"><i class="fa-solid fa-eye"></i> View Details</button>';
                                }
                                if (permissions.canEditData) {
                                    detailsContent += '<button class="block-action-btn edit" onclick="editBlockDetails(\'' + block.type + '\')" title="Edit assessment data"><i class="fa-solid fa-pen"></i> Edit Details</button>';
                                }
                                detailsContent += '</div>';
                            }
                        } else if (permissions.canViewScores) {
                            detailsContent = `
                                <div class="block-info-grid">
                                    <div class="block-info-item">
                                        <div class="block-info-label">Status</div>
                                        <div class="block-info-value" style="font-size: 12px;">Completed</div>
                                    </div>
                                    <div class="block-info-item">
                                        <div class="block-info-label">Completed By</div>
                                        <div class="block-info-value" style="font-size: 12px;">${block.completedBy}</div>
                                    </div>
                                    <div class="block-info-item">
                                        <div class="block-info-label">Date</div>
                                        <div class="block-info-value" style="font-size: 12px;">${block.completedAt}</div>
                                    </div>
                                </div>
                            `;
                            if (permissions.canViewReports || permissions.canEditData) {
                                detailsContent += '<div class="block-action-buttons">';
                                if (permissions.canViewReports) {
                                    detailsContent += '<button class="block-action-btn view" onclick="viewBlockDetails(\'' + block.type + '\')" title="View detailed report"><i class="fa-solid fa-eye"></i> View Details</button>';
                                }
                                if (permissions.canEditData) {
                                    detailsContent += '<button class="block-action-btn edit" onclick="editBlockDetails(\'' + block.type + '\')" title="Edit assessment data"><i class="fa-solid fa-pen"></i> Edit Details</button>';
                                }
                                detailsContent += '</div>';
                            }
                        }
                    } else if (block.status === 'active') {
                        if (block.type === 'prs') {
                            detailsContent = `
                                <div class="block-info-grid">
                                    <div class="block-info-item">
                                        <div class="block-info-label">Progress</div>
                                        <div class="block-info-value">${block.currentProgress || 40}%</div>
                                    </div>
                                    <div class="block-info-item">
                                        <div class="block-info-label">Diseases Assessed</div>
                                        <div class="block-info-value" style="font-size: 11px;">Parkinson's</div>
                                    </div>
                                    <div class="block-info-item">
                                        <div class="block-info-label">Assigned To</div>
                                        <div class="block-info-value" style="font-size: 12px;">${block.performer}</div>
                                    </div>
                                    <div class="block-info-item">
                                        <div class="block-info-label">Started</div>
                                        <div class="block-info-value" style="font-size: 12px;">${block.startedAt}</div>
                                    </div>
                                </div>
                                <div class="detail-section">
                                    <div class="detail-section-title">Current Scores</div>
                                    <div class="block-info-grid">
                                        <div class="block-info-item">
                                            <div class="block-info-label">Tremor</div>
                                            <div class="block-info-value" style="font-size: 12px;">Moderate</div>
                                        </div>
                                        <div class="block-info-item">
                                            <div class="block-info-label">Rigidity</div>
                                            <div class="block-info-value" style="font-size: 12px;">Mild</div>
                                        </div>
                                        <div class="block-info-item">
                                            <div class="block-info-label">Bradykinesia</div>
                                            <div class="block-info-value" style="font-size: 12px;">Moderate</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                            if (permissions.canViewReports || permissions.canEditData) {
                                detailsContent += '<div class="block-action-buttons">';
                                if (permissions.canViewReports) {
                                    detailsContent += '<button class="block-action-btn view" onclick="openPrsModal(false)" title="View current PRS assessment"><i class="fa-solid fa-eye"></i> View Details</button>';
                                }
                                if (permissions.canEditData) {
                                    detailsContent += '<button class="block-action-btn edit" onclick="window.open(\'prs-edit.html?mode=continue\', \'_blank\')" title="Continue PRS assessment"><i class="fa-solid fa-play"></i> Continue Assessment</button>';
                                }
                                detailsContent += '</div>';
                            }
                        } else {
                            detailsContent = `
                                <div class="block-info-grid">
                                    <div class="block-info-item">
                                        <div class="block-info-label">Assigned To</div>
                                        <div class="block-info-value" style="font-size: 12px;">${block.performer || 'Not assigned'}</div>
                                    </div>
                                    <div class="block-info-item">
                                        <div class="block-info-label">Started</div>
                                        <div class="block-info-value" style="font-size: 12px;">${block.startedAt || 'Today'}</div>
                                    </div>
                                </div>
                            `;
                            if (permissions.canEditData) {
                                detailsContent += '<button class="action-button primary" style="margin-top: 12px; width: 100%;" onclick="continueBlock(\'' + block.id + '\')"><i class="fa-solid fa-play"></i> Continue</button>';
                            }
                        }
                    } else if (block.status === 'pending') {
                        // Check if current role can start this block type
                        let canStart = false;
                        let waitingMessage = '';
                        
                        if (currentRole === 'doctor') {
                            canStart = true;
                        } else if (currentRole === 'clinical-assistant') {
                            canStart = ['anamnesis', 'fnon', 'prs', 'brain-mapping'].includes(block.type);
                            if (!canStart) {
                                waitingMessage = 'Waiting for doctor';
                            }
                        } else if (currentRole === 'receptionist') {
                            waitingMessage = block.type === 'doctor-notes' || block.type === 'treatment-plan' || block.type === 'final-report' 
                                ? 'Waiting for doctor' 
                                : 'Waiting for clinical assistant';
                        } else {
                            waitingMessage = block.type === 'doctor-notes' || block.type === 'treatment-plan' || block.type === 'final-report'
                                ? 'Waiting for doctor'
                                : 'Waiting for clinical team';
                        }

                        // For pending blocks, show info ALWAYS VISIBLE (not in accordion)
                        if (canStart && permissions.canEditData) {
                            // Check if device activation is required for this block
                            if (block.requiresDeviceActivation && block.type === 'brain-mapping') {
                                expandedDetailsHTML = `
                                    <div class="block-meta" style="margin-top: 12px; font-size: 11px;">
                                        <span style="color: #f59e0b;"><i class="fa-solid fa-unlock"></i> Device Activation Required</span>
                                    </div>
                                    <div class="block-action-buttons" style="margin-top: 12px;">
                                        <button class="block-action-btn start" onclick="startDeviceAssessment('${block.type}')">
                                            <i class="fa-solid fa-unlock-keyhole"></i> Activate Device
                                        </button>
                                    </div>
                                `;
                            } else {
                                expandedDetailsHTML = `
                                    <div class="block-meta" style="margin-top: 12px; font-size: 11px;">
                                        <span style="color: #f59e0b;"><i class="fa-solid fa-circle-dot"></i> Ready to Start</span>
                                    </div>
                                    <div class="block-action-buttons" style="margin-top: 12px;">
                                        <button class="block-action-btn start" onclick="startBlock('${block.id}', '${block.type}')">
                                            <i class="fa-solid fa-play"></i> Start ${block.name}
                                        </button>
                                    </div>
                                `;
                            }
                        } else if (waitingMessage) {
                            expandedDetailsHTML = `
                                <div class="block-meta" style="margin-top: 12px; font-size: 11px;">
                                    <span style="color: #64748b;"><i class="fa-solid fa-clock"></i> ${waitingMessage}</span>
                                </div>
                            `;
                        }
                    } else if (block.status === 'locked') {
                        // Determine lock message based on lock reason
                        let lockMessage = 'Complete 4 initial assessments';
                        let lockIcon = 'fa-lock';
                        
                        if (block.lockReason === 'payment') {
                            lockMessage = 'Payment required';
                            lockIcon = 'fa-credit-card';
                        } else if (block.lockReason === 'assessment') {
                            lockMessage = 'Complete 4 initial assessments';
                            lockIcon = 'fa-lock';
                        }
                        
                        // Check if payment override is available for this block
                        const canOverride = block.allowOverride && block.lockReason === 'payment' && 
                            (currentRole === 'doctor' || currentRole === 'clinical-assistant');
                        
                        // For locked blocks, show info ALWAYS VISIBLE
                        if (canOverride) {
                            expandedDetailsHTML = `
                                <div class="block-meta" style="margin-top: 12px; font-size: 11px;">
                                    <span style="color: #dc2626;"><i class="fa-solid ${lockIcon}"></i> ${lockMessage}</span>
                                </div>
                                <div class="block-action-buttons" style="margin-top: 12px;">
                                    <button class="override-payment-btn" onclick="openPaymentOverrideModal('${block.id}', '${block.type}')">
                                        <i class="fa-solid fa-unlock"></i> Override Payment
                                    </button>
                                </div>
                            `;
                        } else {
                            expandedDetailsHTML = `
                                <div class="block-meta" style="margin-top: 12px; font-size: 11px;">
                                    <span style="color: #94a3b8;"><i class="fa-solid ${lockIcon}"></i> ${lockMessage}</span>
                                </div>
                            `;
                        }
                    }

                    if (detailsContent) {
                        expandedDetailsHTML = `<div class="block-expanded-details">${detailsContent}</div>`;
                    }
                }

                blockDiv.innerHTML = `
                    <div class="block-status">
                        <span class="block-status-icon">${statusIcon}</span>
                        <span class="block-status-text">${statusText}</span>
                    </div>
                    <div class="block-icon">
                        <i class="fa-solid ${iconMap[block.type] || 'fa-circle'}"></i>
                    </div>
                    <div class="block-name">${block.name}</div>
                    <div class="block-desc">${block.desc}</div>
                    ${expandedDetailsHTML}
                    ${expandedDetailsHTML && block.status === 'completed' && (permissions.canViewScores || permissions.canViewReports) ? '<div class="accordion-indicator"><i class="fa-solid fa-chevron-down"></i></div>' : ''}
                `;

                // Add click handler ONLY for completed blocks with details
                if (expandedDetailsHTML && block.status === 'completed' && (permissions.canViewScores || permissions.canViewReports || permissions.canEditData)) {
                    blockDiv.style.cursor = 'pointer';
                    blockDiv.onclick = function (event) {
                        if (event.target.tagName === 'BUTTON' || event.target.closest('button') || event.target.closest('.block-action-btn')) {
                            return;
                        }
                        this.classList.toggle('expanded');
                    };
                }

                blocksGrid.appendChild(blockDiv);
            });

            container.appendChild(blocksGrid);
            } // END if (!hasSessions)
            
            // SESSIONS SECTION - Only rendered when sessions exist (replaces assessments)
            if (hasSessions) {

                // Create sessions grid
                const sessionsGrid = document.createElement('div');
                sessionsGrid.className = 'blocks-container';

                patientData.sessions.forEach(session => {
                    const sessionDiv = document.createElement('div');
                    sessionDiv.className = `block-card ${session.status}`;

                    // Only 3 states: completed, pending, locked (no active - one session per day)
                    let statusIcon, statusText, statusColor;
                    if (session.status === 'completed') {
                        statusIcon = '';
                        statusText = 'Completed';
                        statusColor = '#10b981';
                    } else if (session.status === 'pending') {
                        statusIcon = '';
                        statusText = 'Ready to Start';
                        statusColor = '#f59e0b';
                    } else {
                        statusIcon = '';
                        statusText = 'Locked';
                        statusColor = '#94a3b8';
                    }

                    let expandedDetailsHTML = '';

                    // COMPLETED: Show details and view button based on role
                    if (session.status === 'completed') {
                        // Only show details to doctor, clinical-assistant, and patient (NOT receptionist)
                        const canViewPrivateInfo = currentRole === 'doctor' || currentRole === 'clinical-assistant' || currentRole === 'patient';
                        
                        // Build device info with montage (only for neuronika and tps)
                        let deviceInfo = session.device || 'Not specified';
                        const deviceLower = (session.device || '').toLowerCase();
                        const showMontage = (deviceLower === 'neuronika' || deviceLower === 'tps') && session.montage;
                        
                        // Map activities to images for hover
                        const activityImages = {
                            'Sudoku': 'sudoku.jpg',
                            'Crossword': 'crossword.avif',
                            'Balance Test': 'balance.jpeg',
                            'Walking': 'walking.jpeg',
                            'Toe Touch': 'exercise.png',
                            'Breathing Exercise': 'exercise.png',
                            'Memory Game': 'sudoku.jpg'
                        };
                        
                        expandedDetailsHTML = `
                            <div class="block-expanded-details">
                                <!-- Basic Session Info -->
                                <div class="block-info-grid" style="margin-bottom: 12px;">
                                    <div class="block-info-item">
                                        <div class="block-info-label">Date</div>
                                        <div class="block-info-value">${session.completedAt}</div>
                                    </div>
                                    <div class="block-info-item">
                                        <div class="block-info-label">Duration</div>
                                        <div class="block-info-value">${session.duration || '60 min'}</div>
                                    </div>
                                    <div class="block-info-item">
                                        <div class="block-info-label">Therapist</div>
                                        <div class="block-info-value">${session.completedBy}</div>
                                    </div>
                                    ${canViewPrivateInfo ? `
                                        <div class="block-info-item">
                                            <div class="block-info-label">Device</div>
                                            <div class="block-info-value">${deviceInfo}${showMontage ? ` (${session.montage})` : ''}</div>
                                        </div>
                                    ` : ''}
                                </div>
                                
                                ${canViewPrivateInfo ? `
                                    <!-- Activities Performed -->
                                    ${session.activities && session.activities.length > 0 ? `
                                        <div style="margin-bottom: 12px;">
                                            <div style="font-size: 11px; font-weight: 700; color: #64748b; margin-bottom: 8px;">Activities Performed</div>
                                            <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                                ${session.activities.map(activity => `
                                                    <span style="position: relative; display: inline-block; background: white; border: 2px solid #e2e8f0; color: #0f172a; padding: 6px 12px; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer;">
                                                        ${activity}
                                                        <img src="${activityImages[activity] || 'sudoku.jpg'}" alt="${activity}" style="display: none; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); width: 80px; height: 80px; object-fit: cover; border-radius: 8px; margin-bottom: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 2px solid white; z-index: 10;" onload="this.parentElement.addEventListener('mouseenter', () => this.style.display = 'block'); this.parentElement.addEventListener('mouseleave', () => this.style.display = 'none');">
                                                    </span>
                                                `).join('')}
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    <!-- Symptoms & Clinical Notes -->
                                    ${session.symptoms || session.clinicalNotes ? `
                                        <div style="background: #f8fafc; border-radius: 6px; padding: 10px; margin-bottom: 12px; font-size: 11px; color: #475569; line-height: 1.5;">
                                            ${session.symptoms ? `<div style="margin-bottom: 6px;"><strong style="color: #0f172a;">Symptoms:</strong> ${session.symptoms}</div>` : ''}
                                            ${session.clinicalNotes ? `<div><strong style="color: #0f172a;">Notes:</strong> ${session.clinicalNotes}</div>` : ''}
                                        </div>
                                    ` : ''}
                                ` : ''}
                                
                                ${permissions.canViewReports ? `
                                    <div class="block-action-buttons">
                                        <button class="block-action-btn view" onclick="viewSessionDetails('${session.id}')">
                                            <i class="fa-solid fa-eye"></i> View Full Report
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }
                    // PENDING: Show start button based on role (doctor or clinical-assistant only)
                    else if (session.status === 'pending') {
                        const canStartSession = (currentRole === 'doctor' || currentRole === 'clinical-assistant') && permissions.canEditData;
                        
                        if (canStartSession) {
                            expandedDetailsHTML = `
                                <div class="block-meta" style="margin-top: 12px; font-size: 11px;">
                                    <span style="color: #f59e0b;"><i class="fa-solid fa-calendar"></i> ${session.scheduledDate || 'Today'}</span>
                                </div>
                                <div class="block-action-buttons" style="margin-top: 12px;">
                                    <button class="block-action-btn start" onclick="startSession('${session.id}')">
                                        <i class="fa-solid fa-play"></i> Start ${session.name}
                                    </button>
                                </div>
                            `;
                        } else {
                            expandedDetailsHTML = `
                                <div class="block-meta" style="margin-top: 12px; font-size: 11px;">
                                    <span style="color: #64748b;"><i class="fa-solid fa-calendar"></i> ${session.scheduledDate || 'Today'}</span>
                                </div>
                            `;
                        }
                    }
                    // LOCKED: Show lock reason
                    else if (session.status === 'locked') {
                        expandedDetailsHTML = `
                            <div class="block-meta" style="margin-top: 12px; font-size: 11px;">
                                <span style="color: #94a3b8;"><i class="fa-solid fa-lock"></i> ${session.lockReason || 'Complete previous session'}</span>
                            </div>
                        `;
                    }

                    sessionDiv.innerHTML = `
                        <div class="block-status" style="background: ${statusColor}15; color: ${statusColor}; border: 1px solid ${statusColor};">
                            <span class="block-status-icon">${statusIcon}</span>
                            <span class="block-status-text">${statusText}</span>
                        </div>
                        <div class="block-icon">
                            <i class="fa-solid fa-calendar-day"></i>
                        </div>
                        <div class="block-name">${session.name}</div>
                        <div class="block-desc">${session.desc}</div>
                        ${expandedDetailsHTML}
                        ${session.status === 'completed' && expandedDetailsHTML ? '<div class="accordion-indicator"><i class="fa-solid fa-chevron-down"></i></div>' : ''}
                    `;

                    // Add click handler for completed sessions
                    if (session.status === 'completed' && expandedDetailsHTML) {
                        sessionDiv.style.cursor = 'pointer';
                        sessionDiv.onclick = function(event) {
                            if (event.target.tagName === 'BUTTON' || event.target.closest('button')) return;
                            this.classList.toggle('expanded');
                        };
                    }

                    sessionsGrid.appendChild(sessionDiv);
                });

                container.appendChild(sessionsGrid);
            }
            
            } // END OF assessment-blocks wireframe
        } // END OF renderTodayView
        
        const workingBlocks = [
            {
                id: 'working-block-0',
                type: 'anamnesis',
                name: 'Anamnesis',
                desc: 'Patient symptoms and medical history',
                requiresPrevious: false
            },
            {
                id: 'working-block-1',
                type: 'fnon',
                name: 'FNON Assessment',
                desc: 'Functional neurological assessment across multiple domains',
                requiresPrevious: false
            },
            {
                id: 'working-block-2',
                type: 'brain-mapping',
                name: 'Brain Mapping',
                desc: 'EEG data capture and neural activity analysis',
                requiresPrevious: false
            },
            {
                id: 'working-block-3',
                type: 'prs',
                name: 'PRS Evaluation',
                desc: 'Disease-specific symptom assessment and scoring',
                requiresPrevious: false
            },
            {
                id: 'working-block-4',
                type: 'doctors-notes',
                name: "Doctor's Notes",
                desc: 'Clinical observations and medical recommendations',
                requiresPrevious: true
            },
            {
                id: 'working-block-5',
                type: 'treatment-plan',
                name: 'Treatment Plan',
                desc: 'Personalized therapy protocol and montage selection',
                requiresPrevious: true
            },
            {
                id: 'working-block-6',
                type: 'final-report',
                name: 'Final Report',
                desc: 'Comprehensive assessment summary and outcomes',
                requiresPrevious: true
            }
        ];

        // GET WORKING JOURNEY PERMISSIONS
        function getWorkingPermissions(role) {
            const permissions = {
                'doctor': {
                    canStart: ['anamnesis', 'fnon', 'brain-mapping', 'prs'],
                    canView: ['anamnesis', 'fnon', 'brain-mapping', 'prs', 'doctors-notes', 'treatment-plan', 'final-report'],
                    showStartButtons: true,
                    label: 'Doctor'
                },
                'clinical-assistant': {
                    canStart: ['anamnesis', 'prs'],
                    canView: ['anamnesis', 'fnon', 'brain-mapping', 'prs', 'doctors-notes', 'treatment-plan', 'final-report'],
                    showStartButtons: true,
                    restrictedMessage: 'Only doctors can perform this assessment',
                    label: 'Clinical Assistant'
                },
                'receptionist': {
                    canStart: [],
                    canView: ['anamnesis', 'fnon', 'brain-mapping', 'prs', 'doctors-notes', 'treatment-plan', 'final-report'],
                    showStartButtons: false,
                    label: 'Receptionist'
                },
                'patient': {
                    canStart: [],
                    canView: ['anamnesis', 'fnon', 'brain-mapping', 'prs', 'doctors-notes', 'treatment-plan', 'final-report'],
                    showStartButtons: false,
                    label: 'Patient'
                }
            };
            return permissions[role];
        }

        // RENDER WORKING JOURNEY VIEW
        function renderWorkingView() {
            const container = document.getElementById('workingBlocksContainer');
            const permissions = getWorkingPermissions(currentRole);
            container.innerHTML = '';

            workingBlocks.forEach(block => {
                const blockDiv = document.createElement('div');

                const canStart = !block.requiresPrevious && permissions.canStart.includes(block.type);
                const canView = permissions.canView.includes(block.type) && !canStart && !block.requiresPrevious;
                const isLocked = block.requiresPrevious;

                let statusClass = 'locked';
                let statusText = 'Locked';
                if (canStart) {
                    statusClass = 'ready';
                    statusText = 'Can Start';
                } else if (canView) {
                    statusClass = 'view-only';
                    statusText = 'View Only';
                }

                blockDiv.className = `block-card ${block.type} ${canStart ? 'can-start' : ''} ${isLocked ? 'locked' : ''}`;

                let actionHTML = '';
                if (permissions.showStartButtons && !isLocked) {
                    if (canStart) {
                        actionHTML = `
                            <div class="block-actions" style="margin-top: auto;">
                                <button class="start-button primary" onclick="startWorkingBlock('${block.id}', '${block.name}')">
                                    <i class="fa-solid fa-play"></i>
                                    Start Assessment
                                </button>
                            </div>
                        `;
                    } else if (canView && currentRole === 'clinical-assistant') {
                        actionHTML = `
                            <div class="block-actions tooltip" style="margin-top: auto;">
                                <button class="start-button disabled">
                                    <i class="fa-solid fa-lock"></i>
                                    Restricted
                                </button>
                                <span class="tooltip-text">${permissions.restrictedMessage}</span>
                            </div>
                        `;
                    }
                } else if (!isLocked && currentRole === 'patient') {
                    actionHTML = `
                        <div class="block-actions" style="margin-top: auto;">
                            <button class="start-button view-only">
                                <i class="fa-solid fa-eye"></i>
                                View Information
                            </button>
                        </div>
                    `;
                }

                if (isLocked) {
                    actionHTML = `
                        <div class="block-actions" style="margin-top: auto;">
                            <button class="start-button disabled">
                                <i class="fa-solid fa-lock"></i>
                                Complete Previous Steps
                            </button>
                        </div>
                    `;
                }

                blockDiv.innerHTML = `
                    <div class="block-status ${statusClass}">
                        <span class="block-status-icon">${statusClass === 'ready' ? '' : statusClass === 'view-only' ? '' : ''}</span>
                        <span class="block-status-text">${statusText}</span>
                    </div>
                    <div class="block-icon">
                        <i class="fa-solid ${iconMap[block.type] || 'fa-circle'}"></i>
                    </div>
                    <div class="block-name">${block.name}</div>
                    <div class="block-desc">${block.desc}</div>
                    ${actionHTML}
                `;

                container.appendChild(blockDiv);
            });
        }

        // START BLOCK - Navigate to assessment pages
        // Session action functions
        function startSession(sessionId) {
            // Store session context
            sessionStorage.setItem('activeSessionId', sessionId);
            sessionStorage.setItem('currentPatientId', selectedPatientData?.id || 'unknown');
            sessionStorage.setItem('patientName', selectedPatientData ? `${selectedPatientData.firstName} ${selectedPatientData.lastName}` : 'Unknown');
            sessionStorage.setItem('currentRole', currentRole);
            
            // Navigate to start-session.html to begin the treatment session
            window.open('start-session.html?session=' + sessionId, '_blank');
        }

        function continueSession(sessionId) {
            // Store session context
            sessionStorage.setItem('activeSessionId', sessionId);
            sessionStorage.setItem('currentPatientId', selectedPatientData?.id || 'unknown');
            sessionStorage.setItem('currentRole', currentRole);
            
            // Navigate to active journey to continue session
            window.open('working-active-journey.html?session=' + sessionId, '_blank');
        }

        function viewSessionDetails(sessionId) {
            // Store session context for viewing
            sessionStorage.setItem('sessionId', sessionId);
            sessionStorage.setItem('currentPatientId', selectedPatientData?.id || 'unknown');
            sessionStorage.setItem('sessionMode', 'view');
            sessionStorage.setItem('currentRole', currentRole);
            
            // Navigate to view-session.html to view session report
            window.open('view-session.html?session=' + sessionId, '_blank');
        }

        function startBlock(blockId, blockType) {
            // Map block types to their respective pages
            if (blockType === 'anamnesis') {
                window.open('anamnesis.html', '_blank');
            } else if (blockType === 'fnon') {
                window.open('fnon-edit.html', '_blank');
            } else if (blockType === 'brain-mapping') {
                // All roles can start brain mapping, but only doctors can generate EEG in eeg.html
                const patientNameElement = document.getElementById('patientFullName');
                const patientName = patientNameElement ? patientNameElement.textContent : 'Patient';
                
                const sessionData = {
                    currentRole: currentRole,
                    patientName: patientName,
                    blockType: 'brain-mapping',
                    viewMode: 'edit',
                    returnUrl: window.location.href
                };
                localStorage.setItem('eegSession', JSON.stringify(sessionData));
                window.open('eeg.html', '_blank');
            } else if (blockType === 'prs') {
                window.open('prs-edit.html', '_blank');
            } else if (blockType === 'doctor-notes') {
                // Open Doctor's Notes modal in edit mode
                openDoctorNotesModal(true);
            } else if (blockType === 'treatment-plan') {
                // Navigate to treatment plan page (role-based view handled in target page)
                window.open('treatment-plan.html', '_blank');
            } else if (blockType === 'final-report') {
                window.open('final-report.html', '_blank');
            } else {
                alert(`Starting: ${blockType}\\n\\nRole: ${currentRole}\\n\\nThis would open the assessment interface.`);
            }
        }

        // START WORKING BLOCK
        function startWorkingBlock(blockId, blockName) {
            // Check if this is an anamnesis block and redirect appropriately
            const block = workingBlocks.find(b => b.id === blockId);
            if (block && block.type === 'anamnesis') {
                window.open('anamnesis.html', '_blank');
            } else {
                alert(`Starting: ${blockName}\\n\\nRole: ${currentRole}\\n\\nThis would open the assessment interface for data entry.`);
            }
        }

        // RENDER DEVICE LOCKING VIEW
        function renderDeviceView() {
            const permissions = getWorkingPermissions(currentRole);

            // Render LOCKED state
            const lockedContainer = document.getElementById('deviceLockedContainer');
            lockedContainer.innerHTML = '';

            const lockedBlock = createDeviceBlock('Brain Mapping', 'brain-mapping', true, permissions);
            lockedContainer.appendChild(lockedBlock);

            // Render UNLOCKED state
            const unlockedContainer = document.getElementById('deviceUnlockedContainer');
            unlockedContainer.innerHTML = '';

            const unlockedBlock = createDeviceBlock('Brain Mapping', 'brain-mapping', false, permissions);
            unlockedContainer.appendChild(unlockedBlock);
        }

        // CREATE DEVICE BLOCK
        function createDeviceBlock(name, type, isPaymentLocked, permissions) {
            const blockDiv = document.createElement('div');
            blockDiv.className = `block-card ${type}`;

            let statusHTML = '';
            let actionHTML = '';
            let additionalInfo = '';

            if (isPaymentLocked) {
                // LOCKED STATE - Payment not processed
                blockDiv.classList.add('locked');
                statusHTML = `
                    <div class="block-status locked">
                        <span class="block-status-icon"></span>
                        <span class="block-status-text">Payment Pending</span>
                    </div>
                `;

                additionalInfo = `
                    <div class="payment-warning">
                        <i class="fa-solid fa-exclamation-triangle"></i>
                        <span>Device activation requires payment confirmation</span>
                    </div>
                `;

                actionHTML = `
                    <div class="block-actions" style="margin-top: auto;">
                        <button class="start-button disabled">
                            <i class="fa-solid fa-lock"></i>
                            Device Locked - Payment Required
                        </button>
                    </div>
                `;
            } else {
                // UNLOCKED STATE - Payment processed
                const canStart = permissions.canStart.includes(type);

                if (canStart) {
                    statusHTML = `
                        <div class="block-status ready">
                            <span class="block-status-icon"></span>
                            <span class="block-status-text">Device Active</span>
                        </div>
                    `;
                    blockDiv.classList.add('can-start');
                } else {
                    statusHTML = `
                        <div class="block-status view-only">
                            <span class="block-status-icon"></span>
                            <span class="block-status-text">Device Active</span>
                        </div>
                    `;
                }

                additionalInfo = `
                    <div class="payment-success">
                        <i class="fa-solid fa-circle-check"></i>
                        <span>Payment confirmed - Device ready for use</span>
                    </div>
                `;

                if (permissions.showStartButtons && canStart) {
                    actionHTML = `
                        <div class="block-actions" style="margin-top: auto;">
                            <button class="start-button primary" onclick="startDeviceAssessment('${type}')">
                                <i class="fa-solid fa-play"></i>
                                Start Assessment
                            </button>
                        </div>
                    `;
                } else if (currentRole === 'clinical-assistant' && !canStart) {
                    actionHTML = `
                        <div class="block-actions tooltip" style="margin-top: auto;">
                            <button class="start-button disabled">
                                <i class="fa-solid fa-lock"></i>
                                Restricted
                            </button>
                            <span class="tooltip-text">Only doctors can perform this assessment</span>
                        </div>
                    `;
                } else if (currentRole === 'patient') {
                    actionHTML = `
                        <div class="block-actions" style="margin-top: auto;">
                            <button class="start-button view-only">
                                <i class="fa-solid fa-eye"></i>
                                View Information
                            </button>
                        </div>
                    `;
                } else if (currentRole === 'receptionist') {
                    actionHTML = `
                        <div class="block-actions" style="margin-top: auto;">
                            <button class="start-button view-only">
                                <i class="fa-solid fa-check-circle"></i>
                                Payment Confirmed
                            </button>
                        </div>
                    `;
                }
            }

            blockDiv.innerHTML = `
                ${statusHTML}
                <div class="block-icon">
                    <i class="fa-solid ${iconMap[type] || 'fa-circle'}"></i>
                </div>
                <div class="block-name">${name}</div>
                <div class="block-desc">EEG data capture and neural activity analysis</div>
                ${additionalInfo}
                ${actionHTML}
            `;

            return blockDiv;
        }

        // START DEVICE ASSESSMENT
        function startDeviceAssessment(type) {
            // Update patient name in modal
            const patientName = selectedPatientData ? selectedPatientData.name : 'James Wilson';
            const activationNameEl = document.getElementById('activationPatientName');
            if (activationNameEl) {
                activationNameEl.textContent = patientName;
            }
            
            // Reset modal to step 1
            document.getElementById('activationStep1').style.display = 'block';
            document.getElementById('activationStep2').style.display = 'none';
            
            // Show modal
            const modal = document.getElementById('deviceActivationModal');
            if (modal) {
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        }

        function closeDeviceActivationModal() {
            const modal = document.getElementById('deviceActivationModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        function generateSerialKey() {
            // Generate a random serial key
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let key = '';
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 4; j++) {
                    key += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                if (i < 2) key += '-';
            }
            
            // Display the key with animation
            const keyDisplay = document.getElementById('serialKeyDisplay');
            if (keyDisplay) {
                keyDisplay.textContent = key;
            }
            
            // Move to step 2
            document.getElementById('activationStep1').style.display = 'none';
            document.getElementById('activationStep2').style.display = 'block';
        }

        function proceedToBrainMapping() {
            // Close modal
            closeDeviceActivationModal();
            
            // Store session context
            const patientId = selectedPatientData ? selectedPatientData.id : 'P-NEW-3';
            const patientName = selectedPatientData ? selectedPatientData.name : 'James Wilson';
            
            sessionStorage.setItem('currentPatientId', patientId);
            sessionStorage.setItem('patientName', patientName);
            sessionStorage.setItem('currentRole', currentRole);
            sessionStorage.setItem('eegSession', JSON.stringify({
                patientId: patientId,
                startTime: new Date().toISOString(),
                operator: currentRole,
                deviceActivated: true,
                serialKey: document.getElementById('serialKeyDisplay').textContent
            }));
            
            // Navigate to EEG interface
            window.open('eeg.html', '_blank');
        }

        // ACTION HANDLERS
        function viewBlockReport(blockId) {
            alert(`Viewing report for block: ${blockId}\\n\\nThis would open the detailed report in ${currentRole} view.`);
        }

        function continueBlock(blockId) {
            // Check if this is a PRS block
            if (blockId && blockId.includes('prs')) {
                window.open('prs-edit.html?mode=continue', '_blank');
            } else {
                alert(`Continuing block: ${blockId}\\n\\nThis would open the data entry interface.`);
            }
        }

        function viewBlockDetails(blockType) {
            if (blockType === 'anamnesis') {
                // Open Anamnesis modal in read-only mode
                openAnamnesisModal(false);
            } else if (blockType === 'fnon') {
                // Get patient name from the header or from state
                const patientNameElement = document.getElementById('patientFullName');
                const patientName = patientNameElement ? patientNameElement.textContent : 'Sarah Mitchell';

                // Update modal with patient information (guard missing elements)
                const apEl = document.getElementById('assessmentPatientName');
                if (apEl) apEl.textContent = patientName;
                const modalNameEl = document.getElementById('modalPatientName');
                if (modalNameEl) modalNameEl.textContent = patientName;
                // Render FNON sections in read-only mode
                renderFnonModal(false);

                // Show the modal
                const modal = document.getElementById('fnonAssessmentModal');
                if (modal) modal.classList.add('open');

                // Prevent body scroll when modal is open
                document.body.style.overflow = 'hidden';
            } else if (blockType === 'brain-mapping') {
                // Show EEG PDF report modal
                const pdfModal = document.getElementById('eegPdfViewerModal');
                const pdfFrame = document.getElementById('eegReportFrame');
                pdfFrame.src = 'eeg.pdf';
                pdfModal.classList.add('open');
                document.body.style.overflow = 'hidden';
            } else if (blockType === 'prs') {
                // Open PRS modal in read-only mode
                openPrsModal(false);
            } else if (blockType === 'doctor-notes') {
                // Open Doctor's Notes modal in read-only mode
                openDoctorNotesModal(false);
            } else if (blockType === 'treatment-plan') {
                // Navigate to treatment plan page (role-based view handled in target page)
                window.open('treatment-plan.html', '_blank');
            } else if (blockType === 'final-report') {
                // Navigate to final-report.html in new tab
                window.open('final-report.html', '_blank');
            } else {
                // For other block types, show placeholder alert
                const blockNames = {
                    'brain-mapping': 'Brain Mapping (EEG)',
                    'prs': 'PRS Evaluation',
                    'doctor-notes': "Doctor's Notes",
                    'treatment-plan': 'Treatment Plan',
                    'final-report': 'Final Report'
                };
                alert(`Viewing Detailed Report\\n\\nBlock: ${blockNames[blockType] || blockType}\\nRole: ${currentRole}\\n\\nThis would open a comprehensive view with:\\n- Full assessment data\\n- Charts and visualizations\\n- Historical comparisons\\n- Downloadable reports`);
            }
        }

        function closeAssessmentModal(event) {
            // If clicking on the modal background or close button, close it
            if (event && event.target !== event.currentTarget && event.target.closest('.assessment-modal-close') === null) {
                return;
            }

            const modal = document.getElementById('fnonAssessmentModal');
            if (modal) {
                modal.classList.remove('open');
                modal.classList.remove('editing');

                // If we set the body editable for edit mode, remove it
                const modalBody = modal.querySelector('.assessment-modal-body');
                if (modalBody) {
                    modalBody.removeAttribute('contenteditable');
                    modalBody.style.outline = '';
                }

                // Reset header title if it was changed during edit
                const titleEl = modal.querySelector('.assessment-modal-title h2');
                if (titleEl) titleEl.textContent = 'FNON Assessment';
            }

            // Restore body scroll
            document.body.style.overflow = 'auto';
        }

        function editBlockDetails(blockType) {
            const blockNames = {
                'anamnesis': 'Anamnesis Assessment',
                'fnon': 'FNON Assessment',
                'brain-mapping': 'Brain Mapping (EEG)',
                'prs': 'PRS Evaluation',
                'doctor-notes': "Doctor's Notes",
                'treatment-plan': 'Treatment Plan',
                'final-report': 'Final Report'
            };
            if (blockType === 'anamnesis') {
                // Navigate to anamnesis.html
                window.open('anamnesis.html', '_blank');
                return;
            } else if (blockType === 'fnon') {
                // Navigate to fnon-edit.html page
                window.open('fnon-edit.html', '_blank');
                return;
            } else if (blockType === 'brain-mapping') {
                // Navigate to eeg.html page for doctor role
                if (currentRole === 'doctor') {
                    const patientNameElement = document.getElementById('patientFullName');
                    const patientName = patientNameElement ? patientNameElement.textContent : 'Patient';
                    
                    const sessionData = {
                        currentRole: currentRole,
                        patientName: patientName,
                        blockType: 'brain-mapping',
                        viewMode: 'edit',
                        returnUrl: window.location.href
                    };
                    localStorage.setItem('eegSession', JSON.stringify(sessionData));
                    window.open('eeg.html', '_blank');
                } else {
                    alert('Only doctors can edit EEG brain mapping assessments.');
                }
                return;
            } else if (blockType === 'prs') {
                // Navigate to prs-edit.html page
                window.open('prs-edit.html', '_blank');
                return;
            } else if (blockType === 'doctor-notes') {
                // Open Doctor's Notes modal in edit mode
                openDoctorNotesModal(true);
                return;
            } else if (blockType === 'treatment-plan') {
                // Navigate to treatment plan page (role-based view handled in target page)
                window.open('treatment-plan.html', '_blank');
                return;
            } else if (blockType === 'final-report') {
                // Navigate to final-report.html in new tab
                window.open('final-report.html', '_blank');
                return;
            }

            // Fallback behavior for other block types remains a simple alert
            alert(`Editing Assessment Data\\n\\nBlock: ${blockNames[blockType] || blockType}\\nRole: ${currentRole}\\n\\nThis would open an edit interface with:\\n- Editable assessment fields\\n- Data validation\\n- Save/Cancel options\\n- Audit trail logging`);
        }

        function editSessionDetails(sessionId) {
            // Store session context for editing
            sessionStorage.setItem('sessionId', sessionId);
            sessionStorage.setItem('currentPatientId', selectedPatientData?.id || 'unknown');
            sessionStorage.setItem('sessionMode', 'edit');
            sessionStorage.setItem('currentRole', currentRole);
            
            // Navigate to workshop detail page in edit mode
            window.open('workshop_detail.html?session=' + sessionId + '&mode=edit', '_blank');
        }

        function activateSession(sessionId) {
            alert(`Activating Session\\n\\nSession: ${sessionId}\\nRole: ${currentRole}\\n\\nThis would:\\n- Confirm payment of 100\\n- Mark session as active\\n- Notify clinical staff\\n- Update patient dashboard`);
        }

        function activateSessionWithFlow(sessionId) {
            // Check role permissions
            if (currentRole !== 'doctor' && currentRole !== 'clinical-assistant') {
                alert(`Access Denied\\n\\nOnly doctors and clinical assistants can activate treatment sessions.\\n\\nCurrent Role: ${currentRole === 'receptionist' ? 'Receptionist' : 'Patient'}`);
                return;
            }

            // Store session for later
            window.activatingSessionId = sessionId;

            // Create a dummy session patient object
            const sessionPatient = {
                firstName: document.getElementById('patientFullName') ? document.getElementById('patientFullName').textContent.split(' ')[0] : 'Sarah',
                lastName: document.getElementById('patientFullName') ? document.getElementById('patientFullName').textContent.split(' ')[1] : 'Mitchell',
                age: 32,
                gender: 'Female',
                condition: 'Depression',
                sessionNumber: 4,
                sessionFee: 100
            };

            // Show consent form for session
            showConsentFormForSession(sessionPatient);
        }

        function showConsentFormForSession(sessionPatient) {
            currentOnboardingPatient = sessionPatient;

            // Hide journey
            document.getElementById('journeyContent').style.display = 'none';
            document.getElementById('selectedPatientHeader').style.display = 'none';

            // Show consent form
            document.getElementById('consentFormPage').style.display = 'block';

            // Populate patient name in consent form
            const fullName = `${sessionPatient.firstName} ${sessionPatient.lastName}`;
            document.getElementById('consentFullName').value = fullName;

            // Set context flag
            window.isSessionActivation = true;
            window.consentFormOrigin = 'session';

            // Initialize signature canvas
            setTimeout(() => {
                initSignatureCanvas();
                setupConsentListeners();
            }, 100);
        }

        function submitConsent() {
            // Check if signature exists
            if (!hasSignature) {
                alert('Please provide your signature before proceeding.');
                return;
            }

            // Check if checkbox is checked
            const consentCheckbox = document.getElementById('consentCheckbox');
            if (!consentCheckbox.checked) {
                alert('Please check the consent agreement box to proceed.');
                return;
            }

            // Store signature as base64
            const signatureCanvas = document.getElementById('signatureCanvas');
            const signatureData = signatureCanvas.toDataURL();
            currentOnboardingPatient.signature = signatureData;

            console.log('Consent signed:', {
                patient: currentOnboardingPatient.firstName + ' ' + currentOnboardingPatient.lastName,
                timestamp: new Date().toISOString(),
                signature: signatureData.substring(0, 50) + '...'
            });

            // Hide consent form
            document.getElementById('consentFormPage').style.display = 'none';

            // Show payment page
            if (window.isSessionActivation) {
                showSessionPaymentPage();
            } else {
                showPaymentPage();
            }
        }

        // --- FNON renderer and edit handlers (local-only) ---
        const fnonSpec = {
            questions: [
                { id: 'q1', title: 'Motor Network Function', hint: 'How well can you perform coordinated movements and physical tasks?' },
                { id: 'q2', title: 'Cognitive Processing Speed', hint: 'How quickly can you process information and make decisions?' },
                { id: 'q3', title: 'Memory & Recall', hint: 'How effectively do you recall recent and past events?' },
                { id: 'q4', title: 'Attention & Focus', hint: 'How well can you concentrate on a single task?' },
                { id: 'q5', title: 'Language & Communication', hint: 'How clear and effective is your verbal and written communication?' },
                { id: 'q6', title: 'Emotional Regulation', hint: 'How well do you manage emotions and respond to stress?' },
                { id: 'q7', title: 'Sleep & Autonomic Function', hint: 'How satisfied are you with your sleep patterns and autonomic regulation?' }
            ],
            sectionA: [
                { net: 'DMN', signs: 'Rumination, Mind-wandering', tests: ['Gaze fixation', 'Romberg dual-task', 'Clock drawing'] },
                { net: 'CEN', signs: 'Poor planning, Memory deficits', tests: ['Digit Span', 'Serial subtraction (100-7)', 'Motor sequencing'] },
                { net: 'SN', signs: 'Anxiety, Hyperarousal', tests: ['Startle response', 'Interoceptive awareness'] },
                { net: 'SMN', signs: 'Motor/Sensory deficits', tests: ['Finger-to-nose', 'Heel-to-shin', 'Rapid movements'] },
                { net: 'Limbic', signs: 'Emotional lability, Apathy', tests: ['Facial expression check', 'Emotional reactivity'] },
                { net: 'Attention', signs: 'Distractibility, Neglect', tests: ['Cancellation test', 'Eye tracking'] }
            ]
        };

        // local state for editable values - scores as per user's example
        const fnonState = {
            sectionA: [
                { 'Gaze fixation': 1, 'Romberg dual-task': 1, 'Clock drawing': 1 },
                { 'Digit Span': 1, 'Serial subtraction (100-7)': 1, 'Motor sequencing': 1 },
                { 'Startle response': 2, 'Interoceptive awareness': 2 },
                { 'Finger-to-nose': 0, 'Heel-to-shin': 2, 'Rapid movements': 2 },
                { 'Facial expression check': 0, 'Emotional reactivity': 0 },
                { 'Cancellation test': 2, 'Eye tracking': 1 }
            ],
            notes: ''
        };

        function renderScoreBadges(value, namePrefix, editable) {
            if (editable) {
                return ['0', '1', '2'].map(v => `
                    <label style="margin-right:8px; font-size:13px;">
                      <input type="radio" name="${namePrefix}" value="${v}" ${value == v ? 'checked' : ''} onchange="onFnonScoreChange('${namePrefix}', ${v})"> ${v}
                    </label>
                `).join('');
            }

            // read-only badges
            return ['0', '1', '2'].map(v => {
                const is = Number(value) === Number(v);
                const bg = v === '0' ? '#0ea5e9' : (v === '1' ? '#f59e0b' : '#ef4444');
                const opacity = is ? '1' : '0.35';
                const chk = is ? ' ' : '';
                return `<span style="background:${bg}; color:white; padding:4px 8px; border-radius:4px; font-size:11px; font-weight:600; opacity:${opacity}; margin-right:6px;">${v}${chk}</span>`;
            }).join('');
        }

        function calculateTotalScore() {
            let total = 0;
            fnonState.sectionA.forEach(net => {
                Object.values(net).forEach(val => total += Number(val));
            });
            return total;
        }

        function renderFnonModal(editable) {
            const body = document.querySelector('#fnonAssessmentModal .assessment-modal-body');
            if (!body) return;

            let html = '';

            // Compute summary values upfront
            const totalScore = calculateTotalScore();
            const maxScore = 30;
            const percentage = ((totalScore / maxScore) * 100).toFixed(1);
            let interpretation = 'Excellent - Minimal deficits detected';
            let interpColor = '#fed7aa';
            let interpBorder = '#fb923c';
            let interpTextColor = '#7c2d12';

            if (percentage <= 20) {
                interpretation = 'Excellent - Minimal deficits detected';
            } else if (percentage <= 40) {
                interpretation = 'Good - Mild concerns in some areas';
            } else if (percentage <= 60) {
                interpretation = 'Moderate - Several areas need attention';
            } else {
                interpretation = 'Significant - Multiple areas require intervention';
            }

            // Main title and description
            html += `<div style="margin-bottom: 24px;">
                <h2 style="font-size: 24px; font-weight: 900; color: #0f172a; margin: 0 0 8px 0;">FNON Assessment</h2>
                <p style="font-size: 14px; color: #64748b; margin: 0;">Functional Network of Neurons - Assessment Overview</p>
            </div>`;

            // Assessment Summary FIRST
            html += `<div style="margin-bottom: 24px; padding: 24px; background: linear-gradient(to right, #f8fafc, #eff6ff); border-radius: 8px; border: 2px solid #e2e8f0;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                    <h3 style="font-size: 18px; font-weight: 700; color: #0f172a; margin: 0;">
                        <i class="fa-solid fa-chart-line" style="margin-right: 8px; color: #ea580c;"></i>
                        Assessment Summary
                    </h3>
                    <div style="text-align: right;">
                        <p style="font-size: 11px; color: #64748b; text-transform: uppercase; font-weight: 600; margin: 0;">Assessed by</p>
                        <p style="font-size: 13px; font-weight: 700; color: #0f172a; margin: 4px 0 0 0;">Dr. James Wilson</p>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 16px;">
                    <div style="background: white; border-radius: 8px; border-left: 4px solid #2563eb; padding: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                        <p style="font-size: 11px; font-weight: 700; text-transform: uppercase; color: #64748b; margin: 0 0 6px 0;">Total Score</p>
                        <p style="font-size: 32px; font-weight: 900; color: #0f172a; margin: 0;">${totalScore}</p>
                        <p style="font-size: 11px; color: #64748b; margin: 4px 0 0 0;">out of ${maxScore} points</p>
                    </div>
                    
                    <div style="background: white; border-radius: 8px; border-left: 4px solid #475569; padding: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                        <p style="font-size: 11px; font-weight: 700; text-transform: uppercase; color: #64748b; margin: 0 0 6px 0;">Score Percentage</p>
                        <p style="font-size: 32px; font-weight: 900; color: #0f172a; margin: 0;">${percentage}%</p>
                        <p style="font-size: 11px; color: #64748b; margin: 4px 0 0 0;">deficit index</p>
                    </div>
                    
                    <div style="background: white; border-radius: 8px; border-left: 4px solid #ea580c; padding: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                        <p style="font-size: 11px; font-weight: 700; text-transform: uppercase; color: #64748b; margin: 0 0 6px 0;">Assessment Date</p>
                        <p style="font-size: 16px; font-weight: 900; color: #0f172a; margin: 0;">Feb 2, 2026</p>
                        <p style="font-size: 11px; color: #64748b; margin: 4px 0 0 0;">completed</p>
                    </div>
                </div>
                
                <div style="padding: 16px; background: ${interpColor}; border: 2px solid ${interpBorder}; border-radius: 8px;">
                    <p style="font-weight: 700; margin: 0 0 6px 0; color: ${interpTextColor};">
                        <i class="fa-solid fa-stethoscope" style="margin-right: 8px;"></i>
                        Clinical Interpretation
                    </p>
                    <p style="font-size: 13px; font-weight: 600; margin: 0; color: ${interpTextColor};">${interpretation}</p>
                </div>
            </div>`;

            // Clinical Notes Section - After Summary
            html += `<div style="margin-bottom: 24px; background: white; border-radius: 8px; border-left: 4px solid #8b5cf6; padding: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                <p style="font-size: 11px; font-weight: 700; text-transform: uppercase; color: #64748b; margin: 0 0 8px 0;">Clinical Notes</p>
                <p style="font-size: 13px; color: #0f172a; margin: 0; line-height: 1.5;">Patient tolerated assessment well. No adverse effects reported. Functional networks show expected patterns with minor variations in motor network activation.</p>
            </div>`;

            // Activities Performed Section
            const activities = [
                { name: 'Crossword', image: 'crossword.avif' },
                { name: 'Toe Touch', image: 'exercise.png' },
                { name: 'Walking', image: 'walking.jpeg' },
                { name: 'Sudoku', image: 'sudoku.jpg' },
                { name: 'Balance Test', image: 'balance.jpeg' }
            ];

            html += `<div style="margin-bottom: 24px;">
                <h4 style="font-size: 14px; font-weight: 700; color: #1e293b; margin: 0 0 12px 0;">Activities Performed</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;">`;
            
            activities.forEach(activity => {
                html += `<div style="background: white; border: 2px solid #e2e8f0; border-radius: 8px; padding: 12px; text-align: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                    <img src="${activity.image}" alt="${activity.name}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px; margin-bottom: 8px;">
                    <p style="font-size: 12px; font-weight: 600; color: #0f172a; margin: 0;">${activity.name}</p>
                </div>`;
            });

            html += `</div>
            </div>`;

            // Assessment Overview cards
            html += `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 24px;">
                <div style="background: white; border-radius: 8px; border-left: 4px solid #3b82f6; padding: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                    <p style="font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #475569; margin: 0 0 8px 0;">Assessment Status</p>
                    <p style="font-size: 22px; font-weight: 900; color: #0f172a; margin: 0;">Assessment Ready</p>
                    <p style="font-size: 12px; color: #64748b; margin: 4px 0 0 0;">Review the questions below to understand this assessment</p>
                </div>
                <div style="background: white; border-radius: 8px; border-left: 4px solid #2563eb; padding: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                    <p style="font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #475569; margin: 0 0 8px 0;">Assessment Type</p>
                    <p style="font-size: 18px; font-weight: 900; color: #2563eb; margin: 0;">Neural Network Evaluation</p>
                    <p style="font-size: 12px; color: #64748b; margin: 4px 0 0 0;">7 functional networks assessment</p>
                </div>
            </div>`;

            // Assessment Questions (read-only guidance, NOT editable)
            html += `<div style="border-radius: 12px; border: 2px solid #bfdbfe; background: linear-gradient(135deg, #eff6ff 0%, #eff6ff 100%); padding: 24px; margin-bottom: 24px;">
                <div style="background: white; border-radius: 8px; border: 1px solid #e2e8f0; padding: 20px;">
                    <h4 style="font-weight: 700; color: #0f172a; margin: 0 0 16px 0; font-size: 16px;">Assessment Questions</h4>
                    <div style="display: flex; flex-direction: column; gap: 0;">`;

            fnonSpec.questions.forEach((q, idx) => {
                html += `<div style="display: flex; gap: 16px; align-items: flex-start; padding: 12px 0; border-bottom: 1px solid #f1f5f9;">
                    <div style="width: 32px; height: 32px; border-radius: 50%; background: #3b82f6; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">${idx + 1}</div>
                    <div style="flex: 1;">
                        <p style="font-weight: 700; color: #0f172a; margin: 0 0 6px 0; font-size: 15px;">${q.title}</p>
                        <p style="font-size: 13px; color: #475569; margin: 0 0 8px 0; line-height: 1.5;">${q.hint}</p>
                        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                            <span style="font-size: 12px; font-weight: 600; color: #475569;">Scoring:</span>
                            <span style="background: #0ea5e9; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">0=Normal</span>
                            <span style="background: #f59e0b; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">1=Mild</span>
                            <span style="background: #ef4444; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">2=Deficit</span>
                        </div>
                    </div>
                </div>`;
            });

            html += `</div>
                <div style="margin-top: 16px; padding: 16px; background: #dbeafe; border: 1px solid #93c5fd; border-radius: 8px;">
                    <p style="font-size: 12px; color: #1e3a8a; margin: 0;"><strong> Note:</strong> This assessment evaluates functional brain networks. Each question is scored on a scale from 0-2, where 0 indicates normal function, 1 indicates mild concerns, and 2 indicates significant deficits. This assessment helps create a personalized treatment plan.</p>
                </div>
            </div>`;

            // Section A: Clinical Checklist (EDITABLE)
            html += `<div style="border-radius: 8px; overflow: hidden; border: 1px solid #e2e8f0; margin-bottom: 24px;">
                <div style="background: #1e293b; color: white; padding: 16px; font-weight: 700; display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 15px; font-weight: 700;">Section A: Clinical Checklist</span>
                    <span style="font-size: 11px; font-weight: 400; opacity: 0.7;">0=Normal, 1=Mild, 2=Deficit</span>
                </div>
                <div style="padding: 24px; background: white;">`;

            fnonSpec.sectionA.forEach((network, si) => {
                html += `<div style="margin-bottom: 18px; padding-bottom: 18px; border-bottom: 1px solid #e2e8f0; last:border-bottom-width: 0;">
                    <h3 style="font-weight: 700; font-size: 16px; color: #ea580c; margin: 0 0 4px 0;">${network.net}</h3>
                    <p style="font-size: 12px; color: #64748b; font-style: italic; margin: 0 0 12px 0;"><i class="fa-solid fa-triangle-exclamation"></i> ${network.signs}</p>
                    <div style="display: grid; gap: 8px;">`;

                network.tests.forEach((testName, ti) => {
                    const val = fnonState.sectionA[si][testName];
                    const fieldName = `sectionA_${si}_${ti}_${testName}`;

                    html += `<div style="display: flex; justify-content: space-between; align-items: center; font-size: 13px; background: #f8fafc; padding: 12px; border-radius: 6px; border-left: 4px solid #93c5fd;">
                        <span style="font-weight: 500; color: #475569;">${testName}</span>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <span style="font-size: 11px; font-weight: 600; color: #475569;">Score:</span>`;

                    if (editable) {
                        // Radio buttons for edit mode
                        html += ['0', '1', '2'].map(score => `
                            <label style="margin-right: 4px; cursor: pointer;">
                                <input type="radio" name="${fieldName}" value="${score}" ${Number(val) === Number(score) ? 'checked' : ''} onchange="onFnonScoreChange('${fieldName}', ${score})" style="cursor: pointer;">
                                <span style="margin-left: 2px; font-size: 11px;">${score}</span>
                            </label>
                        `).join('');
                    } else {
                        // Read-only badges
                        html += renderScoreBadges(val, fieldName, false);
                    }

                    html += `</div></div>`;
                });

                html += `</div></div>`;
            });

            html += `</div></div>`;

            // Action buttons
            html += `<div style="margin-top: 20px; display: flex; gap: 8px; justify-content: flex-end;">`;
            if (editable) {
                html += `<button onclick="saveFnonEdits()" style="background: #0ea5e9; color: white; padding: 10px 16px; border-radius: 6px; border: none; font-weight: 700; cursor: pointer;">Save</button>`;
                html += `<button onclick="closeAssessmentModal()" style="background: #f3f4f6; color: #0f172a; padding: 10px 16px; border-radius: 6px; border: 1px solid #e5e7eb; font-weight: 700; cursor: pointer;">Cancel</button>`;
            } else {
                html += `<button onclick="closeAssessmentModal()" style="background: #f3f4f6; color: #0f172a; padding: 10px 16px; border-radius: 6px; border: 1px solid #e5e7eb; font-weight: 700; cursor: pointer;">Close</button>`;
            }
            html += `</div>`;

            body.innerHTML = html;
        }

        function onFnonScoreChange(fieldName, value) {
            const parts = fieldName.split('_');
            if (parts.length >= 3) {
                const si = Number(parts[1]);
                const testName = parts.slice(3).join('_');
                fnonState.sectionA[si][testName] = Number(value);
            }
        }

        function saveFnonEdits() {
            // Re-render in read-only mode to show saved changes
            renderFnonModal(false);
            // Optionally: You can add console.log to verify saved state
            console.log('FNON Assessment saved:', fnonState);
        }

        // --- PRS ASSESSMENT FUNCTIONS ---
        let prsData = null;
        let prsState = {
            currentDisease: 'tinnitus',
            answers: {},
            notes: '',
            isEditable: false  // Track edit mode
        };

        // Load PRS data from prs.json
        async function loadPRSData() {
            if (prsData) return prsData;
            try {
                const response = await fetch('prs.json');
                prsData = await response.json();
                return prsData;
            } catch (err) {
                console.error('Failed to load prs.json:', err);
                alert('Could not load PRS questionnaire data.');
                return null;
            }
        }

        // Get list of diseases from PRS data
        function getPRSDiseases() {
            if (!prsData) return [];
            return Object.keys(prsData).map(key => ({
                id: key,
                title: prsData[key].title
            }));
        }

        // Open PRS Modal
        async function openPrsModal(editable) {
            const patientNameElement = document.getElementById('patientFullName');
            const patientName = patientNameElement ? patientNameElement.textContent : 'Sarah Mitchell';

            const prsNameEl = document.getElementById('prsPatientName');
            if (prsNameEl) prsNameEl.textContent = patientName;

            // Load PRS data if not already loaded
            if (!prsData) {
                await loadPRSData();
            }

            if (!prsData) return;

            // Store edit mode in state
            prsState.isEditable = editable;

            renderPrsModal(editable);

            const modal = document.getElementById('prsAssessmentModal');
            if (modal) modal.classList.add('open');

            document.body.style.overflow = 'hidden';
        }

        function closePrsModal(event) {
            if (event && event.target !== event.currentTarget && event.target.closest('.assessment-modal-close') === null) {
                return;
            }

            const modal = document.getElementById('prsAssessmentModal');
            if (modal) {
                modal.classList.remove('open');
            }

            document.body.style.overflow = 'auto';
        }

        // Helper function to check if question should be visible based on showIf condition
        function shouldShowQuestion(q) {
            if (!q.showIf) return true;
            const { field, value } = q.showIf;
            const answerId = `prs_${prsState.currentDisease}_${field}`;
            return prsState.answers[answerId] === value;
        }

        function renderPrsModal(editable) {
            const body = document.getElementById('prsModalBody');
            if (!body || !prsData) return;

            const config = prsData[prsState.currentDisease];
            if (!config) return;

            let html = '';

            // SCORE SUMMARY AT THE TOP - Use dummy data in view mode
            let totalScore, scorePercentage, scoreSeverity, severityColor;
           
            if (!editable) {
                // View mode: use dummy score
                totalScore = 18;
                scorePercentage = 36;
                scoreSeverity = 'Mild';
                severityColor = 'white';
            } else {
                // Edit mode: use calculated score
                totalScore = prsState.totalScore || 0;
                const maxScore = 100;
                scorePercentage = (totalScore / maxScore) * 100;
                scoreSeverity = scorePercentage > 70 ? 'Severe' : scorePercentage > 50 ? 'Moderate' : scorePercentage > 30 ? 'Mild' : 'Normal';
                severityColor = 'white';
            }

            html += `<div style="margin-bottom: 24px; padding: 20px; background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); border-radius: 8px; color: white;">
                <div style="text-align: center;">
                    <p style="font-size: 14px; margin: 0 0 8px 0; opacity: 0.9;">Patient Score</p>
                    <h2 style="font-size: 48px; font-weight: 900; margin: 0 0 12px 0;">${totalScore}/50</h2>
                    <div style="display: flex; justify-content: center; gap: 16px; flex-wrap: wrap;">
                        <div style="background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 6px;">
                            <p style="font-size: 12px; margin: 0 0 4px 0; opacity: 0.9;">Severity</p>
                            <p style="font-size: 16px; font-weight: 700; margin: 0; color: ${severityColor};">${scoreSeverity}</p>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 6px;">
                            <p style="font-size: 12px; margin: 0 0 4px 0; opacity: 0.9;">Percentage</p>
                            <p style="font-size: 16px; font-weight: 700; margin: 0;">${scorePercentage.toFixed(1)}%</p>
                        </div>
                    </div>
                </div>
            </div>`;

            // PRS SUMMARY
            html += `<div style="margin-bottom: 24px; padding: 20px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;">
                <h3 style="font-weight: 700; font-size: 16px; color: #0f172a; margin: 0 0 12px 0;">Summary of PRS Assessment</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                    <div style="padding: 12px; background: #f8fafc; border-radius: 6px; border-left: 3px solid #3b82f6;">
                        <p style="font-size: 12px; color: #64748b; margin: 0 0 6px 0;">Assessment Type</p>
                        <p style="font-size: 14px; font-weight: 700; color: #0f172a; margin: 0;">${config.title}</p>
                    </div>
                    <div style="padding: 12px; background: #f8fafc; border-radius: 6px; border-left: 3px solid #8b5cf6;">
                        <p style="font-size: 12px; color: #64748b; margin: 0 0 6px 0;">Date</p>
                        <p style="font-size: 14px; font-weight: 700; color: #0f172a; margin: 0;">${new Date().toLocaleDateString()}</p>
                    </div>
                    <div style="padding: 12px; background: #f8fafc; border-radius: 6px; border-left: 3px solid #10b981;">
                        <p style="font-size: 12px; color: #64748b; margin: 0 0 6px 0;">Status</p>
                        <p style="font-size: 14px; font-weight: 700; color: #0f172a; margin: 0;">${editable ? 'In Progress' : 'Completed'}</p>
                    </div>
                </div>
            </div>`;

            // CLINICAL NOTES
            html += `<div style="margin-bottom: 24px;">
                <label style="display: block; font-weight: 700; color: #0f172a; margin-bottom: 8px; font-size: 14px;">Clinical Notes</label>
                <textarea id="prsNotesField" placeholder="Add any clinical notes..." style="width: 100%; min-height: 100px; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-family: inherit; font-size: 13px; color: #0f172a; ${!editable ? 'background: #f8fafc; opacity: 0.8;' : 'background: white;'}" ${!editable ? 'readonly' : ''}>${prsState.notes || ''}</textarea>
            </div>`;

            // DIVIDER
            html += `<hr style="border: none; border-top: 2px solid #e2e8f0; margin: 24px 0;">`;

            // Title and description for questionnaire section
            html += `<div style="margin-bottom: 24px;">
                <h2 style="font-size: 20px; font-weight: 900; color: #0f172a; margin: 0 0 8px 0;">Assessment Questionnaire</h2>
                <p style="font-size: 14px; color: #64748b; margin: 0;">Personalized Response System Assessment</p>
            </div>`;

            // Disease selector
            const diseases = getPRSDiseases();
            html += `<div style="margin-bottom: 24px; padding: 16px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                <label style="display: block; font-weight: 700; color: #0f172a; margin-bottom: 8px;">Select Disease:</label>
                <select id="diseaseSelect" onchange="changePrsDisease(this.value)" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px;">
                    ${diseases.map(d => `<option value="${d.id}" ${d.id === prsState.currentDisease ? 'selected' : ''}>${d.title}</option>`).join('')}
                </select>
            </div>`;

            // Render questions section by section (skip first section "General Data")
            if (config.sections && Array.isArray(config.sections)) {
                config.sections.forEach((section, sectionIdx) => {
                    // Skip first section (General Data)
                    if (sectionIdx === 0) return;

                    html += `<div style="margin-bottom: 24px; padding: 20px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <h3 style="font-weight: 700; font-size: 16px; color: #0f172a; margin: 0 0 16px 0;">${section.title}</h3>
                        <div style="display: flex; flex-direction: column; gap: 16px;">`;

                    if (section.questions && Array.isArray(section.questions)) {
                        section.questions.forEach((q, qIdx) => {
                            // Check if question should be displayed based on showIf condition
                            if (!shouldShowQuestion(q)) {
                                return;
                            }

                            const answerId = `prs_${prsState.currentDisease}_${q.id}`;
                            const currentAnswer = prsState.answers[answerId];

                            html += `<div style="padding: 12px; background: #f8fafc; border-radius: 6px; border-left: 4px solid #3b82f6;">
                                <p style="font-weight: 700; color: #0f172a; margin: 0 0 8px 0; font-size: 14px;">${q.label}</p>`;

                            if ((q.type === 'radio' || q.type === 'likert') && q.options) {
                                html += `<div style="display: grid; gap: 8px;">`;
                                q.options.forEach((opt, optIdx) => {
                                    // Handle both object options {value, label} and string options (for likert)
                                    const optValue = typeof opt === 'object' ? opt.value : opt;
                                    const optLabel = typeof opt === 'object' ? opt.label : opt;
                                    const uniqueId = `${answerId}_opt_${optIdx}`;

                                    if (editable) {
                                        html += `<label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                            <input type="radio" id="${uniqueId}" name="${answerId}" data-answer-id="${answerId}" data-answer-value="${optValue}" ${currentAnswer === optValue ? 'checked' : ''} style="cursor: pointer;">
                                            <span style="font-size: 13px; color: #475569;">${optLabel}</span>
                                        </label>`;
                                    } else {
                                        const isSel = currentAnswer === optValue;
                                        html += `<div style="padding: 8px; background: ${isSel ? '#0ea5e9' : '#e2e8f0'}; color: ${isSel ? 'white' : '#475569'}; border-radius: 4px; font-size: 13px;">${isSel ? ' ' : ''}${optLabel}</div>`;
                                    }
                                });
                                html += `</div>`;
                            } else if (q.type === 'checkbox' && q.options) {
                                html += `<div style="display: grid; gap: 8px;">`;
                                q.options.forEach((opt, optIdx) => {
                                    const optValue = typeof opt === 'object' ? opt.value : opt;
                                    const optLabel = typeof opt === 'object' ? opt.label : opt;
                                    const isChecked = (currentAnswer || '').includes(optValue);
                                    const uniqueId = `${answerId}_chk_${optIdx}`;

                                    if (editable) {
                                        html += `<label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                            <input type="checkbox" id="${uniqueId}" data-answer-id="${answerId}" data-answer-value="${optValue}" ${isChecked ? 'checked' : ''} style="cursor: pointer;">
                                            <span style="font-size: 13px; color: #475569;">${optLabel}</span>
                                        </label>`;
                                    } else {
                                        html += `<div style="padding: 8px; background: ${isChecked ? '#10b981' : '#e2e8f0'}; color: ${isChecked ? 'white' : '#475569'}; border-radius: 4px; font-size: 13px;">${isChecked ? ' ' : ''}${optLabel}</div>`;
                                    }
                                });
                                html += `</div>`;
                            } else if (q.type === 'slider') {
                                const val = currentAnswer ? Number(currentAnswer) : (q.min || 0);
                                if (editable) {
                                    html += `<div style="display: flex; align-items: center; gap: 12px;">
                                        <input type="range" id="${answerId}" data-answer-id="${answerId}" min="${q.min || 0}" max="${q.max || 10}" value="${val}" style="flex: 1;">
                                        <span id="${answerId}_val" style="font-weight: 700; color: #0ea5e9; min-width: 30px; text-align: center;">${val}</span>
                                    </div>`;
                                } else {
                                    html += `<div style="padding: 8px; background: #dbeafe; border-radius: 4px; font-size: 13px; color: #1e3a8a;">Score: <strong>${val}</strong> / ${q.max || 10}</div>`;
                                }
                            } else if (q.type === 'text' || q.type === 'email' || q.type === 'date' || q.type === 'number') {
                                if (editable) {
                                    html += `<input type="${q.type}" id="${answerId}" data-answer-id="${answerId}" value="${currentAnswer || ''}" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 13px;" />`;
                                } else {
                                    html += `<div style="padding: 8px; background: #f1f5f9; border-radius: 4px; font-size: 13px; color: #475569;">${currentAnswer || 'Not provided'}</div>`;
                                }
                            }

                            html += `</div>`;
                        });
                    }

                    html += `</div></div>`;
                });
            }

            // Notes section
            html += `<div style="margin-bottom: 24px;">
                <label style="display: block; font-weight: 700; color: #0f172a; margin-bottom: 8px; font-size: 14px;">Clinical Notes</label>
                <textarea id="prsNotesField" placeholder="Add any clinical notes..." style="width: 100%; min-height: 100px; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-family: inherit; font-size: 13px; color: #0f172a; ${!editable ? 'background: #f8fafc; opacity: 0.8;' : 'background: white;'}" ${!editable ? 'readonly' : ''}>${prsState.notes || ''}</textarea>
            </div>`;

            // Action buttons
            html += `<div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px;">`;
            if (editable) {
                html += `<button onclick="savePrsEdits()" style="background: #0ea5e9; color: white; padding: 10px 16px; border-radius: 6px; border: none; font-weight: 700; cursor: pointer;">Save</button>`;
                html += `<button onclick="closePrsModal()" style="background: #f3f4f6; color: #0f172a; padding: 10px 16px; border-radius: 6px; border: 1px solid #e5e7eb; font-weight: 700; cursor: pointer;">Cancel</button>`;
            } else {
                html += `<button onclick="closePrsModal()" style="background: #f3f4f6; color: #0f172a; padding: 10px 16px; border-radius: 6px; border: 1px solid #e5e7eb; font-weight: 700; cursor: pointer;">Close</button>`;
            }
            html += `</div>`;

            body.innerHTML = html;

            // Attach event listeners after DOM is updated
            attachPrsEventListeners();
        }

        // Attach event listeners to PRS form inputs using event delegation
        function attachPrsEventListeners() {
            const body = document.getElementById('prsModalBody');
            if (!body) return;

            // Remove old listeners by cloning and replacing (cleanup)
            const oldBody = body;
            const newBody = oldBody.cloneNode(true);
            oldBody.parentNode.replaceChild(newBody, oldBody);

            // Get fresh reference
            const modalBody = document.getElementById('prsModalBody');
            if (!modalBody) return;

            // Use event delegation on the modal body
            modalBody.addEventListener('change', function (e) {
                const target = e.target;

                // Radio buttons
                if (target.type === 'radio' && target.getAttribute('data-answer-id')) {
                    const answerId = target.getAttribute('data-answer-id');
                    const value = target.getAttribute('data-answer-value');
                    onPrsAnswerChange(answerId, value);
                    // Re-render to show/hide dependent questions
                    renderPrsModal(prsState.isEditable);
                    return;
                }

                // Checkboxes
                if (target.type === 'checkbox' && target.getAttribute('data-answer-id')) {
                    const answerId = target.getAttribute('data-answer-id');
                    const value = target.getAttribute('data-answer-value');
                    const currentValues = prsState.answers[answerId] || '';
                    if (target.checked && !currentValues.includes(value)) {
                        prsState.answers[answerId] = currentValues ? currentValues + ',' + value : value;
                    } else if (!target.checked) {
                        prsState.answers[answerId] = currentValues.split(',').filter(v => v !== value).join(',');
                    }
                    return;
                }

                // Sliders
                if (target.type === 'range' && target.getAttribute('data-answer-id')) {
                    const answerId = target.getAttribute('data-answer-id');
                    onPrsAnswerChange(answerId, target.value);
                    // Re-render to show/hide dependent questions
                    renderPrsModal(prsState.isEditable);
                    return;
                }

                // Text/Email/Date/Number inputs
                if ((target.type === 'text' || target.type === 'email' || target.type === 'date' || target.type === 'number') && target.getAttribute('data-answer-id')) {
                    const answerId = target.getAttribute('data-answer-id');
                    onPrsAnswerChange(answerId, target.value);
                    return;
                }
            });
        }

        function changePrsDisease(diseaseId) {
            prsState.currentDisease = diseaseId;
            if (!prsData[diseaseId]) {
                loadPRSData().then(() => renderPrsModal(prsState.isEditable));
            } else {
                renderPrsModal(prsState.isEditable);
            }
        }

        function onPrsAnswerChange(answerId, value) {
            prsState.answers[answerId] = value;
            // Update slider display
            const valSpan = document.getElementById(`${answerId}_val`);
            if (valSpan) valSpan.textContent = value;
        }

        function savePrsEdits() {
            const notesField = document.getElementById('prsNotesField');
            if (notesField) {
                prsState.notes = notesField.value;
            }
            renderPrsModal(false);
            console.log('PRS Assessment saved:', prsState);
        }

        // --- ANAMNESIS FUNCTIONS ---
        let anamnesisState = {
            diagnosis: 'Chronic fatigue and concentration issues',
            mainSymptoms: 'Difficulty concentrating, memory problems, persistent fatigue',
            initialSymptoms: 'Started with mild fatigue 6 months ago',
            diagnosisRelated: 'Yes - diagnosed with chronic fatigue syndrome',
            symptomsStart: '6 months ago',
            symptomsDuration: '6 months ongoing',
            symptomsFrequency: 'Daily',
            symptomsIntensity: 'Moderate to severe',
            symptomsProgression: 'Getting worse',
            secondarySymptoms: {
                sleep: 'Difficulty falling asleep, frequent waking',
                concentration: 'Severe concentration issues',
                memory: 'Short-term memory problems',
                gastrointestinal: 'None reported',
                mood: 'Mild depression due to symptoms',
                fatigue: 'Severe persistent fatigue',
                weakness: 'General muscle weakness',
                pain: 'Mild headaches',
                depression: 'Mild',
                bladder: 'Normal'
            },
            operations: 'None',
            treatments: 'Previous physiotherapy (6 weeks, 2x/week) - minimal improvement',
            medications: 'Multivitamin, Omega-3 supplements',
            brainMRI: 'Yes - performed 3 months ago, results normal',
            neuromodulation: 'No previous experience with neuromodulation devices'
        };

        function openAnamnesisModal(editable) {
            console.log('Opening Anamnesis modal, editable:', editable);
            if (editable) {
                window.open('anamnesis.html', '_blank');
            } else {
                renderAnamnesisModal(false);
                document.getElementById('anamnesisModal').classList.add('open');
            }
        }

        function closeAnamnesisModal(event) {
            if (event && event.target === event.currentTarget) {
                document.getElementById('anamnesisModal').classList.remove('open');
            }
        }

        function renderAnamnesisModal(editable) {
            const modalBody = document.getElementById('anamnesisModalBody');
            modalBody.innerHTML = `
                <div class="assessment-section-group">
                    <div class="assessment-section-title">
                        <i class="fas fa-stethoscope"></i>
                        Patient Anamnesis Summary
                    </div>
                    
                    <div class="assessment-info-table" style="margin-bottom: 24px;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr>
                                    <th style="background: #f8fafc; padding: 12px; border: 1px solid #e2e8f0; font-size: 11px; font-weight: 700; text-transform: uppercase; color: #475569;">Category</th>
                                    <th style="background: #f8fafc; padding: 12px; border: 1px solid #e2e8f0; font-size: 11px; font-weight: 700; text-transform: uppercase; color: #475569;">Information</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="padding: 14px; border: 1px solid #e2e8f0; font-weight: 600;">Diagnosis</td>
                                    <td style="padding: 14px; border: 1px solid #e2e8f0;">${anamnesisState.diagnosis}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 14px; border: 1px solid #e2e8f0; font-weight: 600;">Main Symptoms</td>
                                    <td style="padding: 14px; border: 1px solid #e2e8f0;">${anamnesisState.mainSymptoms}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 14px; border: 1px solid #e2e8f0; font-weight: 600;">Symptoms Duration</td>
                                    <td style="padding: 14px; border: 1px solid #e2e8f0;">${anamnesisState.symptomsDuration}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 14px; border: 1px solid #e2e8f0; font-weight: 600;">Symptoms Progression</td>
                                    <td style="padding: 14px; border: 1px solid #e2e8f0;">${anamnesisState.symptomsProgression}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 14px; border: 1px solid #e2e8f0; font-weight: 600;">Sleep Issues</td>
                                    <td style="padding: 14px; border: 1px solid #e2e8f0;">${anamnesisState.secondarySymptoms.sleep}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 14px; border: 1px solid #e2e8f0; font-weight: 600;">Concentration</td>
                                    <td style="padding: 14px; border: 1px solid #e2e8f0;">${anamnesisState.secondarySymptoms.concentration}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 14px; border: 1px solid #e2e8f0; font-weight: 600;">Previous Treatments</td>
                                    <td style="padding: 14px; border: 1px solid #e2e8f0;">${anamnesisState.treatments}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 14px; border: 1px solid #e2e8f0; font-weight: 600;">Current Medications</td>
                                    <td style="padding: 14px; border: 1px solid #e2e8f0;">${anamnesisState.medications}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 14px; border: 1px solid #e2e8f0; font-weight: 600;">Brain MRI</td>
                                    <td style="padding: 14px; border: 1px solid #e2e8f0;">${anamnesisState.brainMRI}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 14px; border: 1px solid #e2e8f0; font-weight: 600;">Previous Neuromodulation</td>
                                    <td style="padding: 14px; border: 1px solid #e2e8f0;">${anamnesisState.neuromodulation}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="assessment-conclusion-box">
                        <h4>Clinical Assessment Summary</h4>
                        <p>Patient presents with chronic fatigue syndrome with significant impact on daily functioning. Comprehensive symptom assessment completed with detailed medical history documented.</p>
                    </div>
                </div>
            `;
        }

        // --- DOCTOR'S NOTES FUNCTIONS ---
        let doctorNotesState = {
            clinicalObservations: 'Patient demonstrates significant cognitive decline in executive function and working memory. MMSE score: 18/30. Notable difficulties with delayed recall and verbal fluency. Speech output slow but coherent. Mood appears slightly depressed. Shows good compliance with current medication regimen.',
            recommendations: '1. Continue current medication (Donepezil 10mg daily + Memantine 20mg daily)\n2. Recommend cognitive rehabilitation therapy 2x weekly\n3. Consider referral to neuropsychology for detailed assessment\n4. Family psychoeducation sessions recommended\n5. Monitor for behavioral changes or mood disturbances\n6. Repeat MMSE assessment in 3 months',
            prescribedMedications: 'Donepezil 10mg - Once daily at night (Cholinesterase inhibitor)\nMemantine 20mg - Once daily in morning (NMDA antagonist)\nSertraline 50mg - Once daily in morning (SSRI for mood)\nMelatonin 5mg - At bedtime as needed (Sleep support)'
        };

        function openDoctorNotesModal(editable) {
            renderDoctorNotesModal(editable);
            const modal = document.getElementById('doctorNotesModal');
            if (modal) modal.classList.add('open');
            document.body.style.overflow = 'hidden';
        }

        function closeDoctorNotesModal(event) {
            if (event && event.target !== event.currentTarget && event.target.closest('.assessment-modal-close') === null) {
                return;
            }
            const modal = document.getElementById('doctorNotesModal');
            if (modal) modal.classList.remove('open');
            document.body.style.overflow = 'auto';
        }

        function closeEegPdfViewer(event) {
            if (event && event.target !== event.currentTarget && event.target.closest('.assessment-modal-close') === null) {
                return;
            }
            const modal = document.getElementById('eegPdfViewerModal');
            if (modal) modal.classList.remove('open');
            document.body.style.overflow = 'auto';
        }

        // PAYMENT OVERRIDE MODAL FUNCTIONS
        let pendingOverrideBlockId = null;
        let pendingOverrideBlockType = null;

        function openPaymentOverrideModal(blockId, blockType) {
            pendingOverrideBlockId = blockId;
            pendingOverrideBlockType = blockType;
            
            // Reset checkbox and button state
            const checkbox = document.getElementById('overrideConsentCheckbox');
            const confirmBtn = document.getElementById('confirmOverrideBtn');
            if (checkbox) checkbox.checked = false;
            if (confirmBtn) {
                confirmBtn.disabled = true;
                confirmBtn.classList.remove('enabled');
            }
            
            // Reset to form view (hide success view)
            const formView = document.getElementById('overrideFormView');
            const successView = document.getElementById('overrideSuccessView');
            const header = document.getElementById('overrideModalHeader');
            if (formView) formView.classList.remove('hide');
            if (successView) successView.classList.remove('show');
            if (header) header.style.display = 'flex';
            
            const modal = document.getElementById('paymentOverrideModal');
            if (modal) modal.classList.add('open');
            document.body.style.overflow = 'hidden';
        }

        function closePaymentOverrideModal(event) {
            if (event && event.target !== event.currentTarget) {
                return;
            }
            const modal = document.getElementById('paymentOverrideModal');
            if (modal) modal.classList.remove('open');
            document.body.style.overflow = 'auto';
            
            // Reset views
            const formView = document.getElementById('overrideFormView');
            const successView = document.getElementById('overrideSuccessView');
            const header = document.getElementById('overrideModalHeader');
            if (formView) formView.classList.remove('hide');
            if (successView) successView.classList.remove('show');
            if (header) header.style.display = 'flex';
            
            // Re-render the patient journey if override was successful
            if (pendingOverrideBlockId === null && pendingOverrideBlockType === null) {
                renderPatientJourney();
            }
            
            pendingOverrideBlockId = null;
            pendingOverrideBlockType = null;
        }

        function toggleOverrideButton() {
            const checkbox = document.getElementById('overrideConsentCheckbox');
            const confirmBtn = document.getElementById('confirmOverrideBtn');
            
            if (checkbox && confirmBtn) {
                if (checkbox.checked) {
                    confirmBtn.disabled = false;
                    confirmBtn.classList.add('enabled');
                } else {
                    confirmBtn.disabled = true;
                    confirmBtn.classList.remove('enabled');
                }
            }
        }

        function confirmPaymentOverride() {
            const checkbox = document.getElementById('overrideConsentCheckbox');
            if (!checkbox || !checkbox.checked) return;
            
            // Get current patient data
            const patientId = selectedPatientData?.id;
            if (!patientId || !patientStateData[patientId]) {
                alert('Unable to process override. Patient data not found.');
                return;
            }

            // Find and update the block status
            const patientData = patientStateData[patientId];
            const blockIndex = patientData.blocks.findIndex(b => b.id === pendingOverrideBlockId);
            
            if (blockIndex !== -1) {
                // Update block to pending status (unlocked)
                patientData.blocks[blockIndex].status = 'pending';
                patientData.blocks[blockIndex].lockReason = null;
                patientData.blocks[blockIndex].allowOverride = false;
                patientData.blocks[blockIndex].overriddenBy = currentRole === 'doctor' ? 'Dr. ' + (selectedPatientData?.doctorName || 'Physician') : 'Clinical Assistant';
                patientData.blocks[blockIndex].overriddenAt = new Date().toISOString();
                
                // Log the override action
                console.log('Payment override confirmed:', {
                    patientId: patientId,
                    blockId: pendingOverrideBlockId,
                    blockType: pendingOverrideBlockType,
                    overriddenBy: patientData.blocks[blockIndex].overriddenBy,
                    timestamp: patientData.blocks[blockIndex].overriddenAt
                });
            }

            // Show success view in modal
            showOverrideSuccessInModal();
        }

        function showOverrideSuccessInModal() {
            // Hide form view, show success view
            const formView = document.getElementById('overrideFormView');
            const successView = document.getElementById('overrideSuccessView');
            const header = document.getElementById('overrideModalHeader');
            
            if (formView) formView.classList.add('hide');
            if (successView) successView.classList.add('show');
            
            // Update header to success state
            if (header) {
                header.innerHTML = `
                    <div class="payment-override-header-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                        <i class="fa-solid fa-check"></i>
                    </div>
                    <div class="payment-override-header-text">
                        <h3 style="color: white;">Override Successful</h3>
                        <p style="color: rgba(255,255,255,0.9);">Brain Mapping Assessment</p>
                    </div>
                `;
                header.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
            }
            
            // Clear the pending block info so closeModal knows override was successful
            pendingOverrideBlockId = null;
            pendingOverrideBlockType = null;
        }

        function startBrainMappingFromOverride() {
            // Close modal first
            const modal = document.getElementById('paymentOverrideModal');
            if (modal) modal.classList.remove('open');
            document.body.style.overflow = 'auto';
            
            // Reset modal views for next time
            const formView = document.getElementById('overrideFormView');
            const successView = document.getElementById('overrideSuccessView');
            const header = document.getElementById('overrideModalHeader');
            if (formView) formView.classList.remove('hide');
            if (successView) successView.classList.remove('show');
            if (header) {
                header.style.background = 'linear-gradient(135deg, #dc2626 0%, #b91c1c 100%)';
                header.innerHTML = `
                    <div class="payment-override-header-icon">
                        <i class="fa-solid fa-credit-card"></i>
                    </div>
                    <div class="payment-override-header-text">
                        <h3>Payment Override Request</h3>
                        <p>Brain Mapping Assessment</p>
                    </div>
                `;
            }
            
            // Store session data for EEG page
            const patientNameElement = document.getElementById('patientFullName');
            const patientName = patientNameElement ? patientNameElement.textContent : 'Patient';
            
            const sessionData = {
                currentRole: currentRole,
                patientName: patientName,
                blockType: 'brain-mapping',
                viewMode: 'edit',
                returnUrl: window.location.href,
                paymentOverridden: true
            };
            localStorage.setItem('eegSession', JSON.stringify(sessionData));
            
            // Re-render the today view to update the UI
            renderTodayView();
            
            // Navigate to EEG page in new tab
            window.open('eeg.html', '_blank');
        }

        function renderDoctorNotesModal(editable) {
            const body = document.getElementById('doctorNotesModalBody');
            if (!body) return;

            const patientNameElement = document.getElementById('patientFullName');
            const patientName = patientNameElement ? patientNameElement.textContent : 'Sarah Mitchell';

            let html = '';

            // Header with patient info
            html += `<div style="margin-bottom: 24px; padding: 16px; background: #f0f4ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="width: 48px; height: 48px; background: #6366f1; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 18px;">
                        ${patientName.split(' ').map(n => n[0]).join('')}
                    </div>
                    <div>
                        <div style="font-weight: 700; font-size: 16px; color: #0f172a;">${patientName}</div>
                        <div style="font-size: 13px; color: #64748b;">ID: PAT-001  34 years old  Depression</div>
                    </div>
                </div>
            </div>`;

            // Clinical Observations Section
            html += `<div style="margin-bottom: 24px;">
                <h3 style="font-weight: 700; font-size: 16px; color: #0f172a; margin: 0 0 12px 0;">Clinical Observations</h3>
                <textarea id="clinicalObservationsField" placeholder="Clinical observations and findings..." style="width: 100%; min-height: 120px; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-family: inherit; font-size: 13px; color: #0f172a; background: ${!editable ? '#f8fafc' : 'white'}; ${!editable ? 'opacity: 0.8;' : ''}" ${!editable ? 'readonly' : ''}>${doctorNotesState.clinicalObservations || ''}</textarea>
            </div>`;

            // Recommendations Section
            html += `<div style="margin-bottom: 24px;">
                <h3 style="font-weight: 700; font-size: 16px; color: #0f172a; margin: 0 0 12px 0;">Recommendations</h3>
                <textarea id="recommendationsField" placeholder="Treatment recommendations..." style="width: 100%; min-height: 120px; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-family: inherit; font-size: 13px; color: #0f172a; background: ${!editable ? '#f8fafc' : 'white'}; ${!editable ? 'opacity: 0.8;' : ''}" ${!editable ? 'readonly' : ''}>${doctorNotesState.recommendations || ''}</textarea>
            </div>`;

            // Prescribed Medications Section
            html += `<div style="margin-bottom: 24px;">
                <h3 style="font-weight: 700; font-size: 16px; color: #0f172a; margin: 0 0 12px 0;">Prescribed Medications</h3>
                <textarea id="prescribedMedicationsField" placeholder="Current medications..." style="width: 100%; min-height: 120px; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-family: inherit; font-size: 13px; color: #0f172a; background: ${!editable ? '#f8fafc' : 'white'}; ${!editable ? 'opacity: 0.8;' : ''}" ${!editable ? 'readonly' : ''}>${doctorNotesState.prescribedMedications || ''}</textarea>
            </div>`;

            // Action buttons
            html += `<div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 24px; padding-top: 16px; border-top: 1px solid #e2e8f0;">`;

            if (editable) {
                html += `<button onclick="saveDoctorNotes()" style="background: #0ea5e9; color: white; padding: 10px 16px; border-radius: 6px; border: none; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                    <i class="fa-solid fa-save"></i> Save Notes
                </button>
                <button onclick="continueTreatmentPlan()" style="background: #10b981; color: white; padding: 10px 16px; border-radius: 6px; border: none; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                    <i class="fa-solid fa-arrow-right"></i> Continue to Treatment Plan
                </button>`;
            }

            html += `<button onclick="closeDoctorNotesModal()" style="background: #f3f4f6; color: #0f172a; padding: 10px 16px; border-radius: 6px; border: 1px solid #e5e7eb; font-weight: 700; cursor: pointer;">Close</button>`;

            html += `</div>`;

            body.innerHTML = html;
        }

        function saveDoctorNotes() {
            const clinicalField = document.getElementById('clinicalObservationsField');
            const recommendationsField = document.getElementById('recommendationsField');
            const medicationsField = document.getElementById('prescribedMedicationsField');

            if (clinicalField) doctorNotesState.clinicalObservations = clinicalField.value;
            if (recommendationsField) doctorNotesState.recommendations = recommendationsField.value;
            if (medicationsField) doctorNotesState.prescribedMedications = medicationsField.value;

            console.log('Doctor Notes saved:', doctorNotesState);
            alert('Doctor Notes saved successfully!');
            renderDoctorNotesModal(false);
        }

        function continueTreatmentPlan() {
            // Save current notes first
            saveDoctorNotes();
            // Close doctor notes modal
            closeDoctorNotesModal();
            // Open treatment plan based on role
            setTimeout(() => {
                if (window.currentRole === 'doctor') {
                    window.open('./treatment-plan-doctor.html', '_blank');
                } else {
                    window.open('./treatment-plan.html', '_blank');
                }
            }, 300);
        }

        function showSessionPaymentPage() {
            // Show payment page
            document.getElementById('paymentPage').style.display = 'block';

            // Update payment amount for session
            const paymentAmountElements = document.querySelectorAll('.payment-amount');
            paymentAmountElements.forEach(el => {
                el.textContent = '100';
            });

            // Update payment description
            const paymentDescElements = document.querySelectorAll('.payment-description');
            paymentDescElements.forEach(el => {
                el.textContent = 'Treatment Session Activation';
            });

            // Update payment details
            const paymentDetailsElements = document.querySelectorAll('.payment-details');
            paymentDetailsElements.forEach(el => {
                el.innerHTML = '<i class="fa-solid fa-info-circle"></i> This session fee covers PRS assessment and EEG recording';
            });
        }

        function processPayment() {
            // Simulate payment processing
            console.log('Processing session payment: 100');

            if (window.isSessionActivation) {
                // Complete session activation
                completeSessionActivation();
            } else {
                // Original flow
                proceedToJourney('paid');
            }
        }

        // Payment Method Selection
        function selectPaymentMethod(method) {
            // Update tab styles
            const methods = ['card', 'wallet', 'qr', 'bank'];
            methods.forEach(m => {
                const el = document.getElementById(`paymentMethod${m.charAt(0).toUpperCase() + m.slice(1)}`);
                if (el) {
                    if (m === method) {
                        el.style.border = '3px solid #10b981';
                        el.style.background = 'rgba(16, 185, 129, 0.05)';
                    } else {
                        el.style.border = '2px solid #e2e8f0';
                        el.style.background = 'white';
                    }
                }
            });

            // Show/hide payment sections
            document.getElementById('cardPaymentSection').style.display = method === 'card' ? 'block' : 'none';
            document.getElementById('walletPaymentSection').style.display = method === 'wallet' ? 'block' : 'none';
            document.getElementById('qrPaymentSection').style.display = method === 'qr' ? 'block' : 'none';
            document.getElementById('bankPaymentSection').style.display = method === 'bank' ? 'block' : 'none';
        }

        // Card Type Detection
        function detectCardType(cardNumber) {
            // Remove spaces
            const cleaned = cardNumber.replace(/\s/g, '');
            const cardTypeIcon = document.getElementById('cardTypeIcon');

            if (!cardTypeIcon) return;

            // Visa
            if (/^4/.test(cleaned)) {
                cardTypeIcon.className = 'fa-brands fa-cc-visa';
                cardTypeIcon.style.color = '#1a1f71';
            }
            // Mastercard
            else if (/^5[1-5]/.test(cleaned) || /^2[2-7]/.test(cleaned)) {
                cardTypeIcon.className = 'fa-brands fa-cc-mastercard';
                cardTypeIcon.style.color = '#eb001b';
            }
            // Amex
            else if (/^3[47]/.test(cleaned)) {
                cardTypeIcon.className = 'fa-brands fa-cc-amex';
                cardTypeIcon.style.color = '#006fcf';
            }
            // Discover
            else if (/^6(?:011|5)/.test(cleaned)) {
                cardTypeIcon.className = 'fa-brands fa-cc-discover';
                cardTypeIcon.style.color = '#ff6000';
            }
            // Default
            else {
                cardTypeIcon.className = 'fa-solid fa-credit-card';
                cardTypeIcon.style.color = '#64748b';
            }
        }

        function completeSessionActivation() {
            // Hide payment page
            document.getElementById('paymentPage').style.display = 'none';

            // Show journey again
            document.getElementById('journeyContent').style.display = 'block';
            document.getElementById('selectedPatientHeader').style.display = 'block';

            // Reset flags
            window.isSessionActivation = false;
            window.consentFormOrigin = null;
            hasSignature = false;

            // Show success message
            alert('Session Activated Successfully!\n\nSession 4\nPayment: 100 (Confirmed)\nConsent: Signed\n\nThe session is now active and ready for treatment.');

            // Re-render today view to show updated session
            renderTodayView();
        }

        function selectPayLater() {
            if (window.isSessionActivation) {
                alert('Session activation requires immediate payment of 100 to unlock the device and begin treatment.');
                return;
            }

            // Original pay later flow for new patient
            proceedToJourney('pending');
        }

        function backFromPayment() {
            // Hide payment page
            document.getElementById('paymentPage').style.display = 'none';

            // Show consent form again
            document.getElementById('consentFormPage').style.display = 'block';
        }


        function startNewPatientAssessment(assessmentId, assessmentName) {
            // Handle Anamnesis assessment
            if (assessmentId === 'anamnesis-paid') {
                window.open('anamnesis.html', '_blank');
                return;
            }

            // Handle FNON assessment
            if (assessmentId === 'fnon-paid') {
                const patientNameElement = document.getElementById('patientFullName');
                const patientName = patientNameElement ? patientNameElement.textContent : 'Sarah Mitchell';

                const apEl = document.getElementById('assessmentPatientName');
                if (apEl) apEl.textContent = patientName;
                const modalNameEl = document.getElementById('modalPatientName');
                if (modalNameEl) modalNameEl.textContent = patientName;

                // Render FNON sections in editable mode for new patient
                renderFnonModal(true);

                const modal = document.getElementById('fnonAssessmentModal');
                if (modal) modal.classList.add('open');

                document.body.style.overflow = 'hidden';
                return;
            }

            // Handle PRS assessment
            if (assessmentId === 'prs-paid') {
                openPrsModal(true);
                return;
            }

            // Default fallback for other assessments
            alert(`Starting ${assessmentName}\\n\\nAssessment ID: ${assessmentId}\\nRole: ${currentRole}\\n\\nThis would:\\n- Open ${assessmentName} interface\\n- Load assessment forms\\n- Begin data collection\\n- Save progress automatically\\n\\nNote: This is a new patient's initial assessment.`);

            console.log(`Starting new patient assessment: ${assessmentId} (${assessmentName}) by ${currentRole}`);
        }

        function proceedToPayment() {
            // Hide journey
            document.getElementById('journeyContent').style.display = 'none';
            document.getElementById('selectedPatientHeader').style.display = 'none';

            // Show payment page
            showPaymentPage();

            alert('Returning to Payment Page\\n\\nComplete the 300 payment to unlock all assessments.');
        }

        // ONBOARDING FLOW MANAGEMENT
        let currentOnboardingPatient = null;
        let currentUserRole = 'receptionist'; // Default role for onboarding
        let signatureCanvas = null;
        let signatureContext = null;
        let isDrawing = false;
        let hasSignature = false;
        let patientPaymentStatus = 'pending'; // Track if payment is 'paid' or 'pending'

        // Initialize signature canvas
        function initSignatureCanvas() {
            signatureCanvas = document.getElementById('signatureCanvas');
            if (!signatureCanvas) return;

            signatureContext = signatureCanvas.getContext('2d');
            signatureContext.strokeStyle = '#0f172a';
            signatureContext.lineWidth = 2;
            signatureContext.lineCap = 'round';
            signatureContext.lineJoin = 'round';

            // Mouse events
            signatureCanvas.addEventListener('mousedown', startDrawing);
            signatureCanvas.addEventListener('mousemove', draw);
            signatureCanvas.addEventListener('mouseup', stopDrawing);
            signatureCanvas.addEventListener('mouseout', stopDrawing);

            // Touch events
            signatureCanvas.addEventListener('touchstart', handleTouchStart);
            signatureCanvas.addEventListener('touchmove', handleTouchMove);
            signatureCanvas.addEventListener('touchend', stopDrawing);
        }

        function startDrawing(e) {
            isDrawing = true;
            const rect = signatureCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            signatureContext.beginPath();
            signatureContext.moveTo(x, y);
        }

        function draw(e) {
            if (!isDrawing) return;
            const rect = signatureCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            signatureContext.lineTo(x, y);
            signatureContext.stroke();
            hasSignature = true;
            validateConsent();
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousedown', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            signatureCanvas.dispatchEvent(mouseEvent);
        }

        function handleTouchMove(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            signatureCanvas.dispatchEvent(mouseEvent);
        }

        function clearSignature() {
            if (!signatureContext || !signatureCanvas) return;
            signatureContext.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
            hasSignature = false;
            validateConsent();
        }

        function validateConsent() {
            const checkbox = document.getElementById('consentCheckbox');
            const submitBtn = document.getElementById('submitConsentBtn');

            if (checkbox && submitBtn) {
                const isValid = checkbox.checked && hasSignature;
                submitBtn.disabled = !isValid;
                submitBtn.style.opacity = isValid ? '1' : '0.5';
                submitBtn.style.cursor = isValid ? 'pointer' : 'not-allowed';
            }
        }

        // Add event listener for checkbox
        function setupConsentListeners() {
            const checkbox = document.getElementById('consentCheckbox');
            if (checkbox) {
                checkbox.addEventListener('change', validateConsent);
            }
        }

        function showQuestionnaireScreen(patient) {
            currentOnboardingPatient = patient;

            // Hide all screens
            document.getElementById('patientEntryScreen').style.display = 'none';
            document.getElementById('consentFormPage').style.display = 'none';
            document.getElementById('paymentPage').style.display = 'none';
            document.getElementById('journeyContent').style.display = 'none';
            document.getElementById('selectedPatientHeader').style.display = 'none';

            // Show questionnaire screen
            document.getElementById('questionnaireScreen').style.display = 'block';
        }

        function submitQuestionnaire() {
            // Collect questionnaire data
            const questionnaireData = {
                neurologicalConditions: document.getElementById('neurologicalConditions')?.value || '',
                otherMedicalConditions: document.getElementById('otherMedicalConditions')?.value || '',
                currentMedications: document.getElementById('currentMedications')?.value || '',
                allergies: document.getElementById('allergies')?.value || '',
                previousTDCS: document.querySelector('input[name="previousTDCS"]:checked')?.value || 'no',
                previousTDCSDetails: document.getElementById('previousTDCSDetails')?.value || '',
                otherTreatments: document.getElementById('otherTreatments')?.value || '',
                smoking: document.querySelector('input[name="smoking"]:checked')?.value || 'no',
                alcohol: document.querySelector('input[name="alcohol"]:checked')?.value || 'never',
                exercise: document.querySelector('input[name="exercise"]:checked')?.value || 'weekly',
                treatmentGoals: document.getElementById('treatmentGoals')?.value || '',
                referralSource: document.getElementById('referralSource')?.value || '',
                additionalNotes: document.getElementById('additionalNotes')?.value || '',
                completedAt: new Date().toISOString()
            };

            // Store in current onboarding patient
            if (currentOnboardingPatient) {
                currentOnboardingPatient.questionnaire = questionnaireData;
            }

            // Proceed to consent form
            showConsentForm(currentOnboardingPatient);
        }

        function skipQuestionnaire() {
            // Mark questionnaire as skipped
            if (currentOnboardingPatient) {
                currentOnboardingPatient.questionnaire = {
                    skipped: true,
                    skippedAt: new Date().toISOString()
                };
            }

            // Proceed directly to consent form
            showConsentForm(currentOnboardingPatient);
        }

        function showConsentForm(patient) {
            currentOnboardingPatient = patient;

            // Hide all screens
            document.getElementById('patientEntryScreen').style.display = 'none';
            document.getElementById('questionnaireScreen').style.display = 'none';
            document.getElementById('paymentPage').style.display = 'none';
            document.getElementById('journeyContent').style.display = 'none';
            document.getElementById('selectedPatientHeader').style.display = 'none';

            // Show consent form
            document.getElementById('consentFormPage').style.display = 'block';

            // Populate patient name
            const fullName = `${patient.firstName} ${patient.lastName}`;
            document.getElementById('consentFullName').value = fullName;

            // Set context flag
            window.isSessionActivation = false;
            window.consentFormOrigin = 'newPatient';

            // Initialize signature canvas
            setTimeout(() => {
                initSignatureCanvas();
                setupConsentListeners();
            }, 100);
        }

        function showPaymentPage() {
            // Hide consent form
            document.getElementById('consentFormPage').style.display = 'none';

            // Show payment page
            document.getElementById('paymentPage').style.display = 'block';

            // Pre-fill cardholder name
            if (currentOnboardingPatient) {
                document.getElementById('cardholderName').value =
                    `${currentOnboardingPatient.firstName} ${currentOnboardingPatient.lastName}`;
            }
        }

        function proceedToJourney(paymentStatus) {
            // Determine which patient flow to use based on payment status
            // P-NEW-1: Payment completed - all assessments pending and ready to start
            // P-NEW-2: Payment pending - only Anamnesis/FNON available, PRS/Brain Mapping locked
            const patientId = paymentStatus === 'paid' ? 'P-NEW-1' : 'P-NEW-2';
            
            // Hide all onboarding screens
            document.getElementById('patientEntryScreen').style.display = 'none';
            document.getElementById('questionnaireScreen').style.display = 'none';
            document.getElementById('consentFormPage').style.display = 'none';
            document.getElementById('paymentPage').style.display = 'none';
            
            // Redirect to patient journey with proper URL parameters
            // This ensures proper state management and back button behavior
            window.location.href = `patient-journey.html?patient=${patientId}&role=doctor&tab=today`;
        }

        function backToPatientSelection() {
            // Check context to determine where to go back
            if (window.consentFormOrigin === 'session') {
                // Coming from session activation - go back to journey
                document.getElementById('consentFormPage').style.display = 'none';
                document.getElementById('paymentPage').style.display = 'none';
                document.getElementById('journeyContent').style.display = 'block';
                document.getElementById('selectedPatientHeader').style.display = 'block';

                // Reset session activation flags
                window.isSessionActivation = false;
                window.consentFormOrigin = null;
                hasSignature = false;
            } else {
                // Coming from new patient flow - go back to patient entry
                document.getElementById('consentFormPage').style.display = 'none';
                document.getElementById('paymentPage').style.display = 'none';
                document.getElementById('patientEntryScreen').style.display = 'block';

                // Reset onboarding state
                currentOnboardingPatient = null;
                window.consentFormOrigin = null;
                hasSignature = false;
            }
        }

        // PATIENT MANAGEMENT FUNCTIONS
        const samplePatients = [
            {
                id: 'P-NEW-1',
                firstName: 'Alex',
                lastName: 'Martinez',
                age: 34,
                gender: 'Male',
                condition: "Parkinson's Disease",
                lastVisit: 'Today',
                status: 'new',
                nextAppointment: '2026-02-10',
                stateLabel: ' New - Paid'
            },
            {
                id: 'P-NEW-2',
                firstName: 'Rachel',
                lastName: 'Kim',
                age: 41,
                gender: 'Female',
                condition: 'Anxiety',
                lastVisit: 'Today',
                status: 'new',
                nextAppointment: '2026-02-10',
                stateLabel: ' New - Payment Pending'
            },
            {
                id: 'P-NEW-3',
                firstName: 'James',
                lastName: 'Wilson',
                age: 38,
                gender: 'Male',
                condition: 'Migraine',
                lastVisit: 'Today',
                status: 'new',
                nextAppointment: '2026-02-10',
                stateLabel: ' Device Activation Needed'
            },
            {
                id: 'P-NEW-4',
                firstName: 'Thomas',
                lastName: 'Brown',
                age: 52,
                gender: 'Male',
                condition: 'Chronic Pain',
                lastVisit: 'Today',
                status: 'new',
                nextAppointment: '2026-02-10',
                stateLabel: ' Payment Pending - Override Available'
            },
            {
                id: 'P001',
                firstName: 'Sarah',
                lastName: 'Johnson',
                age: 42,
                gender: 'Female',
                condition: "Parkinson's Disease",
                lastVisit: '2026-01-30',
                status: 'active',
                nextAppointment: '2026-02-01',
                stateLabel: ' Assessments 2/4'
            },
            {
                id: 'P002',
                firstName: 'Michael',
                lastName: 'Chen',
                age: 55,
                gender: 'Male',
                condition: 'Depression',
                lastVisit: '2026-01-28',
                status: 'active',
                nextAppointment: '2026-02-03',
                stateLabel: ' Ready for Review'
            },
            {
                id: 'P003',
                firstName: 'Emma',
                lastName: 'Rodriguez',
                age: 38,
                gender: 'Female',
                condition: 'Stroke Recovery',
                lastVisit: '2026-01-25',
                status: 'pending-session',
                nextAppointment: '2026-02-08',
                stateLabel: ' Plan Ready - Session Locked'
            },
            {
                id: 'P004',
                firstName: 'David',
                lastName: 'Park',
                age: 47,
                gender: 'Male',
                condition: 'Depression',
                lastVisit: 'Today',
                status: 'in-session',
                nextAppointment: 'Today',
                stateLabel: ' Session 1 LIVE'
            },
            {
                id: 'P005',
                firstName: 'Lisa',
                lastName: 'Thompson',
                age: 35,
                gender: 'Female',
                condition: 'Anxiety',
                lastVisit: '2026-01-27',
                status: 'mid-treatment',
                nextAppointment: '2026-02-04',
                stateLabel: ' 3 Sessions Done'
            }
        ];

        let selectedPatientData = null;
        let filteredPatients = [...samplePatients];

        // Render patient dropdown options
        function renderPatientDropdown() {
            const container = document.getElementById('patientDropdownList');
            const noResults = document.getElementById('noResultsMessage');

            if (filteredPatients.length === 0) {
                container.style.display = 'none';
                noResults.style.display = 'block';
                return;
            }

            container.style.display = 'block';
            noResults.style.display = 'none';

            container.innerHTML = filteredPatients.map(patient => `
                <div onclick="selectPatientFromDropdown(${JSON.stringify(patient).replace(/"/g, '&quot;')})" 
                     style="padding: 16px; border-bottom: 1px solid #e2e8f0; cursor: pointer; transition: all 0.2s; background: white;"
                     onmouseover="this.style.background='#f8fafc'"
                     onmouseout="this.style.background='white'">
                    <div style="display: flex; align-items: center; gap: 14px;">
                        <div style="width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(135deg, var(--orange-primary), #dc6027); display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; font-weight: 700; flex-shrink: 0;">
                            ${patient.firstName[0]}${patient.lastName[0]}
                        </div>
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <span style="font-size: 15px; font-weight: 700; color: #0f172a;">
                                    ${patient.firstName} ${patient.lastName}
                                </span>
                                <span style="font-size: 12px; color: #94a3b8; font-weight: 500;">
                                    ${patient.age} yrs
                                </span>
                                ${patient.stateLabel
                    ? `<span style="background: linear-gradient(135deg, #f0f9ff, #dbeafe); color: #1e40af; padding: 3px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; border: 1px solid #93c5fd;">${patient.stateLabel}</span>`
                    : patient.status === 'active'
                        ? '<span style="background: #dcfce7; color: #166534; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">ACTIVE</span>'
                        : '<span style="background: #e0e7ff; color: #3730a3; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">COMPLETED</span>'
                }
                            </div>
                            <div style="display: flex; gap: 16px; font-size: 12px; color: #64748b;">
                                <span><i class="fa-solid fa-id-card" style="width: 14px;"></i> ${patient.id}</span>
                                <span><i class="fa-solid fa-stethoscope" style="width: 14px;"></i> ${patient.condition}</span>
                            </div>
                        </div>
                        <div>
                            <i class="fa-solid fa-chevron-right" style="color: #cbd5e1; font-size: 12px;"></i>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Filter patients based on search
        function filterPatients() {
            const searchTerm = document.getElementById('patientSearchInput').value.toLowerCase();

            filteredPatients = samplePatients.filter(patient => {
                const fullName = `${patient.firstName} ${patient.lastName}`.toLowerCase();
                const id = patient.id.toLowerCase();
                return fullName.includes(searchTerm) || id.includes(searchTerm);
            });

            renderPatientDropdown();
        }

        // Select patient from dropdown
        function selectPatientFromDropdown(patient) {
            selectedPatientData = patient;

            // Update selected patient display
            document.getElementById('selectedPatientInitials').textContent = `${patient.firstName[0]}${patient.lastName[0]}`;
            document.getElementById('selectedPatientName').textContent = `${patient.firstName} ${patient.lastName}`;
            document.getElementById('selectedPatientAge').textContent = `${patient.age} yrs`;
            document.getElementById('selectedPatientCondition').textContent = patient.condition;

            // Show selected display, hide dropdown
            document.getElementById('selectedPatientDisplay').style.display = 'block';
            document.getElementById('patientDropdownList').style.display = 'none';
            document.getElementById('patientSearchInput').value = '';

            // Proceed to journey
            setTimeout(() => {
                selectPatient(patient);
            }, 300);
        }

        // Clear patient selection
        function clearPatientSelection() {
            selectedPatientData = null;
            document.getElementById('selectedPatientDisplay').style.display = 'none';
            document.getElementById('patientSearchInput').value = '';
            filteredPatients = [...samplePatients];
            renderPatientDropdown();
        }

        function selectPatient(patient) {
            // All roles go directly to journey (consent/payment happens at session activation)
            proceedDirectlyToJourney(patient);
        }

        function proceedDirectlyToJourney(patient) {
            // Update selected patient data
            selectedPatientData = patient;

            // Hide entry screen
            document.getElementById('patientEntryScreen').style.display = 'none';

            // Show patient header
            const header = document.getElementById('selectedPatientHeader');
            header.style.display = 'block';

            // Show back to list button in top header
            document.getElementById('topBackToListBtn').style.display = 'block';

            // Sync role selector (top is always visible)
            const topRoleSelect = document.getElementById('topRoleSelect');
            if (topRoleSelect) {
                topRoleSelect.value = currentRole;
            }

            // Update current patient index and navigation
            updateCurrentPatientIndex(patient.id);

            // Populate header
            document.getElementById('patientInitials').textContent = patient.firstName.charAt(0) + patient.lastName.charAt(0);
            document.getElementById('patientFullName').textContent = `${patient.firstName} ${patient.lastName}`;
            document.getElementById('patientAge').textContent = `${patient.age} years`;
            document.getElementById('patientGender').textContent = patient.gender;
            document.getElementById('patientCondition').textContent = patient.condition;

            // Show journey content
            document.getElementById('journeyContent').style.display = 'block';

            // Update URL with patient ID and current role
            updateURL(patient.id, currentRole, 'today');

            // Activate Today's Journey tab and render it
            switchTab('today');
        }

        function backToPatientList() {
            // Hide all pages
            document.getElementById('journeyContent').style.display = 'none';
            document.getElementById('selectedPatientHeader').style.display = 'none';
            document.getElementById('consentFormPage').style.display = 'none';
            document.getElementById('paymentPage').style.display = 'none';

            // Hide back to list button only
            document.getElementById('topBackToListBtn').style.display = 'none';

            // Show entry screen
            document.getElementById('patientEntryScreen').style.display = 'block';

            // Reset patient selection
            clearPatientSelection();

            // Reset onboarding state
            currentOnboardingPatient = null;
            hasSignature = false;

            // Reset clarity wireframes dropdown
            const topClarityDropdown = document.getElementById('topClaritySelector');
            if (topClarityDropdown) topClarityDropdown.value = 'none';

            // Reset to Today's Journey tab
            switchTab('today');
        }

        function showAddNewPatient() {
            // Hide the main patient selection
            document.getElementById('patientEntryScreen').querySelector('[style*="max-width: 600px"]').style.display = 'none';
            // Show the add patient form
            document.getElementById('addNewPatientSection').style.display = 'block';
        }

        function cancelAddPatient() {
            // Hide the add patient form
            document.getElementById('addNewPatientSection').style.display = 'none';
            // Show the main patient selection
            document.getElementById('patientEntryScreen').querySelector('[style*="max-width: 600px"]').style.display = 'block';
        }

        function submitNewPatient(event) {
            event.preventDefault();

            // Get form data
            const form = document.getElementById('newPatientForm');
            const formData = new FormData(form);

            // Create new patient object
            const newPatient = {
                id: 'P' + String(samplePatients.length + 1).padStart(3, '0'),
                firstName: form.elements[0].value,
                lastName: form.elements[1].value,
                age: calculateAge(form.elements[2].value),
                gender: form.elements[3].value.charAt(0).toUpperCase() + form.elements[3].value.slice(1),
                condition: form.elements[5].value === 'parkinsons' ? "Parkinson's Disease" :
                    form.elements[5].value === 'depression' ? 'Depression' :
                        form.elements[5].value === 'anxiety' ? 'Anxiety' : 'Other',
                lastVisit: new Date().toISOString().split('T')[0],
                status: 'active',
                nextAppointment: null
            };

            // Add to patient list
            samplePatients.push(newPatient);

            // Hide form
            cancelAddPatient();

            // Start onboarding flow with questionnaire
            showQuestionnaireScreen(newPatient);
        }

        function calculateAge(birthDate) {
            const today = new Date('2026-02-01');
            const birth = new Date(birthDate);
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        }

        function handleEntryRoleChange() {
            const entryRole = document.getElementById('entryRoleSelector').value;
            const addPatientBtn = document.getElementById('addPatientButtonContainer');
            const welcomeMsg = document.getElementById('welcomeMessage');

            // Update welcome message
            const welcomeMessages = {
                'receptionist': 'Welcome Back, Receptionist!',
                'patient': 'Welcome!',
                'doctor': 'Welcome, Doctor!',
                'clinical-assistant': 'Welcome, Clinical Assistant!'
            };
            welcomeMsg.textContent = welcomeMessages[entryRole] || 'Welcome Back!';

            // Show/hide add patient button (only for receptionist)
            if (entryRole === 'receptionist') {
                addPatientBtn.style.display = 'block';
            } else {
                addPatientBtn.style.display = 'none';
            }
        }

        function handleRoleChange() {
            const roleSelector = document.getElementById('roleSelector');
            if (!roleSelector) return;

            currentRole = roleSelector.value;

            // Update patient navigation visibility
            updatePatientNavigationVisibility();

            // Re-render views if patient is selected
            if (document.getElementById('journeyContent').style.display === 'block') {
                if (document.getElementById('todayTabContent').style.display === 'block') {
                    renderTodayView();
                }
                if (document.getElementById('workingTabContent').style.display === 'block') {
                    renderWorkingView();
                }
            }
        }

        // Update role display banner
        function updateRoleDisplay(role) {
            const roleIcon = document.getElementById('roleIcon');
            const roleTitle = document.getElementById('roleTitle');
            const roleDescription = document.getElementById('roleDescription');
            const roleBadge = document.getElementById('roleBadge');
            
            if (!roleIcon || !roleTitle || !roleDescription || !roleBadge) return;
            
            const roleConfig = {
                'doctor': {
                    icon: 'fa-user-doctor',
                    title: 'Doctor',
                    description: 'Full clinical access - Manage assessments and treatment plans',
                    class: 'doctor'
                },
                'clinical-assistant': {
                    icon: 'fa-user-nurse',
                    title: 'Clinical Assistant',
                    description: 'Support role - Assist with assessments and patient care',
                    class: 'clinical-assistant'
                },
                'patient': {
                    icon: 'fa-user',
                    title: 'Patient',
                    description: 'Patient view - Track your health journey and results',
                    class: 'patient'
                },
                'receptionist': {
                    icon: 'fa-user-tie',
                    title: 'Receptionist',
                    description: 'Administrative access - Manage patient records and appointments',
                    class: 'receptionist'
                }
            };
            
            const config = roleConfig[role] || roleConfig['receptionist'];
            
            // Update icon
            roleIcon.className = 'role-icon ' + config.class;
            roleIcon.innerHTML = '<i class="fa-solid ' + config.icon + '"></i>';
            
            // Update title and description
            roleTitle.textContent = config.title;
            roleDescription.textContent = config.description;
            
            // Update badge
            roleBadge.className = 'role-badge ' + config.class;
            roleBadge.textContent = role.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }

        // Handler functions for top controls
        function handleTopRoleChange() {
            const topRoleSelect = document.getElementById('topRoleSelect');
            
            if (!topRoleSelect) return;
            
            currentRole = topRoleSelect.value;
            
            // Update role display banner
            updateRoleDisplay(currentRole);
            
            // Update patient navigation visibility
            updatePatientNavigationVisibility();

            // Re-render views if patient is selected
            if (document.getElementById('journeyContent').style.display === 'block') {
                if (document.getElementById('todayTabContent').style.display === 'block') {
                    renderTodayView();
                }
                if (document.getElementById('workingTabContent').style.display === 'block') {
                    renderWorkingView();
                }
            }
        }

        function handleTopClarityWireframeChange() {
            const topSelector = document.getElementById('topClaritySelector');
            
            if (!topSelector) return;
            
            const selectedWireframe = topSelector.value;
            
            if (selectedWireframe === 'none') {
                return;
            }
            
            // Handle wireframe navigation
            if (selectedWireframe === 'working') {
                window.location.href = 'working-active-journey.html';
            } else if (selectedWireframe === 'device') {
                switchTab('device');
            }
        }

        // PATIENT NAVIGATION FUNCTIONS
        let currentPatientIndex = 0;

        function updatePatientNavigationVisibility() {
            const navigationDiv = document.getElementById('patientNavigation');

            // Show navigation only for Doctor and Clinical Assistant roles
            if (currentRole === 'doctor' || currentRole === 'clinical-assistant') {
                if (navigationDiv) navigationDiv.style.display = 'flex';
            } else {
                if (navigationDiv) navigationDiv.style.display = 'none';
            }
        }

        function updatePatientCounter() {
            const counterSpan = document.getElementById('patientCounter');
            const prevBtn = document.getElementById('prevPatientBtn');
            const nextBtn = document.getElementById('nextPatientBtn');
            
            const totalPatients = samplePatients.length;
            const counterText = `${currentPatientIndex + 1} / ${totalPatients}`;

            // Update counter
            if (counterSpan) counterSpan.textContent = counterText;

            // Disable/enable buttons based on position
            const isPrevDisabled = currentPatientIndex === 0;
            const isNextDisabled = currentPatientIndex === totalPatients - 1;

            if (prevBtn) prevBtn.disabled = isPrevDisabled;
            if (nextBtn) nextBtn.disabled = isNextDisabled;
        }

        function navigateToPreviousPatient() {
            if (currentPatientIndex > 0) {
                currentPatientIndex--;
                const patient = samplePatients[currentPatientIndex];
                selectPatient(patient);
                updatePatientCounter();
            }
        }

        function navigateToNextPatient() {
            if (currentPatientIndex < samplePatients.length - 1) {
                currentPatientIndex++;
                const patient = samplePatients[currentPatientIndex];
                selectPatient(patient);
                updatePatientCounter();
            }
        }

        function updateCurrentPatientIndex(patientId) {
            const index = samplePatients.findIndex(p => p.id === patientId);
            if (index !== -1) {
                currentPatientIndex = index;
                updatePatientCounter();
                updatePatientNavigationVisibility();
            }
        }

        // KEYBOARD EVENT LISTENER FOR MODAL
        document.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('fnonAssessmentModal');
                if (modal && modal.classList.contains('open')) {
                    closeAssessmentModal();
                }
            }
        });

        // ========================================
        // URL ROUTING & STATE MANAGEMENT
        // ========================================

        // Get URL parameters
        function getURLParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                patientId: params.get('patient'),
                role: params.get('role'),
                tab: params.get('tab')
            };
        }

        // Update URL without reload
        function updateURL(patientId, role, tab) {
            const params = new URLSearchParams();
            if (patientId) params.set('patient', patientId);
            if (role) params.set('role', role);
            if (tab) params.set('tab', tab);
            
            const newURL = `${window.location.pathname}?${params.toString()}`;
            window.history.pushState({ patientId, role, tab }, '', newURL);
        }

        // Handle browser back/forward buttons
        window.addEventListener('popstate', function(event) {
            if (event.state) {
                const { patientId, role, tab } = event.state;
                restoreStateFromURL(patientId, role, tab);
            } else {
                // No state - go back to patient selection
                returnToPatientSelection();
            }
        });

        // Restore state from URL parameters
        function restoreStateFromURL(patientId, role, tab) {
            if (!patientId) {
                returnToPatientSelection();
                return;
            }

            const patient = samplePatients.find(p => p.id === patientId);
            if (!patient) {
                returnToPatientSelection();
                return;
            }

            selectedPatientData = patient;

            if (role) {
                currentRole = role;
                const topRoleSelect = document.getElementById('topRoleSelect');
                if (topRoleSelect) {
                    topRoleSelect.value = role;
                }
            }

            showJourneyForPatient(patient);
            
            const targetTab = tab || 'today';
            switchTab(targetTab, true);
        }

        // Return to patient selection screen
        function returnToPatientSelection() {
            // Show entry screen
            document.getElementById('patientEntryScreen').style.display = 'block';
            
            // Hide patient header and journey content
            document.getElementById('selectedPatientHeader').style.display = 'none';
            document.getElementById('journeyRoleSelector').style.display = 'none';
            document.getElementById('journeyContent').style.display = 'none';
            
            // Clear selected patient data
            selectedPatientData = null;
            
            // Clear URL
            window.history.replaceState({}, '', window.location.pathname);
        }

        // Show journey for patient (without updating URL)
        function showJourneyForPatient(patient) {
            // Hide entry screen
            document.getElementById('patientEntryScreen').style.display = 'none';

            // Show patient header
            const header = document.getElementById('selectedPatientHeader');
            header.style.display = 'block';

            // Show top header controls
            document.getElementById('topRoleSelector').style.display = 'block';
            document.getElementById('topClarityWireframes').style.display = 'block';
            document.getElementById('topBackToListBtn').style.display = 'block';

            // Update role display banner
            updateRoleDisplay(currentRole);

            // Update current patient index and navigation
            updateCurrentPatientIndex(patient.id);

            // Populate header
            document.getElementById('patientInitials').textContent = patient.firstName.charAt(0) + patient.lastName.charAt(0);
            document.getElementById('patientFullName').textContent = `${patient.firstName} ${patient.lastName}`;
            document.getElementById('patientAge').textContent = `${patient.age} years`;
            document.getElementById('patientGender').textContent = patient.gender;
            document.getElementById('patientCondition').textContent = patient.condition;

            // Show journey content
            document.getElementById('journeyContent').style.display = 'block';
        }

        // Initialize from URL on page load
        function initializeFromURL() {
            const { patientId, role, tab } = getURLParams();
            
            if (patientId) {
                restoreStateFromURL(patientId, role, tab);
            } else {
                // No patient in URL - show selection screen
                returnToPatientSelection();
            }
        }

        // INITIALIZE
        // IMPORTANT: Check URL for role FIRST before any rendering
        const urlParams = getURLParams();
        if (urlParams.role) {
            currentRole = urlParams.role;
        }
        
        renderAssessments();
        renderPatientDropdown();
        handleEntryRoleChange(); // Initialize entry role-based UI
        
        // Initialize role display banner with current role
        updateRoleDisplay(currentRole);
        
        // Initialize from URL if patient is in URL
        initializeFromURL();

        // EXPOSE FOR DEBUGGING
        window.patientState = patientState;
    </script>
</body>

</html>