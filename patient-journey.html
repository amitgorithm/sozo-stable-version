<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Journey - Sozo Clinical Operating System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --orange-primary: rgb(244, 121, 32);
            --blue-primary: rgb(0, 161, 228);
            --dark-bg: #0f172a;
            --light-bg: #f8f9fa;
            --slate-border: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--light-bg);
            color: #1e293b;
        }

        .container-journey {
            padding: 24px;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* ASSESSMENT SECTION */
        .assessment-section {
            margin-bottom: 24px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .assessment-section.expanded {
            border-color: var(--orange-primary);
        }

        .assessment-section.locked {
            opacity: 0.7;
        }

        .assessment-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .assessment-header:hover:not(.locked) {
            background: rgba(244, 121, 32, 0.05);
        }

        .assessment-header.locked {
            cursor: not-allowed;
        }

        .assessment-title {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .assessment-title h2 {
            font-size: 20px;
            font-weight: 700;
            color: #0f172a;
        }

        .expand-icon {
            font-size: 18px;
            color: #64748b;
            transition: transform 0.3s ease;
            margin-left: 12px;
        }

        .assessment-section.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .assessment-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .assessment-badge.completed {
            background: rgba(244, 121, 32, 0.15);
            color: var(--orange-primary);
        }

        .assessment-badge.active {
            background: rgba(0, 161, 228, 0.15);
            color: var(--blue-primary);
        }

        .assessment-meta {
            font-size: 12px;
            color: #64748b;
            display: flex;
            gap: 16px;
            margin-top: 8px;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .assessment-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
        }

        .assessment-section.expanded .assessment-content {
            max-height: 2000px;
        }

        .assessment-content-inner {
            padding: 0 20px 20px 20px;
        }

        .progress-bar {
            height: 4px;
            background: #e5e7eb;
            margin-top: 12px;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--orange-primary), #dc6027);
            transition: width 0.3s ease;
        }

        /* BLOCKS HORIZONTAL GRID */
        .blocks-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
            position: relative;
            overflow: visible;
        }

        .block-card {
            background: white;
            border-radius: 12px;
            border: 1px solid var(--slate-border);
            padding: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            overflow: visible;
            min-height: fit-content;
        }

        .block-card.expanded {
            overflow: visible;
            padding-bottom: 24px;
            z-index: 1;
        }

        .block-card.expanded:hover {
            z-index: 10;
        }

        .block-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: transparent;
            transition: all 0.3s ease;
        }

        .block-card:hover {
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            transform: translateY(-4px);
        }

        /* STATE-BASED COLORS */
        .block-card.completed::before {
            background: var(--orange-primary);
        }

        .block-card.pending::before {
            background: var(--blue-primary);
        }

        .block-card.active::before {
            background: #10b981;
        }

        .block-card.locked::before {
            background: #cbd5e1;
        }

        /* ICON CIRCLE */
        .block-icon {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin-bottom: 12px;
            flex-shrink: 0;
        }

        /* STATE-BASED ICON COLORS */
        .block-card.completed .block-icon {
            background: rgba(244, 121, 32, 0.15);
            color: var(--orange-primary);
        }

        .block-card.pending .block-icon {
            background: rgba(0, 161, 228, 0.15);
            color: var(--blue-primary);
        }

        .block-card.active .block-icon {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
        }

        .block-card.locked .block-icon {
            background: rgba(203, 213, 225, 0.3);
            color: #cbd5e1;
        }

        /* BLOCK TITLE & SUBTITLE */
        .block-name {
            font-size: 14px;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 4px;
        }

        .block-desc {
            font-size: 12px;
            color: #64748b;
            line-height: 1.4;
        }

        /* BLOCK SCORE DISPLAY */
        .block-score-display {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e2e8f0;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .block-score-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .block-score-label {
            font-size: 10px;
            color: #64748b;
            font-weight: 600;
            text-transform: uppercase;
        }

        .block-score-value {
            font-size: 14px;
            font-weight: 700;
            color: var(--orange-primary);
        }

        /* BLOCK VIEW BUTTON */
        .block-view-btn {
            margin-top: 10px;
            padding: 6px 14px;
            background: var(--orange-primary);
            color: white;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
        }

        .block-view-btn:hover {
            background: #dc6027;
            transform: scale(1.05);
        }

        /* STATUS OVERLAY */
        .block-status {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 4px 10px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            font-weight: 700;
            background: white;
            border: 1.5px solid var(--slate-border);
        }

        .block-status-icon {
            font-size: 12px;
        }

        .block-status-text {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .block-card.completed .block-status {
            background: rgba(244, 121, 32, 0.15);
            color: var(--orange-primary);
            border-color: var(--orange-primary);
        }

        .block-card.pending .block-status {
            background: rgba(0, 161, 228, 0.15);
            color: var(--blue-primary);
            border-color: var(--blue-primary);
        }

        .block-card.active .block-status {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
            border-color: #10b981;
            animation: pulse 2s infinite;
        }

        .block-card.locked .block-status {
            background: rgba(148, 163, 184, 0.15);
            color: #64748b;
            border-color: #94a3b8;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* SESSIONS ROW */
        .sessions-row {
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--slate-border);
        }

        .sessions-title {
            font-size: 12px;
            font-weight: 700;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        .sessions-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }

        /* SESSION BOX CARD */
        .session-box {
            background: white;
            border: 1px solid var(--slate-border);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .session-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: transparent;
            transition: all 0.3s ease;
        }

        .session-box.completed::before {
            background: var(--orange-primary);
        }

        .session-box.pending::before {
            background: var(--blue-primary);
        }

        .session-box.active::before {
            background: #10b981;
        }

        .session-box.disabled::before {
            background: #cbd5e1;
        }

        .session-box:hover:not(.disabled) {
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            transform: translateY(-4px);
        }

        /* SESSION ICON */
        .session-icon {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 12px;
            flex-shrink: 0;
        }

        .session-box.completed .session-icon {
            background: rgba(244, 121, 32, 0.15);
            color: var(--orange-primary);
        }

        .session-box.pending .session-icon {
            background: rgba(0, 161, 228, 0.15);
            color: var(--blue-primary);
        }

        .session-box.disabled .session-icon {
            background: rgba(203, 213, 225, 0.3);
            color: #cbd5e1;
            opacity: 0.6;
        }

        .session-box.active .session-icon {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
            animation: subtle-pulse 2s infinite;
        }

        @keyframes subtle-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* SESSION HEADER */
        .session-header {
            font-size: 14px;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 8px;
        }

        /* SESSION STATUS BADGE */
        .session-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            font-weight: 700;
            padding: 6px 12px;
            border-radius: 12px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .session-status-icon {
            font-size: 12px;
        }

        .session-box.completed .session-status-badge {
            background: rgba(244, 121, 32, 0.15);
            color: var(--orange-primary);
            border: 1.5px solid var(--orange-primary);
        }

        .session-box.pending .session-status-badge {
            background: rgba(0, 161, 228, 0.15);
            color: var(--blue-primary);
            border: 1.5px solid var(--blue-primary);
        }

        .session-box.active .session-status-badge {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
            border: 1.5px solid #10b981;
        }

        .session-box.disabled .session-status-badge {
            background: rgba(148, 163, 184, 0.15);
            color: #64748b;
            border: 1.5px solid #94a3b8;
        }

        /* SESSION INFO */
        .session-info {
            font-size: 11px;
            color: #64748b;
            line-height: 1.6;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .session-info-item {
            margin: 4px 0;
        }

        .session-info-label {
            font-weight: 600;
            color: #475569;
        }

        .session-info-value {
            color: #64748b;
            font-size: 10px;
        }

        /* PAGE HEADER */
        .page-header {
            margin-bottom: 32px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--slate-border);
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 6px;
        }

        .page-subtitle {
            font-size: 14px;
            color: #64748b;
        }

        /* IMPROVEMENTS BUTTON */
        .improvements-section {
            margin-top: 32px;
            padding: 24px;
            background: white;
            border-radius: 12px;
            border: 2px solid var(--slate-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .improvements-text h3 {
            font-size: 16px;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 4px;
        }

        .improvements-text p {
            font-size: 13px;
            color: #64748b;
        }

        .improvements-btn {
            background: linear-gradient(135deg, var(--orange-primary) 0%, rgb(202, 65, 12) 100%);
            color: white;
            border: none;
            padding: 12px 28px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .improvements-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(244, 121, 32, 0.3);
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* TABS */
        .tabs-container {
            background: white;
            border-radius: 12px;
            padding: 8px;
            margin-bottom: 24px;
            display: flex;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .tab-button {
            flex: 1;
            padding: 12px 24px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-button:hover {
            background: rgba(244, 121, 32, 0.1);
            color: var(--orange-primary);
        }

        .tab-button.active {
            background: var(--orange-primary);
            color: white;
            box-shadow: 0 2px 8px rgba(244, 121, 32, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ROLE SELECTOR */
        .role-selector-container {
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .role-label {
            font-size: 14px;
            font-weight: 600;
            color: #64748b;
        }

        .role-select {
            padding: 8px 16px;
            border: 2px solid var(--slate-border);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #0f172a;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .role-select:hover {
            border-color: var(--orange-primary);
        }

        .role-select:focus {
            outline: none;
            border-color: var(--orange-primary);
            box-shadow: 0 0 0 3px rgba(244, 121, 32, 0.1);
        }

        /* TODAY'S VIEW */
        .today-header {
            background: rgba(244, 121, 32, 0.1);
            border: 2px solid rgba(244, 121, 32, 0.3);
            color: #0f172a;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .today-header h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #0f172a;
        }

        .today-header p {
            font-size: 14px;
            color: #64748b;
        }

        .today-blocks-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .today-blocks-section h3 {
            font-size: 18px;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 16px;
        }

        .block-expanded-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, opacity 0.3s ease;
            margin-top: 16px;
            opacity: 0;
            width: 100%;
        }

        .block-card.expanded .block-expanded-details {
            max-height: 800px;
            overflow: visible;
            opacity: 1;
            padding-bottom: 8px;
        }

        .block-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            background: #f8fafc;
            padding: 16px;
            border-radius: 8px;
            position: relative;
            z-index: 1;
        }

        .block-info-item {
            display: flex;
            flex-direction: column;
        }

        .block-info-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: #64748b;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .block-info-value {
            font-size: 14px;
            font-weight: 700;
            color: #0f172a;
        }

        .action-button {
            padding: 10px 20px;
            border-radius: 8px;
            border: 2px solid var(--slate-border);
            background: white;
            font-size: 13px;
            font-weight: 600;
            color: #0f172a;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .action-button:hover {
            border-color: var(--orange-primary);
            color: var(--orange-primary);
        }

        .action-button.primary {
            background: var(--orange-primary);
            border-color: var(--orange-primary);
            color: white;
        }

        .action-button.primary:hover {
            background: #dc6027;
            transform: translateY(-1px);
        }

        .activity-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
            position: relative;
            z-index: 100;
        }

        .activity-tag {
            padding: 6px 12px;
            background: rgba(0, 161, 228, 0.15);
            color: #0369a1;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 101;
        }

        .activity-tag:hover {
            background: rgba(0, 161, 228, 0.25);
            transform: translateY(-2px);
            z-index: 9999;
        }

        .activity-tag-image {
            display: none;
            position: absolute;
            bottom: calc(100% + 12px);
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            width: 250px;
            height: auto;
            max-height: 250px;
            border-radius: 12px;
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.4);
            border: 4px solid white;
            pointer-events: none;
            background: white;
            object-fit: contain;
        }

        .activity-tag:hover .activity-tag-image {
            display: block;
        }

        .detail-section {
            margin-top: 12px;
            position: relative;
            z-index: 50;
            overflow: visible;
        }

        .detail-section-title {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            color: #64748b;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .block-action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            width: 100%;
            flex-wrap: wrap;
        }

        .block-action-btn {
            flex: 1;
            min-width: 120px;
            padding: 10px 16px;
            border-radius: 8px;
            border: 2px solid;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            position: relative;
            z-index: 10;
            pointer-events: auto;
        }

        .block-action-btn.view {
            background: white;
            border-color: var(--blue-primary);
            color: var(--blue-primary);
        }

        .block-action-btn.view:hover {
            background: var(--blue-primary);
            color: white;
        }

        .block-action-btn.edit {
            background: var(--orange-primary);
            border-color: var(--orange-primary);
            color: white;
        }

        .block-action-btn.edit:hover {
            background: #dc6027;
            transform: translateY(-1px);
        }

        .block-action-btn.disabled {
            background: #e2e8f0;
            border-color: #cbd5e1;
            color: #94a3b8;
            cursor: not-allowed;
        }

        /* MODAL STYLES */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 1200px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: white;
            padding: 24px;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .modal-body {
            padding: 24px;
        }

        .network-section {
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 24px;
            margin-bottom: 24px;
        }

        .network-section:last-child {
            border-bottom: none;
        }

        .network-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .network-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--orange-primary);
        }

        .network-signs {
            font-size: 13px;
            color: #64748b;
            font-style: italic;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .test-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
            margin-bottom: 8px;
        }

        .test-name {
            font-weight: 500;
            color: #334155;
        }

        .test-score {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .score-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            opacity: 0.4;
            transition: all 0.2s ease;
        }

        .score-badge.active {
            opacity: 1;
            box-shadow: 0 0 8px currentColor;
        }

        .score-badge.score-0 {
            background: #0ea5e9;
            color: white;
        }

        .score-badge.score-1 {
            background: #f59e0b;
            color: white;
        }

        .score-badge.score-2 {
            background: #ef4444;
            color: white;
        }

        .summary-section {
            background: linear-gradient(to right, #f8fafc, #eff6ff);
            border-radius: 12px;
            border: 2px solid #cbd5e1;
            padding: 24px;
            margin-top: 24px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .summary-card {
            background: white;
            border-radius: 10px;
            padding: 16px;
            border-left: 4px solid #3b82f6;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .summary-label {
            font-size: 11px;
            font-weight: 700;
            color: #64748b;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .summary-value {
            font-size: 32px;
            font-weight: 900;
            color: #0f172a;
        }

        .summary-detail {
            font-size: 12px;
            color: #64748b;
            margin-top: 4px;
        }

        .interpretation-box {
            margin-top: 16px;
            padding: 16px;
            border-radius: 10px;
            border: 2px solid;
        }

        .accordion-indicator {
            position: absolute;
            bottom: 8px;
            right: 12px;
            font-size: 12px;
            color: #94a3b8;
            transition: transform 0.3s ease;
            z-index: 1;
            pointer-events: none;
        }

        .block-card.expanded .accordion-indicator {
            transform: rotate(180deg);
            bottom: 12px;
        }

        .next-up-banner {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 16px 20px;
            border-radius: 8px;
            margin-top: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .next-up-icon {
            font-size: 24px;
        }

        .next-up-text {
            flex: 1;
        }

        .next-up-text strong {
            display: block;
            font-size: 14px;
            color: #78350f;
            margin-bottom: 4px;
        }

        .next-up-text span {
            font-size: 13px;
            color: #92400e;
        }

        /* WORKING JOURNEY STYLES */
        .patient-info-banner {
            background: rgba(244, 121, 32, 0.1);
            border: 2px solid rgba(244, 121, 32, 0.3);
            color: #0f172a;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .patient-info-banner h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #0f172a;
        }

        .patient-info-banner p {
            font-size: 14px;
            color: #64748b;
        }

        .patient-meta {
            display: flex;
            gap: 24px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .patient-meta-item {
            display: flex;
            flex-direction: column;
        }

        .patient-meta-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: #64748b;
            letter-spacing: 0.5px;
        }

        .patient-meta-value {
            font-size: 14px;
            font-weight: 700;
            color: #0f172a;
            margin-top: 4px;
        }

        .block-card.can-start {
            cursor: pointer;
            border-color: rgba(244, 121, 32, 0.3);
        }

        .block-card.can-start:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
            border-color: var(--orange-primary);
        }

        .block-status.ready {
            background: rgba(16, 185, 129, 0.15);
            color: var(--green-primary);
            border: 1.5px solid #10b981;
        }

        .block-status.view-only {
            background: rgba(0, 161, 228, 0.15);
            color: var(--blue-primary);
            border: 1.5px solid #00a1e4;
        }

        .start-button {
            width: 100%;
            padding: 10px 16px;
            border-radius: 8px;
            border: none;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .start-button.primary {
            background: var(--orange-primary);
            color: white;
        }

        .start-button.primary:hover {
            background: #dc6027;
            transform: translateY(-1px);
        }

        .start-button.disabled {
            background: #e2e8f0;
            color: #94a3b8;
            cursor: not-allowed;
        }

        .start-button.view-only {
            background: rgba(0, 161, 228, 0.1);
            color: var(--blue-primary);
            border: 2px solid rgba(0, 161, 228, 0.3);
        }

        .tooltip {
            position: relative;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #0f172a;
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 11px;
        }

        .tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #0f172a transparent transparent transparent;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .permission-legend {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .permission-legend h3 {
            font-size: 16px;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 16px;
        }

        .legend-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .legend-badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .legend-badge.ready {
            background: rgba(16, 185, 129, 0.15);
            color: var(--green-primary);
        }

        .legend-badge.locked {
            background: rgba(100, 116, 139, 0.15);
            color: #64748b;
        }

        .legend-badge.view-only {
            background: rgba(0, 161, 228, 0.15);
            color: var(--blue-primary);
        }

        .legend-text {
            font-size: 13px;
            color: #64748b;
        }

        /* DEVICE LOCKING STYLES */
        .device-state-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .device-state-header {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid;
        }

        .device-state-header.locked-state {
            background: rgba(239, 68, 68, 0.05);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .device-state-header.unlocked-state {
            background: rgba(16, 185, 129, 0.05);
            border-color: rgba(16, 185, 129, 0.3);
        }

        .state-icon {
            font-size: 32px;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .locked-state .state-icon {
            background: rgba(239, 68, 68, 0.15);
            color: #dc2626;
        }

        .unlocked-state .state-icon {
            background: rgba(16, 185, 129, 0.15);
            color: var(--green-primary);
        }

        .state-info {
            flex: 1;
        }

        .state-info h3 {
            font-size: 18px;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 4px;
        }

        .state-info p {
            font-size: 13px;
            color: #64748b;
        }

        .state-badge {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 8px;
            letter-spacing: 0.5px;
        }

        .locked-badge {
            background: rgba(239, 68, 68, 0.15);
            color: #dc2626;
        }

        .unlocked-badge {
            background: rgba(16, 185, 129, 0.15);
            color: var(--green-primary);
        }

        .payment-warning {
            background: rgba(239, 68, 68, 0.1);
            border-left: 4px solid #dc2626;
            padding: 12px 16px;
            border-radius: 6px;
            margin-top: 12px;
            font-size: 12px;
            color: #991b1b;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .payment-success {
            background: rgba(16, 185, 129, 0.1);
            border-left: 4px solid var(--green-primary);
            padding: 12px 16px;
            border-radius: 6px;
            margin-top: 12px;
            font-size: 12px;
            color: #065f46;
            display: flex;
            align-items: center;
            gap: 8px;
        }
    </style>
</head>
<body>
    <div class="container-journey">
        <!-- PAGE HEADER -->
        <div class="page-header">
            <h1 class="page-title">Patient Journey</h1>
            <p class="page-subtitle">Clinical Assessment Progress & Session Timeline</p>
        </div>

        <!-- CONSENT FORM PAGE -->
        <div id="consentFormPage" style="display: none;">
            <div style="max-width: 900px; margin: 0 auto;">
                <!-- Header -->
                <div style="text-align: center; margin-bottom: 32px;">
                    <div style="width: 72px; height: 72px; border-radius: 50%; background: linear-gradient(135deg, var(--blue-primary), #0284c7); margin: 0 auto 20px; display: flex; align-items: center; justify-content: center;">
                        <i class="fa-solid fa-file-signature" style="font-size: 32px; color: white;"></i>
                    </div>
                    <h2 style="font-size: 28px; font-weight: 700; color: #0f172a; margin-bottom: 8px;">Patient Consent Form</h2>
                    <p style="font-size: 14px; color: #64748b;">Please review and sign the consent form to proceed</p>
                </div>

                <!-- PDF Viewer -->
                <div style="background: white; border-radius: 16px; padding: 24px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12); margin-bottom: 32px;">
                    <div style="background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 24px; margin-bottom: 24px;">
                        <embed src="consent.pdf" type="application/pdf" width="100%" height="600px" style="border-radius: 8px;" />
                    </div>

                    <!-- E-Signature Section -->
                    <div style="background: linear-gradient(135deg, rgba(0, 161, 228, 0.05), rgba(2, 132, 199, 0.05)); border: 2px solid var(--blue-primary); border-radius: 12px; padding: 24px;">
                        <h3 style="font-size: 16px; font-weight: 700; color: #0f172a; margin-bottom: 16px;">Electronic Signature</h3>
                        
                        <div style="display: grid; gap: 16px;">
                            <!-- Full Name -->
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; color: #475569; margin-bottom: 8px;">FULL NAME *</label>
                                <input type="text" id="consentFullName" readonly style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: #f8fafc; color: #0f172a; font-weight: 600;">
                            </div>

                            <!-- Signature Canvas -->
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; color: #475569; margin-bottom: 8px;">SIGNATURE *</label>
                                <div style="position: relative;">
                                    <canvas id="signatureCanvas" width="800" height="200" style="border: 2px solid #e2e8f0; border-radius: 8px; cursor: crosshair; background: white; width: 100%; height: 200px;"></canvas>
                                    <button type="button" onclick="clearSignature()" style="position: absolute; top: 8px; right: 8px; padding: 6px 12px; background: white; border: 2px solid #e2e8f0; border-radius: 6px; color: #64748b; font-size: 11px; font-weight: 600; cursor: pointer;">
                                        <i class="fa-solid fa-eraser"></i> Clear
                                    </button>
                                </div>
                                <p style="font-size: 11px; color: #94a3b8; margin-top: 8px;"><i class="fa-solid fa-info-circle"></i> Draw your signature using mouse or touch</p>
                            </div>

                            <!-- Date -->
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; color: #475569; margin-bottom: 8px;">DATE</label>
                                <input type="text" id="consentDate" readonly value="February 1, 2026" style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: #f8fafc; color: #64748b;">
                            </div>

                            <!-- Checkbox -->
                            <div style="display: flex; align-items: start; gap: 12px; padding: 16px; background: white; border-radius: 8px;">
                                <input type="checkbox" id="consentCheckbox" style="width: 20px; height: 20px; margin-top: 2px; cursor: pointer;">
                                <label for="consentCheckbox" style="font-size: 13px; color: #475569; cursor: pointer;">
                                    I have read and understood the consent form. I agree to the terms and conditions outlined above and provide my consent for the proposed treatment.
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 12px; justify-content: center;">
                    <button type="button" onclick="backToPatientSelection()" style="padding: 16px 32px; border: 2px solid #e2e8f0; background: white; color: #64748b; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                        <i class="fa-solid fa-arrow-left"></i> Back
                    </button>
                    <button type="button" id="submitConsentBtn" onclick="submitConsent()" disabled style="padding: 16px 48px; border: none; background: linear-gradient(135deg, var(--blue-primary), #0284c7); color: white; border-radius: 12px; font-size: 15px; font-weight: 700; cursor: not-allowed; opacity: 0.5; transition: all 0.2s; box-shadow: 0 4px 12px rgba(0, 161, 228, 0.3);">
                        Sign & Continue <i class="fa-solid fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- PAYMENT PAGE -->
        <div id="paymentPage" style="display: none;">
            <div style="max-width: 900px; margin: 0 auto;">
                <!-- Header -->
                <div style="text-align: center; margin-bottom: 32px;">
                    <div style="width: 72px; height: 72px; border-radius: 50%; background: linear-gradient(135deg, #10b981, #059669); margin: 0 auto 20px; display: flex; align-items: center; justify-content: center;">
                        <i class="fa-solid fa-credit-card" style="font-size: 32px; color: white;"></i>
                    </div>
                    <h2 style="font-size: 28px; font-weight: 700; color: #0f172a; margin-bottom: 8px;">Secure Payment</h2>
                    <p style="font-size: 14px; color: #64748b;">Powered by <strong>Stripe</strong> • PCI DSS Compliant • 256-bit SSL Encryption</p>
                </div>

                <!-- Payment Summary -->
                <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1)); border: 2px solid #10b981; border-radius: 16px; padding: 24px; margin-bottom: 32px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <span style="font-size: 14px; color: #64748b;" class="payment-description">Initial Consultation Fee</span>
                        <span style="font-size: 24px; font-weight: 700; color: #0f172a;" class="payment-amount">€300</span>
                    </div>
                    <div style="padding-top: 12px; border-top: 2px dashed #10b981; font-size: 12px; color: #64748b;" class="payment-details">
                        <i class="fa-solid fa-info-circle"></i> This includes initial assessments (PRS, FNON, EEG) and onboarding
                    </div>
                </div>

                <!-- Payment Method Selection -->
                <div style="background: white; border-radius: 16px; padding: 32px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12); margin-bottom: 24px;">
                    <h3 style="font-size: 18px; font-weight: 700; color: #0f172a; margin-bottom: 20px;">Select Payment Method</h3>
                    
                    <!-- Payment Method Tabs -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 32px;">
                        <!-- Card Payment (Selected) -->
                        <div id="paymentMethodCard" onclick="selectPaymentMethod('card')" style="padding: 16px; border: 3px solid #10b981; background: rgba(16, 185, 129, 0.05); border-radius: 12px; cursor: pointer; text-align: center; transition: all 0.3s;">
                            <i class="fa-solid fa-credit-card" style="font-size: 24px; color: #10b981; margin-bottom: 8px;"></i>
                            <div style="font-size: 13px; font-weight: 700; color: #0f172a;">Card Payment</div>
                            <div style="font-size: 11px; color: #64748b; margin-top: 4px;">Visa, Mastercard, Amex</div>
                        </div>

                        <!-- Digital Wallets -->
                        <div id="paymentMethodWallet" onclick="selectPaymentMethod('wallet')" style="padding: 16px; border: 2px solid #e2e8f0; background: white; border-radius: 12px; cursor: pointer; text-align: center; transition: all 0.3s;">
                            <i class="fa-brands fa-apple-pay" style="font-size: 24px; color: #64748b; margin-bottom: 8px;"></i>
                            <div style="font-size: 13px; font-weight: 700; color: #0f172a;">Digital Wallet</div>
                            <div style="font-size: 11px; color: #64748b; margin-top: 4px;">Apple Pay, Google Pay</div>
                        </div>

                        <!-- QR Code Payment -->
                        <div id="paymentMethodQR" onclick="selectPaymentMethod('qr')" style="padding: 16px; border: 2px solid #e2e8f0; background: white; border-radius: 12px; cursor: pointer; text-align: center; transition: all 0.3s;">
                            <i class="fa-solid fa-qrcode" style="font-size: 24px; color: #64748b; margin-bottom: 8px;"></i>
                            <div style="font-size: 13px; font-weight: 700; color: #0f172a;">QR Code</div>
                            <div style="font-size: 11px; color: #64748b; margin-top: 4px;">WeChat, Alipay, UPI</div>
                        </div>

                        <!-- Bank Transfer -->
                        <div id="paymentMethodBank" onclick="selectPaymentMethod('bank')" style="padding: 16px; border: 2px solid #e2e8f0; background: white; border-radius: 12px; cursor: pointer; text-align: center; transition: all 0.3s;">
                            <i class="fa-solid fa-building-columns" style="font-size: 24px; color: #64748b; margin-bottom: 8px;"></i>
                            <div style="font-size: 13px; font-weight: 700; color: #0f172a;">Bank Transfer</div>
                            <div style="font-size: 11px; color: #64748b; margin-top: 4px;">SEPA, ACH, Wire</div>
                        </div>
                    </div>

                    <!-- Card Payment Form (Default Selected) -->
                    <div id="cardPaymentSection">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid #e2e8f0;">
                            <h4 style="font-size: 16px; font-weight: 700; color: #0f172a;">Card Details</h4>
                            <div style="display: flex; gap: 8px;">
                                <i class="fa-brands fa-cc-visa" style="font-size: 32px; color: #1a1f71;"></i>
                                <i class="fa-brands fa-cc-mastercard" style="font-size: 32px; color: #eb001b;"></i>
                                <i class="fa-brands fa-cc-amex" style="font-size: 32px; color: #006fcf;"></i>
                                <i class="fa-brands fa-cc-discover" style="font-size: 32px; color: #ff6000;"></i>
                            </div>
                        </div>

                        <form id="paymentForm">
                            <!-- Cardholder Name -->
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; font-size: 12px; font-weight: 600; color: #475569; margin-bottom: 8px;">CARDHOLDER NAME</label>
                                <input type="text" id="cardholderName" value="Sarah Mitchell" style="width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;" onfocus="this.style.borderColor='#10b981'" onblur="this.style.borderColor='#e2e8f0'">
                            </div>

                            <!-- Card Number with Stripe Element Simulation -->
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; font-size: 12px; font-weight: 600; color: #475569; margin-bottom: 8px;">CARD NUMBER</label>
                                <div style="position: relative;">
                                    <input type="text" id="cardNumber" value="4242 4242 4242 4242" maxlength="19" style="width: 100%; padding: 14px 50px 14px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s; font-family: 'Courier New', monospace; letter-spacing: 2px;" onfocus="this.style.borderColor='#10b981'" onblur="this.style.borderColor='#e2e8f0'" oninput="detectCardType(this.value)">
                                    <i id="cardTypeIcon" class="fa-brands fa-cc-visa" style="position: absolute; right: 16px; top: 50%; transform: translateY(-50%); font-size: 24px; color: #1a1f71;"></i>
                                </div>
                                <div style="font-size: 11px; color: #64748b; margin-top: 6px;">
                                    <i class="fa-solid fa-shield-halved" style="color: #10b981;"></i> Stripe secure element • Data never stored on our servers
                                </div>
                            </div>

                            <!-- Expiry and CVC -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                                <div>
                                    <label style="display: block; font-size: 12px; font-weight: 600; color: #475569; margin-bottom: 8px;">EXPIRY DATE</label>
                                    <input type="text" id="cardExpiry" value="12/28" maxlength="5" placeholder="MM/YY" style="width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s; font-family: 'Courier New', monospace;" onfocus="this.style.borderColor='#10b981'" onblur="this.style.borderColor='#e2e8f0'">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; font-weight: 600; color: #475569; margin-bottom: 8px;">CVC</label>
                                    <div style="position: relative;">
                                        <input type="text" id="cardCvc" value="123" maxlength="4" placeholder="123" style="width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s; font-family: 'Courier New', monospace;" onfocus="this.style.borderColor='#10b981'" onblur="this.style.borderColor='#e2e8f0'">
                                        <i class="fa-solid fa-circle-question" style="position: absolute; right: 16px; top: 50%; transform: translateY(-50%); color: #94a3b8; cursor: help;" title="3-digit security code on the back of your card"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- Country and ZIP -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                                <div>
                                    <label style="display: block; font-size: 12px; font-weight: 600; color: #475569; margin-bottom: 8px;">COUNTRY</label>
                                    <select id="billingCountry" style="width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s; background: white; cursor: pointer;" onfocus="this.style.borderColor='#10b981'" onblur="this.style.borderColor='#e2e8f0'">
                                        <option value="IE" selected>🇮🇪 Ireland</option>
                                        <option value="GB">🇬🇧 United Kingdom</option>
                                        <option value="US">🇺🇸 United States</option>
                                        <option value="DE">🇩🇪 Germany</option>
                                        <option value="FR">🇫🇷 France</option>
                                        <option value="IN">🇮🇳 India</option>
                                        <option value="CN">🇨🇳 China</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 12px; font-weight: 600; color: #475569; margin-bottom: 8px;">POSTAL CODE</label>
                                    <input type="text" id="billingZip" value="D02 XY45" maxlength="10" style="width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;" onfocus="this.style.borderColor='#10b981'" onblur="this.style.borderColor='#e2e8f0'">
                                </div>
                            </div>

                            <!-- Save Card Option -->
                            <div style="margin-bottom: 20px;">
                                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="saveCard" checked style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="font-size: 13px; color: #475569;">Save card for future payments (PCI compliant tokenization)</span>
                                </label>
                            </div>
                        </form>
                    </div>

                    <!-- Digital Wallet Section (Hidden by default) -->
                    <div id="walletPaymentSection" style="display: none;">
                        <div style="text-align: center; padding: 40px 20px;">
                            <div style="display: flex; justify-content: center; gap: 16px; margin-bottom: 24px;">
                                <button style="padding: 16px 32px; background: black; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                    <i class="fa-brands fa-apple-pay" style="font-size: 24px;"></i> Apple Pay
                                </button>
                                <button style="padding: 16px 32px; background: white; border: 2px solid #e2e8f0; color: #0f172a; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                    <i class="fa-brands fa-google-pay" style="font-size: 24px;"></i> Google Pay
                                </button>
                            </div>
                            <p style="font-size: 12px; color: #64748b;">Quick checkout with your saved payment methods</p>
                        </div>
                    </div>

                    <!-- QR Code Section (Hidden by default) -->
                    <div id="qrPaymentSection" style="display: none;">
                        <div style="text-align: center; padding: 20px;">
                            <h4 style="font-size: 16px; font-weight: 700; color: #0f172a; margin-bottom: 20px;">Scan to Pay</h4>
                            
                            <!-- QR Code Display -->
                            <div style="background: white; padding: 24px; border: 2px solid #e2e8f0; border-radius: 16px; display: inline-block; margin-bottom: 20px;">
                                <div style="width: 200px; height: 200px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 3px solid #10b981; border-radius: 12px; display: flex; align-items: center; justify-content: center; position: relative;">
                                    <i class="fa-solid fa-qrcode" style="font-size: 120px; color: #0f172a; opacity: 0.8;"></i>
                                    <div style="position: absolute; bottom: 8px; right: 8px; width: 32px; height: 32px; background: #10b981; border-radius: 6px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fa-solid fa-check" style="color: white; font-size: 16px;"></i>
                                    </div>
                                </div>
                            </div>

                            <p style="font-size: 14px; color: #0f172a; font-weight: 600; margin-bottom: 8px;">Scan with your mobile payment app</p>
                            <p style="font-size: 12px; color: #64748b; margin-bottom: 24px;">Supported: WeChat Pay, Alipay, UPI, Paytm</p>

                            <!-- Payment Options -->
                            <div style="display: flex; justify-content: center; gap: 12px; flex-wrap: wrap;">
                                <div style="padding: 8px 16px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 11px; color: #64748b;">
                                    <i class="fa-brands fa-weixin" style="color: #09b83e;"></i> WeChat Pay
                                </div>
                                <div style="padding: 8px 16px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 11px; color: #64748b;">
                                    <i class="fa-solid fa-mobile-screen-button" style="color: #1677ff;"></i> Alipay
                                </div>
                                <div style="padding: 8px 16px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 11px; color: #64748b;">
                                    <i class="fa-solid fa-building-columns" style="color: #ff6b00;"></i> UPI
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bank Transfer Section (Hidden by default) -->
                    <div id="bankPaymentSection" style="display: none;">
                        <div style="padding: 20px;">
                            <div style="background: #fef3c7; border: 1px solid #fbbf24; border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <i class="fa-solid fa-circle-info" style="color: #d97706; font-size: 20px;"></i>
                                    <div>
                                        <div style="font-size: 13px; font-weight: 700; color: #92400e; margin-bottom: 4px;">Bank transfer takes 2-3 business days</div>
                                        <div style="font-size: 12px; color: #78350f;">Your appointment will be confirmed once payment is received</div>
                                    </div>
                                </div>
                            </div>

                            <div style="background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px;">
                                <h4 style="font-size: 14px; font-weight: 700; color: #0f172a; margin-bottom: 16px;">Bank Details</h4>
                                <div style="display: grid; gap: 12px; font-size: 13px;">
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #64748b;">Bank Name:</span>
                                        <span style="font-weight: 600; color: #0f172a;">Allied Irish Bank (AIB)</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #64748b;">Account Name:</span>
                                        <span style="font-weight: 600; color: #0f172a;">Sozo Clinic Ltd</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #64748b;">IBAN:</span>
                                        <span style="font-weight: 600; color: #0f172a; font-family: 'Courier New', monospace;">IE29 AIBK 9311 5212 3456 78</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #64748b;">BIC/SWIFT:</span>
                                        <span style="font-weight: 600; color: #0f172a; font-family: 'Courier New', monospace;">AIBKIE2D</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #64748b;">Reference:</span>
                                        <span style="font-weight: 600; color: #10b981; font-family: 'Courier New', monospace;">PAT-SM-2026-001</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Security Notice -->
                    <div style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; margin-top: 24px;">
                        <i class="fa-solid fa-shield-halved" style="color: #16a34a; font-size: 16px;"></i>
                        <span style="font-size: 12px; color: #15803d;">256-bit SSL encryption • PCI DSS Level 1 certified • Your data is never stored</span>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 12px;">
                    <button type="button" onclick="backFromPayment()" style="padding: 16px 24px; border: 2px solid #e2e8f0; background: white; color: #64748b; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                        <i class="fa-solid fa-arrow-left"></i> Back
                    </button>
                    <button type="button" onclick="selectPayLater()" style="flex: 1; padding: 16px; border: 2px solid #e2e8f0; background: white; color: #64748b; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                        <i class="fa-solid fa-clock"></i> Pay Later
                    </button>
                    <button type="button" onclick="processPayment()" style="flex: 2; padding: 16px; border: none; background: linear-gradient(135deg, #10b981, #059669); color: white; border-radius: 12px; font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                        <i class="fa-solid fa-lock"></i> Secure Payment <span class="payment-amount">€300</span>
                    </button>
                </div>

                <!-- Payment Providers -->
                <div style="text-align: center; margin-top: 24px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                    <p style="font-size: 11px; color: #94a3b8; margin-bottom: 12px;">Payment processed securely by</p>
                    <div style="display: flex; justify-content: center; align-items: center; gap: 24px; flex-wrap: wrap;">
                        <div style="font-size: 20px; font-weight: 700; color: #635bff;">Stripe</div>
                        <div style="font-size: 11px; color: #cbd5e1;">|</div>
                        <i class="fa-solid fa-shield-halved" style="font-size: 16px; color: #10b981;"></i>
                        <div style="font-size: 11px; color: #64748b; font-weight: 600;">PCI DSS Compliant</div>
                        <div style="font-size: 11px; color: #cbd5e1;">|</div>
                        <i class="fa-solid fa-lock" style="font-size: 14px; color: #64748b;"></i>
                        <div style="font-size: 11px; color: #64748b; font-weight: 600;">SSL Secured</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PATIENT SELECTION / ENTRY SCREEN -->
        <div id="patientEntryScreen" style="display: block;">
            <!-- Centered Container -->
            <div style="max-width: 600px; margin: 60px auto; text-align: center;">
                <!-- Role Selector for Entry -->
                <div style="margin-bottom: 32px;">
                    <label style="font-size: 12px; font-weight: 600; color: #64748b; margin-right: 12px;">I AM:</label>
                    <select id="entryRoleSelector" onchange="handleEntryRoleChange()" style="padding: 10px 20px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; font-weight: 600; color: #0f172a; cursor: pointer; background: white;">
                        <option value="receptionist" selected>Receptionist</option>
                        <option value="patient">Patient</option>
                        <option value="doctor">Doctor</option>
                        <option value="clinical-assistant">Clinical Assistant</option>
                    </select>
                </div>

                <!-- Welcome Message -->
                <div style="margin-bottom: 48px;">
                    <div style="font-size: 32px; font-weight: 700; color: #0f172a; margin-bottom: 12px;">
                        <span id="welcomeMessage">Welcome Back!</span>
                    </div>
                    <p style="font-size: 16px; color: #64748b;">Select a patient to view their journey</p>
                </div>

                <!-- Search and Select Patient -->
                <div style="background: white; border-radius: 16px; padding: 32px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12); margin-bottom: 32px;">
                    <!-- Search Input -->
                    <div style="position: relative; margin-bottom: 20px;">
                        <input 
                            type="text" 
                            id="patientSearchInput"
                            placeholder="Search by name or ID..." 
                            oninput="filterPatients()"
                            style="width: 100%; padding: 16px 48px 16px 48px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 15px; transition: all 0.3s; background: #f8fafc;"
                            onfocus="this.style.borderColor='var(--orange-primary)'; this.style.background='white';"
                            onblur="this.style.borderColor='#e2e8f0'; this.style.background='#f8fafc';">
                        <i class="fa-solid fa-search" style="position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: #94a3b8; font-size: 16px;"></i>
                        <i class="fa-solid fa-filter" style="position: absolute; right: 18px; top: 50%; transform: translateY(-50%); color: #94a3b8; font-size: 16px;"></i>
                    </div>

                    <!-- Selected Patient Display -->
                    <div id="selectedPatientDisplay" style="display: none; background: linear-gradient(135deg, rgba(244, 121, 32, 0.1), rgba(220, 96, 39, 0.1)); border: 2px solid var(--orange-primary); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <div style="width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(135deg, var(--orange-primary), #dc6027); display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; font-weight: 700; flex-shrink: 0;">
                                <span id="selectedPatientInitials">SM</span>
                            </div>
                            <div style="flex: 1; text-align: left;">
                                <div style="font-size: 18px; font-weight: 700; color: #0f172a; margin-bottom: 4px;" id="selectedPatientName">Sarah Mitchell</div>
                                <div style="display: flex; gap: 16px; font-size: 13px; color: #64748b;">
                                    <span><i class="fa-solid fa-calendar"></i> <span id="selectedPatientAge">42 yrs</span></span>
                                    <span><i class="fa-solid fa-stethoscope"></i> <span id="selectedPatientCondition">Parkinson's</span></span>
                                </div>
                            </div>
                            <button onclick="clearPatientSelection()" style="padding: 8px 12px; background: white; border: 2px solid #e2e8f0; border-radius: 8px; color: #64748b; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                <i class="fa-solid fa-times"></i> Change
                            </button>
                        </div>
                    </div>

                    <!-- Patient Dropdown List -->
                    <div id="patientDropdownList" style="max-height: 400px; overflow-y: auto; border-radius: 12px; border: 2px solid #e2e8f0; background: #f8fafc;">
                        <!-- Patient options will be rendered here -->
                    </div>

                    <!-- No results message -->
                    <div id="noResultsMessage" style="display: none; padding: 40px; text-align: center; color: #94a3b8;">
                        <i class="fa-solid fa-search" style="font-size: 32px; margin-bottom: 12px; display: block;"></i>
                        <p style="font-size: 14px;">No patients found</p>
                    </div>
                </div>

                <!-- Add New Patient Button (for receptionist) -->
                <div id="addPatientButtonContainer" style="display: none;">
                    <div style="position: relative; margin: 40px 0;">
                        <div style="position: absolute; top: 50%; left: 0; right: 0; height: 1px; background: #e2e8f0;"></div>
                        <div style="position: relative; background: var(--light-bg); display: inline-block; padding: 0 16px;">
                            <span style="font-size: 13px; color: #94a3b8; font-weight: 600;">OR</span>
                        </div>
                    </div>
                    
                    <button onclick="showAddNewPatient()" style="display: inline-flex; align-items: center; gap: 12px; padding: 16px 32px; background: linear-gradient(135deg, var(--orange-primary), #dc6027); border: none; border-radius: 12px; color: white; font-size: 15px; font-weight: 700; cursor: pointer; box-shadow: 0 8px 20px rgba(244, 121, 32, 0.35); transition: all 0.3s;">
                        <div style="width: 32px; height: 32px; background: rgba(255, 255, 255, 0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <i class="fa-solid fa-plus" style="font-size: 16px;"></i>
                        </div>
                        <span>Add New Patient</span>
                    </button>
                </div>
            </div>

            <!-- ADD NEW PATIENT FORM (Hidden by default) -->
            <div id="addNewPatientSection" style="display: none;">
                <div style="background: white; border-radius: 16px; padding: 40px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12); max-width: 700px; margin: 0 auto;">
                    <div style="text-align: center; margin-bottom: 32px;">
                        <div style="width: 72px; height: 72px; border-radius: 50%; background: linear-gradient(135deg, var(--orange-primary), #dc6027); margin: 0 auto 20px; display: flex; align-items: center; justify-content: center;">
                            <i class="fa-solid fa-user-plus" style="font-size: 32px; color: white;"></i>
                        </div>
                        <h2 style="font-size: 26px; font-weight: 700; color: #0f172a; margin-bottom: 8px;">Add New Patient</h2>
                        <p style="font-size: 14px; color: #64748b;">Enter patient information to create their record</p>
                    </div>

                    <form id="newPatientForm" style="display: grid; gap: 20px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; color: #475569; margin-bottom: 8px;">FIRST NAME *</label>
                                <input type="text" required style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;" placeholder="John" onfocus="this.style.borderColor='var(--orange-primary)'" onblur="this.style.borderColor='#e2e8f0'">
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; color: #475569; margin-bottom: 8px;">LAST NAME *</label>
                                <input type="text" required style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;" placeholder="Doe" onfocus="this.style.borderColor='var(--orange-primary)'" onblur="this.style.borderColor='#e2e8f0'">
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; color: #475569; margin-bottom: 8px;">DATE OF BIRTH *</label>
                                <input type="date" required style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;" onfocus="this.style.borderColor='var(--orange-primary)'" onblur="this.style.borderColor='#e2e8f0'">
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; color: #475569; margin-bottom: 8px;">GENDER *</label>
                                <select required style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;" onfocus="this.style.borderColor='var(--orange-primary)'" onblur="this.style.borderColor='#e2e8f0'">
                                    <option value="">Select</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label style="display: block; font-size: 12px; font-weight: 600; color: #475569; margin-bottom: 8px;">EMAIL *</label>
                            <input type="email" required style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;" placeholder="john.doe@example.com" onfocus="this.style.borderColor='var(--orange-primary)'" onblur="this.style.borderColor='#e2e8f0'">
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; color: #475569; margin-bottom: 8px;">PHONE *</label>
                                <input type="tel" required style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;" placeholder="+1 (555) 123-4567" onfocus="this.style.borderColor='var(--orange-primary)'" onblur="this.style.borderColor='#e2e8f0'">
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; color: #475569; margin-bottom: 8px;">CONDITION *</label>
                                <select required style="width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; transition: all 0.2s;" onfocus="this.style.borderColor='var(--orange-primary)'" onblur="this.style.borderColor='#e2e8f0'">
                                    <option value="">Select</option>
                                    <option value="parkinsons">Parkinson's</option>
                                    <option value="depression">Depression</option>
                                    <option value="anxiety">Anxiety</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>

                        <div style="display: flex; gap: 12px; margin-top: 16px;">
                            <button type="button" onclick="cancelAddPatient()" style="flex: 1; padding: 14px; border: 2px solid #e2e8f0; background: white; color: #64748b; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                Cancel
                            </button>
                            <button type="submit" onclick="submitNewPatient(event)" style="flex: 2; padding: 14px; border: none; background: linear-gradient(135deg, var(--orange-primary), #dc6027); color: white; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(244, 121, 32, 0.3);">
                                <i class="fa-solid fa-check"></i> Create Patient
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- SELECTED PATIENT HEADER (Hidden by default) -->
        <div id="selectedPatientHeader" style="display: none; background: white; border-radius: 12px; padding: 24px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); border-left: 4px solid var(--orange-primary);">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, var(--orange-primary), #dc6027); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: 700;">
                        <span id="patientInitials">SM</span>
                    </div>
                    <div>
                        <h2 id="patientFullName" style="font-size: 20px; font-weight: 700; color: #0f172a; margin-bottom: 4px;">Sarah Mitchell</h2>
                        <div style="display: flex; gap: 16px; font-size: 13px; color: #64748b;">
                            <span><i class="fa-solid fa-calendar"></i> <span id="patientAge">42 years</span></span>
                            <span><i class="fa-solid fa-venus-mars"></i> <span id="patientGender">Female</span></span>
                            <span><i class="fa-solid fa-stethoscope"></i> <span id="patientCondition">Parkinson's Disease</span></span>
                        </div>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 16px;">
                    <!-- Role Selector (only shown in journey) -->
                    <div id="journeyRoleSelector" style="display: none;">
                        <label style="font-size: 12px; font-weight: 600; color: #475569; margin-right: 8px;">VIEW AS:</label>
                        <select id="roleSelector" onchange="handleRoleChange()" style="padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 13px; font-weight: 600; color: #0f172a; cursor: pointer; background: white;">
                            <option value="receptionist" selected>Receptionist</option>
                            <option value="patient">Patient</option>
                            <option value="doctor">Doctor</option>
                            <option value="clinical-assistant">Clinical Assistant</option>
                        </select>
                    </div>
                    <button onclick="backToPatientList()" style="padding: 10px 20px; border: 2px solid #e2e8f0; background: white; color: #64748b; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                        <i class="fa-solid fa-arrow-left"></i> Back to List
                    </button>
                </div>
            </div>
        </div>

        <!-- JOURNEY CONTENT (Hidden by default) -->
        <div id="journeyContent" style="display: none;">

        <!-- TABS -->
        <div class="tabs-container">
            <button class="tab-button active" id="todayTab" onclick="switchTab('today')">Today's Journey</button>
            <button class="tab-button" id="overallTab" onclick="switchTab('overall')">Overall Journey</button>
            <button class="tab-button" id="workingTab" onclick="switchTab('working')">Working Active Journey</button>
            <button class="tab-button" id="deviceTab" onclick="switchTab('device')">Device Locking</button>
        </div>

        <!-- OVERALL JOURNEY TAB -->
        <div id="overallTabContent" class="tab-content" style="display: none;">

        <!-- ASSESSMENTS STACK -->
        <div id="assessmentsContainer"></div>

        <!-- IMPROVEMENTS CTA -->
        <div class="improvements-section">
            <div class="improvements-text">
                <h3>Track Your Progress</h3>
                <p>Compare metrics across clinical assessments and see improvements over time</p>
            </div>
            <button class="improvements-btn" onclick="window.location.href='improvements.html'">
                See Improvements
                <i class="fa-solid fa-arrow-right"></i>
            </button>
        </div>

        </div>
        <!-- END OVERALL JOURNEY TAB -->

        <!-- TODAY'S JOURNEY TAB -->
        <div id="todayTabContent" class="tab-content active">
            <div class="today-header">
                <h2>Today's Activity</h2>
                <p id="todayDate">February 1, 2026 - Clinical Assessment 2 in Progress</p>
            </div>

            <div id="todayContent">
                <!-- Today's content will be rendered here -->
            </div>
        </div>
        <!-- END TODAY'S JOURNEY TAB -->

        <!-- WORKING ACTIVE JOURNEY TAB -->
        <div id="workingTabContent" class="tab-content" style="display: none;">
            <div class="patient-info-banner">
                <h2>New Patient Check-In</h2>
                <p>Patient has just arrived at the clinic</p>
                <div class="patient-meta">
                    <div class="patient-meta-item">
                        <div class="patient-meta-label">Patient Name</div>
                        <div class="patient-meta-value">Sarah Mitchell</div>
                    </div>
                    <div class="patient-meta-item">
                        <div class="patient-meta-label">Check-In Time</div>
                        <div class="patient-meta-value">10:30 AM</div>
                    </div>
                    <div class="patient-meta-item">
                        <div class="patient-meta-label">Assessment</div>
                        <div class="patient-meta-value">Clinical Assessment 2</div>
                    </div>
                    <div class="patient-meta-item">
                        <div class="patient-meta-label">Status</div>
                        <div class="patient-meta-value">Ready to Begin</div>
                    </div>
                </div>
            </div>

            <div id="workingBlocksContainer" class="blocks-container"></div>

            <div class="permission-legend">
                <h3>Permission Guide</h3>
                <div class="legend-items">
                    <div class="legend-item">
                        <span class="legend-badge ready">Can Start</span>
                        <span class="legend-text">You can initiate this assessment</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-badge view-only">View Only</span>
                        <span class="legend-text">Visible but requires doctor permission</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-badge locked">Locked</span>
                        <span class="legend-text">Complete previous steps first</span>
                    </div>
                </div>
            </div>
        </div>
        <!-- END WORKING ACTIVE JOURNEY TAB -->

        <!-- DEVICE LOCKING TAB -->
        <div id="deviceTabContent" class="tab-content" style="display: none;">
            <div class="patient-info-banner">
                <h2>Device Activation & Payment Flow</h2>
                <p>EEG Device locking mechanism based on payment status</p>
                <div class="patient-meta">
                    <div class="patient-meta-item">
                        <div class="patient-meta-label">Patient Name</div>
                        <div class="patient-meta-value">Sarah Mitchell</div>
                    </div>
                    <div class="patient-meta-item">
                        <div class="patient-meta-label">Assessment</div>
                        <div class="patient-meta-value">Clinical Assessment 2</div>
                    </div>
                    <div class="patient-meta-item">
                        <div class="patient-meta-label">Device Required</div>
                        <div class="patient-meta-value">EEG Headset</div>
                    </div>
                </div>
            </div>

            <!-- STATE 1: PAYMENT NOT PROCESSED - DEVICE LOCKED -->
            <div class="device-state-section">
                <div class="device-state-header locked-state">
                    <div class="state-icon">
                        <i class="fa-solid fa-lock"></i>
                    </div>
                    <div class="state-info">
                        <h3>State 1: Payment Not Processed</h3>
                        <p>Device activation blocked until payment confirmation</p>
                    </div>
                    <div class="state-badge locked-badge">
                        <i class="fa-solid fa-circle-xmark"></i>
                        Device Locked
                    </div>
                </div>
                <div id="deviceLockedContainer" class="blocks-container" style="margin-top: 20px;"></div>
            </div>

            <!-- STATE 2: PAYMENT PROCESSED - DEVICE UNLOCKED -->
            <div class="device-state-section" style="margin-top: 32px;">
                <div class="device-state-header unlocked-state">
                    <div class="state-icon">
                        <i class="fa-solid fa-lock-open"></i>
                    </div>
                    <div class="state-info">
                        <h3>State 2: Payment Processed</h3>
                        <p>Device activated and ready for assessment</p>
                    </div>
                    <div class="state-badge unlocked-badge">
                        <i class="fa-solid fa-circle-check"></i>
                        Device Active
                    </div>
                </div>
                <div id="deviceUnlockedContainer" class="blocks-container" style="margin-top: 20px;"></div>
            </div>

            <!-- DEVICE INFO -->
            <div class="permission-legend" style="margin-top: 32px;">
                <h3>Payment & Device Activation Flow</h3>
                <div class="legend-items">
                    <div class="legend-item">
                        <span class="legend-badge locked" style="background: rgba(239, 68, 68, 0.15); color: #dc2626;">
                            <i class="fa-solid fa-lock"></i> Locked
                        </span>
                        <span class="legend-text">Payment pending - Device cannot be activated</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-badge ready">
                            <i class="fa-solid fa-lock-open"></i> Active
                        </span>
                        <span class="legend-text">Payment confirmed - Device ready for use</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-badge view-only">
                            <i class="fa-solid fa-eye"></i> Visible
                        </span>
                        <span class="legend-text">All roles can see payment status</span>
                    </div>
                </div>
            </div>
        </div>
        <!-- END DEVICE LOCKING TAB -->

        </div>
        <!-- END JOURNEY CONTENT -->

    </div>
    <!-- END CONTAINER -->

    <script>
        // PATIENT STATE - SINGLE SOURCE OF TRUTH
        const patientState = {
            patientId: 'PAT-001',
            patientName: 'Sarah Mitchell',
            clinicalAssessments: [
                {
                    id: 'ca-1',
                    number: 1,
                    status: 'completed',
                    startDate: '2025-09-15',
                    completedDate: '2025-10-20',
                    blocks: [
                        { 
                            id: 'fnon-1', 
                            name: 'FNON', 
                            desc: 'Network Analysis',
                            type: 'fnon',
                            status: 'completed', 
                            completedBy: 'Dr. James', 
                            completedAt: '2025-09-18' 
                        },
                        { 
                            id: 'eeg-1', 
                            name: 'Brain Mapping', 
                            desc: 'EEG Imaging',
                            type: 'brain-mapping',
                            status: 'completed', 
                            completedBy: 'Tech Sarah', 
                            completedAt: '2025-09-22' 
                        },
                        { 
                            id: 'prs-1', 
                            name: 'PRS', 
                            desc: 'Symptoms',
                            type: 'prs',
                            status: 'completed', 
                            completedBy: 'Dr. James', 
                            completedAt: '2025-09-25' 
                        },
                        { 
                            id: 'ana-1', 
                            name: "Doctor's Notes", 
                            desc: 'Clinical Notes',
                            type: 'doctor-notes',
                            status: 'completed', 
                            completedBy: 'Dr. James', 
                            completedAt: '2025-10-01' 
                        },
                        { 
                            id: 'treatment-1', 
                            name: 'Treatment Plan', 
                            desc: 'Therapy Design',
                            type: 'treatment-plan',
                            status: 'completed', 
                            completedBy: 'Dr. James', 
                            completedAt: '2025-10-10' 
                        },
                        { 
                            id: 'report-1', 
                            name: 'Final Report', 
                            desc: 'Comprehensive',
                            type: 'final-report',
                            status: 'completed', 
                            completedBy: 'Dr. James', 
                            completedAt: '2025-10-20' 
                        }
                    ],
                    sessions: [
                        { id: 'sess-1-1', number: 1, status: 'completed', device: 'TMS-Unit-A', montage: 'Motor Cortex', completedAt: '2025-10-25' },
                        { id: 'sess-1-2', number: 2, status: 'completed', device: 'TMS-Unit-A', montage: 'DLPFC', completedAt: '2025-10-28' },
                        { id: 'sess-1-3', number: 3, status: 'completed', device: 'TMS-Unit-A', montage: 'DLPFC', completedAt: '2025-11-01' },
                        { id: 'sess-1-4', number: 4, status: 'completed', device: 'TMS-Unit-A', montage: 'Motor Cortex', completedAt: '2025-11-05' },
                        { id: 'sess-1-5', number: 5, status: 'completed', device: 'TMS-Unit-A', montage: 'DLPFC', completedAt: '2025-11-08' }
                    ]
                },
                {
                    id: 'ca-2',
                    number: 2,
                    status: 'active',
                    startDate: '2026-01-15',
                    completedDate: null,
                    blocks: [
                        { 
                            id: 'fnon-2', 
                            name: 'FNON', 
                            desc: 'Network Analysis',
                            type: 'fnon',
                            status: 'completed', 
                            completedBy: 'Dr. James', 
                            completedAt: '2026-01-15', 
                            score: 32 
                        },
                        { 
                            id: 'eeg-2', 
                            name: 'Brain Mapping', 
                            desc: 'EEG Imaging',
                            type: 'brain-mapping',
                            status: 'completed', 
                            completedBy: 'Tech Sarah', 
                            completedAt: '2026-01-17', 
                            channelsCaptured: 32 
                        },
                        { 
                            id: 'prs-2', 
                            name: 'PRS', 
                            desc: 'Symptoms',
                            type: 'prs',
                            status: 'completed', 
                            completedBy: 'Patient Self-Report', 
                            completedAt: '2026-01-30' 
                        },
                        { 
                            id: 'ana-2', 
                            name: "Doctor's Notes", 
                            desc: 'Clinical Notes',
                            type: 'doctor-notes',
                            status: 'completed', 
                            completedBy: 'Dr. James Wilson', 
                            completedAt: '2026-02-01' 
                        },
                        { 
                            id: 'treatment-2', 
                            name: 'Treatment Plan', 
                            desc: 'Therapy Design',
                            type: 'treatment-plan',
                            status: 'locked', 
                            performer: null 
                        },
                        { 
                            id: 'report-2', 
                            name: 'Final Report', 
                            desc: 'Comprehensive',
                            type: 'final-report',
                            status: 'locked', 
                            completedBy: null, 
                            completedAt: null 
                        }
                    ],
                    sessions: [
                        { id: 'sess-2-1', number: 1, status: 'pending', device: 'TMS-Unit-B', montage: 'DLPFC', prerequisite: 'Doctor Review' },
                        { id: 'sess-2-2', number: 2, status: 'disabled', device: null, montage: null },
                        { id: 'sess-2-3', number: 3, status: 'disabled', device: null, montage: null },
                        { id: 'sess-2-4', number: 4, status: 'disabled', device: null, montage: null },
                        { id: 'sess-2-5', number: 5, status: 'disabled', device: null, montage: null }
                    ]
                },
                {
                    id: 'ca-3',
                    number: 3,
                    status: 'locked',
                    startDate: '2026-04-15',
                    completedDate: null,
                    blocks: [
                        { id: 'fnon-3', name: 'FNON', desc: 'Network Analysis', type: 'fnon', status: 'locked', completedBy: null, completedAt: null },
                        { id: 'eeg-3', name: 'Brain Mapping', desc: 'EEG Imaging', type: 'brain-mapping', status: 'locked', completedBy: null, completedAt: null },
                        { id: 'prs-3', name: 'PRS', desc: 'Symptoms', type: 'prs', status: 'locked', completedBy: null, completedAt: null },
                        { id: 'ana-3', name: "Doctor's Notes", desc: 'Clinical Notes', type: 'doctor-notes', status: 'locked', completedBy: null, completedAt: null },
                        { id: 'treatment-3', name: 'Treatment Plan', desc: 'Therapy Design', type: 'treatment-plan', status: 'locked', completedBy: null, completedAt: null },
                        { id: 'report-3', name: 'Final Report', desc: 'Comprehensive', type: 'final-report', status: 'locked', completedBy: null, completedAt: null }
                    ],
                    sessions: [
                        { id: 'sess-3-1', number: 1, status: 'disabled', device: null, montage: null },
                        { id: 'sess-3-2', number: 2, status: 'disabled', device: null, montage: null },
                        { id: 'sess-3-3', number: 3, status: 'disabled', device: null, montage: null },
                        { id: 'sess-3-4', number: 4, status: 'disabled', device: null, montage: null },
                        { id: 'sess-3-5', number: 5, status: 'disabled', device: null, montage: null }
                    ]
                },
                {
                    id: 'ca-4',
                    number: 4,
                    status: 'locked',
                    startDate: '2026-07-15',
                    completedDate: null,
                    blocks: [
                        { id: 'fnon-4', name: 'FNON', desc: 'Network Analysis', type: 'fnon', status: 'locked', completedBy: null, completedAt: null },
                        { id: 'eeg-4', name: 'Brain Mapping', desc: 'EEG Imaging', type: 'brain-mapping', status: 'locked', completedBy: null, completedAt: null },
                        { id: 'prs-4', name: 'PRS', desc: 'Symptoms', type: 'prs', status: 'locked', completedBy: null, completedAt: null },
                        { id: 'ana-4', name: "Doctor's Notes", desc: 'Clinical Notes', type: 'doctor-notes', status: 'locked', completedBy: null, completedAt: null },
                        { id: 'treatment-4', name: 'Treatment Plan', desc: 'Therapy Design', type: 'treatment-plan', status: 'locked', completedBy: null, completedAt: null },
                        { id: 'report-4', name: 'Final Report', desc: 'Comprehensive', type: 'final-report', status: 'locked', completedBy: null, completedAt: null }
                    ],
                    sessions: [
                        { id: 'sess-4-1', number: 1, status: 'disabled', device: null, montage: null },
                        { id: 'sess-4-2', number: 2, status: 'disabled', device: null, montage: null },
                        { id: 'sess-4-3', number: 3, status: 'disabled', device: null, montage: null },
                        { id: 'sess-4-4', number: 4, status: 'disabled', device: null, montage: null },
                        { id: 'sess-4-5', number: 5, status: 'disabled', device: null, montage: null }
                    ]
                }
            ]
        };

        // ICON MAPPING
        const iconMap = {
            'fnon': 'fa-list-check',
            'brain-mapping': 'fa-brain',
            'prs': 'fa-comments',
            'doctor-notes': 'fa-clipboard',
            'treatment-plan': 'fa-prescription-bottle-medical',
            'final-report': 'fa-file-pdf'
        };

        // RENDER MAIN CONTENT
        function renderAssessments() {
            const container = document.getElementById('assessmentsContainer');
            container.innerHTML = '';

            patientState.clinicalAssessments.forEach((ca, index) => {
                const caDiv = document.createElement('div');
                caDiv.className = 'assessment-section';
                if (ca.status === 'locked') caDiv.classList.add('locked');
                if (index === 1) caDiv.classList.add('expanded'); // Start with assessment 2 expanded

                // Calculate progress
                const completedBlocks = ca.blocks.filter(b => b.status === 'completed').length;
                const completedSessions = ca.sessions.filter(s => s.status === 'completed').length;
                const totalItems = ca.blocks.length + ca.sessions.length;
                const completedItems = completedBlocks + completedSessions;
                const progressPercent = (completedItems / totalItems) * 100;

                // Header
                const headerDiv = document.createElement('div');
                headerDiv.className = `assessment-header ${ca.status === 'locked' ? 'locked' : ''}`;
                
                const statusIcon = ca.status === 'completed' ? '✓' : ca.status === 'active' ? '●' : '🔒';
                const statusText = ca.status === 'completed' ? 'Completed' : ca.status === 'active' ? 'Active' : 'Locked';
                
                headerDiv.innerHTML = `
                    <div class="assessment-title">
                        <h2>Clinical Assessment ${ca.number}</h2>
                        <span class="assessment-badge ${ca.status}">
                            ${statusIcon} ${statusText}
                        </span>
                    </div>
                    ${ca.status !== 'locked' ? '<span class="expand-icon">▼</span>' : ''}
                `;
                
                // Add click handler for accordion
                if (ca.status !== 'locked') {
                    headerDiv.onclick = () => {
                        caDiv.classList.toggle('expanded');
                    };
                }
                
                caDiv.appendChild(headerDiv);
                
                // Create content wrapper
                const contentDiv = document.createElement('div');
                contentDiv.className = 'assessment-content';
                
                const innerDiv = document.createElement('div');
                innerDiv.className = 'assessment-content-inner';
                
                // Add meta and progress
                const metaDiv = document.createElement('div');
                metaDiv.innerHTML = `
                    <div class="assessment-meta">
                        <div class="meta-item">
                            <i class="fa-solid fa-calendar"></i>
                            <span>${ca.status === 'completed' ? `Completed: ${new Date(ca.completedDate).toLocaleDateString()}` : ca.status === 'active' ? 'In Progress' : `Starts: ${ca.startDate}`}</span>
                        </div>
                        <div class="meta-item">
                            <i class="fa-solid fa-cube"></i>
                            <span>${completedBlocks}/${ca.blocks.length} Blocks</span>
                        </div>
                        <div class="meta-item">
                            <i class="fa-solid fa-dumbbell"></i>
                            <span>${completedSessions}/${ca.sessions.length} Sessions</span>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progressPercent}%"></div>
                    </div>
                `;
                innerDiv.appendChild(metaDiv);

                // Blocks Grid
                const blocksDiv = document.createElement('div');
                blocksDiv.className = 'blocks-container';
                blocksDiv.style.marginTop = '20px';

                ca.blocks.forEach(block => {
                    let blockStatus = block.status;
                    
                    // Patient view logic
                    if (currentRole === 'patient') {
                        // Clinical Assessment 3 and 4 - All blocks should remain locked for patients
                        if (ca.number === 3 || ca.number === 4) {
                            blockStatus = 'locked';
                        }
                        // Clinical Assessment 2 - Final Report should be locked for patients, others keep their status
                        else if (ca.number === 2 && block.type === 'final-report') {
                            blockStatus = 'locked';
                        }
                        // Clinical Assessment 1 - Final Report based on patient success case, others keep their status
                        else if (ca.number === 1 && block.type === 'final-report') {
                            const currentPatientId = selectedPatientData?.id || 'P001';
                            const isSuccessCase = currentPatientId !== 'P005';
                            blockStatus = isSuccessCase ? 'completed' : 'locked';
                        }
                        // For CA1 and CA2, keep the original block status (completed/active/pending/locked)
                    }
                    
                    const blockDiv = document.createElement('div');
                    blockDiv.className = `block-card ${block.type} ${blockStatus}`;
                    
                    let statusIcon, statusText;
                    if (blockStatus === 'completed') {
                        statusIcon = '✓';
                        statusText = 'Done';
                    } else if (blockStatus === 'active') {
                        statusIcon = '●';
                        statusText = 'Active';
                    } else if (blockStatus === 'pending') {
                        statusIcon = '○';
                        statusText = 'Pending';
                    } else {
                        statusIcon = '🔒';
                        statusText = 'Locked';
                    }

                    // Build score display for completed assessments (patient view only)
                    let scoreHTML = '';
                    if (blockStatus === 'completed' && currentRole === 'patient') {
                        const currentPatientId = selectedPatientData?.id || 'P001';
                        const improvement = patientImprovements[currentPatientId] || '+0%';
                        
                        if (block.type === 'fnon') {
                            const fnonScore = calculatePatientFnonScore(ca.number);
                            scoreHTML = `
                                <div class="block-score-display">
                                    <div class="block-score-item">
                                        <span class="block-score-label">Score:</span>
                                        <span class="block-score-value">${fnonScore}/30</span>
                                    </div>
                                    <div class="block-score-item">
                                        <span class="block-score-label">Progress:</span>
                                        <span class="block-score-value" style="color: var(--green-primary);">${improvement}</span>
                                    </div>
                                </div>
                            `;
                        } else if (block.type === 'brain-mapping') {
                            const brainData = getPatientBrainMappingData(currentPatientId, ca.number);
                            if (brainData && brainData.dominantFrequency) {
                                scoreHTML = `
                                    <div class="block-score-display">
                                        <div class="block-score-item">
                                            <span class="block-score-label">Frequency:</span>
                                            <span class="block-score-value">${brainData.dominantFrequency}</span>
                                        </div>
                                    </div>
                                `;
                            }
                        } else if (block.type === 'prs') {
                            const prsData = getPatientPRSData(currentPatientId, ca.number);
                            if (prsData && prsData.overallScore) {
                                scoreHTML = `
                                    <div class="block-score-display">
                                        <div class="block-score-item">
                                            <span class="block-score-label">Score:</span>
                                            <span class="block-score-value">${prsData.overallScore}</span>
                                        </div>
                                    </div>
                                `;
                            }
                        } else if (block.type === 'doctor-notes') {
                            scoreHTML = `
                                <div class="block-score-display">
                                    <div class="block-score-item">
                                        <span class="block-score-label">Status:</span>
                                        <span class="block-score-value">Available</span>
                                    </div>
                                </div>
                            `;
                        } else if (block.type === 'final-report') {
                            scoreHTML = `
                                <div class="block-score-display">
                                    <div class="block-score-item">
                                        <span class="block-score-label">Status:</span>
                                        <span class="block-score-value" style="color: var(--blue-primary);">Complete</span>
                                    </div>
                                </div>
                            `;
                        }
                    }

                    blockDiv.innerHTML = `
                        <div class="block-status">
                            <span class="block-status-icon">${statusIcon}</span>
                            <span class="block-status-text">${statusText}</span>
                        </div>
                        <div class="block-icon">
                            <i class="fa-solid ${iconMap[block.type] || 'fa-circle'}"></i>
                        </div>
                        <div class="block-name">${block.name}</div>
                        <div class="block-desc">${block.desc}</div>
                        ${scoreHTML}
                        ${blockStatus === 'completed' && currentRole === 'patient' && (block.type === 'fnon' || block.type === 'brain-mapping' || block.type === 'prs' || block.type === 'doctor-notes' || block.type === 'final-report') ? 
                            '<div class="block-view-btn"><i class="fa-solid fa-eye"></i> View Details</div>' : ''}
                    `;

                    // Add click handler for viewing details (patient view only)
                    if (blockStatus === 'completed' && currentRole === 'patient' && 
                        (block.type === 'fnon' || block.type === 'brain-mapping' || block.type === 'prs' || block.type === 'doctor-notes' || block.type === 'final-report')) {
                        blockDiv.style.cursor = 'pointer';
                        blockDiv.onclick = () => {
                            viewBlockDetails(block.type, ca.number);
                        };
                    }

                    blocksDiv.appendChild(blockDiv);
                });

                innerDiv.appendChild(blocksDiv);

                // Sessions Row
                if (ca.sessions.length > 0) {
                    const sessionsDiv = document.createElement('div');
                    sessionsDiv.className = 'sessions-row';

                    const sessTitle = document.createElement('div');
                    sessTitle.className = 'sessions-title';
                    sessTitle.textContent = 'Treatment Sessions';
                    sessionsDiv.appendChild(sessTitle);

                    const containerDiv = document.createElement('div');
                    containerDiv.className = 'sessions-container';

                    ca.sessions.forEach(sess => {
                        const box = document.createElement('div');
                        box.className = `session-box ${sess.status}`;

                        let iconClass = 'fa-dumbbell';
                        let statusIcon = '';
                        let statusText = '';
                        let infoHTML = '';

                        if (sess.status === 'completed') {
                            iconClass = 'fa-check-circle';
                            statusIcon = '✓';
                            statusText = 'Completed';
                            infoHTML = `
                                <div class="session-info">
                                    <div class="session-info-item">
                                        <span class="session-info-label">Device:</span> ${sess.device}
                                    </div>
                                    <div class="session-info-item">
                                        <span class="session-info-label">Montage:</span> ${sess.montage}
                                    </div>
                                    <div class="session-info-item">
                                        <span class="session-info-label">Date:</span> ${new Date(sess.completedAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                                    </div>
                                </div>
                            `;
                        } else if (sess.status === 'pending') {
                            iconClass = 'fa-play-circle';
                            statusIcon = '○';
                            statusText = 'Pending';
                            infoHTML = `
                                <div class="session-info">
                                    <div class="session-info-item">
                                        <span class="session-info-label">Ready to start</span>
                                    </div>
                                    <div class="session-info-item">
                                        <span class="session-info-label">Device:</span> ${sess.device}
                                    </div>
                                    <div class="session-info-item">
                                        <span class="session-info-label">Montage:</span> ${sess.montage}
                                    </div>
                                </div>
                            `;
                        } else if (sess.status === 'disabled') {
                            iconClass = 'fa-lock';
                            statusIcon = '🔒';
                            statusText = 'Locked';
                            infoHTML = `
                                <div class="session-info">
                                    <div class="session-info-item">
                                        Awaiting prior sessions
                                    </div>
                                </div>
                            `;
                        }

                        box.innerHTML = `
                            <div class="session-status-badge">
                                <span class="session-status-icon">${statusIcon}</span>
                                <span>${statusText}</span>
                            </div>
                            <div class="session-icon">
                                <i class="fa-solid ${iconClass}"></i>
                            </div>
                            <div class="session-header">Session ${sess.number}</div>
                            ${infoHTML}
                        `;

                        containerDiv.appendChild(box);
                    });

                    sessionsDiv.appendChild(containerDiv);
                    innerDiv.appendChild(sessionsDiv);
                }
                
                contentDiv.appendChild(innerDiv);
                caDiv.appendChild(contentDiv);

                container.appendChild(caDiv);
            });
        }

        // CURRENT ROLE STATE
        let currentRole = 'receptionist';

        // TAB SWITCHING
        function switchTab(tab) {
            // Update tab buttons
            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // Find and activate the clicked button
            if (tab === 'today') document.getElementById('todayTab').classList.add('active');
            else if (tab === 'overall') document.getElementById('overallTab').classList.add('active');
            else if (tab === 'working') document.getElementById('workingTab').classList.add('active');
            else if (tab === 'device') document.getElementById('deviceTab').classList.add('active');

            // Update tab content visibility
            document.getElementById('todayTabContent').style.display = 'none';
            document.getElementById('overallTabContent').style.display = 'none';
            document.getElementById('workingTabContent').style.display = 'none';
            document.getElementById('deviceTabContent').style.display = 'none';

            if (tab === 'today') {
                document.getElementById('todayTabContent').style.display = 'block';
                renderTodayView();
            } else if (tab === 'overall') {
                document.getElementById('overallTabContent').style.display = 'block';
            } else if (tab === 'working') {
                document.getElementById('workingTabContent').style.display = 'block';
                renderWorkingView();
            } else if (tab === 'device') {
                document.getElementById('deviceTabContent').style.display = 'block';
                renderDeviceView();
            }
        }

        // ROLE CHANGE HANDLER
        function handleRoleChange() {
            currentRole = document.getElementById('roleSelector').value;
            // Re-render today's view if active
            if (document.getElementById('todayTabContent').style.display === 'block') {
                renderTodayView();
            }
            // Re-render working view if active
            if (document.getElementById('workingTabContent').style.display === 'block') {
                renderWorkingView();
            }
            // Re-render overall journey if active
            if (document.getElementById('overallTabContent').style.display === 'block') {
                renderAssessments();
            }
        }

        // GET ROLE PERMISSIONS
        function getRolePermissions(role) {
            const permissions = {
                'patient': {
                    canViewReports: true,
                    canEditData: false,
                    canViewScores: true,
                    showPendingItems: true,
                    label: 'Patient View'
                },
                'doctor': {
                    canViewReports: true,
                    canEditData: true,
                    canViewScores: true,
                    showPendingItems: false,
                    label: 'Doctor View'
                },
                'clinical-assistant': {
                    canViewReports: true,
                    canEditData: true,
                    canViewScores: true,
                    showPendingItems: false,
                    label: 'Clinical Assistant View'
                },
                'receptionist': {
                    canViewReports: false,
                    canEditData: false,
                    canViewScores: false,
                    showPendingItems: false,
                    label: 'Receptionist View'
                }
            };
            return permissions[role];
        }

        // RENDER TODAY'S JOURNEY VIEW
        function renderTodayView() {
            const container = document.getElementById('todayContent');
            const permissions = getRolePermissions(currentRole);
            container.innerHTML = '';

            // Get active assessment (Assessment 2)
            const activeAssessment = patientState.clinicalAssessments.find(a => a.status === 'active');
            
            if (!activeAssessment) {
                container.innerHTML = '<p style="text-align: center; color: #64748b; padding: 40px;">No active sessions today.</p>';
                return;
            }

            // Add Today's Assessment Header
            const headerDiv = document.createElement('div');
            headerDiv.style.cssText = 'margin-bottom: 24px;';
            headerDiv.innerHTML = `
                <h3 style="font-size: 20px; font-weight: 700; color: #0f172a; margin-bottom: 8px;">
                    <i class="fa-solid fa-calendar-day" style="color: #10b981;"></i> Today's Active Assessment
                </h3>
                <p style="font-size: 14px; color: #64748b;">Clinical Assessment ${activeAssessment.number} - Started ${activeAssessment.startDate}</p>
            `;
            container.appendChild(headerDiv);

            // Create blocks grid (reuse same design)
            const blocksGrid = document.createElement('div');
            blocksGrid.className = 'blocks-container';

            // Show ALL Blocks (complete flow)
            const activeBlocks = activeAssessment.blocks;
            
            activeBlocks.forEach(block => {
                const blockDiv = document.createElement('div');
                blockDiv.className = `block-card ${block.type} ${block.status}`;
                
                let statusIcon, statusText;
                if (block.status === 'completed') {
                    statusIcon = '✓';
                    statusText = 'Done';
                } else if (block.status === 'active') {
                    statusIcon = '●';
                    statusText = 'Active';
                } else if (block.status === 'pending') {
                    statusIcon = '○';
                    statusText = 'Pending';
                } else {
                    statusIcon = '🔒';
                    statusText = 'Locked';
                }

                // Build expanded details based on role and block type
                let expandedDetailsHTML = '';
                
                if (permissions.canViewScores || permissions.canViewReports || permissions.canEditData) {
                    let detailsContent = '';
                    
                    if (block.status === 'completed') {
                        if (block.type === 'fnon' && permissions.canViewScores) {
                            const fnonScore = calculatePatientFnonScore(activeAssessment.number);
                            const currentPatientId = selectedPatientData?.id || 'P001';
                            const improvement = patientImprovements[currentPatientId] || '+0%';
                            detailsContent = `
                                <div class="block-info-grid">
                                    <div class="block-info-item">
                                        <div class="block-info-label">FNON Score</div>
                                        <div class="block-info-value">${fnonScore}/30</div>
                                    </div>
                                    <div class="block-info-item">
                                        <div class="block-info-label">Improvement</div>
                                        <div class="block-info-value" style="color: var(--green-primary);">${improvement}</div>
                                    </div>
                                    <div class="block-info-item">
                                        <div class="block-info-label">Duration</div>
                                        <div class="block-info-value" style="font-size: 12px;">45 min</div>
                                    </div>
                                    <div class="block-info-item">
                                        <div class="block-info-label">Completed By</div>
                                        <div class="block-info-value" style="font-size: 12px;">${block.completedBy}</div>
                                    </div>
                                </div>
                                <div class="detail-section">
                                    <div class="detail-section-title">Activities Performed</div>
                                    <div class="activity-tags">
                                        <span class="activity-tag">
                                            Crossword
                                            <img src="crossword.avif" alt="Crossword" class="activity-tag-image">
                                        </span>
                                        <span class="activity-tag">
                                            Toe Touch
                                            <img src="exercise.png" alt="Toe Touch" class="activity-tag-image">
                                        </span>
                                        <span class="activity-tag">
                                            Walking
                                            <img src="walking.jpeg" alt="Walking" class="activity-tag-image">
                                        </span>
                                        <span class="activity-tag">
                                            Sudoku
                                            <img src="sudoku.jpg" alt="Sudoku" class="activity-tag-image">
                                        </span>
                                        <span class="activity-tag">
                                            Balance Test
                                            <img src="balance.jpeg" alt="Balance Test" class="activity-tag-image">
                                        </span>
                                    </div>
                                </div>
                            `;
                            if (permissions.canViewReports || permissions.canEditData) {
                                detailsContent += '<div class="block-action-buttons">';
                                if (permissions.canViewReports) {
                                    detailsContent += '<button class="block-action-btn view" onclick="viewBlockDetails(\'fnon\')" title="View detailed FNON report"><i class="fa-solid fa-eye"></i> View Details</button>';
                                }
                                if (permissions.canEditData) {
                                    detailsContent += '<button class="block-action-btn edit" onclick="editBlockDetails(\'fnon\')" title="Edit FNON assessment data"><i class="fa-solid fa-pen"></i> Edit Details</button>';
                                }
                                detailsContent += '</div>';
                            }
                        } else if (block.type === 'brain-mapping' && permissions.canViewScores) {
                            const currentPatientId = selectedPatientData?.id || 'P001';
                            const brainData = getPatientBrainMappingData(currentPatientId, activeAssessment.number);
                            detailsContent = `
                                <div class="block-info-grid">
                                    <div class="block-info-item">
                                        <div class="block-info-label">Dominant Frequency</div>
                                        <div class="block-info-value">${brainData.dominantFrequency}</div>
                                    </div>
                                    <div class="block-info-item">
                                        <div class="block-info-label">Alpha Activity</div>
                                        <div class="block-info-value">${brainData.alphaActivity}</div>
                                    </div>
                                    <div class="block-info-item">
                                        <div class="block-info-label">Asymmetry</div>
                                        <div class="block-info-value">${brainData.asymmetry}</div>
                                    </div>
                                    <div class="block-info-item">
                                        <div class="block-info-label">Completed By</div>
                                        <div class="block-info-value" style="font-size: 12px;">${block.completedBy}</div>
                                    </div>
                                </div>
                            `;
                            if (permissions.canViewReports || (currentRole === 'doctor' && permissions.canEditData)) {
                                detailsContent += '<div class="block-action-buttons">';
                                if (permissions.canViewReports) {
                                    detailsContent += '<button class="block-action-btn view" onclick="viewBlockDetails(\'brain-mapping\')" title="View EEG data and analysis"><i class="fa-solid fa-eye"></i> View Details</button>';
                                }
                                if (currentRole === 'doctor') {
                                    detailsContent += '<button class="block-action-btn edit" onclick="editBlockDetails(\'brain-mapping\')" title="Edit EEG analysis (Doctor only)"><i class="fa-solid fa-pen"></i> Edit Details</button>';
                                } else if (currentRole === 'clinical-assistant') {
                                    detailsContent += '<button class="block-action-btn disabled" title="Only doctors can edit EEG data"><i class="fa-solid fa-lock"></i> Edit Restricted</button>';
                                }
                                detailsContent += '</div>';
                            }
                        } else if (permissions.canViewScores) {
                            detailsContent = `
                                <div class="block-info-grid">
                                    <div class="block-info-item">
                                        <div class="block-info-label">Status</div>
                                        <div class="block-info-value" style="font-size: 12px;">Completed</div>
                                    </div>
                                    <div class="block-info-item">
                                        <div class="block-info-label">Completed By</div>
                                        <div class="block-info-value" style="font-size: 12px;">${block.completedBy}</div>
                                    </div>
                                    <div class="block-info-item">
                                        <div class="block-info-label">Date</div>
                                        <div class="block-info-value" style="font-size: 12px;">${block.completedAt}</div>
                                    </div>
                                </div>
                            `;
                            if (permissions.canViewReports || permissions.canEditData) {
                                detailsContent += '<div class="block-action-buttons">';
                                if (permissions.canViewReports) {
                                    detailsContent += '<button class="block-action-btn view" onclick="viewBlockDetails(\''+block.type+'\', '+activeAssessment.number+')" title="View detailed report"><i class="fa-solid fa-eye"></i> View Details</button>';
                                }
                                if (permissions.canEditData) {
                                    detailsContent += '<button class="block-action-btn edit" onclick="editBlockDetails(\''+block.type+'\')" title="Edit assessment data"><i class="fa-solid fa-pen"></i> Edit Details</button>';
                                }
                                detailsContent += '</div>';
                            }
                        } else if (block.type === 'prs' && permissions.canViewScores) {
                            const currentPatientId = selectedPatientData?.id || 'P001';
                            const prsData = getPatientPRSData(currentPatientId, activeAssessment.number);
                            detailsContent = `
                                <div class="block-info-grid">
                                    <div class="block-info-item">
                                        <div class="block-info-label">Overall Score</div>
                                        <div class="block-info-value">${prsData.overallScore}</div>
                                    </div>
                                    <div class="block-info-item">
                                        <div class="block-info-label">Severity</div>
                                        <div class="block-info-value" style="font-size: 12px;">${prsData.severity}</div>
                                    </div>
                                    <div class="block-info-item">
                                        <div class="block-info-label">Date</div>
                                        <div class="block-info-value" style="font-size: 12px;">${block.completedAt}</div>
                                    </div>
                                    <div class="block-info-item">
                                        <div class="block-info-label">Completed By</div>
                                        <div class="block-info-value" style="font-size: 12px;">${block.completedBy}</div>
                                    </div>
                                </div>
                            `;
                            if (permissions.canViewReports || permissions.canEditData) {
                                detailsContent += '<div class="block-action-buttons">';
                                if (permissions.canViewReports) {
                                    detailsContent += '<button class="block-action-btn view" onclick="viewBlockDetails(\'prs\', '+activeAssessment.number+')" title="View PRS details"><i class="fa-solid fa-eye"></i> View Details</button>';
                                }
                                if (permissions.canEditData) {
                                    detailsContent += '<button class="block-action-btn edit" onclick="editBlockDetails(\'prs\')" title="Edit PRS data"><i class="fa-solid fa-pen"></i> Edit Details</button>';
                                }
                                detailsContent += '</div>';
                            }
                        } else if (permissions.canViewScores) {
                            detailsContent = `
                                <div class="block-info-grid">
                                    <div class="block-info-item">
                                        <div class="block-info-label">Status</div>
                                        <div class="block-info-value" style="font-size: 12px;">Completed</div>
                                    </div>
                                    <div class="block-info-item">
                                        <div class="block-info-label">Completed By</div>
                                        <div class="block-info-value" style="font-size: 12px;">${block.completedBy}</div>
                                    </div>
                                    <div class="block-info-item">
                                        <div class="block-info-label">Date</div>
                                        <div class="block-info-value" style="font-size: 12px;">${block.completedAt}</div>
                                    </div>
                                </div>
                            `;
                            if (permissions.canViewReports || permissions.canEditData) {
                                detailsContent += '<div class="block-action-buttons">';
                                if (permissions.canViewReports) {
                                    detailsContent += '<button class="block-action-btn view" onclick="viewBlockDetails(\''+block.type+'\', '+activeAssessment.number+')" title="View detailed report"><i class="fa-solid fa-eye"></i> View Details</button>';
                                }
                                if (permissions.canEditData) {
                                    detailsContent += '<button class="block-action-btn edit" onclick="editBlockDetails(\''+block.type+'\')" title="Edit assessment data"><i class="fa-solid fa-pen"></i> Edit Details</button>';
                                }
                                detailsContent += '</div>';
                            }
                        }
                    } else if (block.status === 'active') {
                        if (block.type === 'prs') {
                            detailsContent = `
                                <div class="block-info-grid">
                                    <div class="block-info-item">
                                        <div class="block-info-label">Progress</div>
                                        <div class="block-info-value">${block.currentProgress || 40}%</div>
                                    </div>
                                    <div class="block-info-item">
                                        <div class="block-info-label">Diseases Assessed</div>
                                        <div class="block-info-value" style="font-size: 11px;">Parkinson's</div>
                                    </div>
                                    <div class="block-info-item">
                                        <div class="block-info-label">Assigned To</div>
                                        <div class="block-info-value" style="font-size: 12px;">${block.performer}</div>
                                    </div>
                                    <div class="block-info-item">
                                        <div class="block-info-label">Started</div>
                                        <div class="block-info-value" style="font-size: 12px;">${block.startedAt}</div>
                                    </div>
                                </div>
                                <div class="detail-section">
                                    <div class="detail-section-title">Current Scores</div>
                                    <div class="block-info-grid">
                                        <div class="block-info-item">
                                            <div class="block-info-label">Tremor</div>
                                            <div class="block-info-value" style="font-size: 12px;">Moderate</div>
                                        </div>
                                        <div class="block-info-item">
                                            <div class="block-info-label">Rigidity</div>
                                            <div class="block-info-value" style="font-size: 12px;">Mild</div>
                                        </div>
                                        <div class="block-info-item">
                                            <div class="block-info-label">Bradykinesia</div>
                                            <div class="block-info-value" style="font-size: 12px;">Moderate</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                            if (permissions.canViewReports || permissions.canEditData) {
                                detailsContent += '<div class="block-action-buttons">';
                                if (permissions.canViewReports) {
                                    detailsContent += '<button class="block-action-btn view" onclick="viewBlockDetails(\'prs\')" title="View current PRS assessment"><i class="fa-solid fa-eye"></i> View Details</button>';
                                }
                                if (permissions.canEditData) {
                                    detailsContent += '<button class="block-action-btn edit" onclick="continueBlock(\''+block.id+'\')" title="Continue PRS assessment"><i class="fa-solid fa-play"></i> Continue Assessment</button>';
                                }
                                detailsContent += '</div>';
                            }
                        } else {
                            detailsContent = `
                                <div class="block-info-grid">
                                    <div class="block-info-item">
                                        <div class="block-info-label">Assigned To</div>
                                        <div class="block-info-value" style="font-size: 12px;">${block.performer || 'Not assigned'}</div>
                                    </div>
                                    <div class="block-info-item">
                                        <div class="block-info-label">Started</div>
                                        <div class="block-info-value" style="font-size: 12px;">${block.startedAt || 'Today'}</div>
                                    </div>
                                </div>
                            `;
                            if (permissions.canEditData) {
                                detailsContent += '<button class="action-button primary" style="margin-top: 12px; width: 100%;" onclick="continueBlock(\''+block.id+'\')"><i class="fa-solid fa-play"></i> Continue</button>';
                            }
                        }
                    } else if (block.status === 'pending' && permissions.showPendingItems) {
                        detailsContent = `
                            <div style="text-align: center; padding: 16px; color: #64748b;">
                                <i class="fa-solid fa-clock" style="font-size: 24px; margin-bottom: 8px; display: block;"></i>
                                <p style="font-size: 13px; margin: 0;">Waiting for previous steps</p>
                            </div>
                        `;
                    }

                    if (detailsContent) {
                        expandedDetailsHTML = `<div class="block-expanded-details">${detailsContent}</div>`;
                    }
                }

                blockDiv.innerHTML = `
                    <div class="block-status">
                        <span class="block-status-icon">${statusIcon}</span>
                        <span class="block-status-text">${statusText}</span>
                    </div>
                    <div class="block-icon">
                        <i class="fa-solid ${iconMap[block.type] || 'fa-circle'}"></i>
                    </div>
                    <div class="block-name">${block.name}</div>
                    <div class="block-desc">${block.desc}</div>
                    ${expandedDetailsHTML}
                    ${expandedDetailsHTML ? '<div class="accordion-indicator"><i class="fa-solid fa-chevron-down"></i></div>' : ''}
                `;

                // Add click handler if there are details to show
                if (expandedDetailsHTML && (permissions.canViewScores || permissions.canViewReports || permissions.canEditData)) {
                    blockDiv.style.cursor = 'pointer';
                    blockDiv.onclick = function(event) {
                        // Don't toggle if clicking on a button or link
                        if (event.target.tagName === 'BUTTON' || event.target.closest('button') || event.target.closest('.block-action-btn')) {
                            return;
                        }
                        this.classList.toggle('expanded');
                    };
                }

                blocksGrid.appendChild(blockDiv);
            });

            container.appendChild(blocksGrid);

            // ADD NEW PATIENT - PAYMENT COMPLETED STATE
            const paidSeparatorDiv = document.createElement('div');
            paidSeparatorDiv.style.cssText = 'margin: 80px 0 40px 0; border-top: 3px solid #cbd5e1; padding-top: 40px;';
            container.appendChild(paidSeparatorDiv);

            const paidHeader = document.createElement('div');
            paidHeader.style.cssText = 'margin-bottom: 24px;';
            paidHeader.innerHTML = `
                <h3 style="font-size: 20px; font-weight: 700; color: #0f172a; margin-bottom: 8px;">New Patient - Payment Completed (\u20ac300)</h3>
                <p style="font-size: 14px; color: #64748b;">All initial assessments ready to start</p>
            `;
            container.appendChild(paidHeader);

            const paidBlocksGrid = document.createElement('div');
            paidBlocksGrid.className = 'blocks-container';

            const paidBlocks = [
                { id: 'fnon-paid', name: 'FNON', desc: 'Network Analysis', type: 'fnon', status: 'pending', canStart: currentRole === 'clinical-assistant' },
                { id: 'eeg-paid', name: 'Brain Mapping', desc: 'EEG Imaging', type: 'brain-mapping', status: 'ready', requiresUnlock: true, canStart: currentRole === 'doctor' || currentRole === 'clinical-assistant' },
                { id: 'prs-paid', name: 'PRS', desc: 'Symptoms', type: 'prs', status: 'pending', canStart: currentRole === 'doctor' || currentRole === 'clinical-assistant' },
                { id: 'ana-paid', name: "Doctor's Notes", desc: 'Clinical Notes', type: 'doctor-notes', status: 'pending', canStart: currentRole === 'doctor' },
                { id: 'treatment-paid', name: 'Treatment Plan', desc: 'Therapy Design', type: 'treatment-plan', status: 'pending', canStart: currentRole === 'doctor' },
                { id: 'report-paid', name: 'Final Report', desc: 'Comprehensive', type: 'final-report', status: 'pending', canStart: currentRole === 'doctor' }
            ];

            paidBlocks.forEach(block => {
                const blockDiv = document.createElement('div');
                blockDiv.className = `block-card ${block.type} ${block.status === 'ready' ? 'can-start' : 'pending'}`;

                let expandedDetailsHTML = '';
                if (permissions.canViewScores || permissions.canEditData) {
                    let detailsContent = '';
                    
                    // Build info grid based on block type
                    if (block.type === 'brain-mapping' && block.requiresUnlock) {
                        // EEG with device unlock
                        detailsContent = `
                            <div class="block-info-grid">
                                <div class="block-info-item">
                                    <div class="block-info-label">Device</div>
                                    <div class="block-info-value" style="font-size: 12px;">EEG Headset</div>
                                </div>
                                <div class="block-info-item">
                                    <div class="block-info-label">Status</div>
                                    <div class="block-info-value" style="font-size: 12px; color: #10b981;">Payment Confirmed</div>
                                </div>
                            </div>
                            <div class="payment-success" style="margin-top: 12px;">
                                <i class="fa-solid fa-circle-check"></i>
                                <span>Device ready for use</span>
                            </div>
                        `;
                        
                        if (block.canStart && permissions.canEditData) {
                            detailsContent += `
                                <div class="block-actions" style="margin-top: 12px;">
                                    <button class="start-button primary" onclick="startDeviceAssessment('brain-mapping')">
                                        <i class="fa-solid fa-unlock"></i>
                                        Unlock & Start Device
                                    </button>
                                </div>
                            `;
                        } else if (currentRole === 'clinical-assistant') {
                            detailsContent += `
                                <div class="block-actions tooltip" style="margin-top: 12px;">
                                    <button class="start-button disabled">
                                        <i class="fa-solid fa-lock"></i>
                                        Restricted
                                    </button>
                                    <span class="tooltip-text">Only doctors can perform this assessment</span>
                                </div>
                            `;
                        } else if (currentRole === 'receptionist') {
                            detailsContent += `
                                <div class="block-actions" style="margin-top: 12px;">
                                    <button class="start-button view-only">
                                        <i class="fa-solid fa-check-circle"></i>
                                        Payment Confirmed
                                    </button>
                                </div>
                            `;
                        } else if (currentRole === 'patient') {
                            detailsContent += `
                                <div class="block-actions" style="margin-top: 12px;">
                                    <button class="start-button view-only">
                                        <i class="fa-solid fa-eye"></i>
                                        View Information
                                    </button>
                                </div>
                            `;
                        }
                    } else {
                        // Regular assessments (PRS, FNON, Doctor's Notes, Treatment Plan, Final Report)
                        detailsContent = `
                            <div class="block-info-grid">
                                <div class="block-info-item">
                                    <div class="block-info-label">Status</div>
                                    <div class="block-info-value" style="font-size: 12px;">Ready to Start</div>
                                </div>
                                <div class="block-info-item">
                                    <div class="block-info-label">Payment</div>
                                    <div class="block-info-value" style="font-size: 12px; color: #10b981;">Confirmed</div>
                                </div>
                            </div>
                        `;
                        
                        if (block.canStart && permissions.canEditData) {
                            detailsContent += `
                                <div class="block-actions" style="margin-top: 12px;">
                                    <button class="start-button primary" onclick="startNewPatientAssessment('${block.id}', '${block.name}')">
                                        <i class="fa-solid fa-play"></i>
                                        Start ${block.type === 'doctor-notes' ? 'Notes' : block.type === 'treatment-plan' ? 'Planning' : block.type === 'final-report' ? 'Report' : 'Assessment'}
                                    </button>
                                </div>
                            `;
                        } else if (permissions.canViewScores) {
                            const waitingFor = block.type === 'fnon' ? 'clinical assistant' : 'doctor';
                            detailsContent += '<div style="text-align: center; padding: 12px; background: #f8fafc; border-radius: 6px; margin-top: 12px;"><span style="font-size: 12px; color: #64748b;">Waiting for ' + waitingFor + '</span></div>';
                        }
                    }
                    
                    expandedDetailsHTML = `<div class="block-expanded-details">${detailsContent}</div>`;
                }

                let statusIcon = block.status === 'ready' ? '✓' : '○';
                let statusText = block.status === 'ready' ? 'Ready' : 'Pending';

                blockDiv.innerHTML = `
                    <div class="block-status ${block.status === 'ready' ? 'ready' : ''}">
                        <span class="block-status-icon">${statusIcon}</span>
                        <span class="block-status-text">${statusText}</span>
                    </div>
                    <div class="block-icon">
                        <i class="fa-solid ${iconMap[block.type] || 'fa-circle'}"></i>
                    </div>
                    <div class="block-name">${block.name}</div>
                    <div class="block-desc">${block.desc}</div>
                    ${expandedDetailsHTML}
                    ${expandedDetailsHTML ? '<div class="accordion-indicator"><i class="fa-solid fa-chevron-down"></i></div>' : ''}
                `;

                if (expandedDetailsHTML) {
                    blockDiv.style.cursor = 'pointer';
                    blockDiv.onclick = function(event) {
                        if (event.target.tagName === 'BUTTON' || event.target.closest('button')) return;
                        this.classList.toggle('expanded');
                    };
                }

                paidBlocksGrid.appendChild(blockDiv);
            });

            container.appendChild(paidBlocksGrid);

            // ADD NEW PATIENT - PAY LATER STATE
            const laterSeparatorDiv = document.createElement('div');
            laterSeparatorDiv.style.cssText = 'margin: 80px 0 40px 0; border-top: 3px solid #cbd5e1; padding-top: 40px;';
            container.appendChild(laterSeparatorDiv);

            const laterHeader = document.createElement('div');
            laterHeader.style.cssText = 'margin-bottom: 24px;';
            laterHeader.innerHTML = `
                <h3 style="font-size: 20px; font-weight: 700; color: #0f172a; margin-bottom: 8px;">New Patient - Pay Later (Pending \u20ac300)</h3>
                <p style="font-size: 14px; color: #64748b;">Limited assessments available until payment</p>
            `;
            container.appendChild(laterHeader);

            const laterBlocksGrid = document.createElement('div');
            laterBlocksGrid.className = 'blocks-container';

            const laterBlocks = [
                { id: 'fnon-later', name: 'FNON', desc: 'Network Analysis', type: 'fnon', status: 'pending', canStart: currentRole === 'clinical-assistant' },
                { id: 'eeg-later', name: 'Brain Mapping', desc: 'EEG Imaging', type: 'brain-mapping', status: 'locked', requiresUnlock: true, canStart: false },
                { id: 'prs-later', name: 'PRS', desc: 'Symptoms', type: 'prs', status: 'locked', canStart: false },
                { id: 'ana-later', name: "Doctor's Notes", desc: 'Clinical Notes', type: 'doctor-notes', status: 'locked', canStart: false },
                { id: 'treatment-later', name: 'Treatment Plan', desc: 'Therapy Design', type: 'treatment-plan', status: 'locked', canStart: false },
                { id: 'report-later', name: 'Final Report', desc: 'Comprehensive', type: 'final-report', status: 'locked', canStart: false }
            ];

            laterBlocks.forEach(block => {
                const blockDiv = document.createElement('div');
                blockDiv.className = `block-card ${block.type} ${block.status}`;

                let expandedDetailsHTML = '';
                if (permissions.canViewScores || permissions.canEditData) {
                    let detailsContent = '';
                    
                    if (block.status === 'locked') {
                        // Locked blocks - different content for EEG vs others
                        if (block.type === 'brain-mapping' && block.requiresUnlock) {
                            // EEG device locked
                            detailsContent = `
                                <div class="block-info-grid">
                                    <div class="block-info-item">
                                        <div class="block-info-label">Device</div>
                                        <div class="block-info-value" style="font-size: 12px;">EEG Headset</div>
                                    </div>
                                    <div class="block-info-item">
                                        <div class="block-info-label">Payment</div>
                                        <div class="block-info-value" style="font-size: 12px; color: #f59e0b;">Pending</div>
                                    </div>
                                </div>
                                <div class="payment-warning" style="margin-top: 12px;">
                                    <i class="fa-solid fa-exclamation-triangle"></i>
                                    <span>Device activation requires payment</span>
                                </div>
                                <div class="block-actions" style="margin-top: 12px;">
                                    <button class="start-button disabled">
                                        <i class="fa-solid fa-lock"></i>
                                        Device Locked - Payment Required
                                    </button>
                                </div>
                            `;
                        } else {
                            // Regular locked assessment (PRS)
                            detailsContent = `
                                <div class="block-info-grid">
                                    <div class="block-info-item">
                                        <div class="block-info-label">Status</div>
                                        <div class="block-info-value" style="font-size: 12px;">Locked</div>
                                    </div>
                                    <div class="block-info-item">
                                        <div class="block-info-label">Payment</div>
                                        <div class="block-info-value" style="font-size: 12px; color: #f59e0b;">Pending</div>
                                    </div>
                                </div>
                                <div style="text-align: center; padding: 12px; background: #f8fafc; border-radius: 6px; margin-top: 12px;">
                                    <span style="font-size: 12px; color: #64748b;">Payment required to unlock</span>
                                </div>
                            `;
                        }
                    } else {
                        // FNON - ready to start (only unlocked item in pay-later flow)
                        detailsContent = `
                            <div class="block-info-grid">
                                <div class="block-info-item">
                                    <div class="block-info-label">Status</div>
                                    <div class="block-info-value" style="font-size: 12px;">Ready to Start</div>
                                </div>
                                <div class="block-info-item">
                                    <div class="block-info-label">Payment</div>
                                    <div class="block-info-value" style="font-size: 12px; color: #f59e0b;">Pending</div>
                                </div>
                            </div>
                        `;
                        
                        if (block.canStart && permissions.canEditData) {
                            detailsContent += `
                                <div class="block-actions" style="margin-top: 12px;">
                                    <button class="start-button primary" onclick="startNewPatientAssessment('${block.id}', '${block.name}')">
                                        <i class="fa-solid fa-play"></i>
                                        Start Assessment
                                    </button>
                                </div>
                            `;
                        } else if (permissions.canViewScores) {
                            detailsContent += '<div style="text-align: center; padding: 12px; background: #f8fafc; border-radius: 6px; margin-top: 12px;"><span style="font-size: 12px; color: #64748b;">Waiting for clinical assistant</span></div>';
                        }
                    }
                    
                    expandedDetailsHTML = `<div class="block-expanded-details">${detailsContent}</div>`;
                }

                let statusIcon = block.status === 'locked' ? '🔒' : '○';
                let statusText = block.status === 'locked' ? 'Locked' : 'Pending';

                blockDiv.innerHTML = `
                    <div class="block-status ${block.status === 'locked' ? 'locked' : ''}">
                        <span class="block-status-icon">${statusIcon}</span>
                        <span class="block-status-text">${statusText}</span>
                    </div>
                    <div class="block-icon">
                        <i class="fa-solid ${iconMap[block.type] || 'fa-circle'}"></i>
                    </div>
                    <div class="block-name">${block.name}</div>
                    <div class="block-desc">${block.desc}</div>
                    ${expandedDetailsHTML}
                    ${expandedDetailsHTML ? '<div class="accordion-indicator"><i class="fa-solid fa-chevron-down"></i></div>' : ''}
                `;

                if (expandedDetailsHTML) {
                    blockDiv.style.cursor = 'pointer';
                    blockDiv.onclick = function(event) {
                        if (event.target.tagName === 'BUTTON' || event.target.closest('button')) return;
                        this.classList.toggle('expanded');
                    };
                }

                laterBlocksGrid.appendChild(blockDiv);
            });

            container.appendChild(laterBlocksGrid);


            // ADD SESSION ACTIVATION WIREFRAME
            const sessionSeparatorDiv = document.createElement('div');
            sessionSeparatorDiv.style.cssText = 'margin: 80px 0 40px 0; border-top: 3px solid #cbd5e1; padding-top: 40px;';
            container.appendChild(sessionSeparatorDiv);

            const sessionWireframeHeader = document.createElement('div');
            sessionWireframeHeader.style.cssText = 'margin-bottom: 24px;';
            sessionWireframeHeader.innerHTML = `
                <h3 style="font-size: 20px; font-weight: 700; color: #0f172a; margin-bottom: 8px;">Session Activation Flow - Wireframe</h3>
                <p style="font-size: 14px; color: #64748b;">Complete consent and payment (\u20ac100) to activate treatment session</p>
            `;
            container.appendChild(sessionWireframeHeader);

            // Session wireframe showing all 5 sessions
            const sessionWireframeGrid = document.createElement('div');
            sessionWireframeGrid.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; position: relative; overflow: visible;';

            // Define all 5 sessions for wireframe
            const wireframeSessions = [
                { number: 1, status: 'completed', time: '09:30 AM' },
                { number: 2, status: 'completed', time: '11:45 AM' },
                { number: 3, status: 'active', time: '02:15 PM' },
                { number: 4, status: 'pending', time: '04:00 PM' },
                { number: 5, status: 'locked', prerequisite: 'Complete Session 4' }
            ];

            wireframeSessions.forEach(sess => {
                const sessDiv = document.createElement('div');
                sessDiv.style.cssText = 'background: white; border-radius: 12px; border: 1px solid #e2e8f0; padding: 16px; display: flex; flex-direction: column; align-items: center; text-align: center; cursor: pointer; transition: all 0.3s ease; position: relative; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); overflow: visible;';

                let statusIcon, statusText, statusColor, borderColor;
                if (sess.status === 'completed') {
                    statusIcon = '✓';
                    statusText = 'Completed';
                    statusColor = '#10b981';
                    borderColor = '#10b981';
                } else if (sess.status === 'active') {
                    statusIcon = '●';
                    statusText = 'Active Now';
                    statusColor = '#f59e0b';
                    borderColor = '#f59e0b';
                } else if (sess.status === 'pending') {
                    statusIcon = '○';
                    statusText = 'Scheduled';
                    statusColor = '#3b82f6';
                    borderColor = '#3b82f6';
                } else {
                    statusIcon = '🔒';
                    statusText = 'Locked';
                    statusColor = '#94a3b8';
                    borderColor = '#cbd5e1';
                }

                // Top border
                sessDiv.innerHTML = `<div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: ${borderColor}; border-radius: 12px 12px 0 0;"></div>`;

                // Status badge
                sessDiv.innerHTML += `
                    <div style="position: absolute; top: 12px; right: 12px; padding: 4px 10px; border-radius: 12px; display: flex; align-items: center; gap: 4px; font-size: 11px; font-weight: 700; background: white; border: 1.5px solid ${borderColor}; color: ${statusColor};">
                        <span style="font-size: 12px;">${statusIcon}</span>
                        <span>${statusText}</span>
                    </div>
                `;

                // Icon
                sessDiv.innerHTML += `
                    <div style="width: 64px; height: 64px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; margin-bottom: 12px; background: ${sess.status === 'completed' ? 'rgba(16, 185, 129, 0.15)' : sess.status === 'active' ? 'rgba(245, 158, 11, 0.15)' : sess.status === 'pending' ? 'rgba(59, 130, 246, 0.15)' : 'rgba(203, 213, 225, 0.3)'}; color: ${statusColor};">
                        <i class="fa-solid fa-dumbbell"></i>
                    </div>
                `;

                // Session name
                sessDiv.innerHTML += `<div style="font-size: 14px; font-weight: 700; color: #0f172a; margin-bottom: 4px;">Session ${sess.number}</div>`;

                // Time or prerequisite
                if (sess.status === 'locked') {
                    sessDiv.innerHTML += `<div style="font-size: 11px; color: #94a3b8; margin-bottom: 8px;">${sess.prerequisite}</div>`;
                } else {
                    sessDiv.innerHTML += `<div style="font-size: 12px; color: #64748b; margin-bottom: 8px;">${sess.time}</div>`;
                }

                // Expanded details based on status
                let expandedContent = '';
                
                if (sess.status === 'completed') {
                    expandedContent = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; background: #f8fafc; padding: 12px; border-radius: 8px; margin-top: 12px; width: 100%; font-size: 11px;">
                            <div>
                                <div style="color: #64748b; margin-bottom: 2px;">Payment</div>
                                <div style="font-weight: 700; color: #10b981;">\u20ac100 Paid</div>
                            </div>
                            <div>
                                <div style="color: #64748b; margin-bottom: 2px;">Duration</div>
                                <div style="font-weight: 700; color: #0f172a;">25 min</div>
                            </div>
                        </div>
                    `;
                } else if (sess.status === 'active') {
                    // Only doctors and clinical assistants can start treatment
                    const canStartTreatment = currentRole === 'doctor' || currentRole === 'clinical-assistant';
                    
                    expandedContent = `
                        <div style="background: #f8fafc; padding: 12px; border-radius: 8px; margin-top: 12px; width: 100%;">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 6px; margin-bottom: 8px;">
                                <i class="fa-solid fa-circle-check" style="color: #10b981;"></i>
                                <span style="font-size: 11px; font-weight: 600; color: #0f172a;">Payment Confirmed</span>
                            </div>
                            <div style="font-size: 11px; color: #64748b; text-align: center; margin-bottom: 8px;">\u20ac100 • Paid</div>
                            ${canStartTreatment ? `
                            <button class="action-button primary" style="width: 100%; font-size: 11px; padding: 8px;" onclick="alert('Start Treatment:\\n\\nSession 3 Active\\nDevice ready for treatment\\nProceeding to interface...')">
                                <i class="fa-solid fa-play"></i> Start Treatment
                            </button>
                            ` : `
                            <div style="background: #e0f2fe; border: 1px solid #0ea5e9; border-radius: 8px; padding: 8px; text-align: center; font-size: 11px; color: #0369a1;">
                                <i class="fa-solid fa-info-circle"></i> ${currentRole === 'patient' ? 'Treatment will be started by clinic staff' : 'Only doctor or clinical assistant can start treatment'}
                            </div>
                            `}
                        </div>
                    `;
                } else if (sess.status === 'pending') {
                    // Only doctors and clinical assistants can activate sessions
                    const canActivateSession = currentRole === 'doctor' || currentRole === 'clinical-assistant';
                    
                    expandedContent = `
                        <div style="background: #f8fafc; padding: 12px; border-radius: 8px; margin-top: 12px; width: 100%;">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 6px; margin-bottom: 8px;">
                                <i class="fa-solid fa-info-circle" style="color: #3b82f6;"></i>
                                <span style="font-size: 11px; font-weight: 600; color: #1e40af;">Activation Required</span>
                            </div>
                            <div style="font-size: 11px; color: #64748b; text-align: center; margin-bottom: 8px;">\u20ac100 per session</div>
                            ${canActivateSession ? `
                            <button class="action-button primary" style="width: 100%; font-size: 11px; padding: 8px;" onclick="activateSessionWithFlow('sess-4')">
                                <i class="fa-solid fa-play"></i> Activate Session
                            </button>
                            ` : `
                            <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 8px; text-align: center; font-size: 11px; color: #92400e;">
                                <i class="fa-solid fa-lock"></i> ${currentRole === 'patient' ? 'Session will be activated by clinic staff' : 'Only doctor or clinical assistant can activate'}
                            </div>
                            `}
                        </div>
                    `;
                } else if (sess.status === 'locked') {
                    expandedContent = `
                        <div style="background: #f8fafc; padding: 12px; border-radius: 8px; margin-top: 12px; width: 100%;">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 6px; margin-bottom: 8px;">
                                <i class="fa-solid fa-lock" style="color: #94a3b8;"></i>
                                <span style="font-size: 11px; font-weight: 600; color: #64748b;">Locked</span>
                            </div>
                            <div style="font-size: 11px; color: #94a3b8; text-align: center;">${sess.prerequisite}</div>
                        </div>
                    `;
                }

                sessDiv.innerHTML += expandedContent;

                // Add accordion indicator for expandable sessions
                if (sess.status !== 'locked') {
                    sessDiv.innerHTML += '<div class="accordion-indicator" style="margin-top: 12px;"><i class="fa-solid fa-chevron-down"></i></div>';
                    
                    // Make expandable
                    sessDiv.onclick = function(event) {
                        if (event.target.tagName === 'BUTTON' || event.target.closest('button')) return;
                        this.classList.toggle('expanded');
                    };
                }

                sessionWireframeGrid.appendChild(sessDiv);
            });

            container.appendChild(sessionWireframeGrid);


            const separatorDiv = document.createElement('div');
            separatorDiv.style.cssText = 'margin: 80px 0 40px 0; border-top: 3px solid #cbd5e1; padding-top: 40px;';
            container.appendChild(separatorDiv);

            const deepDiveHeader = document.createElement('div');
            deepDiveHeader.style.cssText = 'margin-bottom: 24px;';
            deepDiveHeader.innerHTML = `
                <h3 style="font-size: 20px; font-weight: 700; color: #0f172a; margin-bottom: 8px;">All Success Case - Deep Dive</h3>
                <p style="font-size: 14px; color: #64748b;">View all completed assessments and available role-based actions</p>
            `;
            container.appendChild(deepDiveHeader);

            // Create completed blocks grid showing all items as completed
            const completedBlocksGrid = document.createElement('div');
            completedBlocksGrid.className = 'blocks-container';

            // Define all blocks in completed state
            const allCompletedBlocks = [
                { 
                    id: 'fnon-completed', 
                    name: 'FNON', 
                    desc: 'Network Analysis', 
                    type: 'fnon', 
                    status: 'completed', 
                    completedBy: 'Clinical Assistant Sarah',
                    completedAt: '2026-01-30',
                    score: 55,
                    channelsCaptured: null
                },
                { 
                    id: 'eeg-completed', 
                    name: 'Brain Mapping', 
                    desc: 'EEG Imaging', 
                    type: 'brain-mapping', 
                    status: 'completed', 
                    completedBy: 'Dr. Johnson',
                    completedAt: '2026-01-30',
                    score: null,
                    channelsCaptured: 32
                },
                { 
                    id: 'prs-completed', 
                    name: 'PRS', 
                    desc: 'Symptoms', 
                    type: 'prs', 
                    status: 'completed', 
                    completedBy: 'Clinical Assistant Alex',
                    completedAt: '2026-01-30',
                    currentProgress: 100
                },
                { 
                    id: 'ana-completed', 
                    name: "Doctor's Notes", 
                    desc: 'Clinical Notes',
                    type: 'doctor-notes',
                    status: 'completed', 
                    completedBy: 'Dr. Johnson',
                    completedAt: '2026-01-31'
                },
                { 
                    id: 'treatment-completed', 
                    name: 'Treatment Plan', 
                    desc: 'Therapy Design',
                    type: 'treatment-plan',
                    status: 'completed', 
                    completedBy: 'Dr. Johnson',
                    completedAt: '2026-01-31'
                },
                { 
                    id: 'report-completed', 
                    name: 'Final Report', 
                    desc: 'Comprehensive',
                    type: 'final-report',
                    status: 'completed', 
                    completedBy: 'Dr. Johnson',
                    completedAt: '2026-01-31'
                }
            ];

            allCompletedBlocks.forEach(block => {
                const blockDiv = document.createElement('div');
                blockDiv.className = `block-card ${block.type} completed`;
                
                let statusIcon = '✓';
                let statusText = 'Done';

                // Build expanded details based on role and block type
                let expandedDetailsHTML = '';
                
                if (permissions.canViewScores || permissions.canViewReports || permissions.canEditData) {
                    let detailsContent = '';
                    
                    if (block.type === 'fnon' && permissions.canViewScores) {
                        const fnonScore = calculatePatientFnonScore();
                        const currentPatientId = selectedPatientData?.id || 'P001';
                        const improvement = patientImprovements[currentPatientId] || '+0%';
                        detailsContent = `
                            <div class="block-info-grid">
                                <div class="block-info-item">
                                    <div class="block-info-label">FNON Score</div>
                                    <div class="block-info-value">${fnonScore}/30</div>
                                </div>
                                <div class="block-info-item">
                                    <div class="block-info-label">Improvement</div>
                                    <div class="block-info-value" style="color: var(--green-primary);">${improvement}</div>
                                </div>}
                                <div class="block-info-item">
                                    <div class="block-info-label">Duration</div>
                                    <div class="block-info-value" style="font-size: 12px;">45 min</div>
                                </div>
                                <div class="block-info-item">
                                    <div class="block-info-label">Completed By</div>
                                    <div class="block-info-value" style="font-size: 12px;">${block.completedBy}</div>
                                </div>
                            </div>
                            <div class="detail-section">
                                <div class="detail-section-title">Activities Performed</div>
                                <div class="activity-tags">
                                    <span class="activity-tag">
                                        Crossword
                                        <img src="crossword.avif" alt="Crossword" class="activity-tag-image">
                                    </span>
                                    <span class="activity-tag">
                                        Toe Touch
                                        <img src="exercise.png" alt="Toe Touch" class="activity-tag-image">
                                    </span>
                                    <span class="activity-tag">
                                        Walking
                                        <img src="walking.jpeg" alt="Walking" class="activity-tag-image">
                                    </span>
                                    <span class="activity-tag">
                                        Sudoku
                                        <img src="sudoku.jpg" alt="Sudoku" class="activity-tag-image">
                                    </span>
                                    <span class="activity-tag">
                                        Balance Test
                                        <img src="balance.jpeg" alt="Balance Test" class="activity-tag-image">
                                    </span>
                                </div>
                            </div>
                        `;
                        if (permissions.canViewReports || permissions.canEditData) {
                            detailsContent += '<div class="block-action-buttons">';
                            if (permissions.canViewReports) {
                                detailsContent += '<button class="block-action-btn view" onclick="viewBlockDetails(\'fnon\')" title="View detailed FNON report"><i class="fa-solid fa-eye"></i> View Details</button>';
                            }
                            if (permissions.canEditData) {
                                detailsContent += '<button class="block-action-btn edit" onclick="editBlockDetails(\'fnon\')" title="Edit FNON assessment data"><i class="fa-solid fa-pen"></i> Edit Details</button>';
                            }
                            detailsContent += '</div>';
                        }
                    } else if (block.type === 'brain-mapping' && permissions.canViewScores) {
                        detailsContent = `
                            <div class="block-info-grid">
                                <div class="block-info-item">
                                    <div class="block-info-label">Channels</div>
                                    <div class="block-info-value">${block.channelsCaptured || 32}</div>
                                </div>
                                <div class="block-info-item">
                                    <div class="block-info-label">Quality</div>
                                    <div class="block-info-value" style="font-size: 12px;">High</div>
                                </div>
                                <div class="block-info-item">
                                    <div class="block-info-label">Duration</div>
                                    <div class="block-info-value" style="font-size: 12px;">20 min</div>
                                </div>
                                <div class="block-info-item">
                                    <div class="block-info-label">Completed By</div>
                                    <div class="block-info-value" style="font-size: 12px;">${block.completedBy}</div>
                                </div>
                            </div>
                        `;
                        if (permissions.canViewReports || (currentRole === 'doctor' && permissions.canEditData)) {
                            detailsContent += '<div class="block-action-buttons">';
                            if (permissions.canViewReports) {
                                detailsContent += '<button class="block-action-btn view" onclick="viewBlockDetails(\'brain-mapping\')" title="View EEG data and analysis"><i class="fa-solid fa-eye"></i> View Details</button>';
                            }
                            if (currentRole === 'doctor') {
                                detailsContent += '<button class="block-action-btn edit" onclick="editBlockDetails(\'brain-mapping\')" title="Edit EEG analysis (Doctor only)"><i class="fa-solid fa-pen"></i> Edit Details</button>';
                            } else if (currentRole === 'clinical-assistant') {
                                detailsContent += '<button class="block-action-btn disabled" title="Only doctors can edit EEG data"><i class="fa-solid fa-lock"></i> Edit Restricted</button>';
                            }
                            detailsContent += '</div>';
                        }
                    } else if (permissions.canViewScores) {
                        detailsContent = `
                            <div class="block-info-grid">
                                <div class="block-info-item">
                                    <div class="block-info-label">Status</div>
                                    <div class="block-info-value" style="font-size: 12px;">Completed</div>
                                </div>
                                <div class="block-info-item">
                                    <div class="block-info-label">Completed By</div>
                                    <div class="block-info-value" style="font-size: 12px;">${block.completedBy}</div>
                                </div>
                                <div class="block-info-item">
                                    <div class="block-info-label">Date</div>
                                    <div class="block-info-value" style="font-size: 12px;">${block.completedAt}</div>
                                </div>
                            </div>
                        `;
                        if (permissions.canViewReports || permissions.canEditData) {
                            detailsContent += '<div class="block-action-buttons">';
                            if (permissions.canViewReports) {
                                detailsContent += '<button class="block-action-btn view" onclick="viewBlockDetails(\''+block.type+'\')" title="View detailed report"><i class="fa-solid fa-eye"></i> View Details</button>';
                            }
                            if (permissions.canEditData) {
                                detailsContent += '<button class="block-action-btn edit" onclick="editBlockDetails(\''+block.type+'\')" title="Edit assessment data"><i class="fa-solid fa-pen"></i> Edit Details</button>';
                            }
                            detailsContent += '</div>';
                        }
                    }

                    if (detailsContent) {
                        expandedDetailsHTML = `<div class="block-expanded-details">${detailsContent}</div>`;
                    }
                }

                blockDiv.innerHTML = `
                    <div class="block-status">
                        <span class="block-status-icon">${statusIcon}</span>
                        <span class="block-status-text">${statusText}</span>
                    </div>
                    <div class="block-icon">
                        <i class="fa-solid ${iconMap[block.type] || 'fa-circle'}"></i>
                    </div>
                    <div class="block-name">${block.name}</div>
                    <div class="block-desc">${block.desc}</div>
                    ${expandedDetailsHTML}
                    ${expandedDetailsHTML ? '<div class="accordion-indicator"><i class="fa-solid fa-chevron-down"></i></div>' : ''}
                `;

                // Add click handler if there are details to show
                if (expandedDetailsHTML && (permissions.canViewScores || permissions.canViewReports || permissions.canEditData)) {
                    blockDiv.style.cursor = 'pointer';
                    blockDiv.onclick = function(event) {
                        // Don't toggle if clicking on a button or link
                        if (event.target.tagName === 'BUTTON' || event.target.closest('button') || event.target.closest('.block-action-btn')) {
                            return;
                        }
                        this.classList.toggle('expanded');
                    };
                }

                completedBlocksGrid.appendChild(blockDiv);
            });

            container.appendChild(completedBlocksGrid);

            // ADD TREATMENT SESSIONS SECTION
            const sessionsSeparatorDiv = document.createElement('div');
            sessionsSeparatorDiv.style.cssText = 'margin: 80px 0 40px 0; border-top: 3px solid #cbd5e1; padding-top: 40px;';
            container.appendChild(sessionsSeparatorDiv);

            const sessionsHeader = document.createElement('div');
            sessionsHeader.style.cssText = 'margin-bottom: 24px;';
            sessionsHeader.innerHTML = `
                <h3 style="font-size: 20px; font-weight: 700; color: #0f172a; margin-bottom: 8px;">Treatment Sessions - Today's Activity</h3>
                <p style="font-size: 14px; color: #64748b;">View session progress, active treatments, and completed protocols</p>
            `;
            container.appendChild(sessionsHeader);

            // Create sessions grid
            const sessionsGrid = document.createElement('div');
            sessionsGrid.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; position: relative; overflow: visible;';

            // Define sessions with different states
            const todaySessions = [
                {
                    id: 'sess-1',
                    number: 1,
                    status: 'completed',
                    device: 'TMS-Unit-A',
                    montage: 'DLPFC',
                    completedAt: '09:30 AM',
                    duration: '25 min',
                    completedBy: 'Clinical Assistant Sarah',
                    paymentAmount: 100,
                    paymentStatus: 'Paid',
                    notes: 'Patient tolerated the session well. No adverse effects reported. Target intensity achieved at 80% motor threshold.',
                    exercises: ['Deep Breathing', 'Guided Meditation', 'Light Stretching']
                },
                {
                    id: 'sess-2',
                    number: 2,
                    status: 'completed',
                    device: 'TMS-Unit-B',
                    montage: 'M1 Left',
                    completedAt: '11:45 AM',
                    duration: '30 min',
                    completedBy: 'Clinical Assistant Alex',
                    paymentAmount: 100,
                    paymentStatus: 'Paid',
                    notes: 'Session completed successfully. Patient reported mild tingling sensation which is normal. Motor responses were consistent.',
                    exercises: ['Balance Training', 'Coordination Test', 'Walking']
                },
                {
                    id: 'sess-3',
                    number: 3,
                    status: 'active',
                    paymentAmount: 100,
                    paymentStatus: 'Paid',
                    activatedAt: '02:15 PM',
                    activatedBy: 'Receptionist Maria'
                },
                {
                    id: 'sess-4',
                    number: 4,
                    status: 'pending',
                    scheduledTime: '04:00 PM'
                },
                {
                    id: 'sess-5',
                    number: 5,
                    status: 'locked',
                    prerequisite: 'Complete Session 4'
                }
            ];

            todaySessions.forEach(sess => {
                const sessDiv = document.createElement('div');
                sessDiv.style.cssText = 'background: white; border-radius: 12px; border: 1px solid #e2e8f0; padding: 16px; display: flex; flex-direction: column; align-items: center; text-align: center; cursor: pointer; transition: all 0.3s ease; position: relative; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); overflow: visible;';

                let statusIcon, statusText, statusColor, borderColor;
                if (sess.status === 'completed') {
                    statusIcon = '✓';
                    statusText = 'Completed';
                    statusColor = '#10b981';
                    borderColor = '#10b981';
                } else if (sess.status === 'active') {
                    statusIcon = '●';
                    statusText = 'Active Now';
                    statusColor = '#f59e0b';
                    borderColor = '#f59e0b';
                } else if (sess.status === 'pending') {
                    statusIcon = '○';
                    statusText = 'Scheduled';
                    statusColor = '#3b82f6';
                    borderColor = '#3b82f6';
                } else {
                    statusIcon = '🔒';
                    statusText = 'Locked';
                    statusColor = '#94a3b8';
                    borderColor = '#cbd5e1';
                }

                // Add top border color
                sessDiv.innerHTML = `<div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: ${borderColor}; border-radius: 12px 12px 0 0;"></div>`;

                // Status badge
                sessDiv.innerHTML += `
                    <div style="position: absolute; top: 12px; right: 12px; padding: 4px 10px; border-radius: 12px; display: flex; align-items: center; gap: 4px; font-size: 11px; font-weight: 700; background: white; border: 1.5px solid ${borderColor}; color: ${statusColor};">
                        <span style="font-size: 12px;">${statusIcon}</span>
                        <span>${statusText}</span>
                    </div>
                `;

                // Icon
                sessDiv.innerHTML += `
                    <div style="width: 64px; height: 64px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; margin-bottom: 12px; background: ${sess.status === 'completed' ? 'rgba(16, 185, 129, 0.15)' : sess.status === 'active' ? 'rgba(245, 158, 11, 0.15)' : sess.status === 'pending' ? 'rgba(59, 130, 246, 0.15)' : 'rgba(203, 213, 225, 0.3)'}; color: ${statusColor};">
                        <i class="fa-solid fa-dumbbell"></i>
                    </div>
                `;

                // Session name
                sessDiv.innerHTML += `<div style="font-size: 14px; font-weight: 700; color: #0f172a; margin-bottom: 4px;">Session ${sess.number}</div>`;

                // Build expanded details
                let expandedDetailsHTML = '';
                
                if (sess.status === 'completed' && (permissions.canViewScores || permissions.canViewReports)) {
                    let detailsContent = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; background: #f8fafc; padding: 16px; border-radius: 8px; margin-top: 16px;">
                            <div>
                                <div style="font-size: 11px; font-weight: 600; text-transform: uppercase; color: #64748b; margin-bottom: 4px;">Payment</div>
                                <div style="font-size: 14px; font-weight: 700; color: #10b981;">€${sess.paymentAmount} ${sess.paymentStatus}</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; font-weight: 600; text-transform: uppercase; color: #64748b; margin-bottom: 4px;">Time</div>
                                <div style="font-size: 14px; font-weight: 700; color: #0f172a;">${sess.completedAt}</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; font-weight: 600; text-transform: uppercase; color: #64748b; margin-bottom: 4px;">Device</div>
                                <div style="font-size: 14px; font-weight: 700; color: #0f172a;">${sess.device}</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; font-weight: 600; text-transform: uppercase; color: #64748b; margin-bottom: 4px;">Montage</div>
                                <div style="font-size: 14px; font-weight: 700; color: #0f172a;">${sess.montage}</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; font-weight: 600; text-transform: uppercase; color: #64748b; margin-bottom: 4px;">Duration</div>
                                <div style="font-size: 14px; font-weight: 700; color: #0f172a;">${sess.duration}</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; font-weight: 600; text-transform: uppercase; color: #64748b; margin-bottom: 4px;">Completed By</div>
                                <div style="font-size: 14px; font-weight: 700; color: #0f172a;">${sess.completedBy}</div>
                            </div>
                        </div>
                        <div style="margin-top: 12px;">
                            <div style="font-size: 11px; font-weight: 700; text-transform: uppercase; color: #64748b; letter-spacing: 0.5px; margin-bottom: 8px;">Exercises Performed</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px; position: relative; z-index: 100;">
                                ${sess.exercises.map(ex => {
                                    const exerciseImages = {
                                        'Deep Breathing': 'exercise.png',
                                        'Guided Meditation': 'exercise.png',
                                        'Light Stretching': 'exercise.png',
                                        'Balance Training': 'balance.jpeg',
                                        'Coordination Test': 'balance.jpeg',
                                        'Walking': 'walking.jpeg'
                                    };
                                    const imgSrc = exerciseImages[ex] || 'exercise.png';
                                    return `
                                        <span class="activity-tag" style="padding: 6px 12px; background: rgba(16, 185, 129, 0.15); color: #059669; border-radius: 6px; font-size: 12px; font-weight: 600; position: relative; cursor: pointer; z-index: 101;">
                                            ${ex}
                                            <img src="${imgSrc}" alt="${ex}" class="activity-tag-image">
                                        </span>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        <div style="margin-top: 12px; background: #fffbeb; border-left: 3px solid #f59e0b; padding: 12px; border-radius: 6px;">
                            <div style="font-size: 11px; font-weight: 700; text-transform: uppercase; color: #92400e; margin-bottom: 6px;">Clinical Notes</div>
                            <div style="font-size: 12px; color: #78350f; line-height: 1.6;">${sess.notes}</div>
                            <div style="font-size: 11px; color: #92400e; margin-top: 6px; font-style: italic;">— ${sess.completedBy}</div>
                        </div>
                    `;
                    if (permissions.canViewReports || permissions.canEditData) {
                        detailsContent += '<div style="display: flex; gap: 8px; margin-top: 16px; width: 100%;">';
                        if (permissions.canViewReports) {
                            detailsContent += '<button class="block-action-btn view" onclick="viewSessionDetails(\''+sess.id+'\')"><i class="fa-solid fa-eye"></i> View Details</button>';
                        }
                        if (permissions.canEditData) {
                            detailsContent += '<button class="block-action-btn edit" onclick="editSessionDetails(\''+sess.id+'\')"><i class="fa-solid fa-pen"></i> Edit Details</button>';
                        }
                        detailsContent += '</div>';
                    }
                    expandedDetailsHTML = `<div style="max-height: 0; overflow: hidden; transition: max-height 0.4s ease, opacity 0.3s ease; opacity: 0; width: 100%;" class="session-expanded-details">${detailsContent}</div>`;
                } else if (sess.status === 'active') {
                    let detailsContent = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; background: #fef3c7; padding: 16px; border-radius: 8px; margin-top: 16px; border: 2px solid #fbbf24;">
                            <div>
                                <div style="font-size: 11px; font-weight: 600; text-transform: uppercase; color: #78350f; margin-bottom: 4px;">Payment Status</div>
                                <div style="font-size: 14px; font-weight: 700; color: #10b981;">€${sess.paymentAmount} ${sess.paymentStatus}</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; font-weight: 600; text-transform: uppercase; color: #78350f; margin-bottom: 4px;">Activated At</div>
                                <div style="font-size: 14px; font-weight: 700; color: #92400e;">${sess.activatedAt}</div>
                            </div>
                        </div>
                        <div style="margin-top: 12px; padding: 12px; background: white; border-radius: 8px; border: 1px solid #e2e8f0; text-align: center;">
                            <div style="font-size: 11px; font-weight: 600; color: #64748b; margin-bottom: 4px;">Activated By</div>
                            <div style="font-size: 13px; font-weight: 700; color: #0f172a;">${sess.activatedBy}</div>
                        </div>
                        <div style="margin-top: 12px; padding: 16px; background: #ecfdf5; border: 2px dashed #10b981; border-radius: 8px; text-align: center;">
                            <i class="fa-solid fa-check-circle" style="font-size: 32px; color: #10b981; margin-bottom: 8px; display: block;"></i>
                            <div style="font-size: 13px; font-weight: 600; color: #065f46;">Session Ready to Start</div>
                            <div style="font-size: 11px; color: #059669; margin-top: 4px;">Payment confirmed - Awaiting clinical staff</div>
                        </div>
                    `;
                    // Role-based start button
                    if (currentRole === 'doctor' || currentRole === 'clinical-assistant') {
                        detailsContent += '<div style="margin-top: 16px;"><button class="block-action-btn edit" onclick="startSession(\''+sess.id+'\'" style="width: 100%;"><i class="fa-solid fa-play"></i> Start Session</button></div>';
                    } else if (currentRole === 'receptionist') {
                        detailsContent += '<div style="margin-top: 16px; padding: 10px; background: #fef3c7; border-radius: 6px; text-align: center; font-size: 12px; color: #78350f;"><i class="fa-solid fa-info-circle"></i> Clinical staff can start this session</div>';
                    } else if (currentRole === 'patient') {
                        detailsContent += '<div style="margin-top: 16px; padding: 10px; background: #e0f2fe; border-radius: 6px; text-align: center; font-size: 12px; color: #075985;"><i class="fa-solid fa-clock"></i> Your session is ready and will begin shortly</div>';
                    }
                    expandedDetailsHTML = `<div style="max-height: 0; overflow: hidden; transition: max-height 0.4s ease, opacity 0.3s ease; opacity: 0; width: 100%;" class="session-expanded-details">${detailsContent}</div>`;
                } else if (sess.status === 'pending') {
                    let detailsContent = `
                        <div style="text-align: center; padding: 16px; color: #64748b; margin-top: 16px;">
                            <i class="fa-solid fa-clock" style="font-size: 32px; margin-bottom: 8px; display: block; color: #3b82f6;"></i>
                            <p style="font-size: 13px; margin: 0; font-weight: 600;">Scheduled for ${sess.scheduledTime}</p>
                            <p style="font-size: 12px; margin: 8px 0 0 0; color: #94a3b8;">Awaiting payment confirmation</p>
                        </div>
                    `;
                    // Receptionist can activate
                    if (currentRole === 'receptionist') {
                        detailsContent += '<div style="margin-top: 16px;"><button class="block-action-btn edit" onclick="activateSession(\''+sess.id+'\'" style="width: 100%;"><i class="fa-solid fa-euro-sign"></i> Confirm Payment & Activate</button></div>';
                    }
                    expandedDetailsHTML = `<div style="max-height: 0; overflow: hidden; transition: max-height 0.4s ease, opacity 0.3s ease; opacity: 0; width: 100%;" class="session-expanded-details">${detailsContent}</div>`;
                } else if (sess.status === 'locked') {
                    sessDiv.innerHTML += `<div style="font-size: 12px; color: #64748b; margin-top: 4px;">${sess.prerequisite}</div>`;
                }

                if (expandedDetailsHTML) {
                    sessDiv.innerHTML += expandedDetailsHTML;
                    sessDiv.innerHTML += '<div style="position: absolute; bottom: 8px; right: 12px; font-size: 12px; color: #94a3b8; transition: transform 0.3s ease; z-index: 1; pointer-events: none;" class="session-accordion-indicator"><i class="fa-solid fa-chevron-down"></i></div>';
                    
                    sessDiv.onclick = function(event) {
                        if (event.target.tagName === 'BUTTON' || event.target.closest('button')) {
                            return;
                        }
                        this.classList.toggle('session-expanded');
                        const details = this.querySelector('.session-expanded-details');
                        const indicator = this.querySelector('.session-accordion-indicator');
                        if (this.classList.contains('session-expanded')) {
                            details.style.maxHeight = '1000px';
                            details.style.opacity = '1';
                            details.style.overflow = 'visible';
                            indicator.style.transform = 'rotate(180deg)';
                            this.style.paddingBottom = '24px';
                        } else {
                            details.style.maxHeight = '0';
                            details.style.opacity = '0';
                            details.style.overflow = 'hidden';
                            indicator.style.transform = 'rotate(0deg)';
                            this.style.paddingBottom = '16px';
                        }
                    };
                }

                sessionsGrid.appendChild(sessDiv);
            });

            container.appendChild(sessionsGrid);
        }

        // WORKING JOURNEY - BLOCKS DEFINITION
        const workingBlocks = [
            {
                id: 'working-block-1',
                type: 'fnon',
                name: 'FNON Assessment',
                desc: 'Functional neurological assessment across multiple domains',
                requiresPrevious: false
            },
            {
                id: 'working-block-2',
                type: 'brain-mapping',
                name: 'Brain Mapping',
                desc: 'EEG data capture and neural activity analysis',
                requiresPrevious: false
            },
            {
                id: 'working-block-3',
                type: 'prs',
                name: 'PRS Evaluation',
                desc: 'Disease-specific symptom assessment and scoring',
                requiresPrevious: false
            },
            {
                id: 'working-block-4',
                type: 'doctors-notes',
                name: "Doctor's Notes",
                desc: 'Clinical observations and medical recommendations',
                requiresPrevious: true
            },
            {
                id: 'working-block-5',
                type: 'treatment-plan',
                name: 'Treatment Plan',
                desc: 'Personalized therapy protocol and montage selection',
                requiresPrevious: true
            },
            {
                id: 'working-block-6',
                type: 'final-report',
                name: 'Final Report',
                desc: 'Comprehensive assessment summary and outcomes',
                requiresPrevious: true
            }
        ];

        // GET WORKING JOURNEY PERMISSIONS
        function getWorkingPermissions(role) {
            const permissions = {
                'doctor': {
                    canStart: ['fnon', 'brain-mapping', 'prs'],
                    canView: ['fnon', 'brain-mapping', 'prs', 'doctors-notes', 'treatment-plan', 'final-report'],
                    showStartButtons: true,
                    label: 'Doctor'
                },
                'clinical-assistant': {
                    canStart: ['prs'],
                    canView: ['fnon', 'brain-mapping', 'prs', 'doctors-notes', 'treatment-plan', 'final-report'],
                    showStartButtons: true,
                    restrictedMessage: 'Only doctors can perform this assessment',
                    label: 'Clinical Assistant'
                },
                'receptionist': {
                    canStart: [],
                    canView: ['fnon', 'brain-mapping', 'prs', 'doctors-notes', 'treatment-plan', 'final-report'],
                    showStartButtons: false,
                    label: 'Receptionist'
                },
                'patient': {
                    canStart: [],
                    canView: ['fnon', 'brain-mapping', 'prs', 'doctors-notes', 'treatment-plan', 'final-report'],
                    showStartButtons: false,
                    label: 'Patient'
                }
            };
            return permissions[role];
        }

        // RENDER WORKING JOURNEY VIEW
        function renderWorkingView() {
            const container = document.getElementById('workingBlocksContainer');
            const permissions = getWorkingPermissions(currentRole);
            container.innerHTML = '';

            workingBlocks.forEach(block => {
                const blockDiv = document.createElement('div');
                
                const canStart = !block.requiresPrevious && permissions.canStart.includes(block.type);
                const canView = permissions.canView.includes(block.type) && !canStart && !block.requiresPrevious;
                const isLocked = block.requiresPrevious;

                let statusClass = 'locked';
                let statusText = 'Locked';
                if (canStart) {
                    statusClass = 'ready';
                    statusText = 'Can Start';
                } else if (canView) {
                    statusClass = 'view-only';
                    statusText = 'View Only';
                }

                blockDiv.className = `block-card ${block.type} ${canStart ? 'can-start' : ''} ${isLocked ? 'locked' : ''}`;
                
                let actionHTML = '';
                if (permissions.showStartButtons && !isLocked) {
                    if (canStart) {
                        actionHTML = `
                            <div class="block-actions" style="margin-top: auto;">
                                <button class="start-button primary" onclick="startWorkingBlock('${block.id}', '${block.name}')">
                                    <i class="fa-solid fa-play"></i>
                                    Start Assessment
                                </button>
                            </div>
                        `;
                    } else if (canView && currentRole === 'clinical-assistant') {
                        actionHTML = `
                            <div class="block-actions tooltip" style="margin-top: auto;">
                                <button class="start-button disabled">
                                    <i class="fa-solid fa-lock"></i>
                                    Restricted
                                </button>
                                <span class="tooltip-text">${permissions.restrictedMessage}</span>
                            </div>
                        `;
                    }
                } else if (!isLocked && currentRole === 'patient') {
                    actionHTML = `
                        <div class="block-actions" style="margin-top: auto;">
                            <button class="start-button view-only">
                                <i class="fa-solid fa-eye"></i>
                                View Information
                            </button>
                        </div>
                    `;
                }

                if (isLocked) {
                    actionHTML = `
                        <div class="block-actions" style="margin-top: auto;">
                            <button class="start-button disabled">
                                <i class="fa-solid fa-lock"></i>
                                Complete Previous Steps
                            </button>
                        </div>
                    `;
                }

                blockDiv.innerHTML = `
                    <div class="block-status ${statusClass}">
                        <span class="block-status-icon">${statusClass === 'ready' ? '✓' : statusClass === 'view-only' ? '○' : '🔒'}</span>
                        <span class="block-status-text">${statusText}</span>
                    </div>
                    <div class="block-icon">
                        <i class="fa-solid ${iconMap[block.type] || 'fa-circle'}"></i>
                    </div>
                    <div class="block-name">${block.name}</div>
                    <div class="block-desc">${block.desc}</div>
                    ${actionHTML}
                `;

                container.appendChild(blockDiv);
            });
        }

        // START WORKING BLOCK
        function startWorkingBlock(blockId, blockName) {
            alert(`Starting: ${blockName}\\n\\nRole: ${currentRole}\\n\\nThis would open the assessment interface for data entry.`);
        }

        // RENDER DEVICE LOCKING VIEW
        function renderDeviceView() {
            const permissions = getWorkingPermissions(currentRole);
            
            // Render LOCKED state
            const lockedContainer = document.getElementById('deviceLockedContainer');
            lockedContainer.innerHTML = '';
            
            const lockedBlock = createDeviceBlock('Brain Mapping', 'brain-mapping', true, permissions);
            lockedContainer.appendChild(lockedBlock);
            
            // Render UNLOCKED state
            const unlockedContainer = document.getElementById('deviceUnlockedContainer');
            unlockedContainer.innerHTML = '';
            
            const unlockedBlock = createDeviceBlock('Brain Mapping', 'brain-mapping', false, permissions);
            unlockedContainer.appendChild(unlockedBlock);
        }

        // CREATE DEVICE BLOCK
        function createDeviceBlock(name, type, isPaymentLocked, permissions) {
            const blockDiv = document.createElement('div');
            blockDiv.className = `block-card ${type}`;
            
            let statusHTML = '';
            let actionHTML = '';
            let additionalInfo = '';
            
            if (isPaymentLocked) {
                // LOCKED STATE - Payment not processed
                blockDiv.classList.add('locked');
                statusHTML = `
                    <div class="block-status locked">
                        <span class="block-status-icon">🔒</span>
                        <span class="block-status-text">Payment Pending</span>
                    </div>
                `;
                
                additionalInfo = `
                    <div class="payment-warning">
                        <i class="fa-solid fa-exclamation-triangle"></i>
                        <span>Device activation requires payment confirmation</span>
                    </div>
                `;
                
                actionHTML = `
                    <div class="block-actions" style="margin-top: auto;">
                        <button class="start-button disabled">
                            <i class="fa-solid fa-lock"></i>
                            Device Locked - Payment Required
                        </button>
                    </div>
                `;
            } else {
                // UNLOCKED STATE - Payment processed
                const canStart = permissions.canStart.includes(type);
                
                if (canStart) {
                    statusHTML = `
                        <div class="block-status ready">
                            <span class="block-status-icon">✓</span>
                            <span class="block-status-text">Device Active</span>
                        </div>
                    `;
                    blockDiv.classList.add('can-start');
                } else {
                    statusHTML = `
                        <div class="block-status view-only">
                            <span class="block-status-icon">○</span>
                            <span class="block-status-text">Device Active</span>
                        </div>
                    `;
                }
                
                additionalInfo = `
                    <div class="payment-success">
                        <i class="fa-solid fa-circle-check"></i>
                        <span>Payment confirmed - Device ready for use</span>
                    </div>
                `;
                
                if (permissions.showStartButtons && canStart) {
                    actionHTML = `
                        <div class="block-actions" style="margin-top: auto;">
                            <button class="start-button primary" onclick="startDeviceAssessment('${type}')">
                                <i class="fa-solid fa-play"></i>
                                Start Assessment
                            </button>
                        </div>
                    `;
                } else if (currentRole === 'clinical-assistant' && !canStart) {
                    actionHTML = `
                        <div class="block-actions tooltip" style="margin-top: auto;">
                            <button class="start-button disabled">
                                <i class="fa-solid fa-lock"></i>
                                Restricted
                            </button>
                            <span class="tooltip-text">Only doctors can perform this assessment</span>
                        </div>
                    `;
                } else if (currentRole === 'patient') {
                    actionHTML = `
                        <div class="block-actions" style="margin-top: auto;">
                            <button class="start-button view-only">
                                <i class="fa-solid fa-eye"></i>
                                View Information
                            </button>
                        </div>
                    `;
                } else if (currentRole === 'receptionist') {
                    actionHTML = `
                        <div class="block-actions" style="margin-top: auto;">
                            <button class="start-button view-only">
                                <i class="fa-solid fa-check-circle"></i>
                                Payment Confirmed
                            </button>
                        </div>
                    `;
                }
            }
            
            blockDiv.innerHTML = `
                ${statusHTML}
                <div class="block-icon">
                    <i class="fa-solid ${iconMap[type] || 'fa-circle'}"></i>
                </div>
                <div class="block-name">${name}</div>
                <div class="block-desc">EEG data capture and neural activity analysis</div>
                ${additionalInfo}
                ${actionHTML}
            `;
            
            return blockDiv;
        }

        // START DEVICE ASSESSMENT
        function startDeviceAssessment(type) {
            alert(`Starting Brain Mapping Assessment\\n\\nRole: ${currentRole}\\nDevice: EEG Headset\\nStatus: Active\\n\\nThis would open the EEG capture interface.`);
        }

        // ACTION HANDLERS
        function viewBlockReport(blockId) {
            alert(`Viewing report for block: ${blockId}\\n\\nThis would open the detailed report in ${currentRole} view.`);
        }

        function continueBlock(blockId) {
            alert(`Continuing block: ${blockId}\\n\\nThis would open the data entry interface.`);
        }

        // Helper function to calculate FNON score for current patient
        function calculatePatientFnonScore(assessmentNumber = 2) {
            const currentPatientId = selectedPatientData?.id || 'P001';
            
            // Assessment-specific FNON scores (CA1 has higher/baseline scores, CA2 shows improvement)
            const assessmentScores = {
                'P001': { 1: 24, 2: 18 },  // Improved from 24 to 18 (lower is better for depression)
                'P002': { 1: 26, 2: 20 },
                'P003': { 1: 25, 2: 19 },
                'P004': { 1: 23, 2: 17 },
                'P005': { 1: 28, 2: 27 }   // Minimal improvement
            };
            
            return assessmentScores[currentPatientId]?.[assessmentNumber] || assessmentScores['P001'][assessmentNumber];
        }

        // Helper function to get assessment-specific brain mapping data
        function getPatientBrainMappingData(patientId, assessmentNumber = 2) {
            const baselineData = {
                'P001': {
                    1: { 
                        dominantFrequency: '9.2 Hz', 
                        alphaActivity: '16.8 μV', 
                        betaActivity: '24.1 μV', 
                        thetaActivity: '17.2 μV', 
                        deltaActivity: '13.5 μV', 
                        asymmetry: '8.2% (L>R)',
                        findings: ['Elevated slow-wave activity in frontal regions', 'Reduced alpha power suggesting arousal dysregulation', 'Asymmetric activation patterns noted'],
                        recommendation: 'Initial assessment shows typical patterns for depression. TMS therapy targeting identified regions recommended.'
                    },
                    2: { 
                        dominantFrequency: '10.1 Hz', 
                        alphaActivity: '18.2 μV', 
                        betaActivity: '22.5 μV', 
                        thetaActivity: '15.7 μV', 
                        deltaActivity: '12.3 μV', 
                        asymmetry: '5.8% (L>R)',
                        findings: ['Improved alpha rhythm coherence', 'Reduced frontal slow-wave activity', 'Better hemispheric balance achieved'],
                        recommendation: 'Positive neuroplasticity changes observed. Continue current TMS protocol with regular monitoring.'
                    }
                },
                'P002': {
                    1: { 
                        dominantFrequency: '8.8 Hz', 
                        alphaActivity: '15.2 μV', 
                        betaActivity: '25.3 μV', 
                        thetaActivity: '18.1 μV', 
                        deltaActivity: '14.2 μV', 
                        asymmetry: '9.1% (L>R)',
                        findings: ['Significant frontal theta activity', 'Low alpha power indicating stress response', 'Marked left-right asymmetry'],
                        recommendation: 'Baseline shows elevated stress markers. Targeted neuromodulation recommended.'
                    },
                    2: { 
                        dominantFrequency: '9.9 Hz', 
                        alphaActivity: '17.8 μV', 
                        betaActivity: '23.1 μV', 
                        thetaActivity: '16.2 μV', 
                        deltaActivity: '12.8 μV', 
                        asymmetry: '6.2% (L>R)',
                        findings: ['Enhanced alpha activity post-treatment', 'Normalized theta patterns', 'Improved symmetry metrics'],
                        recommendation: 'Treatment response excellent. Maintain current protocol and reassess in 4 weeks.'
                    }
                },
                'P003': {
                    1: { 
                        dominantFrequency: '9.0 Hz', 
                        alphaActivity: '16.1 μV', 
                        betaActivity: '24.7 μV', 
                        thetaActivity: '17.8 μV', 
                        deltaActivity: '13.9 μV', 
                        asymmetry: '8.7% (L>R)',
                        findings: ['Frontal-temporal dysregulation present', 'Beta activity elevation noted', 'Asymmetry in parietal regions'],
                        recommendation: 'Clinical patterns consistent with depression. Multi-target TMS approach suggested.'
                    },
                    2: { 
                        dominantFrequency: '10.0 Hz', 
                        alphaActivity: '18.0 μV', 
                        betaActivity: '22.8 μV', 
                        thetaActivity: '16.0 μV', 
                        deltaActivity: '12.5 μV', 
                        asymmetry: '6.0% (L>R)',
                        findings: ['Normalized frontal-temporal connectivity', 'Beta normalization achieved', 'Symmetry improvements evident'],
                        recommendation: 'Strong treatment response. Continue protocol with bi-weekly monitoring.'
                    }
                },
                'P004': {
                    1: { 
                        dominantFrequency: '9.3 Hz', 
                        alphaActivity: '17.0 μV', 
                        betaActivity: '23.8 μV', 
                        thetaActivity: '16.9 μV', 
                        deltaActivity: '13.2 μV', 
                        asymmetry: '7.9% (L>R)',
                        findings: ['Mild dysregulation in DMN activity', 'Slightly elevated slow waves', 'Moderate asymmetry observed'],
                        recommendation: 'Baseline within acceptable range. Standard TMS protocol appropriate.'
                    },
                    2: { 
                        dominantFrequency: '10.2 Hz', 
                        alphaActivity: '18.5 μV', 
                        betaActivity: '22.2 μV', 
                        thetaActivity: '15.5 μV', 
                        deltaActivity: '12.1 μV', 
                        asymmetry: '5.5% (L>R)',
                        findings: ['DMN normalization achieved', 'Slow-wave reduction successful', 'Near-optimal hemispheric balance'],
                        recommendation: 'Excellent progress. Consider transitioning to maintenance phase.'
                    }
                },
                'P005': {
                    1: { 
                        dominantFrequency: '8.5 Hz', 
                        alphaActivity: '14.8 μV', 
                        betaActivity: '26.2 μV', 
                        thetaActivity: '18.9 μV', 
                        deltaActivity: '14.8 μV', 
                        asymmetry: '10.2% (L>R)',
                        findings: ['Severe frontal lobe dysfunction', 'Treatment-resistant pattern evident', 'Significant bilateral asymmetry'],
                        recommendation: 'Complex case requiring intensive multi-modal approach and close monitoring.'
                    },
                    2: { 
                        dominantFrequency: '8.7 Hz', 
                        alphaActivity: '15.1 μV', 
                        betaActivity: '25.8 μV', 
                        thetaActivity: '18.5 μV', 
                        deltaActivity: '14.5 μV', 
                        asymmetry: '9.8% (L>R)',
                        findings: ['Minimal improvement in frontal activity', 'Persistent dysregulation patterns', 'Asymmetry remains elevated'],
                        recommendation: 'Limited treatment response. Consider alternative therapeutic strategies.'
                    }
                }
            };
            
            return baselineData[patientId]?.[assessmentNumber] || baselineData['P001'][assessmentNumber];
        }

        // Helper function to get assessment-specific PRS data
        function getPatientPRSData(patientId, assessmentNumber = 2) {
            const prsData = {
                'P001': {
                    1: { 
                        overallScore: '68/100', 
                        severity: 'Moderate-Severe',
                        condition: 'Major Depressive Disorder',
                        interpretation: 'Moderate to severe depression symptoms with significant impact on daily functioning. Patient reports persistent low mood, fatigue, and difficulty concentrating.',
                        functionalImpact: 'Moderate difficulty with work tasks and social activities',
                        primarySymptoms: [
                            { name: 'Persistent Low Mood', severity: 'Severe', frequency: 'Daily, lasting most of the day', duration: '6+ months' },
                            { name: 'Fatigue & Low Energy', severity: 'Moderate-Severe', frequency: 'Daily', duration: '5+ months' },
                            { name: 'Difficulty Concentrating', severity: 'Moderate', frequency: '5-6 days per week', duration: '4+ months' }
                        ],
                        secondarySymptoms: [
                            { name: 'Sleep Disturbance', severity: 'Moderate', notes: 'Difficulty falling asleep, waking early' },
                            { name: 'Appetite Changes', severity: 'Mild', notes: 'Reduced appetite, some weight loss' },
                            { name: 'Social Withdrawal', severity: 'Moderate', notes: 'Avoiding friends and social activities' }
                        ]
                    },
                    2: { 
                        overallScore: '42/100', 
                        severity: 'Mild-Moderate',
                        condition: 'Major Depressive Disorder',
                        interpretation: 'Significant improvement in depression symptoms. Patient reports better mood stability, increased energy levels, and improved ability to engage in daily activities.',
                        functionalImpact: 'Minimal to mild difficulty, able to complete most tasks',
                        primarySymptoms: [
                            { name: 'Occasional Low Mood', severity: 'Mild', frequency: '2-3 days per week', duration: 'Several hours' },
                            { name: 'Mild Fatigue', severity: 'Mild', frequency: '3-4 days per week', duration: 'Variable' },
                            { name: 'Concentration Challenges', severity: 'Mild', frequency: '2-3 days per week', duration: 'Brief periods' }
                        ],
                        secondarySymptoms: [
                            { name: 'Improved Sleep', severity: 'Mild', notes: 'Sleeping better with occasional difficulties' },
                            { name: 'Appetite Normalizing', severity: 'Minimal', notes: 'Appetite returning to normal' },
                            { name: 'Increased Social Engagement', severity: 'Minimal', notes: 'Beginning to reconnect with friends' }
                        ]
                    }
                },
                'P002': {
                    1: { 
                        overallScore: '72/100', 
                        severity: 'Severe',
                        condition: 'Generalized Anxiety Disorder',
                        interpretation: 'Severe anxiety symptoms with substantial impact on quality of life. Patient experiences frequent worry, physical tension, and avoidance behaviors.',
                        functionalImpact: 'Significant difficulty with stress management and new situations',
                        primarySymptoms: [
                            { name: 'Excessive Worry', severity: 'Severe', frequency: 'Daily, uncontrollable', duration: '8+ months' },
                            { name: 'Physical Tension', severity: 'Severe', frequency: 'Constant', location: 'Shoulders, neck, jaw, chest' },
                            { name: 'Restlessness', severity: 'Moderate-Severe', frequency: 'Daily', duration: 'Most of the day' }
                        ],
                        secondarySymptoms: [
                            { name: 'Racing Thoughts', severity: 'Severe', notes: 'Constant mental chatter, especially at night' },
                            { name: 'Irritability', severity: 'Moderate', notes: 'Short temper, easily frustrated' },
                            { name: 'Avoidance Behaviors', severity: 'Severe', notes: 'Avoiding many social and work situations' }
                        ]
                    },
                    2: { 
                        overallScore: '45/100', 
                        severity: 'Moderate',
                        condition: 'Generalized Anxiety Disorder',
                        interpretation: 'Notable reduction in anxiety symptoms. Patient demonstrates improved coping strategies and reduced avoidance behaviors.',
                        functionalImpact: 'Mild to moderate impact, managing most situations',
                        primarySymptoms: [
                            { name: 'Reduced Worry', severity: 'Moderate', frequency: '4-5 days per week', duration: 'Several hours' },
                            { name: 'Less Tension', severity: 'Mild-Moderate', frequency: '3-4 days per week', location: 'Occasional neck and shoulder tension' },
                            { name: 'More Settled', severity: 'Mild', frequency: '2-3 days per week', duration: 'Brief periods' }
                        ],
                        secondarySymptoms: [
                            { name: 'Better Sleep', severity: 'Mild', notes: 'Falling asleep more easily most nights' },
                            { name: 'Improved Patience', severity: 'Mild', notes: 'More relaxed in daily life' },
                            { name: 'Facing Situations', severity: 'Mild', notes: 'Engaging in previously avoided activities' }
                        ]
                    }
                },
                'P003': {
                    1: { 
                        overallScore: '70/100', 
                        severity: 'Moderate-Severe',
                        condition: 'Post-Traumatic Stress Disorder',
                        interpretation: 'Moderate to severe PTSD symptoms with significant functional impairment. Patient experiences intrusive memories, nightmares, and hypervigilance.',
                        functionalImpact: 'Significant difficulty with daily activities and relationships',
                        primarySymptoms: [
                            { name: 'Intrusive Memories', severity: 'Severe', frequency: 'Multiple times daily', duration: '8+ months' },
                            { name: 'Nightmares', severity: 'Moderate-Severe', frequency: '5-6 nights per week', duration: '7+ months' },
                            { name: 'Hypervigilance', severity: 'Moderate', frequency: 'Most of the time', duration: '8+ months' }
                        ],
                        secondarySymptoms: [
                            { name: 'Emotional Numbness', severity: 'Moderate', notes: 'Difficulty feeling positive emotions' },
                            { name: 'Avoidance of Triggers', severity: 'Moderate-Severe', notes: 'Avoiding places, people, activities' },
                            { name: 'Irritability', severity: 'Moderate', notes: 'Easily frustrated, occasional outbursts' }
                        ]
                    },
                    2: { 
                        overallScore: '43/100', 
                        severity: 'Mild-Moderate',
                        condition: 'Post-Traumatic Stress Disorder',
                        interpretation: 'Substantial improvement in PTSD symptoms. Patient reports fewer intrusive thoughts, better sleep quality, and improved emotional regulation.',
                        functionalImpact: 'Mild to moderate improvement, engaging more with life',
                        primarySymptoms: [
                            { name: 'Reduced Intrusions', severity: 'Mild-Moderate', frequency: '2-3 times per week', duration: 'Brief episodes' },
                            { name: 'Better Sleep', severity: 'Mild', frequency: '1-2 nights per week with disturbance', duration: 'Much improved' },
                            { name: 'Less Alert', severity: 'Mild', frequency: 'In specific situations only', duration: 'Situational' }
                        ],
                        secondarySymptoms: [
                            { name: 'Emotional Connection', severity: 'Mild', notes: 'Starting to feel positive emotions again' },
                            { name: 'Facing Triggers', severity: 'Mild', notes: 'Gradually confronting avoided situations' },
                            { name: 'Emotional Stability', severity: 'Mild', notes: 'Better control over reactions' }
                        ]
                    }
                },
                'P004': {
                    1: { 
                        overallScore: '65/100', 
                        severity: 'Moderate',
                        condition: 'Social Anxiety Disorder',
                        interpretation: 'Moderate social anxiety with notable impact on work and relationships. Patient experiences intense fear of judgment and criticism.',
                        functionalImpact: 'Moderate difficulty with social interactions and public speaking',
                        primarySymptoms: [
                            { name: 'Fear of Judgment', severity: 'Moderate-Severe', frequency: 'In most social situations', duration: '5+ months' },
                            { name: 'Physical Symptoms', severity: 'Moderate', frequency: 'During social interactions', location: 'Blushing, sweating, trembling' },
                            { name: 'Anticipatory Anxiety', severity: 'Moderate', frequency: 'Before social events', duration: 'Hours to days before' }
                        ],
                        secondarySymptoms: [
                            { name: 'Social Avoidance', severity: 'Moderate', notes: 'Declining invitations, avoiding meetings' },
                            { name: 'Self-Consciousness', severity: 'Moderate-Severe', notes: 'Constant awareness of being watched' },
                            { name: 'Negative Self-Talk', severity: 'Moderate', notes: 'Harsh self-criticism after interactions' }
                        ]
                    },
                    2: { 
                        overallScore: '40/100', 
                        severity: 'Mild',
                        condition: 'Social Anxiety Disorder',
                        interpretation: 'Significant reduction in social anxiety symptoms. Patient engaging more confidently in social situations.',
                        functionalImpact: 'Minimal to mild impact, attending more social events',
                        primarySymptoms: [
                            { name: 'Reduced Fear', severity: 'Mild', frequency: 'In unfamiliar situations mainly', duration: 'Brief periods' },
                            { name: 'Fewer Physical Symptoms', severity: 'Mild', frequency: '2-3 times per week', location: 'Mild sweating occasionally' },
                            { name: 'Less Worry', severity: 'Mild', frequency: 'Before major events only', duration: 'Brief' }
                        ],
                        secondarySymptoms: [
                            { name: 'Increased Engagement', severity: 'Minimal', notes: 'Accepting invitations, participating more' },
                            { name: 'More Confident', severity: 'Mild', notes: 'Less focused on being watched' },
                            { name: 'Balanced Thinking', severity: 'Mild', notes: 'More realistic self-assessment' }
                        ]
                    }
                },
                'P005': {
                    1: { 
                        overallScore: '78/100', 
                        severity: 'Severe',
                        condition: 'Bipolar Depression',
                        interpretation: 'Severe depressive episode with significant functional impairment. Patient in depressive phase with history of mood cycling.',
                        functionalImpact: 'Severe difficulty with all aspects of daily functioning',
                        primarySymptoms: [
                            { name: 'Severe Depressed Mood', severity: 'Severe', frequency: 'Daily', duration: '6+ months' },
                            { name: 'Psychomotor Retardation', severity: 'Severe', frequency: 'Daily', duration: '5+ months' },
                            { name: 'Profound Fatigue', severity: 'Severe', frequency: 'Constant', duration: '6+ months' }
                        ],
                        secondarySymptoms: [
                            { name: 'Sleep Hypersomnia', severity: 'Severe', notes: 'Sleeping 12-14 hours per day' },
                            { name: 'Cognitive Slowing', severity: 'Severe', notes: 'Difficulty thinking, speaking slowly' },
                            { name: 'Social Withdrawal', severity: 'Severe', notes: 'Complete isolation from others' }
                        ]
                    },
                    2: { 
                        overallScore: '75/100', 
                        severity: 'Severe',
                        condition: 'Bipolar Depression',
                        interpretation: 'Depression remains severe with minimal improvement. Patient continues in depressive phase with persistent symptoms despite intervention.',
                        functionalImpact: 'Severe impairment continues with minimal change',
                        primarySymptoms: [
                            { name: 'Severe Depression', severity: 'Severe', frequency: 'Daily', duration: 'Ongoing' },
                            { name: 'Slowed Movement', severity: 'Moderate-Severe', frequency: 'Daily', duration: 'Ongoing' },
                            { name: 'Extreme Fatigue', severity: 'Severe', frequency: 'Constant', duration: 'Ongoing' }
                        ],
                        secondarySymptoms: [
                            { name: 'Excessive Sleep', severity: 'Moderate-Severe', notes: 'Still sleeping 10-12 hours' },
                            { name: 'Mental Slowness', severity: 'Moderate-Severe', notes: 'Difficulty with conversations' },
                            { name: 'Isolation Continues', severity: 'Severe', notes: 'Minimal social contact' }
                        ]
                    }
                }
            };
            
            return prsData[patientId]?.[assessmentNumber] || prsData['P001'][assessmentNumber];
        }

        function calculatePatientFnonScore_old() {
            const currentPatientId = selectedPatientData?.id || 'P001';
            const patientScores = patientFnonScores[currentPatientId] || patientFnonScores['P001'];
            
            // Calculate total score
            let totalScore = 0;
            const allTests = [
                'Gaze fixation', 'Romberg dual-task', 'Clock drawing',
                'Digit Span', 'Serial subtraction (100-7)', 'Motor sequencing',
                'Startle response', 'Interoceptive awareness',
                'Finger-to-nose', 'Heel-to-shin', 'Rapid movements',
                'Facial expression check', 'Emotional reactivity',
                'Cancellation test', 'Eye tracking'
            ];
            
            allTests.forEach(test => {
                totalScore += patientScores[test] || 0;
            });
            
            return totalScore;
        }

        function viewBlockDetails(blockType, assessmentNumber = 2) {
            // Only show detailed patient-friendly modals for patients
            // Doctors, receptionist, and clinical assistants see standard alerts
            if (currentRole !== 'patient') {
                const blockNames = {
                    'fnon': 'FNON Assessment',
                    'brain-mapping': 'Brain Mapping (EEG)',
                    'prs': 'PRS Assessment',
                    'doctor-notes': 'Doctor\'s Notes',
                    'final-report': 'Final Report',
                    'treatment-plan': 'Treatment Plan'
                };
                alert(`Viewing ${blockNames[blockType] || blockType}\\n\\nRole: ${currentRole}\\n\\nThis would open a professional clinical view with:\\n- Complete assessment data\\n- Clinical metrics & scores\\n- Charts and visualizations\\n- Historical comparisons\\n- Editable notes (if permitted)\\n- Downloadable reports`);
                return;
            }
            
            // Patient role - show detailed friendly modals with assessment-specific data
            if (blockType === 'fnon') {
                showFnonDetailsModal(assessmentNumber);
            } else if (blockType === 'brain-mapping') {
                showBrainMappingModal(assessmentNumber);
            } else if (blockType === 'prs') {
                showPRSModal(assessmentNumber);
            } else if (blockType === 'doctor-notes') {
                showDoctorNotesModal(assessmentNumber);
            } else if (blockType === 'final-report') {
                showFinalReportModal(assessmentNumber);
            } else {
                const blockNames = {
                    'treatment-plan': 'Treatment Plan'
                };
                alert(`Viewing Detailed Report\\n\\nBlock: ${blockNames[blockType] || blockType}\\n\\nThis would open a comprehensive view with:\\n- Full assessment data\\n- Charts and visualizations\\n- Historical comparisons\\n- Downloadable reports`);
            }
        }

        function showBrainMappingModal(assessmentNumber = 2) {
            const currentPatientId = selectedPatientData?.id || 'P001';
            const brainData = getPatientBrainMappingData(currentPatientId, assessmentNumber);
            const patientName = selectedPatientData ? `${selectedPatientData.firstName} ${selectedPatientData.lastName}` : 'Patient';

            const modalHtml = `
                <div class="modal-overlay" id="brainMappingModal" onclick="closeBrainMappingModal(event)">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <div>
                                <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 4px;">Brain Mapping Report</h2>
                                <p style="font-size: 14px; opacity: 0.9;">Patient: ${patientName} (${currentPatientId}) • EEG Analysis</p>
                            </div>
                            <button class="modal-close" onclick="closeBrainMappingModal()">
                                <i class="fa-solid fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div style="background: #eff6ff; padding: 16px; border-radius: 10px; border-left: 4px solid #3b82f6; margin-bottom: 24px;">
                                <p style="font-size: 13px; color: #1e40af; line-height: 1.6;">
                                    <strong>What is Brain Mapping?</strong><br>
                                    We measured your brain's electrical activity while you were relaxed. Think of it like taking your brain's pulse - it helps us understand how different parts of your brain are working.
                                </p>
                            </div>

                            <!-- Summary Section -->
                            <div class="summary-section" style="margin-bottom: 24px;">
                                <h3 style="font-size: 20px; font-weight: 700; color: #0f172a; margin-bottom: 8px;">
                                    <i class="fa-solid fa-wave-square" style="color: var(--orange-primary); margin-right: 8px;"></i>
                                    Your Brain Wave Patterns
                                </h3>
                                <p style="font-size: 13px; color: #64748b; margin-bottom: 16px;">Different brain waves show different mental states</p>
                                <div class="summary-grid">
                                    <div class="summary-card">
                                        <p class="summary-label">Main Rhythm</p>
                                        <p class="summary-value" style="font-size: 24px;">${brainData.dominantFrequency}</p>
                                        <p class="summary-detail">your brain's natural frequency</p>
                                    </div>
                                    <div class="summary-card" style="border-left-color: #8b5cf6;">
                                        <p class="summary-label">Alpha Waves</p>
                                        <p class="summary-value" style="font-size: 24px;">${brainData.alphaActivity}</p>
                                        <p class="summary-detail">calm & relaxed state</p>
                                    </div>
                                    <div class="summary-card" style="border-left-color: #f59e0b;">
                                        <p class="summary-label">Beta Waves</p>
                                        <p class="summary-value" style="font-size: 24px;">${brainData.betaActivity}</p>
                                        <p class="summary-detail">thinking & focus</p>
                                    </div>
                                </div>
                                <div class="summary-grid" style="margin-top: 16px;">
                                    <div class="summary-card" style="border-left-color: #06b6d4;">
                                        <p class="summary-label">Theta Waves</p>
                                        <p class="summary-value" style="font-size: 24px;">${brainData.thetaActivity}</p>
                                        <p class="summary-detail">creativity & learning</p>
                                    </div>
                                    <div class="summary-card" style="border-left-color: #64748b;">
                                        <p class="summary-label">Delta Waves</p>
                                        <p class="summary-value" style="font-size: 24px;">${brainData.deltaActivity}</p>
                                        <p class="summary-detail">deep rest & healing</p>
                                    </div>
                                    <div class="summary-card" style="border-left-color: #ef4444;">
                                        <p class="summary-label">Brain Balance</p>
                                        <p style="font-size: 14px; font-weight: 700; color: #0f172a; margin-top: 8px;">${brainData.asymmetry}</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Clinical Findings -->
                            <div class="network-section">
                                <h3 style="font-size: 18px; font-weight: 700; color: var(--orange-primary); margin-bottom: 8px;">
                                    <i class="fa-solid fa-clipboard-list" style="margin-right: 8px;"></i>
                                    What We Found
                                </h3>
                                <p style="font-size: 13px; color: #64748b; margin-bottom: 12px;">Here's what your brain activity tells us</p>
                                <div style="display: grid; gap: 10px;">
                                    ${brainData.findings.map(finding => `
                                        <div style="display: flex; align-items: start; gap: 10px; padding: 12px; background: #f8fafc; border-radius: 8px; border-left: 4px solid #3b82f6;">
                                            <i class="fa-solid fa-circle-check" style="color: #3b82f6; margin-top: 2px;"></i>
                                            <span style="font-size: 14px; color: #334155; font-weight: 500;">${finding}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- Recommendation -->
                            <div class="interpretation-box" style="border-color: var(--orange-primary); background: rgba(244, 121, 32, 0.1); color: #b45309; margin-top: 24px;">
                                <p style="font-weight: 700; margin-bottom: 4px;">
                                    <i class="fa-solid fa-lightbulb" style="margin-right: 8px;"></i>
                                    What's Next - Your Personalized Program
                                </p>
                                <p style="font-size: 14px; font-weight: 600; line-height: 1.5;">${brainData.recommendation}</p>
                            </div>

                            <!-- Assessment Info -->
                            <div style="margin-top: 24px; padding: 16px; background: #f8fafc; border-radius: 10px; border: 1px solid #e2e8f0;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <p style="font-size: 11px; color: #64748b; font-weight: 700; text-transform: uppercase; margin-bottom: 4px;">Analyzed by</p>
                                        <p style="font-size: 14px; font-weight: 700; color: #0f172a;">Dr. James Wilson - Neurologist</p>
                                    </div>
                                    <div style="text-align: right;">
                                        <p style="font-size: 11px; color: #64748b; font-weight: 700; text-transform: uppercase; margin-bottom: 4px;">Assessment Date</p>
                                        <p style="font-size: 14px; font-weight: 700; color: #0f172a;">${new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('brainMappingModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            setTimeout(() => {
                document.getElementById('brainMappingModal').classList.add('active');
            }, 10);
        }

        function closeBrainMappingModal(event) {
            if (!event || event.target.id === 'brainMappingModal') {
                const modal = document.getElementById('brainMappingModal');
                if (modal) {
                    modal.classList.remove('active');
                    setTimeout(() => modal.remove(), 300);
                }
            }
        }

        function showPRSModal(assessmentNumber = 2) {
            const currentPatientId = selectedPatientData?.id || 'P001';
            const prsData = getPatientPRSData(currentPatientId, assessmentNumber);
            const patientName = selectedPatientData ? `${selectedPatientData.firstName} ${selectedPatientData.lastName}` : 'Patient';

            const getSeverityColor = (severity) => {
                if (!severity) return '#0ea5e9';
                const lowerSeverity = severity.toLowerCase();
                if (lowerSeverity.includes('severe')) return '#ef4444';
                if (lowerSeverity.includes('moderate')) return '#f59e0b';
                return '#0ea5e9';
            };

            const getSeverityBg = (severity) => {
                if (!severity) return 'rgba(14, 165, 233, 0.1)';
                const lowerSeverity = severity.toLowerCase();
                if (lowerSeverity.includes('severe')) return '#fee2e2';
                if (lowerSeverity.includes('moderate')) return '#fef3c7';
                return '#dbeafe';
            };

            const modalHtml = `
                <div class="modal-overlay" id="prsModal" onclick="closePRSModal(event)">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <div>
                                <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 4px;">Patient Reported Symptoms</h2>
                                <p style="font-size: 14px; opacity: 0.9;">Patient: ${patientName} (${currentPatientId}) • Condition: ${prsData.condition}</p>
                            </div>
                            <button class="modal-close" onclick="closePRSModal()">
                                <i class="fa-solid fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div style="background: #eff6ff; padding: 16px; border-radius: 10px; border-left: 4px solid #3b82f6; margin-bottom: 24px;">
                                <p style="font-size: 13px; color: #1e40af; line-height: 1.6;">
                                    <strong>About PRS:</strong><br>
                                    This assessment captures the symptoms you're experiencing in your own words. It helps us understand how ${prsData.condition} affects your daily life.
                                </p>
                            </div>

                            <!-- Overall Assessment -->
                            <div class="summary-section" style="margin-bottom: 24px;">
                                <h3 style="font-size: 20px; font-weight: 700; color: #0f172a; margin-bottom: 16px;">
                                    <i class="fa-solid fa-chart-line" style="color: var(--orange-primary); margin-right: 8px;"></i>
                                    Overall Assessment
                                </h3>
                                <div class="summary-grid">
                                    <div class="summary-card">
                                        <p class="summary-label">Symptom Score</p>
                                        <p class="summary-value" style="font-size: 28px; color: ${getSeverityColor(prsData.interpretation)};">${prsData.overallScore}</p>
                                        <p class="summary-detail">higher score = more symptoms</p>
                                    </div>
                                    <div class="summary-card" style="border-left-color: #8b5cf6;">
                                        <p class="summary-label">Functional Impact</p>
                                        <p style="font-size: 14px; font-weight: 700; color: #0f172a; margin-top: 8px; line-height: 1.4;">${prsData.functionalImpact}</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Primary Symptoms -->
                            <div class="network-section" style="margin-bottom: 24px;">
                                <h3 style="font-size: 18px; font-weight: 700; color: var(--orange-primary); margin-bottom: 8px;">
                                    <i class="fa-solid fa-clipboard-list" style="margin-right: 8px;"></i>
                                    Primary Symptoms
                                </h3>
                                <p style="font-size: 13px; color: #64748b; margin-bottom: 12px;">Main symptoms related to ${prsData.condition}</p>
                                <div style="display: grid; gap: 12px;">
                                    ${prsData.primarySymptoms.map(symptom => `
                                        <div style="padding: 16px; background: #f8fafc; border-radius: 10px; border-left: 4px solid ${getSeverityColor(symptom.severity)};">
                                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                                <p style="font-size: 15px; font-weight: 700; color: #0f172a;">${symptom.name}</p>
                                                <span style="background: ${getSeverityBg(symptom.severity)}; color: ${getSeverityColor(symptom.severity)}; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700;">
                                                    ${symptom.severity}
                                                </span>
                                            </div>
                                            <div style="display: grid; gap: 4px; font-size: 13px; color: #64748b;">
                                                <p><strong>Frequency:</strong> ${symptom.frequency}</p>
                                                <p><strong>${symptom.location ? 'Location' : 'Duration'}:</strong> ${symptom.location || symptom.duration}</p>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- Secondary Symptoms -->
                            <div class="network-section" style="margin-bottom: 24px;">
                                <h3 style="font-size: 18px; font-weight: 700; color: #64748b; margin-bottom: 8px;">
                                    <i class="fa-solid fa-list-ul" style="margin-right: 8px;"></i>
                                    Additional Symptoms
                                </h3>
                                <p style="font-size: 13px; color: #64748b; margin-bottom: 12px;">Other symptoms affecting quality of life</p>
                                <div style="display: grid; gap: 10px;">
                                    ${prsData.secondarySymptoms.map(symptom => `
                                        <div style="display: flex; align-items: start; gap: 12px; padding: 12px; background: #f8fafc; border-radius: 8px;">
                                            <div style="width: 8px; height: 8px; border-radius: 50%; background: ${getSeverityColor(symptom.severity)}; margin-top: 6px; flex-shrink: 0;"></div>
                                            <div style="flex: 1;">
                                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 4px;">
                                                    <p style="font-size: 14px; font-weight: 700; color: #0f172a;">${symptom.name}</p>
                                                    <span style="font-size: 11px; font-weight: 700; color: ${getSeverityColor(symptom.severity)};">${symptom.severity}</span>
                                                </div>
                                                <p style="font-size: 13px; color: #64748b;">${symptom.notes}</p>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- Clinical Interpretation -->
                            <div class="interpretation-box" style="border-color: var(--orange-primary); background: rgba(244, 121, 32, 0.1); color: #b45309; margin-top: 24px;">
                                <p style="font-weight: 700; margin-bottom: 4px;">
                                    <i class="fa-solid fa-user-doctor" style="margin-right: 8px;"></i>
                                    Clinical Interpretation
                                </p>
                                <p style="font-size: 14px; font-weight: 600; line-height: 1.5;">${prsData.interpretation}</p>
                            </div>

                            <!-- Assessment Info -->
                            <div style="margin-top: 24px; padding: 16px; background: #f8fafc; border-radius: 10px; border: 1px solid #e2e8f0;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <p style="font-size: 11px; color: #64748b; font-weight: 700; text-transform: uppercase; margin-bottom: 4px;">Reported by</p>
                                        <p style="font-size: 14px; font-weight: 700; color: #0f172a;">Patient Self-Assessment</p>
                                    </div>
                                    <div style="text-align: right;">
                                        <p style="font-size: 11px; color: #64748b; font-weight: 700; text-transform: uppercase; margin-bottom: 4px;">Assessment Date</p>
                                        <p style="font-size: 14px; font-weight: 700; color: #0f172a;">${new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('prsModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            setTimeout(() => {
                document.getElementById('prsModal').classList.add('active');
            }, 10);
        }

        function closePRSModal(event) {
            if (!event || event.target.id === 'prsModal') {
                const modal = document.getElementById('prsModal');
                if (modal) {
                    modal.classList.remove('active');
                    setTimeout(() => modal.remove(), 300);
                }
            }
        }

        function showDoctorNotesModal(assessmentNumber = 2) {
            const currentPatientId = selectedPatientData?.id || 'P001';
            const doctorNotes = patientDoctorNotes[currentPatientId] || patientDoctorNotes['P001'];
            const patientName = selectedPatientData ? `${selectedPatientData.firstName} ${selectedPatientData.lastName}` : 'Patient';

            const modalHtml = `
                <div class="modal-overlay" id="doctorNotesModal" onclick="closeDoctorNotesModal(event)">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <div>
                                <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 4px;">Doctor's Notes & Comments</h2>
                                <p style="font-size: 14px; opacity: 0.9;">Clinical observations, recommendations, and medication notes for ${patientName}</p>
                            </div>
                            <button class="modal-close" onclick="closeDoctorNotesModal()">
                                <i class="fa-solid fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <!-- Patient Info -->
                            <div style="background: #f8fafc; padding: 16px; border-radius: 10px; margin-bottom: 24px; border-left: 4px solid var(--orange-primary);">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                    <div style="width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(135deg, var(--orange-primary), #dc6027); display: flex; align-items: center; justify-content: center; color: white; font-size: 16px; font-weight: 700;">
                                        ${patientName.split(' ').map(n => n[0]).join('')}
                                    </div>
                                    <div>
                                        <p style="font-size: 16px; font-weight: 700; color: #0f172a;">${patientName}</p>
                                        <p style="font-size: 13px; color: #64748b;">ID: ${currentPatientId} • ${doctorNotes.condition}</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Clinical Observations Section -->
                            <div class="network-section" style="margin-bottom: 24px;">
                                <h3 style="font-size: 20px; font-weight: 700; color: var(--orange-primary); margin-bottom: 8px;">
                                    <i class="fa-solid fa-clipboard-list" style="margin-right: 8px;"></i>
                                    Clinical Observations
                                </h3>
                                <p style="font-size: 13px; color: #64748b; margin-bottom: 16px;">Assessment-specific clinical notes and observations</p>
                                
                                <!-- FNON Notes -->
                                <div style="margin-bottom: 16px; padding: 16px; background: #f8fafc; border-radius: 10px; border-left: 4px solid #0ea5e9;">
                                    <h4 style="font-size: 14px; font-weight: 700; color: #0f172a; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                                        <i class="fa-solid fa-list-check" style="color: #0ea5e9;"></i>
                                        FNON Assessment Notes
                                    </h4>
                                    <p style="font-size: 14px; color: #334155; line-height: 1.6;">${doctorNotes.clinicalObservations.fnon}</p>
                                </div>

                                <!-- Brain Mapping Notes -->
                                <div style="margin-bottom: 16px; padding: 16px; background: #f8fafc; border-radius: 10px; border-left: 4px solid #8b5cf6;">
                                    <h4 style="font-size: 14px; font-weight: 700; color: #0f172a; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                                        <i class="fa-solid fa-brain" style="color: #8b5cf6;"></i>
                                        Brain Mapping & EEG Report Notes
                                    </h4>
                                    <p style="font-size: 14px; color: #334155; line-height: 1.6;">${doctorNotes.clinicalObservations.brainMapping}</p>
                                </div>

                                <!-- PRS Notes -->
                                ${doctorNotes.clinicalObservations.prs ? `
                                <div style="padding: 16px; background: #f8fafc; border-radius: 10px; border-left: 4px solid #f59e0b;">
                                    <h4 style="font-size: 14px; font-weight: 700; color: #0f172a; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                                        <i class="fa-solid fa-comments" style="color: #f59e0b;"></i>
                                        Patient Reported Symptoms Notes
                                    </h4>
                                    <p style="font-size: 14px; color: #334155; line-height: 1.6;">${doctorNotes.clinicalObservations.prs}</p>
                                </div>
                                ` : ''}
                            </div>

                            <!-- Recommendations Section -->
                            <div class="network-section" style="margin-bottom: 24px;">
                                <h3 style="font-size: 18px; font-weight: 700; color: #0f172a; margin-bottom: 12px;">
                                    <i class="fa-solid fa-lightbulb" style="color: var(--orange-primary); margin-right: 8px;"></i>
                                    Recommendations
                                </h3>
                                <div style="padding: 16px; background: rgba(244, 121, 32, 0.1); border-radius: 10px; border-left: 4px solid var(--orange-primary);">
                                    <p style="font-size: 14px; color: #0f172a; line-height: 1.7; font-weight: 500;">${doctorNotes.recommendations}</p>
                                </div>
                            </div>

                            <!-- Prescribed Medications Section -->
                            <div class="network-section">
                                <h3 style="font-size: 18px; font-weight: 700; color: #0f172a; margin-bottom: 12px;">
                                    <i class="fa-solid fa-pills" style="color: #ef4444; margin-right: 8px;"></i>
                                    Prescribed Medications
                                </h3>
                                <div style="padding: 16px; background: #fef2f2; border-radius: 10px; border-left: 4px solid #ef4444;">
                                    <p style="font-size: 14px; color: #0f172a; line-height: 1.7; font-weight: 500;">${doctorNotes.medications}</p>
                                </div>
                            </div>

                            <!-- Doctor Info -->
                            <div style="margin-top: 24px; padding: 16px; background: #f8fafc; border-radius: 10px; border: 1px solid #e2e8f0;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <p style="font-size: 11px; color: #64748b; font-weight: 700; text-transform: uppercase; margin-bottom: 4px;">Prepared by</p>
                                        <p style="font-size: 14px; font-weight: 700; color: #0f172a;">Dr. James Wilson - Neurologist</p>
                                    </div>
                                    <div style="text-align: right;">
                                        <p style="font-size: 11px; color: #64748b; font-weight: 700; text-transform: uppercase; margin-bottom: 4px;">Last Updated</p>
                                        <p style="font-size: 14px; font-weight: 700; color: #0f172a;">${new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('doctorNotesModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            setTimeout(() => {
                document.getElementById('doctorNotesModal').classList.add('active');
            }, 10);
        }

        function closeDoctorNotesModal(event) {
            if (!event || event.target.id === 'doctorNotesModal') {
                const modal = document.getElementById('doctorNotesModal');
                if (modal) {
                    modal.classList.remove('active');
                    setTimeout(() => modal.remove(), 300);
                }
            }
        }

        function showFinalReportModal(assessmentNumber = 2) {
            if (!selectedPatientData) return;
            const patientId = selectedPatientData.id;
            const reportData = patientFinalReports[patientId];
            if (!reportData) return;

            // Only show "All Success Case - Deep Dive" for successful cases (not P005 with guarded prognosis)
            const isSuccessCase = patientId !== 'P005';
            const subtitleHTML = isSuccessCase ? '<p style="color: #6b7280; font-size: 0.875rem; margin-top: 0.5rem;">All Success Case - Deep Dive Analysis</p>' : '';

            // Generate random data for assessments
            const randomData = {
                qolMobility: Math.floor(Math.random() * 5) + 1,
                qolSelfCare: Math.floor(Math.random() * 5) + 1,
                qolUsualActivities: Math.floor(Math.random() * 5) + 1,
                qolPainDiscomfort: Math.floor(Math.random() * 5) + 1,
                qolDepressionAnxiety: Math.floor(Math.random() * 5) + 1,
                qolVAS: Math.floor(Math.random() * 10) + 1,
                compassOrthostatic: Math.floor(Math.random() * 41),
                compassVasomotor: Math.floor(Math.random() * 41),
                compassSecretomotor: Math.floor(Math.random() * 41),
                compassGastrointestinal: Math.floor(Math.random() * 41),
                compassBladder: Math.floor(Math.random() * 41),
                compassPupillomotor: Math.floor(Math.random() * 41),
                amtsScore: Math.floor(Math.random() * 11),
                mocaScore: Math.floor(Math.random() * 31),
                dsrsScore: Math.floor(Math.random() * 55),
                gdsStage: `Stage ${Math.floor(Math.random() * 5) + 1}`,
                iadlScore: Math.floor(Math.random() * 9),
                dassDepression: Math.floor(Math.random() * 29),
                dassAnxiety: Math.floor(Math.random() * 21),
                dassStress: Math.floor(Math.random() * 35),
            };

            const modalHTML = `
                <div class="modal-overlay" id="finalReportModal" onclick="closeFinalReportModal(event)">
                    <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;" onclick="event.stopPropagation()">
                        <button class="modal-close" onclick="closeFinalReportModal()">
                            <i class="fas fa-times"></i>
                        </button>
                        
                        <div style="padding: 2rem;">
                            <!-- SOZO Header -->
                            <div style="text-align: center; border-bottom: 4px solid rgb(244, 121, 32); padding-bottom: 1rem; margin-bottom: 1.5rem;">
                                <h1 style="font-size: 2.25rem; font-weight: 900; color: rgb(244, 121, 32); margin-bottom: 0.5rem; letter-spacing: 0.05em;">SOZ&#937; BRAIN CENTER</h1>
                                <p style="font-size: 0.75rem; color: #64748b;">
                                    <i class="fas fa-phone" style="margin-right: 0.25rem;"></i> +357 25 864013 | 
                                    <i class="fas fa-envelope" style="margin-right: 0.25rem;"></i> info@sozobraincenter.com | 
                                    <i class="fas fa-globe" style="margin-right: 0.25rem;"></i> www.sozobraincenter.com
                                </p>
                                <p style="font-size: 0.625rem; color: #94a3b8; margin-top: 0.75rem;">Privacy Notice available at www.sozobraincenter.com</p>
                            </div>

                            <!-- Report Title -->
                            <div style="background: rgb(244, 121, 32); color: white; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; text-align: center;">
                                <h2 style="font-size: 1.5rem; font-weight: 700;">ASSESSMENT FINDINGS REPORT</h2>
                                <p style="font-size: 0.875rem; margin-top: 0.25rem; opacity: 0.9;">${reportData.condition.toUpperCase()}</p>
                                ${subtitleHTML}
                            </div>

                            <!-- Patient Information Section -->
                            <div style="background: #f8fafc; padding: 1.5rem; border-radius: 0.5rem; border: 2px solid #cbd5e1; margin-bottom: 1.5rem;">
                                <h3 style="font-size: 1.125rem; font-weight: 700; color: #0f172a; margin-bottom: 1rem;">Patient Information</h3>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                                    <div style="background: white; padding: 0.75rem; border-radius: 0.5rem;">
                                        <p style="font-size: 0.625rem; font-weight: 700; color: #64748b; text-transform: uppercase;">Name/Surname</p>
                                        <p style="font-size: 0.875rem; font-weight: 700; color: #0f172a;">${reportData.name}</p>
                                    </div>
                                    <div style="background: white; padding: 0.75rem; border-radius: 0.5rem;">
                                        <p style="font-size: 0.625rem; font-weight: 700; color: #64748b; text-transform: uppercase;">Date</p>
                                        <p style="font-size: 0.875rem; font-weight: 700; color: #0f172a;">${reportData.assessmentDate}</p>
                                    </div>
                                    <div style="background: white; padding: 0.75rem; border-radius: 0.5rem;">
                                        <p style="font-size: 0.625rem; font-weight: 700; color: #64748b; text-transform: uppercase;">Date of Birth</p>
                                        <p style="font-size: 0.875rem; font-weight: 700; color: #0f172a;">${reportData.age} years</p>
                                    </div>
                                    <div style="background: white; padding: 0.75rem; border-radius: 0.5rem;">
                                        <p style="font-size: 0.625rem; font-weight: 700; color: #64748b; text-transform: uppercase;">Patient ID</p>
                                        <p style="font-size: 0.875rem; font-weight: 700; color: #0f172a;">${reportData.patientId}</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Multifactorial Assessment Report Header -->
                            <div style="background: linear-gradient(to right, #fef3c7, #fed7aa); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; border-left: 4px solid rgb(244, 121, 32);">
                                <h3 style="font-size: 1.125rem; font-weight: 700; color: rgb(180, 83, 9); display: flex; align-items: center;">
                                    <i class="fas fa-clipboard-list" style="margin-right: 0.5rem;"></i>Multifactorial Assessment Report
                                </h3>
                            </div>

                            <!-- Quality of Life Section -->
                            <div style="margin-bottom: 1.5rem;">
                                <h4 style="font-size: 1rem; font-weight: 700; color: #0f172a; margin-bottom: 0.75rem; border-bottom: 2px solid rgb(244, 121, 32); padding-bottom: 0.5rem; display: flex; align-items: center;">
                                    <i class="fas fa-heart" style="margin-right: 0.5rem; color: #64748b;"></i>Quality of Life
                                </h4>
                                <p style="font-size: 0.75rem; font-weight: 700; color: #475569; margin-bottom: 0.5rem;">General Health (EQ-5D-5L)</p>
                                <div style="overflow-x: auto; margin-bottom: 0.75rem;">
                                    <table style="width: 100%; border-collapse: collapse; border: 1px solid #cbd5e1; font-size: 0.75rem;">
                                        <thead style="background: linear-gradient(to right, #e2e8f0, #f1f5f9);">
                                            <tr>
                                                <th style="border: 1px solid #cbd5e1; padding: 0.5rem; text-align: left;">Date Visit</th>
                                                <th style="border: 1px solid #cbd5e1; padding: 0.5rem; text-align: center;">Mobility</th>
                                                <th style="border: 1px solid #cbd5e1; padding: 0.5rem; text-align: center;">Self-Care</th>
                                                <th style="border: 1px solid #cbd5e1; padding: 0.5rem; text-align: center;">Activities</th>
                                                <th style="border: 1px solid #cbd5e1; padding: 0.5rem; text-align: center;">Pain</th>
                                                <th style="border: 1px solid #cbd5e1; padding: 0.5rem; text-align: center;">Mood</th>
                                                <th style="border: 1px solid #cbd5e1; padding: 0.5rem; text-align: center;">VAS</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr style="background: #dbeafe;">
                                                <td style="border: 1px solid #cbd5e1; padding: 0.5rem;">${reportData.assessmentDate}</td>
                                                <td style="border: 1px solid #cbd5e1; padding: 0.5rem; text-align: center; font-weight: 600;">${randomData.qolMobility}</td>
                                                <td style="border: 1px solid #cbd5e1; padding: 0.5rem; text-align: center; font-weight: 600;">${randomData.qolSelfCare}</td>
                                                <td style="border: 1px solid #cbd5e1; padding: 0.5rem; text-align: center; font-weight: 600;">${randomData.qolUsualActivities}</td>
                                                <td style="border: 1px solid #cbd5e1; padding: 0.5rem; text-align: center; font-weight: 600;">${randomData.qolPainDiscomfort}</td>
                                                <td style="border: 1px solid #cbd5e1; padding: 0.5rem; text-align: center; font-weight: 600;">${randomData.qolDepressionAnxiety}</td>
                                                <td style="border: 1px solid #cbd5e1; padding: 0.5rem; text-align: center; font-weight: 600;">${randomData.qolVAS}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <p style="font-size: 0.625rem; color: #64748b; font-style: italic;">Scale: 1=No problem, 2=Slight, 3=Moderate, 4=Severe, 5=Unable/Extreme</p>
                            </div>

                            <!-- Autonomic Nervous System Assessment -->
                            <div style="margin-bottom: 1.5rem;">
                                <h4 style="font-size: 1rem; font-weight: 700; color: #0f172a; margin-bottom: 0.75rem; border-bottom: 2px solid rgb(244, 121, 32); padding-bottom: 0.5rem; display: flex; align-items: center;">
                                    <i class="fas fa-wave-square" style="margin-right: 0.5rem; color: #64748b;"></i>Autonomic Nervous System (COMPASS-31)
                                </h4>
                                <div style="overflow-x: auto; margin-bottom: 0.75rem;">
                                    <table style="width: 100%; border-collapse: collapse; border: 1px solid #cbd5e1; font-size: 0.75rem;">
                                        <thead style="background: linear-gradient(to right, #e2e8f0, #f1f5f9);">
                                            <tr>
                                                <th style="border: 1px solid #cbd5e1; padding: 0.5rem; text-align: left;">Date Visit</th>
                                                <th style="border: 1px solid #cbd5e1; padding: 0.5rem; text-align: center;">Orthostatic</th>
                                                <th style="border: 1px solid #cbd5e1; padding: 0.5rem; text-align: center;">Vasomotor</th>
                                                <th style="border: 1px solid #cbd5e1; padding: 0.5rem; text-align: center;">Secretomotor</th>
                                                <th style="border: 1px solid #cbd5e1; padding: 0.5rem; text-align: center;">GI</th>
                                                <th style="border: 1px solid #cbd5e1; padding: 0.5rem; text-align: center;">Bladder</th>
                                                <th style="border: 1px solid #cbd5e1; padding: 0.5rem; text-align: center;">Pupil</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr style="background: #f8fafc;">
                                                <td style="border: 1px solid #cbd5e1; padding: 0.5rem;">${reportData.assessmentDate}</td>
                                                <td style="border: 1px solid #cbd5e1; padding: 0.5rem; text-align: center; font-weight: 600;">${randomData.compassOrthostatic}</td>
                                                <td style="border: 1px solid #cbd5e1; padding: 0.5rem; text-align: center; font-weight: 600;">${randomData.compassVasomotor}</td>
                                                <td style="border: 1px solid #cbd5e1; padding: 0.5rem; text-align: center; font-weight: 600;">${randomData.compassSecretomotor}</td>
                                                <td style="border: 1px solid #cbd5e1; padding: 0.5rem; text-align: center; font-weight: 600;">${randomData.compassGastrointestinal}</td>
                                                <td style="border: 1px solid #cbd5e1; padding: 0.5rem; text-align: center; font-weight: 600;">${randomData.compassBladder}</td>
                                                <td style="border: 1px solid #cbd5e1; padding: 0.5rem; text-align: center; font-weight: 600;">${randomData.compassPupillomotor}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Cognitive Assessments -->
                            <div style="margin-bottom: 1.5rem;">
                                <!-- AMTS -->
                                <div style="margin-bottom: 1rem;">
                                    <p style="font-size: 0.875rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem;">AMTS – Abbreviated Mental Test Score</p>
                                    <table style="width: 100%; border-collapse: collapse; border: 1px solid #cbd5e1; margin-bottom: 0.5rem; font-size: 0.75rem;">
                                        <thead style="background: #e2e8f0;">
                                            <tr>
                                                <th style="border: 1px solid #cbd5e1; padding: 0.75rem; font-size: 0.75rem; font-weight: 700; text-align: left;">Date Visit</th>
                                                <th style="border: 1px solid #cbd5e1; padding: 0.75rem; font-size: 0.75rem; font-weight: 700; text-align: center;">AMTS Score</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td style="border: 1px solid #cbd5e1; padding: 0.75rem;">${reportData.assessmentDate} First visit</td>
                                                <td style="border: 1px solid #cbd5e1; padding: 0.75rem; text-align: center; font-weight: 700; font-size: 1rem;">${randomData.amtsScore}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <p style="font-size: 0.625rem; color: #64748b; font-style: italic;">A score of 6 or less suggests delirium or dementia, although further tests are necessary to confirm the diagnosis.</p>
                                </div>

                                <!-- MoCA -->
                                <div style="margin-bottom: 1rem;">
                                    <p style="font-size: 0.875rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem;">MoCA – Montreal Cognitive Assessment</p>
                                    <table style="width: 100%; border-collapse: collapse; border: 1px solid #cbd5e1; font-size: 0.75rem;">
                                        <thead style="background: #e2e8f0;">
                                            <tr>
                                                <th style="border: 1px solid #cbd5e1; padding: 0.75rem; font-size: 0.75rem; font-weight: 700; text-align: left;">Date Visit</th>
                                                <th style="border: 1px solid #cbd5e1; padding: 0.75rem; font-size: 0.75rem; font-weight: 700; text-align: center;">MoCA Score</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td style="border: 1px solid #cbd5e1; padding: 0.75rem;">${reportData.assessmentDate} First visit</td>
                                                <td style="border: 1px solid #cbd5e1; padding: 0.75rem; text-align: center; font-weight: 700; font-size: 1rem;">${randomData.mocaScore}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <!-- DSRS -->
                                <div style="margin-bottom: 1rem;">
                                    <p style="font-size: 0.875rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem;">DSRS – Dementia Severity Rating Scale</p>
                                    <table style="width: 100%; border-collapse: collapse; border: 1px solid #cbd5e1; margin-bottom: 0.5rem; font-size: 0.75rem;">
                                        <thead style="background: #e2e8f0;">
                                            <tr>
                                                <th style="border: 1px solid #cbd5e1; padding: 0.75rem; font-size: 0.75rem; font-weight: 700; text-align: left;">Date Visit</th>
                                                <th style="border: 1px solid #cbd5e1; padding: 0.75rem; font-size: 0.75rem; font-weight: 700; text-align: center;">DSRS Score</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td style="border: 1px solid #cbd5e1; padding: 0.75rem;">${reportData.assessmentDate} First visit</td>
                                                <td style="border: 1px solid #cbd5e1; padding: 0.75rem; text-align: center; font-weight: 700; font-size: 1rem;">${randomData.dsrsScore}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <p style="font-size: 0.625rem; color: #64748b; font-style: italic;">0-18: Mild, 19-36: Moderate, 37-54: Severe</p>
                                </div>

                                <!-- GDS -->
                                <div style="margin-bottom: 1rem;">
                                    <p style="font-size: 0.875rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem;">GDS – Global Deterioration Scale</p>
                                    <table style="width: 100%; border-collapse: collapse; border: 1px solid #cbd5e1; font-size: 0.75rem;">
                                        <thead style="background: #e2e8f0;">
                                            <tr>
                                                <th style="border: 1px solid #cbd5e1; padding: 0.75rem; font-size: 0.75rem; font-weight: 700; text-align: left;">Date Visit</th>
                                                <th style="border: 1px solid #cbd5e1; padding: 0.75rem; font-size: 0.75rem; font-weight: 700; text-align: center;">GDS Stage</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td style="border: 1px solid #cbd5e1; padding: 0.75rem;">${reportData.assessmentDate} First visit</td>
                                                <td style="border: 1px solid #cbd5e1; padding: 0.75rem; text-align: center; font-weight: 700;">${randomData.gdsStage}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <!-- IADL -->
                                <div style="margin-bottom: 1rem;">
                                    <p style="font-size: 0.875rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem;">IADL – Lawton Instrumental Activities of Daily Living Scale</p>
                                    <table style="width: 100%; border-collapse: collapse; border: 1px solid #cbd5e1; margin-bottom: 0.5rem; font-size: 0.75rem;">
                                        <thead style="background: #e2e8f0;">
                                            <tr>
                                                <th style="border: 1px solid #cbd5e1; padding: 0.75rem; font-size: 0.75rem; font-weight: 700; text-align: left;">Date Visit</th>
                                                <th style="border: 1px solid #cbd5e1; padding: 0.75rem; font-size: 0.75rem; font-weight: 700; text-align: center;">IADL Score</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td style="border: 1px solid #cbd5e1; padding: 0.75rem;">${reportData.assessmentDate} First visit</td>
                                                <td style="border: 1px solid #cbd5e1; padding: 0.75rem; text-align: center; font-weight: 700; font-size: 1rem;">${randomData.iadlScore}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <p style="font-size: 0.625rem; color: #64748b; font-style: italic;">Score ranges from 0 (low function, dependent) to 8 (high function, independent).</p>
                                </div>
                            </div>

                            <!-- Mental Health Section -->
                            <div style="margin-bottom: 1.5rem;">
                                <h4 style="font-size: 1rem; font-weight: 700; color: #0f172a; margin-bottom: 0.75rem; border-bottom: 2px solid rgb(244, 121, 32); padding-bottom: 0.5rem;">Mental Health</h4>
                                <p style="font-size: 0.875rem; font-weight: 700; color: #475569; margin-bottom: 0.5rem;">Assessment of Psychological Distress</p>
                                <p style="font-size: 0.875rem; font-weight: 700; color: #1e293b; margin-bottom: 0.75rem;">DASS-21</p>
                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse; border: 1px solid #cbd5e1; font-size: 0.75rem;">
                                        <thead style="background: #e2e8f0;">
                                            <tr>
                                                <th style="border: 1px solid #cbd5e1; padding: 0.75rem; font-size: 0.75rem; font-weight: 700; text-align: left;">Date Visit</th>
                                                <th style="border: 1px solid #cbd5e1; padding: 0.75rem; font-size: 0.75rem; font-weight: 700; text-align: center;">Depression<br/>(0-28)</th>
                                                <th style="border: 1px solid #cbd5e1; padding: 0.75rem; font-size: 0.75rem; font-weight: 700; text-align: center;">Anxiety<br/>(0-20)</th>
                                                <th style="border: 1px solid #cbd5e1; padding: 0.75rem; font-size: 0.75rem; font-weight: 700; text-align: center;">Stress<br/>(0-34)</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td style="border: 1px solid #cbd5e1; padding: 0.75rem;">${reportData.assessmentDate} First visit</td>
                                                <td style="border: 1px solid #cbd5e1; padding: 0.75rem; text-align: center; font-weight: 700;">${randomData.dassDepression}</td>
                                                <td style="border: 1px solid #cbd5e1; padding: 0.75rem; text-align: center; font-weight: 700;">${randomData.dassAnxiety}</td>
                                                <td style="border: 1px solid #cbd5e1; padding: 0.75rem; text-align: center; font-weight: 700;">${randomData.dassStress}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Assessment Summary -->
                            <div style="background: white; border: 2px solid #e5e7eb; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                                <h3 style="font-size: 1.125rem; font-weight: 700; color: #1e40af; margin-bottom: 1.25rem; display: flex; align-items: center;">
                                    <i class="fas fa-chart-bar" style="margin-right: 0.5rem;"></i>
                                    Assessment Summary
                                </h3>
                                
                                <!-- FNON Assessment -->
                                <div style="margin-bottom: 1.25rem; padding: 1rem; background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%); border-radius: 0.5rem; border-left: 4px solid #f97316; box-shadow: 0 1px 3px rgba(249, 115, 22, 0.1);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                        <h4 style="font-weight: 700; color: #9a3412; font-size: 0.875rem;">FNON (Functional Neurology Objective Network)</h4>
                                        <span style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; padding: 0.25rem 0.75rem; border-radius: 9999px; font-weight: 700; font-size: 0.75rem; box-shadow: 0 2px 4px rgba(249, 115, 22, 0.3);">
                                            ${reportData.assessmentSummary.fnon.score}
                                        </span>
                                    </div>
                                    <p style="color: #7c2d12; font-size: 0.75rem; line-height: 1.5; font-weight: 500;">${reportData.assessmentSummary.fnon.interpretation}</p>
                                </div>

                                <!-- Brain Mapping -->
                                <div style="margin-bottom: 1.25rem; padding: 1rem; background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%); border-radius: 0.5rem; border-left: 4px solid #7c3aed; box-shadow: 0 1px 3px rgba(124, 58, 237, 0.1);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                        <h4 style="font-weight: 700; color: #5b21b6; font-size: 0.875rem;">Brain Mapping (EEG Analysis)</h4>
                                        <span style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%); color: white; padding: 0.25rem 0.75rem; border-radius: 9999px; font-weight: 700; font-size: 0.75rem; box-shadow: 0 2px 4px rgba(124, 58, 237, 0.3);">
                                            ${reportData.assessmentSummary.brainMapping.score}
                                        </span>
                                    </div>
                                    <p style="color: #4c1d95; font-size: 0.75rem; line-height: 1.5; font-weight: 500;">${reportData.assessmentSummary.brainMapping.interpretation}</p>
                                </div>

                                <!-- PRS -->
                                <div style="padding: 1rem; background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); border-radius: 0.5rem; border-left: 4px solid #ec4899; box-shadow: 0 1px 3px rgba(236, 72, 153, 0.1);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                        <h4 style="font-weight: 700; color: #9f1239; font-size: 0.875rem;">PRS (Patient Reported Symptoms)</h4>
                                        <span style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%); color: white; padding: 0.25rem 0.75rem; border-radius: 9999px; font-weight: 700; font-size: 0.75rem; box-shadow: 0 2px 4px rgba(236, 72, 153, 0.3);">
                                            ${reportData.assessmentSummary.prs.score}
                                        </span>
                                    </div>
                                    <p style="color: #831843; font-size: 0.75rem; line-height: 1.5; font-weight: 500;">${reportData.assessmentSummary.prs.interpretation}</p>
                                </div>
                            </div>

                            <!-- Clinical Findings -->
                            <div style="background: white; border: 2px solid #e5e7eb; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                                <h3 style="font-size: 1.125rem; font-weight: 700; color: #1e40af; margin-bottom: 1rem; display: flex; align-items: center;">
                                    <i class="fas fa-stethoscope" style="margin-right: 0.5rem;"></i>
                                    Key Clinical Findings
                                </h3>
                                <ul style="list-style: none; padding: 0; margin: 0;">
                                    ${reportData.clinicalFindings.map(finding => `
                                        <li style="padding: 0.625rem; margin-bottom: 0.5rem; background: #f9fafb; border-left: 3px solid #10b981; border-radius: 0.375rem; display: flex; align-items: start;">
                                            <i class="fas fa-check-circle" style="color: #10b981; margin-right: 0.75rem; margin-top: 0.125rem; flex-shrink: 0; font-size: 0.875rem;"></i>
                                            <span style="color: #374151; line-height: 1.5; font-size: 0.8125rem;">${finding}</span>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>

                            <!-- Treatment Plan -->
                            <div style="background: white; border: 2px solid #e5e7eb; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                                <h3 style="font-size: 1.125rem; font-weight: 700; color: #1e40af; margin-bottom: 1.25rem; display: flex; align-items: center;">
                                    <i class="fas fa-notes-medical" style="margin-right: 0.5rem;"></i>
                                    Treatment Plan
                                </h3>
                                
                                <!-- Medications -->
                                <div style="margin-bottom: 1.25rem;">
                                    <h4 style="font-weight: 600; color: #374151; margin-bottom: 0.625rem; display: flex; align-items: center; font-size: 0.9375rem;">
                                        <i class="fas fa-pills" style="color: #3b82f6; margin-right: 0.5rem; font-size: 0.75rem;"></i>
                                        Medications
                                    </h4>
                                    <p style="padding: 0.75rem; background: #f8fafc; border-radius: 0.5rem; color: #4b5563; font-size: 0.8125rem; line-height: 1.6;">
                                        <i class="fas fa-capsules" style="color: #60a5fa; margin-right: 0.5rem;"></i>
                                        ${reportData.treatmentPlan.medications}
                                    </p>
                                </div>

                                <!-- Therapy -->
                                <div style="margin-bottom: 1.25rem;">
                                    <h4 style="font-weight: 600; color: #374151; margin-bottom: 0.625rem; display: flex; align-items: center; font-size: 0.9375rem;">
                                        <i class="fas fa-brain" style="color: #8b5cf6; margin-right: 0.5rem; font-size: 0.75rem;"></i>
                                        Therapy & Interventions
                                    </h4>
                                    <p style="padding: 0.75rem; background: #f8fafc; border-radius: 0.5rem; color: #4b5563; font-size: 0.8125rem; line-height: 1.6;">
                                        <i class="fas fa-hand-holding-medical" style="color: #a78bfa; margin-right: 0.5rem;"></i>
                                        ${reportData.treatmentPlan.therapy}
                                    </p>
                                </div>

                                <!-- Monitoring -->
                                <div style="margin-bottom: 1.25rem;">
                                    <h4 style="font-weight: 600; color: #374151; margin-bottom: 0.625rem; display: flex; align-items: center; font-size: 0.9375rem;">
                                        <i class="fas fa-heartbeat" style="color: #ec4899; margin-right: 0.5rem; font-size: 0.75rem;"></i>
                                        Monitoring Plan
                                    </h4>
                                    <p style="padding: 0.75rem; background: #f8fafc; border-radius: 0.5rem; color: #4b5563; font-size: 0.8125rem; line-height: 1.6;">
                                        <i class="fas fa-clipboard-check" style="color: #f472b6; margin-right: 0.5rem;"></i>
                                        ${reportData.treatmentPlan.monitoring}
                                    </p>
                                </div>

                                <!-- Lifestyle -->
                                <div>
                                    <h4 style="font-weight: 600; color: #374151; margin-bottom: 0.625rem; display: flex; align-items: center; font-size: 0.9375rem;">
                                        <i class="fas fa-running" style="color: #10b981; margin-right: 0.5rem; font-size: 0.75rem;"></i>
                                        Lifestyle Recommendations
                                    </h4>
                                    <p style="padding: 0.75rem; background: #f8fafc; border-radius: 0.5rem; color: #4b5563; font-size: 0.8125rem; line-height: 1.6;">
                                        <i class="fas fa-leaf" style="color: #34d399; margin-right: 0.5rem;"></i>
                                        ${reportData.treatmentPlan.lifestyle}
                                    </p>
                                </div>
                            </div>

                            <!-- Conclusion and Recommendations -->
                            <div style="space-y: 1rem; margin-bottom: 1.5rem;">
                                <div style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem; border: 1px solid #cbd5e1; margin-bottom: 1rem;">
                                    <h4 style="font-size: 0.875rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem;">Multifactorial Assessment Conclusion</h4>
                                    <p style="color: #475569; font-size: 0.8125rem; line-height: 1.5;">The comprehensive analysis reveals significant findings consistent with the patient's reported condition. Concurrent assessment results support the clinical diagnosis and treatment planning.</p>
                                </div>

                                <div style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem; border: 1px solid #cbd5e1; margin-bottom: 1rem;">
                                    <h4 style="font-size: 0.875rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem;">Recommendation</h4>
                                    <p style="color: #475569; font-size: 0.8125rem; line-height: 1.5;">We recommend a non-invasive neuromodulation protocol to regulate cortical excitability, paired with cognitive behavioral strategies to reinforce neural changes. Lifestyle modifications focusing on sleep hygiene and reduced stimulant intake are advised to support the biological intervention.</p>
                                </div>

                                <div style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem; border: 1px solid #cbd5e1; margin-bottom: 1rem;">
                                    <h4 style="font-size: 0.875rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem;">Neuromodulation Protocol</h4>
                                    <p style="color: #475569; font-size: 0.8125rem; line-height: 1.5;">The selected modality is Repetitive Transcranial Magnetic Stimulation (rTMS) targeting the left DLPFC to enhance neuronal firing rates. An inhibitory protocol may be applied to the right hemisphere subsequently to dampen anxiety-related overactivity.</p>
                                </div>

                                <div style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem; border: 1px solid #cbd5e1; margin-bottom: 1rem;">
                                    <h4 style="font-size: 0.875rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem;">Primary Neuromodulation Goals</h4>
                                    <p style="color: #475569; font-size: 0.8125rem; line-height: 1.5;">The primary objective is to achieve a clinically significant reduction in symptoms (aiming for >50% reduction in standardized scores). We focus on restoring emotional regulation and increasing the patient's drive and motivation for daily activities.</p>
                                </div>

                                <div style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem; border: 1px solid #cbd5e1; margin-bottom: 1rem;">
                                    <h4 style="font-size: 0.875rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem;">Additional Goals</h4>
                                    <p style="color: #475569; font-size: 0.8125rem; line-height: 1.5;">Secondary goals include stabilizing sleep architecture to ensure restorative rest and reducing subjective feelings of brain fog. We also aim to improve executive functions, specifically attention span and working memory, which have been impacted by the condition.</p>
                                </div>

                                <div style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem; border: 1px solid #cbd5e1; margin-bottom: 1rem;">
                                    <h4 style="font-size: 0.875rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem;">Schedule of Neuromodulation Sessions</h4>
                                    <p style="color: #475569; font-size: 0.8125rem; line-height: 1.5; margin-bottom: 0.5rem;">The initial acute phase consists of 5 sessions per week for a duration of 4 to 6 weeks, totaling 20-30 sessions. Each session will last approximately 20 minutes and should ideally be scheduled at the same time each day to establish a routine.</p>
                                    <p style="font-size: 0.625rem; color: #64748b; font-style: italic;">Note: Manufacturers propose limiting the use of tDCS products to a maximum of 30 mins per day and recommend against their use with children below the age of 18.</p>
                                </div>

                                <div style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem; border: 1px solid #cbd5e1;">
                                    <h4 style="font-size: 0.875rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem;">Follow-up Assessment Plan</h4>
                                    <p style="color: #475569; font-size: 0.8125rem; line-height: 1.5;">A clinical review will be conducted after session 10 to evaluate tolerance and early symptomatic improvement. A full repeat of the Multifactorial Assessment, including Brain Mapping, is required after session 20 to quantify physiological progress. Based on these results, the treatment plan will be adjusted or transitioned to a maintenance schedule.</p>
                                </div>
                            </div>

                            <!-- Prognosis -->
                            <div style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border: 2px solid #10b981; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                                <h3 style="font-size: 1.125rem; font-weight: 700; color: #065f46; margin-bottom: 1rem; display: flex; align-items: center;">
                                    <i class="fas fa-chart-line" style="margin-right: 0.5rem;"></i>
                                    Prognosis
                                </h3>
                                <p style="color: #064e3b; line-height: 1.6; font-size: 0.875rem;">${reportData.prognosis}</p>
                            </div>

                            <!-- Next Steps -->
                            <div style="background: white; border: 2px solid #e5e7eb; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1rem;">
                                <h3 style="font-size: 1.125rem; font-weight: 700; color: #1e40af; margin-bottom: 1rem; display: flex; align-items: center;">
                                    <i class="fas fa-tasks" style="margin-right: 0.5rem;"></i>
                                    Next Steps
                                </h3>
                                <ul style="list-style: none; padding: 0; margin: 0;">
                                    ${reportData.nextSteps.map((step, index) => `
                                        <li style="padding: 0.625rem; margin-bottom: 0.5rem; background: #eff6ff; border-left: 3px solid #2563eb; border-radius: 0.375rem; display: flex; align-items: start;">
                                            <span style="background: #2563eb; color: white; width: 1.375rem; height: 1.375rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.625rem; margin-right: 0.75rem; flex-shrink: 0;">
                                                ${index + 1}
                                            </span>
                                            <span style="color: #1e40af; line-height: 1.5; font-weight: 500; font-size: 0.8125rem;">${step}</span>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>

                            <!-- Footer -->
                            <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid #e5e7eb; text-align: center;">
                                <p style="color: #6b7280; font-size: 0.75rem; margin-bottom: 0.5rem;">
                                    <i class="fas fa-shield-alt" style="color: #10b981; margin-right: 0.25rem;"></i>
                                    This report is confidential and intended for the patient and authorized healthcare providers only.
                                </p>
                                <p style="color: #9ca3af; font-size: 0.625rem;">
                                    Generated by SOZO CRM Clinical Assessment System
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
            setTimeout(() => {
                const modal = document.getElementById('finalReportModal');
                if (modal) modal.classList.add('active');
            }, 10);
        }

        function closeFinalReportModal(event) {
            if (!event || event.target.id === 'finalReportModal') {
                const modal = document.getElementById('finalReportModal');
                if (modal) {
                    modal.classList.remove('active');
                    setTimeout(() => modal.remove(), 300);
                }
            }
        }

        function showFnonDetailsModal(assessmentNumber = 2) {
            const currentPatientId = selectedPatientData?.id || 'P001';
            const fnonScore = calculatePatientFnonScore(assessmentNumber);
            const patientName = selectedPatientData ? `${selectedPatientData.firstName} ${selectedPatientData.lastName}` : 'Patient';
            // FNON data structure
            const fnonData = {
                sectionA: [
                    {net:'DMN', signs:'Rumination, Mind-wandering', tests:['Gaze fixation','Romberg dual-task','Clock drawing']},
                    {net:'CEN', signs:'Poor planning, Memory deficits', tests:['Digit Span','Serial subtraction (100-7)','Motor sequencing']},
                    {net:'SN', signs:'Anxiety, Hyperarousal', tests:['Startle response','Interoceptive awareness']},
                    {net:'SMN', signs:'Motor/Sensory deficits', tests:['Finger-to-nose','Heel-to-shin','Rapid movements']},
                    {net:'Limbic', signs:'Emotional lability, Apathy', tests:['Facial expression check','Emotional reactivity']},
                    {net:'Attention', signs:'Distractibility, Neglect', tests:['Cancellation test','Eye tracking']}
                ]
            };

            // Get current patient's scores or use default scores
            
            const patientScores = patientFnonScores[currentPatientId] || patientFnonScores['P001'];
            
            console.log('Selected Patient ID:', currentPatientId);
            console.log('Patient Scores:', patientScores);

            // Calculate scores using patient-specific data
            let totalScore = 0;
            const networksHtml = fnonData.sectionA.map(net => {
                const testsHtml = net.tests.map(testName => {
                    // Use patient-specific score instead of random
                    const patientScore = patientScores[testName] !== undefined ? patientScores[testName] : Math.floor(Math.random() * 3);
                    totalScore += patientScore;
                    
                    return `
                        <div class="test-item">
                            <span class="test-name">${testName}</span>
                            <div class="test-score">
                                <span style="font-size: 12px; font-weight: 600; color: #64748b;">Score:</span>
                                <span class="score-badge score-0 ${patientScore === 0 ? 'active' : ''}">0 ${patientScore === 0 ? '✓' : ''}</span>
                                <span class="score-badge score-1 ${patientScore === 1 ? 'active' : ''}">1 ${patientScore === 1 ? '✓' : ''}</span>
                                <span class="score-badge score-2 ${patientScore === 2 ? 'active' : ''}">2 ${patientScore === 2 ? '✓' : ''}</span>
                            </div>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="network-section">
                        <div class="network-header">
                            <h3 class="network-title">${net.net}</h3>
                        </div>
                        <div class="network-signs">
                            <i class="fa-solid fa-triangle-exclamation" style="color: var(--orange-primary);"></i>
                            ${net.signs}
                        </div>
                        <div class="network-tests">
                            ${testsHtml}
                        </div>
                    </div>
                `;
            }).join('');

            // Calculate summary statistics
            const maxPossibleScore = fnonData.sectionA.reduce((sum, net) => sum + net.tests.length * 2, 0);
            const scorePercentage = (totalScore / maxPossibleScore) * 100;
            
            let interpretation = '';
            let interpretationColor = '';
            
            if (scorePercentage <= 20) {
                interpretation = 'Excellent - Minimal deficits detected';
                interpretationColor = 'border-color: rgb(244, 121, 32); background: rgba(244, 121, 32, 0.1); color: #b45309;';
            } else if (scorePercentage <= 40) {
                interpretation = 'Good - Mild concerns in some areas';
                interpretationColor = 'border-color: rgb(0, 161, 228); background: rgba(0, 161, 228, 0.1); color: #0369a1;';
            } else if (scorePercentage <= 60) {
                interpretation = 'Moderate - Several areas need attention';
                interpretationColor = 'border-color: #64748b; background: #f1f5f9; color: #334155;';
            } else {
                interpretation = 'Significant - Multiple areas require intervention';
                interpretationColor = 'border-color: #ef4444; background: rgba(239, 68, 68, 0.1); color: #991b1b;';
            }

            const modalHtml = `
                <div class="modal-overlay" id="fnonDetailsModal" onclick="closeFnonModal(event)">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <div>
                                <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 4px;">FNON Assessment Details</h2>
                                <p style="font-size: 14px; opacity: 0.9;">Patient: ${patientName} (${currentPatientId}) • Section A: Clinical Checklist</p>
                            </div>
                            <button class="modal-close" onclick="closeFnonModal()">
                                <i class="fa-solid fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div style="background: #eff6ff; padding: 16px; border-radius: 10px; border-left: 4px solid #3b82f6; margin-bottom: 24px;">
                                <p style="font-size: 13px; color: #1e40af;">
                                    <strong>ℹ️ Scoring Guide:</strong> 
                                    <span style="display: inline-flex; align-items: center; gap: 12px; margin-left: 8px;">
                                        <span><strong>0</strong> = Normal</span>
                                        <span><strong>1</strong> = Mild</span>
                                        <span><strong>2</strong> = Deficit</span>
                                    </span>
                                </p>
                            </div>

                            <div class="summary-section" style="margin-bottom: 24px;">
                                <div style="display: flex; align-items: center; justify-between; margin-bottom: 16px;">
                                    <h3 style="font-size: 20px; font-weight: 700; color: #0f172a;">
                                        <i class="fa-solid fa-chart-line" style="color: var(--orange-primary); margin-right: 8px;"></i>
                                        Assessment Summary
                                    </h3>
                                    <div style="text-align: right;">
                                        <p style="font-size: 11px; color: #64748b; font-weight: 700; text-transform: uppercase;">Assessed by</p>
                                        <p style="font-size: 14px; font-weight: 700; color: #0f172a;">Dr. James Wilson</p>
                                    </div>
                                </div>

                                <div class="summary-grid">
                                    <div class="summary-card">
                                        <p class="summary-label">Total Score</p>
                                        <p class="summary-value">${fnonScore}/30</p>
                                        <p class="summary-detail">Depression Severity Score</p>
                                    </div>
                                    <div class="summary-card" style="border-left-color: #64748b;">
                                        <p class="summary-label">Assessment</p>
                                        <p class="summary-value">CA${assessmentNumber}</p>
                                        <p class="summary-detail">Clinical Assessment ${assessmentNumber}</p>
                                    </div>
                                    <div class="summary-card" style="border-left-color: var(--orange-primary);">
                                        <p class="summary-label">Severity Level</p>
                                        <p class="summary-value" style="font-size: 18px;">${fnonScore < 15 ? 'Mild' : fnonScore < 22 ? 'Moderate' : 'Severe'}</p>
                                        <p class="summary-detail">depression level</p>
                                    </div>
                                </div>

                                <div class="interpretation-box" style="${fnonScore < 15 ? 'border-color: #10b981; background: rgba(16, 185, 129, 0.1); color: #065f46;' : fnonScore < 22 ? 'border-color: #f59e0b; background: rgba(245, 158, 11, 0.1); color: #92400e;' : 'border-color: #ef4444; background: rgba(239, 68, 68, 0.1); color: #991b1b;'}">
                                    <p style="font-weight: 700; margin-bottom: 4px;">
                                        <i class="fa-solid fa-stethoscope" style="margin-right: 8px;"></i>
                                        Clinical Interpretation
                                    </p>
                                    <p style="font-size: 14px; font-weight: 600;">${fnonScore < 15 ? 'Mild symptoms - Good response to treatment' : fnonScore < 22 ? 'Moderate symptoms - Treatment showing progress' : 'Severe symptoms - Continued treatment recommended'}</p>
                                </div>
                            </div>

                            ${networksHtml}
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('fnonDetailsModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            setTimeout(() => {
                document.getElementById('fnonDetailsModal').classList.add('active');
            }, 10);
        }

        function closeFnonModal(event) {
            // Only close if clicking on overlay, not on modal content
            if (!event || event.target.id === 'fnonDetailsModal') {
                const modal = document.getElementById('fnonDetailsModal');
                if (modal) {
                    modal.classList.remove('active');
                    setTimeout(() => modal.remove(), 300);
                }
            }
        }

        function editBlockDetails(blockType) {
            const blockNames = {
                'fnon': 'FNON Assessment',
                'brain-mapping': 'Brain Mapping (EEG)',
                'prs': 'PRS Evaluation',
                'doctor-notes': "Doctor's Notes",
                'treatment-plan': 'Treatment Plan',
                'final-report': 'Final Report'
            };
            alert(`Editing Assessment Data\\n\\nBlock: ${blockNames[blockType] || blockType}\\nRole: ${currentRole}\\n\\nThis would open an edit interface with:\\n- Editable assessment fields\\n- Data validation\\n- Save/Cancel options\\n- Audit trail logging`);
        }

        function viewSessionDetails(sessionId) {
            alert(`Viewing Session Report\\n\\nSession: ${sessionId}\\nRole: ${currentRole}\\n\\nThis would open a detailed session view with:\\n- Complete session data\\n- Device parameters\\n- Patient responses\\n- Clinical observations\\n- Downloadable report`);
        }

        function editSessionDetails(sessionId) {
            alert(`Editing Session Notes\\n\\nSession: ${sessionId}\\nRole: ${currentRole}\\n\\nThis would open an edit interface with:\\n- Clinical notes editor\\n- Session parameters\\n- Patient feedback\\n- Save/Cancel options`);
        }

        function activateSession(sessionId) {
            alert(`Activating Session\\n\\nSession: ${sessionId}\\nRole: ${currentRole}\\n\\nThis would:\\n- Confirm payment of €100\\n- Mark session as active\\n- Notify clinical staff\\n- Update patient dashboard`);
        }

        function activateSessionWithFlow(sessionId) {
            // Check role permissions
            if (currentRole !== 'doctor' && currentRole !== 'clinical-assistant') {
                alert(`Access Denied\\n\\nOnly doctors and clinical assistants can activate treatment sessions.\\n\\nCurrent Role: ${currentRole === 'receptionist' ? 'Receptionist' : 'Patient'}`);
                return;
            }
            
            // Store session for later
            window.activatingSessionId = sessionId;
            
            // Create a dummy session patient object
            const sessionPatient = {
                firstName: document.getElementById('patientFullName') ? document.getElementById('patientFullName').textContent.split(' ')[0] : 'Sarah',
                lastName: document.getElementById('patientFullName') ? document.getElementById('patientFullName').textContent.split(' ')[1] : 'Mitchell',
                age: 32,
                gender: 'Female',
                condition: 'Depression',
                sessionNumber: 4,
                sessionFee: 100
            };
            
            // Show consent form for session
            showConsentFormForSession(sessionPatient);
        }

        function showConsentFormForSession(sessionPatient) {
            currentOnboardingPatient = sessionPatient;
            
            // Hide journey
            document.getElementById('journeyContent').style.display = 'none';
            document.getElementById('selectedPatientHeader').style.display = 'none';
            
            // Show consent form
            document.getElementById('consentFormPage').style.display = 'block';
            
            // Populate patient name in consent form
            const fullName = `${sessionPatient.firstName} ${sessionPatient.lastName}`;
            document.getElementById('consentFullName').value = fullName;
            
            // Set context flag
            window.isSessionActivation = true;
            window.consentFormOrigin = 'session';
            
            // Initialize signature canvas
            setTimeout(() => {
                initSignatureCanvas();
                setupConsentListeners();
            }, 100);
        }

        function submitConsent() {
            // Check if signature exists
            if (!hasSignature) {
                alert('Please provide your signature before proceeding.');
                return;
            }
            
            // Check if checkbox is checked
            const consentCheckbox = document.getElementById('consentCheckbox');
            if (!consentCheckbox.checked) {
                alert('Please check the consent agreement box to proceed.');
                return;
            }
            
            // Store signature as base64
            const signatureCanvas = document.getElementById('signatureCanvas');
            const signatureData = signatureCanvas.toDataURL();
            currentOnboardingPatient.signature = signatureData;
            
            console.log('Consent signed:', {
                patient: currentOnboardingPatient.firstName + ' ' + currentOnboardingPatient.lastName,
                timestamp: new Date().toISOString(),
                signature: signatureData.substring(0, 50) + '...'
            });
            
            // Hide consent form
            document.getElementById('consentFormPage').style.display = 'none';
            
            // Show payment page
            if (window.isSessionActivation) {
                showSessionPaymentPage();
            } else {
                showPaymentPage();
            }
        }

        function showSessionPaymentPage() {
            // Show payment page
            document.getElementById('paymentPage').style.display = 'block';
            
            // Update payment amount for session
            const paymentAmountElements = document.querySelectorAll('.payment-amount');
            paymentAmountElements.forEach(el => {
                el.textContent = '€100';
            });
            
            // Update payment description
            const paymentDescElements = document.querySelectorAll('.payment-description');
            paymentDescElements.forEach(el => {
                el.textContent = 'Treatment Session Activation';
            });
            
            // Update payment details
            const paymentDetailsElements = document.querySelectorAll('.payment-details');
            paymentDetailsElements.forEach(el => {
                el.innerHTML = '<i class="fa-solid fa-info-circle"></i> This session fee covers PRS assessment and EEG recording';
            });
        }

        function processPayment() {
            // Simulate payment processing
            console.log('Processing session payment: €100');
            
            if (window.isSessionActivation) {
                // Complete session activation
                completeSessionActivation();
            } else {
                // Original flow
                proceedToJourney('paid');
            }
        }

        // Payment Method Selection
        function selectPaymentMethod(method) {
            // Update tab styles
            const methods = ['card', 'wallet', 'qr', 'bank'];
            methods.forEach(m => {
                const el = document.getElementById(`paymentMethod${m.charAt(0).toUpperCase() + m.slice(1)}`);
                if (el) {
                    if (m === method) {
                        el.style.border = '3px solid #10b981';
                        el.style.background = 'rgba(16, 185, 129, 0.05)';
                    } else {
                        el.style.border = '2px solid #e2e8f0';
                        el.style.background = 'white';
                    }
                }
            });

            // Show/hide payment sections
            document.getElementById('cardPaymentSection').style.display = method === 'card' ? 'block' : 'none';
            document.getElementById('walletPaymentSection').style.display = method === 'wallet' ? 'block' : 'none';
            document.getElementById('qrPaymentSection').style.display = method === 'qr' ? 'block' : 'none';
            document.getElementById('bankPaymentSection').style.display = method === 'bank' ? 'block' : 'none';
        }

        // Card Type Detection
        function detectCardType(cardNumber) {
            // Remove spaces
            const cleaned = cardNumber.replace(/\s/g, '');
            const cardTypeIcon = document.getElementById('cardTypeIcon');
            
            if (!cardTypeIcon) return;

            // Visa
            if (/^4/.test(cleaned)) {
                cardTypeIcon.className = 'fa-brands fa-cc-visa';
                cardTypeIcon.style.color = '#1a1f71';
            }
            // Mastercard
            else if (/^5[1-5]/.test(cleaned) || /^2[2-7]/.test(cleaned)) {
                cardTypeIcon.className = 'fa-brands fa-cc-mastercard';
                cardTypeIcon.style.color = '#eb001b';
            }
            // Amex
            else if (/^3[47]/.test(cleaned)) {
                cardTypeIcon.className = 'fa-brands fa-cc-amex';
                cardTypeIcon.style.color = '#006fcf';
            }
            // Discover
            else if (/^6(?:011|5)/.test(cleaned)) {
                cardTypeIcon.className = 'fa-brands fa-cc-discover';
                cardTypeIcon.style.color = '#ff6000';
            }
            // Default
            else {
                cardTypeIcon.className = 'fa-solid fa-credit-card';
                cardTypeIcon.style.color = '#64748b';
            }
        }

        function completeSessionActivation() {
            // Hide payment page
            document.getElementById('paymentPage').style.display = 'none';
            
            // Show journey again
            document.getElementById('journeyContent').style.display = 'block';
            document.getElementById('selectedPatientHeader').style.display = 'block';
            
            // Reset flags
            window.isSessionActivation = false;
            window.consentFormOrigin = null;
            hasSignature = false;
            
            // Show success message
            alert('Session Activated Successfully!\n\nSession 4\nPayment: €100 (Confirmed)\nConsent: Signed\n\nThe session is now active and ready for treatment.');
            
            // Re-render today view to show updated session
            renderTodayView();
        }

        function selectPayLater() {
            if (window.isSessionActivation) {
                alert('Session activation requires immediate payment of €100 to unlock the device and begin treatment.');
                return;
            }
            
            // Original pay later flow for new patient
            proceedToJourney('pending');
        }

        function backFromPayment() {
            // Hide payment page
            document.getElementById('paymentPage').style.display = 'none';
            
            // Show consent form again
            document.getElementById('consentFormPage').style.display = 'block';
        }


        function startSession(sessionId) {
            alert(`Starting Session\\n\\nSession: ${sessionId}\\nRole: ${currentRole}\\n\\nThis would:\\n- Open session interface\\n- Select device and montage\\n- Begin treatment protocol\\n- Start timer and monitoring`);
        }

        function startNewPatientAssessment(assessmentId, assessmentName) {
            alert(`Starting ${assessmentName}\\n\\nAssessment ID: ${assessmentId}\\nRole: ${currentRole}\\n\\nThis would:\\n- Open ${assessmentName} interface\\n- Load assessment forms\\n- Begin data collection\\n- Save progress automatically\\n\\nNote: This is a new patient's initial assessment.`);
            
            // In production, this would navigate to the assessment interface
            console.log(`Starting new patient assessment: ${assessmentId} (${assessmentName}) by ${currentRole}`);
        }

        function proceedToPayment() {
            // Hide journey
            document.getElementById('journeyContent').style.display = 'none';
            document.getElementById('selectedPatientHeader').style.display = 'none';
            
            // Show payment page
            showPaymentPage();
            
            alert('Returning to Payment Page\\n\\nComplete the €300 payment to unlock all assessments.');
        }

        // ONBOARDING FLOW MANAGEMENT
        let currentOnboardingPatient = null;
        let currentUserRole = 'receptionist'; // Default role for onboarding
        let signatureCanvas = null;
        let signatureContext = null;
        let isDrawing = false;
        let hasSignature = false;
        let patientPaymentStatus = 'pending'; // Track if payment is 'paid' or 'pending'

        // Initialize signature canvas
        function initSignatureCanvas() {
            signatureCanvas = document.getElementById('signatureCanvas');
            if (!signatureCanvas) return;
            
            signatureContext = signatureCanvas.getContext('2d');
            signatureContext.strokeStyle = '#0f172a';
            signatureContext.lineWidth = 2;
            signatureContext.lineCap = 'round';
            signatureContext.lineJoin = 'round';

            // Mouse events
            signatureCanvas.addEventListener('mousedown', startDrawing);
            signatureCanvas.addEventListener('mousemove', draw);
            signatureCanvas.addEventListener('mouseup', stopDrawing);
            signatureCanvas.addEventListener('mouseout', stopDrawing);

            // Touch events
            signatureCanvas.addEventListener('touchstart', handleTouchStart);
            signatureCanvas.addEventListener('touchmove', handleTouchMove);
            signatureCanvas.addEventListener('touchend', stopDrawing);
        }

        function startDrawing(e) {
            isDrawing = true;
            const rect = signatureCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            signatureContext.beginPath();
            signatureContext.moveTo(x, y);
        }

        function draw(e) {
            if (!isDrawing) return;
            const rect = signatureCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            signatureContext.lineTo(x, y);
            signatureContext.stroke();
            hasSignature = true;
            validateConsent();
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousedown', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            signatureCanvas.dispatchEvent(mouseEvent);
        }

        function handleTouchMove(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            signatureCanvas.dispatchEvent(mouseEvent);
        }

        function clearSignature() {
            if (!signatureContext || !signatureCanvas) return;
            signatureContext.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
            hasSignature = false;
            validateConsent();
        }

        function validateConsent() {
            const checkbox = document.getElementById('consentCheckbox');
            const submitBtn = document.getElementById('submitConsentBtn');
            
            if (checkbox && submitBtn) {
                const isValid = checkbox.checked && hasSignature;
                submitBtn.disabled = !isValid;
                submitBtn.style.opacity = isValid ? '1' : '0.5';
                submitBtn.style.cursor = isValid ? 'pointer' : 'not-allowed';
            }
        }

        // Add event listener for checkbox
        function setupConsentListeners() {
            const checkbox = document.getElementById('consentCheckbox');
            if (checkbox) {
                checkbox.addEventListener('change', validateConsent);
            }
        }

        function showConsentForm(patient) {
            currentOnboardingPatient = patient;
            
            // Hide all screens
            document.getElementById('patientEntryScreen').style.display = 'none';
            document.getElementById('paymentPage').style.display = 'none';
            document.getElementById('journeyContent').style.display = 'none';
            document.getElementById('selectedPatientHeader').style.display = 'none';
            
            // Show consent form
            document.getElementById('consentFormPage').style.display = 'block';
            
            // Populate patient name
            const fullName = `${patient.firstName} ${patient.lastName}`;
            document.getElementById('consentFullName').value = fullName;
            
            // Set context flag
            window.isSessionActivation = false;
            window.consentFormOrigin = 'newPatient';
            
            // Initialize signature canvas
            setTimeout(() => {
                initSignatureCanvas();
                setupConsentListeners();
            }, 100);
        }

        function showPaymentPage() {
            // Hide consent form
            document.getElementById('consentFormPage').style.display = 'none';
            
            // Show payment page
            document.getElementById('paymentPage').style.display = 'block';
            
            // Pre-fill cardholder name
            if (currentOnboardingPatient) {
                document.getElementById('cardholderName').value = 
                    `${currentOnboardingPatient.firstName} ${currentOnboardingPatient.lastName}`;
            }
        }

        function proceedToJourney(paymentStatus) {
            // Store payment status globally
            patientPaymentStatus = paymentStatus;
            
            // Hide payment page
            document.getElementById('paymentPage').style.display = 'none';
            
            // Show patient header
            const header = document.getElementById('selectedPatientHeader');
            header.style.display = 'block';
            
            // Show role selector for journey
            document.getElementById('journeyRoleSelector').style.display = 'block';
            
            // Populate header
            document.getElementById('patientInitials').textContent = 
                currentOnboardingPatient.firstName.charAt(0) + currentOnboardingPatient.lastName.charAt(0);
            document.getElementById('patientFullName').textContent = 
                `${currentOnboardingPatient.firstName} ${currentOnboardingPatient.lastName}`;
            document.getElementById('patientAge').textContent = `${currentOnboardingPatient.age} years`;
            document.getElementById('patientGender').textContent = currentOnboardingPatient.gender;
            document.getElementById('patientCondition').textContent = currentOnboardingPatient.condition;
            
            // Show journey content
            document.getElementById('journeyContent').style.display = 'block';
            
            // Store payment status
            currentOnboardingPatient.paymentStatus = paymentStatus;
            
            // Activate Today's Journey tab and render it
            switchTab('today');
            
            console.log('Patient onboarding complete:', {
                patient: currentOnboardingPatient,
                paymentStatus: paymentStatus
            });
        }

        function backToPatientSelection() {
            // Check context to determine where to go back
            if (window.consentFormOrigin === 'session') {
                // Coming from session activation - go back to journey
                document.getElementById('consentFormPage').style.display = 'none';
                document.getElementById('paymentPage').style.display = 'none';
                document.getElementById('journeyContent').style.display = 'block';
                document.getElementById('selectedPatientHeader').style.display = 'block';
                
                // Reset session activation flags
                window.isSessionActivation = false;
                window.consentFormOrigin = null;
                hasSignature = false;
            } else {
                // Coming from new patient flow - go back to patient entry
                document.getElementById('consentFormPage').style.display = 'none';
                document.getElementById('paymentPage').style.display = 'none';
                document.getElementById('patientEntryScreen').style.display = 'block';
                
                // Reset onboarding state
                currentOnboardingPatient = null;
                window.consentFormOrigin = null;
                hasSignature = false;
            }
        }

        // PATIENT MANAGEMENT FUNCTIONS
        const samplePatients = [
            {
                id: 'P001',
                firstName: 'Sarah',
                lastName: 'Mitchell',
                age: 42,
                gender: 'Female',
                condition: "Parkinson's Disease",
                lastVisit: '2026-01-30',
                status: 'active',
                nextAppointment: '2026-02-01'
            },
            {
                id: 'P002',
                firstName: 'Michael',
                lastName: 'Roberts',
                age: 55,
                gender: 'Male',
                condition: 'Depression',
                lastVisit: '2026-01-28',
                status: 'active',
                nextAppointment: '2026-02-03'
            },
            {
                id: 'P003',
                firstName: 'Emily',
                lastName: 'Chen',
                age: 38,
                gender: 'Female',
                condition: 'Anxiety',
                lastVisit: '2026-01-25',
                status: 'completed',
                nextAppointment: '2026-02-08'
            },
            {
                id: 'P004',
                firstName: 'David',
                lastName: 'Thompson',
                age: 47,
                gender: 'Male',
                condition: 'Stroke Recovery',
                lastVisit: '2026-01-29',
                status: 'active',
                nextAppointment: '2026-02-02'
            },
            {
                id: 'P005',
                firstName: 'Lisa',
                lastName: 'Anderson',
                age: 35,
                gender: 'Female',
                condition: 'Depression',
                lastVisit: '2026-01-27',
                status: 'active',
                nextAppointment: '2026-02-04'
            }
        ];

        let selectedPatientData = null;
        let filteredPatients = [...samplePatients];

        // Patient-specific FNON scores - each patient has their own assessment scores
        const patientFnonScores = {
            'P001': {
                'Gaze fixation': 2,
                'Romberg dual-task': 1,
                'Clock drawing': 0,
                'Digit Span': 2,
                'Serial subtraction (100-7)': 1,
                'Motor sequencing': 0,
                'Startle response': 0,
                'Interoceptive awareness': 1,
                'Finger-to-nose': 1,
                'Heel-to-shin': 0,
                'Rapid movements': 1,
                'Facial expression check': 0,
                'Emotional reactivity': 2,
                'Cancellation test': 0,
                'Eye tracking': 1
            },
            'P002': {
                'Gaze fixation': 0,
                'Romberg dual-task': 0,
                'Clock drawing': 1,
                'Digit Span': 1,
                'Serial subtraction (100-7)': 0,
                'Motor sequencing': 0,
                'Startle response': 2,
                'Interoceptive awareness': 2,
                'Finger-to-nose': 0,
                'Heel-to-shin': 0,
                'Rapid movements': 0,
                'Facial expression check': 1,
                'Emotional reactivity': 1,
                'Cancellation test': 0,
                'Eye tracking': 0
            },
            'P003': {
                'Gaze fixation': 1,
                'Romberg dual-task': 2,
                'Clock drawing': 2,
                'Digit Span': 0,
                'Serial subtraction (100-7)': 1,
                'Motor sequencing': 1,
                'Startle response': 0,
                'Interoceptive awareness': 0,
                'Finger-to-nose': 0,
                'Heel-to-shin': 1,
                'Rapid movements': 0,
                'Facial expression check': 0,
                'Emotional reactivity': 0,
                'Cancellation test': 1,
                'Eye tracking': 1
            },
            'P004': {
                'Gaze fixation': 0,
                'Romberg dual-task': 0,
                'Clock drawing': 0,
                'Digit Span': 0,
                'Serial subtraction (100-7)': 1,
                'Motor sequencing': 0,
                'Startle response': 1,
                'Interoceptive awareness': 1,
                'Finger-to-nose': 0,
                'Heel-to-shin': 0,
                'Rapid movements': 0,
                'Facial expression check': 0,
                'Emotional reactivity': 1,
                'Cancellation test': 0,
                'Eye tracking': 0
            },
            'P005': {
                'Gaze fixation': 2,
                'Romberg dual-task': 2,
                'Clock drawing': 1,
                'Digit Span': 2,
                'Serial subtraction (100-7)': 2,
                'Motor sequencing': 1,
                'Startle response': 1,
                'Interoceptive awareness': 2,
                'Finger-to-nose': 1,
                'Heel-to-shin': 2,
                'Rapid movements': 2,
                'Facial expression check': 1,
                'Emotional reactivity': 2,
                'Cancellation test': 2,
                'Eye tracking': 2
            }
        };

        // Patient-specific improvement percentages (compared to previous assessment)
        const patientImprovements = {
            'P001': '+15%',  // Sarah Mitchell - moderate improvement
            'P002': '+28%',  // Michael Roberts - significant improvement
            'P003': '+12%',  // Emily Chen - mild improvement
            'P004': '+5%',   // David Thompson - slight improvement (already very good)
            'P005': '+8%'    // Emma Anderson - showing improvement
        };

        // Patient-specific brain mapping EEG data
        const patientBrainMappingData = {
            'P001': {
                name: 'Sarah Mitchell',
                dominantFrequency: '8.5 Hz',
                alphaActivity: 'Reduced (35%)',
                betaActivity: 'Elevated (45%)',
                thetaActivity: 'Moderate (15%)',
                deltaActivity: 'Low (5%)',
                asymmetry: 'Left frontal hypoactivity',
                findings: [
                    'Reduced alpha power in posterior regions',
                    'Increased beta activity indicating hyperarousal',
                    'Left hemisphere asymmetry pattern',
                    'Normal connectivity in default mode network'
                ],
                recommendation: 'Neurofeedback targeting alpha enhancement in posterior cortex'
            },
            'P002': {
                name: 'Michael Roberts',
                dominantFrequency: '9.2 Hz',
                alphaActivity: 'Normal (42%)',
                betaActivity: 'Normal (28%)',
                thetaActivity: 'Elevated (22%)',
                deltaActivity: 'Normal (8%)',
                asymmetry: 'Minimal asymmetry',
                findings: [
                    'Elevated theta/beta ratio suggesting attention concerns',
                    'Good alpha peak frequency',
                    'Bilateral symmetry preserved',
                    'Frontal theta elevation noted'
                ],
                recommendation: 'Theta/beta training protocol with mindfulness integration'
            },
            'P003': {
                name: 'Emily Chen',
                dominantFrequency: '10.1 Hz',
                alphaActivity: 'High (48%)',
                betaActivity: 'Elevated (38%)',
                thetaActivity: 'Low (10%)',
                deltaActivity: 'Low (4%)',
                asymmetry: 'Right frontal hyperactivity',
                findings: [
                    'High beta activity in frontal regions',
                    'Right hemisphere dominance',
                    'Anxiety-related pattern observed',
                    'Good posterior alpha rhythm'
                ],
                recommendation: 'SMR training to reduce anxiety-related beta activity'
            },
            'P004': {
                name: 'David Thompson',
                dominantFrequency: '10.5 Hz',
                alphaActivity: 'Optimal (45%)',
                betaActivity: 'Normal (25%)',
                thetaActivity: 'Normal (18%)',
                deltaActivity: 'Normal (12%)',
                asymmetry: 'Well-balanced',
                findings: [
                    'Excellent alpha peak frequency',
                    'Balanced hemispheric activity',
                    'Optimal frequency distribution',
                    'Strong posterior dominant rhythm'
                ],
                recommendation: 'Maintain current wellness protocol, no intervention needed'
            },
            'P005': {
                name: 'Emma Anderson',
                dominantFrequency: '7.8 Hz',
                alphaActivity: 'Low (28%)',
                betaActivity: 'Very High (52%)',
                thetaActivity: 'Elevated (15%)',
                deltaActivity: 'Low (5%)',
                asymmetry: 'Bilateral frontal hyperactivity',
                findings: [
                    'Significantly elevated beta activity',
                    'Low alpha power indicating poor relaxation',
                    'Chronic stress pattern evident',
                    'Reduced posterior dominant rhythm'
                ],
                recommendation: 'Intensive alpha/theta training with stress management protocols'
            }
        };

        // Patient-specific PRS (Patient Reported Symptoms) data based on their condition
        const patientPRSData = {
            'P001': {
                name: 'Sarah Mitchell',
                condition: "Parkinson's Disease",
                primarySymptoms: [
                    { name: 'Resting tremor (pill-rolling)', severity: 'Moderate', frequency: 'Daily, worse with stress', location: 'Right hand and forearm' },
                    { name: 'Muscular rigidity (cogwheel)', severity: 'Mild to Moderate', frequency: 'Constant, worse mornings', location: 'Neck, shoulders, right arm' },
                    { name: 'Bradykinesia (slow movements)', severity: 'Moderate', frequency: 'Throughout day', location: 'Shuffling gait, reduced arm swing' },
                    { name: 'Postural instability', severity: 'Mild', frequency: '2-3 times per week', location: 'Difficulty with turns and uneven surfaces' }
                ],
                secondarySymptoms: [
                    { name: 'REM sleep behavior disorder', severity: 'Moderate', notes: 'Acting out dreams, disrupting partner' },
                    { name: 'Daytime fatigue', severity: 'Moderate', notes: 'Energy drops significantly after 2 PM' },
                    { name: 'Masked facies', severity: 'Mild', notes: 'Reduced facial expressions noted by family' },
                    { name: 'Micrographia', severity: 'Mild', notes: 'Handwriting has become smaller' }
                ],
                functionalImpact: 'Moderate - Managing work with accommodations, difficulty with fine motor tasks like buttoning',
                overallScore: '24/40',
                interpretation: 'Stage 2 Parkinson\'s with bilateral symptoms, good medication response, candidate for physiotherapy'
            },
            'P002': {
                name: 'Michael Roberts',
                condition: 'Major Depressive Disorder',
                primarySymptoms: [
                    { name: 'Persistent depressed mood', severity: 'Moderate', frequency: 'Daily, worse mornings', duration: 'Present for 8 months' },
                    { name: 'Anhedonia', severity: 'Moderate', frequency: '6 days per week', duration: 'Lost interest in golf and reading' },
                    { name: 'Psychomotor retardation', severity: 'Mild to Moderate', frequency: 'Daily', duration: 'Slow speech, delayed responses' },
                    { name: 'Indecisiveness', severity: 'Moderate', frequency: 'Daily', duration: 'Simple decisions take hours' }
                ],
                secondarySymptoms: [
                    { name: 'Early morning awakening', severity: 'Moderate', notes: 'Waking at 4 AM, unable to return to sleep' },
                    { name: 'Decreased appetite', severity: 'Mild', notes: 'Lost 7 pounds in 2 months, food tasteless' },
                    { name: 'Diminished libido', severity: 'Moderate', notes: 'Affecting marital relationship' },
                    { name: 'Cognitive slowing', severity: 'Moderate', notes: 'Difficulty with work reports and emails' }
                ],
                functionalImpact: 'Moderate - Performance review concerns at work, reduced social engagement, strain on marriage',
                overallScore: '28/40',
                interpretation: 'Moderate MDD with melancholic features, showing 30% improvement on SSRI after 8 weeks, consider therapy augmentation'
            },
            'P003': {
                name: 'Emily Chen',
                condition: 'Generalized Anxiety Disorder',
                primarySymptoms: [
                    { name: 'Uncontrollable worry', severity: 'Severe', frequency: 'Daily, 6+ hours', duration: 'About work, health, family safety' },
                    { name: 'Motor restlessness', severity: 'Moderate to Severe', frequency: 'Constant when awake', duration: 'Pacing, fidgeting, unable to sit still' },
                    { name: 'Hypervigilance', severity: 'Severe', frequency: 'Constant', duration: 'Scanning for threats, startles easily' },
                    { name: 'Anticipatory anxiety', severity: 'Moderate', frequency: '4-5 days per week', duration: 'Dreading upcoming events days in advance' }
                ],
                secondarySymptoms: [
                    { name: 'Sleep onset insomnia', severity: 'Moderate to Severe', notes: 'Takes 1-2 hours to fall asleep, racing thoughts' },
                    { name: 'Chronic muscle tension', severity: 'Moderate', notes: 'Jaw clenching causing TMJ pain, upper back knots' },
                    { name: 'GI distress', severity: 'Moderate', notes: 'Frequent nausea, IBS symptoms when anxious' },
                    { name: 'Irritability/edginess', severity: 'Moderate', notes: 'Snapping at husband and children, feeling on edge' }
                ],
                functionalImpact: 'Moderate to Severe - Work productivity declining, avoiding social situations, family tension increasing',
                overallScore: '30/40',
                interpretation: 'Severe GAD with somatic symptoms, good candidate for CBT + SSRI, consider relaxation training'
            },
            'P004': {
                name: 'David Thompson',
                condition: 'Post-Stroke Syndrome (6 months)',
                primarySymptoms: [
                    { name: 'Left hemiparesis', severity: 'Mild', frequency: 'Constant', location: 'Left arm (3/5 strength), left leg (4/5 strength)' },
                    { name: 'Expressive aphasia', severity: 'Minimal', frequency: 'Intermittent', location: 'Word-finding pauses, circumlocution' },
                    { name: 'Working memory deficit', severity: 'Mild', frequency: 'Daily', location: 'Forgetting conversations, task sequences' },
                    { name: 'Left-sided neglect (mild)', severity: 'Minimal', frequency: 'Occasional', location: 'Bumping left shoulder on doorframes' }
                ],
                secondarySymptoms: [
                    { name: 'Post-stroke fatigue', severity: 'Moderate', notes: 'Energy depleted by noon, needs afternoon rest' },
                    { name: 'Pseudobulbar affect', severity: 'Mild', notes: 'Inappropriate crying 2-3 times weekly, embarrassing' },
                    { name: 'Mild depression (reactive)', severity: 'Mild', notes: 'Grief over lost abilities, optimistic about recovery' },
                    { name: 'Spasticity', severity: 'Mild', notes: 'Left hand flexor tightness, responds to stretching' }
                ],
                functionalImpact: 'Mild - Independent with ADLs, driving again, planning return to work part-time',
                overallScore: '12/40',
                interpretation: 'Excellent recovery from left MCA stroke, 85% functional improvement, continue OT/PT, excellent rehabilitation prognosis'
            },
            'P005': {
                name: 'Lisa Anderson',
                condition: 'Severe Major Depressive Disorder',
                primarySymptoms: [
                    { name: 'Severe depressed mood', severity: 'Severe', frequency: 'Constant, all day every day', duration: '14 months duration' },
                    { name: 'Complete anhedonia', severity: 'Severe', frequency: 'Total loss of pleasure', duration: 'No joy in anything, even children' },
                    { name: 'Severe worthlessness/guilt', severity: 'Severe', frequency: 'Constant rumination', duration: 'Believes she\'s a burden, self-blame' },
                    { name: 'Psychomotor retardation', severity: 'Severe', frequency: 'Daily', duration: 'Monotone speech, blank stare, slow movements' }
                ],
                secondarySymptoms: [
                    { name: 'Hypersomnia', severity: 'Severe', notes: 'Sleeping 14-16 hours daily, using sleep to escape' },
                    { name: 'Atypical appetite increase', severity: 'Moderate to Severe', notes: 'Emotional eating, 18 lb weight gain in 4 months' },
                    { name: 'Severe concentration deficit', severity: 'Severe', notes: 'Cannot read, watch TV, or follow conversations' },
                    { name: 'Complete social withdrawal', severity: 'Severe', notes: 'Stopped answering calls, hasn\'t left house in 3 weeks' },
                    { name: 'Passive death wishes', severity: 'Severe', notes: 'Wishes she wouldn\'t wake up, no active plan' }
                ],
                functionalImpact: 'Severe - On medical leave from work, struggling with basic hygiene, children staying with mother',
                overallScore: '36/40',
                interpretation: 'Severe MDD with atypical features, failed 2 antidepressants, urgent psychiatric referral for intensive outpatient program or ECT consideration'
            }
        };

        // Patient-specific Doctor's Notes data
        const patientDoctorNotes = {
            'P001': {
                name: 'Sarah Mitchell',
                condition: "Parkinson's Disease",
                clinicalObservations: {
                    fnon: 'Patient performed well during limbic network assessment. Notable mild tremor affecting right hand during fine motor tasks. Balance testing revealed postural instability, particularly during dual-task conditions. Eye tracking showed expected saccadic abnormalities consistent with PD progression.',
                    brainMapping: 'Sarah responded calmly to the EEG report discussion. Brain mapping reveals reduced alpha activity in posterior regions with elevated beta in motor cortex, consistent with parkinsonian patterns. No unexpected findings. Patient expressed understanding of correlation between EEG patterns and motor symptoms.',
                    prs: 'Patient self-report aligns well with clinical observations. Symptom progression appears gradual and well-managed with current medication regimen.'
                },
                recommendations: 'Continue current levodopa therapy with careful monitoring. Recommend initiating physical therapy focused on balance and gait training 2x weekly. Consider neuropsychological assessment in 6 months to monitor cognitive changes. Family education on fall prevention strategies is essential.',
                medications: 'Carbidopa-Levodopa 25/100mg TID (well-tolerated, good symptom control). Added Rasagiline 1mg daily to optimize dopaminergic therapy. Recommend Vitamin D supplementation for bone health given mobility limitations.'
            },
            'P002': {
                name: 'Michael Roberts',
                condition: 'Major Depressive Disorder',
                clinicalObservations: {
                    fnon: 'Patient showed reduced engagement during cognitive tasks, particularly those requiring sustained attention. Processing speed noticeably slower than baseline. Emotional reactivity assessment revealed blunted affect with minimal facial expression changes.',
                    brainMapping: 'Michael reviewed the EEG results with appropriate concern but maintained composure. Brain mapping indicates elevated theta/beta ratio in frontal regions, classic marker for depression. Left frontal hypoactivity noted, correlating with anhedonia symptoms.',
                    prs: 'Patient report reveals significant improvement from baseline (PHQ-9 score decreased from 21 to 14 over 8 weeks). Sleep architecture improving but appetite still reduced.'
                },
                recommendations: 'Continue SSRI therapy with dosage optimization after 2 more weeks. Initiate cognitive behavioral therapy (CBT) sessions weekly to address negative thought patterns. Recommend adding behavioral activation protocol to combat anhedonia. Schedule follow-up in 4 weeks to reassess medication efficacy.',
                medications: 'Sertraline 100mg daily (started 8 weeks ago, showing partial response). Plan to increase to 150mg if tolerated. Added Vitamin B12 (1000mcg), Magnesium for sleep support. No adverse effects reported.'
            },
            'P003': {
                name: 'Emily Chen',
                condition: 'Generalized Anxiety Disorder',
                clinicalObservations: {
                    fnon: 'Patient displayed hypervigilance throughout assessment, frequently scanning environment. Startle response test showed exaggerated reactions. Interoceptive awareness tasks revealed difficulty with body-mind disconnection, common in chronic anxiety.',
                    brainMapping: 'Emily appeared anxious when reviewing EEG data but engaged well with education. Brain mapping shows significantly elevated beta activity bilaterally, especially in frontal regions - objective marker of hyperarousal state. Right hemisphere shows dominance pattern associated with worry.',
                    prs: 'Self-reported symptoms align with clinical presentation. Patient demonstrates good insight into anxiety patterns and triggers. Motivation for treatment is high.'
                },
                recommendations: 'Recommend combined approach: pharmacotherapy with SSRI plus weekly CBT focusing on exposure therapy and worry management. Add mindfulness-based stress reduction (MBSR) program. Neurofeedback targeting SMR enhancement to reduce beta hyperactivity shows promise. Sleep hygiene education critical.',
                medications: 'Starting Escitalopram 10mg daily, titrate to 20mg after 2 weeks if tolerated. Hydroxyzine 25mg PRN for acute anxiety (max 3x daily). Recommend Magnesium L-Threonate 2000mg for calming effect and cognitive support.'
            },
            'P004': {
                name: 'David Thompson',
                condition: 'Post-Stroke Recovery',
                clinicalObservations: {
                    fnon: 'Remarkable recovery progress noted. Mild word-finding pauses during language tasks but compensatory strategies effective. Memory testing shows working memory within low-normal range with good response to cueing. Motor coordination improving steadily.',
                    brainMapping: 'David showed enthusiasm when reviewing recovery progress on EEG. Brain mapping reveals excellent compensatory activation in right hemisphere following left MCA stroke. Neuroplasticity markers very positive - increased connectivity in perilesional tissue suggests ongoing recovery potential.',
                    prs: 'Patient maintains optimistic outlook which is therapeutically beneficial. Family support system strong. Realistic about limitations while motivated for continued improvement.'
                },
                recommendations: 'Continue intensive occupational and physical therapy - critical window for neuroplasticity remains open. Add speech therapy 2x weekly for aphasia management. Consider constraint-induced movement therapy for left upper extremity. Cognitive rehabilitation targeting working memory and attention. Excellent prognosis for return to work part-time within 3 months.',
                medications: 'Aspirin 81mg daily for stroke prevention. Atorvastatin 40mg for cholesterol management. Modafinil 100mg morning for post-stroke fatigue (showing good response). Blood pressure well-controlled on current regimen.'
            },
            'P005': {
                name: 'Lisa Anderson',
                condition: 'Severe Major Depressive Disorder',
                clinicalObservations: {
                    fnon: 'Severe psychomotor retardation evident - patient required extended time for all tasks. Emotional reactivity testing showed profound anhedonia with no pleasure response to positive stimuli. Attention and concentration severely impaired, unable to complete several subtests.',
                    brainMapping: 'Lisa appeared withdrawn and required gentle encouragement to engage with report. Brain mapping reveals severe bilateral frontal hypoactivity and global alpha suppression - neurobiological markers of severe depression. Pattern suggests strong candidate for neuromodulation interventions.',
                    prs: 'Self-report indicates total loss of interest in previously enjoyed activities, passive death wishes without plan. Symptom severity warrants urgent intervention escalation. Patient insight partially preserved which is favorable prognostic indicator.'
                },
                recommendations: 'URGENT: Refer to psychiatry for ECT evaluation given treatment resistance (failed 2 SSRIs). Recommend enrollment in intensive outpatient program (IOP) with daily check-ins. Family psychoeducation critical - children temporarily staying with grandmother is appropriate. Consider TMS protocol if ECT declined. Close safety monitoring essential. Weekly appointments minimum until stabilization.',
                medications: 'Recently discontinued Fluoxetine 40mg (no response after 10 weeks), previously failed Sertraline. Starting Venlafaxine 75mg BID with plan to titrate to 150mg BID. Added Bupropion 150mg SR to target energy/motivation. Trazodone 50mg at bedtime for hypersomnia regulation. Requires careful monitoring for medication interactions and emergence of side effects.'
            }
        };

        // Patient-specific Final Report data
        const patientFinalReports = {
            'P001': {
                name: 'Sarah Mitchell',
                patientId: 'P001',
                age: 42,
                gender: 'Female',
                condition: "Parkinson's Disease",
                assessmentDate: 'January 29, 2026',
                assessmentSummary: {
                    fnon: { score: '12/30', interpretation: 'Moderate network dysfunction, primarily affecting motor and limbic networks' },
                    brainMapping: { finding: 'Reduced alpha (35%), Elevated beta (45%)', interpretation: 'Pattern consistent with PD progression, left frontal hypoactivity' },
                    prs: { score: '24/40', interpretation: 'Moderate symptom burden with good medication response' }
                },
                clinicalFindings: [
                    'Bilateral motor symptoms consistent with Stage 2 Parkinson\'s Disease',
                    'Resting tremor predominantly right-sided with cogwheel rigidity',
                    'Mild bradykinesia affecting activities of daily living',
                    'Postural instability present during dual-task conditions',
                    'REM sleep behavior disorder requiring partner accommodation',
                    'Mild masked facies with reduced spontaneous facial expressions'
                ],
                treatmentPlan: {
                    medications: 'Continue Carbidopa-Levodopa 25/100mg TID, Added Rasagiline 1mg daily for neuroprotection',
                    therapy: 'Physical therapy 2x weekly focusing on balance and gait training, Occupational therapy for ADL optimization',
                    monitoring: 'Neuropsychological assessment in 6 months, Regular follow-ups every 3 months',
                    lifestyle: 'Fall prevention strategies, Regular exercise program, Family education on PD progression'
                },
                prognosis: 'Good - Disease progression appears gradual with excellent response to medication. Early intervention with physical therapy should maintain functional independence. Close monitoring recommended for cognitive changes.',
                nextSteps: ['Initiate physical therapy program', 'Neuropsychological baseline assessment', 'Family caregiver education session', 'Follow-up in 3 months for medication adjustment']
            },
            'P002': {
                name: 'Michael Roberts',
                patientId: 'P002',
                age: 55,
                gender: 'Male',
                condition: 'Major Depressive Disorder',
                assessmentDate: 'January 29, 2026',
                assessmentSummary: {
                    fnon: { score: '8/30', interpretation: 'Mild to moderate dysfunction in executive and attention networks' },
                    brainMapping: { finding: 'Elevated theta/beta ratio, Left frontal hypoactivity', interpretation: 'Classic depression biomarkers, reduced activity in mood regulation centers' },
                    prs: { score: '28/40', interpretation: 'Moderate depression with partial treatment response (30% improvement)' }
                },
                clinicalFindings: [
                    'Major Depressive Disorder with melancholic features',
                    'Persistent depressed mood for 8 months duration',
                    'Anhedonia affecting work performance and relationships',
                    'Psychomotor retardation evident in speech and movement',
                    'Early morning awakening with inability to return to sleep',
                    'Partial response to SSRI therapy after 8 weeks'
                ],
                treatmentPlan: {
                    medications: 'Increase Sertraline to 150mg daily, Continue Vitamin B12 and Magnesium supplementation',
                    therapy: 'Weekly CBT sessions targeting negative cognitions, Behavioral activation protocol to combat anhedonia',
                    monitoring: 'PHQ-9 scores every 2 weeks, Medication side effect monitoring, Suicidal ideation screening',
                    lifestyle: 'Sleep hygiene optimization, Regular exercise 30 min daily, Social engagement activities'
                },
                prognosis: 'Fair to Good - Showing improvement trajectory with combined medication and therapy. Expect continued symptom reduction over next 4-8 weeks. Strong family support system is favorable prognostic factor.',
                nextSteps: ['Medication dose optimization', 'Begin CBT weekly sessions', 'Re-assess in 4 weeks with PHQ-9', 'Consider couples therapy for relationship support']
            },
            'P003': {
                name: 'Emily Chen',
                patientId: 'P003',
                age: 38,
                gender: 'Female',
                condition: 'Generalized Anxiety Disorder',
                assessmentDate: 'January 29, 2026',
                assessmentSummary: {
                    fnon: { score: '10/30', interpretation: 'Moderate dysfunction in salience and attention networks' },
                    brainMapping: { finding: 'Severe beta elevation (52%), Right hemisphere dominance', interpretation: 'Chronic hyperarousal state, anxiety-specific brain pattern' },
                    prs: { score: '30/40', interpretation: 'Moderate to severe anxiety symptoms affecting daily functioning' }
                },
                clinicalFindings: [
                    'Generalized Anxiety Disorder with chronic hyperarousal',
                    'Uncontrollable worry consuming 6+ hours daily',
                    'Severe anticipatory anxiety with avoidance behaviors',
                    'Somatic symptoms including TMJ pain and GI distress',
                    'Sleep onset insomnia with racing thoughts',
                    'High motivation for treatment and good insight into condition'
                ],
                treatmentPlan: {
                    medications: 'Initiate Escitalopram 10mg daily, titrate to 20mg after 2 weeks, Hydroxyzine 25mg PRN for acute anxiety, Magnesium L-Threonate for calming',
                    therapy: 'Weekly CBT with exposure therapy components, MBSR (Mindfulness-Based Stress Reduction) program, Neurofeedback targeting SMR enhancement',
                    monitoring: 'GAD-7 scores biweekly, Sleep diary monitoring, Medication tolerance assessment',
                    lifestyle: 'Sleep hygiene protocol, Eliminate caffeine, Progressive muscle relaxation daily, Yoga or tai chi practice'
                },
                prognosis: 'Good - High motivation and insight are strong predictors of treatment success. Combined pharmacotherapy and CBT approach should yield significant symptom reduction within 8-12 weeks.',
                nextSteps: ['Start SSRI medication', 'Begin weekly CBT sessions', 'Enroll in MBSR course', 'Sleep study if insomnia persists', 'Re-evaluate in 6 weeks']
            },
            'P004': {
                name: 'David Thompson',
                patientId: 'P004',
                age: 47,
                gender: 'Male',
                condition: 'Post-Stroke Recovery (6 months)',
                assessmentDate: 'January 29, 2026',
                assessmentSummary: {
                    fnon: { score: '4/30', interpretation: 'Minimal residual network dysfunction - excellent recovery' },
                    brainMapping: { finding: 'Strong compensatory right hemisphere activation, Good neuroplasticity markers', interpretation: 'Outstanding recovery pattern post-left MCA stroke' },
                    prs: { score: '12/40', interpretation: 'Minimal residual symptoms with excellent functional recovery' }
                },
                clinicalFindings: [
                    'Remarkable recovery from left middle cerebral artery stroke',
                    'Mild left hemiparesis with improving strength (3/5 arm, 4/5 leg)',
                    'Minimal expressive aphasia with effective compensatory strategies',
                    'Mild working memory deficits responsive to environmental cueing',
                    'Post-stroke fatigue improving with energy conservation techniques',
                    'Excellent neuroplasticity demonstrated on brain imaging'
                ],
                treatmentPlan: {
                    medications: 'Continue Aspirin 81mg daily, Atorvastatin 40mg for lipid management, Modafinil 100mg morning for fatigue',
                    therapy: 'Intensive PT/OT 3x weekly, Speech therapy 2x weekly for aphasia, Constraint-induced movement therapy for left arm, Cognitive rehabilitation for memory',
                    monitoring: 'Monthly functional assessments, Blood pressure monitoring, Lipid panel every 3 months',
                    lifestyle: 'Mediterranean diet for secondary prevention, Regular cardiovascular exercise, Cognitive stimulation activities'
                },
                prognosis: 'Excellent - Among top 10% of stroke recovery outcomes. Strong potential for return to work part-time within 3 months and full-time within 6-9 months. Continued improvement expected for 12-18 months post-stroke.',
                nextSteps: ['Continue intensive rehabilitation', 'Vocational assessment for return to work', 'Caregiver respite planning', 'Re-assess functional status in 1 month']
            },
            'P005': {
                name: 'Lisa Anderson',
                patientId: 'P005',
                age: 35,
                gender: 'Female',
                condition: 'Severe Major Depressive Disorder',
                assessmentDate: 'January 29, 2026',
                assessmentSummary: {
                    fnon: { score: '25/30', interpretation: 'Severe widespread network dysfunction across all systems' },
                    brainMapping: { finding: 'Severe bilateral frontal hypoactivity, Global alpha suppression', interpretation: 'Neurobiological markers consistent with severe treatment-resistant depression' },
                    prs: { score: '36/40', interpretation: 'Severe depression with complete functional impairment' }
                },
                clinicalFindings: [
                    'Severe Major Depressive Disorder with treatment resistance',
                    'Complete anhedonia with total loss of pleasure in all activities',
                    'Severe worthlessness and guilt with passive death wishes',
                    'Psychomotor retardation with monotone speech and blank affect',
                    'Hypersomnia 14-16 hours daily as escape mechanism',
                    'Failed two adequate SSRI trials - requires treatment escalation'
                ],
                treatmentPlan: {
                    medications: 'URGENT: Start Venlafaxine 75mg BID titrate to 150mg BID, Add Bupropion 150mg SR for energy, Trazodone 50mg for sleep regulation, Weekly medication monitoring',
                    therapy: 'URGENT: Psychiatry referral for ECT evaluation, Enrollment in Intensive Outpatient Program (IOP) with daily check-ins, Family psychoeducation and support',
                    monitoring: 'URGENT: Weekly appointments minimum, Daily safety check-ins via phone, PHQ-9 and Columbia Suicide Severity Rating Scale weekly',
                    lifestyle: 'Children temporarily with grandmother (appropriate), Support for activities of daily living, Nutritional support and meal planning'
                },
                prognosis: 'Guarded - Treatment-resistant depression requires aggressive intervention. ECT or TMS may be necessary if current medication changes ineffective. Close safety monitoring essential. With appropriate intensive treatment, significant improvement possible within 6-12 weeks.',
                nextSteps: ['URGENT: Psychiatry consultation for ECT evaluation', 'Enroll in IOP program immediately', 'Family meeting for safety planning', 'Weekly follow-up appointments', 'Consider hospital partial program if no improvement in 2 weeks']
            }
        };

        // Render patient dropdown options
        function renderPatientDropdown() {
            const container = document.getElementById('patientDropdownList');
            const noResults = document.getElementById('noResultsMessage');
            
            if (filteredPatients.length === 0) {
                container.style.display = 'none';
                noResults.style.display = 'block';
                return;
            }
            
            container.style.display = 'block';
            noResults.style.display = 'none';
            
            container.innerHTML = filteredPatients.map(patient => `
                <div onclick="selectPatientFromDropdown(${JSON.stringify(patient).replace(/"/g, '&quot;')})" 
                     style="padding: 16px; border-bottom: 1px solid #e2e8f0; cursor: pointer; transition: all 0.2s; background: white;"
                     onmouseover="this.style.background='#f8fafc'"
                     onmouseout="this.style.background='white'">
                    <div style="display: flex; align-items: center; gap: 14px;">
                        <div style="width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(135deg, var(--orange-primary), #dc6027); display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; font-weight: 700; flex-shrink: 0;">
                            ${patient.firstName[0]}${patient.lastName[0]}
                        </div>
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <span style="font-size: 15px; font-weight: 700; color: #0f172a;">
                                    ${patient.firstName} ${patient.lastName}
                                </span>
                                <span style="font-size: 12px; color: #94a3b8; font-weight: 500;">
                                    ${patient.age} yrs
                                </span>
                                ${patient.status === 'active' 
                                    ? '<span style="background: #dcfce7; color: #166534; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">ACTIVE</span>'
                                    : '<span style="background: #e0e7ff; color: #3730a3; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;">COMPLETED</span>'
                                }
                            </div>
                            <div style="display: flex; gap: 16px; font-size: 12px; color: #64748b;">
                                <span><i class="fa-solid fa-id-card" style="width: 14px;"></i> ${patient.id}</span>
                                <span><i class="fa-solid fa-stethoscope" style="width: 14px;"></i> ${patient.condition}</span>
                            </div>
                        </div>
                        <div>
                            <i class="fa-solid fa-chevron-right" style="color: #cbd5e1; font-size: 12px;"></i>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Filter patients based on search
        function filterPatients() {
            const searchTerm = document.getElementById('patientSearchInput').value.toLowerCase();
            
            filteredPatients = samplePatients.filter(patient => {
                const fullName = `${patient.firstName} ${patient.lastName}`.toLowerCase();
                const id = patient.id.toLowerCase();
                return fullName.includes(searchTerm) || id.includes(searchTerm);
            });
            
            renderPatientDropdown();
        }

        // Select patient from dropdown
        function selectPatientFromDropdown(patient) {
            selectedPatientData = patient;
            
            // Update selected patient display
            document.getElementById('selectedPatientInitials').textContent = `${patient.firstName[0]}${patient.lastName[0]}`;
            document.getElementById('selectedPatientName').textContent = `${patient.firstName} ${patient.lastName}`;
            document.getElementById('selectedPatientAge').textContent = `${patient.age} yrs`;
            document.getElementById('selectedPatientCondition').textContent = patient.condition;
            
            // Show selected display, hide dropdown
            document.getElementById('selectedPatientDisplay').style.display = 'block';
            document.getElementById('patientDropdownList').style.display = 'none';
            document.getElementById('patientSearchInput').value = '';
            
            // Proceed to journey
            setTimeout(() => {
                selectPatient(patient);
            }, 300);
        }

        // Clear patient selection
        function clearPatientSelection() {
            selectedPatientData = null;
            document.getElementById('selectedPatientDisplay').style.display = 'none';
            document.getElementById('patientSearchInput').value = '';
            filteredPatients = [...samplePatients];
            renderPatientDropdown();
        }

        function selectPatient(patient) {
            // All roles go directly to journey (consent/payment happens at session activation)
            proceedDirectlyToJourney(patient);
        }

        function proceedDirectlyToJourney(patient) {
            // Hide entry screen
            document.getElementById('patientEntryScreen').style.display = 'none';
            
            // Show patient header
            const header = document.getElementById('selectedPatientHeader');
            header.style.display = 'block';
            
            // Show role selector and sync it with current role
            document.getElementById('journeyRoleSelector').style.display = 'block';
            document.getElementById('roleSelector').value = currentRole;
            
            // Populate header
            document.getElementById('patientInitials').textContent = patient.firstName.charAt(0) + patient.lastName.charAt(0);
            document.getElementById('patientFullName').textContent = `${patient.firstName} ${patient.lastName}`;
            document.getElementById('patientAge').textContent = `${patient.age} years`;
            document.getElementById('patientGender').textContent = patient.gender;
            document.getElementById('patientCondition').textContent = patient.condition;
            
            // Show journey content
            document.getElementById('journeyContent').style.display = 'block';
            
            // Activate Today's Journey tab and render it
            switchTab('today');
            
            // Re-render assessments with current role
            renderAssessments();
        }

        function backToPatientList() {
            // Hide all pages
            document.getElementById('journeyContent').style.display = 'none';
            document.getElementById('selectedPatientHeader').style.display = 'none';
            document.getElementById('consentFormPage').style.display = 'none';
            document.getElementById('paymentPage').style.display = 'none';
            
            // Show entry screen
            document.getElementById('patientEntryScreen').style.display = 'block';
            
            // Reset patient selection
            clearPatientSelection();
            
            // Reset onboarding state
            currentOnboardingPatient = null;
            hasSignature = false;
        }

        function showAddNewPatient() {
            // Hide the main patient selection
            document.getElementById('patientEntryScreen').querySelector('[style*="max-width: 600px"]').style.display = 'none';
            // Show the add patient form
            document.getElementById('addNewPatientSection').style.display = 'block';
        }

        function cancelAddPatient() {
            // Hide the add patient form
            document.getElementById('addNewPatientSection').style.display = 'none';
            // Show the main patient selection
            document.getElementById('patientEntryScreen').querySelector('[style*="max-width: 600px"]').style.display = 'block';
        }

        function submitNewPatient(event) {
            event.preventDefault();
            
            // Get form data
            const form = document.getElementById('newPatientForm');
            const formData = new FormData(form);
            
            // Create new patient object
            const newPatient = {
                id: 'P' + String(samplePatients.length + 1).padStart(3, '0'),
                firstName: form.elements[0].value,
                lastName: form.elements[1].value,
                age: calculateAge(form.elements[2].value),
                gender: form.elements[3].value.charAt(0).toUpperCase() + form.elements[3].value.slice(1),
                condition: form.elements[5].value === 'parkinsons' ? "Parkinson's Disease" : 
                          form.elements[5].value === 'depression' ? 'Depression' :
                          form.elements[5].value === 'anxiety' ? 'Anxiety' : 'Other',
                lastVisit: new Date().toISOString().split('T')[0],
                status: 'active',
                nextAppointment: null
            };
            
            // Add to patient list
            samplePatients.push(newPatient);
            
            // Hide form
            cancelAddPatient();
            
            // Start onboarding flow with consent
            showConsentForm(newPatient);
        }

        function calculateAge(birthDate) {
            const today = new Date('2026-02-01');
            const birth = new Date(birthDate);
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        }

        function handleEntryRoleChange() {
            const entryRole = document.getElementById('entryRoleSelector').value;
            
            // Update currentRole
            currentRole = entryRole;
            
            const addPatientBtn = document.getElementById('addPatientButtonContainer');
            const welcomeMsg = document.getElementById('welcomeMessage');
            
            // Update welcome message
            const welcomeMessages = {
                'receptionist': 'Welcome Back, Receptionist!',
                'patient': 'Welcome!',
                'doctor': 'Welcome, Doctor!',
                'clinical-assistant': 'Welcome, Clinical Assistant!'
            };
            welcomeMsg.textContent = welcomeMessages[entryRole] || 'Welcome Back!';
            
            // Show/hide add patient button (only for receptionist)
            if (entryRole === 'receptionist') {
                addPatientBtn.style.display = 'block';
            } else {
                addPatientBtn.style.display = 'none';
            }
        }

        function handleRoleChange() {
            const roleSelector = document.getElementById('roleSelector');
            if (!roleSelector) return;
            
            currentRole = roleSelector.value;
            
            // Re-render views if patient is selected
            if (document.getElementById('journeyContent').style.display === 'block') {
                if (document.getElementById('todayTabContent').style.display === 'block') {
                    renderTodayView();
                }
                if (document.getElementById('workingTabContent').style.display === 'block') {
                    renderWorkingView();
                }
            }
        }

        // INITIALIZE
        renderAssessments();
        renderPatientDropdown();
        handleEntryRoleChange(); // Initialize entry role-based UI

        // EXPOSE FOR DEBUGGING
        window.patientState = patientState;
    </script>
</body>
</html>
